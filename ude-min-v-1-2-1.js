let UD_exTagAndClassInfo={},elementTypesByExTag=null;function TEST_getElementType(e){if(!elementTypesByExTag)for(var t in elementTypes){t=elementTypes[t];elementTypesByExTag[t.exTag]=t}return elementTypesByExTag[ud.dom.attr(e,"exTag")].label}let UD_defaultContentByExTag={"div.page":"","div.part":"","div.zone":"",h1:"...",h2:"...",h3:"...",h4:"...",h5:"...",h6:"...",p:"...",li:"...",td:"...",th:"...","p.sub_paragraph":"...","div.table":"Table{AutoIndex_table}","div.list":"List{AutoIndex_list}","div.graphic":"Illustration{AutoIndex_graphic}","div.linetext":"Text{AutoIndex_text}","div.server":"Server{AutoIndex_server}","div.css":"Style{AutoIndex_style}","div.js":"Javascript{AutoIndex_js}","div.json":"JSON{AutoIndex_json}","div.connector":"Connector{AutoIndex_connector}","div.zoneToFill":"zone{id}","span.field":"...","span.button":"..."},UD_moduleLabels={siteExtract:"modules/connectors/udcsiteextract.js"};const UD_insignificantWords={EN:["and","if","but","a","an","the","of"],FR:["et","si","mais","un","une","le","la","les","du","de","des","dans","sont","pour","en","type"]},UD_wellKnownClasses={active:"active",hidden:"hidden",editing:"editing"},UD_wellKnownElements={botlog:"BVU00000002200000M",docNameHolder:"BVU0000000810{userId_base32}_texts",UD_docParams:"UD_docParams_object"},UD_appAttributes=["data-ud-iheight","data-ud-pageHeight","data-ud-offset","data-ud-cursor","data-ud-debug","data-ud-refresh","data-ud-mode","data-ud-dupdated","data-ud-dchanged","data-ud-oid","data-ud-oidchildren","data-ud-dsent","data-ud-fields","data-ud-saveId","data-ud-type","data-ud-subtype","data-ud-mime","data-ud-key","data-ud-extra","data-ud-attr","data-ud-hidden","data-ud-onupdate","data-ud-onevent","data-ud-prepost","data-ud-model","data-ud-content","data-ud-display","data-ud-follow","data-ud-dbaction","data-ud-defaultPart","data-ud-quotes","data-ud-selection","data-ud-filter","data-ud-saveid","data-ude-datasrc","data-ude-formula","data-ude-bind","data-ude-edit","data-ude-menu","data-ude-input","data-ude-stage","data-ude-mode","data-ude-autosave","data-ude-source","data-ude-onclick","data-ude-noedit","data-ude-place","data-ude-onclickformula","data-ude-rowidformula","data-ude-updateaction","data-ude-validate","data-ude-editzone","data-ude-autoplay","data-ude-onvalid","data-ude-oninvalid","data-ude-accept","data-ude-pageno","data-ude-check","data-ude-input","data-ude-form","data-ude-ui","data-ude-editzone","data-ude-selection","data-ude-filter","data-udc-step","data-udc-scenario","data-udapi-quotes","data-udapi-callbackid","data-udapi-value1","data-cb-type","data-cb-tags","data-rb-time","data-rb-action","data-ud-lang","data-from-model","ud_iheight","ud_pageHeight","ud_offset","ud_cursor","ud_debug","ud_refresh","ud_mode","ud_dupdated","ud_dchanged","ud_oid","ud_oidchildren","ud_dsent","ud_fields","ud_saveId","ud_type","ud_subtype","ud_mime","ud_key","ud_extra","ud_attr","ud_hidden","ud_onupdate","ud_onevent","ud_prepost","ud_model","ud_content","ud_display","ud_follow","ud_dbaction","ud_defaultPart","ud_quotes","ud_selection","ud_filter","ud_saveid","ude_datasrc","ude_formula","ude_bind","ude_edit","ude_menu","ude_edit","ude_stage","ude_mode","ude_autosave","ude_source","ude_onclick","ude_noedit","ude_place","ude_onclickformula","ude_rowidformula","ude_updateaction","ude_validate","ude_editZone","ude_autoplay","ude_onvalid","ude_oninvalid","ude_accept","ude_pageno","ude_check","ude_input","ude_form","ude_ui","ude_editzone","ude-selection","ude-filter","udc_step","udc_scenario","udapi_quotes","udapi_callbackid","udapi_value1","cb_type","cb_tags","RB_time","RB_action","ud_lang","fromModel"],UD_domAttributes=["onclick","contenteditable","onchange","draggable","ondragstart","ondragend","ondrop","class","id","name","src","onscroll","width","height","href","placeholder","title","tagName","style","type","_editable","_datadest","_add","target_id","_onclick","_type","x","y","onmouseover","onmousenter","onmouseout","value","checked","sandbox","spellcheck","max"],UD_styleAttributes=["marginTop","marginLeft","marginBottom","marginRight"],UD_attributes=["ud_dupdated","ud_dchanged","ud_oid","ud_oidchildren","ud_dsent","ud_fields","ud_iheight","ud_textra","ud_type","ud_content","ud_display","ud_onupdate","ud_onevent","ud_refresh"],UD_indexableTags=["table","ul"],UD_lowerCaseAttr=["tagName","contenteditable"],UD_useComputedPrefix="computed_",UD_layoutPrefix="LAY_",UD_themePrefix="THEME_",UD_viewPrefix="view";"object"==typeof process&&(global.UD_layoutPrefix="LAY_",global.UD_themePrefix="THEME_",global.UD_viewPrefix="view");const UD_dateFormats=["YYYY-MM-DD","YYYY-MM-DD hh:mm","YYYY-MM-DD HH:mm","YYYY-MM-DD HH:mm:ii","DD/MM/YYYY","MM/DD/YYYY","DD/MM/YY","MM/DD/YY"],UD_terms={"This screen":"Cet écran",genericMobile:"Mobile en portrait",genericTabletLandscape:"Tablette en paysage",INPUT_addApage:"INPUT_ajouterUnePage",INPUT_addAdir:"INPUT_ajouterUnRepertoire",INPUT_addAtemplate:"INPUT_ajouterUnModèle",list:"liste",emphasized:"faire sortir",quoted:"citation",chapter:"chapitre","sub-section":"sous-section",graphic:"illustration",collapse:"réduire",expand:"ouvrir",delete:"effacer","Available styles":"Styles disponibles","Current style":"Style actuelle","Available layouts":"Dispositions possibles","Current layout":"Disposition actuelle","Insertable elements":"Insérer un élément","Click on an idea to add to your text":"Cliquez sur une idée pour l'insérer dans votre texte",Use:"Utiliser",Back:"Retour"},LINKSUSER_login=1,UD_before=0,UD_after=1,UD_inside=1;"object"==typeof process&&(module.exports={UD_defaultContentByExTag:UD_defaultContentByExTag,UD_insignificantWords:UD_insignificantWords,UD_exTagAndClassInfo:UD_exTagAndClassInfo,UD_appAttributes:UD_appAttributes,UD_domAttributes:UD_domAttributes,UD_styleAttributes:UD_styleAttributes,UD_indexableTags:UD_indexableTags,UD_lowerCaseAttr:UD_lowerCaseAttr,UD_useComputedPrefix:UD_useComputedPrefix,UD_wellKnownElements:UD_wellKnownElements,UD_terms:UD_terms,UD_moduleLabels:UD_moduleLabels},void 0===global.JSDOM&&"undefined"==typeof window&&(console.log("Syntax : OK"),console.log("Test completed")));let UDE_attributeValues={"data-ude-edit":{on:"All editing enabled (*default*)",off:"No editing","a CSV list":{title:"Selected editing",items:{delete:"Enable deletion of complete element",text:"Enable text editing",image:"Enable image insertion an deletion",field:"Enable insertion, editing & deleting of fields"}}},"data-ude-menu":{on:"All tools enabled (*default*)",off:"No tools enabled","a CSV list":{title:"Selected tools",items:{style:"Enable deletion of complete element",config:"Enable text editing",web:"Enable image insertion an deletion",ideas:"Enable insertion, editing & deleting of fields"}}},"data-ude-autosave":{on:"Enable auto saving of element (*default*)",off:"Disable auto saving"}},UDE_availableActions={styler:{apiFct:"displayStyle",icon:"/upload/smartdoc/resources/images/brush.png",label:"style",isDefault:!0},config:{apiFct:"configureElement",icon:"/upload/smartdoc/resources/images/tools.png",label:"config",isDefault:!0},cloud:{apiFct:"displayCloud",icon:"/upload/smartdoc/resources/images/cloud-download-outline.png",label:"web",isDefault:!0},ideas:{apiFct:"displayIdeas",icon:"/upload/smartdoc/resources/images/lightbulb-on-30.png",label:"ideas",isDefault:!0},expand:{apiFct:"expand",label:"expand",onlyClasses:["collapsable"]},collapse:{apiFct:"collapse",label:"collapse",onlyClasses:["collapsable"]},update:{apiFct:"setChanged",icon:"Update",label:"update",args:"1",onlyTypes:["div.text","div.css","div.json","div.html","div.js"]},restore:{apiFct:"initialiseElement",icon:"Restore",label:"restore",onlyTypes:["div.text","div.css","div.json","div.html","div.js"]}};"object"==typeof process&&(module.exports={UDE_attributeValues:UDE_attributeValues,UDE_availableActions:UDE_availableActions},void 0===global.JSDOM&&"undefined"==typeof window&&(console.log("Syntax : OK"),console.log("Test completed")));class UniversalDoc{minTicksToSave=10;maxTicksToFetch=1200;maxTicksDisconnected=1200;autoReloadTicks=0;idleTicks=6e3;ticksInfo=100;ticksToInfo=12e3;minIdStep=300;server="http://dev.rfolks.com";service="webdesk";fetchAction="AJAX_fetch";refreshAction={model:"AJAX_modelShow",model3:"AJAX_modelShow",edit2:"AJAX_show",edit3:"AJAX_show",display2:"AJAX_show"};serverFormName="INPUT_UDE_FETCH";serverTime=0;reverseTagMap={};historyElementId="UD_history";ticks=0;tickOffset;timestamp=0;lastViewEventTicks=0;topElement;elementsToSave=[];elementsToFetch=[];serverRequestId=1;userId;autoLayoutAdjust=!0;ownerId;user_id;mode;sync=!0;ude=null;dom=null;udajax=null;udlocal=null;api=null;networkStatus={connected:!0,secure:!1,session:!0,dchanged:0,dlastfocus:0};info={displayed:!1,dstarted:0,dlastDisplay:0};botlog={busy:!1,openToServer:!1,call:null,log:{}};infoZoneName="";infoZone=null;localStorageStatus={};apiBuffer_requests=UDapiBuffer_requests;triggeredActions=[];currentURL="";unitTesting=!1;currentPage=null;syncRemovePending=[];constructor(e,t=!1,s){var n=!1;if("object"==typeof process&&(this.unitTesting=n=!0),(window.ud=this).topElement=document.getElementById(e),this.topElement){if(this.user_id=s,this.userId=("00000"+s.toString(32)).slice(-5).toUpperCase(),this.ownerId=this.userId,t&&this.topElement.setAttribute("contenteditable","true"),this.dom=new DOM(this.topElement,this),console.log("Page contains "+document.getElementsByTagName("*").length+" elements"),n&&"undefined"==typeof UD_SERVER){const UD_SERVER="http://dev.rfolks.com",UD_SERVICE="webdesk";this.udajax=new UDAJAX(this,"http://dev.rfolks.com","webdesk")}else this.udajax=new UDAJAX(this,UD_SERVER,UD_SERVICE);if(this.udajax&&(this.networkStatus.connected=!0),!n&&window.localStorage&&(this.localStorageStatus.present=!0),void 0===UDapi?this.ude.loadScript("ud-view-model/udapi.js","window.ud.api = new UDapi( window.ud);","UDapi","UDapi"):this.api=setupAPI(this),this.ude=new UDE(this.topElement,this),this.api.ude=this.ude,this.api.calc=this.ude.calc,void 0===window.udAttributes){let e="yes";var i=document.getElementsByName("_new_window");1!=i.length||i[0].checked||(e="no"),window.udAttributes={newWindowOnFiles:e}}var o=this.dom.childrenOfClass(this.topElement,"part");for(let t=0;t<o.length;t++){let e=o[t];e.classList.contains("NoEdit")&&this.dom.attr(e,"contenteditable","false")}this.infoZoneName&&(this.infoZone=document.getElementById(this.infoZoneName));var a,i=this.dom.element("UD_mode");i&&(this.mode=i.textContent),document.getElementById("footer")&&this.displayFooter(),this.pageBanner=$$$.getShortCut("pageBanner"),this.botlogUpdate=$$$.getShortcut("botlogUpdate"),this.getParameter=$$$.getShortcut("getParameter"),this.apiPoll=$$$.getShortcut("poll"),setInterval((a=this,function(){a.heartbeat()}),100),window.addEventListener("focus",function(e){window.ud.focusEvent()}),this.initialise(),debug({level:3},"UniversalDoc up and running")}}initialise(){let e=this.dom.element("banner");e.style.backgroundColor="rgb( 241,208,208,1)",setTimeout(function(){e.style.backgroundColor="rgb( 208,234,241,1)"},2e3);var t=this.dom.elements("*",this.topElement),s=t.length;let n=this.dom.udjson.value;void 0===UD_exTagAndClassInfo&&(UD_exTagAndClassInfo=UD_register.UD_exTagAndClassInfo);for(let e=0;e<s;e++){var i=t[e],o=this.dom.attr(i,"exTag"),a=this.dom.attr(i,"ud_oid");if(i.nodeType==Node.ELEMENT_NODE&&a&&(n(UD_exTagAndClassInfo[o],"earlyInit")||n(UD_exTagAndClassInfo[o],"useTextEditor")))try{this.initialiseElement(i.id)}catch(e){console.log("ERR. Can't initialise "+i.id,e)}else this.dom.attr(i,"onclick")&&!API.testEditorAttr(i,"ude_edit")&&this.dom.attr(i,"contenteditable","false")}var l=this.dom.elements("li.viewoutline",this.dom.element("document-outline"));let r=this.dom.element("view-selector");var d=this.dom.element("div.part:not(.hidden)",this.dom.element("document")),u=this.dom.attr(d,"name");let c="";if(r&&l&&1<l.length&&800<window.innerWidth){for(let i=0;i<l.length;i++){var h=l[i];let e=h.textContent;c||"app"!=this.dom.attr(h,"ud_type")||(c=this.dom.attr(h,"name"));var m=e.toLowerCase().replace(/ /g,"_")+"sel",h="API.switchView( '"+e+"', '"+m+"');";let t="tab";-1<["managesel","botlogsel","gérersel"].indexOf(m)?t+=" right":t+=" left",u==e&&(t+=" active");let s=e;15<s.length&&(s=e.substring(0,6)+"..."+e.substring(s.length-6));API.dom.insertElement("span",s,{id:m,class:t,onclick:h,title:e},r,!0,!0);let n=this.dom.elementByName(e);0==this.dom.children(n).length&&setTimeout(function(){API.updateContentAfterEvent(n,{eventType:"emptyView"})},1e3)}API.dom.insertElement("span","+",{id:"newView",class:"tab left",onclick:"API.addView();"},r,!0,!0)}else r&&r.classList.add("hidden");debug({level:1},"Default view "+u+" "+c),c&&window.innerWidth<this.ude.minWidthFloater?API.switchView(c):API.switchView(u);let p="view_load_"+u;setTimeout(function(){"function"==typeof global[p]&&global[p]()},1e3)}viewEvent(t,s){if(!(s="string"==typeof s?this.dom.element(s):s)||void 0===s.tagName)return!1;if(!(-1<["scroll","middleColumn","content","body"].indexOf(s.id))){this.lastViewEventTicks=this.ticks;let e=this.dom.getSaveableParent(s);switch(e&&e!=s&&(e.classList.contains("page")||e.classList.contains("part"))&&(e=null),t){case"focus":break;case"changeClass":case"change":if(!e||"__NONE__"==this.dom.attr(e,"ud_oid")||""==this.dom.attr(e,"ud_oid")||""==this.dom.attr(e,"ud_dchanged")||""==this.dom.attr(e,"ud_dupdated"))return debug({level:1,return:null},"Cannot set as changed an unknown or incorrect element",s);this.dom.attr(e,"ud_dchanged",this.ticks);break;case"changeTag":var n=this.computeId(s);n!=s.id&&(s.id=n,this.dom.attr(s,"ud_saveId","yes"));n=this.buildName(s);n&&this.dom.attr(s,"name",n),this.dom.attr(s,"ud_dchanged",this.ticks);break;case"createView":{let e=this.dom.parentAttr(s.parentNode,"ud_oid");e="UniversalDocElement--"+e.split("--")[1]+"-21-0",this.dom.attr(s,"ud_oid",e),this.dom.attr(s,"ud_dupdated",this.ticks-1),this.dom.attr(s,"ud_dchanged",this.ticks),this.dom.attr(s,"ud_dbaction","insert")}break;case"create":{(!s.id||s.id.length<17||0==s.id.indexOf("__TMP"))&&(s.id&&0==s.id.indexOf("__TMP")&&(s.id=""),s.id=this.computeId(s));let e=s.parentNode;"page"==this.dom.attr(e,"ud_type")&&(e=e.parentNode);let t=this.dom.parentAttr(e,"ud_oid");-1<t.indexOf("_FILE_UniversalDocElement")?(i=t.split("--"),t=i[0]+"-_FILE_UniversalDocElement-"+s.id+"--"+i[1]+"-21-0"):t+="-"+t.split("--")[1].split("-").slice(0,1)+"-0",this.dom.attr(s,"ud_oid",t),this.dom.attr(s,"ud_dupdated",this.ticks-1),this.dom.attr(s,"ud_dchanged",this.ticks),this.dom.attr(s,"ud_dbaction","insert"),this.dom.attr(s,"ud_saveId","yes"),s.innerHTML=s.innerHTML.replace(/{id}/g,s.id);var i=this.buildName(s);i&&this.dom.attr(s,"name",i);break}case"move":i=s.id;s.id=this.computeId(s,!0),this.dom.attr(s,"ud_saveId","yes"),this.dom.attr(s,"ud_dchanged",this.ticks),debug({level:3},"Moved "+i+"to "+s.id);break;case"delete":if(!e)break;this.dom.attr(e,"ud_dchanged",this.ticks),this.dom.attr(e,"ud_dbaction","remove"),this.dom.attr(s,"ud_dsent")||this.syncRemovePending.push(e.id);break;case"server remove":s.remove()}return e}}computeId(s,e=!1){let n=[],i=-1,o="";let t=s.id,a=s.parentNode,l=5;for(;!a.classList.contains("part")&&l--;)a=a.parentNode;if(!a.classList.contains("part"))return debug({level:2,return:!1},"Can't find element's part in parts",s);o=this.dom.attr(a,"id").substring(0,13);for(var r=this.dom.childrenOfClass(this.topElement,"part"),d=0;d<r.length&&this.dom.attr(r[d],"id").substring(0,13)!=o;d++);if(d==r.length)return debug({level:2,return:!1},"Can't find element's part in parts",s,r);let u=r[d];o=o.substring(0,3);var c=u.getElementsByTagName("*");for(let t=0;t<c.length;t++){var h=c[t];let e=this.dom.attr(h,"id");this.dom.attr(h,"ud_oid")&&15<=e.length&&e.substring(0,3)==o?(n.push(e),h==s&&(i=n.length-1)):h==s&&(i=n.length,n.push("BTOFIND"))}let m=null;1<=i&&(m=this.dom.element(n[i-1]));let p=null;-1<i&&i<n.length-1&&(p=this.dom.element(n[i+1]));let g,f,v,b;g=m?parseInt(m.id.substring(3,13),32):1;var x=parseInt("VVVVVVVVVV",32)-2*this.minIdStep;f=p?parseInt(p.id.substring(3,13),32):Math.min(g+16*this.minIdStep,x);var y=Math.round((g+f)/2);let T=g+.5*this.minIdStep,E=f-.5*this.minIdStep;E<T&&(debug({level:2},"renumbering required (server or JS)"),T=g+10,E=f-10,E<=T&&(alert("Technical issue with block ids, reloading"),this.reload(!0)));x=g+this.getDBidStepFactor(s)*this.minIdStep;if(v=x<E&&x>T?x:y<E&&y>T?y:E,!e){e=parseInt(t.substring(3,13),32);if(t&&e<v)return t}return v=v.toString(32),debug({level:3},"newId :"+v),b=("00000"+this.userId).slice(-5).toUpperCase(),o+("0000000000"+v).slice(-10).toUpperCase()+b}viewModelEvent(e,t){}focusEvent(){this.networkStatus.dlastfocus=this.ticks;var e=Date.now()-this.timestamp;this.ticks+=Math.round(e/100),e>=this.maxTicksToFetch&&(this.ticks=Math.round(this.ticks/this.maxTicksToFetch)*this.maxTicksToFetch-5),debug({level:3},"Window has focus")}heartbeat(){this.ticks++,this.timestamp=Date.now();var n=this.networkStatus.session;void 0===this.networkStatus.save?this.networkStatus.save={connected:this.networkStatus.connected,secure:this.networkStatus.secure,session:n}:this.networkStatus.save.session!=n?(this.networkStatus.save.session=n,this.networkStatus.dchanged=this.networkStatus.dlastfocus||this.ticks,this.networkStatus.dlastfocus=0):!n&&this.ticks-this.networkStatus.dchanged>this.maxTicksDisconnected?(this.networkStatus.dchanged=this.ticks,this.reload("UniversalDocElement--21--{OIDPARAM}"!=this.dom.attr(this.topElement,"ud_oid"))):n&&this.infoZone&&!this.info.display&&this.ticks-this.info.dlastDisplay>this.ticksToInfo?(this.info.display=!0,this.info.dstarted=this.ticks,this.infoZone=document.getElementById(this.infoZoneName)):this.infoZone&&this.info.display&&this.ticks-this.info.dstarted>this.ticksInfo&&(this.pageBanner("clear"),this.infoZone.style.display="none",this.info.display=!1,this.info.dlastDisplay=this.ticks),this.autoReloadTicks&&this.ticks>this.autoReloadTicks&&this.ticks-this.lastViewEventTicks>this.idleTicks&&(this.dom.cursor.save(),this.reload(!1),this.lastViewEventTicks=this.ticks,this.dom.cusor.restore());var i=0<this.elementsToSave.length|0<this.elementsToFetch.length;if(i|=this.botlogUpdate("busy")|this.ude.isBusy()|this.udajax.isBusy(),i|="onloaded"!=requirejs_app,this.botlog.busy=i,this.api&&this.api.LED("STATUS_busy",!i),0<this.elementsToSave.length?this.saveElement(this.elementsToSave.shift()):0<this.elementsToFetch.length&&this.fetchElement(this.elementsToFetch.shift()),this.ticks%(this.minTicksToSave/2)==0){var t=document.querySelectorAll("#document *");for(let e=0;e<t.length;e++){var s,o=t[e];1==o.nodeType&&this.dom.attr(o,"ud_dchanged")&&!this.dom.attr(o,"ud_dsent")?(s=parseInt(this.dom.attr(o,"ud_dchanged")),parseInt(this.dom.attr(o,"ud_dupdated"))<s&&this.ticks-s>this.minTicksToSave&&-1==this.elementsToSave.indexOf(o)&&(debug({level:5}," Save ",this.dom.attr(o,"ud_oid")),this.elementsToSave.push(o))):"yes"==this.dom.attr(o,"ud_refresh").toLowerCase()&&this.ude.dispatchEditEvent(o,{event:"refresh"})}this.ticks%this.maxTicksToFetch==0&&this.syncWithServer()}if(this.apiPoll&&this.apiPoll(5),(this.ticks%50==0||this.ticks<20)&&this.autoLayoutAdjust){var a=window.innerHeight;let s=this.dom.element("content"),e=this.dom.element("scroll");n=this.dom.element("view-selector");if(s&&e){e.offsetHeight;i=s.offsetHeight;let t=this.ude.tabletMode?a-30:a-70-30;if(this.dom.element("p9")&&(t-=22),i!=t&&"scroll"==this.dom.attr(e,"computed_overflowY")){s.style.height=t+"px";a=t;a-=this.dom.attr(e,"computed_marginTop")+this.dom.attr(e,"computed_marginBottom"),a-=n?n.offsetHeight:0,e.style.height=a+"px"}else if(i!=t){let e=this.dom.element("document");e.offsetHeight;s.style.height=t+"px",e.style.height=t-20+"px"}else this.dom.element("footer").classList.remove("hidden")}"yes"==this.getParameter("device_isMobile")&&(this.autoLayoutAdjust=!1)}}displayFooter(){let e=this.dom.element("content");var t=this.dom.element("scroll");e&&t&&(t=t.offsetHeight,e.offsetHeight<t+10&&(e.style.height=t+10+"px"),this.dom.element("footer").classList.remove("hidden"))}saveElement(n){if("string"==typeof n&&!(n=this.dom.element(n)))return debug({level:2,return:!1},"Can't find id to save",n);if(this.dom.isEditable(n)){var i=n.innerHTML;(o=this.dom.attr(n,"ud_hidden"))&&(i+=document.getElementById(o));let t="update";this.dom.attr(n,"ud_dbaction")&&(t=this.dom.attr(n,"ud_dbaction"));t;"insert"==t&&"graphic"==this.dom.attr(n,"ud_type")&&(t="refresh"),debug({level:3},"Server request "+this.serverRequestId,t,n.id);let e=n.parentNode;e&&void 0!==e.classList&&e.classList.contains("page")&&e.scrollHeight>e.clientHeight&&debug({level:2},"Page height too big refresh",e);let s=this.dom.attr(n,"ud_oid");"refresh"==t?(s=this.dom.attr(this.topElement,"ud_oid"),this.ude.dom.cursor.save()):"remove"==t&&(s=s+"--SP|"+(s.split("--")[1].split("-").length/2-1),this.dom.attr(n,"ud_oid",s),this.dom.attr(n,"ud_dbaction","remove"),this.ude.dom.cursor.save(),debug({level:5},"removing ",s));var o=this.dom.attr(n,"ud_prepost");if(o){i=parseInt(o)-1;let e=this.triggeredActions[i].fct;this.triggeredActions[i].once&&(this.triggeredActions[i]=null,this.dom.attr(n,"ud_prepost","__CLEAR__"));o=e?e(n):"";o?(i=n.innerHTML,n.innerHTML=o,this.udajax.postElement(n,s,t,this.getDBtype(n)),n.innerHTML=i):this.udajax.postElement(n,s,t,this.getDBtype(n))}else this.udajax.postElement(n,s,t,this.getDBtype(n));this.dom.attr(n,"ud_dsent",this.ticks)}else this.dom.attr(n,"ud_dupdated",parseInt(this.dom.attr(n,"ud_dchanged"))+1)}refresh(){this.fetchElement(document.getElementById("document"),"AJAX_modelShow"),setTimeout(function(){let e=document.getElementsByName("_new_window");1==e.length&&void 0!==window.udAttributes&&("yes"==window.udAttributes.newWindowOnFiles.toLowerCase()?e[0].checked=!0:e[0].checked=!1)},1e3)}fetchElement(e,t=""){let s=this.dom.attr(e,"ud_oid");"document"==e.id&&(s=this.dom.attr(e,"ud_oidchildren")),t&&""!=t||(t="document"==e.id?this.refreshAction[this.mode]:this.fetchAction);var n="/"+this.service+"/"+s+"/"+t+"/";let i="update";"document"==e.id&&(i="refresh");t={element:e,action:i,setCursor:!1,ud:this};this.udajax.serverRequest(n,"GET","",t),this.dom.isEditable(e)&&e.classList.add("busy"),this.dom.attr(e,"ud_dsent",this.ticks)}updateElement(s,n){if(this.dom.isEditable(s)){let t;try{t=JSON.parse(n)}catch{return debug({level:1,return:!1},"Non JSON server response",n)}if(!s||!s.id)return debug({level:1,return:!1},"Can't update element",s);if(t.nname!=s.id&&-1==s.id.indexOf("MANAGE_"))return debug({level:1,return:!1},"bad record from server",s.id,t);let e=this.dom.attr(s,"ud_fields");n=this.getDBtype(s);if(t.newElement)this.dom.attr(s,"_add")&&this.dom.attr(s,0),t.oid&&this.dom.attr(s,"ud_oid",t.oid);else if(void 0!==window.botlogId&&s.id==window.botlogId)s.innerHTML=t.tcontent;else if(-1==t.result.indexOf("OK")&&t.modifiableBy!=this.user_id&&s.innerHTML!=t.tcontent)if(this.dom.cursor.save(),n==t.stype)(!e||-1<e.indexOf("tcontent"))&&(s.innerHTML=t.tcontent),t.nstyle&&(!e||-1<e.indexOf("nstyle"))&&this.dom.attr(s,"class",t.nstyle),this.ude.initialiseElement(s.id),this.dom.attr(s,"ud_display")&&doupdate(this.dom.attr(s,"ud_display"));else if(!e||-1<e.indexOf("stype")){(!e||-1<e.indexOf("tcontent"))&&(s.innerHTML=t.tcontent);var i=Object.keys(UD_exTagAndClassInfo).find(e=>UD_exTagAndClassInfo[e].db_type==t.stype);if(void 0===i)return debug({level:2,return:!1},"can't update stype",t);this.dom.changeTag(s,i)}this.dom.attr(s,"ud_dsent",""),1<t.users.length&&(this.minTicksToFetch=500/Math.min(t.users.length,10));i=this.dom.attr(s,"ude_edit").split(" ");t.modifiableBy==t.you?1<i.length&&this.ude.dom.attr(s,"ude_edit",i[1]):i&&1==i.length&&this.ude.dom.attr(s,"ude_edit","Off "+i[0]),this.dom.attr(s,"ud_dupdated",this.ticks),s.classList.remove("busy");i=this.dom.attr(s,"ud_onupdate");if(i){i=parseInt(i)-1;let e=this.triggeredActions[i].fct;this.triggeredActions[i].once&&(this.triggeredActions[i]=null,this.dom.attr(s,"ud_onupdate","__CLEAR__")),e&&e(s)}return t.newElements&&this.syncWithServer(),!0}console.log(s.id+" is not editable so cannot be updated")}isDirListing(){let e=this.dom.element("UD_docModel");return!(!e||0!=e.textContent.indexOf("Basic model for home directories"))}syncWithServer(i=null,e="",t){if(i){let s=i.ud,n=s.dom;var o=JSONparse(e),a=Object.keys(o).length;if(!o)return debug({level:2,return:!1},"Bad server response",e);if(1<a&&debug({level:2},"Changed elements count",o.length),"model"==s.mode&&2<a)s.reload(!0);else for(var l in o){var r=o[l],d=s.dom.element(l);if(d)"UD_user"==l?(h=s.dom.element(l).textContent,r.content!=h?s.networkStatus.session=!1:s.networkStatus.session=!0,void 0!==r.time&&(s.serverTime=r.time)):"__DELETED"==r.oid?s.viewEvent("server remove",d):r.ticks>=s.dom.attr(d,"ud_dupdated")&&("A"==l[0]?s.reload(!1):s.elementsToFetch.push(d));else if("__DELETED"!=r.oid){if("A"==l[0])return void s.reload(!1);var u=r.before,c=s.dom.element(u),h=r.after,d=s.dom.element(h),u=r.oid,h=r.parent;if(h){let t=n.element(h);if(t){h=n.prepareToInsert("p","...",{ud_oid:u});let e=n.children(t);0==e.length||-1==e.indexOf(c)?t.appendChild(h):t.insertBefore(h,c),s.elementsToFetch.push(h)}}else c?(c=s.dom.insertElement("p","...",{id:l,ud_oid:u,ud_dupdated:s.ticks,ud_dchanged:s.ticks},c,!1),s.elementsToFetch.push(c)):d?(m=s.dom.insertElement("p","...",{id:l,ud_oid:u,ud_dupdated:s.ticks,ud_dchanged:s.ticks},d,!0),s.elementsToFetch.push(m)):s.reload(!1)}else{var m=s.syncRemovePending.indexOf(l);-1<m?s.syncRemovePending.splice(m,1):"__DELETED"==r.oid?console.log("Deleted element is absent",o,l):l&&"A"!=l[0]&&"Basic model for home directories"!=l&&(console.log("Delete an unfound object in",o),s.reload(!1))}}}else if(this.sync){let t=this.dom.attr(this.topElement,"ud_oid"),s=this.dom.attr(this.topElement,"ud_oidchildren");if(t){"model1"!=this.mode&&"model"!=this.mode||!this.isDirListing()||(s=t.replace("--{OIDPARAM}",""),"UniversalDocElement--21"!=s&&(s+="-21"));a=Date.now()/1e3;let e=Math.round(a-this.maxTicksToFetch/10);this.serverTime&&10<Math.abs(e-this.serverTime)&&(e+=this.serverTime-e);a="/"+UD_SERVICE+"/"+s+"/AJAX_getChanged/?lastTime="+e;i={element:this.topElement,ud:this};this.udajax.serverRequest(a,"GET","",i,this.syncWithServer)}}}isFetchable(e){var t=e.tagName.toLowerCase();return-1<["p","h1","h2","h3","h4","h5","h6"].indexOf(t)||"div"==t&&""!=this.ude.dom.attr(e,"ude_type")}getDBtype(e){let t=this.dom.udjson.value,s=t(UD_exTagAndClassInfo[this.dom.attr(e,"exTagType")],"db_type");return s=s||t(UD_exTagAndClassInfo[this.dom.attr(e,"exTag")],"db_type"),s=s||t(UD_exTagAndClassInfo["p.undefined"],"db_type"),s}getDBidStepFactor(e){let t=this.dom.udjson.value,s=t(UD_exTagAndClassInfo[this.dom.attr(e,"exTagType")],"db_id_step_factor");return s=s||2,s}addTool(e,t,s,n,i=""){if(this.dom.element(t+"-icon")){let e=this.dom.element(t+"-icon");e.remove()}let o=document.createElement("div"),a=document.createElement("img");a.src=s;let l=document.createElement("a");s=document.createTextNode(t);l.appendChild(a),l.appendChild(document.createElement("br")),l.appendChild(s),l.title=t,i&&(l.title=i),l.href="javascript:";i="";let r=e.replace("-selector","-zone");i+="window.ud.loadTool( this,'"+e+"', '"+n+"','"+r+"');",this.dom.attr(l,"onclick",i),o.appendChild(l),this.dom.attr(o,"class","tool-icon"),this.dom.attr(o,"id",t+"-icon"),this.dom.element(e).appendChild(o);let d=t;if("tagger"==t.toLowerCase()&&(d="Inserter"),-1<n.indexOf(".js"))try{this.unitTesting?requirejs(["modules/"+n.replace(".js","")],function(){window.ud.ude.modules["modules/"+n]={src:n,instance:null,state:"loaded"},doOnload("window.ud.ude.modules['modules/"+n+"']['instance'] = new window."+d+"( window.ud, '"+r+"');")}):void 0===window.ud.ude.modules["modules/"+n]&&(window.ud.ude.modules["modules/"+n]={src:n,instance:null,state:"loading"},requirejs(["modules/"+n.replace(".js","")+version],function(){doOnload("window.ud.ude.modules['modules/"+n+"']['instance'] = new "+d+"( window.ud, '"+r+"');window.ud.ude.modules['modules/"+n+"']['state']='loaded';")}))}catch(e){console.log("Load ERR",e.message,d,n)}}loadTool(e,t,s,n){let i=document.getElementById(t);for(var o in i.childNodes)"object"==typeof i.childNodes[o]&&i.childNodes[o].classList.remove("selected");e.parentNode.classList.add("selected");let a=document.getElementById(n);if(a.innerHTML="",-1<s.indexOf(".js")){let e=this.ude.modules["modules/"+s].instance;e&&e.event("open")}else if(s=s.replace(/{topOID}/g,this.dom.attr(document.getElementById("document"),"ud_oid")),!this.unitTesting){let e=new UDAJAX(this,"");e.serverRequest(s+"/e|open/","GET","",{action:"fill zone",zone:n})}}clearTools(e,t){let s=document.getElementById(e).childNodes;for(let e=s.length;0<e;e--)s[e-1].remove();let n=document.getElementById(t);t=n.getElementsByTagName("img")[0];return this.dom.attr(t,"src","/upload/N3u2U2g3W_emptyIcon50.png"),!0}loadDocument(s){if(this.unitTesting||-1<s.indexOf("AJAX_")){let e=s.split("/"),t=e.splice(3,e.length-3);var n=t.join("/"),i={action:"refresh",element:this.topElement,zone:"document"};this.udajax.serverRequest(n,"GET","",i)}else document.location=s;return!0}reload(e=!0,t=""){var s=this.refreshAction[this.mode];let n=this.service+"/"+this.dom.attr(this.topElement,"ud_oid")+"/"+s+"/";return this.isDirListing()&&(n=this.service+"/"+this.dom.attr(this.topElement,"ud_oid")+"-21/"+s+"/"),e?(e={action:"refresh",element:this.topElement},t&&(n+=t+"/"),this.udajax.serverRequest(n,"GET","",e)):location.reload(!0),!0}addToHistory(e){this.currentURL=e;let t=this.dom.element(this.historyElementId);if(!t)return!1;let s=t.textContent.split(",");return-1==s.indexOf(e)&&s.push(e),t.textContent=s.join(","),!0}back(){let e=this.dom.element("UD_history"),t=e.textContent.split(",");var s;2<t.length&&(1<(s=t.indexOf(this.currentURL))&&(s=t[s-1],this.loadDocument(s)))}setClipboardHandler(e){return this.ude.clipboardHandler=e,this}insertElement(e,t,s){this.dom.insertElement_old(e,t,s)}insertText(e,t="plain"){this.ude.insertTextAtCursor(e,t)}prepareHTML(e){}reserveElement(){}insertTable(e,t){return this.ude.insertTableAtCursor(e)}initialiseElement(e){this.ude.initialiseElement(e)}updateTable(e){let t=e,s=this.dom.element(e);return!!s&&("DIV"==s.tagName&&(t=s.getElementsByTagName("table")[0].id),this.ude.updateTable(t))}updateGraphic(e){return this.ude.updateGraphic(e)}insertHTML(e,t){return this.ude.insertHTML(e)}clientSideInterpretor(e){commande}setModel(e,t=!1){var s="reload";debug({level:3},"Server request model "+this.serverRequestId,s,e);var n=this.dom.attr(this.topElement,"ud_oid");let i="nstyle="+e;t&&(i+="&stype=3"),i+="&input_oid="+n,i+="&form="+this.serverFormName;n="/"+this.service+"/"+n+"/AJAX_show/",s={element:this.topElement,action:s,setCursor:!1,ud:this};this.udajax.serverRequest(n,"POST",i,s,null);let o=$$$.getShortcut("translateTerm");s='<div style="text-align:center"><img src="'+UDE_processingIcon+'"><br>';s+=o("Initialisation de la page")+" "+o("avec")+" "+e,this.topElement.innerHTML=s+=".</div>",window.scrollTo(0,0)}copyModel(e){return this.setModel(e,!0)}makeDirectory(e){var t="close";debug({level:3},"Server request model "+this.serverRequestId,t,e);var s=this.dom.attr(this.topElement,"ud_oid"),n="nstyle="+e;n+="&stype=1",n+="&tContent="+this.dom.element("UD_docFull").innerHTML.replace("Nouveau document","Nouveau repertoire"),n+="&input_oid="+s,n+="&form="+this.serverFormName;s="/"+this.service+"/"+s+"/AJAX_fetch/",t={element:this.topElement,action:t,setCursor:!1,ud:this};this.udajax.serverRequest(s,"POST",n,t,null);t='<div style="text-align:center"><img src="'+UDE_processingIcon+'">';this.topElement.innerHTML=t+="<br>Création d'un repertoire avec "+e+".</div>",window.scrollTo(0,0)}setSystemParameters(e){var t="reload";debug({level:3},"Server request system params"+this.serverRequestId,t,e);var s=this.dom.attr(this.topElement,"ud_oid"),e='textra={"system":{'+JSON.stringyfy(e)+"}";e+="&input_oid="+s,e+="&form="+this.serverFormName;s="/"+this.service+"/"+s+"/"+this.refreshAction[this.mode]+"/",t={element:this.topElement,action:t,setCursor:!1,ud:this};this.udajax.serverRequest(s,"POST",e,t,null)}delay(t){return new Promise(e=>{setTimeout(e,t)})}async docParameter(n,i,o=null){if(n&&n!=$$$.getParameter("UD_wellKnown/UD_wellKnownElements/UD_currentDocument","register")){var e=this.dom.elementByName(n);if(!e){let e=this.getDocInfo(n),t={},s="";return e.then(e=>{t=$$$.json.parse("UD_spare"),t&&(s=$$$.json.value(t.params,i),o&&(t.params=$$$.json.value(t.params,i,o)))}).catch(e=>console.log("docParamater",e)),await e,t=$$$.json.parse("UD_spare"),s=$$$.json.value(t.params,i),s}}else{$$$.buildManagePart();n=$$$.json.valueByPath("UD_docParams_object","data/value/"+i);if(await this.delay(50),null==o)return n;$$$.json.valueByPath("UD_docParams_object","data/value/"+i,o);n=$$$.dom.element("MANAGE_params");$$$.dispatchEditEvent({event:"update"},n),$$$.setChanged(n)}return o}async getDocInfo(t){let e=t.split("/");if(1==e.length){let e=this.dom.attr("document","ud_oid");var s="UniversalDocElement--"+e.split("--")[1].split("-").splice(0,2).join("-");return $$$.servicePromise("doc",{action:"getInfo",dir:s,doc:t,dataTarget:"UD_spare",dataMap:{info:"info",params:"params"}},!0)}s=e.pop(),t=e.join("/");return $$$.servicePromise("doc",{action:"getInfo",dirPath:t,doc:s,dataTarget:"UD_spare",dataMap:{info:"info",params:"params"}},!0)}setStyle(e){this.ude.setStyle(e)}addStyleRules(e){e=(e=e.replace(/\n/g,"")).split("}");var t,s=document.createElement("style");for(t in s.appendChild(document.createTextNode("")),document.head.appendChild(s),e)if(-1!=e[t].indexOf("{")){var n=e[t]+"}";s.sheet.insertRule(n,s.sheet.length)||debug({level:1},"addStyleRules Fail on",n);var i=n.substring(0,n.indexOf("{"));-1<i.indexOf(".")&&(i=i.substring(i.indexOf(".")+1));for(var o=document.getElementById("document").getElementsByClassName(i),a=0;a<o.length;a++){var l=o[a];l.classList.remove(i),l.classList.add(i)}}}translateTerm(e,t=0){return debug("Deprecated call to ud.translateTerm"),console.err("Deprecated call to ud.translateTerm"),API.translateTerm(e,replaceUnderscore)}buildPartEditing(e){let n=this.dom.element(e);if(!n)return debug({level:2,return:null},"Can't find part editing zone",e);e=window.udparams.outlineId;let t=this.dom.element(e);if(!t)return debug({level:2,return:null},"Can't find outline or outlineId",e);var i=t.getElementsByTagName("li");for(let s=0;s<i.length;s++){var o=i[s],a=this.dom.attr(o,"target_id"),l=this.dom.element(a);let t=!0,e=this.dom.attr(l,"ud_extra");if(e&&(e=this.dom.udjson.parse(e),e.fromModel&&(t=!1)),l){a=l.id,l=this.dom.attr(l,"ud_oid"),o=o.innerHTML;let e=document.createElement("p");e.id=a+"_manage",e.className=t?"viewname":"viewname noedit",this.dom.attr(e,"ud_oid",l),this.dom.attr(e,"ud_fields","tcontent"),this.dom.attr(e,"ud_dupdated",""+this.ticks),this.dom.attr(e,"ud_dchanged",""+this.ticks),this.dom.attr(e,"ude_stage","on"),this.dom.attr(e,"ude_menu","off"),e.innerHTML=o,n.appendChild(e)}}return n}buildName(e){let t="",s=0,n="",i=this.dom.element("span.caption",e);var o;return n=i?i.textContent:e.innerHTML,-1<n.indexOf("AutoIndex_")&&(s=n.match(/{AutoIndex_([^}]*)}/)),s&&(o="AutoIndex_"+s[1],void 0===window.udparams[o]&&(window.udparams[o]=1),t=n.replace("{"+o+"}",window.udparams[o]),window.udparams[o]++,i?i.textContent=t:e.innerHTML=t),t}run(e){return this.api.run(e)}onTrigger(e,t,s,n=!0){var i=this.dom.element(e);let o=0;for(let e=0;e<this.triggeredActions.length;e++)this.triggeredActions[e]||(o=e+1,this.triggeredActions[e]={fct:s,once:n});switch(o||(this.triggeredActions.push({fct:s,once:n}),o=this.triggeredActions.length),t){case"update":this.dom.attr(i,"ud_onupdate",o);break;case"prepost":this.dom.attr(i,"ud_prepost",o)}}}const UDapiBuffer_requests="UDErequest";class UDapiRequest{constructor(e,t,s=null){var n="",i="",o=null;if("object"==typeof e&&(t=e.command,void 0!==e.quotes&&(n=e.quotes),void 0!==e.callbackId&&(i=e.callbackId),e=e.caller,s=null),s){let e=API.dom;(o=s.target||s)&&(e.attr(o,"udapi_quotes")&&(n=e.attr(o,"udapi_quotes")),e.attr(o,"udapi_callbackid")&&(i=e.attr(o,"udapi_callbackId")),e.attr(o,"udapi_value1")&&(t=t.replace("%value1","'"+e.attr(o,"udapi_value1")+"'")),o.getAttribute("id")&&(t=t.replace("%id","'"+e.attr(o,"id")+"'")))}n&&(t=t.replace(new RegExp(n.charAt(0),"g"),"'").replace(new RegExp(n.charAt(1),"g"),"'")),document.getElementById(UDapiBuffer_requests).textContent+=e+"|"+t+"|"+i+"\n",debug({level:4},"API - command submitted",e,t,i),-1<["Outline"].indexOf(e)&&leftColumn.switchDisplayMode()}}if("object"==typeof process&&(module.exports={UniversalDoc:UniversalDoc,UDapiRequest:UDapiRequest,UDapiBuffer_requests:UDapiBuffer_requests},void 0===global.JSDOM&&"undefined"==typeof window&&"undefined"==typeof ModuleUnderTest)){ModuleUnderTest="ud.js",console.log("Syntax : OK"),console.log("Start of ud.js test program"),console.log("Setting up browser (client) test environment");var envMod=require("../tests/testenv.js");envMod.load(),ud=new UniversalDoc("document",!0,133);const connMod=require("../modules/connectors/udeconnector.js");connMod.init();const drawMod=require("../modules/editors/udedraw.js");let test="Test 1 : retrieve content from integrated page";"Hello big world"==ud.ude.dom.value("B0100000001000000M...textContent")?console.log(test+": OK"):console.log(test+": KO "+ud.ude.dom.value("B0100000001000000M...textContent")),ud.updateElement(ud.dom.element("B0100000001000000M"),'{"stype":10, "nname" : "B0100000001000000M", "nstyle":"", "tcontent":"Hello again", "result":"", "users":"22", "newElement": 0, "modifiableBy":202}'),"Hello again"==ud.dom.value("B0100000001000000M...textContent")?console.log("Test update: OK"):console.log("Test update: KO "+ud.dom.value("B0100000001000000M...textContent")),TEST_serverSaving=!1;let before=API.dom.element("B010000000500000M"),el=document.createElement("p");function nextTest(e){switch(e.testNo){case 2:var t="webdesk/UniversalDocElement--21-725-21--UD|3|NO|OIDLENGTH|CD|5/show/tusername|demo/tpassword|demo/";console.log("GET from server",t),e.udajax.serverRequest(t,"GET","",{ud:e,action:"reload"});break;case 3:"Text"==e.dom.value("B01000000B0000000M...textContent")?console.log("Test 2 : OK"):console.log("Test 2 : KO",e.topElement.innerHTML);break;case 4:console.log("Program's trace checksum: "+debug("__CHECKSUM__")),console.log("Test completed : OK"),process.exit()}e.testNo++}el.textContent="inserted",before.parentNode.insertBefore(el,before),ud.viewEvent("create",el),testResult("Insert test","B0100000001IO00045"==el.id,el.id),API.dom.attr(el,"ud_dupdated",API.dom.attr(el,"ud_dchanged")),ud.Zone=Zone,ud.UDapiRequest=UDapiRequest,ud.domjs=domjs,ud.testNo=2,nextTest(ud),setInterval(function(){nextTest(ud)},5e3)}var UDE_attributes=["ude_datasrc","ude_autosave","ude_stage","ude_onvalid","ude_oninvalid","ude_bind","ude_place","ude_onvalid","ude_oninvalid"],UDE_processingIcon=null,UDE_logo=null,DEBUG_level,displaylib,envMod;class UDE{useCE=!0;bookChangesTimeout=5;modules={"div.table":{src:"modules/editors/udetable.js",state:"required",onload:"new UDEtable( window.ude.dom, window.ude);",instance:null,extags:"div.table",className:"UDEtable"},"div.linetext":{src:"modules/editors/udetext.js",state:"required",onload:"new UDEtext( window.ude.dom, window.ude);",instance:null,extags:"div.linetext",className:"UDEtext"},"div.list":{src:"modules/editors/udelist.js",state:"required",onload:"new UDElist( window.ude.dom, window.ude);",instance:null,extags:"div.list",className:"UDElist"},"div.graphic":{src:"modules/editors/udedraw.js",state:"required",onload:"new UDEdraw( window.ude.dom, window.ude);",instance:null,extags:"div.graphic",className:"UDEdraw"},"div.chart":{src:"modules/udchart/udechart.js",state:"required",onload:"new UDEchart( window.ude);",instance:null,extags:"div.chart",className:"UDEchart"},Udapi:{src:"ud-view-model/udapi.js",state:"required",onload:"new UDapi( window.ude);",instance:null,extags:"",className:"UDapi"},"div.html":{src:"modules/editors/udehtml.js",state:"required",onload:"new UDEhtml( window.ude);",instance:null,extags:"div.html",className:"UDEhtml"},"div.connector":{src:"modules/connectors/udeconnector.js",state:"required",onload:"new UDEconnector( window.ud);",instance:null,extags:"div.connector",className:"UDEconnector"},"div.video":{src:"modules/players/udevideo.js",state:"required",onload:"new UDEvideo( window.ud);",instance:null,extags:"div.video",className:"UDEvideo"}};virtualKeyboardMaxTime=15;menuManager=null;layoutManager=null;editElement=null;editingElement=null;editRestoreHTML=null;editRestoreAttr={};ticks=0;registerAPI=null;dom=null;calc=null;tableEd=null;draw=null;textEd=null;clipboard=null;topOid="";container=null;dataSource=null;updateForm="updateform";modified=!1;directions=["None","Up","Down","Left","Right"];escapedChars={">":"&gt;","<":"&lt"};lastChar="";lastMouseEvent=null;lastMouseEvent=0;stylePopup=null;drawMouse=null;touchMove=!1;externalExchange={request:null,reply:null};dependencies=null;needUpdate=new Array;lockNeedUpdate=!1;mode="";isMobile=!1;forceStagedEditing=!1;tabletMode=!1;maxElementTopOffset=-1;keyDownTime=0;keyUpTime=0;mouseDownTime=0;mouseUpTime=0;averageKeyboardTime=17;ignoreKeyup=!1;watchElementForChange=null;watchElementTextContent="";emulateMobile=!1;elementToScroll=null;lastClickPosition={x:-1,y:-1};inputField=null;replacedElement=null;displayToRestore="block";clipboardHandler=null;enterCommand="/!";endCommand="!/";commandMode=!1;command="";nonEditableClasses=["Noedit"];includePath="/upload/smartdoc/";testing=!1;dummy="...";constructor(e,t,s=0){var n;"object"==typeof process&&(this.testing=!0,window.DOM,window.UDEcalc),this.container=e,(this.dataSource=t)&&"object"==typeof t.dom?this.dom=t.dom:this.dom=new DOM(e,this),this.calc=new UDEcalc(this.dom,this),this.registerAPI=window.UD_resources,this.mode=$$$.dom.textContent("UD_mode"),window.ude=this,void 0!==UDE_menu&&(this.menuManager=new UDE_menu(this)),void 0!==UDE_layout&&(this.layoutManager=new UDE_layout(this)),"undefined"!=typeof API&&API&&(API.addFunctions(this,["changeTagOnCurrent","changeTag","changeClassOnCurrent","changeSubType","changeClass","toggleClass","setAttribute","insertElement","updateElement","updateTable","removeElement","followScroll","initialiseElement","loadScript","getEditType","setChanged","insertTextAtCursor","replaceTextAtCursor","insertHTMLatCursor","isLongClick","dispatchEditEvent","clearClasses","requires2stageEditing","leave2stageEditing","is2stageEditing"]),API.setupUDElinks(this)),void 0!==UDEclickHandler?this.clickHandler=new UDEclickHandler(this):this.clickEvent({type:"start"}),this.keyEvent({type:"start"}),this.pointEvent({type:"start"}),this.dataActionEvent({type:"start"});let i=this.dom.element("scroll");i&&i.addEventListener("scroll",function(e){window.ude.scrollEvent(e)});let o=document.getElementById("leftColumn"),a=document.getElementById("rightColumn");if(o&&a&&(o.addEventListener("dragstart",function(e){window.ude.dataActionEvent(e)}),a.addEventListener("dragstart",function(e){window.ude.dataActionEvent(e)}),o.addEventListener("dragend",function(e){window.ude.dataActionEvent(e)}),a.addEventListener("dragend",function(e){window.ude.dataActionEvent(e)}),o.addEventListener("drop",function(e){window.ude.dataActionEvent(e)}),a.addEventListener("drop",function(e){window.ude.dataActionEvent(e)})),void 0!==s&&(this.ticks=s),setInterval((n=this,function(){n.tick()}),100),this.useCE&&!this.testing&&document.execCommand("defaultParagraphSeparator",!1,"p"),!this.testing&&this.container.getAttribute("contenteditable")&&"true"==this.container.getAttribute("contenteditable").toLowerCase()&&!this.dom.cursor.restore()){this.dom.cursor.HTMLelement=null,window.scrollTo(0,0);var l=this.container.childNodes,r=10;for(let e=0;e<l.length;e++){var d=l[e];if(d&&1==d.nodeType){let e=d.classList;if(!e.contains("hidden")&&!e.contains("system")){this.dom.cursor.HTMLelement=d;break}}}if(this.dom.cursor.HTMLelement)for(;"DIV"==this.dom.cursor.HTMLelement.tagName&&--r&&this.dom.elements("*",this.dom.cursor.HTMLelement).length;)this.dom.cursor.HTMLelement=this.dom.elements("*",this.dom.cursor.HTMLelement)[0];this.dom.cursor.HTMLelement&&(this.dom.cursor.textElement=this.dom.cursor.HTMLelement.firstChild,this.dom.cursor.textElement&&3!=this.dom.cursor.textElement.nodeType&&(this.dom.cursor.HTMLelement=this.dom.cursor.HTMLelement.firstChild,this.dom.cursor.textElement=this.dom.cursor.HTMLelement.firstChild,this.dom.cursor.HTMLoffset=0,this.dom.cursor.set()))}var u=this.dom.elements("div.part","document");for(let e=0;e<u.length;e++){var c=u[e];if("false"==this.dom.attr(c,"contenteditable")){var h=this.dom.elements("span.field",c);for(let e=0;e<h.length;e++){var m=h[e];"off"!=this.dom.attr(m,"ude_edit")&&(this.dom.attr(m,"contenteditable","true"),this.dom.attr(m,"ude_edit","on"),""==this.dom.attr(m,"ude_menu")&&this.dom.attr(m,"ude_menu","off"))}}}if(void 0!==window.UDincludePath)this.includePath=window.UDincludePath;else{var p=document.getElementsByTagName("script");if(p.length){let e=p[0].src;-1<e.indexOf("smartdoc_prod")&&(this.includePath="/upload/smartdoc_prod/")}}var g,p=this.dom.element("UD_device_isMobile");p&&(this.isMobile=parseInt(p.textContent));let f=this.dom.element("UD_requiredModules").textContent;window.ude=this;let v="div.table";"undefined"==typeof UDEtable?-1==f.indexOf("udetable")&&(g=this.modules[v],this.loadScript(g.src,"window.ude.tableEd  = window.ude.modules['"+v+"']['instance']="+g.onload,g.className,v)):this.tableEd=this.modules[v].instance=new UDEtable(this.dom,this),v="div.graphic","undefined"==typeof UDEdraw?-1==f.indexOf("udedraw")&&(g=this.modules[v],this.loadScript(g.src,"window.ude.draw  = window.ude.modules['"+v+"']['instance']="+g.onload,g.className,v)):this.draw=this.modules[v].instance=new UDEdraw(this.dom,this),v="div.linetext",void 0===UDEtext?-1==f.indexOf("udetext")&&(b=this.modules[v],this.loadScript(b.src,"window.ude.textEd= window.ude.modules['"+v+"']['instance']="+b.onload,b.className,v)):this.textEd=this.modules[v].instance=new UDEtext(this.dom,this),window.rollbacker=null;var b=API.dom.element("UD_icons");b&&(b=API.dom.udjson.parse(b.textContent),UDE_processingIcon=b.Processing,UDE_logo=b.Logo)}tick(){if(this.lastChangeElement&&this.ticks-this.lastChangeTicks>this.bookChangesTimeout){if("off"!=this.dom.getParentAttribute("","ude_autosave",this.lastChangeElement))this.setChanged(this.lastChangeElement);else{let e=this.dom.getSaveableParent(this.lastChangeElement);e.classList.add("modified")}this.lastChangeElement=null}if(this.lastMouseEvent&&this.ticks-this.lastMouseEventTime==2&&(this.lastMouseEvent=null),this.watchElementForChange&&this.watchElementForChange.textContent!=this.watchElementTextContent&&this.dataSource.viewEvent("change",this.watchElementForChange),this.ticks%50==0&&!this.forceStagedEditing&&"on"==this.dom.attr(this.container,"ude_stage")){this.forceStagedEditing=!0,this.tabletMode=!0,this.maxElementTopOffset=Math.round(.4*window.innerHeight);let e=this.dom.element("header");if(e.classList.add("hidden"),!this.dom.element("escapeButton")){let e=this.dom.insertElement("span","ESC",{id:"escapeButton",class:"button"},this.dom.element("content"),!0,!0);e.style.cssText="position:absolute; z-index:20; top:50px; left:10px;",e.addEventListener("click",function(e){window.ude.leave2stageEditing(!1)});let t=this.dom.element("content");t.style.height=t.clientHeight+50+"px"}}this.ticks++,6<this.ticks&&this.ticks%5==0&&this.calc.do(50)}isBusy(){for(var e in this.modules)if("loading"==this.modules[e].state)return!0;return!1}clickEvent(n){let i=!1;if("start"==n.type)return this.dom.topElement.addEventListener("click",function(e){window.ude.clickEvent(e)}),this.dom.topElement.addEventListener("touchstart",function(e){window.ude.clickEvent(e)}),this.dom.topElement.addEventListener("touchend",function(e){window.ude.clickEvent(e)}),!0;if(this.drawMouse)this.drawMouse=null;else{n.event=n.type;let s=n.target;if(!s&&void 0!==n.composedPath){var o=n.composedPath();for(let t=0;t<o.length;t++){let e=o[t];if(-1<e.className.indexOf("Noedit")&&(this.dom.cursor.set(),i=!0),"document"==e.id)break}}if("document"==s.id)return n.preventDefault(),!0;if(0==this.dom.parentAttr(s,"id").indexOf("_TMP"))return!1;if(this.watchElementForChange=null,!this.menuManager.click(s,n)){let e=!1;""==this.dom.parentAttr(s,"onclick")&&"a"!=s.tagName&&"a"!=s.parentNode.tagName||(e=!0);var a=this.dom.attr(s,"exTag");let t=!0;if((!s||"div.page"==a||!API.testEditorAttr(s,"ude_edit")&&"input"!=a||e&&"link"!=this.dom.attr(s.parentNode,"ud_type"))&&(t=!1),"mousedown"==n.type)return this.mouseDownTime=this.ticks,void(t||n.preventDefault());if("mouseup"==n.type)return this.mouseUpTime=this.ticks,void(t||n.preventDefault());if("touchstart"!=n.type){if("touchend"!=n.type||!this.touchMove){if(!i&&t){if(this.editElement&&this.clearClasses(this.editElement,"editing,edcontainer,edinside"),this.editElement=null,this.dom.cursor.fetch(),i=i||this.dispatchEvent(n,s),this.requires2stageEditing(s)&&(s=this.editingElement),!i&&this.registerAPI.testEditorAttr(s,"ude_menu")){var l=this.dom.getSaveableParent(s);let e=this.dom.getEditableParent(s,this.dom.cursor.selectionInNode);this.toggleClass(l,"editing"),this.clearClasses(l,"edcontainer"),this.clearClasses(s,"edinside"),0!=this.dom.attr(e,"exTag").indexOf("span")||e.classList.contains("caption")||(this.toggleClass(l,"edcontainer"),this.toggleClass(s,"edinside")),this.editElement=l,this.dom.cursor.selectionInNode&&-1==["div.editzone"].indexOf(this.dom.attr(e,"exTag"))&&!e.classList.contains("linetext")?i=this.menuManager.display(this.dom.getEditableParent(s),this.dom.cursor):this.dom.cursor.selectionMultiNode?this.menuManager.hide():i=this.menuManager.display(s)}if(!i&&this.emulateMobile){let t=this;this.dom.topElement.addEventListener("mousemove",function(e){t.pointEvent(e)});a=n.clientX,l=n.clientY;this.lastClickPosition.x=a,this.lastClickPosition.y=l,i=!0}}else if("INPUT"==s.tagName||e)i=!1;else if(e)this.editElement&&this.clearClasses(this.editElement,"editing,edcontainer,edinside"),this.editElement=null,this.menuManager.hide(),this.leave2stageEditing(!0),this.dom.cursor.clear();else{n.ud_clickable=!1,n.ud_editable=!1,i=i||this.dispatchEvent(n,s),this.dom.cursor.set();let e=this.dom.getSaveableParent(s);e.classList.contains("collapsable")&&(this.editElement=null,this.menuManager.hide(),this.leave2stageEditing(!0),this.editElement=this.dom.getSaveableParent(s),this.menuManager.display(this.editElement),i=!0)}return i&&n.preventDefault(),i}}else this.touchMove=!1}}}isLongClick(e){return!1}detectVirtualKeyboard(e){"keydown"==e&&(this.keyDownTime=(new Date).getTime()),"keyup"==e&&(this.keyUpTime=(new Date).getTime(),e=this.keyUpTime-this.keyDownTime,this.averageKeyboardTime=Math.round(this.averageKeyboardTime+(e-this.averageKeyboardTime)/2),e<this.averageKeyboardTime&&debug({level:5},"New record keyboard time !: ",e,this.averageKeyboardTime),this.averageKeyboardTime<this.virtualKeyboardMaxTime?this.forceStagedEditing=!0:this.forceStagedEditing=!1)}keyEvent(e){let i=!1;if("start"==e.type)return this.dom.topElement.addEventListener("keypress",function(e){window.ude.keyEvent(e)}),this.dom.topElement.addEventListener("keydown",function(e){window.ude.keyEvent(e)}),this.dom.topElement.addEventListener("keyup",function(e){window.ude.keyEvent(e)}),!0;let o=this.dom.cursor.fetch().HTMLelement;if(o&&o.id&&0==o.id.indexOf("_TMP"))return!1;var s=this.dom.cursor.textElement;if(debug({level:6},"Key "+e.key,e,o),!o||this.menuManager.click(o))return!1;var n=this.dom.attr(o,"exTag");let a=this.dom.getSaveableParent(o);var l=this.dom.getDisplayableParent(o);if(!this.testing&&!this.dom.isInViewport(o))return!1;this.detectVirtualKeyboard(e.type);let r=e.key;e.ctrlKey&&(r+="_ctrl",e.shiftKey&&(r+="_shift"));let d="";switch(r){case"Escape":(this.leave2stageEditing(!1)||this.inlineCommandManager(r))&&(i=!0),this.dom.cursor.clear();break;case"Backspace":case"Delete":if("input"==n)break;o;if("keyup"==e.type)API.getEditorAttr(o,"ude_place")&&""==o.textContent&&o.classList.add("placeHolding"),this.ignoreKeyup&&(i=!0),this.requires2stageEditing(this.dom.cursor.HTMLelement)||"off"==this.dom.getParentAttribute("","ude_autosave",this.dom.cursor.HTMLelement)||(window.rollbacker&&window.rollbacker.inputEvent({event:"change",content:o.innerHTML},o),this.setChanged(o));else if("keydown"==e.type||"keypress"==e.type){if(this.ignoreKeyup=!1,d="Key "+r,i=this.dispatchEvent({event:d,saveable:a,displayable:l},o),d="",i)break;let s=this.dom.cursor;if(this.dom.cursor.selectionMultiNode){this.dom.getSaveableParent(o);setTimeout(function(){window.ud.ude.dispatchEvent({event:"change",multinode:"true"},o)},100)}else{if(s.selectionInNode){if(s.textElement){let e=s.textElement,t=e.textContent;s.textOffset,s.focusOffset;e.textContent=t.substr(0,s.textOffset)+t.substr(s.focusOffset)}s.selectionInNode=!1,i=!0,this.dom.cursor.set()}if(this.is2stageEditing(o)&&o.textContent){if(!(this.dom.cursor.textOffset<=1))return;o.textContent=o.textContent.substring(1),this.dom.cursor.textElement=o.childNodes[0],this.dom.cursor.set(),i=!0}else{var u=this.dom.cursor.textElement,c=u?u.textContent:"";0==this.dom.cursor.textOffset&&"Backspace"==r?d="merge up":this.dom.cursor.textOffset==c.length&&"Delete"==r?d="merge down":""!=o.innerHTML&&"<br>"!=o.innerHTML||(d="remove");var h=o.innerHTML,c=API.getEditorAttr(o,"ude_place");c&&h==c&&(this.dom.cursor.textElement.textContent=""),d&&(this.dispatchEvent({event:d,saveable:a,displayable:l},o)?i=!0:this.editEventDefault({type:d,textEl:u},o),i=!0)}}}break;case"Enter":case"Enter_shift":case"\n":case"\r":if("input"==o.tagName.toLowerCase())break;if(!this.dom.isEditable(o)){i=!0;break}if("keydown"==e.type||"keypress"==e.type){e.preventDefault();break}var m={event:"newline",type:"newline",HTMLoffset:this.dom.cursor.HTMLoffset};if(e.shiftKey){var p=document.createElement("br");let e=document.createTextNode("..."),t=this.dom.cursor.textElement;var g=this.dom.cursor.textOffset;let s=t.textContent;g<s.length&&(e.textContent=s.substr(g),t.textContent=s.substr(0,g));let n=Array.from(o.childNodes);g=n.indexOf(t);if(g<0)break;++g>=n.length?(o.appendChild(p),o.appendChild(e)):(o.insertBefore(p,n[g]),o.insertBefore(e,n[g])),this.dom.cursor.textElement=e,this.dom.cursor.textOffset=0,this.dom.cursor.set(),this.setChanged(o),i=!0}else(i=this.leave2stageEditing(!0))||!o.classList.contains("caption")&&(i=this.dispatchEvent(m,o))||(i=this.editEventDefault(m,o));break;case"Tab":if("keyup"==e.type){i=!0;break}let t=null;switch(n){case"th":case"td":if(e.shiftKey)if(o.previousSibling)t=o.previousSibling;else{let e=o.parentNode;e=e&&e.previousSibling,e&&(t=e.cells[e.cells.length-1])}else if(o.nextSibling)t=o.nextSibling;else if("th"==n)d="insert column";else{let e=o.parentNode;e=e&&e.nextSibling,e?t=e.cells[0]:d="newline"}t?(this.dom.cursor.setAt(t),this.leave2stageEditing(!0),this.requires2stageEditing(t),i=!0):d&&(i=!!this.dispatchEvent({event:d,saveable:a,displayable:l},o)||this.editEventDefault({type:d,textEl:s},o))}break;case"Insert":case"Shift":i=!0;break;case"c_ctrl":case"C_ctrl":case"c_ctrl_shift":case"C_ctrl_shift":case"v_ctrl":case"V_ctrl":case"v_ctrl_shift":case"V_ctrl_shift":case"x_ctrl":case"X_ctrl":case"x_ctrl_shift":case"X_ctrl_shift":"keydown"!=e.type&&(i=!0);break;case"shift":case"Shift":case"shift_shift":case"Shift_shift":case"control":case"Control":case"Control_ctrl":case"control_ctrl":case"altGraph":case"AltGraph":i=!0;break;case"ArrowLeft":if(this.editingElement==o){this.dom.cursor.textOffset<=0&&(this.leave2stageEditing(!0),o=o.previousSibling,o&&(this.dom.cursor.setAt(o,1e4),this.requires2stageEditing(o)));break}if(o.classList.contains("objectName")&&0==this.dom.cursor.textOffset){i=!0;break}case"ArrowRight":if(this.editingElement==o){this.dom.cursor.textOffset>=o.textContent.length-1&&(this.leave2stageEditing(!0),o=o.nextSibling,o&&(this.dom.cursor.setAt(o,0),this.requires2stageEditing(o)));break}if("ArrowRight"==r&&o.classList.contains("objectName")&&this.dom.cursor.textOffset==o.textContent.length){i=!0;break}case"ArrowUp":case"ArrowDown":this.leave2stageEditing(!0),"keyup"!=e.type||this.menuManager.box||this.floaterActionPending?(f={event:r,type:r,saveable:a,displayable:l},i=this.dispatchEvent(f,o),i&&(o=this.dom.cursor.fetch().HTMLelement,this.requires2stageEditing(o))):i=this.edit();break;case"PageUp":case"PageDown":if("keyup"==e.type&&!this.menuManager.box&&!this.floaterActionPending){var f;let e=a.parentNode;"div.page"==this.dom.attr(e,"exTag")&&(e="PageDown"==r?e.nextSibling.nextSibling:e.previousSibling.previousSibling,(f=e.childNodes[0])&&(this.dom.cursor.setAt(f),this.dom.makeVisible(f))),i=!0}break;case"Unidentified":default:if("input"==n){let e=this.dom.attr(o,"ude_accept");var v=e.replace(/this/g,r);v&&!this.calc.eval(v)&&(i=!0)}else this.inlineCommandManager(r)?e.preventDefault():(this.editingElement||("Unidentified"!=r&&this.requires2stageEditing(o)||(window.rollbacker&&window.rollbacker.inputEvent({event:"change",content:o.innerHTML},o),(this.lastChangeElement&&o!=this.lastChangeElement||-1<[";"].indexOf(r))&&("off"!=this.dom.getParentAttribute("","ude_autosave",o)?this.setChanged(o):a.classList.add("modified"),this.lastChangeElement=null),this.lastChangeElement=o,this.lastChangeTicks=this.ticks),"P"==o.tagName&&o.classList.contains("undefined")&&20<o.textContent.length&&(o.classList.remove("undefined"),o.classList.add("standard"),this.dataSource.viewEvent("changeTag",o))),this.lastChar=r,this.hasDefaultContent(o)&&"keydown"==e.type&&("Unidentified"==r?o.innerHTML="":(o.innerHTML=r,this.dom.cursor.textElement=o.firstChild,this.dom.cursor.textOffset=1,this.dom.cursor.HTMLoffset=1,this.dom.cursor.set(),o.classList.remove("initialcontent"),i=!0)),o.classList.contains("undefined")&&(o.classList.remove("undefined"),this.changeTag("p",o.id),o.textContent=r),(v=this.dom.attr(o,"onchange"))&&doOnload(v))}return i&&(debug({level:6},"Stopping propagation"),this.ignoreKeyup=!0,e.preventDefault(),void 0!==e.stopPropagation&&e.stopPropagation(),a&&this.menuManager&&this.menuManager.updatePosition(a)),i}pointEvent(e){let t=!1;if("start"==e.type)return this.dom.topElement.addEventListener("mouseover",function(e){window.ude.pointEvent(e)}),this.dom.topElement.addEventListener("mousewheel",function(e){window.ude.pointEvent(e)}),this.dom.topElement.addEventListener("focus",function(e){window.ude.pointEvent(e)}),this.dom.topElement.addEventListener("blur",function(e){window.ude.pointEvent(e)}),this.dom.topElement.addEventListener("touchmove",function(e){window.ude.pointEvent(e)}),!0;this.lastMouseEvent=e,this.lastMouseEventTime=this.ticks;let s=e.target,n=null;var i,o,a;switch(n=void 0!==e.composedPath?e.composedPath():e.path,n&&"canvas"==n[0].tagName.toLowerCase()&&(s=n[0],i=this.dom.getSaveableParent(s),"div.graphic"==this.dom.attr(i,"exTag")&&(this.drawMouse=s)),e.type){case"touchmove":2<Object.keys(e.changedTouches).length&&(this.touchMove=!0);break;case"mousemove":t=this.emulateMobile&&this.elementToScroll?(o=e.clientX,a=e.clientY,-1<this.lastClickPosition.x&&(this.lastClickPosition.x,o=a-this.lastClickPosition.y,a=this.dom.element("scroll"),a=this.elementToScroll.scrollHeight/this.dom.attr(a,"computed_height"),0<o&&(this.elementToScroll.style.marginTop=-o*a+"px")),!0):this.dispatchEvent({event:e.type,target:s},s);break;case"mouseout":this.lastMouseEvent=null,t=this.dispatchEvent({event:e.type,target:s},s);break;case"mousedown":case"touchstart":t=this.dispatchEvent({event:e.type,target:s},s);break;case"mouseup":case"touchend":this.drawMouse?(t=this.draw.inputEvent(e,this.drawMouse),this.drawMouse=null):t=this.dispatchEvent({event:e.type,target:s},s);break;case"mousewheel":this.drawMouse&&(t=this.draw.inputEvent(e,s))}return t&&e.preventDefault(),t}dataActionEvent(l){let r=!1,d=!1;if("start"==l.type){this.dom.topElement.addEventListener("paste",function(e){window.ude.dataActionEvent(e)}),this.dom.topElement.addEventListener("copy",function(e){window.ude.dataActionEvent(e)}),this.dom.topElement.addEventListener("cut",function(e){window.ude.dataActionEvent(e)}),this.dom.topElement.addEventListener("dragstart",function(e){window.ude.dataActionEvent(e)}),this.dom.topElement.addEventListener("dragend",function(e){window.ude.dataActionEvent(e)}),this.dom.topElement.addEventListener("drop",function(e){window.ude.dataActionEvent(e)}),this.dom.topElement.addEventListener("dragover",function(e){window.ude.dataActionEvent(e)}),this.dom.topElement.addEventListener("contextmenu",function(e){window.ude.dataActionEvent(e)});let e=this.dom.element("middleColumn");return e&&(e.addEventListener("dragenter",function(e){window.ude.dataActionEvent(e)}),e.addEventListener("dragover",function(e){window.ude.dataActionEvent(e)}),e.addEventListener("drop",function(e){window.ude.dataActionEvent(e)})),!0}debug({level:6},"Data action",l.type,l.target,l);let u=this.dom.cursor.fetch().HTMLelement;var e=this.dom.getSaveableParent(u);this.dom.getDisplayableParent(u);let c=null,h=null,m=[];var p=this.dom.attr(e,"exTag");switch(l.type){case"paste":let s="",n="",i="",e=this.dom.element("LastClip");if(e)i=this.dom.attr(e,"cb_type"),s=e.innerHTML;else{document.getElementById("UDEclipboard");let e=l.clipboardData.types;if(e instanceof DOMStringList&&e.contains("text/html")||e.indexOf&&-1!==e.indexOf("text/html"))i="text/html",s=l.clipboardData.getData("text/html"),n=l.clipboardData.getData("text/plain");else if((e instanceof DOMStringList&&e.contains("text/plain")||e.indexOf&&-1!==e.indexOf("text/plain"))&&(i="text/plain",s=l.clipboardData.getData("text/plain"),this.is2stageEditing(u))){$$$.hasDefaultContent(u)?u.textContent=s:this.insertTextAtCursor(s),r=!0;break}}if(this.clipboardHandler){var g=this.dom.getEditableParent(u);let e=this.dom.attr(g,"ud_type");-1<["editzone","viewzone"].indexOf(e)&&(e=this.dom.attr(g,"ud_subtype"));let t="html";-1<["text","linetext","css","json","js","htmltext","connector"].indexOf(e)&&(t="text",n&&"htmltext"!=e&&(s=n)),m=this.clipboardHandler.preparePasteEvents(this.clipboardHandler.preparePastedData(i,s),t)}else s&&(h={event:"paste",type:"paste",data:s,mime:i});e&&e.remove(),r=!0;break;case"copy":case"cut":debug(1,null,"2DO copy/cut events",l),-1<["div.css","div.js"].indexOf(p)&&-1==UD_SERVER.indexOf("https//")&&(d=!0),h=l,h.event=h.type;break;case"drag":case"dragstart":console.log("Drag Start event",l);let t=l.target,o="",a="";0==t.id.indexOf("move")?(a=t.id.substr(4),o=""):"img"==t.tagName.toLowerCase()&&t.classList.contains("CLIPBOARD")||(t.classList.contains("CLIPBOARD_clip")?(o=l.target.innerHTML,a=l.target.id):"dir"==this.dom.attr(t.parentNode.parentNode.parentNode.parentNode,"id")&&(o=this.dom.attr(t.parentNode.parentNode,"onclick"),a="dir")),l.dataTransfer.setData("text/html",o),l.dataTransfer.setData("text/plain",a),l.stopPropagation(),r=!1;break;case"dragenter":c=l.target,"middleColumn"==c.id&&(r=!0);break;case"dragover":l.dataTransfer.dropEffect="move",r=!0;break;case"dragend":case"drop":console.log("Drop event"),console.log(l);var f=l.dataTransfer.getData("text/html"),v=l.dataTransfer.getData("text/plain"),b=l.composedPath();if(c=this.dom.getSaveableParent(b[0]),c){var x=this.dom.element(v);if("UD_wasteBin"==c.id){let e=f;let t=e.split("/")[2];t=t.split("--")[1].split("-").slice(0,-1);var y="UniversalDocElement--"+t.join("-")+"--SP|"+(Math.round(t.length/2)-1)+"|WB|1",g="/webdesk/"+this.dom.attr("document","ud_oidchildren")+"/AJAX_modelShow/",b=API.translateTerm("Are you sure ?");confirm(b)&&(b={zone:"document",element:null,action:"fill zone",setCursor:!1,ud:this.dataSource},this.dataSource.udajax.serverRequest(g,"POST","form=INPUT_UDE_FETCH&input_oid="+y+"&iaccess=0&tlabel=owns",b))}else this.dom.getSaveableParent(c)==c&&this.dom.attr(x,"ud_oid")?"middleColumn"==c.id?API.copyToClipboard(v,!0):c.id&&"B"==c.id[0]&&(x=c.parentNode.insertBefore(x,c),this.dataSource.viewEvent("move",x)):f&&window.clipboarder.insert(v,c)}r=!0;break;case"contextmenu":console.log(l);l.composedPath();this.dom.attr(u,"ud_oid")&&(this.watchElementForChange=u,this.watchElementTextContent=u.textContent)}for(let e=0;e<m.length;e++){var t=m[e];this.dispatchEvent(t,u)||this.editEventDefault(t,u)}return h&&((r=this.dispatchEvent(h,u))||(r=this.editEventDefault(h,u))),r&&!d&&-1<!["copy"].indexOf(l.type)&&(l.preventDefault(),void 0!==l.stopPropagation&&l.stopPropagation()),r}scrollEvent(e){this.menuManager&&this.menuManager.scroll(e)}editEventDefault(h,m){if(m){let d=!1;var p=h.type;let u=this.dom.getSaveableParent(m);var g=this.dom.attr(u,"exTag");let c=["h1","h2","h3","h4","h5","h6","p","p.undefined","span","span.field"];if(-1==c.indexOf(g)&&"newline"!=p)return!1;switch(p){case"merge up":{let t=h.textEl,e=Array.from(t.parentNode.childNodes);var f=e.indexOf(t);let s=m.previousSibling;if(!f&&s&&-1<c.indexOf(this.dom.attr(s,"exTag")))m=u,s.innerHTML+=m.innerHTML,this.setChanged(s),this.dom.cursor.setAt(s,9999),m.innerHTML="",API.removeElement(m.id),d=!0;else if(f){let e=t.previousSibling;e&&e.nodeType==Node.ELEMENT_NODE&&"BR"==e.tagName?(e.previousSibling.textContent+=t.textContent,e.remove(),t.remove(),d=!0):e&&e.nodeType==Node.TEXT_NODE&&(e.textContent+=t.textContent,t.remove(),d=!0)}break}case"merge down":{let t=h.textEl,e=Array.from(t.parentNode.childNodes);var v=e.indexOf(t);let s=m.nextSibling;if(!v&&s&&-1<c.indexOf(this.dom.attr(s,"exTag")))m=u,s.innerHTML=m.innerHTML+s.innerHTML,this.setChanged(s),this.dom.cursor.setAt(s,0),m.innerHTML="",API.removeElement(m.id),d=!0;else if(v){let e=t.nextSibling;e&&e.nodeType==Node.ELEMENT_NODE&&"BR"==e.tagName?(e.nextSibling.textContent+=t.textContent,e.remove(),t.remove(),d=!0):e&&e.nodeType==Node.TEXT_NODE&&(e.textContent+=t.textContent,t.remove(),d=!0)}break}case"remove":m.innerHTML="",this.source.viewEvent("remove",m),d=!0;break;case"insert row":case"newline":let t="div",s="undefined",n="";v=$$$.availableTags(u);if(1==v.length){let e=v[0];var b=e.split(".");t=b[0],s=1<b.length?b[1]:"standard",n="..."}let e=!1;if(-1<c.indexOf(g)){v=this.dom.cursor.textElement.textContent.length,b=this.dom.cursor.textOffset;if(0==b)e=!0;else if(b<v){let e=this.dom.cursor.HTMLelement.innerHTML;var x=this.dom.cursor.computeHTMLoffset(this.dom.cursor.textElement.textContent,b,e);n=e.substr(x),s="",this.dom.cursor.HTMLelement.innerHTML=e.substr(0,x),"off"!=this.dom.getParentAttribute("","ude_autosave",this.dom.cursor.HTMLelement)&&this.setChanged(this.dom.cursor.HTMLelement)}}x={class:s};let i=this.insertElement(t,n,x,u,!e);n||"undefined"!=s||(i.innerHTML=$$$.getUndefinedElementContent(i)),this.editElement&&this.toggleClass(this.editElement,"editing"),this.editElement=null,this.menuManager.hide(),this.toggleClass(i,"editing"),this.editElement=i,this.dom.cursor.setAt(i),this.menuManager.display(i),d=!0;break;case"copy":window.clipboarder.copyTo();d=!0;break;case"cut":window.clipboarder.copyTo("",!0);d=!0;break;case"paste":let o=this.dom.cursor.HTMLelement,a=h.data,l=this.dom.attr(m,"exTag");if("image"==h.type||a&&-1<a.indexOf("<img")){let e=/src="([^"]+)"/;var x=e.exec(h.data)[1],y=1.3*m.getBoundingClientRect().height;a='<img src="'+x+'" style="max-height:'+y+'px;">',h.type="image"}if(console.log("Default pasting",a,m),this.dom.hasDefaultContent(o)?o.innerHTML=a:this.insertHTMLatCursor(a),0==l.indexOf("span")){y=document.createTextNode("Enter to validate"),y=m.appendChild(y);this.dom.cursor.HTMLelement=m,this.dom.cursor.textElement=y,this.dom.cursor.textOffset=0,this.dom.cursor.set()}else if("image"==h.type){let t=u.classList;for(let e=0;e<t.length&&!(-1<t[e].indexOf("LAY_"));e++)e==t.length-1&&u.classList.add("LAY_left")}this.requires2stageEditing(this.dom.cursor.HTMLelement)||this.setChanged(this.dom.cursor.HTMLelement);case"endPaste":d=!0;break;case"setValue":let r=h.key;r.unshift(m.id),this.dom.value(r,h.value,m),API.setEditorAttrPermanently(m,r[r.length-1],h.value);break;case"use":case"idea":API.insertTextAtCursor(h.data)}return d&&u&&this.menuManager&&this.menuManager.updatePosition(u),d}}loadScript(t,s,e="",n=""){var i=(i=t.split("/").pop().split(".",1).pop()).charAt(0).toUpperCase()+i.slice(1);if(void 0!==this.modules[t]&&"required"!=this.modules[t].state){if("loaded"==window.ud.ude.modules[t].state)return s&&doOnload(s),!0}else{if(!this.testing){{console.log("loading "+t);var o=document.createElement("script");o.id=n=n||t,o.onerror=function(){debug({level:2},t+" is not available"),window.ud.ude.modules[n].state="unavailable"},o.onload=function(){let e=window.ud.ude.dom.element(n).textContent;if(!(-1<e.indexOf("SOILinks error :")))return debug({level:2},t+" is loaded (old method)"),window.ud.ude.modules[n].state="loaded",window.ud.ude.modules[n].onload&&doOnload(window.ud.ude.modules[n].onload),!0;debug({level:2},t+" is not available"),window.ud.ude.modules[n].state="unavailable"};let e="";void 0!==this.modules[n]&&(e=this.modules[n].state),-1==["undefined","unavailable"].indexOf(e)&&(o.src=this.includePath+t.replace(".js","")+window.version+".js",document.body.appendChild(o),n?this.modules[n]={state:"loading",onload:s}:this.modules[t]={state:"loading",onload:s})}return!1}o=require("../"+t);e&&n&&(o=o.class,o=doOnload(s.replace(/new[^\(]*\(/,"new "+o+"(")),void 0!==this.modules[n]&&(this.modules[n].state="loaded",this.modules[n].instance=o))}}loadCustomModule(e,t){var s="modules/custom/"+e.toLowerCase()+".js",n="new "+e+"( window.ude.dom, window.ude);";return this.modules[t]={src:s,state:"required",onload:n,className:e,instance:null,exTags:t},this.loadScript(s,n,e,t)}dataEvent(e,t){switch(e){case"created":this.initialiseElement(t);break;case"changed":this.updateElement(t)}}updateTable(e,t=!1){var s;this.tableEd?this.tableEd.update(e,t):(s=this,setTimeout(function(){s.updateTable(e,t)},100))}initialiseElement(n){window.UDE_init=!0;let i=this.dom.element(n);if(i){let t=i.tagName.toLowerCase();var o=this.dom.attr(i,"ud_type");o&&(t+="."+o);let e=this.dom.udjson.value;this.dom.udjson.valueByPath;o&&e(UD_exTagAndClassInfo[t],"useTextEditor")&&(t="div.linetext");let s=this.modules[t];if(s){if(s.instance)s.instance.initialise(i.id);else if(console.log("Module required but not yet loaded "+s.src),1==i.childNodes.length&&"{"==i.childNodes[0].textContent[0]&&e(UD_exTagAndClassInfo[t],"earlyInit")){debug({level:5},"Default initialising",i);var a=i.childNodes[0].innerHTML,n=JSON.parse(a),o=JSONvalue(n,"meta");if(o){a=JSONvalue(o,"name"),a=this.dom.udjson.putElement(n,a+"_object","",this.dom.keepPermanentClasses(i.className,!0));i.appendChild(a),-1<["div.table"].indexOf(t)&&this.updateTable(o.name);let e=this.dom.elements("div",a);1<e.length&&(e[0].classList.add("hidden"),e[1].classList.remove("hidden"))}if(e(UD_exTagAndClassInfo[t],"needsOwnInit")){let e=this;setTimeout(function(){e.initialiseElement(i)},100)}}else{let e=this;setTimeout(function(){e.initialiseElement(i)},100)}window.UDE_init=!1}}else window.UDE_init=!1}updateGraphic(e){var t=document.getElementById(e),t=this.dom.attr(t,"ude_bind");this.draw.renderToCanvas(t,e)}getValueFromTable(e,t,s){return this.dom.getValueFromTable(e,t,s)}setStyle(e){debug({level:1},"Old call UDE.setSTyle DEPRECATED"),this.dom.cursor.setStyle(e)}substr(e,t,s){return e.substr(t,s)}changeTagOnCurrent(e){var t,s=this.dom.availableTags[e].split("."),n="";1<s.length&&(n=s[1]),s=s[0],this.dom.cursor.HTMLelement&&(e=(t=this.dom.cursor.HTMLelement).id,this.dom.changeTag(t,s,n),t=this.dom.element(e),this.dataSource.viewEvent("changeTag",t),n&&this.initialiseElement(e))}changeTag(s,n,i=""){let o=s;o=(Number.isInteger(s)?this.dom.availableTags[s]:s).split(".");var a=o.join(".");let l="";1<o.length&&(l=o[1]),o=o[0];let r=this.dom.element(n);if(!r)return null;var d=r.id;if("p.undefined"==a)"p"!=this.dom.attr(r,"exTag")&&(r=this.dom.changeTag(r,"p")),r.classList.contains("editing")?r.className="undefined editing":r.className="undefined";else{let e="changeTag";var u=this.dom.attr(r,"exTag"),s=this.dom.elements("div.panel-block",r).length,n=r.classList.contains("undefined");(n||s)&&(r.classList.remove("undefined"),r.innerHTML="",e="create"),r=this.dom.changeTag(r,o,l),i&&this.dom.attr(r,"ud_subtype",i);let t=$$$.getTagOrStyleInfo(a,"autoClass");if(t){Array.isArray(t)||(t=t.split(" "));for(let e=0;e<t.length;e++)r.classList.add(t[e])}$$$.updateContentAfterEvent(r,{eventType:"changeTag",oldTag:u,wasUndefined:n}),r=this.dom.element(d),this.dom.cursor.setAt(r);n=this.dom.elements("div.panel-block",r).length;n||this.dataSource.viewEvent(e,r),l&&!n&&this.initialiseElement(r.id)}return this.editElement.id==d&&this.menuManager.display(r),r}changeSubType(e,t){let s=this.dom.element(t);if(!s)return debug({level:3,return:!1},"Can't change subtype on",t);API.dom.attr(s,"ud_subtype",e),e||(s.className=this.dom.keepTemporaryClasses(s.className))}changeClassOnCurrent(e){var t=this.dom.cursor.HTMLelement;if(!t)return!1;this.changeClass(e,t)}changeClass(t,e,s=null,n="document"!=e){let i=this.dom.element(e);if(!i)return debug({level:3,return:!1},"Can't change class on",e);let o=[t];t.indexOf(".")&&(o=t.split("."));let a="";if(s){var l="string"==typeof s?s.split(","):s;for(let e=0;e<l.length;e++)i.classList.contains(l[e])&&(a=a||l[e],i.classList.remove(l[e]))}else void 0!==UD_ressources&&API.hasDefaultContent(i,a)&&this.dom.keepPermanentClasses(o.join(" "))&&(i.innerHTML=API.defaultContent(i,API.getViewType(i),o[0]),this.dataSource.viewEvent("changeClass",i));let r=!1;for(let e=0;e<o.length;e++)""!=(t=o[e])&&(i.classList.contains(t)&&e==o.length-1?(i.classList.remove(t),r=!0,a=a||t):-1==t.indexOf(" ")&&(i.classList.add(t),r=!0));if("span"==this.dom.attr(i,"exTag")&&""==this.dom.keepPermanentClasses(i.className)){i.parentNode;let e=i.previousSibling;e&&e.nodeType==Node.TEXT_NODE&&(e.textContent+=i.textContent,i.remove(),i=e,this.editingElement=i,this.clearClasses(this.dom.getSaveableParent(i),"edcontainer"))}return n&&API.dispatchClassChange(i,a,t),r}toggleClass(e,t){return this.changeClass(t,e)}clearClasses(e,t){e=this.dom.element(e);this.changeClass("",e,t);var s=this.dom.children(e);for(let e=0;e<s.length;e++)this.changeClass("",s[e],t)}toggleClasses(e,t){return this.changeClass(t.join(","),e)}insertElement(e,t,s={},n=null,i=!1,o=!1){let a=null;if(a=n?this.dom.insertElement(e,t,s,n,i,o):this.dom.insertElementAtCursor(e,t,s),a.classList.contains("undefined")){let e="";a.previousSibling?e="_AFTER_"+a.previousSibling.id:a.nextSibling&&(e="_BEFORE_"+a.nextSibling.id),a.id="__TMP"+e+"__"}else this.dataSource.viewEvent("create",a),window.UDE_lastInsertId=a.id,API.paginate(this.dom.getView(a.id));return a}updateElement(e,t){let s=this.dom.element(e);var n=this.dom.getSaveableParent(s);return s?(s.innerHTML=t,n&&this.dataSource.viewEvent("change",n),API.paginate(this.dom.getView(s)),s):debug({level:3,return:null},"Can't update ",e)}setAttribute(e,t){debug({level:1},"Old call UDE.setAttribute DEPRECATED"),"outlineCurrentElementCSS"===e&&(this.dom.cursor.outlineCurrentElementCSS=t)}removeElement(e){let t=this.dom.element(e);if(!t)return!1;var s=this.dom.getSaveableParent(t);if(s==t){e=this.dom.attr(s,"exTag");if("div.part"==e||"div.zone"==e){var n=this.dom.children(t);for(let e=0;e<n.length;e++)this.removeElement(n[e])}window.ud.viewEvent("delete",t)}else-1<t.id.indexOf("Zone")?window.ud.viewEvent("delete",t):(t.remove(),window.ud.viewEvent("change",s));this.editElement&&this.clearClasses(this.editElement,"editing,edcontainer,edinside")}focus(e){this.dom.cursor.HTMLelement=this.dom.element(e),this.dom.cursor.HTMLoffset=0,this.dom.cursor.textElement=this.dom.cursor.HTMLelement.firstChild,this.dom.cursor.textOffset=0,this.dom.cursor.set();e=this.dom.cursor.HTMLelement.offsetTop;this.container.parentNode.scrollTop=200<e?e-200:0}edit(t=""){let e=!1;t=t||this.dom.cursor.fetch().HTMLelement;let s=this.dom.element(t);if(!s||s==this.editElement)return e;let n=!0;this.dom.attr(s,"editable")||(n=!1),n&&s&&s.nodeType==Node.ELEMENT_NODE&&-1==s.className.indexOf("Noedit")&&""==this.dom.parentAttr(s,"onclick")&&"a"!=this.dom.parentAttr(s,"tagName")&&(this.editElement&&this.clearClasses(this.editElement,"editing,edcontainer,edinside"),this.editElement=null,this.menuManager.hide());if(e=e||this.dispatchEvent({event:"focus",type:"focus"},s),this.requires2stageEditing(s),n&&!e&&"off"!=this.dom.extraAttr(s,"ude_menu")){t=this.dom.getSaveableParent(s);let e=this.dom.getEditableParent(s);this.toggleClass(t,"editing"),this.clearClasses(t,"edcontainer"),this.clearClasses(s,"edinside"),"span"!=this.dom.attr(e,"exTagType")||e.classList.contains("caption")||(this.toggleClass(t,"edcontainer"),this.toggleClass(s,"edinside")),this.editElement=t,this.menuManager.display(this.dom.getEditableParent(s))}return e}setChanged(e,t=!1){let s=this.dom.element(e);if(void 0===s&&(this.dom.cursor.fetch(),s=this.dom.cursor.HTMLelement),!s)return null;this.dispatchChangeEvent(s),this.calc.checkDependencies(s),API.checkPagination(s);let n=this.dom.getSaveableParent(s);if(!n||!t&&"off"==this.dom.parentAttr(s,"ude_autosave").toLowerCase())return null;if(n.classList.remove("initialcontent"),""==this.dom.keepPermanentClasses(n.className,!0)&&n.classList.add("neutral"),n.classList.remove("modified"),"__NONE__"==this.dom.attr(n,"ud_oid"))return null;var i=this.dom.getParentWithAttribute("ude_bind",s),e=this.dom.element(this.dom.attr(i,"ude_bind")),t=this.dom.attr(n,"ud_type");let o=!0;return e&&t&&(o=this.dispatchEvent({event:"save",target:e},i)),o?this.dataSource.viewEvent("change",n):null}dispatchEditEvent(s,n){n=this.dom.element(n);let i="string"==typeof s?this.dom.udjson.parse(s):s,o=!1;if(n&&i){void 0!==i.type&&void 0===i.event&&(i.event=i.type);s=this.dom.getSaveableParent(n);let e=this.dom.attr(s,"exTag");this.dom.udjson.value(UD_exTagAndClassInfo[e],"useTextEditor")&&(e="div.linetext");let t=this.modules[e];t&&t.instance&&(o=t.instance.inputEvent(i,n)),o=o||this.editEventDefault(i,n)}return o}dispatchEvent(n,i){if(i){void 0!==n.type&&void 0===n.event&&(n.event=n.type);let e=!1;var o=this.dom.getSaveableParent(i);let t=this.dom.attr(o,"exTag");(this.dom.udjson.value(UD_exTagAndClassInfo[t],"useTextEditor")||"linetext"==this.dom.parentAttr(i,"ud_type"))&&(t="div.linetext");let s=this.modules[t];return s&&s.instance&&(e=s.instance.inputEvent(n,i)),e=e||this.editEventDefault(n,i),e}}dispatchChangeEvent(t){var s=this.dom.getParentWithAttribute("ude_bind",t),n=this.dom.getSaveableParent(t);if(n){var i=this.dom.getParentAttribute("","ud_type",n),o={source:t,container:s,target:n,event:"change"};if(n&&i)switch(i){case"table":this.tableEd.inputEvent(o,t);break;case"list":let e=this.modules["div.list"].instance;e&&e.inputEvent(o,t);break;case"graphic":this.draw.inputEvent(o,t);break;case"linetext":case"server":case"css":case"js":case"apiCalls":case"json":this.textEd.inputEvent(o,s);break;case"html":case"chart":this.dispatchEvent({event:o,target:n},t);break;case"image":this.dispatchEvent(o,n)}}}insertTextAtCursor(e,t){let s=this.dom.cursor.textElement;var n=this.dom.cursor.textOffset;let i=s.textContent;var o=this.dom.attr(s.parentNode,"ude_place"),a=this.dom.cursor;i==o?(s.textContent=e,this.dom.cursor.setAt(s,1e4)):(this.cursor.selectionInNode&&(i=i.substring(0,a.textOffset)+i.substring(a.focusOffset)),s.textContent=i.substring(0,n)+e+i.substring(n,i.length),this.dom.cursor.setAt(this.dom.cursor.HTMLelement,n+e.length)),"off"==this.dom.getParentAttribute("","ude_autosave",this.dom.cursor.HTMLelement)?debug({level:3},"Auto update disabled in insertTextAtCursor on "+this.dom.cursor.HTMLelement.id):this.setChanged(this.dom.cursor.HTMLelement)}replaceTextAtCursor(e,t){var s=this.dom.cursor.HTMLelement;this.dom.cursor.textElement.textContent=e,"off"==this.dom.getParentAttribute("","ude_autosave",s)?debug({level:3},"Auto update disabled in insertTextAtCursor on "+s.id):this.setChanged(s)}insertHTMLatCursor(e,t){let s=this.dom.cursor.HTMLelement;var n=this.dom.cursor.HTMLoffset;let i=s.innerHTML;var o=this.dom.attr(s,"ude_place");i==o?(s.innerHTML=e,this.dom.cursor.setAt(s,9e3)):(o=s.innerHTML.length,s.innerHTML=i.substring(0,n)+e+i.substring(n,i.length),this.dom.cursor.setAt(s,n+s.innerHTML.length-o)),"off"==this.dom.getParentAttribute("","ude_autosave",s)?debug({level:3},"Auto update disabled in insertTextAtCursor on "+this.dom.cursor.HTMLelement.id):this.setChanged(s)}requires2stageEditing(s){if(this.editingElement&&this.editingElement!=s&&this.leave2stageEditing(!0),this.editingElement&&(this.editingElement==s||this.editingElement==s.parentNode))return!0;var t=s.childNodes;let n=!1;for(let e=0;e<t.length;e++)if(3==t[e].nodeType){n=!0;break}var i=this.forceStagedEditing;if(i|=API.testEditorAttr(s,"ude_stage"),i|=""!=this.dom.attr(s,"ude_formula"),(i|=""!=this.dom.attr(s,"_onclick")||""!=this.dom.attr(s,"ude_onclick"))&&this.dom.isEditable(s)){this.editingElement=s,this.editRestoreHTML=s.innerHTML,this.editRestoreAttr={ude_onclick:"",ude_formula:""};let e=this.dom.attr(s,"ud_type"),t=this.dom.attr(s,"ude_formula");this.dom.attr(s,"exTagType");if(e||t||(i=s.parentNode,"span"!=this.dom.attr(s,"exTagType")&&(this.dom.attr(i,"ud_type")||this.dom.attr(i,"ude_formula"))&&(s=i,e=this.dom.attr(s,"ud_type"),t=this.dom.attr(s,"ude_formula"),this.editingElement=s,this.editRestoreHTML=s.innerHTML,this.editRestoreAttr={})),s.classList.add("stageediting"),"button"==e){var o="";o+="DO|"+this.dom.attr(s,"_onclick")+"|"+s.innerHTML,o+='|<a href="javascript:" onclick="'+this.dom.attr(s,"_onclick")+'">test</a>',s.innerHTML=o,this.editRestoreAttr={ude_onclick:this.dom.attr("_onclick"),ude_formula:this.dom.attr("ude_formula")}}else if("link"==e){o=this.dom.element("a",s);let e="";o&&(e=this.dom.attr(o,"href"));let t=this.dom.attr(s,"ude_formula");t=t||"linkTag( '"+e+"','','"+s.textContent+"');",s.innerHTML="="+t,e&&(s.innerHTML+=' | <a href="javascript:" onclick="window.open(\''+e+"');\">test</a>")}else"field"==e&&"edit3"==!this.mode&&1==this.calc.countTermsInFormula(this.dom.attr(s,"ude_formula"))?n||"img"==s.childNodes[0].tagName.toLowerCase()&&(s.style.border="2px solid green",n=document.createTextNode("select in clipboard"),n=s.appendChild(n),this.dom.cursor.HTMLelement=s,this.dom.cursor.textElement=n,this.dom.cursor.textOffset=0,this.dom.cursor.set()):("field"==e&&"edit3"==this.mode||this.dom.attr(s,"ude_formula"))&&(n||(this.dom.emptyElement(s),n=document.createTextNode(""),n=s.appendChild(n)),s.textContent="="+this.dom.attr(s,"ude_formula"));return!0}return!1}is2stageEditing(e){return this.editingElement==e}leave2stageEditing(n=!0){if(!this.editingElement)return!1;let i=this.editingElement;this.editingElement=null,i.classList.remove("stageediting");let o=i.textContent;if(!n||(a=this.dom.attr(i,"ude_check"))&&!this.calc.checkValue(a,o)&&(n=!1),n){let t=!0;window.rollbacker&&window.rollbacker.inputEvent({event:"change",content:this.editRestoreHTML},i);var a=this.dom.attr(i,"ud_type");let s=this.dom.attr(i,"ude_formula");if("="==o.charAt(0))o=o.substr(1).split("|"),this.dom.attr(i,"ude_formula",o[0]),i.textContent=this.dummy,this.dom.attr(i,"_onclick","__CLEAR__"),this.calc.updateElement(i),this.dom.attr(i,"ud_follow",this.dom.children(i)?"off":"__CLEAR__");else if("field"==a&&1==this.calc.countTermsInFormula(s)){let e=s;s.indexOf("(")&&(e=e.substring(e.indexOf("(")+1,e.length-1).trim()),e=e.split(".");n=this.dom.element(e[0]);2==i.childNodes.length&&"img"==i.childNodes[0].tagName.toLowerCase()&&(o=this.dom.attr(i.childNodes[0],"src"),i.style.border="none");a={event:"setValue",key:[e[1],e[2]],value:o};this.dispatchEvent(a,n),this.calc.updateElement(i),"off"==this.dom.attr(i,"ude_menu")&&(t=!1)}else if("DO|"==o.substr(0,3)){o=o.substr(3).split("|");let e=stripScriptsAndStyles(o[0]);API.translateTerm(o[1],!1);"="==e.charAt(0)?(e=e.substring(1),this.dom.attr(i,"onclick_formula",e),i.setAttribute("_onclick",this.calc.exec(e,i))):i.setAttribute("_onclick",e),this.dom.attr(i,"ude_formula","__CLEAR__"),i.textContent=o[1],this.dom.clearAttr(i,"ude_formula"),this.calc.updateElement(i)}else{this.dom.attr(i,"ude_formula","__CLEAR__"),this.dom.attr(i,"ud_follow","__CLEAR__"),this.dom.attr(i,"_onclick","__CLEAR__");let e=this.dom.attr(i,"ude_validate");e&&(e=e.replace(/this/g,i.innerHTML),this.calc.eval(e,i)||(t=!1,i.innerHTML=this.editRestoreHTML))}let e=this.dom.attr(i,"ude_onvalid");t&&e&&(l=this.dom.getSaveableParent(i),e=i.id?e.replace(/{id}/g,i.id):e.replace(/{id}/g,l.id),e=e.replace(/{name}/g,this.dom.attr(l,"name")),doOnupdate(e)),!t||i.innerHTML==this.editRestoreHTML&&this.dom.attr(i,"_onclick")==this.editRestoreAttr.ude_onclick&&this.dom.attr(i,"ude_formula")==this.editRestoreAttr.ude_formula||this.setChanged(i)}else if(i.innerHTML=this.editRestoreHTML,!this.floaterActionPending){"span.field"==this.dom.attr(i,"exTag")&&(i.style.border="none");var l=this.dom.getSaveableParent(i);this.clearClasses(l,"edcontainer"),this.clearClasses(i,"edinside"),this.dom.cursor.setAt(l);let e=this.dom.attr(i,"ude_oninvalid");e&&i.id&&doOnupdate(e.replace(/{id}/g,i.id))}return this.editingElement=null,this.editRestoreHTML="",this.editRestoreAttr={},(this.isMobile||this.forceStagedEditing)&&(document.activeElement.blur(),this.menuManager&&this.menuManager.hide()),!0}formInputChange(e,t=null){let s=e.parentNode;if(t&&t.keyCode<20)if("Enter"==t.code)s.submit();else if("Backspace"!=t.code&&"Delete"!=t.code)return;debug({level:1},"formInputChange used",e),50<this.ticks&&e.classList.contains("initialField")?(e.value="",e.classList.remove("initialField"),e.classList.add("editField")):""==e.value&&(e.classList.remove("editField"),e.classList.add("initialField"))}inlineCommandManager(e){return this.commandMode?"Escape"==e||"Enter"==e?(this.commandMode=!1,!(this.command="")):(this.command+=e,!0):this.lastChar==this.enterCommand.charAt(0)&&e==this.enterCommand.charAt(1)?(console.log("Command mode"),this.commandMode=!0,!(this.command="")):(e==this.enterCommand.charAt(0)&&(this.lastChar=e),!1)}followScroll(e){if(e){e=this.dom.element(e);if(e){this.emulateMobile=!0,this.elementToScroll=e;let t=this;this.dom.topElement.addEventListener("mousemove",function(e){t.pointEvent(e)}),this.dom.cursor.HTMLelement=e.childNodes[0]}}else{this.emulateMobile=!1,this.elementToScroll=null,this.lastClickPosition={x:-1,y:-1};let t=this;this.dom.topElement.removeEventListener("mousemove",function(e){t.pointEvent(e)})}}arrowNavigate(e){switch(e){case 2:this.dom.moveCursor(1,null,"line");break;case 3:this.dom.moveCursor(-1);break;case 4:this.dom.moveCursor(1)}}click(e){}getEditType(e){e=this.dom.getEditableParent(e);let t=this.dom.attr(e,"ud_type").toLowerCase();-1<["editzone","viewzone"].indexOf(t)&&(t=this.dom.attr(e,"ud_subtype"));let s="html";return-1<["text","linetext","css","js","json","htmltext","html","chart"].indexOf(t)&&(s="text"),s}clearPlaceholder(e){let t=API.dom.element(e);e=API.getEditorAttr(t,"ude_place");(e||"..."!=t.textContent)&&t.textContent!=e||(t.textContent=""),t.classList.remove("placeHolding")}setPlaceholder(e){let t=API.dom.element(e);e=API.getEditorAttr(t,"ude_place");e&&""==t.textContent&&(t.textContent=e),t.classList.add("placeHolding")}hasDefaultContent(e){e=this.dom.element(e),this.dom.getSaveableParent(e);let t=this.dom.udjson.value(UD_defaultContentByExTag,this.dom.attr(e,"exTag"));return t=t||"...",API.getEditorAttr(e,"ude_place")==e.innerHTML||t&&e.innerHTML==t}}if("object"==typeof process){testThis=!1;const udecalc=require("./udecalc.js"),UDEcalc=udecalc.UDEcalc;if(window.UDEcalc=udecalc.UDEcalc,module.exports={UDE:UDE,CALC:window.UDEcalc},window.UDE=UDE,void 0===global.JSDOM&&"undefined"==typeof window){var envMod=require("../tests/testenv.js");envMod.load();const udedraw=require("../modules/editors/udedraw.js"),UDEdraw=udedraw.UDEdraw;window.UDEdraw=udedraw.UDEdraw,console.log("Syntax OK"),console.log("Start of UDE test program"),debug({level:2},"abd"),console.log("Creating ude");var myude=new UDE(document.getElementById("document"),null,0);console.log("Test completed")}}function doOnload(onload){if(onload&&"string"==typeof onload){let r="";try{r=eval(onload)}catch(error){console.error(error,onload)}return r}}function doOnupdate(onupdate){if(onupdate&&"string"==typeof onupdate)return eval(onupdate)}function doOnsave(onsave){if(onsave&&"string"==typeof onsave)return eval(onsave)}function convertToObject(attrFriendlyStr){return attrFriendlyStr?eval("("+attrFriendlyStr+")"):{dummy:"dummy"}}function doControl(test,args){if(test&&"string"==typeof test)return eval(test)}function Confirm(e){confirm(e)}function APIreturnType(fctName){if(fctName&&"string"==typeof fctName)return typeof eval("API."+fctName+"();")}function stripScripts(e,t=null){let s=0,n=5,i=!1;for(;-1<(s=e.indexOf("<script",s))&&n--;){var o=e.indexOf("<\/script>");e=o?e.substr(0,s)+e.substr(o+9):e.substr(0,s),i=!0}return n?(i&&t&&(t.innerHTML=e),e):(alert("<script> sequenciencies not allowed here. Please remove for element to be saved."),!1)}function stripStyles(e,t=null){let s=0,n=5,i=!1;for(;-1<(s=e.indexOf("<style",s))&&n--;){var o=e.indexOf("</style>");e=o?e.substr(0,s)+e.substr(o+9):e.substr(0,s),i=!0}return n?(i&&t&&(t.innerHTML=e),e):(alert("<style> sequenciencies not allowed here. Please remove for element to be saved."),!1)}function stripScriptsAndStyles(e,t=null){return stripStyles(stripScripts(e,t),t)}function htmlEntities(e,t=!1){return t?String(e).replace(/&quote/g,'"').replace(/&gt;/g,">;").replace(/&lt;/g,"<").replace(/&amp;/g,"&"):String(e).replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;")}function htmlEntities2(e,t=null){var s=String(e).replace(/<script/g,"&lt;script").replace(/<style/g,"&lt;style");return s!=String(e)&&t&&(t.innerHTML=s),s}function L_new(t,e){let s=arguments;if(s.shift(),s.shift(),"object"!=typeof process)return new t(s);{let e=window[t];return new e(s)}}function dumpElement(e,t=""){if(e)if("undefined"==typeof process)console.log(e);else{console.log(t,e,e.id,e.getAttribute("name"),e.className,e.getAttribute("ud_type"));var s=e.childNodes;for(let e=0;e<s.length;e++){var n=s[e];1==n.nodeType?dumpElement(n,t+"   "):3==n.nodeType&&console.log(t+"    Text node: "+n.textContent)}}else console.log("null")}function testResult(e,t,s=""){ok=t?"OK":"KO "+s,console.log("Test "+e+" : "+ok)}function stringifyHelper(e,t){return"object"==typeof t&&window.DEBUG_stringifyCount--<=0?"object":"array"==typeof t?"array":t}function debug(){var a=arguments[0];if(!("object"==typeof a&&"level"in a))return 5<=DEBUG_level?"__CHECKSUM__"==a?DEBUG_checksum:"__COVERAGE__"==a?COVERAGE:"Level, arg "+window.DEBUG_level+a:void 0;if(a.level>window.DEBUG_level)return"return"in a?arguments[0].return:"returnValue"in a?a.returnValue:void 0;if(0 in a,1<arguments.length){let t=[];-1==window.DEBUG_time&&(window.DEBUG_time=Date.now()%1e7);for(let e=1;e<arguments.length;e++)t.push(arguments[e]);let i="",o=Error();if(void 0!==o.stack){let e=o.stack.split("\n");-1==e[0].indexOf(":")&&e.shift(),-1==e[0].indexOf(":")&&e.shift(),-1<e[0].indexOf("debug.js")&&e.shift();let s=e[1];var l=s.indexOf("("),r=s.indexOf(")");if(0<l&&0<r&&(s=s.substring(l+1,r)),s=s.split(":"),s.length<2)return;let n=s[1];l=s[2];-1<n.indexOf("_")&&(n=n.substr(n.indexOf("_")+1));r=n.split("\\");if(n=r[r.length-1],"coverage"in a){void 0===COVERAGE[n]&&(COVERAGE[n]={});let e=a.coverage,t=0;"coverageDetail"in a?e+="/"+a.coverageDetail:(e+="/global",t=3),void 0===COVERAGE[n][e]?COVERAGE[n][e]=parseInt(s[2]):"number"==typeof COVERAGE[n][e]&&(COVERAGE[n][e]=""+(parseInt(s[2])-COVERAGE[n][e]+t))}if(1<arguments.length){if(TEST_ENVIRONMENT)i=n+" line "+l;else{let e="0000000"+(Date.now()%1e7-window.DEBUG_time),t="0000000";void 0!==window.performance.memory&&(t="0000000"+window.performance.memory.totalJSHeapSize),i=e.substring(e.length-7)+" "+t.substring(t.length-7)+" "+n+" line "+s[2]}for(var d=0;d<t.length;d++)window.DEBUG_stringifyCount=2,i+=" "+JSON.stringify(t[d],stringifyHelper);a.error?TEST_ENVIRONMENT?console.log("ALERT "+a.error,i,t):console.error(i,a.error,t):TEST_ENVIRONMENT&&!TEST_verbose||console.log(i,t),DEBUG_checksum+=crc32_compute_string(DEBUG_poly,i)}}else console.log(t)}return"return"in a?a.return:"returnValue"in a?a.returnValue:void 0}function debug_callerFct(){let s=Error(),n="Error stack unavailable";if(void 0!==s.stack){let e=s.stack.split("\n");-1==e[0].indexOf(":")&&e.shift(),-1==e[0].indexOf(":")&&e.shift();let t=e[2];var i=t.indexOf("("),o=t.indexOf(")");if(0<i&&0<o&&(t=t.substring(i+1,o)),t=t.split(":"),t.length<2)return;n=t[1],-1<n.indexOf("_")&&(n=n.substr(n.indexOf("_")+1));o=n.split("/");n=o[o.length-1],n+=" line"+t[2],n+=" "+e[3]}return n}function crc32_generate(e){for(var t,s,n=new Array,i=0;i<256;i++){for(s=i,t=8;0<t;t--)1==(1&s)?s=s>>>1^e:s>>>=1;n[i]=s}return n}function crc32_initial(){return 4294967295}function crc32_add_byte(e,t,s){return t=t>>>8^e[s^255&t]}function crc32_final(e){return e=(e=~e)<0?4294967295+e+1:e}function crc32_compute_string(e,t){var s=crc32_generate(e),n=0,n=crc32_initial();for(let e=0;e<t.length;e++)n=crc32_add_byte(s,n,t.charCodeAt(e));return n=crc32_final(n)}function crc32_compute_buffer(e,t){var s=new DataView(t),n=crc32_generate(e),i=0,i=crc32_initial();for(let e=0;e<s.byteLength;e++)i=crc32_add_byte(n,i,s.getUint8(e));return i=crc32_final(i)}function crc32_reverse(t){var s=0;for(let e=0;e<32;e++)s<<=1,s|=t>>>e&1;return s}DEBUG_alwaysNull={level:2,returnValue:null},DEBUG_alwaysFalse={level:2,returnValue:!1},void 0===DEBUG_level&&(DEBUG_level=5),DEBUG_time=-1,DEBUG_stringifyCount=1,DEBUG_checksum=0,DEBUG_poly=202020192018,TEST_ENVIRONMENT=!1,TEST_verbose=!1,COVERAGE={},"object"==typeof process&&(TEST_ENVIRONMENT=!0),"object"==typeof process&&(displaylib=require("../debug/display_lib.js"),module.exports={debug:debug,L_new:L_new,dumpElement:dumpElement,testResult:testResult,debug_callerFct:debug_callerFct,DEBUG_checksum:DEBUG_checksum,RegisterBlock:displaylib.RegisterBlock,ShowBlock:displaylib.ShowBlock,Zone:displaylib.Zone,doOnload:doOnload,doOnupdate:doOnupdate,doOnsave:doOnsave,doControl:doControl,APIreturnType:APIreturnType,convertToObject:convertToObject,htmlEntities:htmlEntities,htmlEntities2:htmlEntities2,stripScripts:stripScripts,stripStyles:stripStyles,stripScriptsAndStyles:stripScriptsAndStyles},void 0===global.JSDOM&&"undefined"==typeof window&&"undefined"==typeof ModuleUnderTest&&(ModuleUnderTest="debug.js",console.log("Syntax : OK"),console.log("Start of debug.js test program"),console.log("Setting up browser (client) test environment"),envMod=require("../tests/testenv.js"),envMod.load(),TEST_verbose=!0,debug({level:2,error:"DEPRECATED"},"Value1","Value2"),console.log("Test completed: OK")));var DOM_lastAccessedValues=[];function JSONvalue(e,t){return window.udjson.value(e,t)}function JSONparse(e){return window.udjson.parse(e)}class DOM{maxElementDepth=30;DOM_properties={};parent=null;cursor;udjson=null;domvalue=null;topElement=null;lastAccessedElement=null;autoHome=null;autoIndex1=-1;autoIndex2=-1;headerRowCache={};transformScale=1;classMap={};editClasses=["editing","edcontainer","edinside","menu-on","hidden"];dummyText="...";nodejs=!1;constructor(e,t){this.topElement=e,this.parent=t,this.cursor=new DOM_cursor(this.topElement,this),this.udjson=new UDJSON(this),window.udjson=this.udjson,this.domvalue=new DOMvalue(this),"object"==typeof process&&(this.nodejs=!0)}JSONget(e){return this.udjson.getElement(e)}JSONput(e,t="",s="",n=""){return this.udjson.putElement(e,t,s,n)}value(e,t=null,s=null){return this.domvalue.value(e,t,s)}appAttribute(e,t,s=null){this.attr(e,t,s)}setAttr(e,t,s,n=!0){n?this.attr(t,s)&&(e[s]=this.attr(t,s)):void 0!==e[s]&&this.attr(t,s,e[s])}attr(e,t,n=null){debug({level:5,coverage:"attr"});let i=this.element(e);if(!i||void 0===i.getAttribute)return"";var s;if(null!=n)return-1<UD_appAttributes.indexOf(t)?((e=0==t.indexOf("data-")?t:"data-"+t.replace(/_/g,"-"))!=t&&void 0!==i.getAttribute(t)&&i.removeAttribute(t),"__CLEAR__"==n?void 0!==i.getAttribute(e)&&i.removeAttribute(e):i.setAttribute(e,n)):(-1==UD_domAttributes.indexOf(t)&&(o=debug_callerFct(),console.error("Writing unknown attribute:"+t,o)),"boolean"==typeof n&&n?i.setAttribute(t,""):"class"==t?i.className=n:"__CLEAR__"==n?i.removeAttribute(t):i.setAttribute(t,n)),n;if(-1<UD_styleAttributes.indexOf(t)||0==t.indexOf(UD_useComputedPrefix)){t=t.replace(UD_useComputedPrefix,"");var o=i.currentStyle||window.getComputedStyle(i);(n=void 0!==o[t]?o[t]:n)&&-1<n.indexOf("px")&&(n=parseFloat(n.replace("px","")))}else if("textContent of siblings"==t){var a=i.parentNode.childNodes;n="";var l=API.getParameter("dummyText");for(let t=0;t<a.length;t++){let e=a[t];var r=e.textContent;1!=e.nodeType||e.classList.contains("rowNo")||"false"==e.getAttribute("contenteditable")||r==l||r==this.attr(e,"ude_place")||(n+=r)}}else if("editable"==t){n=!0,"div.page"==this.attr(i,"exTag")&&(n=!1);let s=i,e=10;for(;n&&s&&"document"!=s.id&&--e;){if("true"==this.attr(s,"contenteditable"))return n;let e=this.attr(s,"ude_edit").toLowerCase();e||(e=this.attr(s,"ude_mode").toLowerCase(),"none"==this.attr(s,"ude_input")&&(e="display"),e=!e||-1<e.indexOf("edit")?"on":"off");let t=this.element("UD_mode");if(t=t&&t.textContent,-1==["div.page"].indexOf(this.attr(s,"exTag"))&&("false"==this.attr(s,"contenteditable")||this.attr(s,"ude_noedit")||s.classList.contains("noedit")||"INPUT"==s.tagName||"edit3"!=t&&e&&0==e.indexOf("off")||!e&&t&&"model"==t)){n=!1;break}s=s.parentNode}"document"!=i.id&&"div.page"!=this.attr(i,"exTag")||(n=!1)}else"exTag"==t||"exTagType"==t?"div"==(n=i.tagName.toLowerCase())||"span"==n?((s=this.attr(i,"ud_type"))&&(n+="."+s),s=this.attr(i,"ud_subtype"),"exTagType"==t&&s&&(n+="."+s)):"p"==n&&i.classList.contains("undefined")&&(n="p.undefined"):-1<UD_domAttributes.indexOf(t)?n=(n=i.getAttribute(t))||"":(s=0==t.indexOf("data-")?t:"data-"+t.replace(/_/g,"-"),(n=!(n=!(n=(n=i.getAttribute(s))||i.getAttribute(t))&&void 0!==i[t]?i[t]:n)||void 0===n?"":n)&&-1<UD_lowerCaseAttr.indexOf(t)&&(n=n.toLowerCase()),-1==UD_appAttributes.indexOf(t)&&-1==UD_domAttributes.indexOf(t)&&(s=debug_callerFct(),console.error("Reading unknown attribute:"+t,s)));return debug({level:5,coverage:"attr"}),n}isEditable(e,t=!1){var s=this.attr(e,"exTag"),n=$$$.testEditorAttr(e,"ude_edit");n|=$$$.testEditorAttr(e,"ude_stage");var i=!e;return i|="div.page"==s,i|=!(n|="input"==s),!(i|=t&&"link"!=this.attr(e.parentNode,"ud_type"))}clearAttr(e,t){this.attr(e,t,"__CLEAR__")}extraAttr(e,t){let s="";var n=this.parentAttr(e,"ud_extra"),e=this.element("UD_mode").textContent;return n&&"edit2"==e&&(n=this.udjson.parse(n))&&n[t]&&(s=n[t]),s}parentAttr(e,t){let s=10,n="",i=this.element(e),o="";for(;i&&!(n=this.attr(i,t))&&!(o=this.attr(i,"ude_bind"))&&--s&&i!=this.topElement;)i=i.parentNode;return o?this.parentAttr(this.element(o),t):n}textContent(t){let n="";if(!t)return n;("string"==typeof t||"object"==typeof t&&void 0!==t.tagName)&&(t=[t]);for(let e=0;e<t.length;e++){var i=this.element(t[e]);if(i&&i.nodeType==Node.ELEMENT_NODE){var s=this.attr(i,"exTag");if(-1<["div.linetext","div.server","div.css","div.js","div.json","div.html"].indexOf(s))switch(this.attr(i,"ud_mime")){case"text/json":var o=JSONparse(i.textContent);if(!o)continue;n+=this.udjson.text(o,"data/value");break;case"text/text":default:let e=this.element("div.textObject",i);if(!e)continue;let t=e.textContent.split("\n"),s=t.shift();-1==["linetext","css","js","json","html"].indexOf(s.toLowerCase())&&(n+=firstline+"\n"),n+=t.join("\n")}else n+=i.textContent}}return n}isDOM(e){return e&&void 0!==e.tagName}element(s,e=null){if(!s)return null;let n=null,t=null;if("object"==typeof s){if(void 0!==s.tagName)return s;var i=s;e="string"==typeof i.parent?i.parent:this.element(JSON.stringify(i.parent)),s="tbody"==i.tag||"thead"==i.tag?i.tag:i.tag+":nth-child("+i.child+")"}if("{"==s[0]){i=this.udjson.parse(s);if(!i)return null;e="string"==typeof i.parent?i.parent:this.element(JSON.stringify(i.parent)),s="tbody"==i.tag||"thead"==i.tag?i.tag:i.tag+":nth-child("+i.child+")"}if(e&&(t=this.element(e),t||(a=document.getElementsByName(e)).length&&(t=a[0]),t=t||this.element("document")),t)if(this.nodejs){if(t.id&&(n=document.querySelector("#"+t.id+" "+s),!n&&-1<" table ul ".indexOf(s))){console.log("parse children for query");var o=t.childNodes;for(let t=0;t<o.length;t++){let e=o[t];if(e.nodeType==Node.ELEMENT_NODE&&e.tagName.toLowerCase()==s){n=e;break}}}}else n=t.querySelector(s);else{var a=s.replace(/ /g,"_");n=document.getElementById(a)}return n}elements(e,t,s="",n=""){let i=this.element(t);if(!i)return[];let o=null;o=this.nodejs?i.id?document.querySelectorAll("#"+i.id+" "+e):[]:i.querySelectorAll(e);let a=[];for(let e=0;e<o.length;e++){var l,r=o[e];r.nodeType==Node.ELEMENT_NODE&&(s||n?(l=this.getSaveableParent(r))&&(l=l.id,(!s||s<l)&&(!n||l<n)&&a.push(r)):a.push(r))}return a}elementByName(e,t=""){var s=this.element("document");if(!s)return console.log("FATAL ERROR No document element",document.body.innerHTML),null;s=this.elements(t+"[name='"+e+"']",s);return s&&0!=s.length?1<s.length?debug({level:3,return:null},"DOM.elementByName name not unique",e):s[0]:debug({level:3,return:null},"DOM.elementByName name not found",e)}unpagedChildElements(e){e=this.element(e);if(!e)return[];let t=[];var s=e.childNodes;if(!s)return t;for(var n=0;n<s.length;n++){var i=s[n];1==i.nodeType&&(void 0!==i.classList&&i.classList.contains("page")?t=t.concat(this.children(i)):t.push(i))}return t}children(e){return this.unpagedChildElements(e)}childElements(e){e=this.element(e);if(!e)return null;let t=[];var s=e.childNodes;if(!s)return t;for(var n=0;n<s.length;n++){var i=s[n];1==i.nodeType&&t.push(i)}return t}childNodes(e){e=this.element(e);if(!e)return null;let t=[];var s=e.childNodes;if(!s)return t;for(var n=0;n<s.length;n++){var i=s[n];t.push(i)}return t}pages(e="document"){let t=this.element(e);if(t=t||this.element('[name="'+e+'"]',this.element("document")),!t)return null;let s=[];var n=t.childNodes;if(!n)return s;for(var i=0;i<n.length;i++){var o=n[i];1==o.nodeType&&void 0!==o.classList&&o.classList.contains("page")&&s.push(o)}return s}views(){return this.childElements("document")}siblings(e){e=this.element(e).parentNode;return e.classList.contains("page")?this.children(e.parentNode):this.children(e)}emptyElement(e){let t=this.element(e);return t?(t.innerHTML="",t):null}childrenAsJSON(e,t=0){debug({level:2},"childrenAsJSON OLD called");var s=e.childNodes;let n=[];for(let e=0;e<s.length;e++){let t=s[e];if(t.nodeType==Node.TEXT_NODE)n.push({value:t.textContent});else if(t.nodeType==Node.ELEMENT_NODE)if("br"==t.tagName.toLowerCase())n.push({value:""});else{let e={value:t.textContent,tag:t.tagName.toLowerCase()};t.className&&(e.class=t.className);var i=this.attr(t,"ude_formula");i&&(e.formula=i),n.push(e)}}return n}childrenOfClass(e,s){e=this.element(e);if(!this.nodejs)return this.elements("."+s,e);var n=this.childElements(e);let i=[];for(let t=0;t<n.length;t++){let e=n[t];1==e.nodeType&&e.classList.contains(s)&&i.push(e)}return i}hasClass(e,t){return this.dom.element(e).classList.contains(t)}getSaveableParent(e,t=!0){var s=this.element(e);let n=this.maxElementDepth,i=s;for(;i&&void 0!==i.tagName&&!this.attr(i,"ud_oid")&&(!i.id||0!=i.id.indexOf("__TMP"))&&n--&&(!t||!this.attr(i,"ude_bind"));)i=i.parentNode;return i?t&&this.attr(i,"ude_bind")?this.getSaveableParent(this.attr(i,"ude_bind"),!1):this.attr(i,"ud_oid")||i.id&&0==i.id.indexOf("__TMP")?i:"page"==this.attr(i,"ud_type")?debug({level:8,return:null},"getSaveable() found page before saveable",e):debug({level:8,return:null},"can't find saveable",e):debug({level:8,return:null},"can't find saveable",e)}getEditableParent(e,t=0){var s=this.element(e);if(!s)return null;var n=this.getSaveableParent(s),e=this.attr(n,"exTag");if(!this.udjson.valueByPath(UD_exTagAndClassInfo,e+"/editableInside"))return n;let i=s;var o=this.attr(i,"exTag");let a=this.udjson.valueByPath(UD_exTagAndClassInfo,o+"/editable"),l=this.maxElementDepth;for(;!a&&i!=n&&l--;)i=i.parentNode,o=this.attr(i,"exTag"),a=this.udjson.valueByPath(UD_exTagAndClassInfo,o+"/editable"),i.classList.contains("editzone")&&(a=!1);return i}getDisplayableParent(e){e=this.element(e);let t=5,s=e,n=!0;for(;s&&void 0!==s.tagName&&void 0!==UD_exTagAndClassInfo[this.attr(s,"exTag")]&&!(n=UD_exTagAndClassInfo[this.attr(s,"exTag")].displayable)&&t--;)s=s.parentNode;return s&&void 0===UD_exTagAndClassInfo[this.attr(s,"exTag")]&&console.log("BUG udconstants.js",s,this.attr(s,"exTag")),s&&void 0!==s&&void 0!==s.tagName&&void 0!==UD_exTagAndClassInfo[this.attr(s,"exTag")]&&n?s:(console.log("can't find displayable",e),null)}getTypedDivParent(e){return this.getDisplayableParent(e)}getBindedParent(e){var t=this.element(e);let s=10,n=t;for(;n&&void 0!==n&&!this.attr(n,"ud_oid")&&!this.attr(n,"ude_bind")&&s--;)n=n.parentNode;if(!n||!this.attr(n,"ud_oid")&&!this.attr(n,"ude_bind"))return debug({level:8,return:null},"can't find saveable",t);if(this.attr(n,"ude_bind")){e=this.attr(n,"ude_bind"),e="previous"==e?n.previousSibling:"next"==e?n.nextSibling:this.element(e);if(e)return e}return debug({level:5},"No binded parent",t),null}getParentAttribute(e,t,s){if(!e&&s)return this.parentAttr(s,t);e=e.toUpperCase();let n=s,i=this.maxElementDepth;for(;n!=document&&n.tagName!=e&&i--;)n=n.parentNode;return n==document||n.tagName!=e?debug({level:2,return:null},"No parent with tag",e,s):"_element"==t?n:this.parentAttr(n,t)}getParentWithTag(e,t){let s=this.element(e);for(var n=this.maxElementDepth;s&&s!=document&&this.attr(s,"exTag")!=t&&n--;)s=s.parentNode;return s&&s!=document&&this.attr(s,"exTag")==t?s:null}getParentWithAttribute(e,t){for(var s=t,n=this.maxElementDepth;s&&s!=document&&!this.attr(s,e)&&n--;)s=s.parentNode;return s&&s!=document&&this.attr(s,e)?s:null}getView(e){let t=10;let s=this.element(e);for(;s&&"document"!=s.id&&!s.classList.contains("part")&&--t;)s=s.parentNode;return s&&s.classList.contains("part")?s:null}getViewType(e){e=this.getView(e);return e?this.attr(e,"ud_subtype"):""}getViewClass(e){let t=this.getView(e);if(!t)return"";var s=this.attr(t,"ud_subtype");if(""==t.classname)return"";var n=t.className.split(" ");for(let t=0;t<n.length;t++){let e=n[t];if("part"!=e&&"view"!=e&&e!=s&&0!=e.indexOf(UD_layoutPrefix)&&-1==this.editClasses.indexOf(e))return e}return""}hasDefaultContent(e){let t=this.element(e);if(!t)return!1;e=this.attr(t,"exTag");let s=$$$.getTagOrStyleInfo(e,"defaultContent");return s=s||this.udjson.value(UD_defaultContentByExTag,this.attr(t,"exTag")),t.classList.contains("initialcontent")||this.attr(t,"ude_place")==t.innerHTML||s&&t.innerHTML==s||!t.innerHTML}createLookupFromTable(e,t,s){let n={};var i=document.getElementById(e);if(!i)return null;let o=[];for(let e=0;e<i.rows[0].cells.length;e++)o.push(i.rows[0].cells[e].textContent);var a=o.indexOf(t),l=o.indexOf(s),r=i.rows.length;for(let e=1;e<r;e++)"h"==s.substr(0,1)?n[i.rows[e].cells[a].textContent]=i.rows[e].cells[l].innerHTML:n[i.rows[e].cells[a].textContent]=i.rows[e].cells[l].textContent;return n}removeStylesFromHTML(t,e=0){var s=["<body>","</body>","<html>","</html>"];let n=["meta","b","body","html","br"],i="",o=null;if("string"==typeof t){for(let e=0;e<s.length;e++)t=t.replace(s[e],"");t=t.replace(/\n/g,""),o=document.createElement("div"),o.innerHTML=t}else o=t;var a,l=o.childNodes;for(let t=0;t<l.length;t++){let e=l[t];e.nodeType==Node.TEXT_NODE?(a=e.textContent.trim(),i+=a):e.nodeType==Node.ELEMENT_NODE&&("span"==(a=e.tagName.toLowerCase())&&this.attr(e,"style")||-1<n.indexOf(a)?i+=this.removeStylesFromHTML(e):(e.className="",this.attr(e,"style")&&this.attr(e,"style",""),i+=e.outerHTML))}return i}splitTextElement(e,t){return e.splitText(t)}getTextElementAtCursor(){let t=this.cursor.textElement;if(!t){let e=this.cursor.HTMLelement;t=document.createTextNode(""),e.appendChild(t),this.cursor.textElement=t,this.cursor.textOffset=0}return t}insertPreparedElement(e,t=this.cursor.HTMLelement,s=null){if(!t&&!s)return debug({level:2,return:null},"No where to insertElement");s=s||t.parentNode,debug({level:6},"Inserting in DOM",e,t=t&&t.id&&(-1<t.id.indexOf("editZone")||-1<t.id.indexOf("viewZone"))?t.nextSibling:t);var n=null,n=t?s.insertBefore(e,t):s.appendChild(e);return t==this.cursor.HTMLelement&&(this.cursor.HTMLelement=n,this.cursor.HTMLoffset=0,this.cursor.textElement=this.cursor.HTMLelement.childNodes[0],this.cursor.textOffset=0,this.cursor.set()),n}prepareToInsert(t,s,e={}){let n=null;if("object"==typeof s)void 0!==s.parentNode?(n=s.cloneNode(!0),n.classList.remove("rowModel"),n.classList.remove("model")):(n=document.createElement(t),"img"==t&&(n.setAttribute("src",s.src),s.class&&n.setAttribute("className",s.src)));else{if(n=document.createElement(t),!n)return debug({level:2,return:null},"Can't create",t);if(s)n.innerHTML=s;else{let e=this.dummyText;"string"==typeof s&&""!=s&&(e=s),(-1<["p","span","td","li"].indexOf(t)||e!=this.dummyText)&&(t=document.createTextNode(e),n.appendChild(t))}}for(var i in e)"class"==i?n.className=e[i]:this.attr(n,i,e[i]);return n}insertElementAtCursor(e,t,s={},n=!0){if(!this.cursor.HTMLelement)return debug({level:2,return:null},"No cursor to insert at",this.cursor);let i=this.cursor.HTMLelement;n=this.insertElement(e,t,s,i,n);return n&&("br"==e&&Array.from(i.childNodes).indexOf(n)?(e=document.createTextNode(""),n.nextSibling?i.insertBefore(e,n.nextSibling):i.appendChild(e),this.cursor.textElement=e,this.cursor.textOffset=0):(this.cursor.HTMLelement=n,this.cursor.HTMLoffset=0,this.cursor.textElement=null),this.cursor.set()),n}insertElement(e,t,s={},n=null,i=!1,o=0){debug({level:5,coverage:"insertElement"});e=this.prepareToInsert(e,t,s);if(!e)return debug({level:2,return:null},"Can't insert",elementType,t,s);let a=null,l=null;if(!(n=n||this.cursor.HTMLelement))return debug({level:1,return:null},"Don't know where to insert",elementType,t,s);l=n.parentNode,a=n;s=this.attr(e,"exTag");if(i){let e=n.nextSibling;e&&e.nodeType!=Node.ELEMENT_NODE&&(e=null),a=e}s=this.udjson.value(UD_exTagAndClassInfo[s],"insertable");if(("inside"==s&&-1<o||0<o)&&(a=n==this.cursor.HTMLelement?(l=n,this.cursor.textElement&&0<this.cursor.textOffset?this.splitTextElement(this.cursor.textElement,this.cursor.textOffset):this.cursor.textElement&&0==this.cursor.textOfffset?this.cursor.textElement:null):(l=n,null)),!o&&"above"==s){s=n.parentNode;if(!s||s==this.topElement)return debug({level:2,return:null},"Can't find parent",n);a=s.nextSibling,l=s.parentNode}e=this.insertPreparedElement(e,a,l);return debug({level:5,coverage:"insertElement"}),e}remove(e){let t=this.element(e);t&&t.remove()}fillElement(e,t){let s=this.element(e);return s?(s.innerHTML=t,s):debug({level:5,return:null},"fillElement can't find",e)}setStyle(e,t){return debug({level:2},"setStyle OLD called"),value("class",e,this.topElement)}setStyleAttr(e,t,s){var n=document.querySelectorAll("[name='"+e+"']");let i=null;if(1==n.length)i=n[0];else{if(i=document.getElementById(e),!i)return null;i=this.getSaveableParent(i)}return i.style[t]=s,i}styleSelection(e,t,s=""){let n=(e=e||this.cursor.fetch()).textElement,i=e.focusElement;if(!n||!i||n.nodeType!=Node.TEXT_NODE||i.nodeType!=Node.TEXT_NODE)return!1;var o=n.parentNode,a=i.parentNode;if(o.parentNode!=a.parentNode)return!1;let l="";if(n==i){l=n.textContent.substring(e.textOffset,e.focusOffset);i.nextSibling;n.textContent=n.textContent.substring(0,e.textOffset)+i.textContent.substring(e.focusOffset);e=e.textOffset?this.splitTextElement(n,e.textOffset):n,e=this.insertElement("span",l,{class:t,ud_type:t,ude_stage:"on"},e,!1,-1);this.cursor.setAt(e)}else{if(o==a)return!1;{let e=o,t=10;for(;e!=a&&--t;)-1<["span.field","span.input"].indexOf(this.attr(e,"exTag"))?l+=e.outerHTML:l+=e.textContent,e=e.nextSibling();-1<["span.field","span.input"].indexOf(this.attr(e,"exTag"))?l+=e.outerHTML:l+=a.textContent}}let r={class:t};s&&(r.id=s,r.name=s),API.setChanged(this.cursor.HTMLelement)}changeTag(e,t,s=null){let n=this.element(e);if(!n||!n.parentNode)return!1;e=n.getAttribute("id");let i=t.split(".");t.indexOf(".")&&1==i.length&&(i=t.split(".")),s&&1==i.length&&i.push(s);s="";return s+="<"+t,s+=' id="'+e+'"',s+=' ud_oid="'+this.attr(n,"ud_oid")+'"',s+=' ud_dupdated="'+this.attr(n,"ud_dupdated")+'"',s+=' ud_dchanged="'+this.attr(n,"ud_dchanged")+'"',s+=' ud_iheight="'+this.attr(n,"ud_iheight")+'"',s+=' ud_mode="'+this.attr(n,"ud_mode")+'"',1<i.length&&(s+=' ud_type="'+i[1]+'"',s+=' class="'+i[1]+'"',2<i.length&&(s+=' ud_subtype="'+i[2]+'"')),s+=">",n.outerHTML=s+n.innerHTML+"</"+t+">",this.element(e)}removeClassFromChildren(e,t){e=this.element(e);if(!e)return null;let s=e.childNodes;for(let e=0;e<s.length;e++)3!=s[e].nodeType&&(s[e].classList.remove(t),this.removeCSSfromAll(s[e],t));return e}removeCSSfromAll(e,t){debug({level:2},"rmoveCSSfromAll OLD called");for(var s=t.childNodes,n=0;n<s.length;n++)3!=s[n].nodeType&&(s[n].classList.remove(e),this.removeCSSfromAll(e,s[n]))}keepPermanentClasses(e,t=!1){let s=UD_register.UD_wellKnown.UD_editorTemporaryClasses;t&&(s=void 0===API.listTypeAndSubTypeClasses?s.concat(["part","subpart","zone","table","list","graphic","text","zoneToFill","filledZone","page"]):s.concat(API.listTypeAndSubTypeClasses()));let n=" ";-1<e.indexOf(",")&&(n=",");var i=e.split(n);let o=[];for(let t=0;t<i.length;t++){let e=i[t];"_"!=e.charAt(0)&&-1==s.indexOf(e)&&("*"==e.charAt(0)&&(e=e.substr(1)),o.push(e))}return o.length?o.join(n):""}keepPermanentClass(e){let s=UD_register.UD_wellKnown.UD_editorTemporaryClasses;s=s.concat(API.listTypeAndSubTypeClasses());let t=" ";-1<e.indexOf(",")&&(t=",");var n=e.split(t);let i=[];for(let t=0;t<n.length;t++){let e=n[t];"_"!=e.charAt(0)&&-1==s.indexOf(e)&&i.push(e)}return i.length?i[0]:""}keepTemporaryClasses(e){let s=["editing","edcontainer","edinside"],t=" ";-1<e.indexOf(",")&&(t=",");var n=e.split(t);let i=[];for(let t=0;t<n.length;t++){let e=n[t];"_"!=e.charAt(0)&&-1<s.indexOf(e)&&i.push(e)}return i.length?i.join(t):""}getLengthOfText(e){let t=document.createElement("div");return t.textContent=e,debug({level:5,return:t.innerHTML.length,coverage:6,file:"dom.js"},"getLengthOfText()")}increment(e,t,s=1){let n=this.element(e),i=n[t];e=i.substring(-2);i=parseFloat(i.substring(0,-2)),i+=s,n[t]=i+e}getWidthAndHeightOfText(e,t){let s=document.getElementById("textWidthAndHeightCalculator");return s=s||document.createElement("div"),t&&s.classList.add(t),s.style.fontSize=14,s.textContent=e,s.getBoundingClientRect()}isInViewport(e){let t=this.element(e);if(!t)return!1;if(t.nodeType!=Node.ELEMENT_NODE)return!0;e=t.getBoundingClientRect();return 0<e.top&&0<e.left&&e.bottom<=2*(window.innerHeight||document.documentElement.clientHeight)&&e.right<=2*(window.innerWidth||document.documentElement.clientWidth)}isVisible(e,t="div"){if(!this.element("scroll"))return!0;let s=!1;e=this.element(e);let n=e,i=null,o=10,a="";for(;n&&n!=this.topElement.parentNode.parentNode&&"none"!=n.style.display&&!n.classList.contains("hidden")&&(""==n.style.opacity||0!=n.style.opacity)&&o--;){if(t&&n.tagName.toLowerCase()==t&&(i=n),a=this.attr(n,"computed_overflowY"),"scroll"==a||"auto"==a){i=n;break}n=n.parentNode}return n!=this.topElement&&"scroll"!=a&&"auto"!=a||(!i||e.offsetTop>=i.scrollTop&&e.offsetTop<=i.scrollTop+i.offsetHeight+10)&&(s=!0),s}makeVisible(e,t="scroll",s="middle"){let n=this.element(e),i=this.element(t);if(!n||!i)return!1;if("none"==n.style.display||""==n.style.display&&n.classList.contains("hidden"))return!1;n.getBoundingClientRect();var o=document.documentElement.clientHeight-i.offsetTop,e=this.getSaveableParent(n),t=n.offsetParent;let a=(e&&e.offsetParent!=t?e.offsetTop+n.offsetTop:n.offsetTop)-i.offsetTop;return a-="top"==s?0:o/3,a<0&&(a=0),"function"==typeof i.scrollTo&&(o=this.getView(n),this.attr(o,"computed_transform"),i.scrollTo(0,a)),!0}isHTML(e){let t=document.createElement("div");return t.innerHTML=e,t.innerHTML!=t.textContent&&(1!=t.childNodes.length||t.childNodes[0].nodeType!=Node.TEXT_NODE)}getSelector(n){let i="";if(n.id)i="'"+n.id+"'";else{let e=n.parentNode;if(!e)return debug({level:2,return:""},"Can't build selector for",n);var o,a=n.tagName.toLowerCase(),n=Array.prototype.indexOf.call(e.getElementsByTagName(a),n)+1;let t="";if(e.id)i={child:n,tag:a,parent:e.id};else{if(t=this.getSelector(e),!t)return"";i={child:n,tag:a,parent:convertToObject(t)}}let s="{";for(o in i){var l=i[o];"parent"==o&&"object"==typeof l?s+=o+":"+t+",":isNaN(l)?s+=o+":'"+l+"',":s+=o+":"+l+","}s=s.substr(0,s.length-1)+"}",i=s}return i}arrangeTable(e,r=!0){if(r&&"string"==typeof e)setTimeout(function(){API.dom.arrangeTable(e,!1)},500);else{let n=this.element(e);if(n&&"TABLE"==n.tagName&&!n.classList.contains("textContent")){var d="fixed"==this.attr(n,"computed_tableLayout"),t=API.dom.element("thead",n),u=API.dom.element("tbody",n);let o=[],s=[],a=0,l=[];var c=u.rows.length;if(u&&t){API.dom.attr(u,"onscroll","this.previousSibling.scrollLeft = this.scrollLeft;");var h=t.rows[0].cells;for(let i=0;i<h.length;i++){var m=t.rows[0].cells[i].textContent.length;o.push(0),l.push(0);for(let n=0;n<c;n++){let t=u.rows[n].cells[i];if(t){var p=t.innerHTML.split("<br>");let s=0;for(let t=0;t<p.length;t++){var g=p[t];let e=document.createElement("div");e.innerHTML=g;g=e.textContent;g.length>s&&(s=g.length)}let e=Math.max(s,m);n&&(e=Math.max(e,o[i]/n)),o[i]+=e,e>l[i]&&(l[i]=e),a+=e}}s[i]=Math.round(o[i]/c)}if(a){let i=[];for(let t=0;t<h.length;t++){var f=h[t];if(i[t]=1,s[t]>a/20){let e=f.textContent.length/s[t];e=2<e?.5:.8,i[t]=e,a-=Math.round(s[t]*(1-e)),o[t]*=e,s[t]*=e,l[t]*=e}}var v=this.attr(n,UD_useComputedPrefix+"maxWidth"),b=n.parentNode.getBoundingClientRect().width-5*h.length;let t=1;r=API.getView(n);let e=this.attr(r,"computed_transform");e&&"none"!=e&&(console.log("Transform="+e),r=e.match(/matrix\(([^,]*),/),console.log(r),r&&1<r.length&&(t=parseFloat(r[1])));for(let n=0;n<h.length;n++){let e=h[n];a*=t;var x=Math.round(100*o[n]/a),y=Math.round(b*o[n]/a);Math.min(Math.round(10*o[n]/(c*t)),35<x?Math.round(.6*y):y),t;let s=0;if(s=d?Math.round(b/h.length):v&&"none"!=v?(x=Math.round(v*o[n]/a),Math.min(16*l[n],x)):y,0<s){for(let t=0;t<u.rows.length;t++){let e=u.rows[t].cells[n];e&&(e.style.minWidth=s+"px",e.style.maxWidth=s+"px",1!=i[n]&&(e.style.fontSize=i[n]+"em"))}e.style.minWidth=s+"px",e.style.maxWidth=s+"px"}}}}}else"TABLE"!=n.tagName&&console.error("Bad arrange table request",e,n)}}arrangeTables(e){var t=this.elements("table",e);for(let e=0;e<t.length;e++){var s=t[e];this.arrangeTable(s,!1)}}}if("object"==typeof process){void 0===global.JSDOM&&"undefined"==typeof window&&(global.ModuleUnderTest="DOM");let domcursor=require("./domcursor.js");const DOM_cursor=domcursor.DOM_cursor;let udjsonmod=require("../ud-utilities/udjson.js");const UDJSON=udjsonmod.UDJSON;let domvaluemod=require("./domvalue.js");const DOMvalue=domvaluemod.DOMvalue;if(module.exports={DOM:DOM,DOM_cursor:DOM_cursor,JSONparse:JSONparse,JSONvalue:JSONvalue,UDJSON:UDJSON,DOMvalue:DOMvalue},void 0===global.JSDOM&&"undefined"==typeof window){console.log("Syntax dom.js OK"),console.log("Start of dom.js test program");let path="..";const testMod=require(path+"/tests/testenv.js");testMod.load([]);var dom=new DOM(document.getElementById("document"),null);let test="";{test="Test 1",console.log(dom.value("B0100000001000000M...textContent"));let element=dom.element("B0100000000000000M"),children=dom.children(element),firstChild=children[0];"attribVal"==dom.parentAttr(firstChild,"data-ud-attr")?console.log(test+" : OK"):console.log(test+": KO",firstChild,dom.parentAttr(firstChild,"data-ud-attr"))}{test="Test 2";let data={tag:"ul",name:"myul",defaults:{tag:{1:"li"}},value:{0:{value:"item1",tag:"li"},1:{value:"item2",tag:"li"}}},json={meta:{type:"list",name:"mylist",zone:"myListeditZone",caption:"My list",captionPosition:"top"},data:data,changes:{}},element=dom.JSONput(json),rjson=dom.JSONget(element);"list"==JSONvalue(rjson,"meta").type?console.log(test+" : OK"):console.log(test+": KO")}{test="3 - text editor";let data={tag:"textedit",mime:"text/text",value:["line1","line2","line3"]},json={meta:{type:"text",name:"mytextD",zone:"mytextDeditZone",caption:"My text",captionPosition:"top"},data:data,changes:{}},element=dom.JSONput(json),rjson=JSON.stringify(dom.JSONget(element));testResult(test,-1<rjson.indexOf("textedit")&&-1<rjson.indexOf("line1"),rjson)}{test="4 - views";let views=dom.views(),pages=dom.pages("myView");testResult(test,4==views.length&&1==pages.length,views.length+" views and "+pages.length+" pages in myView")}test="Test 6 - default content",testResult(test,dom.hasDefaultContent("B0100000009000000M"));{test="Test 7 - data- prefix read only";let element=dom.element("B0100000000000000M");dom.attr(element,"data-ud-model","test");let model=dom.attr(element,"ud_model");testResult(test,"test"==model)}console.log("Program checksum : ",debug("__CHECKSUM__")),console.log("Program coverage : ",debug("__COVERAGE__")),console.log("Test completed")}else window.DOM=DOM}class DOM_cursor{topElement=null;parent;dom;topHTMLoffset;HTMLelement;HTMLoffset;textElement;textOffset;selectionMultiNode=!1;selectionInNode=!1;focusElement;focusOffset;display;savedValues=[];outlineCurrentElementCSS=null;noIdTags=["tr","td","th","tbody","thead","table","div","span","ul","ol","li"];constructor(e,t){this.topElement=e,this.parent=t,this.dom=t,this.HTMLelement=null}getOrAddTextNode(e){if(!e)return null;let t=null;var s,n=e.childNodes;for(let e=0;e<n.length;e++)if(n[e].nodeType==Node.TEXT_NODE){t=n[e];break}return t?t.nodeType!=Node.TEXT_NODE&&(t=null):(s=this.dom.attr(e,"ude_place"),t=document.createTextNode(s||""),t=e.appendChild(t)),t}fetch(){debug({level:9,coverage:0},"Fetching cursor");var e=window.getSelection();if(!e.anchorNode)return this;let n=e.anchorNode.parentNode;if(e.anchorNode.nodeType!=Node.TEXT_NODE){n=e.anchorNode;var t=document.activeElement;if("INPUT"==t.tagName)return this.HTMLelement=t,this.HTMLOffset=1,this.textElement=null,this}var i=this.parent.getSaveableParent(n),t=i?this.parent.getView(n):null;if(!(i||t&&"App"==this.parent.attr(t,"name")))return this;if(i){var o=this.parent.attr(i,"exTag");let e=!0;-1<["div.html","div.zoneToFill","div.filledZone"].indexOf(o)&&(e=!1);let t=n,s=30;for(;t&&(!t.id||"document"!=t.id)&&s--;){if(t==i&&(e=!1),e&&!t.id&&-1==this.noIdTags.indexOf(t.tagName.toLowerCase()))return this;t=t.parentNode}if(!t||"document"!=t.id)return this}if(this.textElement=e.anchorNode,this.textOffset=e.anchorOffset,e.anchorNode.nodeType!=Node.TEXT_NODE){this.textElement=this.getOrAddTextNode(n);var s=this.textElement;this.HTMLelement=e.anchorNode,this.HTMLoffset=this.computeHTMLoffset(s.textContent,s.textContent.length,n.innerHTML)}else{this.HTMLelement=this.textElement.parentNode;var a=this.HTMLelement.childNodes;let t=0;for(let e=0;e<a.length;e++){var l=a[e];if(l==this.textElement)break;l.nodeType==Node.TEXT_NODE?t+=this.computeHTMLoffset(l.textContent,l.textContent.length):l.nodeType==Node.ELEMENT_NODE&&(t+=l.outerHTML.length)}this.HTMLoffset=t+this.computeHTMLoffset(this.textElement.textContent,this.textOffset)}this.selectionMultiNode=this.selectionInNode=!1;let r=e.focusNode;r.nodeType!=Node.TEXT_NODE&&(r=this.getOrAddTextNode(r)),!e.isCollapsed&&r&&this.textElement&&(this.focusElement=r,this.focusOffset=e.focusOffset,o=this.dom.attr(e.anchorNode.parentNode,"editable"),s=this.dom.attr(r.parentNode,"editable"),o&&s||s||(r=e.anchorNode,this.focusElement=r,this.focusOffset=0),e.anchorNode!=r?(this.selectionMultiNode=!0,o=this.textElement.parentNode.getBoundingClientRect(),s=this.focusElement.parentNode.getBoundingClientRect(),o.y>s.y&&(this.HTMLelement=this.focusElement.parentNode,this.HTMLoffset=this.focusOffset,this.textElement=this.focusElement,this.textOffset=this.focusOffset,this.focusElement=e.anchorNode,this.focusOffset=e.anchorOffset)):e.anchorOffset!=e.focusOffset&&(this.selectionInNode=!0,this.focusOffset<this.textOffset&&(this.textOffset=this.focusOffset,this.focusOffset=e.anchorOffset)));let d=document.getElementById("UDEcursorInfo"),u="";return d&&(u+="{",u+="element: '"+this.dom.getSelector(this.HTMLelement)+"',",u+="offset:"+this.textOffset+",",u+="tagName:"+this.HTMLelement.tagName+",",u+="classes:'"+this.HTMLelement.classList+"'",u+="selectionMultiNode:'"+this.selectionMultiNode+"'",u+="selectionInNode:'"+this.selectionInNode+"'",u+="}",d.textContent=u),this.outlineCurrentElementCSS&&(this.parent.removeCSSfromAll(this.outlineCurrentElementCSS,this.topElement),this.HTMLelement.classList.add(this.outlineCurrentElementCSS)),debug({level:8,coverage:"DOM_cursor.fetch"},"Cursor info updated",u),this}set(){if(!this.textElement){if(!this.HTMLelement)return!1;let e=this.HTMLelement,t=5;for(;e&&e.nodeType!=Node.TEXT_NODE&&--t;)e=e.firstChild;if(!e||e.nodeType!=Node.TEXT_NODE)return!1;this.textElement=e,this.HTMLelement=e.parentNode,this.textOffset=0}if(this.textElement.createTextRange){let e=this.textElement.createTextRange();e.move("character",this.textOffset),e.select()}else if(this.textElement.selectionStart)this.HTMLelement.focus(),this.textElement.setSelectionRange(caretPos,caretPos);else{let t=window.getSelection();0<t.rangeCount&&t.removeAllRanges();let s=this.dom.getParentWithTag(this.HTMLelement,"tbody");if(s){let e=20;for(;!this.dom.isVisible(this.HTMLelement,"tbody")&&--e;)s.scrollTop+=2}if(this.HTMLelement&&this.textElement){this.HTMLelement.focus();let e=document.createRange();if(this.textElement&&void 0!==this.textElement.parentNode&&this.textElement.parentNode&&e.selectNode(this.textElement),this.textOffset>this.textElement.textContent.length&&(debug({level:4},"DOM_cursor auto-correcting invalid textOffset",this.textElement,this.textOffset),this.textOffset=this.textElement.textContent.length),e.setStart(this.textElement,this.textOffset),e.collapse(!0),t.addRange(e),"li"===this.HTMLelement.tagName.toLowerCase()){var n=this.HTMLelement;let e=n.parentNode,t=this.dom.element("scroll");var i=this.dom.attr(t,"computed_height");e.offsetTop-t.scrollTop+e.offsetHeight>=i&&(t.scrollTop=e.offsetTop-(i-e.offsetHeight-100)/2),e.offsetHeight<e.scrollHeight&&n.offsetTop>e.scrollTop+e.offsetHeight&&(e.scrollTop=n.offsetTop-50)}}}}clear(){let e=window.getSelection();e.removeAllRanges()}setAt(e,n=0){e=this.dom.element(e);if(e){var i=this.dom.childNodes(e).concat(this.dom.elements("*",e));let s=this.getOrAddTextNode(e);for(let t=0;t<i.length;t++){let e=i[t];if(e.nodeType==Node.TEXT_NODE){s=e;break}if("input"==e.tagName.toLowerCase())return e.focus(),this.HTMLelement=e,void e.setSelectionRange(n,n);if(!s&&this.dom.attr(e,"editable")){var o=e.childNodes;for(let e=0;e<o.length;e++){var a=o[e];if(a.nodeType==Node.TEXT_NODE){s=a;break}}}}return s?(this.textElement=s,this.HTMLelement=s.parentNode,n>this.textElement.textContent.length&&(n=this.textElement.textContent.length),this.HTMLoffset=this.computeHTMLoffset(this.textElement.textContent,n,this.HTMLelement.innerHTML),this.textOffset=n,this.HTMLelement&&this.textElement&&this.set()):this.set(),this}}save(t=-1){if(!this.HTMLelement||this.HTMLelement.nodeType!=Node.ELEMENT_NODE)return-1;""==t?t=-1:"string"==typeof t&&(t=parseInt(t));let s={};if(s.scroll=this.dom.element("scroll").scrollTop,s.free=!1,this.HTMLelement&&this.HTMLelement.nodeType==Node.ELEMENT_NODE){var e=this.dom.getSelector(this.HTMLelement);if(!e)return t;s.HTMLelementId=convertToObject(e),s.HTMLoffset=this.HTMLoffset;var n=this.HTMLelement.childNodes;for(let e=s.textElementIndex=0;e<n.length;e++)n[e]==this.textElement&&(s.textElementIndex=e);s.textOffset=this.textOffset}if(-1==t){for(let e=this.savedValues-1;0<=e;e--)if(this.savedValues[e].free){t=e+1;break}-1==t&&(this.savedValues.push(s),t=this.savedValues.length)}return this.savedValues[t-1]=s,debug({level:4},"Saved cursor",s,t),t}restore(t,s=!1){if(debug({level:4},"Restoring cursor"),void 0===t?t=this.savedValues.length:"string"==typeof index&&(index=parseInt(index)),!(""==t||t<=0)){let e=this.savedValues[t-1];if(s||(e.free=!0),e.scroll&&(this.dom.element("scroll").scrollTop=e.scroll),void 0===e.HTMLelementId||""==e.HTMLelementId)return!1;if(this.HTMLelement=this.dom.element(e.HTMLelementId),this.HTMLelement){this.HTMLoffset=e.HTMLoffset;this.HTMLelement.childNodes;return this.textElement=this.HTMLelement.childNodes[e.textElementIndex],this.textOffset=e.textOffset,debug({level:4},"Restored cursor",this.savedValues,this.HTMLelement,this.textElement,this.textOffset),this.set(),!0}debug({level:3},"Cursor can't restore",e.HTMLelementId)}}savedCursorAsString(e){e=this.savedValues[e-1];return JSON.stringify(e)}setCurrentCursorPosition(t){if(0<=t){var s=window.getSelection();let e=createRange(document.getElementById("test").parentNode,{count:t});e&&(e.collapse(!1),s.removeAllRanges(),s.addRange(e))}}computeHTMLoffset(e,t,s=""){t=e.substr(0,t)+"__MARKER__";let n=document.createElement("div");n.textContent=t;let i=n.innerHTML.indexOf("__MARKER__");return s&&(i+=s.indexOf(e)),i}getSelectedText(e=!1){var t=this.textElement,s=this.focusElement,n=this.computeHTMLoffset(t.textContent,this.textOffset),i=this.computeHTMLoffset(s.textContent,this.focusOffset);let o=t,a=1e3,l=o.textContent.substring(n);t==s&&(l=o.textContent.substring(n,i));let r=[];for(e&&(0==n?r.push(o):o.textContent=o.textContent.substring(0,n));o&&o!=s&&a--;)o=o.nextSibling,o==s?(l+=o.textContent.substring(0,i),e&&(cursor.focusOffset<o.textContent.length?o.textContent=o.textContent.substring(i):r.push(o))):(l+=o.textContent,e&&r.push(o));for(let e=0;e<r.length;e++)r[e].remove();return l}}"object"==typeof process&&(module.exports={DOM_cursor:DOM_cursor},void 0===global.JSDOM&&"undefined"==typeof window&&(console.log("Syntax : OK"),console.log("Test completed")));class DOMvalue{parent=null;dom;empty;useFirstCharAsType=!0;constructor(e){this.dom=e,this.cursor=e.cursor,this.lowerCaseAttr=UD_lowerCaseAttr,this.indexableTags=UD_indexableTags,this.empty=document.createElement("p"),this.empty.textContent=""}value(s,n=null,e=null){switch((s="string"==typeof s?s.split("."):s).length){case 1:s[2]=s[0],s[1]=s[0]="";break;case 2:s[2]=s[1],s[1]=s[0],s[0]=""}this.useFirstCharAsType=!0,"!"==s[2].substring(0,1)&&(this.useFirstCharAsType=!1,s[2]=s[2].substring(1));let i;if(e)i=e;else if(i=this.findElement(s[0]),!i)return debug({level:8},"can't find",s[0]),null;let o=this.dom.getSaveableParent(i);var a=this.dom.attr(o,"exTag");if(-1<["div.json","div.connector"].indexOf(a)){let e=o.getElementsByTagName("div")[0].textContent,t=s[1];s[2]&&(t+="/"+s[2]),-1<e.indexOf('"meta":')&&(t="data/value/"+t);a=this.dom.udjson.valueByPath(e,t,n);if(a)return DOM_lastAccessedValues.push(i),a}if(("-"==s[1][0]||"+"==s[1][0])&&"TABLE"==i.tagName){var t=(this.dom.autoHome||this.cursor.HTMLelement).parentNode,l=i.tBodies[0].rows;let e=-1;for(e=0;e<l.length&&l[e]!=t;e++);s[1]=""+(parseInt(s[1])+e+1)}if((s[1]||s[2])&&(i=this.findChild(i,s[1],s[2])),!i)return debug({level:8},"can't find child (path)",s),"N/A";let r=s[3];if(!r||""==r){if(!i)return"N/A";r="innerHTML"}if(this.dom.lastAccessedElement=i,("textContent"==r||"innerHTML"==r)&&(DOM_lastAccessedValues.push(i),n))return i[r]=n;if("all"==s[2]&&"object"==typeof i){n="";for(let e=0;e<i.length;e++)n+=this.value("..."+r,null,i[e])+",";n=n.substring(0,n.length-1).split(",")}else 0==r.indexOf("css_")?n?i.style[r.substr(4)]=n:n=i.style[r.substr(4)]:-1<UD_appAttributes.indexOf(r.toLowerCase())?n?this.dom.attr(i,r,n):(n=this.dom.attr(i,r),"_type"==r&&(n+=i.textContent),n&&""!=n||(n=this.dom.parentAttr(i,r))):n="_element"==r?i:"length"==r?i.length:(n=(n=i[r])&&""!=n||"textContent"==r||"innerHTML"==r?n:this.dom.parentAttr(i,r))||"";if(-1<this.lowerCaseAttr.indexOf(r))n=n.toLowerCase();else if(("textContent"==r||"innerHTML"==r)&&""!=s[2])if(s[2].substr(0,1).toLowerCase()==s[2].substr(0,1)&&this.useFirstCharAsType)switch(s[2].substr(0,1)){case"i":n=""==n?0:parseInt(n);break;case"f":n=""==n?0:parseFloat(n)}else n&&""!=n&&!isNaN(n)&&(n=(parseFloat(n)==parseInt(n)?parseInt:parseFloat)(n));return 5==s.length&&(n='<span class="'+s[4]+'">'+n+"</span>"),debug({level:3},s,this.dom.autoIndex1,e,n=null==n?"N/A":n),n}findElement(e){var t,s=null;if(e&&""!=e)s=(s=(s=document.getElementById(e))||document.getElementById(e.replace(/ /g,"_")))||this.dom.elementByName(e);else{if(this.dom.autoHome)n=this.dom.autoHome;else{if(this.cursor.HTMLelement||this.cursor.fetch(),!this.cursor.HTMLelement)return debug({level:2,returnValue:null},"cursor not set");var n=this.cursor.HTMLelement}switch(n.tagName.toLowerCase()){case"ul":case"span":break;case"td":if("TABLE"!=(n=n.parentNode.parentNode.parentNode).tagName)return debug({level:2,returnValue:null},"No TABLE containing TD")}for(var i=n,o=5;!this.dom.attr(i,"ude_datasrc")&&--o;)i=i.parentNode;s=this.dom.attr(i,"ude_datasrc")?document.getElementById(this.dom.attr(i,"ude_datasrc")):n}return s?((-1<this.dom.attr(s,"ud_type").indexOf("Object")||"none"==this.dom.attr(s,"computed_display"))&&(t=s.parentNode.nextSibling,this.dom.attr(t,"ude_bind")==s.id&&"TABLE"==t.childNodes[0].tagName&&(s=t.childNodes[0])),s):debug({level:8,returnValue:null},e+" not found in DOM")}findChild(e,t,s){let n=e;if(""==t||0==t.indexOf("auto")){var i=t.substr(4);if(0<this.dom.autoIndex1)t=this.dom.autoIndex1;else{let e;switch(e=this.dom.autoHome||this.cursor.HTMLelement,e.tagName.toLowerCase()){case"td":case"li":t=1;for(var o=e.parentNode;o=o.previousSibling;)t++;break;case"spam":break;default:return debug({level:2,returnValue:null},"unexpected tag "+e.tagName)}}i&&(t+=parseInt(i)),n=n.getElementsByTagName("tbody")[0].rows[t-1]}else if("all"==t)"table"===e.tagName.toLowerCase()&&(n=e.rows);else{if(!(-1<this.indexableTags.indexOf(e.tagName.toLowerCase())))return null;if(isNaN(parseInt(t))){var a=$$$.findRows(e.id,"id:"+t+",");if(!Array.isArray(a)||1!=a.length)return null;i=e.getElementsByTagName("tbody")[0].rows;n=i[a[0]-1]}else switch(t=parseInt(t),e.tagName.toLowerCase()){case"table":var l=e.getElementsByTagName("tbody")[0].rows;if(t<0||t>l.length)return debug({level:2,return:null},"Bad index 1",n,t);n=l[t-1];break;case"ul":l=e.childNodes;if(t<0||t>l.length)return debug({level:2,return:null},"Bad index 1",n,t);n=l[t-1]}}return n?(""==s||(isNaN(parseInt(s))?"tr"===n.tagName.toLowerCase()&&("all"==s?n=n.cells:(a=(a=n.parentNode.parentNode.getElementsByTagName("thead")[0].rows[0])||n.parentNode.rows[0],-1<(a=this.getColNamesForIndex(a.cells)).indexOf(s)?n=n.cells[a.indexOf(s)]:(n=this.empty,console.log("Force empty",s,a)))):"tr"===n.tagName.toLowerCase()&&(n=n.cells[s-1])),n):null}getColNamesForIndex(t){let s=[];for(let e=0;e<t.length;e++)t[e].getAttribute("_type")?s.push(t[e].getAttribute("_type")+t[e].textContent.replace(/ /g,"").replace(/-/,"_").replace(/(')/g,"")):s.push(t[e].textContent.replace(/ /g,"").replace(/-/,"_").replace(/(')/g,""));return s}}if("object"==typeof process&&(module.exports={DOMvalue:DOMvalue},void 0===global.JSDOM&&"undefined"==typeof window&&"undefined"==typeof ModuleUnderTest)){ModuleUnderTest="domvalue.js",console.log("Syntax:OK "+ModuleUnderTest),console.log("Start of test program"),console.log("Setting up browser (client) test environment");let path="..";const testMod=require(path+"/tests/testenv.js");testMod.load([]);let ud=new UniversalDoc("document",!0,133),dom=ud.dom;console.log("start testing domvalue.js");let test="";{test="Test 1: ";let val=dom.value("B0100000001000000M...textContent");"Hello big world"==val?console.log(test+"OK"):console.log(test+"KO",val)}test="2 read JSON value",testResult(test,"no"==dom.domvalue.value("testConnector_parameters.ready..textContent")),test="3 read velue in table with string indexes",testResult(test,32==dom.domvalue.value("myTable.myId1.val1.textContent"),dom.domvalue.value("myTable.myId1.val1.textContent")),console.log("Test completed"),process.exit(0)}class UDAJAX{ud;dom;server;service;serverRequestId=0;serverFormName="";pending={};url;method;html;js;fetchAction="AJAX_fetch";updateAction="DEFAULT";refreshAction="AJAX_show";useNodejs=!1;PHPcookie="";isOS=!1;constructor(e,t,s){this.ud=e,this.dom=e.dom,this.server=t,this.service=s,this.serverFormName=e.serverFormName,this.isOS=this.server&&-1==this.server.indexOf("sd-bee.com")&&-1==this.server.indexOf("rfolks.com"),"object"==typeof process&&(this.useNodejs=!0)}async serverRequestPromise(s,n="GET",i="",o={},a=null,l=null){return o.promise=new Promise((e,t)=>{o.resolve=e,o.reject=t,this.serverRequest(s,n,i,o,a,l)}),o.promise}serverRequest(t,e="GET",s="",n={},i=null,o=null){if("/"==(t=this.isOS?t.replace("/webdesk/","/"+this.service+"/"):t).charAt(0)?this.url=this.server+t:this.url=this.server+"/"+t,this.isOS&&("POST"==e&&(-1<this.server.indexOf("appspot")||-1<this.server.indexOf("cloudshell"))&&(this.url=this.server),"POST"==e&&-1<t.indexOf("AJAX_clipboard")&&(this.url=this.server+"/"+this.service+"/")),this.method=e,n.uri=t,n.url=this.url,"function"!=typeof serverTracker||serverTracker({status:"not sent yet",url:this.url,data:s}))if(this.useNodejs)"GET"==e?this.nodejs_get(t,n,i,o):"POST"==e&&TEST_serverSaving&&this.nodejs_post(t,s,n,i,o);else{t=new XMLHttpRequest;t.udajax=this,t.serverRequestId=++this.serverRequestId,t.callerContext=n;let e=this.dom.element("system-message-popup");if(t.popup=!(!e||e.classList.contains("show"))&&e,t.onreadystatechange=function(){if(4==this.readyState){if(void 0!==this.udajax.pending[this.serverRequestId]&&delete this.udajax.pending[this.serverRequestId],"function"==typeof serverTracker&&serverTracker({status:this.status,url:this.udajax.url,context:this.callerContext,response:this.responseText}),200==this.status)debug({level:5},"server response (requestid, url, context, response)",this.serverRequestId,this.udajax.url,this.callerContext,this.responseText),debug({level:2},"Response server",this.serverRequestId),this.udajax.splitResponseIntoHTMLandJS(this.responseText),i?i(this.callerContext,this.udajax.html,this.udajax.js):"POST"==this.udajax.method?this.udajax.postSuccess(this.callerContext,this.udajax.html,this.udajax.js):"GET"==this.udajax.method&&this.udajax.getSuccess(this.callerContext,this.udajax.html,this.udajax.js);else if(console.log("AJAX error"),debug({level:2},"can't reach server with ",this.udajax.url),o&&o(this.callerContext,this.status),this.callerContext.promise)try{Promise.reject(this.callerContext.promise)}catch(e){console.error(e)}this.popup&&this.popup.classList.remove("show")}},t.open(this.method,this.url,!0),t.setRequestHeader("Content-type","application/x-www-form-urlencoded"),"object"==typeof s){let e="";for(var a in s)e+=a+"="+s[a]+"&";e=e.substring(0,e.length-2),s=e}t.send(s),this.pending[this.serverRequestId]={method:this.method,url:this.url},(void 0!==n.waitPopup&&n.waitPopup||"fill zone"==n.action&&n.zone)&&e&&!e.classList.contains("show")&&(e.innerHTML='<div style="text-align:center"><img src="'+UDE_processingIcon+'"></div>',e.classList.add("show")),debug({level:2},"request sent to server",t.serverRequestId)}}isBusy(){return Object.keys(this.pending).length}splitResponseIntoHTMLandJS(e){this.html="",this.js="";let t=e.indexOf("window.onloadapp"),s=16;var n,i;return-1==t&&(t=e.indexOf("window.onload"),s=13),50<t?(n=t-'<script type="text/javascript" lang="javascript">'.length-3,this.html=e.substr(0,n),n=t+s+3+9+2,i=e.substr(n).indexOf("}"),this.js=e.substr(n,i),this.js=this.js.replace(/LFJ_openAcco/g,"{"),this.js=this.js.replace(/LFJ_closeAcco/g,"}")):this.html=e,{html:this.html,js:this.js}}postSuccess(t,s,e){if("ignore"!=t.action)if("remove"==t.action){var n=this.dom.getView(t.element);t.element.remove(),n&&$$$.paginate(n)}else if("fill zone"==t.action)document.getElementById(t.zone).innerHTML=s;else if("set json"==t.action){let e=this.dom.element(t.holder);n=this.dom.udjson.parse(s);n&&(e.textContent=this.dom.udjson.valueByPath(e.textContent,t.jsonPath,n))}else"reload"==t.action?location.reload(!0):"close"==t.action?(this.dom.element("document").innerHTML=s,window.close()):0==s.trim().indexOf("{")?t.ud.updateElement(t.element,s.trim()):0!=s.indexOf("<")&&"refresh"!=t.action||(t.ud.topElement.innerHTML=s);var i;t.promise&&(t.resolve?t.resolve(t):t.promise.then&&t.promise.then(t)),t.setCursor&&(i=t.ud.ude.dom.cursor,setTimeout(function(){i.restore()},100),debug({level:4},"Cursor restore set for 100ms")),e&&"ignore"!=t.action&&(debug({level:3},"js to run",e),doOnload(e))}getSuccess(t,s,e){if("ignore"!=t.action){var n=t.action;if("update"==n||"insert"==n)t.ud.updateElement(t.element,s);else if("fill zone"==n)debug({level:2},"fill zone",t),document.getElementById(t.zone).innerHTML=s,"document"==t.zone&&(this.ud.addToHistory(t.url),this.ud.initialise());else if("set json"==t.action){let e=this.dom.element(t.holder);var i=this.dom.udjson.parse(s);i&&(e.textContent=this.dom.udjson.valueByPath(e.textContent,t.jsonPath,i))}else"refresh"==n?(t.element.innerHTML=s,this.ud.addToHistory(t.url)):"reload"==n?("undefined"==typeof process&&(document.open("text/html","replace"),document.write(s),document.close()),ud.topElement=ud.dom.topElement=ud.dom.element("document")):"compositeUpdate"==n&&(t.element.textContent=s,s=this.dom.getSaveableParent(element),this.ud.ude.initialiseElement(s.id));t.promise&&(t.resolve?t.resolve(t):t.promise.then&&t.promise.then(t)),e&&debug({level:3},"js to run",e),e&&doOnload(e)}}updateZone(e,t){e="/"+this.service+"/"+e,t={zone:t,action:"fill zone",element:null,ud:this.ud};this.serverRequest(e,"GET","",t)}postElement(s,e,n,t,i=0,o){let a=e;"refresh"!=n&&"insert"!=n||(a=this.dom.attr(s,"ud_oid")),-1==e.indexOf("UD|")&&(e=e.replace("CD","UD|3|CD"));let l=!1,r=this.dom.attr(s,"ud_fields"),d="form="+this.serverFormName+"&input_oid="+a;if("yes"==this.dom.attr(s,"ud_saveId").toLowerCase()&&(d+="&nname="+s.id,this.dom.attr(s,"ud_saveId","__CLEAR__")),""==r||-1<r.indexOf("nlabel")){let e=this.dom.attr(s,"name");var u,c;s.id==API.getConstant(UD_wellKnownElements,"docNameHolder")&&(console.error("DEPRECATED CODE USED udajax l 266"),c=this.dom.children(s),e=(0<c.length?c[0]:s).textContent,u=e.replace(/ /g,"").substring(0,8),(c=this.dom.udjson.parse(this.dom.attr(s,"ud_extra")).name+"_"+u)&&u&&(d+="&nname="+c)),e&&(d+="&nlabel="+e)}let h="",m="";if(""==r||-1<r.indexOf("tcontent")){var p=Array.prototype.slice.call(s.childNodes);if(p.length){let e=null,t=p[0].textContent;if(0==t.indexOf("{")&&(e=API.json.parse(t)),e&&JSONvalue(e,"meta"))m=p[0].textContent,"remove"!=n&&(h=this.dom.udjson.valueByPath(e,"meta/zone"));else if(this.useNodejs)m=s.innerHTML;else for(let e=0;e<p.length;e++){var g=p[e];if(g.nodeType==Node.TEXT_NODE)m+=g.textContent;else if(g.nodeType==Node.ELEMENT_NODE&&!this.dom.attr(g,"ude_bind")){var f=this.dom.keepPermanentClasses(g.className);let e=g.outerHTML;f!=g.className&&(e=e.replace('class="'+g.className+'"','class="'+f+'"')),m+=e}}}"html"==this.dom.attr(s,"ud_type")&&(m=m.replace(/&amp;/g,"&")),-1<[4,5,51].indexOf(t)?m="":this.dom.attr(s,"ud_content")&&(m=doOnsave(this.dom.attr(s,"ud_content"))),m=htmlEntities2(m,s),d+="&tcontent="+encodeURIComponent(m)}var v;!h||(v=(v=this.dom.element(h))?v.innerHTML:"")&&v.length<65e3&&(d+="&thtml="+encodeURIComponent(v)),"remove"==n?d+="&iaccess=0&tlabel=owns":"insert"==n&&(d+="&nname="+this.dom.attr(s,"id")),(""==r||-1<r.indexOf("stype"))&&(d+="&stype="+t),(""==r||-1<r.indexOf("nstyle"))&&(d+="&nstyle="+this.dom.keepPermanentClasses(s.className,!0)),d+="&taccessRequest="+this.ud.userId,(""==r||-1<r.indexOf("textra"))&&(v={width:s.scrollWidth,height:s.scrollHeight,offsetLeft:s.offsetLeft,offsetTop:s.offsetTop,marginTop:Math.round(parseFloat(this.dom.attr(s,"computed_marginTop"))),marginBottom:Math.round(parseFloat(this.dom.attr(s,"computed_marginBottom"))),system:this.dom.udjson.parse(this.dom.attr(s,"ud_extra"))},-1<r.indexOf("textra")&&-1==r.indexOf("tcontent")&&((t=this.dom.udjson.parse(s.getElementsByTagName("div")[0].textContent)).meta?v.system=t.data.value:v.system=t),d+="&textra="+JSON.stringify(v)),d+="&dmodified=auto","refresh"==n&&(l=!0),"DEFAULT"==this.updateAction&&(this.updateAction=$$$.getParameter("elementUpdateAction"));let b="";this.updateAction&&(b+="/"+this.service+"/"+e+"/"+this.updateAction+"/"),"refresh"==n&&(b="/"+this.service+"/"+e+"/"+this.refreshAction+"/");n={element:s,action:n,setCursor:l,ud:this.ud};this.serverRequest(b,"POST",d,n,null)}postForm(e,t,s=""){var n=this.dom.element(e);if(!n)return debug({level:2,return:null},"can't find ",e);let i="";if(i="form"==n.tagName.toLowerCase()?n:this.dom.element("form",n),!i)return debug({level:2,return:null},"no form in",n);for(var o="",a=i.elements,l=0;l<a.length;l++)o+="&"+a[l].name+"="+a[l].value;o=o.substr(1),e={zone:e,element:null,action:"fill zone",setCursor:!1,ud:this.ud};return""!=s&&!confirm(s)||this.serverRequest(t,"POST",o,e),!1}link(e,t,s,n){}nodejs_get(e,o={},a=null,t){var s=window.request;this.server="http://dev.rfolks.com","/"==e.charAt(0)?this.url=this.server+e:this.url=this.server+"/"+e;e=s.jar();this.PHPcookie&&e.setCookie({key:"PHPSESSID",value:this.PHPcookie},"http://dev.rfolks.com"),this.pending[++this.serverRequestId]={method:"GET",url:this.url,context:o};s(this.url,{jar:!0},(e,t,s)=>{process.ud=global.ud;let n=global.ud.udajax;void 0!==n.pending[n.serverRequestId]&&(n.pending[n.serverRequestId].context,delete n.pending[n.serverRequestId]);s.replace(/RegisterBlock/g,"console.log");var i=t.headers["set-cookie"];if(i)for(let t=0;t<i.length;t++){let e=i[t];e=e.split(";"),"PHPSESSID"==e[0]&&(this.PHPcookie=e[1])}n.nodejs_processResponse(s,"get",o,a),o.promise&&o.resolve()})}nodejs_post(e,s,t={},a=null,n){let i=window.request;this.server="http://dev.rfolks.com","/"==e.charAt(0)?this.url=this.server+e:this.url=this.server+"/"+e;let o=s;if("object"!=typeof s){o={};let t=s.split("&");for(let e=0;e<t.length;e++){var l=t[e].split("=");o[l[0]]=decodeURIComponent(l[1])}}let r=i.jar();this.PHPcookie&&r.setCookie({key:"PHPSESSID",value:this.PHPcookie},"http://dev.rfolks.com"),this.pending[++this.serverRequestId]={method:"POST",url:this.url,context:t},i.post({url:this.url,form:o,jar:!0},(e,t,s)=>{let n=global.ud.udajax,i=null;if(void 0!==n.pending[n.serverRequestId]&&(i=n.pending[n.serverRequestId].context,delete n.pending[n.serverRequestId]),e)console.error("nodejs_post",e);else{var o=t.headers["set-cookie"];if(o)for(let t=0;t<o.length;t++){let e=o[t];e=e.split(";"),"PHPSESSID"==e[0]&&(this.PHPcookie=e[1])}n.nodejs_processResponse(s,"post",i,a),i&&i.promise&&i.resolve()}})}nodejs_processResponse(html,method,context,successCallback=null){if(void 0===this.url&&(this.url=context.url),-1<this.url.indexOf("AJAX_"))this.splitResponseIntoHTMLandJS(html),successCallback?successCallback(context,this.html,this.js):(method="get",this.getSuccess(context,this.html,this.js));else{let p1=html.indexOf('<div id="main"'),p1b=html.indexOf("</div> \x3c!-- main --\x3e"),p2=html.indexOf("window.onloadapp");if(50<p2){var str='<script type="text/javascript" lang="javascript">';let p3=p2-str.length-3;this.html=html.substr(0,p3);let main=document.getElementById("main");main.innerHTML=html.substring(p1+6,p1b);let p4=p2+16+3+9+2,jspart=html.substring(p4),p5=jspart.indexOf("<\/script>");this.js=jspart.substring(0,p5-2)}else document.body.innerHTML=html.substring(p1+6,html.indexOf("</body>")-1);if(ud.topElement=ud.dom.topElement=document.getElementById("document"),this.js){let p1=this.js.indexOf("require(");const reqMod=require("../tests/testenv.js");p1&&(this.js=this.js.replace(/require\(/g,"reqMod.require("));let js="try {"+this.js+"} catch( e) {\n";js+='let lines = this.js.split( "\\n");\n',js+="console.log( e, e.message);\n",js+="}",eval(js),this.js=""}}}}if("object"==typeof process)if(module.exports={UDAJAX:UDAJAX},void 0===global.JSDOM&&"undefined"==typeof window){console.log("Syntax udajax.js:OK"),console.log("Setup test environment");var envMod=require("../tests/testenv.js");envMod.load(),window.request=require("request");async function testGet(e,t){var s="Async get test";await t.udajax.serverRequestPromise(e,"GET","",{ud:t,action:"reload"}),"Text"==t.dom.value("B01000000B0000000M...textContent")?console.log(s+" : OK"):console.log(s+" : KO"),console.log("Test completed"),process.exit(0)}ud=new UniversalDoc("document",!0,133),console.log("Start of test program");let url="webdesk/UniversalDocElement--21-725-21--UD|3|NO|OIDLENGTH|CD|5/show/tusername|demo/tpassword|demo/";testGet(url,ud),console.log("Test completed"),process.exit(0)}else window.request=require("request");class UDEclickHandler{editor=null;dom=null;topDocument=null;mouseDownTime=0;mouseUpTime=0;constructor(e){this.editor=e,this.dom=e.dom,this.topElement=this.dom.topElement,this.setupEventListeners(),this.setupShortcuts()}setupEventListeners(){let t=this;this.topElement.addEventListener("click",function(e){t.event(e)}),this.topElement.addEventListener("mousedown",function(e){t.event(e)}),this.topElement.addEventListener("mouseup",function(e){t.event(e)}),this.topElement.addEventListener("touchstart",function(e){t.event(e)}),this.topElement.addEventListener("touchend",function(e){t.event(e)})}setupShortcuts(){this.requires2stageEditing=$$$.getShortcut("requires2stageEditing"),this.testEditorAttr=$$$.getShortcut("testEditorAttr"),this.clearClasses=$$$.getShortcut("clearClasses"),this.getSaveableParent=this.dom.getSaveableParent.bind(this.dom),this.getEditableParent=this.dom.getEditableParent.bind(this.dom),this.cursor=this.dom.cursor,this.contextualMenuOn=$$$.getShortcut("displayMenu"),this.contextualMenuOff=$$$.getShortcut("hideMenu"),this.element=this.dom.element,this.attr=this.dom.attr.bind(this.dom),this.parentAttr=this.dom.parentAttr.bind(this.dom),this.udjson=this.dom.udjson,this.dispatchEvent=this.editor.dispatchEvent.bind(this.editor),this.toggleClass=$$$.getShortcut("toggleClass")}event(t){let s=this.clickedElement(t);if(s){let e=!1;var n;this.editor.watchElementForChange=null,this.handledByBrowser(s)||(n=this.isEditable(s,!1),this.monitorAndFilter(t,n,s)&&(this.insideActionBox(s)?!e&&this.editor.requires2stageEditing(s)&&(s=this.editor.editingElement):e=n?(this.cursor.HTMLelement==s||s.contains(this.cursor.HTMLelement)||this.cursor.HTMLelement.contains(s)||this.editor.dispatchEvent({event:"click outside"},this.cursor.HTMLelement),this.cursor.fetch(),e=this.editor.dispatchEvent(t,s),!e&&this.editor.requires2stageEditing(s)&&(s=this.editor.editingElement),!e&&$$$.testEditorAttr(s,"ude_menu")&&(e=this.displayMenu(s)),e||this.emulateMobile(t)):(t.ud_clickable=!1,t.ud_editable=!1,e=e||this.dispatchEvent(t,s),this.cursor.set(),e||this.displayMenuOnNonClickable(s)),e&&"touchend"!=t.type&&t.preventDefault()))}}handledByBrowser(e){var t=e.parentNode;let s=!1;return s=t&&"SPAN"==t.tagName&&e.parentNode.classList.contains("link")?"A"==e.tagName&&!$$$.testEditorAttr(e,"ude_edit"):""!=this.dom.parentAttr(e,"onclick")||"A"==e.tagName||"INPUT"==e.tagName,s}insideActionBox(e){let t=this.dom.getParentWithAttribute("ud_type",e);return!!t&&t.classList.contains("actionBox")}isEditable(e,t){var s=this.attr(e,"exTag");return!(!e||"document"==e.id||"false"==this.parentAttr(e,"contenteditable")||"div.page"==s||!$$$.testEditorAttr(e,"ude_edit")&&!$$$.testEditorAttr(e,"ude_stage")&&"input"!=s||t&&"link"!=this.attr(e.parentNode,"ud_type"))}monitorAndFilter(e,t,s){if("INPUT"==s.tagName||this.attr(s,"onclick"))return!0;switch(e.type){case"mousedown":return this.mouseDownTime=this.editor.ticks,!1;case"mouseup":return this.mouseUpTime=this.editor.ticks,!1;case"touchstart":return this.editor.touchMove=!1;case"touchend":return this.editor.touchMove?!1:!1}return!this.editor.menuManager.click(s,e)}clickedElement(e){let s=e.target;if(!s&&void 0!==e.composedPath){var n=e.composedPath();for(let t=0;t<n.length;t++){let e=n[t];if(-1<e.className.indexOf("Noedit")&&(this.dom.cursor.set(),s=null),"document"==e.id)break}}let t=s,i=20;for(;!t.id&&"A"!=t.tagName&&--i;)t=t.parentNode;if(i&&"A"==t.tagName){var o=this.editor.ticks-this.mouseDownTime,a=this.dom.attr(t,"href");if("mouseup"==e.type&&a&&18<o&&o<50)return window.open(a,"article"),t}return s==this.topDocument?(e.preventDefault(),null):s}stopEditing(){this.editor.editElement&&(this.clearClasses(this.editor.editElement,"editing,edcontainer,edinside"),this.editor.editElement=null,this.contextualMenuOff(),this.editor.leave2stageEditing(!0),this.cursor.clear())}displayMenu(s){let n=!1;if(this.testEditorAttr(s,"ude_menu")){var i=this.getSaveableParent(s);let e=this.getEditableParent(s,this.dom.cursor.selectionInNode);if(!i||!e)return;let t=this.attr(e,"exTag");this.clearClasses(i,"editing edcontainer edinside"),this.clearClasses(e,"editing edcontainer edinside"),0!=t.indexOf("span")||e.classList.contains("caption")||(this.toggleClass(i,"edcontainer"),this.toggleClass(s,"edinside")),this.editor.editElement=i,this.cursor.selectionInNode&&-1==["div.editzone"].indexOf(this.dom.attr(e,"exTag"))&&!e.classList.contains("linetext")?n=this.contextualMenuOn(e,this.cursor.selectionInNode):this.cursor.selectionMultiNode?this.contextualMenuOff():n=this.contextualMenuOn(s)}return n}displayMenuOnNonClickable(e){let t=this.dom.getSaveableParent(e);t.classList.contains("collapsable")&&(this.stopEditing(),this.editor.editElement=t,this.contextualMenuOn(t),processed=!0)}emulateMobile(e){let s=!1;if(this.emulateMobile){let t=this.editor;this.dom.topElement.addEventListener("mousemove",function(e){t.pointEvent(e)});var n=e.clientX,e=e.clientY;this.editor.lastClickPosition.x=n,this.editor.lastClickPosition.y=e,s=!0}return s}}if("object"==typeof process&&(module.exports={UDEclickHandler:UDEclickHandler},void 0===global.JSDOM&&"undefined"==typeof window)){var envMod=require("../tests/testenv.js");envMod.load(),console.log("Syntax OK"),console.log("Start of UDEclickHandler test program"),ud=new UniversalDoc("document",!0,133);let handle=new UDEclickHandler(ud.ude),test="click",el=$$$.dom.element("B010000000500000M");el.click();let menu=$$$.dom.element("fmenu"),children=$$$.dom.children(menu);children.length?console.log(test+" test: OK"):console.log(test+" test:KO",menu),console.log("Test completed"),process.exit(0)}class UDE_ideas{parent;dom;ude;ideaFcts={};unfinishedSentence="";currentGPT="";currentId="";constructor(e){this.parent=e,this.dom=e.dom,this.ude=e.ude,API&&API.addFunctions(this,["registerIdeasFunction","getIdeas","fillIdeasBox"])}event(e){"open"==e.event&&(this.currentGPT="",this.currentId="")}registerIdeasFunction(e,t){return void 0===this.ideaFcts[e]?this.ideaFcts[e]=[t]:this.ideaFcts[e].push(t),!0}getIdeas(e,t,s=!1,n){var i=this.dom.element(t);let o=[];i.textContent;let a=this.dom.attr(i,"name");a||(t=this.dom.getSaveableParent(i),a=this.dom.attr(t,"name"));let l=[];var r=this.dom.attr(i,"exTag");l=this.addIdeasFctToList(r,l),a&&(l=this.addIdeasFctToList(a,l));var d=this.dom.keepPermanentClasses(i.className).split(" ");for(let e=0;e<d.length;e++)l=this.addIdeasFctToList(r+"."+d[e],l);if(s)return 0<l.length;for(let t=0;t<l.length;t++){let e=l[t];var u=e.fct(i,e.selector);u&&(o=o.concat(u))}return o}fillIdeasBox(s,e){let o=this.dom.element(s);var n=o?o.previousSibling:null;if(n&&this.dom.element("div.ideasBoxBulma",n)){let e="";e=o.id==this.currentId?this.currentGPT:(this.currentId=o.id,this.currentGPT="",this.unfinishedSentence="");s=this.buildPrompt(o);String.prototype.hashCode=function(){var e,t=0;if(0===this.length)return t;for(e=0;e<this.length;e++)t=(t<<5)-t+this.charCodeAt(e),t|=0;return t};n="textgen_"+(s+"OpenAI").hashCode(),n={provider:"OpenAI",action:"complete",text:o.textContent,prompt:s,cacheTag:n,iterations:10,max_tokens:50,lang:$$$.getLang(o).toLowerCase(),engine:"gpt-neo-20b",dataSource:"gentext",dataTarget:"UD_spare"};let t=$$$.servicePromise("textgen",n);t.then(()=>{let t="";console.log("Handling prompt 0");let e=$$$.json.parse($$$.dom.element("UD_spare").textContent);this.currentGPT+=e.join("");let s=this.buildIdeas(e);for(let e=0;e<s.length;e++){var n=s[e].replace(/\'/g,"\\'");t+='<a class="idea" onclick="'+("$$$.insertTextAtCursor( '"+n+"');")+'">'+s[e]+"</a>"}var i=o?o.previousSibling:null;if(i){let e=this.dom.element("div.ideasBoxBulma",i);e.textContent.length<20&&(e.innerHTML=""),e.innerHTML+=t}})}}isCode(e){if(-1<e.indexOf("<?")||-1<e.indexOf("?>"))return!0;if((e.match(/\$/g)||[]).length>e.length/100)return!0;var t=new RegExp("\\([^\\)]*\\)/","g");return(e.match(t)||[]).length>e.length/100}buildIdeas(e){let o=[];for(;0<e.length;e++){let s=e[0].split(".");this.unfinishedSentence&&(s[0]=this.unfinishedSentence+s[0],this.unfinishedSentence=""),"."!=e[e.length-1]&&(this.unfinishedSentence=s.pop());let n=!1,i=!1;for(let t=0;t<s.length;t++){let e=s[t].trim();e&&(isNaN(e)?e.length<3||-1<e.indexOf("http")||-1<e.indexOf("more info")||-1<e.indexOf("download")||-1<e.indexOf("<|endoftext|>")||this.isCode(e)||(i?(n&&o.push(e+".<br>"),n=!1):o.push(e+".<br>")):(n=!0,i=!0))}}return o}addIdeasFctToList(t,s){let n=s.map(e=>e.fct.name);if(void 0!==this.ideaFcts[t]){var i=this.ideaFcts[t];for(let e=0;e<i.length;e++){var o=i[e];-1==n.indexOf(o.name)&&s.push({selector:t,fct:o})}}return s}buildPrompt(e,t){let s="";var n,i=this.getModelPrompts(e)[0];return s=i?(n={topic:this.getTopic(e),audience:this.getAudience(e)},this.ude.calc.substitute(i,n)):e.textContent,s+=this.currentGPT,s}getModelPrompts(e){let s=e,t=10;for(;s&&s!=this.dom.topElement&&t--;){var n=this.dom.keepPermanentClasses(s.className).split(" ");for(let t=0;t<n.length;t++){var i=this.dom.attr(s,"exTag");let e=$$$.getTagOrStyleInfo(i+"."+n[t],"gpt-prompt");if(e=e||$$$.getTagOrStyleInfo(n[t],"gpt-prompt"),e)return e.split("//")}"H1"==s.tagName&&(s=null),s=s.previousElement}return[""]}getTopic(s,e=!0){let n="";if(s.classList.contains("topic")&&(n=s.textContent),!n){var i=this.dom.children(s);for(let t=0;t<i.length;t++){let e=i[t];if(e.classList.contains("topic")){n=e.textContent;break}}}if(!n&&e){let e=s.previousSibling,t=10;for(;!n&&e&&e!=this.dom.topElement&&t--;)n=this.getTopic(e,!1),e=e.previousSibling}return n}getAudience(s,e=!0){let n="";if(s.classList.contains("audience")&&(n=s.textContent),!n){var i=this.dom.children(s);for(let t=0;t<i.length;t++){let e=i[t];if(e.classList.contains("audience")){n=e.textContent;break}}}if(!n&&e){let e=s.previousSibling,t=10;for(;!n&&e&&e!=this.dom.topElement&&t--;)n=this.getAudience(e,!1),e=e.previousSibling}return n}}function UDE_ideas_init(){return"object"==typeof window.MENU?(window.MENU.ideasHandler=new UDE_ideas(window.MENU),window.MENU.ideasHandler):(setTimeout(function(){UDE_ideas_init()},100),null)}if("object"!=typeof process)UDE_ideas_init();else if(module.exports={class:UDE_ideas},void 0===global.JSDOM&&"undefined"==typeof window&&"undefined"==typeof ModuleUnderTest){console.log("Syntax:OK"),console.log("Start of UDE_ideas class test program"),console.log("Setting up browser (client) test environment"),ModuleUnderTest="udeideas";let path="..";const testMod=require(path+"/tests/testenv.js");testMod.load([]);let ud=new UniversalDoc("document",!0,133);const menuMod=require(path+"/ude-view/udemenu.js");let menuManager=menuMod.init(),ideasHandler=UDE_ideas_init(),test="Test 1 calling ideas fct";window.test1=!1;let myFct=function(e){return console.log("MyFct called"),window.test1=!0,[]};ideasHandler.registerIdeasFunction("h2",myFct),ideasHandler.getIdeas("","source_h2a"),testResult(test,window.test1,window.test1),console.log("Test completed"),process.exit()}class UDE_layout{ude;dom;ud;knownHeights={};paginating=!1;constructor(e){this.ude=e,this.dom=e.dom,this.ud=e.dataSource,API&&API.addFunctions(this,["paginate","checkPagination"])}paginate(t){if(!this.paginating){this.paginating=!0;t="string"==typeof t?this.dom.element('[name="'+t+'"]',"document"):t;let r=this.dom.elements("div.page",t),e=0,d=0;for(let l=0;l<r.length;l++){var u=r[l];let a=0;var s=this.dom.attr(u,"ud_pageHeight");if(s?a=e=parseInt(s):e&&(a=lastpageHeight),a){g(u)&&(d=0),a=this.dom.attr(u,"computed_height");var c=u.clientWidth;"border-box"==$$$.dom.attr(u,"computed_boxSizing")&&(a-=this.dom.attr(u,"computed_marginTop")+this.dom.attr(u,"computed_marginBottom"),a-=this.dom.attr(u,"computed_paddingTop")+this.dom.attr(u,"computed_paddingBottom"));let n=0,i=0,o=0;var h=this.dom.children(u);for(let s=0;s<h.length;s++){let e=h[s],t=s<h.length-1?h[s+1].offsetTop-e.offsetTop:e.getBoundingClientRect().height;var m=e.getBoundingClientRect().width,p=e.offsetLeft;if(console.log("zone widths : page, el, left",c,m,p),t>a&&(t=a-10),t<d){if(l<1)return debug({level:1,return:!1},"No previous page to paginate");this.moveToPreviousPage(e,r[l-1],o++),d-=t,i=0}else if(n+t>a||i){if(l>=r.length-1||g(r[l+1])){p=this.addPage(u);if(!p)return debug({level:1,return:this.paginating=!1},"Can't create new page to paginate");l>=r.length-1?r.push(p):r.splice(l+1,0,p)}this.moveToNextPage(e,r[l+1],i++),d=0}else n+=t,d=0}d=a-n}}function g(e){let t=e.id;return-1==t.indexOf("_")||0==t.indexOf("Forced_")}this.paginating=!1}}addPage(e,t){let s=e.parentNode,n=parseInt(this.dom.attr(e,"ude_pageno"))+1,i=[],o=e.nextSibling;for(;o;)i.push(o),o=o.nextSibling;let a=document.createElement("div");a.id="Break_div_client_"+n,a.className="page";if(this.dom.attr(a,"ud_type","page"),this.dom.attr(a,"ude_mode",this.dom.attr(e,"ude_mode")),this.dom.attr(a,"ude_edit",this.dom.attr(e,"ude_edit")),this.dom.attr(a,"ud_fields",this.dom.attr(e,"ud_fields")),this.dom.attr(a,"ude_pageno",n++),this.dom.attr(a,"ud_pageHeight",this.dom.attr(e,"ud_pageHeight")),0==i.length)s.appendChild(a);else{for(let e=0;e<i.length;e++)this.dom.attr(i[e],"ude_pageno",n++);s.insertBefore(a,i[0])}return a}moveToNextPage(e,t,s){let n=this.dom.cursor.fetch(),i="",o=-1;n&&e.contains(n.HTMLelement)?(i=this.dom.getSelector(n.HTMLelement),o=Array.prototype.indexOf.call(n.HTMLelement.childNodes,n.textElement)):n=null;s=t.childNodes[s],s?t.insertBefore(e,s):t.appendChild(e);n&&(n.HTMLelement=doOnload("$$$.dom.element("+i+");"),n.textElement=n.HTMLelement.childNodes[o],this.dom.cursor.set(),this.dom.makeVisible(n.HTMLelement))}moveToPreviousPage(e,t,s){let n=this.dom.cursor.fetch(),i="",o=-1;n&&e.contains(n.HTMLelement)?(i=this.dom.getSelector(n.HTMLelement),o=Array.prototype.indexOf.call(n.HTMLelement.childNodes,n.textElement)):n=null,t.appendChild(e),n&&(n.HTMLelement=doOnload("$$$.dom.element("+i+");"),n.textElement=n.HTMLelement.childNodes[o],this.dom.cursor.set(),this.dom.makeVisible(n.HTMLelement))}checkPagination(t){var s=this.dom.element(t);if(s=this.dom.getSaveableParent(s)){let e=0;var n=s.nextSibling;e=n?n.offsetTop:s.parentNode.scrollHeight;t=e-s.offsetTop,n=this.knownHeights[s.id];void 0===n?this.knownHeights[s.id]=t:t!=n&&this.paginate(API.getView(s))}}toggleViewHeader(){}}"object"!=typeof process||(module.exports={class:UDE_layout},void 0===global.JSDOM&&"undefined"==typeof window&&"undefined"==typeof ModuleUnderTest&&(console.log("Syntax:OK"),console.log("Test completed"),process.exit()));class UDE_menu{minWidthFloater=500;usePanel=!0;floatTO=1e3;ude;dom;ud;box;icons;border=null;floater=null;useSide=!1;elementInSide=null;ticker=0;ticks=0;cursorSave=-1;editElement=null;saveSideBar="";ideasHandler=null;justClosedId=null;constructor(e){this.ude=e,this.dom=e.dom,this.ud=e.dataSource,API&&API.addFunctions(this,["displayMenu","hideMenu","collapse","expand","closeBox","displaySelectionActions","displayCode","displayConfig","displayStyle","displayLayout","displayIdeas","displayCloud","displayCloudWeb","displayCloudConnector","actionTableClick","useActionData","clearCursor","rearmFloaterTO","classChangeInMenu","getName"]);e=this.dom.element("UD_icons");e&&(this.icons=this.dom.udjson.parse(e.textContent)),(window.MENU=this).border=this.dom.element("floating-menu"),this.floater=this.dom.element("fmenu")}collapse(e){API.changeClass("collapsed",e,"collapsed,expanded")}expand(e){API.changeClass("expanded",e,"collapsed,expanded")}display(t,e=0){var s=t?this.dom.element(t):this.dom.cursor.fetch().HTMLelement;if(s){var n=this.dom.getSaveableParent(s);if("off"==API.getEditorAttr(n,"ude_menu"))return!1;if(this.dom.getSaveableParent(this.editElement)==n){if(this.editElement!=s&&this.box){switch(this.box.id){case"_TMPstyle":this.closeZone(this.box),this.position(this.border,n),this.displayStyle(s);break;case"_TMPconfig":this.closeZone(this.box),this.position(this.border,n),this.displayConfig(s)}return this.editElement=this.getEditable(s),!0}}else this.box&&this.closeZone(this.box),this.editElement&&this.hide();let e=this.floater;return e&&s?(this.cursorSave=this.dom.cursor.save(this.cursorSave),this.useSide?(this.saveSideBar=this.floater.innerHTML,this.floater.scrollTo(0,0),e.innerHTML="<h2>Editer un élément</h2>"):(e.innerHTML="",this.position(this.border,s),this.ticker||(this.ticker=setInterval(function(){window.MENU.tick()},100)),this.ticks=0),this.fill(s),this.useSide&&(this.copyElement(s),t="window.MENU.hide();",API.dom.insertElement("span","Annuler",{class:"button",onclick:"window.MENU.hide();",title:"Annuler"},this.floater,!1,!0),t="window.MENU.updateElement('"+s.id+"'); leftColumn.switchDisplayMode();",API.dom.insertElement("span","Valider",{class:"button",onclick:t,title:"Valider"},this.floater,!1,!0),t="window.MENU.hide();leftColumn.switchDisplayMode();",t+="API.insertElement( 'p', '', { class:'undefined'}, 'element.id', true);",t+="API.displayMenu( UDE_lastInsertId)",API.dom.insertElement("span","Insert",{class:"rightButton",onclick:t,title:"Insert"},this.floater,!1,!0),this.floater.classList.add("floating-menu"),this.floater.style.width=window.getComputedStyle(this.floater)["max-width"]),this.editElement=this.getEditable(s),!0):!1}}displayMenu(e,t=null){return this.display(e,t)}tick(){if(this.floater&&"none"!=this.floater.style.display||this.box){var e=this.box?this.floatTO:100;if(this.floater.style.opacity&&!isNaN(this.floater.style.opacity)&&this.floater.style.opacity,!this.useSide&&this.ticks++>e){this.closeBox(!0),this.border.style.opacity=0;let e=this;setTimeout(function(){e.hide()},1e3),clearInterval(this.ticker),this.ticker=0}}}rearmFloaterTO(e=0){this.ticks=-e}getEditable(e,t=0){let s=this.dom.element(e);e=this.dom.getSaveableParent(s);return s.classList.contains("caption")?e:s}click(e,t){e=this.dom.element(e);let s=e;for(;s&&"div.configurator"!=this.dom.attr(s,"exTag")&&"document"!=s.id;)s=s.parentNode;return!("div.configurator"!=this.dom.attr(s,"exTag")||!this.dom.attr(e,"onclick"))}scroll(e){this.border&&"block"==this.border.style.display&&this.editElement&&this.positionBorderTop()}positionBorderTop(){var e=this.dom.element("scroll").scrollTop,t=this.dom.getSaveableParent(this.editElement),s=this.dom.attr(this.floater,"computed_height");let n=t.offsetTop-e-.5*s;t.offsetParent&&(n+=t.offsetParent.offsetTop),this.box&&(n=this.box.offsetTop-e-.5*s),this.border.style.top=n+"px"}clearCursor(){this.cursorSave=-1}hide(){this.useSide?(this.floater.style.width="0px",this.floater.classList.remove("floating-menu"),this.saveSideBar&&(this.floater.innerHTML=this.saveSideBar),this.saveSideBar=""):this.border&&(this.border.style.display="none",this.editElement&&this.editElement.classList.contains("edinside")&&(this.editElement.classList.remove("edinside"),this.editElement.parentNode.classList.remove("edcontainer"))),this.box&&(this.closeZone(this.box,!0),this.box=null),"_TMPconfig"==this.justClosedId&&this.ude.dispatchEvent({event:"configure",type:"configure",action:"leave"},this.editElement),this.editElement=null}hideMenu(){return this.hide()}position(s,n){if(s=s||this.border,n){let t=this.dom.getSaveableParent(n);if(t){var i=t.getBoundingClientRect(),n=this.dom.attr(this.floater,"computed_height");let e=t.offsetTop-this.dom.element("scroll").scrollTop-.5*n;t.offsetParent&&(e+=t.offsetParent.offsetTop),s.style.top=e+"px",s.style.left=t.offsetLeft-10+"px",s.style.width=i.width+20+"px",s.style.height=i.height+20+"px",s.style.display="block",s.style.opacity=1}}else s.style.display="none",this.floaterActionPending&&API.closeBox(),this.editElement=null}updatePosition(e){e&&e==this.editElement&&this.position(this.border,e)}addButton(e,t,s,n,i=""){var o=this.useSide?"tool-icon":"FMicon";if(o+=" "+t+" button is-small "+s,i){let t="";if(-1<i.indexOf("/"))0==i.indexOf("resources")&&"undefined"!=typeof UDincludePath&&(i=UDincludePath+i),t=i;else{s=API.dom.element("UD_icons");if(!s)return null;let e=API.dom.udjson.parse(s.textContent);t=e[i].replace("W15H15","W50H50")}return API.dom.insertElement("img","",{src:t,class:o,onclick:n,title:e},this.floater,!1,!0)}return API.dom.insertElement("span",e,{class:o,onclick:n,title:e},this.floater,!1,!0)}copyElement(e){let t=this.dom.element("MenuCopy");return t||(t=document.createElement("div"),t.id="MenuCopy"),t.innerHTML=e.innerHTML,this.dom.attr(t,"contenteditable","true"),this.floater.appendChild(t),this.elementInSide=t,t}updateElement(e){var t=this.dom.element("MenuCopy");let s=this.dom.element(e);return s.innerHTML!=t.innerHTML&&(s.innerHTML=t.innerHTML,API.setChanged(s)),t}fill(i){let e=this.dom.element(i),o=this.dom.getEditableParent(e),a=this.dom.getSaveableParent(e);if(a&&o&&this.floater){var l=this.dom.getSelector(o);let e=null,t=$$$.availableClasses(o),s=t.filter(e=>o.classList.contains(e));s=s.length?s[0]:"";this.getLabel(s);let n=API.dom.attr(o,"exTagType");this.getLabel(n);var r=this.floater;{let e="$$$.displayStyle("+l+");";i=this.dom.attr(o,"exTag");-1<["div.html","div.filledZone","div.zoneToFill"].indexOf(i)&&(e="$$$.displayCode("+l+");"),this.addButton("panel","centered","on",e,"resources/images/arrow-split-horizontal.png")}l="API.removeElement("+l+");API.dom.element( 'floating-menu').style.display='none'; window.ud.ude.editElement=null;",API.translateTerm("delete");this.addButton("effacer","right pos1","off",l,"resources/images/delete-variant.png");API.translateTerm("move");return e=this.addButton("effacer","right pos2","off","","resources/images/arrow-all.png"),this.dom.attr(e,"ondragstart","window.ude.dataActionEvent(event);"),this.dom.attr(e,"draggable","true"),e.id="move"+a.id,r}}panelOnSelection(e){var t=this.dom.element(e),s="panel-on-selection";t.id,this.dom.childElements(t).length;let n={style:{tag:"a",onclick:"$$$.dom.styleSelection( null, 'styled', id);$$$.displayStyle( '');",value:"Style"},button:{tag:"a",onclick:"$$$.dom.styleSelection( null, 'button', id);$$$.clickOn( '');",value:"Action"},field:{tag:"a",onclick:"$$$.dom.styleSelection( null, 'field', id);$$$.clickOn( '');",value:"Champ"},link:{tag:"a",onclick:"$$$.dom.styleSelection( null, 'link', id);$$$.clickOn( '');",value:"Lien"},image:{tag:"a",onclick:"$$$.dom.styleSelection( null, 'image', id);$$$.clickOn( '');",value:"Image"}};t={tag:"div",class:"panel-tabs",value:n},t=API.json.putElement({tag:"div",type:"configurator",class:"panel ",name:s,edit:"off",value:{heading:{tag:"p",class:"panel-heading",onclick:"API.closeBox();",value:"Actions sur une sélection"},tabs:t}},!1);if("object"==typeof process)return t.innerHTML;this.addActionBox(e,s,s,t)}displaySelectionActions(e){return this.panelOnSelection(e)}fillForSelection(e){return this.panelOnSelection(e)}addZone(n,i=null){if(!this.border)return debug({level:1,return:!1},"floatConfig() can't add config as there is no border");if(i){let e=this.border,t=this.dom.element(i);this.usePanel&&(e.style.display="none",t.classList.add("menu-on")),n=t.parentNode.insertBefore(n,t);var o=this.dom.attr(t,"computed_marginTop"),a=this.dom.attr(e,"computed_height"),l=this.dom.attr(n,"computed_height");n.style.marginTop=o+"px",n.style.width=this.dom.attr(t,"computed_width")-5+"px",n.style.marginLeft=this.dom.attr(t,"computed_marginLeft")+"px";i=t.offsetTop-n.offsetTop;if(e.style.height=a+i-o/2+"px",this.cursorSave=this.dom.cursor.save(this.cursorSave),this.box=n,window.innerWidth>this.minWidthFloater){let e=this.dom.element(".panel-block-holder",n);e&&(e.classList.add("panel-block"),e.classList.remove("panel-block-holder"))}this.dom.attr(this.box,"ude_menu","off"),this.dom.makeVisible(t.previousSibling);let s=t.parentNode;"div.page"==this.dom.attr(s,"exTag")&&(s.style.height=parseInt(this.dom.attr(s,"ud_pageHeight"))+l+"px"),this.useSide||(this.floater.style.display="none")}return!0}closeZone(e,t=!1){this.floater.style.display="block";let s=e.parentNode;var n;"div.page"==this.dom.attr(s,"exTag")&&(s.style.height=this.dom.attr(s,"ud_pageHeight")+"px"),this.editElement&&!this.useSide&&(n=this.editElement.getBoundingClientRect(),this.border.style.height=n.height+20+"px"),e.remove(),this.box=null,t&&this.cursorSave&&this.dom.cursor.restore(this.cursorSave,!0),this.usePanel&&this.editElement&&(this.border.style.display="block",this.editElement.classList.remove("menu-on"))}addActionBox(t,s,n,i="",e){var o=this.dom.element(t),t=this.dom.getSaveableParent(o);if(this.actionElement=o,this.dom.element(s)&&(this.closeZone(this.dom.element(s)),this.ude.floaterActionPending=null,this.box=null),i){this.closeBox();let e=null;e="object"==typeof i&&void 0!==i.tagName?i:this.dom.prepareToInsert("div",i,{id:s,class:"actionBox "+n,type:"configurator",ude_stage:"on",ude_bind:"next"}),this.useSide&&this.elementInSide?this.floater.insertBefore(e,this.elementInSide):this.addZone(e,t),this.box=e,window.innerWidth<this.minWidthFloater&&(this.box.focus(),this.dom.makeVisible(s,"scroll","top")),"_TMPconfig"==s&&this.ude.dispatchEvent({event:"configure",type:"configure",action:"enter"},t)}else this.dom.cursor.restore(this.cursorSave,!0)}useActionData(n,e){var i=API.dom.element(n),e=API.dom.element(e);let o=e?e.value:"";if(o){e=API.json.parse(o);!e||(a=this.findAndUseModel(e))&&(e=i.nextSibling,API.changeTag("div.filledZone",e.id),o=a),"_TMPwebextract_config"==n&&parseInt(API.dom.attr(i,"udc_step"))<5&&(o="https://"+o),this.dom.cursor.restore(this.cursorSave,!0);let s=this.ude.dispatchEvent({event:"use",type:"use",data:o},this.actionElement);if(!s){let e=this.dom.cursor.HTMLelement,t=this.dom.getSaveableParent(e);var a=t.getBoundingClientRect(),n=a.height,i=this.dom.isHTML(o);this.dom.hasDefaultContent(e)?e.textContent=o:i?this.ude.insertHTMLatCursor(o):this.ude.insertTextAtCursor(o);i=(a=t.getBoundingClientRect()).height;a=this.ude.floater.getBoundingClientRect(),this.ude.floater.style.height=a.height+i-n+"px",this.ude.requires2stageEditing(this.dom.cursor.HTMLelement)||this.ude.setChanged(this.dom.cursor.HTMLelement),s=!0}return this.ticks=0,s}}closeBox(e=!0){this.box&&(this.justClosedId=this.box.id,this.closeZone(this.box,e),"_TMPconfig"==this.justClosedId&&this.ude.dispatchEvent({event:"configure",type:"configure",action:"leave"},this.editElement),this.display(this.editElement))}_getTabs(e,t=""){var s=this.dom.element(e),n=this.dom.getSaveableParent(s),i=this.dom.getSelector(s);let o=$$$.getEditorAttr(n,"ude_menu");e={select:"on"==o||-1<o.indexOf("sel"),config:"on"==o||-1<o.indexOf("config"),styles:"on"==o||-1<o.indexOf("styles"),layouts:"on"==o||-1<o.indexOf("lays"),cloud:"on"==o||-1<o.indexOf("clouds"),ideas:"on"==o||-1<o.indexOf("ideas")};let a={};return e.select&&$$$.dom.cursor.fetch().selectionInNode&&(a.select={tag:"a",onclick:"$$$.displaySelectionActions("+i+");",value:"Select"}),(e.config&&this.displayConfig(s,!0)||"config"==t)&&(a.config={tag:"a",onclick:"$$$.displayConfig("+i+");",value:"Config"}),(e.styles&&this.displayStyle(s,!0)||"styles"==t)&&(a.styles={tag:"a",onclick:"$$$.displayStyle("+i+");",value:"Styles"}),(e.layouts&&this.displayLayout(s,!0)||"layouts"==t)&&(a.layouts={tag:"a",onclick:"$$$.displayLayout("+i+");",value:"Dispositions"}),(e.cloud&&this.displayCloud(s,!0)||"cloud"==t)&&(a.cloud={tag:"a",onclick:"$$$.displayCloud("+i+");",value:"Cloud"}),(e.ideas&&this.displayIdeas(s,!0)||"ideas"==t)&&(a.ideas={tag:"a",onclick:"$$$.displayIdeas("+i+");",value:"Idées"}),(-1<["div.zoneToFill","div.html"].indexOf(this.dom.attr(n,"exTag"))||"code"==t)&&this.ude.textEd&&(a.code={tag:"a",onclick:"$$$.displayCode("+i+");",value:"Code"}),t&&(a[t].className="is-active"),{tag:"div",class:"panel-tabs",value:a}}displayCode(e,t=!1,s="_TMPcode",n="styleBox"){var i=e?this.dom.element(e):this.dom.cursor.fetch().HTMLelement,e=this.dom.getSaveableParent(i);if(!i||!e)return!1;if(t)return!1;i=this.dom.getEditableParent(i),$$$.HTMLeditor(e.id),this.rearmFloaterTO(e.id);t=API.dom.getSelector(i);let o={};o.upload={tag:"a",class:"panel-block",onclick:"$$$.setChanged("+t+");",title:"update",value:"update"},o.restore={tag:"a",class:"panel-block",onclick:"$$$.initialiseElement("+t+");",title:"restore",value:"restore"};i={tag:"div",type:"configurator",class:"panel "+n,name:s,edit:"off",value:{heading:{tag:"p",class:"panel-heading",onclick:"API.closeBox();",value:"Code"},tabs:this._getTabs(i,"code"),styles:{tag:"p",class:"panel-block-holder is-wrapped",value:o}}},i=API.json.putElement(i,!1);if(-1<["div.zoneToFill","div.html"].indexOf(this.dom.attr(e,"exTag"))&&$$$.HTMLeditor('"+saveable.id+"'),"object"==typeof process)return i.innerHTML;this.addActionBox(e,s,n,i)}displayStyle(e,t=!1,s="_TMPstyle",n="styleBox"){var o=e?this.dom.element(e):this.dom.cursor.fetch().HTMLelement,e=this.dom.getSaveableParent(o);if(!o||!e)return!1;if(t)return!0;var o=this.dom.getEditableParent(o),a=API.dom.getSelector(o);let l=$$$.availableClasses(o);var r=l.join(",");let d={},u=o.classList;for(let i=0;i<l.length;i++){var c=l[i],h=$$$.getStyleLabel(c,o);let e=$$$.translateTerm("add")+" "+h,t="panel-block",s="$$$.classChangeInMenu( '"+c+"', "+a+", '"+r+"');$$$.closeBox();",n=h;u.contains(c)&&(t+=" is-active",n=[{tag:"span",class:"panel-icon",value:{tag:"i",class:"fa fa-thumbs-up"}},{value:n}],e=API.translateTerm("remove")+" "+h,s=s.replace("closeBox();","displayStyle( '"+o.id+"');")),d[h]={tag:"a",class:t,onclick:s,title:e,value:n}}t={tag:"div",type:"configurator",class:"panel "+n,name:s,edit:"off",value:{heading:{tag:"p",class:"panel-heading",onclick:"API.closeBox();",value:"Styles"},tabs:this._getTabs(o,"styles"),styles:{tag:"p",class:"panel-block-holder is-wrapped",value:d}}},t=API.json.putElement(t,!1);if("object"==typeof process)return t.innerHTML;this.addActionBox(e,s,n,t)}displayLayout(e,t=!1,s="_TMPstyle",n="styleBox"){var r=e?this.dom.element(e):this.dom.cursor.fetch().HTMLelement,i=this.dom.getSaveableParent(r);if(r&&i){var r=this.dom.getEditableParent(r),d=this.dom.getSelector(r),e=0<this.dom.elements("*",r).length;if(t&&!e)return!1;let o={},a=r.classList,l=$$$.availableLayouts(r);if(t)return 0<l.length;var u=l.join(",");for(let i=0;i<l.length;i++){var c=l[i],h=$$$.getStyleLabel(c,r);let e=$$$.translateTerm("add")+" "+h,t="panel-block",s="$$$.classChangeInMenu( '"+c+"', "+d+", '"+u+"');API.closeBox();",n=h;a.contains(c)&&(t+=" is-active",n=[{tag:"span",class:"panel-icon",value:{tag:"i",class:"fa fa-thumbs-up"}},{value:n}],e=$$$.translateTerm("remove")+" "+h,s=s.replace("closeBox();","displayLayout( '"+r.id+"');")),o[h]={tag:"a",class:t,onclick:s,title:e,value:n}}t={tag:"div",type:"configurator",class:"panel "+n,name:s,edit:"off",value:{heading:{tag:"p",onclick:"API.closeBox();",class:"panel-heading",value:"Dispositions"},tabs:this._getTabs(r,"layouts"),layouts:{tag:"p",class:"panel-block-holder",value:o}}},t=API.json.putElement(t,!1);if("object"==typeof process)return t.innerHTML;this.addActionBox(i,s,n,t)}}displayConfig(u,c=!1,h="_TMPconfig",m="configBox"){let p=this.dom.element(u);var g=this.dom.getSaveableParent(p);if(p&&g){var u=this.dom.getEditableParent(p),f=API.dom.getSelector(p);let o=this.dom.attr(p,"exTagType");if(c)return-1<this.dom.textContent("UD_mode").indexOf("edit")||"p.undefined"==o||-1<["data","style","program"].indexOf(this.dom.getViewType(p))||$$$.getEditorAttr(p,"fromModel");var v=o.split(".");this.dom.element(h)&&this.closeBox();let{name:e,placeholder:t}=this.getName(u),a=$$$.availableTags(u);p!=g&&(a=API.availableTagsForSelection(g));var b=p.classList.contains("undefined");let l={systemLabel:{tag:"span",class:"label",value:API.translateTerm("Element type & sub-type :")}},r={},d="";c=this.getLabel(o);for(let i=0;i<a.length;i++){let e=a[i];var x=this.getLabel(e);let t=e.split(".");var y=t.slice(0,2).join("."),T=2<t.length?t[2]:"";let s="button",n="";if(b){if(void 0!==l[x])continue;n="let el = API.changeTag( '"+y+"', "+f+", '"+T+"');"}else if(e==o)s+=" rightButton",d=3==t.length?(n="API.changeTag( '"+y+"', "+f+");API.displayConfig( '"+p.id+"');","is-active"):(n="API.changeTag( 'p.undefined', "+f+");API.displayConfig( '"+p.id+"');"," is-active");else{if(2!=v.length||t[1]!=v[1])continue;n="API.changeSubType( '"+T+"', "+f+"); API.closeBox();"}T=x;l[x]={tag:"span",class:s,onclick:n,title:x,value:x},r[x]={tag:"a",class:"panel-block"+d,onclick:n,title:x,value:T}}let s="";s+='<span class="label">Options: </span>';u=this.ude.calc.attrPath(f,"ude_edit");s+=$$$.calculate("switchTag( "+u+", 'configSwitch', 'editable', 'CFG_editable');");let n={systemLabel:{tag:"span",class:"label",value:API.translateTerm("Tools :")}};if("div.part"==this.dom.attr(p,"exTag")&&-1<[" EN"," FR"].indexOf(e.substring(e.length-3))){u=API.dom.getView(p);let e=API.dom.attr(u,"name");var E,u=e.replace(" TBC","").replace(" FR","").replace(" EN","");u!=e&&$$$.dom.elementByName(u)&&(E=this.getLabel("Copy original"),u="API.copyElements( '"+u+"', '"+e+"');",n[c]={tag:"span",class:"button",onclick:u,title:E,value:E})}"div.image"==o&&-1<p.innerHTML.indexOf("shutterstock")&&($$$.dom.element("img",p).src,E="$$$.licenseImage( '"+p.id+"');",w=this.getLabel("License"),n.license={tag:"span",class:"button",onclick:E,title:w,value:w});let i={};p!=g&&(i={tag:"span",class:"parentLink",value:{tag:"a",onclick:"API.hideMenu(); API.displayMenu( '"+g.id+"');API.displayConfig('"+g.id+"');",value:" parent"}});var w={tag:"div",type:"configurator",class:"actionBox "+m,name:h,value:{name:{tag:"div",class:"nameEdit",value:[{tag:"a",onclick:"API.closeBox();",class:"actionIcon",value:{tag:"img",src:this.icons.Config}},{tag:"span",class:"firstlabel",edit:"off",value:API.translateTerm("Element name :")},{tag:"span",class:"objectName",stage:"on",placeholder:t,valid:"if ( API.changeName( "+f+")) API.closeBox();",value:e},i]},tags:{tag:"div",class:"tagSelect",value:l},flags:{tag:"div",class:"flagControl",value:s},actions:{tag:"div",class:"actionSelect",value:n}}},g=API.json.putElement(w,!1);this.dom.attr(g,"contenteditable","false"),this.dom.attr(this.dom.element("span.objectName",g),"contenteditable","true"),r.name={tag:"p",class:"panel-block",value:{tag:"span",class:"objectName",stage:"on",placeholder:t,valid:"if ( API.changeName( "+f+")) API.closeBox();",value:e},parentLink:i},n.systemLabel="";w={tag:"div",type:"configurator",class:"panel",name:h,edit:"off",value:{heading:{tag:"p",onclick:"API.closeBox();",class:"panel-heading",value:"Configuration"},tabs:this._getTabs(p,"config"),config:{tag:"div",value:{tags:{tag:"div",class:"panel-block-holder",value:r},flags:{tag:"div",class:"flagControl",value:s},actions:{tag:"div",class:"actionSelect",value:n}}}}},g=API.json.putElement(w,!1);return this.addActionBox(p,h,m,g),g.innerHTML}}getName(t,s=!1){let n=this.dom.attr(t,"name"),i="";if(!n){let e=this.dom.attr(t,"ud_type");e&&void 0!==window.udparams["AutoIndex_"+e]||(e="element");t=window.udparams["AutoIndex_"+e];n=API.translateTerm(e)+"_"+t,i=n,s&&window.udparams["AutoIndex_"+e]++}return{name:n,placeholder:i}}displayCloud(e,n=!1){var i=this.dom.element(e);if(i){var o="_TMPwebextract",a="webBox",l=window.ud.ude.modules[UD_moduleLabels.siteExtract],l="object"==typeof l?l.instance:null,r=API.dom.elements("div.connector",API.dom.element("document"));let t='<a href="javascript:" onclick="API.closeBox();"><img src="'+this.icons.Cloud+'"/></a>';t+='<span class="boxLabel">Choisir la source : </span>';let s="";var d=API.dom.getSelector(i);if(l){if(n)return!0;var u="API.displayCloudWeb("+d+");";t+='<span class="cloud-source" onclick="'+u+'">Web</span>',s+='<span class="cloud-source" onclick="'+u+'">Web</span>'}for(let e=0;e<r.length;e++){if(n)return!0;var c=API.dom.attr(r[e],"name"),h="API.displayCloudConnector("+d+", '"+c+"');";t+='<span class="cloud-source" onclick="'+h+'">'+c+"</span>",s+='<span class="cloud-source" onclick="'+h+'">'+c+"</span>"}if(n)return!1;l=this.dom.prepareToInsert("div",t,{id:o,class:"actionBox "+a,type:"connector",ude_stage:"on",ude_bind:"next"}),u={tag:"div",type:"configurator",class:"panel "+a,name:o,edit:"off",value:{heading:{tag:"p",class:"panel-heading",onclick:"API.closeBox();",value:"Récupérer du cloud"},tabs:this._getTabs(i,"cloud"),content:{tag:"div",name:"_TMP_CLOUDcontent",value:s}}},l=API.json.putElement(u,!1);return"object"==typeof process?t:(this.addActionBox(i,o,a,l),r.length?void 0:this.displayCloudWeb(e))}}displayCloudWeb(i){var o=this.dom.element(i);if(o){var a="_TMPwebextract",l=window.ud.ude.modules[UD_moduleLabels.siteExtract];let n="object"==typeof l?l.instance:null;if(n){i=API.dom.element(a);let e=$$$.dom.element("_TMP_CLOUDcontent"),t=!1;e?e.innerHTML="":(e=this.dom.prepareToInsert("div","",{id:a,class:"webBox",type:"connector",ude_stage:"on",ude_bind:"next"}),t=!0),this.dom.attr(i,"contenteditable","false");var r=this.dom.children(o);let s="";for(let e=0;e<r.length;e++){var d=r[e];if("a"==this.dom.attr(d,"exTag")&&this.dom.attr(d,"href")){s=this.dom.attr(d,"href");break}}if(s&&(l=API.translateTerm("current link")+" is "+s+".",API.dom.insertElement("span",l,{},i,UD_after,UD_inside),API.dom.insertElement("span",API.translateTerm("follow"),{ude_ui:"on",class:"button",onclick:"window.open('"+s+"');"},i,UD_after,UD_inside)),n.buildConfigZone2(e),"object"==typeof process||!t)return this.dom.cursor.setAt(this.box),content;this.addActionBox(o,a,"webBox",i),this.dom.cursor.setAt(this.box)}}}displayCloudConnector(o,a){var l=this.dom.element(o);if(l){var r="_TMPwebextract";let i=API.dom.element(a);if(i){let e=API.dom.element(r),t=!1;e?e.innerHTML="":(e=this.dom.prepareToInsert("div","",{id:r,class:"webBox",type:"connector",ude_stage:"on",ude_bind:"next"}),t=!0),API.dom.insertElement("a",'<img src="'+this.icons.Cloud+'"/>',{href:"javascript:",class:"actionIcon",onclick:"API.closeBox();"},e,!1,!0);o={id:"_TMPwebPrompt",class:"webPrompt",edit:"off"};API.dom.insertElement("span","Cliquer sur une cellule",o,e,!1,!0);o={id:"_TMPwebInput",class:"webInput",type:"text"},a=API.dom.insertElement("input","",o,e,!1,!0);o={id:"_TMPwebUse",class:"button",onclick:"API.useActionData( '"+r+"', '"+a.id+"');"},API.dom.insertElement("span",API.translateTerm("Use"),o,e,!1,!0);let s=i.cloneNode(!0);s.id="TMP_"+s.id;let n=API.dom.element("tbody",s);API.dom.element("thead",s);o=92;if(n.style.height=API.dom.attr(e,"computed_height")-92+"px",API.dom.attr(s,"onclick","API.actionTableClick( event, '"+a.id+"');"),e.appendChild(s),"object"==typeof process||!t)return content;this.addActionBox(l,r,"webBox",e),o=22+API.dom.attr("head","computed_height")+20,n.style.height=API.dom.attr(e,"computed_height")-o+"px"}}}actionTableClick(s,e){let n=API.dom.element(e);if(n){e=s.target,s=API.dom.attr(e,"exTag");if("td"==s){var i=e.parentNode;if(e==i.cells[0]){let e=i.parentNode.childNodes,t=1;for(;t<=e.length&&e[t-1]!=i;)t++;s=API.getRow(i.parentNode.parentNode.id,t);n.value=JSON.stringify(s),t&&e[t-1].classList.add("selected")}else n.value=e.textContent}}}actionParamGet(){}actionParamSet(){}displayIdeas(u,c=!1){let h=this.dom.element(u);if(h){var m="_TMPideas",p="ideasBox";let n=this.dom.udjson.value;let a="",i='<a href="javascript:" class="actionIcon" onclick="API.closeBox();"><img src="'+this.icons.Idea+'"/></a>',l="";var g=API.getEditorAttr(h,"data-ude-datasrc");if(g){if(c)return!0;let n=g;u=doOnload("("+this.dom.getSelector(h)+")");if("object"==typeof u){let e=u.parent;n={child:u.child,tag:u.tag,parent:e};let t="parent/",s=5;for(;e&&"string"!=typeof e&&s--;)e=e.parent,t+="parent/";e&&(t=t.substring(0,t.length-1),f=this.dom.element(e).tagName.toLowerCase(),f=this.dom.element(f,this.dom.element(g)),n=this.dom.udjson.valueByPath(n,t,f.id))}var f=this.dom.element(n);if(!f)return debug({level:1,return:null},"Error datasrc attribute in "+h.id+"not found "+n);l=f.innerHTML;let e=this.dom.attr(this.dom.getView(g),"ud_lang");e=e||"EN";f=this.dom.getView(h);let t=this.dom.attr(f,"name"),s=this.dom.attr(f,"ud_lang");s=s||t.substring(t.length-2);f={action:"translate",source:e.toLowerCase(),target:s.toLowerCase(),text:l,dataTarget:"UD_spare",dataSource:"translation"},API.service("GoogleTranslate",f);let i=$$$.servicePromise("GoogleTranslate",f);i.then(()=>{var e="";e+='<a class="idea" onclick="$$$.replaceTextAtCursor( this.textContent);">'+$$$.dom.element("UD_spare").textContent+"</a>";let t=$$$.dom.element("_TMP_IDEAScontent");t.innerHTML=e});let o="";f={tag:"div",type:"configurator",class:"panel",name:m,edit:"off",value:{heading:{tag:"p",class:"panel-heading",onclick:"API.closeBox();",value:"Idées"},tabs:this._getTabs(h,"ideas"),content:{tag:"div",name:"_TMP_IDEAScontent",class:p+"Bulma",value:a}}};return o=API.json.putElement(f,!1),"object"!=typeof process?void this.addActionBox(h,m,p,o):o.textContent}f=this.dom.attr(h,"exTag");let o=[],r={},d={element:"",sectionBefore:"",sectionAfter:"",view:""};{let e=this.dom.elementByName("_KEYWORDS");r.model=e?e.textContent.split(","):[];let l=function(e,s){let n=[];var i=function(t){let s=[],n="";for(let e=0;e<t.length;e++){var i=t[e];-1<" .,;?!-_".indexOf(i)?(n&&s.push(n),n=""):n+=""+i}return n&&s.push(n),s}(e);for(let t=0;t<i.length;t++){let e=i[t];var o,a=e.indexOf("[");-1<a&&(o=e.substr(a+1,e.indexOf("]")-a-1),e=e.substr(0,a),void 0===s[o]&&(s[o]=[]),s[o].push(e)),e=window.ud.ude.calc.removeAccentsAndLower(e),a=e,o=void 0,o=API.dom.element("UD_lang").textContent,!a.trim()||-1<UD_insignificantWords[o].indexOf(a)||n.push(e)}return n};r.element=l(h.textContent,r),d.element=h.textContent,r.section=[];let t=h,s=3;for(;(t=t.previousSibling)&&s--;)r.section=r.section.concat(l(t.textContent,r)),d.sectionBefore+=t.textContent+" ";for(t=h,s=3;(t=t.nextSibling)&&s--;)r.section=r.section.concat(l(t.textContent,r)),d.sectionAfter+=t.textContent+" ";if(r.view=[],"div.image"==f){if(c)return!0;i+=API.getImagePicker(h,"API.closeBox();",r),a+=API.getImagePicker(h,"API.closeBox();",r)}else{if(this.ideasHandler)return c||this.dom.element(m)||(C={tag:"div",type:"configurator",class:"panel",name:m,edit:"off",value:{heading:{tag:"p",class:"panel-heading",onclick:"API.closeBox();",value:"Idées"},tabs:this._getTabs(h,"ideas"),content:{tag:"div",name:"_TMP_IDEAScontent",class:p+"Bulma",value:$$$.translateTerm("Searching ideas")}}},i=API.json.putElement(C,!1),"object"!=typeof process&&this.addActionBox(h,m,p,i),this.ideasHandler.event({event:"open"})),c?this.ideasHandler.getIdeas(r,h,c):void(o=this.ideasHandler.getIdeas(r,h));{var v=this.dom.attr(h,"exTag");let e=this.dom.element("[name='Ideas']",this.dom.element("document"));e=e||this.dom.element("[name='Models']",this.dom.element("document"));let s=this.dom.element("h2",e)?API.grabPortion():API.dom.unpagedChildElements(e);for(let e=0;e<s.length;e++){var b=s[e];let t="object"==typeof b?b.innerHTML:b;if(-1<t.indexOf("{verb}")){var x=n(r,"verb"),y=n(r,"noun"),T=n(r,"article");for(let e=0;e<x.length;e++){var E=x[e];for(let e=0;e<y.length;e++){var w=y[e],_=T[e],w=t.replace("{verb}",E).replace("{article}",_).replace("{noun}",w);s.push(w)}}}else("string"==typeof b||this.dom.attr(b,"exTag")==v&&function(e,t){if(!e)return!0;var s=e.split(" ");for(let e=0;e<s.length;e++)if(t.classList.contains(s[e]))return!0;return!1}(b.className,h))&&function(e,t){var s=l(e);let n=0,i=[];for(let e=0;e<s.length;e++){var o=s[e],a=n;-1<t.model.indexOf(o)?n+=3:-1<t.element.indexOf(o)?n+=10:-1<t.section.indexOf(o)?n+=6:-1<t.view.indexOf(o)&&(n+=3),n>a&&i.push(o)}return 6<n}(t,r)&&-1==o.indexOf(t)&&-1==h.textContent.indexOf(t)&&o.push(t)}}}}var C=this.dom.getSelector(h),C="API.dispatchEditEvent( "+("{ event:'idea', type:'idea', data: '"+h.textContent.replace(/\'/g,"\\'")+"'};")+", "+C+");";if(l&&(i+='<div id="_TMP_ideas_original" class="textExpand">',i+=API.translateTerm("Original text")+" : ",i+='<span class="UD_idea" ude_edit="off" onclick="'+C+'">'+l+"</span>",i+="</div>",a+='<a class="panel-block" onclick="'+C+'">'+l+"</a>"),i+='<span class="UD_tip" ude_edit="off">'+API.translateTerm("Click on an idea to add to your text")+"</span><br>",l&&(i+='<div id="_TMP_ideas_translations" class="textExpand">',i+="Google Translate : ",i+='<span name="_TMP_ideas_Google_translate" class="textExpand translation" onclick="'+C+'">Translation comes here</span></div>',a+='<a name="_TMP_ideas_Google_translate" class="panel-block" onclick="'+C+'">Translation comes here/a>'),c)return 0<o.length;for(let e=0;e<o.length;e++){var t=this.dom.getSelector(h),t="API.dispatchEditEvent( "+("{ event:'idea', type:'idea', data: '"+o[e].replace(/\'/g,"\\'")+"'}")+", "+t+");";i+='<span class="UD_idea" ude_edit="off" onclick="'+t+'">'+o[e]+"</span><br>",a+='<a class="panel-block" onclick="'+t+'">'+o[e]+"</a>"}if(c)return 0<o.length;c={tag:"div",type:"configurator",class:"panel",name:m,edit:"off",value:{heading:{tag:"p",class:"panel-heading",onclick:"API.closeBox();",value:"Idées"},tabs:this._getTabs(h,"ideas"),content:{tag:"div",name:"_TMP_IDEAScontent",class:p+"Bulma",value:a}}};if(i=API.json.putElement(c,!1),"object"==typeof process)return i.textContent;this.addActionBox(h,m,p,i)}}find(e){}getLabel(e,t="",s="",n=""){if(!e)return"";let i="";var o=window.lang;let a=null,l=API.json.value;return t&&s&&n&&(a=l(UD_exTagAndClassInfo,"div.part."+s+" ."+n+" "+t+"."+e)),!a&&t&&n&&(a=l(UD_exTagAndClassInfo,"div.part."+n+" "+t+"."+e)),!a&&t&&s&&(a=l(UD_exTagAndClassInfo,"div.part."+s+" "+t+"."+e)),!a&&s&&(a=l(UD_exTagAndClassInfo,"div.part."+s+" "+e)),!a&&t&&(a=l(UD_exTagAndClassInfo,t+"."+e)),a=a||l(UD_exTagAndClassInfo,e),a&&(i="EN"==o?l(a,"label"):l(a,"label_"+o),i=i||API.json.value(a,"label")),i=i||API.translateTerm(e),i=i||e,i}getTagOrStyleLabel(e){return this.getLabel(e)}getIcon(e,t,s="json100"){let n="";window.lang;var i=API.json.value(UD_exTagAndClassInfo,e);return i&&(n=API.json.value(i,"icon")),n?("json100"==s&&(n={tag:"img",class:"LAY_icon",onclick:t,title:this.getLabel(e),src:"/tmp/W24H24_"+n}),n):e}findAndUseModel(e){var t=Object.keys(e),t=this.findModels(t);if(!t.length)return"";t=t[0],t=API.dom.element(t).innerHTML;return API.calc.substitute(t,e)}findModels(i){let o=[];var a=API.dom.elements("div.html","document");for(let n=0;n<a.length;n++){var l=a[n],l=API.dom.attr(l,"name")+"viewZone";let e=API.dom.element(l).innerHTML,t=0,s=0;for(;-1<(t=e.indexOf("{",t));){var r=e.indexOf("}",t);if(r<=0)break;var d=e.substring(t+1,r);-1<i.indexOf(d)&&s++,t=r+1}s>=i.length-3&&o.push(l)}return o}displayViewConfig(e,t){e=API.dom.element('[name="'+e+'"]',"middleColumn");if(!e)return null;this.ude.displayFloatingMenu(e)}classChangeInMenu(e,t,s){let n=$$$.dom.element(t),i=n.className;n.classList.forEach(e=>{(-1<s.indexOf(e)||0==e.indexOf("LAY_"))&&(i=e)}),$$$.changeClass(e,t,s),API.updateContentAfterEvent(n,{eventType:"changeClass",oldClass:i,newClass:e}),this.display(this.dom.getSaveableParent(n)),this.ud.viewEvent("changeClass",n),this.ude.dispatchEvent({event:"classAdded",type:"classAdded",class:e},n)}}function UDE_menu_init(){var e=new UDE_menu(window.ud.ude);return window.ud.ude&&(window.ude.menuManager=e),e}if("object"==typeof process&&(module.exports={class:UDE_menu,init:UDE_menu_init},void 0===global.JSDOM&&"undefined"==typeof window&&"undefined"==typeof ModuleUnderTest)){console.log("Syntax:OK"),console.log("Start of UDE_menu class test program"),console.log("Setting up browser (client) test environment"),ModuleUnderTest="udemenu";let path="..";const testMod=require(path+"/tests/testenv.js");testMod.load([]);let ud=new UniversalDoc("document",!0,133),menuManager=UDE_menu_init();menuManager.icons={Style:"",Config:"",Idea:"",Cloud:""};let modelsViewData={tag:"div",name:"B0A0000000100000M",label:"Models",type:"page",class:"page",value:[{tag:"p",value:"Hello brave world"},{tag:"p",value:"Hello cruel world"},{tag:"p",value:"Totally different"}]},modelsView=API.dom.udjson.putElement(modelsViewData);API.dom.element("document").appendChild(modelsView);{let test="1 - Ideas",elName="B0100000001000000M";ud.dom.cursor.setAt(ud.dom.element(elName));let ideas=menuManager.displayIdeas(elName);testResult(test,-1<ideas.indexOf("cruel"),ideas)}{let test="2 - Config",config=menuManager.displayConfig("B0100000001000000M");testResult(test,-1<config.indexOf("panel"),config)}console.log("Test completed"),process.exit()}class UDE_styleManager{constructor(){}mapStylesOnAll(){for(var e in this.maps){var t=$$$.dom.element("document"),s=$$$.dom.elements("."+e,t);for(let e=0;e<s.length;e++)this.mapStyleOnElement(s[e])}}mapStyleOnElement(e,t="",s){if(newstyle)for(var n in this.map[t])e.classList.add(n)}}"object"==typeof process&&(module.exports={UDE_styleManager:UDE_styleManager},void 0===global.JSDOM&&"undefined"==typeof window&&console.log("Test completed"));class UDEcalc{dom;ude;delimiters=" \n\t=+-*/;,&()'\"";keepDelimiters="=+-*/;,&()'";expr;litteral;quote;autoId=1;cssCalc=null;termCount=0;mathFunctions=["abs","acos","acosh","asin","asinh","atan","atan2","atanh","cbrt","ceil","clz32","cos","cosh","exp","expm1","floor","fround","hypot","imul","log","log10","lop1p","log2","max","min","pow","random","round","sign","sin","sinh","sqrt","tan","tanh","trunc"];cssFunctions=["classesByTag"];tableFunctions=["findRows","findFirstRow","sumsBy","sumsByAK","sumsByAV","sumIf","concatIf","valueList","getRow","tableColumns"];localFunctions=["lookup","ajaxZoneCall","style","if","row","column","datestr","json","imageTag","linkTag","linkJStag","metricTag","multiCalc","checkboxTag","switchTag","switchTagCallback","toggleSwitch","selectorTag","getSingleChoice","textContent2HTML","substitute","buildComposite","buildJSONlist","checkValue","inList","inBetween","listNames","listValues","formatList","removeAccents","item","trim","uppercase","titlecase","orop","oneOf","defaultValue","jsonKeys","api","isName","isDate","array","content","uround","value","textReplace","attrPath"];functions={};dependencies={};toDo=[];lockToDo=!1;constructor(e,t){this.dom=e,this.ude=t,"undefined"==typeof moment&&t&&"undefined"==typeof process&&(window.dayjs=require("dayjs"),window.moment=window.dayjs,window.moment.locale(window.lang.toLowerCase())),"undefined"!=typeof API&&API&&API.addFunctions(this,["redoDependencies","toggleSwitch","if","selectorTag","getSingleChoice","getMultipleChoice"])}addFunctions(t,s){for(let e=0;e<t.length;e++)this.functions[t[e]]=s;return!0}addTokenToExpr(e,t){var s=t;return this.litteral?(this.expr+=e+s,s==this.quote&&(this.litteral=!1)):"'"==s||'"'==s?(this.litteral=!0,this.quote=s,this.expr+=s):(isNaN(e)?s&&"("==s?""==e?this.expr+=s:-1<this.mathFunctions.indexOf(e)?this.expr+="Math."+e:-1<this.localFunctions.indexOf(e)?this.expr+="this."+e:-1<this.tableFunctions.indexOf(e)?this.expr+="this.ude.tableEd."+e:void 0!==this.functions[e]?this.expr+=this.functions[e]:-1<this.cssFunctions.indexOf(e)?this.cssCalc?this.expr+="this.cssCalc."+e:this.expr+="ERR:RETRY LATER":(t=APIreturnType(e),-1<["string","number","boolean"].indexOf(t)?this.expr+="API."+e:this.expr+="ERR:Unknown function or unallowed response type"):(0==e.indexOf("window")?this.expr+=e:this.expr+="this.dom.value('"+e+"')",this.termCount++):this.expr+=e,s&&-1<this.keepDelimiters.indexOf(s)&&(this.expr+=s)),""}prepareForExec(e){var t=this.expr="";this.litteral=!1,this.quote="";for(var s=this.termCount=0;s<e.length;s++){var n=e[s];-1<this.delimiters.indexOf(n)&&(""!=this.expr||"-"!=n&&"+"!=n)?t=this.addTokenToExpr(t,n):t+=n}return t=t&&this.addTokenToExpr(t,null),!0}exec(e,t){return this.eval(e,t)}eval(expr,element){var r;if(debug({level:4},"Computing ",this.expr,expr),!expr||!this.prepareForExec(expr)||-1<this.expr.indexOf("ERR:"))return"ERR";if(expr=expr.replace(/&quot;/g,"'"),!isNaN(this.expr))return this.expr;if("'"==this.expr.charAt(0)&&"'"==this.expr.charAt(this.expr.length-1)&&2==this.expr.match(/'/g).length||'"'==this.expr.charAt(0)&&'"'==this.expr.charAt(this.expr.length-1)&&2==this.expr.match(/\"/g).length)return this.expr.substr(1,this.expr.length-2);try{r=eval(this.expr),debug({level:4},"Computed ",this.expr,expr,r)}catch(error){r="Err",debug({level:0},"ERR eval :",this.expr),console.log(error),2<DEBUG_level&&eval(this.expr)}return r}markToUpdate(e,t=-1,s=!1){this.toDo.push({element:e,index:t,recurrent:s})}updateElement(s,n=0,i=!1){if(s&&this.dom.attr(s,"ude_formula")&&s!=this.ude.editingElement&&!s.classList.contains("stageediting"))if(this.dependencies){debug({level:4},"updating",s.id,n);let t=this.dom.attr(s,"ude_formula");if(t){var o=this.dom.attr(s,"ude_updateaction");let e=!1;"{"==s.textContent.charAt(0)&&(e=!0),DOM_lastAccessedValues=[];var a={home:this.dom.autoHome,index1:this.dom.autoIndex1,index2:this.dom.autoIndex2};if(o&&e)"chart.initialise"===o&&(l=this.dom.getSaveableParent(s),this.ude.initialiseElement(l.id));else{var l=-1<t.indexOf("index.");n&&l?(t=t.replace(/index/g,n),this.dom.attr(s,"ude_formula",t)):t=t.replace(/{index}/g,1);l=this.dom.parentAttr(s,"ude_datasrc");if(this.dom.autoHome=l?this.dom.element(l):s,-1<["td","li"].indexOf(this.dom.attr(s,"exTag"))){let e=1,t=s.parentNode;for(;t=t.previousSibling;)e++;this.dom.autoIndex1=e}window.UDEcalc_element=s;let e=this.exec(t);this.dom.autoIndex1=0,this.dom.autoHome="","..."==e?this.markToUpdate(s,n,i):(s.innerHTML=e,"string"==typeof e&&0==e.indexOf("ERR")?s.classList.add("error"):s.classList.remove("error")),this.dom.elements("table",s).length&&this.dom.arrangeTables(s,!1),window.UDEcalc_element=null}var r,d=DOM_lastAccessedValues;for(r in d){d[r];var u=this.dom.attr(d[r],"id");u||(u="udcalc"+this.autoId++,d[r].id=u),void 0===this.dependencies[u]?this.dependencies[u]=[s]:-1==this.dependencies[u].indexOf(s)&&this.dependencies[u].push(s)}return i&&this.checkDependencies(s),this.dom.autoHome=a.home,this.dom.autoIndex1=a.index1,this.dom.autoIndex2=a.index2,debug({level:4},"updated",s.id,n),!0}}else this.markToUpdate(s,n,i)}do(e){if(!this.lockToDo){this.dependencies||this.initializeDependencies();var t=this.toDo;this.toDo=[];for(var s=0;s<t.length;s++){var n,i,o=t[s];"object"==typeof o&&void 0===o.id?(n=o.index,i=o.recurrent,this.updateElement(o.element,n,i)):(i=(i=this.dom.attr(o,"id"))&&i.split("_"))&&1<i.length?this.updateElement(o,parseInt(i[1])):this.updateElement(o)}}}redoDependencies(){return this.toDo=[],this.initializeDependencies(),!0}initializeDependencies(){this.dependencies=[],this.lockToDo=!0;var e,t=this.dom.topElement.getElementsByTagName("*"),s=[];for(e in this.toDo)"object"==typeof this.toDo[e]?s.push(this.toDo[e].element):s.push(this.toDo[e]);for(var n=t.length-1;0<=n;n--){var i,o=t[n];1!=o.nodeType||!this.dom.attr(o,"ude_formula")||"TD"==o.tagName&&o.parentNode.classList.contains("rowModel")||((i=this.dom.attr(o,"id"))||(i="udcalc"+this.autoId++,o.id=i),-1==s.indexOf(o)&&this.updateElement(o))}this.lockToDo=!1,debug({level:1},"Dependencies",this.dependencies)}checkDependencies(e){void 0===e&&(this.dom.cursor.fetch(),e=this.dom.cursor.HTMLelement);var t,s=[];for(t in this.toDo)"object"==typeof this.toDo[t]?s.push(this.toDo[t].element):s.push(this.toDo[t]);if(this.lockToDo=!0,e&&void 0!==e&&void 0!==this.dependencies[e.id]){var n,i=this.dependencies[e.id];for(n in i){var o=i[n];if(o==e)return o.innerHTML="ERR",void(this.lockToDO=!1);"{"!=o.textContent.charAt(0)&&(o.innerHTML="..."),-1==s.indexOf(o)&&(this.toDo.push(o),this.checkDependencies(o))}}this.lockToDo=!1}lookup(e,t,s,n){return this.dom.createLookupFromTable(e,t,s)[n]}displayOIDcall(e,t,s=""){let n="",i="yes"==window.udAttributes.newWindowOnFiles.toLowerCase();s||(i=!1);let o=t+"/";return i||(o+="AJAX_"),1==e?o+="modelShow/":2!=e&&3!=e||(o+="show/"),n=i&&s?"window.open('webdesk/"+o+"'/, '"+s+"')":"window.ud.udajax.serverRequest( '"+o+'\', \'GET\', null, { zone: "document", action:"fill zone", element:null, ud:window.ud});',n}ajaxUpdateZoneCall(e,t){return"window.ud.udajax.serverRequest( '"+e+"', 'GET', null, { zone: \""+t+'", action:"fill zone", element:null, ud:window.ud});'}ajaxZoneCall(e,t,s,n,i,o,a=""){debug({level:5},"Ajax zone GetValue",e,t,s,i,o);var l=this.dom.value(e+"."+t+".id."+(s="oidChildren"==s?"data-ud-oidchildren":s));let r=this.dom.element("UD_openNewWindow");var d,s=!r||"yes"==r.value.toLowerCase();return-1==l.indexOf("UD|")&&-1<l.indexOf("CD|")&&(l=l.replace("CD","UD|3|CD")),l+="/"+n+"/",a?0==(d=this.dom.value(e+"."+t+".id.textContent"))?"window.ud.udajax.serverRequest( '"+a+'\', \'GET\', null, { zone: "document", action:"fill zone", element:null, ud:window.ud});':"window.open('"+a+"', '"+(o=o.replace("{id}",d))+"')":void 0!==o&&""!=o&&"_"!=o?(d=this.dom.value(e+"."+t+".id.textContent"),o=o.replace("{id}",d),s?"window.open('/webdesk/"+(l=l.replace("AJAX_modelShow","show"))+"', '"+o+"')":"window.ud.udajax.updateZone('"+(l=l.replace("AJAX_modelShow","AJAX_show"))+"','"+i+"');"):"window.ud.udajax.updateZone('"+l+"','"+i+"');"}style(e,t){return'<span class="'+t+'">'+e+"</span>"}row(s=""){if(s){if(isNaN(s)){var e=this.dom.getParentAttribute("table","id",this.dom.autoHome),e=this.ude.tableEd.findFirstRow(e,s);return e||-1}return this.row()+s}{s=this.dom.autoHome;if(!s||"td"!=this.dom.attr(s,"exTag"))return-1;let e=s.parentNode,t=0;for(;e=e.previousElementSibling;)t++;return t+1}}column(t=""){if(!t){var s=this.dom.autoHome,t=s.parentNode;let e=Array.from(t.cells);return e.indexOf(s)+1}}datestr(s,t="",a="",l=!1){var e;dayjs=this.dayjs,this.dayjs||(this.dayjs=dayjs=requirejs("dayjs"),e=requirejs("dayjscdn/plugin/customParseFormat"),d=requirejs("dayjscdn/plugin/relativeTime"),u=requirejs("dayjscdn/plugin/weekOfYear"),requirejs("dayjscdn/locale/fr"),dayjs.extend(e),dayjs.extend(d),dayjs.extend(u),"function"==typeof dayjs.locale&&dayjs.locale(window.lang.toLowerCase()),this.currentDate=null,this.currentWeek=-1);let r=dayjs();if(Array.isArray(t))for(let e=0;e<t.length&&(r=dayjs(s,t[e]),!r.isValid());e++);else r=t?dayjs(s,t):s?dayjs(s,"DD/MM/YYYY hh:mm"):dayjs();if(r.isValid()||t){if(a){let e="";return r.isValid()&&(e=r.format(a)),e}return isNaN(s)?(this.currentDate=r,r):(console.log("date expr is Number :"+s),r=dayjs.unix(s),r.fromNow())}{s=s.trim(),this.currentDate||(this.currentDate=dayjs());let n=this.currentDate;var d=window.lang.toLowerCase();let i={en:["sun","mon","tue","wed","thu","fri","sat","sunw","monw","tuew","wedw","thuw","friw","satw"],fr:["lun","mar","mer","jeu","ven","sam","dim","lunpr","marpr","merpr","jeupr","venpr","sampr","dimpr"]};var u={en:["^today","^tomorrow","^("+i.en.join("|")+") ([0-9]*)h([0-9]*)","^\\+([0-9]*)d","^\\+([0-9]*)h","^([0-9]*)h([0-9]*)","^([0-9]*)h","^week ([0-9]*)","^([0-9][0-9])/([0-9][0-9])/([0-9][0-9][0-9][0-9]) ([0-9][0-9])h([0-9][0-9])","^clear"],fr:["^aujourd'hui","^demain","^("+i.fr.join("|")+") ([0-9]*)h([0-9]*)","^\\+([0-9]*)j","^\\+([0-9]*)h","^([0-9]*)h([0-9]*)","^([0-9]*)h","^semaine ([0-9]*)","^([0-9][0-9])/([0-9][0-9])/([0-9][0-9][0-9][0-9]) ([0-9][0-9])h([0-9][0-9])","^raz"]};let t=u[d],o=null;for(let e=0;e<t.length;e++)if(t[e]){var c=new RegExp(t[e],"i");if(o=s.match(c),o){o[0]=e+1;break}}if(!o&&"en"!=d){t=u.en;for(let e=0;e<t.length;e++)if(t[e]){var h=new RegExp(t[e],"i");if(o=s.match(h),o){o[0]=e+1;break}}}if(o){function m(e){var t=dayjs().week();return n=dayjs(),n=n.startOf("week"),n=t<=e?n.add(7*(e-t),"days"):n.subtract(7*(t-e),"days"),n}switch(o[0]){case 0:break;case 1:n=n.subtract(1,"days"),this.currentDate=n;break;case 2:n=n.add(1,"days"),this.currentDate=n;break;case 3:var p=o[1].toLowerCase();let e=i.fr.indexOf(p),t="fr";if(-1==e&&(e=i.en.indexOf(p),t="en"),-1==e){n=0;break}var g=parseInt(o[2]),p="string"==typeof o[3]?parseInt(o[3]):0;if(0<this.currentWeek&&(n=m(this.currentWeek)),"en"==this.dayjs.locale()&&"fr"==t&&(n=n.add(1,"days")),n=n.add(e,"days").add(g,"hours").add(p,"minutes"),l&&n.isBefore(dayjs())){n=0;break}this.currentDate=n;break;case 4:n=n.add(parseInt(o[1]),"days");break;case 5:n=n.add(parseInt(o[1]),"hours");break;case 6:case 7:var f=o[1]+"h"+(void 0!==o[2]&&o[2]?o[2]:"00");let s=dayjs(f,"h:mm");if(n.isBefore(s))n=s;else{if(l){n=0;break}n=s.add(1,"days")}this.currentDate=n;break;case 8:f=parseInt(o[1]);this.currentWeek=f,this.currentDate=m(f);break;case 9:n=dayjs(new Date(o[3],o[2],o[1],o[4],o[5])),this.currentDate=n;break;case 10:this.currentDate=null}}else n=0;return a=a||"DD/MM/YYYY",r=n&&n.format(a),r}}json(t,e,s=null){if("string"==typeof t){if(""==t)return null;try{var n=JSON.parse(t)}catch(e){return debug({level:2},"Bad JSON",t),null}}else"object"==typeof t&&(n=t);if(!n)return null;for(var i=e.split("/"),o=0;o<i.length;o++)if(!(n=n[i[o]]))return debug({level:1,return:null},"json can't find value in jsonSTring",e,t);return s&&(n[i[o]]=s),n}if(e,t,s){return e?t:s}imageTag(e,t,s,n){let i=document.createElement("img");return i.setAttribute("src",e),i.setAttribute("alt",t),i.style.width=s,i.style.height=n,i.outerHTML}linkTag(e,t,s){let n=document.createElement("a");-1<e.indexOf("/")?n.href=e:$$$.dom.attr(n,"onclick",e.replace("&quot;",'"')),n.target=t;s=document.createTextNode(s);return n.appendChild(s),n.outerHTML}linkJStag(e,t,s){let n=document.createElement("a");n.href="javascript:",n.target=t,e&&""!=e?n.setAttribute("onclick",e):n.setAttribute("onclick","alert('En cours de développement');"),n.setAttribute("contenteditable","false");s=document.createTextNode(s);return n.appendChild(s),n.outerHTML}checkboxTag(e,t="",s="",n=""){let i="";i+="if (this.checked) this.value='yes'; else this.value='no';",s&&(i+="window.ud.ude.updateTable('"+s+"');");let o='<input id="'+t+'" type="checkbox" onchange="'+i+'"';return e||"string"==typeof e&&"yes"==e.toLowerCase()?o+=' checked value="yes"':o+='value="no"',o+=" />"+n,o}switchTag(e,t="UDswitch",s="",n="myVal1"){var i=this.dom.domvalue.value(e);let o="";o+='<span class="label">'+s+"</span>",o+='<span class="'+t+'">',o+='<input type="checkbox" id="'+n+'" value="'+i+'"',i&&(o+=" checked"),o+=">",o+='<label for="'+n+'" class="'+("on"==i?"on":"off")+'" onclick="API.toggleSwitch(this);" ude_bind="'+e+'">',o+='<span class="switch"></span>',o+="</label>";let a=this.eval("classesByTag( 'span.' + switchClass);");return-1<a.indexOf("ERR")?0:a||(t="span."+t,a="",a+=t+"{ display:block; float:right;}\n",a+=t+" input { display:none;}\n",a+=t+" label { background-color :blue; position:relative; width:36px; height:20px; border-radius:20px;display:block;}\n",a+=t+" label.off { background-color :gray; position:relative; width:36px; height:20px; border-radius:20px;display:block;}\n",a+=t+" label.on span.switch { border-radius:50%; position:absolute; top:2px; left:18px; width:16px; height:16px; background:white;}\n",a+=t+" label.off span.switch { border-radius:50%; position:absolute; top:2px; left:1px; width:16px; height:16px; background:white;}\n",API.addStyleRules(a)),o}switchTagCallback(e,t,s=0,n){let i=this.switchTag("","sw1","alt");return i=i.replace('onclick="API.toggleSwitch(this);"','onclick="'+(e+"( '"+t+"', this);")+'"'),i}toggleSwitch(e){let t=e.previousSibling;e.childNodes[0];let s=this.dom.attr(e,"ude_bind");document.querySelector(":root");var n="on"==this.dom.attr(t,"value")?"off":"on";t.setAttribute("value",n),e.className=n;let i=s.split(".");e=this.dom.element(i.shift()),n={event:"setValue",type:"setValue",key:i,value:n};this.ude.dispatchEvent(n,e)}selectorTag(t,e="",s="",n=""){let i="";i+="<select",e&&(i+=' id="'+e+'"'),n&&(i+=' onchange="'+n+'"'),i+=">",s&&(i+='<option value="">'+s+"</option>");for(let e=0;e<t.length;e++)i+='<option value="'+t[e]+'">'+t[e]+"</option>";return i+="</select>",i}getSingleChoice(e){let t=null;e=this.dom.element(e);if(!e)return null;let s=this.dom.elements('input[ type="radio"]',e);0==s.length&&(s=this.dom.elements("option",e));for(let e=0;e<s.length;e++){var n=s[e];if(n.checked||n.selected){t=n.value;break}}return t}getMultipleChoices(e){let s=[];e=this.dom.element(e);if(!e)return null;if("fieldset"==this.dom.attr(e,"exTag")){let t=this.dom.elements('input[ type="checkbox"]',e);0==t.length&&(t=this.dom.elements("option",e));for(let e=0;e<t.length;e++){var n=t[e];(n.checked||n.selected)&&s.push(n.value)}}return s.join(",")}metricTag(e,t,s,n){let i="";var o=n[0],a=n[1],n=n[2],a=this.dom.elementByName(a).clientWidth-40;s=Math.min(s,1.3*o);o=Math.round(100*s/(1.3*o));let l=[o-2,0,o+2,0,o,80];o=l.join(",");return"value versus target"==e&&(i+='<span class="counter">'+s+" "+n+"</span>"),-1<["value versus target","progress","limit"].indexOf(e)&&(i+="<svg",t&&(i+=' id="'+t+'"'),i+=' viewBox="0 0 100 100" preserveaspectratio="none"',i+=' class="progressmetric" width="'+a+'"',i+=">",i+='<rect class="back low" width="33%" height="100%" y="3" />',i+='<rect class="back medium" width="33%" height="100%" x="33" y="3" />',i+='<rect class="back high" width="33%" height="100%" x="66" y="3" />',i+='<polygon class="cursor" points="'+o+'" />',i+="</svg>",n&&(i+='<span class="gaugecaption">'+n+"</span>")),i}multiCalc(e){let t=null;if(t="string"==typeof e?this.dom.udjson.parse(e):this.dom.udjson.parse(JSON.stringify(e)),!t)return debug({level:2,return:null},"Multicalc, no JSON",e);for(var s in t){let e=t[s];"object"==typeof e?e=this.multiCalc(e):"string"==typeof e&&"="==e.charAt(0)&&(e=this.exec(e.substr(1))),t[s]=e}return"string"==typeof e?JSON.stringify(t):t}substituteFormulaeInElement(e){let t=this.dom.eleent(e);if(t){let s="";var n,i,o=t.childNodes;for(let t=0;t<o.length;t++){let e=o[t];3==e.nodeType?s+=e.textContent:(n=this.dom.attr(e,"ude_formula"),i=this.dom.attr(e,"ud_type"),n&&(e.innerHTML=this.exec(n,e)),this.dom.attr(e,"ude_formula","__CLEAR__"),s+="field"==i?e.innerHTML:e.outerHTML)}return t.innerHTML=s,t}}textContent2HTML(e){let t=this.dom.element(e);if(t=t||this.dom.element(e+"_object"),!t)return"";let s=[],n="";n=t.textContent;e=API.json.parse(n);s=e&&API.json.value(e,"meta")?API.json.valueByPath(e,"data/edit/value/value"):(n=n.replace("{edit}",""),n.split("\n"));let i=s.shift().trim().toLowerCase(),o="";if(-1==["linetext","css","js","json","html"].indexOf(i)&&(o+=i="\n"),"html"!=i)o+=s.join("\n");else{let t=!1;for(var a in s){let e=s[a].trim();e=e.replace(/\\\"/g,'"'),-1<e.indexOf("<style")||-1<e.indexOf("<style")?t=!0:(-1<e.indexOf("</style")||-1<e.indexOf("</style"))&&(t=!1),t?e+="\n":e=e||"<br />",o+=e}}let l=document.createElement("textarea");return l.innerHTML=o.replace(/\n/g,"").replace(/\r/g,""),l.value}HTML2editable(e){let t=document.createElement("textarea");t.textContent=e;let s=t.innerHTML;return s=s.replace(/</g,"\n<"),s}substitute(e,t){let s=e;for(var n in t){var i=new RegExp("{"+n+"}","g");s=s.replace(i,t[n])}return s}buildComposite(e,t,s){var n=e.replace(/ /g,"_").replace(/'/g,"_").replace(/"/g,"");let i=e,o=s="html"==t?this.HTML2editable(s):s;void 0!==s.caption&&(i=s.caption,o=s.data);s="";return s+='<span class="caption">'+i+'<span class="objectName">'+n+"</span></span>",s+='<div id="'+n+'" class="'+t+'object hidden" ude_editZone="'+n+'editZone"',s+=">"+o+"</div>"}buildJSONlist(e,t,s){e.replace(/ /g,"_").replace(/'/g,"_").replace(/"/g,"");if("text/plain"!=t)return"ERR: MIME type not processed yet"+t;if(!s)return{};let n=s.split("\n"),i={_list:{_id:e,_classList:"listScroll1"}};for(let e=0;e<n.length;e++){var o=n[e],a=n.indexOf(o);-1<a&&a<e||(i["i"+(e+1)]={value:o})}return JSON.stringify(i)}checkValue(e,t){let s="";return"string"==typeof t?s=e.replace(/\(/,"('"+t+"',"):"number"==typeof t&&(s=e.replace(/\(/,"("+t+",")),this.eval(s)}inList(){let e=Array.from(arguments);var t,s=e.shift();return 1!=e.length||(t=this.dom.element(e[0]))&&"UL"==t.tagName&&(e=API.getItems(t.id)),-1!=e.indexOf(s)}inBetween(e,t,s){var n,i=parseFloat(e);let o=!1;return isNaN(i)||(n=parseFloat(t),e=parseFloat(s),o=isNaN(n)||isNaN(e)?(debug({level:2},"Between not a number",t,s),!0):n<=i&&i<=e),o}countTermsInFormula(e){return e?(this.prepareForExec(e),this.termCount):0}listNames(e){return Object.keys(e)}listValues(e){return Object.values(e)}item(e,t){var s;if(Array.isArray(e)&&!isNaN(t)&&"object"!=typeof(s=e[t-1]))return s}formatList(e,t,s){let n="";for(var i in e){var o=n[i];isNaN(o)?n+='"'+i+'":"'+o+'", ':"money"===(o=s.split(" "))[0]?n+='"'+i+'":'+new Intl.NumberFormat(lang,{style:"currency",currency:o[1]}).format(value)+", ":n+='"'+i+'":'+new Intl.NumberFormat(lang,{style:"decimal",maximumSignificantDigits:o[1]}).format(value)+", "}return n.substr(0,n.length-2)}removeAccentsAndLower(e){let t=e.trim().toLowerCase();return t=t.replace(new RegExp(/\s/g),""),t=t.replace(new RegExp(/[àáâãäå]/g),"a"),t=t.replace(new RegExp(/æ/g),"ae"),t=t.replace(new RegExp(/ç/g),"c"),t=t.replace(new RegExp(/[èéêë]/g),"e"),t=t.replace(new RegExp(/[ìíîï]/g),"i"),t=t.replace(new RegExp(/ñ/g),"n"),t=t.replace(new RegExp(/[òóôõö]/g),"o"),t=t.replace(new RegExp(/œ/g),"oe"),t=t.replace(new RegExp(/[ùúûü]/g),"u"),t=t.replace(new RegExp(/[ýÿ]/g),"y"),t=t.replace(new RegExp(/\W/g),""),t}trim(e,t="_"){t=newRegExp("/"+t+"/","g");return e.replace(t,"").trim()}uppercase(e){return e?e.toUpperCase():""}titlecase(e){return e?e.replace(/\w\S*/g,function(e){return e.charAt(0).toUpperCase()+e.substr(1).toLowerCase()}):""}orop(){let t=!1;for(let e=0;e<arguments.length;e++)t|=arguments[e];return t}oneOf(e){let t=[];for(let e=1;e<arguments.length;e++)t.push(arguments[e]);return-1<t.indexOf(e)}defaultValue(e,t){return""===e?t:e}jsonKeys(e){e=API.json.parse(e);return e?Object.keys(e):[]}api(e,t,s){return-1<["valueByPath"].indexOf(e)?API.json.valueByPath(t,s):API[e](t,s)}isName(e){return 1==e.length?/^[a-zA-Z\u00C0-\u017F 0-9\-]$/.test(e)?e:"":/^[a-zA-Z\u00C0-\u017F 0-9\-]+$/.test(e)?e:""}isDate(e,t="DD/MM/YY",s="DD/MM/YYYY"){return 1==e.length?/^[0-9\/]$/.test(e):this.datestr(e,t,s)}array(){let e=[];for(var t=0;t<arguments.length;t++)e.push(arguments[t]);return e}content(e){let t=this.dom.element(e);if(t=t||this.dom.elementByName(e),!t)return"";let s=t.outerHTML;e="U"+this.ude.ticks;return s=s.replace(/id="/g,'id="'+e).replace(/name="/g,'name="'+e),s}uround(t,s=0){if(!Array.isArray(t)){let e=t;return isNaN(e)?e:("string"==typeof e&&(e=parseFloat(e)),e=s?Math.round(e*10**s)/10**s:Math.round(e),e)}let n=t;for(let e=0;e<n.length;e++)n[e]=this.uround(n[e],s);return n}value(e,t="",s=""){t=this.dom.value(e+"."+t+"."+s);if(isNaN(t))return t;s=parseFloat(t),t=parseInt(t);return s==t?t:s}textReplace(e,t,s){return s.replace(e,t)}attrPath(e,t){let s=doOnload("$$$.dom.element("+e+");");return s?(s.id||(this.dom.attr(s,"name")?s.id=this.dom.attr(s,"name"):(s.id=$$$.getName(s,!0),this.dom.attr(s,"name",s.id))),s.id+"..."+t):(console.log(e),"")}}if("object"==typeof process&&(module.exports={UDEcalc:UDEcalc},void 0===global.JSDOM&&"undefined"==typeof window)){console.log("Syntax : OK");const envMod=require("../tests/testenv.js");requirejs=envMod.require,envMod.load(),"object"==typeof window?window.UDEcalc=UDEcalc:window={};let calc=new UDEcalc(null,null);var DOM_lastAccessedValues,DEBUG_level=6;let r,test="";"test"==(r=calc.exec("'test'",null))?console.log("Test1 : OK"):console.log("Test1 : KO "+r),14==(r=calc.exec("(20+5)*2-3*(7+5)",null))?console.log("Test2 : OK"):console.log("Test2 : KO "+r),10==(r=calc.exec("json('{\"val1\":10}', 'val1')",null))?console.log("Test3 : OK"):console.log("Test3 : KO"),test="4 checkValue/inList",testResult(test,calc.checkValue("inList( 'abc','def','ghi')","abc")),test="5 checkValue/inBetween",testResult(test,calc.checkValue("inBetween( 100,200)",150));{test="6 formatList";let list={Labradors:50,Hounds:20,Retrievers:56};testResult(test,-1<calc.formatList(list,"=","").indexOf("Retrievers"))}{test="7 listName, list Values";let list={Labradors:50,Hounds:20,Retrievers:56};testResult(test,calc.listNames(list).length==calc.listValues(list).length&&3==calc.listNames(list).length)}{test="8 uround";let w=[12.235466,"abc",55,623.3333333],r=calc.uround(w,2);testResult(test,12.24==w[0],r)}{test="9 datestr";let expr="demain",r=calc.datestr(expr);console.log(expr,r),testResult(test,-1<r.indexOf("20"),r)}{test="10 datestr";let expr="+3j",r=calc.datestr(expr);console.log(expr,r),testResult(test,-1<r.indexOf("20"),r)}{test="11 datestr working with week of year";let expr="semaine 21",r=calc.datestr(expr),r2=calc.datestr("Marpr 10h30","","YYYY-MM-DDTHH:mm:00"),r3=calc.datestr("jEnpr 10h30","","YYYY-MM-DDTHH:mm:00");testResult(test,r2&&-1<r2.indexOf("05")&&!r3,r2+" "+r3)}{test="12 datestr with full date";let expr="24/05/2024 10h15",r=calc.datestr(expr,"","YYYY-MM-DDTHH:mm:00");testResult(test,-1<r.indexOf("05"),r)}{test="13 datestr with just time";let expr="10h15",r=calc.datestr(expr,"","YYYY-MM-DDTHH:mm:00");testResult(test,-1<r.indexOf("10:15"),r)}console.log("Program's trace checksum: "+debug("__CHECKSUM__")),console.log("Test completed")}class UDEtext{dom;ude;textCol1="n°";textCol2="text";defaultContent={linetext:"Server/CSS/JS/JSON\n\n\n",server:"Server\n\n\n",css:"CSS\n\n",js:"JS\n\n\n",json:"JSON\n\n\n",api:"API\n\n"};constructor(e,t){this.dom=e,this.ude=t}initialise(e){let t=this.dom.element(e);t.parentNode,t.nextSibling;let s=t.childNodes;var n=this.dom.attr(t,"ud_type");let i=t.classList,o="";for(var a=0;a<i.length;a++)"table"!=i.item(a)&&""==o&&(o=i.item(a));let l="",r="",d="",u=null,c=this.dom.attr(t,"ud_mime");switch(c||(c="text/json",this.dom.attr(t,"ud_mime",c)),"text/json"==c&&1<s.length&&(c="text/text"),c){case"text/json":if(s.length&&(u=JSONparse(s[0].textContent),l=s[0].id),!u){let e=this.dom.attr(t,"name");e=e||"Text_"+t.id,this.dom.emptyElement(t);var h=t.appendChild(this.newTextObject(e,n));l=h.id,u=JSONparse(h.textContent)}h=this.dom.udjson.putElement(u,l);t.appendChild(h);break;case"text/text":if(s.length&&1==s[0].nodeType&&"SPAN"==s[0].tagName&&s[0].classList.contains("caption"))d=s[0].textContent,d=d.replace(/ /g,"_").replace(/'/g,"_").replace(/"/g,""),t.parentNode,l=s[1].id,r=s[s.length-1].innerHTML;else{d=t.textContent,d=d.replace(/ /g,"_").replace(/'/g,"_").replace(/"/g,"");for(var m=t.childNodes,a=0;a<m.length;a++)t.removeChild(m[a]);var p=this.dom.prepareToInsert("span",d,{class:"caption"}),p=t.appendChild(p),h="new UDapiRequest('UDtext', 'setChanged(/"+d+"editZone/, 1);', event);";p=this.dom.prepareToInsert("input","",{type:"button",value:"save",onclick:h,udapi_quotes:"//"}),t.appendChild(p),r=this.defaultContent[n],p=this.dom.prepareToInsert("div",r,{id:d,class:"listObject, hidden"}),t.appendChild(p)}p={id:d+"editZone",class:"table",ud_type:"editZone",ud_subtype:"text",ude_bind:d,ud_mime:"text/"+n,ude_autosave:"off",ude_stage:"off"};let e=this.dom.prepareToInsert("div","",p);"json"==n&&(r=this.JSONtoText(r));p=this.convertTextToHTMLtable(r,d,o);e.appendChild(p),t.appendChild(e)}}newTextObject(e,t){var s=e.replace(/ /g,"_").replace(/'/g,"_").replace(/"/g,""),n=s+"_object";let i={meta:{type:"text",subtype:t,name:s,zone:s+"editZone",caption:e,captionPosition:"top",autosave:"off"},data:{tag:"textedit",class:"textContent "+t,value:[t.toUpperCase(),"...","..."]},changes:[]};"json"==t.toLowerCase()&&(i={meta:{type:"text",subtype:t,name:s,zone:s+"editZone",caption:e,captionPosition:"top"},data:{tag:"textedit",class:"textContent "+t,value:{jsonval1:"..."}},changes:[]});n={id:n,class:"object textObject, hidden",ud_mime:"text/json"},n=this.dom.prepareToInsert("div",JSON.stringify(i),n);return this.dom.attr(n,"ud_mime","text/json"),n}convertTextToHTMLtable(e,t,s,n=""){var i=(e=e.replace(/<br data-ud-type="linebreak">/g,"\n")).split("\n");let o=document.createElement("table");o.className=s?"textContent "+s:"textContent",o.id=t+"edittable";let a=document.createElement("thead"),l=document.createElement("tbody"),r="window.ud.ude.setChanged( document.getElementById( '"+t+"editZone'), true);";n&&(r=n);n="";n+='<span class="rightButton"><a ref="javascript" onclick="'+r+'">save</a>';var d="";d+='<tr contenteditable=false><th class="rowNo">'+this.textCol1+'</th><th class="linetext">'+this.textCol2+" "+n+"</th></tr>",d+='<tr class="rowModel">',d+='<td class="rowNo" ude_formula="row()" contenteditable="false">=row()</td>',d+='<td class="linetext">...</td>',d+="</tr>",a.innerHTML=d,o.appendChild(a);for(var u=0;u<i.length;u++){let e=document.createElement("tr");d="",d+='<td contenteditable="false" ude_formula="row()" class="rowNo">'+(u+1)+"</td>",d+='<td class="linetext">'+i[u]+"</td>",e.innerHTML=d,l.appendChild(e)}return o.appendChild(l),o}inputEvent(d,u){let c=!1;var h=d.event;let m=this.dom.getSaveableParent(u);var p=this.dom.attr(m,"exTag"),g=this.dom.getParentWithAttribute("ude_bind",u);let f="...";void 0!==d.data&&(f=d.data);var v,b=this.dom.cursor.textOffset;switch(h){case"change":"true"==this.dom.udjson.value(d,"multinode")&&(y=this.dom.getParentWithTag(u,"table"),this.ude.tableEd.update(y.id));break;case"newline":let e=null;if(this.dom.isHTML(f)){let e=document.createElement("textarea");e.textContent=f.replace(/\n/g,"");let t=e.innerHTML,s=t.split("&lt;");for(let t=0;t<s.length;t++){let e=s[t].replace(/\"/g,'"');""!=e&&(v={event:h,data:"&lt;"+e.trim()},this.inputEvent(v,u))}c=!0;break}let t=!0;if(f&&"..."!=f||!b)0==b&&(t=!1);else{var x=this.dom.cursor.HTMLoffset;let e=this.dom.cursor.HTMLelement.innerHTML;var y=e.length;x<y&&(f=e.substr(x,y)),this.dom.cursor.HTMLelement.innerHTML=e.substr(0,x)}f=f.replace(/"/g,'\\"');x=this.dom.udjson.parse('{ "'+this.textCol1+'":"=row()", "'+this.textCol2+'":"'+f+'"}');e=this.ude.tableEd?this.ude.tableEd.insertRow(null,-1,x,t,!1):this.dom.insertElementAtCursor("tr");x=this.dom.udjson.value(d,"update");""!=x&&!x||this.ude.updateTable(e.parentNode.parentNode.id),"Off"!=this.dom.getParentAttribute("","ude_autosave",this.dom.cursor.HTMLelement)&&this.ude.setChanged(this.dom.cursor.HTMLelement),this.dom.cursor.HTMLelement=e.querySelector("td :not([contenteditable=false])"),this.dom.cursor.HTMLelement||(this.dom.cursor.HTMLelement=e.cells[1]),this.dom.cursor.setAt(this.dom.cursor.HTMLelement,f.length),c=!0;break;case"paste":let s=this.dom.cursor.HTMLelement;if(!s)break;this.ude.clearPlaceholder(s);let n=s.textContent,i=0;if("string"==typeof f){let e=document.createElement("textarea");e.innerHTML=f.replace(/\n/g,"");var T=e.textContent;if(s.textContent=n.substr(0,b)+T,b<n.length-1&&!d.last){let e=n.substr(b);e=e.replace(/"/g,'\\"'),e=this.dom.udjson.parse('{ "'+this.textCol1+'":"=row()", "'+this.textCol2+'":"'+e+'"}'),this.ude.tableEd&&(this.ude.tableEd.insertRow(null,-1,e),i=e.length)}else s.textContent=n.substr(0,b)+T+n.substr(b),i=b+T.length}else"object"==typeof f&&(this.dom.udjson.value(f,"src")&&(n=n.substr(0,b)+f.src+n.substr(b)),this.dom.cursor.HTMLelement.innerHTML=n);this.dom.cursor.setAt(this.dom.cursor.HTMLelement,i),c=!0;break;case"endPaste":var E=this.dom.cursor.HTMLelement;this.ude.updateTable(E.parentNode.parentNode.parentNode.id),c=!0;break;case"cut":case"copy":this.dom.cursor.fetch();var w=this.dom.cursor,T=w.textElement,_=w.focusElement,E=(w.HTMLelement.parentNode.parentNode.childNodes,T.parentNode.parentNode),T=_.parentNode.parentNode,_=this.dom.cursor.computeHTMLoffset(w.textElement.textContent,w.textOffset),w=this.dom.cursor.computeHTMLoffset(w.focusElement.textContent,w.focusOffset),_=this.getSelection(E,T,_,w);let o="text";this.dom.isHTML(_)&&(o="html"),window.clipboarder&&(window.clipboarder.openClipboard(),(C=window.clipboarder.createClip(o,_))&&window.clipboarder.saveClip(C)),-1<["div.css","div.js"].indexOf(p)&&-1<UD_SERVER.indexOf("https:")&&navigator.clipboard.writeText(_),c=!0;break;case"merge up":case"merge down":case"remove":{if("TD"!=u.tagName){c=!0;break}var w=this.dom.attr(u,"textContent of siblings").replace(/\s/g,""),C=u.innerHTML;let e=u.parentNode;_=e.parentNode.parentNode.id;let t=e.previousSibling.cells[1],s=0;if(t&&(s=t.innerHTML.length),"merge down"!=h&&t||!e.nextSibling||(t=e.nextSibling.cells[1],s=0),w){let e=t.innerHTML;t.innerHTML=e.substring(0,s)+C+e.substring(s),s+=e.length-1}e.remove(),this.ude.tableEd.update(_),this.dom.cursor.HTMLelement=t,this.dom.cursor.HTMLoffset=s,this.dom.cursor.textElement=t.firstChild,this.dom.cursor.textOffset=s-1,this.dom.cursor.set(),c=!0;break}case"save":var A=d.target;c=this.prepareToSave(g,A);break;case"update":var M=this.dom.attr(u,"ud_type");let a=this.dom.attr(u,"name");a=a||u.id;let l=this.dom.element(a+"editZone");this.dom.udjson.value(d,"editZoneId")&&(l=this.dom.element(this.dom.udjson.value(d,"editZoneId")));var N=l.className;let r=this.dom.udjson.value(d,"object");if(r)r=JSON.stringify(r);else if("json"!=M){A=this.dom.element("div.textObject",u);A&&(r=A.textContent)}else{var L=this.dom.element("div.object",u);if(!L)return;r=this.dom.udjson.valueByPath(L.textContent,"data/value")}"json"==M&&(r=this.JSONtoText(r));L=this.convertTextToHTMLtable(r,a,N);l&&(l.innerHTML=L.outerHTML),c=!0;break;case"setValue":M=this.dom.attr(m,"ud_type"),N=this.dom.attr(u,"id");if("json"==M){L=d.key;let e=m.getElementsByTagName("div")[0];M=e.textContent;let t="data/value/"+L[0];L[1]&&(t+="/"+L[1]),M=this.dom.udjson.valueByPath(M,t,d.value),e.textContent=M,this.ude.setChanged(m);let s=this.dom.element(N+"editZone");N=this.dom.attr(s,"ude_bind"),N=this.dom.udjson.putElement(this.dom.udjson.parse(M),N);s.innerHTML=N.outerHTML}}return c}getSelection(e,t,s,n,i=!1){let o=e,a=1e3,l=o.cells[1].innerHTML.substring(s)+"\n";e==t&&(l=o.cells[1].innerHTML.substring(s,n));let r=[];for(i&&(0==s?r.push(o):o.cells[1].innerHTML=o.cells[1].innerHTML.substring(0,s));o&&o!=t&&a--;){o=o.nextSibling;let e=o.cells[1].innerHTML;o==t?(l+=e.substring(0,n),i&&(cursor.focusOffset<o.cell[1].innerHTML.length?o.cells[1].innerHTML=e.substring(n):r.push(o))):(l&&(l+="\n"),l+=e),i&&r.push(o)}for(let e=0;e<r.length;e++)r[e].remove();return l}getHTMLOffset(e,t){e.parentNode.childNodes;let s=0,n=0;for(let e=0;e<children.length&&(s+=child.textContent.length,!(s>=t));e++)child.nodeType==Node.TEXT_NODE?n+=child.textContent.length:child.nodeType==Node.ELEMENT_NODE&&(n+=child.outerHTML.length);return n}prepareToSave(a,l){let e=l.parentNode,r=this.dom.attr(a,"ud_mime");if(r=r||this.dom.attr(e,"ud_mime"),API.dispatchNameChange(e),"text/json"==r&&2<this.dom.children(e).length)r="text/text";else if("text/json"!=r){var t=l.id,n=this.dom.attr(e,"ud_type");l=this.newTextObject(t,n);let s=e.childNodes;l=e.insertBefore(l,s[0]);for(let t=1;t<s.length;t++){let e=s[t];"span"==this.dom.attr(e,"exTag")&&e.classList.contains("caption")?a.insertBefore(e,a.childNodes[0]):e!=l&&e!=a&&e.remove()}s[0].id=s[0].id+"object",this.dom.attr(a,"ud_type","text"),r="text/json"}switch(r){case"text/json":{let e=API.json,t=e.parse(l.textContent);var d=e.value(t.meta,"name");l.innerHTML=JSON.stringify(this.dom.udjson.getElement(a,!0)),t=e.parse(l.textContent);var u=e.value(t.meta,"name");let s=e.value(t.meta,"caption");if(d!=u&&s){s=s.replace(d,u),t.meta.caption=s,l.textContent=JSON.stringify(t);let e=this.dom.element("span.caption",u+"editZone");e&&(e.textContent=s)}break}case"text/js":case"text/css":case"text/text":case"text/linetext":case"text/server":let e=a.getElementsByTagName("table")[0];if(!e)return debug({level:1,return:null},"can't find table in ",editorZoneId);var c=e.getElementsByTagName("tbody")[0].rows;if(!c)return debug({level:1,return:null},"no rows in tbody of ",editorZoneId);let s="",n=!1,i={},o;for(let t=0;t<c.length;t++){let e=c[t].cells[1].textContent;"text/html"==r&&(e=c[t].cells[1].innerHTML),0==t&&0==e.indexOf("JSON")&&(n=!0,o=e.replace("JSON","").trim()),n?i=this.prepareJSONstring(i,e):s+=e+"\n"}if(n){var h=JSON.stringify(i);switch(o){case"parent_extra":var m=l.parentNode;this.dom.attr(m,"ud_extra",h);break;case"content":l.textContent=JSON.stringify(i)}}else l.textContent=s.substring(0,s.length-1)}return!0}prepareJSONstring(e,t){var s=t.indexOf("=");if(s<=0)return e;let n=t.substr(0,s).trim();t=t.substr(s+1).trim(),t=JSON.parse(t),s=n.split("/");return 1<s.length?(void 0===e[s[0]]&&(e[s[0]]={}),2<s.length?(void 0===e[s[0]][s[1]]&&(e[s[0]][s[1]]={}),e[s[0]][s[1]][s[2]]=t):e[s[0]][s[1]]=t):e[n]=t,e}JSONtoText(e,t=""){if(!(e="string"==typeof e&&""!=e?this.dom.udjson.parse(e):e))return"";let s="";for(var n in t||(s+="JSON content\n"),e)if("length"!=n){var i=e[n],o=t+n;switch(typeof i){case"array":case"object":s+=this.JSONtoText(i,o+"/");break;case"number":s+=o+" = "+i+"\n";break;case"string":s+=o+' = "'+i+'"\n';break;default:debug({level:2},"unknown value type in JSON",prefix+n,i)}}return s}}function Zone(e,t){this.stayOpenTime=18e4,this.mobileModeMaxWidth=480,this.getStyle1=function(e,t){e=window.getComputedStyle(this.element1)[e];return"nb"==t?parseInt(e):e},this.getStyle2=function(e,t){e=window.getComputedStyle(this.element2)[e];return"nb"==t?parseInt(e):e},this.element1=document.getElementById(e),this.element2=document.getElementById(t),this.mode="",this.saveContent="",this.params="",0==this.getStyle1("width","nb")&&(this.mode="Reduced"),this.toolZone1=this.element1.childNodes[3],this.toolZone1.setAttribute("onclick","leftColumn.closeIfAnchor(event.target, true);"),this.manageButtons=function(){let e=document.getElementById("leftToolIcon"),t=document.getElementById("rightToolIcon");var s=25<this.element1.textContent.length,n=25<this.element2.textContent.length;!s&&e?e.classList.add("hidden"):s&&e&&e.classList.remove("hidden"),!n&&t?t.classList.add("hidden"):n&&t&&t.classList.remove("hidden")},this.switchDisplayMode=function(e=!1){var t=25<this.element1.textContent.length,s=25<this.element2.textContent.length,n=window.getComputedStyle(this.element1).width,i=window.getComputedStyle(this.element2).width,o=window.scrollY;let a=e?1200:screen.innerWidth;if(a=a||screen.availWidth,console.log("window.scrollY:"+o+", screenWidth:"+a),"0px"==n&&(a>this.mobileModeMaxWidth||"0px"==i)&&t){if(this.element1.style.width=window.getComputedStyle(this.element1)["max-width"],this.element1.style.top=o+"px",o){let t=this;window.addEventListener("scroll",function(e){t.scrollMove(e,t.element1)})}this.element1.querySelector("div.tool-zone").style.display="block",setTimeout(function(){leftColumn.closeAll(!0)},this.stayOpenTime)}else if("0px"!=n&&(a>=this.mobileModeMaxWidth||"0px"==i)&&s){a<this.mobileModeMaxWidth&&(this.element2.style.width=window.getComputedStyle(this.element2)["max-width"],this.element2.querySelector("div.tool-zone").style.display="block",setTimeout(function(){rightColumn.closeAll(!0)},this.stayOpenTime)),this.element1.style.width="0px",this.element1.querySelector("div.tool-zone").style.display="none",API.setAttribute("outlineCurrentElementCSS","");var l,r=document.getElementById("document");for(l in r.childNodes)"object"==typeof r.childNodes[l]&&r.childNodes[l].classList&&r.childNodes[l].classList.remove("StylerTool_outline")}else"0px"!=n&&"0px"==i?(this.element1.style.width="0px",this.element1.querySelector("div.tool-zone").style.display="none"):"0px"==n&&"0px"!=i&&(this.element2.style.width="0px",this.element2.querySelector("div.tool-zone").style.display="none")},this.closeAll=function(e=!1){this.element1.style.width="0px",this.element2.style.width="0px",e&&(this.element1.childNodes[3].innerHTML="",this.element2.childNodes[3].innerHTML="")},this.scrollMove=function(e,t){var s=window.scrollY,n=parseInt(window.getComputedStyle(document.getElementById("content")).height.slice(0,-2)),i=window.getComputedStyle(this.element1).width,o=window.getComputedStyle(this.element2).width;i&&(this.element1.style.top=s+"px",this.element1.style.height=n-s+"px"),i&&(this.element2.style.top=s+"px",this.element2.style.height=n-s+"px"),i||o||window.removeEventListener("scroll",function(e){me.scrollMove(e,t)})},this.closeIfAnchor=function(e,t=!1){"a"==e.tagName.toLowerCase()&&this.closeAll(t)}}"object"==typeof process&&(module.exports={class:UDEtext},void 0===global.JSDOM&&"undefined"==typeof window&&(console.log("Syntax : OK"),console.log("Start of test program"),console.log("Test completed"))),"object"==typeof process&&(module.exports={class:Zone});class UDapiSet1{moduleName="apiset1.js";ud=null;dom=null;udajax=null;ude=null;calc=null;udeTable=null;udeList=null;udeDraw=null;utilities=null;terms=null;constructor(e){"undefined"==typeof API?(this.ud=e,void 0!==this.ud.ude?this.ude=this.ud.ude:this.ude=ud,this.dom=this.ud.dom,this.udajax=this.ud.udajax,this.calc=this.ude.calc,this.udeTable=this.ude.modules["div.table"].instance):e==API&&(this.ud=API.ud,this.dom=API.dom,this.udajax=API.udajax,this.utilities=API.utilities,API.addFunctions(this,["addStyleRules","addToHistory","addTool","back","botlogUpdate","botlog","buildPartEditing","clearTools","initialiseElement","insertElement","insertHTML","insertTable","loadDocument","createDocument","loadModule","loadTool","postForm","reload","reloadView","removeElement","setModel","setStyle","setSystemParameters","getUDparam","setUDparam","env","translateTerm","switchView","configureElement","HTMLeditor","displayDocInPanel","goTo","getView","showMenu","clearMenu","displayTip","addTip","hoverOver","clickOn","addView","setupView","createUser","prepareUserCreation","getOIDbyName","checkAndWriteValue","getRadioValue"]))}addTool(e,t,s,n,i=""){this.dom.findElement(t+"-icon")&&this.dom.findElement(t+"-icon").remove();var o=document.createElement("div"),a=document.createElement("img");a.src=s;var l=document.createElement("a"),s=document.createTextNode(t);l.appendChild(a),l.appendChild(document.createElement("br")),l.appendChild(s),l.title=t,i&&(l.title=i),l.href="javascript:";s="",i=e.replace("-selector","-zone");l.setAttribute("onclick",s+="window.ud.loadTool( this,'"+e+"', '"+n+"','"+i+"');"),o.appendChild(l),o.setAttribute("class","tool-icon"),o.setAttribute("id",t+"-icon"),document.getElementById(e).appendChild(o);let r=t;if("tagger"==t.toLowerCase()&&(r="Inserter"),-1<n.indexOf(".js"))if(this.unitTesting){let e=require("../modules/"+n).class;this.ude.modules["modules/"+n]={},this.ude.modules["modules/"+n].instance=new e(this,i)}else this.ude.loadScript("modules/"+n,"window.ud.ude.modules['modules/"+n+"']['instance'] = new "+r+"( window.ud, '"+i+"');");else this.unitTesting||((i=new XMLHttpRequest).element=o,i.ud=this,i.onreadystatechange=function(){var e;4==this.readyState&&200==this.status&&(debug({level:7},e=getOnload(this.responseText)),doOnload(e))},i.open("GET",n+"/e|load/",!0),i.setRequestHeader("Content-type","application/x-www-form-urlencoded"),i.send())}loadTool(e,t,s,n){var i,o=document.getElementById(t);for(i in o.childNodes)console.log(typeof o.childNodes[i]),"object"==typeof o.childNodes[i]&&o.childNodes[i].classList.remove("selected");e.parentNode.classList.add("selected");let a=document.getElementById(n);a.innerHTML="",-1<s.indexOf(".js")?(e=this.ude.modules["modules/"+s].instance)&&e.event("open"):(s=s.replace(/{topOID}/g,this.dom.attr(this.topElement,"UD_oid")),this.unitTesting||new UDAJAX(this,"").serverRequest(s+"/e|open/","GET","",{action:"fill zone",zone:n}))}clearTools(e,t){let s=document.getElementById(e).childNodes;for(let e=s.length;0<e;e--)s[e-1].remove();let n=document.getElementById(t),i=n.getElementsByTagName("img")[0];return i.setAttribute("src","/upload/N3u2U2g3W_emptyIcon50.png"),!0}loadDocument(n,e=""){var t=API.dom.element("UD_openNewWindow"),s=!t||"yes"==t.value;if(!s||this.unitTesting||-1<n.indexOf("AJAX_")){let s=n.replace("/show/","/AJAX_show/");if(-1<s.indexOf("http")){let e=n.split("/"),t=e.splice(3,e.length-3);s=t.join("/")}t={action:"refresh",element:this.dom.topElement,zone:"document"};this.udajax.serverRequest(s,"GET","",t)}else s&&e?window.open(n,e):document.location=n;return!0}reload(e=!0,t=""){let s=this.ud.service+"/"+this.dom.attr(this.topElement,"ud_oid")+"/"+this.refreshAction+"/";return e?(e={action:"refresh",element:this.topElement},t&&(s+=t+"/"),this.udajax.serverRequest(s,"GET","",e)):location.reload(!0),!0}reloadView(e){var t=this.dom.element(e);if(!t)return!1;t=this.dom.attr(t,"ud_oid");return this.ud.udajax.updateZone(t+"-21/AJAX_show/",e),!0}addToHistory(e){this.currentURL=e;let t=this.dom.element(this.historyElementId);if(!t)return!1;let s=t.textContent.split(",");return-1==s.indexOf(e)&&s.push(e),t.textContent=s.join(","),!0}back(){let e=this.dom.element("UD_history"),t=e.textContent.split(",");var s;2<t.length&&1<(s=t.indexOf(this.currentURL))?(s=t[s-1],this.loadDocument(s)):this.loadDocument("/webdesk/")}insertElement(e,t,s={},n=null,i=!1,o=!1){let a=null;return a=n?this.dom.insertElement(e,t,s,n,i,o):this.dom.insertElementAtCursor(e,t,s),this.dataSource.viewEvent("create",a),a}removeElement(s){let n=this.dom.element(s);if(n){var e=this.dom.getSaveableParent(n);if(e==n)this.ud.viewEvent("delete",n);else if(e){s=this.dom.attr(n,"exTag");if(-1<["span.styled"].indexOf(s)){let e=n.parentNode.innerHTML;n.parentNode.innerHTML=e.replace(n.outerHTML,n.innerHTML)}else n.remove();if(this.ud.viewEvent("change",e),"div.part"==s){let e=this.dom.attr(n,"name");s=e.toLowerCase().replace(/ /g,"_")+"sel";let t=this.dom.element(s);t&&(t.previousSibling?$$$.clickOn(t.previousSibling):t.nextSibling&&$$$.clickOn(t.nextSibling),t.remove())}}}}insertText(e,t="plain"){this.ude.insertTextAtCursor(e,t)}prepareHTML(e){}reserveElement(){}fetch(e){return this.htmlContent}insertTable(e,t){return this.ude.insertTableAtCursor(e)}initialiseElement(e){this.ude.initialiseElement(e)}updateTable(e){let t=e,s=this.dom.element(e);return!!s&&("DIV"==s.tagName&&(t=s.getElementsByTagName("table")[0].id),this.ude.updateTable(t))}updateGraphic(e){return this.ude.updateGraphic(e)}insertHTML(e,t){return API.dom.cursor.setAt(t),this.ude.insertHTMLAtCursor(e)}clientSideInterpretor(e){commande}setModel(e){this.ud.setModel(e)}setSystemParameters(e){var t=this.dom.attr(this.topElement,"ud_oid"),s='textra={"system":{'+JSON.stringyfy(e)+"}";s+="&input_oid="+t,s+="&form="+this.serverFormName;var n="/"+this.ud.service+"/"+t+"/"+this.refreshAction+"/",t={element:this.topElement,action:"reload",setCursor:!1,ud:this};return this.udajax.serverRequest(n,"POST",s,t,null),debug({level:5,coverage:10,file:"apiset1.js",return:!0},"Server request system params"+this.serverRequestId,"reload",e)}env(e,t){t="/"+this.ud.service+"/?"+e+"="+t;this.udajax.serverRequest(t,"GET",null,{action:"ignore"})}setStyle(e){this.ude.setStyle(e)}addStyleRules(t){console.log(t),t=t.split("}");let n=document.createElement("style");for(var i in n.appendChild(document.createTextNode("")),document.head.appendChild(n),t){var o=t[i].indexOf("{");if(-1!=o){let e=t[i].substr(0,o-1).replace(/\n/g,"")+"{"+t[i].substr(o+1).replace(/\s/g,"")+"}";n.sheet.insertRule(e)||debug({level:5},"addStyleRules Fail on",e);let s=e.substring(0,e.indexOf("{")-1);-1<s.indexOf(".")&&(s=s.substring(s.indexOf(".")+1));var a=document.getElementById("document").getElementsByClassName(s);for(let t=0;t<a.length;t++){let e=a[t];e.classList.remove(s),e.classList.add(s)}}}}loadModule(e,t,s){return"object"==typeof process?new window[e](this.topElement):new e(t)}postForm(e,t="",s=""){let n=document.forms.loginform;t&&n.setAttribute("action",t),""!=s&&!Confirm(s)||n.submit()}translateTerm(s,e=!0,t=""){if(!s)return"";let n="";if(this.terms||(this.terms=API.json.merge(UD_terms,"UD_terms")),t)e&&(this.terms[s]=t);else if(-1==s.indexOf("{!"))n=this.terms[s],void 0!==n||(e=Object.values(this.terms).indexOf(s))&&(t=Object.keys(this.terms),n=t[e]),void 0===n&&(n=this.terms[s.replace("_","-")]);else{let e=20,t=s.indexOf("{!");for(;-1<t&&e--;){var i=s.indexOf("!}",t);if(!i)break;var o=s.substring(t+2,i),o="string"==typeof this.terms[o]?this.terms[o]:o;s=s.substr(0,t)+o+s.substr(i+2),t=s.indexOf("{!")}}return void 0!==n&&n||(n=s),n}buildPartEditing(e){let t=this.dom.element(e);if(!t)return debug({level:2,return:null},"Can't find part editing zone",e);e=window.udparams.outlineId;let s=this.dom.element(e);if(!s)return debug({level:2,return:null},"Can't find outline or outlineId",e);var n=s.getElementsByTagName("li");for(let e=0;e<n.length;e++){var i=n[e],o=this.dom.attr(i,"target_id"),a=this.dom.element(o);if(a){o=a.id,a=this.dom.attr(a,"ud_oid"),i=i.innerHTML;let e=document.createElement("p");e.id=o+"_manage",this.dom.attr(e,"ud_oid",a),this.dom.attr(e,"ud_fields","tcontent"),this.dom.attr(e,"ud_dupdated",""+this.ticks),this.dom.attr(e,"ud_dchanged",""+this.ticks),e.innerHTML=i,t.appendChild(e)}}return t}runCommand(e){return this.run(e)}botlogUpdate(o,a,l,r){let d=window.ud.botlog;var u,c=window.ud.ticks;let h=this.dom.element("BVU00000002000000M");if(h&&"p"==this.dom.attr(h,"exTag")||(h=this.dom.element("BVU00000002200000M")),h){window.botlogId=h.id;let s=[],t=h.childNodes;for(let e=0;e<t.length;e++)3==t[e].nodeType&&s.push(t[e].textContent.trim());let e=!1,n=!1,i=!1;if("get"!=o)if("set"==o)void 0===d.log[a]?d.log[a]={status:l,details:r,start:c,update:c,error:!1}:(d.log[a].status=l,d.log[a].details=d.log[a].details+"\n"+r,d.log[a].update=c);else{if("busy"==o){let t=!1;for(var m in d.log){let e=d.log[m];e.status?(50<e.update-e.start?e.error=!0:e.error=!1,t=!0):(u=$$$.calculate("datestr( '', '', 'YYYY-MM-DD-hh:mm');"),u+=" "+m+" "+(e.error?"KO":"OK")+" in "+(e.update-e.start)/10+" s "+e.details,s.push(u),delete d.log[m],h.innerHTML=s.join("<br>"),$$$.setChanged(h))}return t}if("server"==o||""==o){for(let t=0;t<s.length;t++){var p,g=s[t];if("__OPEN__"==g){d.call&&clearInterval(d.call),d.call=setInterval(function(){API.botlogUpdate("server")},2e3),d.openToServer=!0;let e=h.parentNode;"zone"==this.dom.attr(e,"ud_type")&&(e=e.parentNode),API.showOneOfClass(e.id,!0),s[t]="Ouvert au serveur",n=!0}else"__CLOSE__"==g?(d.call&&clearInterval(d.call),d.call=setInterval(function(){API.botlogUpdate("server")},12e3),d.openToServer=!1,(p=this.dom.attr(this.topElement,"ud_defaultpart"))&&API.showOneOfClass(p,!0),s[t]="Fermé au serveur",e=!0,n=!0):"__RELOAD__"==g&&(i=!0,s[t]="Rechargé",n=!0)}if(n&&(h.innerHTML=s.join("<br>")),i&&API.reload(!1),d.openToServer)this.ud.fetchElement(h);else{for(var f in d.log){var v=d.log[f];v.status||(s.push(v.details),delete d.log[f],h.textContent=s.join("<br>"),e=!0)}e&&this.ud.viewEvent("change",h)}debug({level:5,coverage:41,file:"apiset1.js"},"botlogUpdate action:",o)}}}}botlog(e,t,s){this.botlogUpdate("set",e,t,s)}getUDparam(e){let t=null;if(void 0===window.udparams){var s=this.dom.udjson.parse("UD_system");void 0!==s[e]&&(t=s[e])}else{$$$.buildManagePart();s=this.dom.element(UD_wellKnownElements.UD_docParams);if(s){var n=this.dom.udjson.parse(s.textContent);if(!n)return null;n=n.data.value;void 0!==n[e]&&(t=n[e])}}return t||(n=this.dom.udjson.parse("UD_globals"))&&void 0!==n[e]&&(t=n[e]),t}setUDparam(t,s){API.buildManagePart();let n=this.dom.element(UD_wellKnownElements.UD_docParams),i=null,o=null;if(n){let e=this.dom.udjson.parse(n.textContent);if(!e)return null;o=e.data.value,o[t]=s,e.data.value=o,n.textContent=JSON.stringify(e),i=n.parentNode}else{if(i=this.dom.element("BVV00000300000000M_params"),!i)return debug({level:3,return:null},"Can't find doc parameters, so can't change them");if(n=this.dom.element("div.textObject",i),!n)return debug({level:3,return:null},"Can't find doc parameters, so can't change them",i);if(o=this.dom.udjson.parse(n.textContent),!o)return null;o[t]=s,n.textContent=JSON.stringify(o)}return this.ude.textEd.inputEvent({event:"update",object:o},i),this.ud.viewEvent("change",i),o}userId(){return this.ud.userId}ownerId(){return this.ud.ownerId}createDocument(e="Nouvelle tâche",t="Description courte",s="",n=""){let i=this.dom.element("system-message-popup");i&&(i.innerHTML='<div style="text-align:center"><img src="https://www.sd-bee.com/upload/3VUvtUCVi_processing.gif"></div>',i.classList.add("show")),e=API.translateTerm(e,!0),t=API.translateTerm(t,!1),s=API.translateTerm(s,!1);let o=this.dom.attr(this.dom.element("document"),"ud_oid"),a=o.split("--")[1].split("-"),l=this.dom.element("UD_mode").textContent;if(0!=l.indexOf("model")&&(a=a.slice(0,-2)),n){let e=this.dom.element(n);e&&(d=e.textContent.split("--")[1].split("-"),a=d)}o=a.length%2==1?"UniversalDocElement--"+a.join("-")+"-0":"UniversalDocElement--"+a.join("-")+"-21-0";let r="INPUT_addApage";"EN"!=this.dom.element("UD_lang").textContent&&(r=API.translateTerm(r));var d="";d+="form="+r,d+="&input_oid="+o,d+="&stype=2&tgivenname="+e,d+="&tcontent="+t,d+="&nstyle="+s,d+="&textra="+JSON.stringify({system:{state:"new"}});s="/"+UD_SERVICE+"/"+o+"/AJAX_addDirOrFile/e%7CcreateAndOpen/p1%7Cfile/";let u={action:"fill zone",zone:"left-tool-zone",setCursor:!1,ud:this.ud};let c=new Promise((e,t)=>{console.log("Promise new doc")});return c.then(e=>{console.log("then APIset1",e),this.createDocument2(e)}),c.catch(e=>{console.error("Can't create doc (catch)")}),u.promise=c,u.resolve=e=>{console.log("then byresolve APIset1",e),this.createDocument2(e)},u.thenDo={postdata:d,uri:s},window.ud.udajax.serverRequest(s,"GET","",u),!1}createDocument2(e){var t=e.thenDo.uri;let s=e.thenDo.postdata,n={action:"fill zone",zone:"left-tool-zone",setCursor:!1,ud:this.ud},i=new Promise((e,t)=>{console.log("Promise new doc 2")});i.then(e=>this.createDocument3(e)),n.promise=i,n.resolve=e=>{console.log("then APIset1",e),this.createDocument3(e)},this.ud.udajax.serverRequest(t,"POST",s,n);e=s.indexOf("nstyle="),t=s.indexOf("&",e),t=s.substring(e+7,t);let o=$$$.getShortcut("translateTerm"),a='<div style="text-align:center"><img src="https://www.sd-bee.com/upload/3VUvtUCVi_processing.gif"><br>';a+=o("Initialisation de la page"),t&&(a+=" "+o("avec")+" "+t),a+=".</div>",this.topElement.innerHTML=a,window.scrollTo(0,0)}createDocument3(e){let t=this.dom.element("system-message-popup");t&&t.classList.remove("show")}cantCreateDocument(e){let t=this.dom.element("system-message-popup");t&&t.classList.remove("show"),console.error("Can't create doc")}switchView(e,t=""){if(!this.dom.elementByName(e))return!1;let s=t?API.dom.element(t):null;if(s&&s.classList.contains(UD_wellKnownClasses.active)){var n=this.dom.element("div.part:not(.hidden)",this.dom.element("document"));return API.displayMenu(n)}n=this.dom.element("div.part:not(.hidden)",this.dom.element("document"));n&&this.dom.attr(n,"ud_cursor",this.dom.cursor.save(this.dom.attr(n,"ud_cursor")));let i=API.showOneOfClass(e);if(s||(c=API.dom.element("UD_lang").textContent,c=API.hasLanguageSuffix(e)?e:e+" "+c,API.showOneOfClass(c)||API.showOneOfClass(e)),!i)return null;this.buildView(e),API.testEditorAttr(i,"ude_edit","on")&&this.dom.cursor.restore(this.dom.attr(i,"ud_cursor"),!0);let o=API.dom.element("document"),a=API.dom.element("scroll"),l=API.dom.element("content"),r=[],d=o.classList;for(let t=0;t<d.length;t++){let e=d.item(t);-1==e.indexOf(UD_viewPrefix)&&-1==e.indexOf(UD_themePrefix)&&r.push(e)}var u=i.className.split(" ");for(let t=0;t<u.length;t++){let e=u[t];0!=e.indexOf(UD_layoutPrefix)&&0!=e.indexOf(UD_themePrefix)||r.push(UD_viewPrefix+e)}var c=r.join(" ");o.className=c,a.className=c,l.className=c,t=t||e.toLowerCase().replace(/ /g,"_")+"sel",API.activateOneOfClass(t),API.hideMenu();let h=$$$.dom.element("system-message-popup");h&&h.classList.remove("magneto");let m=this.dom.attr(i,"computed_transform");m&&m.indexOf("scale(")?API.dom.transformScale=.8:API.dom.transformScale=1,API.dom.arrangeTables(i),API.paginate(i),"function"==typeof global["view_load_"+e]&&global["view_load_"+e]()}buildView(e){"manage"==e.toLowerCase()?$$$.buildManagePart():$$$.isFunction("build_"+e+"_view")?$$$["build_"+e+"_view"]():$$$.isFunction("build_view")&&$$$.build_view(e)}configureElement(e){let t=this.dom.element(e);t=t||this.dom.element("[name='"+e+"']","document");e=this.dom.getSaveableParent(t);if(!e)return debug({level:7,return:!1},"apiset1.configureElement() can't find ",name);this.ude.dispatchEvent({event:"configure",action:"enter"},e)||(s=this.dom.attr(e,"name"))&&this.dom.element(s+"editZone")&&this.dom.element(s+"_parameters_editZone")&&API.showNextInList([s+"editZone",s+"_parameters_editZone"]);var s=API.insertables(e);s&&function(e,t){for(var s in e)if(t==e[s])return s}(s,this.dom.attr(t,"exTag"))?API.displayConfig(t):API.displayConfig(e)}HTMLeditor(e,t=!1){let i=this.dom.element(e);if(!i)return debug({level:4,return:!1},"Can't find element",e);e=this.dom.attr(i,"name").replace(/ /g,"_");if(this.dom.element(e+"editZone"))API.showNextInList([e+"editZone",e+"viewZone"]);else if(t){let e=this.dom.element(i.id+"editZone"),t=e.getElementsByTagName("table")[0];if(!t)return debug({level:1,return:null},"can't find table in ",editorZoneId);var o=t.getElementsByTagName("tbody")[0].rows;if(!o)return debug({level:1,return:null},"no rows in tbody of ",editorZoneId);let s="";for(let e=0;e<o.length;e++){var a=o[e].cells[1].innerHTML;s+=a}let n=document.createElement("textarea");n.innerHTML=s;var l=n.textContent;e.remove(),i.innerHTML=l,i.classList.remove("hidden"),this.ud.viewEvent("change",i)}else{if(this.dom.element(i.id+"editZone"))return this.dom.element(i.id+"editZone").remove(),void i.classList.remove("hidden");l=i.innerHTML;let e=document.createElement("textarea");e.textContent=l;let t=e.innerHTML.split("&lt;").join("\n&lt;");"\n"==t[0]&&(t=t.substring(1));let s=document.createElement("div");this.dom.attr(s,"id",i.id+"editZone"),this.dom.attr(s,"class","linetext"),this.dom.attr(s,"ude_autosave","off"),this.dom.attr(s,"ude_bind",i.id),this.dom.attr(s,"ud_type","linetext"),this.dom.attr(s,"ud_subtype","text");l="API.HTMLeditor( '"+i.id+"', true);",l=this.ude.textEd.convertTextToHTMLtable(t,i.id,"",l);s.appendChild(l);l=i.nextSibling;let n=i.parentNode;l?n.insertBefore(s,l):n.appendChild(s),i.classList.add("hidden")}}keepOneLanguage(e){var t=this.dom.element("[name='"+name+"']","document");if(!t)return debug({level:7,return:!1},"apiset1.configureElement() can't find ",name);this.ude.dispatchEvent({event:"configure"},t)||API.showNextInList([name+"editZone",name+"_parameters_editZone"])}displayDocInPanel(e,t="",s=""){let n=this.dom.element(e+"Column"),i=this.dom.element(e+"-tool-selector");var o=this.dom.element(e+"-tool-zone");if(o&&t){i&&(i.style.display="none"),API.dom.emptyElement(o);e={onclick:"API.displayDocInPanel( 'right');"};API.dom.insertElement("div","Close",e,o,!1,!0);e={id:s,src:"/webdesk/"+t+"/show/?mode=frame",class:"docDisplay",sandbox:"allow-top-navigation allow-scripts allow-same-origin",style:"width:100%; height:750px;"};return API.dom.insertElement("iframe","",e,o,!1,!0),n.style.width="380px",!0}return o&&(API.dom.emptyElement(o),i&&(i.style.display="block")),!1}goTo(e,t=null,s="middle"){let n="string"==typeof t?this.dom.element('[name="'+t+'"]',"document"):t;n=n||this.dom.element("div.part:not(.hidden)",this.dom.element("document"));let i=this.dom.element(e);var o;return i=i||(0==e.indexOf("Page ")&&n&&"div.part"==API.dom.attr(n,"exTag")?(o=parseInt(e.substr(5)),API.dom.childElements(n)[o-1].childNodes[0]):API.dom.element('[name="'+e+'"]',n)),i?(!n||(o=this.dom.element("div.part:not(.hidden)",this.dom.element("document")))&&o!=n&&this.switchView(this.dom.attr(n,"name")),this.dom.cursor.setAt(i),this.dom.makeVisible(i,"scroll",s),!0):debug({level:5,return:!1},"Can't find element to goTo",e)}getView(e){let t=10;let s=this.dom.element(e);for(;s&&"document"!=s.id&&!s.classList.contains("part")&&--t;)s=s.parentNode;return s.classList.contains("part")?s:null}showMenu(e){e=API.dom.element('[Name="'+e+'"]',"document");e&&API.displayMenu(e)}clearMenu(){API.hideMenu()}hoverOver(e){let t=API.dom.element(e);t&&(e=new MouseEvent("mouseover",{view:window,bubbles:!0,cancelable:!0}),t.dispatchEvent(e))}clickOn(e=""){let t=e?this.dom.element(e):this.dom.cursor.fetch().HTMLelement;t&&(e=new MouseEvent("click",{view:window,bubbles:!0,cancelable:!0}),t.dispatchEvent(e))}displayTip(e,t={x:100,y:100,from:"bottomLeft"},s=20,n=[]){if("undefined"!=typeof TIPS_manager)return TIPS_manager(e,t,1e3*s,n)}addTip(e,t){var s=API.dom.element("tips");let n=API.dom.element(e);return n?n.innerHTML=t:s&&(n=API.dom.insertElement("div","<p>"+t+"</p>",{id:e,class:"tip hidden"},s,!1,!0)),n}addView(){var n=API.defaultContent("div.part","_unconfigured"),i="_NEW_VIEW_ID",e={id:i,name:"_NEW_VIEW_NAME",class:"part unconfigured",ud_type:"part",ude_edit:"on"};let t=this.dom.element(i);if(!t){t=API.dom.insertElement("div","",e,this.dom.element("document"),!1,!0);let s=API.dom.insertElement("div","",{class:"page",ud_type:"page"},t,!1,!0);var o,a=API.json.parse("UD_system");if(a&&void 0!==a.showHidden){let t=[{tag:"h2",value:"Voir les vues cachées"}];for(let e=0;e<a.showHidden.length;e++){var l=a.showHidden[e];t.push({tag:"span",class:"button",onclick:"API.switchView('"+l+"');",value:l})}e=API.json.putElement({tag:"div",value:t});s.appendChild(e)}for(o in n){let e=n[o],t=e.value;""==t&&""!=e.placeholder&&(t=API.translateTerm(e.placeholder),e.placeholder=t),"="==t[0]&&(t=this.calc.exec(API.translateTerm(t.substring(1),!1))),e.value=t,e.name=i+o;var r=API.json.putElement(e);this.dom.attr(r,"ud_oid","__NONE__"),s.appendChild(r)}}return this.switchView("_NEW_VIEW_NAME","newView"),t}setupView(n="_NEW_VIEW_ID"){let e=API.dom.element(n),t=e.childNodes[0];"page"!=API.dom.attr(t,"ud_type")&&(t=e);let i=t.childNodes,o="";let a="doc",l="standard",r="";for(let s=0;s<i.length;s++){let e=i[s],t=e.textContent;switch(e.id.replace(n,"")){case"name":o=t.replace(/ /g,"-");break;case"describe":t;break;case"type":var d=this.dom.element(n+"type"),d=this.dom.element("select",d);a=d.value;break;case"layout":d=this.dom.element(n+"layout"),d=this.dom.element("select",d);l=d.value;break;case"className":r=" "+t}}for(let e=i.length-1;0<=e;e--)i[e].remove();e.className="part "+a.replace(/ /g,"_")+" LAY_"+l.replace(/ /g,"_")+" "+r;var s=API.getTagOrStyleInfo("div.part."+a,"nextId");API.json.valueByPath(UD_exTagAndClassInfo,"div.part."+a+"/nextId",(parseInt(s,32)+1).toString(32)),e.id=("B"+("00"+s).slice(-2)+"0000000000"+("00000"+this.ud.userId).slice(-5)).toUpperCase(),API.dom.attr(e,"name",o),API.dom.attr(e,"ud_subtype",a),this.ud.viewEvent("createView",e);API.onTrigger(e,"update",API.checkContent);var u=this.dom.element("view-selector"),c=o.toLowerCase().replace(/ /g,"_")+"sel",s="API.switchView( '"+o+"', '"+c+"');";API.dom.insertElement("span",o,{id:c,class:"tab left active",onclick:s,title:o},u,!0,!0)}createUser(e="",t="",s="client",n="UserId",i=""){if(!e){var o=this.dom.elementByName("UserName");if((e=o?o.textContent:"")==this.dom.attr(o,"ude_place")&&(e=""),!o||!e)return API.pageBanner("temp",API.translateTerm("A name is required")),debug({level:1,return:!1},"Can't find UserName")}if(!t){o=this.dom.elementByName("UserEmail");let e=o?o.textContent:"";if(e==this.dom.attr(o,"ude_place")&&(e=""),!o||!e)return API.pageBanner("temp",API.translateTerm("A valid email is required")),debug({level:1,return:!1},"Can't find valid UserEmail")}if(!this.dom.elementByName(n))return API.pageBanner("temp",API.translateTerm("An element to write response is required")),debug({level:1,return:!1},"Can't find id element");var a,i="/webdesk/"+i+"/AJAX_userManager/e|create/out|json/",s={userModel:s},l={form:"INPUT_createUser",input_oid:"Links_User--2-0",nname:e,tpasswd:"",tdomain:"localhost_webdesk",stype:LINKSUSER_login,nemail:t,tparams:JSON.stringify(s)};let r="";for(a in l)r+=a+"="+l[a]+"&";r=r.substring(0,r.length-1);this.ud.udajax.serverRequest(i,"POST",r,{dataTarget:n,dataSource:"id"},this.createUserResponse)}createUserResponse(s,e,t){let n=window.ud.api;var i=n.dom.udjson.parse(e);if(i&&i.success){let e="";i.success?e+='<span class="success">'+i.message+"</span>":e+='<span class="error">'+i.message+"</span>";i=i.data;if(!i)return!1;let t=n.dom.elementByName(s.dataTarget);s=n.json.value(i,s.dataSource);t&&s&&(t.textContent==n.dom.attr(t,"ude_place")?t.textContent=s:t.textContent+=","+s,n.ude.setChanged(t))}else n.pageBanner("temp",e)}prepareUserCreation(){this.ud.udajax.serverRequest("/webdesk//AJAX_userManager/e|arm/out|json/","GET",null,{action:"ignore"})}getOIDbyName(e){e=this.dom.elementByName(e),e=this.dom.getSaveableParent(e);return this.dom.attr(e,"ud_oid")}checkAndWriteValue(t,s,e,n="",i=""){e=e.replace(/this/g,s);if(e&&!this.calc.eval(e))return i?$$$[i]():(i="Error: ",i+=API.translateTerm("Unacceptable value"),API.pageBanner("temp",i)),!1;{let e=this.dom.domvalue.value(t+"._element");return e.textContent=s,API.setChanged(e),n&&("function"==typeof window[n]?window:$$$)[n](),!0}}getRadioValue(e){e=this.dom.element(e);if(!e)return"";var t,e=this.dom.getSaveableParent(e);for(t of this.dom.elements("input[type='radio']",e))if(t.checked)return t.value;return""}}"object"==typeof process&&(module.exports={class:UDapiSet1},void 0===global.JSDOM&&"undefined"==typeof window&&"undefined"==typeof ModuleUnderTest&&(ModuleUnderTest="apiset1.js",console.log("Syntax OK"),console.log("apiset1.js Test completed")));class UDapiSet2{moduleName="apiSet2";ud=null;dom=null;udajax=null;ude=null;calc=null;udeTable=null;udeList=null;udeDraw=null;utilities=null;openMenu=null;menuOffsets=[{top:0,left:0},{top:15,left:-35},{top:0,left:10}];appEventHandlers={};constructor(e){"undefined"==typeof API?(this.ud=e,void 0!==this.ud.ude?this.ude=this.ud.ude:this.ude=ud,this.dom=this.ud.dom,this.udajax=this.ud.udajax,this.calc=this.ude.calc,this.udeTable=this.ude.modules["div.table"].instance):e==API&&(this.ud=API.ud,this.dom=API.dom,this.udajax=API.udajax,this.utilities=API.utilities,API.addFunctions(this,["addMenuOption","toggleMenu","showBotlog","getKeywords","updateZone","deleteDoc","appEvent","listenAppEvent","getLang","replaceBannerWithMenu","setLogoLink","toggleDisplay","contactFromTable","hide"]))}addMenuOption(t,e,s,n){let i=this.dom.element("mainMenu");if(!i)return!1;this.dom.attr(i,"computed_display");i.classList.contains("hidden")&&(this.dom.element("banner").style.display="none",i.classList.remove("hidden"));var o=this.dom.element(t+"Menu");if(!o)return!1;let a=1,l=o,r=5;for(;l!=i&&r--;)l=l.parentNode,a++;let d="";if("main"==t){let t=this.dom.elements("div.menuOption",i);if(3<=t.length){var u=t.length+2;d=Math.floor((97.6-u)/u)+"%";for(let e=0;e<t.length;e++)t[e].style.width=d}var c=this.dom.element("main"),u={id:e+"Menu",class:"hidden optionLevel"+a+" "+e+"Option"};this.dom.insertElement("div","",u,c,!0,!0)}else{let e=this.dom.element("main"+t);e&&e.classList.add("hasSubMenu")}let h="NEVERmain"==t?{class:"menuOption",onmouseenter:n,onmouseout:n}:{id:t+e,class:"menuOption",onclick:n};d&&(h.style="width:"+d+";");s=API.translateTerm(s);return this.dom.insertElement("div",s,h,o,!0,!0),!0}toggleMenu(e,s=null){let n=this.dom.element(e+"Menu");if(!n)return!1;if(n.classList.contains("hidden")){this.openMenu&&this.toggleMenu(this.openMenu.id.replace("Menu",""));let t=-1;n.className.split(" ").forEach(e=>{0==e.indexOf("optionLevel")&&(t=parseInt(e.replace("optionLevel","")))}),console.log("toggle",s.offsetTop,s.offsetLeft),n.style.top=s.offsetTop+this.menuOffsets[t].top+"px",n.style.left=s.offsetLeft+this.menuOffsets[t].left+"px",n.style.width=s.clientWidth,n.classList.remove("hidden"),n.parentNode.classList.add("menuOpen"),this.openMenu=n}else n.parentNode.classList.remove("menuOpen"),n.classList.add("hidden"),this.openMenu=null}showBotlog(t="system-message-popup"){let e=this.dom.element(t);var s=this.dom.element(UD_wellKnownElements.botlog);if(!e||!s)return!1;e.innerHTML==s.innerHTML?e.innerHTML="":(e.innerHTML=s.innerHTML,s=this.dom.elements("br",e).length,e.scrollTop=20*(s-6),e.classList.add("botlogDisplay"),setTimeout(function(){let e=API.dom.element(t);e.classList.remove("botlogDisplay"),e.style.top="50%"}.bind(null,t),5e4))}_getWords(s){let n=[],i="",o=!1;s=s.normalize("NFD").replace(/[\u0300-\u036f]/g,"");for(let t=0;t<s.length;t++){let e=s[t];var a=e.toUpperCase()==e;-1<" .,;?!-_".indexOf(e)?(i&&n.push(i),i=""):a&&!o?(i&&n.push(i),i=""+e):i+=""+e,o=a}return i&&n.push(i),n}_isSignificant(e){var t=API.dom.element("UD_lang").textContent;return!(!e.trim()||-1<UD_insignificantWords[t].indexOf(e))}getKeywords(e){let s=[];var n=this._getWords(e);for(let t=0;t<n.length;t++){let e=n[t];e=window.ud.ude.calc.removeAccentsAndLower(e),this._isSignificant(e)&&s.push(e.toLowerCase())}return s}updateZone(e,t){return this.ud.udajax.updateZone(e,t)}deleteDoc(t=""){if("webdesk"!=UD_SERVICE){t=t||this.dom.attr("document","ud_oid"),console.log("Deleting "+t);var s="";s+="form=INPUT_deleteDoc",s+="&input_oid="+t;var e,n=this.dom.attr("document","ud_oid");n==t?(e="/"+UD_SERVICE+"/",console.log("Deleting "+t+" with "+e),this.ud.udajax.serverRequest(e,"POST",s,{action:"ignore",zone:"",setCursor:!1})):(n="/"+UD_SERVICE+"/"+n+"/AJAX_listContainers/",console.log("Deleting "+t+" with "+n),this.ud.udajax.serverRequest(n,"POST",s,{action:"fill zone",zone:"BE00000000000000M_dirListing",setCursor:!1}))}else{if(!t){var i=$$$.dom.textContent("UD_mode");if(-1==["edit2","edit3"].indexOf(i))return;t=this.dom.attr("document","ud_oid")}let e=t.split("--")[1].split("-");s="UniversalDocElement--"+e.join("-")+"--SP|"+(Math.round(e.length/2)-1),i="/webdesk/"+this.dom.attr("document","ud_oidchildren")+"/AJAX_modelShow/",t=API.translateTerm("Are you sure ?");if(confirm(t)){t={zone:"none",element:null,action:"ignore",setCursor:!1,ud:this.dataSource};let e=this.ud.udajax.serverRequestPromise(i,"POST","form=INPUT_UDE_FETCH&input_oid="+s+"&iaccess=0&tlabel=owns",t);e.then(()=>{var e="/webdesk/"+this.dom.attr("document","ud_oid")+"-21/AJAX_modelShow/",t={zone:this.dom.elementByName("Dir listing").id,element:null,action:"fill zone",setCursor:!1,ud:this.dataSource};this.ud.udajax.serverRequest(e,"GET","",t)})}}}appEvent(e,t={}){let s=this.appEventHandlers[e];s&&s(t)}listenAppEvent(e,t){this.appEventHandlers[e]=t}getLang(e){e=this.dom.element(e);let t=this.dom.attr(e,"ud_lang");return t=t||this.dom.parentAttr(e,"ud_lang"),t=t||this.dom.textContent("UD_lang"),t}replaceBannerWithMenu(e){e=this.buildMenuHTML(e);let t=this.dom.element("menu");t.innerHTML=e,t.classList.remove("hidden");let s=this.dom.element("banner");s.style.display="none";e=document.createElement("link");e.type="text/css",e.rel="stylesheet",e.href="/upload/smartdoc/css/menu.css",document.getElementsByTagName("head")[0].appendChild(e)}buildMenuHTML(e,t="MainMenu",s="mainMenu"){let n="";for(var i in e){var o,a,l=e[i];if("string"==typeof l){n+='<span class="'+s+'">';let e="mobileMenu();";"MainMenu"!=t&&(e+="$$$.toggleDisplay( '"+t+"');"),e+=l,n+='  <a href="javascript:" onclick="'+e+'" title="'+i+'">',n+=i,n+="</a></span>"}else"object"==typeof l&&(o="menu-"+i.replace(/ /g,"-"),n+='<span class="'+s+' hasSubMenu" onclick="$$$.toggleDisplay(\''+o+"', this);\">",n+=i,n+="</span>",a='  <div id="'+o+'" class="subMenu hidden">',a+=this.buildMenuHTML(l,o,"menu-level-2"),a+="  </div>",n+=a)}let r=this.dom.element("mobileMenu");return r&&(r.innerHTML=n.replace(/menu-/g,"mobilemenu-")),n}setLogoLink(e,t=""){var s=this.dom.element("logo"),s=this.dom.element("a",s);return!!s&&(this.dom.attr(s,"onclick",e),this.dom.attr(s,"title",t),!0)}toggleDisplay(e,t=null){let s=this.dom.element(e);t&&(s.style.left=t.offsetLeft+10+"px",s.style.top=t.offsetTop+20+"px"),s.classList.contains("hidden")?$$$.showOneOfClass(s):s.classList.add("hidden")}contactFromTable(s){var n=$$$.findRows(s,".*");let i={name:"",email:"",account:"",developper:"",clients:""};$$$.translateTerm;let o="Contact from<br>";for(let t=0;t<n.length;t++){let e=$$$.getRow(s,n[t]);o+=e.question+": "+e.Value+"<br>",-1<e.question.indexOf("name")&&(i.name+=e.Value+" "),-1<e.question.indexOf("email")&&(i.email=e.Value)}var e={provider:"default",action:"contact",contact:i,body:o};$$$.service("contact",e)}hide(e){let t=this.dom.elementByName(e);t&&t.classList.add("hidden")}}"object"==typeof process&&(module.exports={class:UDapiSet2},void 0===global.JSDOM&&"undefined"==typeof window&&(console.log("Syntax OK"),console.log("Test completed")));class UDapiSet3{moduleName="apiset3.js";ud=null;dom=null;constructor(e=null){"undefined"==typeof API?(this.ud=e,void 0!==this.ud.ude?this.ude=this.ud.ude:this.ude=ud,this.dom=this.ud.dom,this.udajax=this.ud.udajax,this.calc=this.ude.calc,this.udeTable=this.ude.modules["div.table"].instance):e==API&&(this.ud=API.ud,this.dom=API.dom,this.udajax=API.udajax,this.utilities=API.utilities,API.addFunctions(this,["getProgressSVG"]))}getProgressSVG(t,n,i,e){var o=Object.keys(n).length;let a="green";var l=[[30,0],[60,15],[60,45],[30,60],[0,45],[0,15]],r="http://www.w3.org/2000/svg",d=Math.round(60),u=Math.round(60),c=(e-o*d-20)/(o-1);let h=10;var m,p="rgba( 120, 120, 120, 1)";let g=document.createElementNS(r,"svg");g.setAttribute("fill","none"),g.setAttribute("viewBox","0 0 "+e+" "+(u+20)),g.setAttribute("stroke","black"),g.setAttribute("width",e),g.setAttribute("height",u+20);let s=document.createElementNS(r,"marker");s.id="triangle-"+t,s.setAttribute("viewBox","0 0 10 10"),s.setAttribute("refX","0"),s.setAttribute("refY","5"),s.setAttribute("markerWidth","4"),s.setAttribute("markerHeight","3"),s.setAttribute("orient","auto"),s.setAttribute("stroke",p),s.setAttribute("fill",p);let f=document.createElement("path");f.setAttribute("d","M 0 0 L 10 5 L 0 10 z"),f.setAttribute("fill","context-stroke"),s.appendChild(f),g.appendChild(s);let v=1;for(m in n){var b=n[m];let s=document.createElementNS(r,"polygon");s.setAttribute("width",d),s.setAttribute("height",u);for(let t=0;t<l.length;t++){let e=g.createSVGPoint();e.x=Math.round(+l[t][0])+h,e.y=Math.round(+l[t][1])+20,s.points.appendItem(e)}a=i>=b["progress-end"]?"rgba( 0,250,0,1)":i<b["progress-start"]?"rgba( 220,220,220,1)":"rgba( 240,240,100,1)",s.setAttribute("fill",a),s.setAttribute("stroke",a),g.appendChild(s);let e=document.createElementNS("http://www.w3.org/2000/svg","text");if(e.setAttribute("x",h+8*d/20),e.setAttribute("y",20+12*u/20),e.setAttribute("width",20),e.setAttribute("height",20),e.setAttribute("font-family","Arial"),e.setAttribute("font-size","20"),e.setAttribute("fill",p),e.setAttribute("stroke",p),e.setAttribute("stroke-width",.25),e.appendChild(document.createTextNode(v)),g.appendChild(e),v!=t){let e=document.createElementNS("http://www.w3.org/2000/svg","text");e.setAttribute("x",Math.round(h+d/2-4.5*b.label.length)),e.setAttribute("y",18),e.setAttribute("width",2*d),e.setAttribute("height",20),e.setAttribute("font-family","Arial"),e.setAttribute("font-size","18"),e.setAttribute("fill",p),e.setAttribute("stroke",p),e.setAttribute("stroke-width",.25),e.setAttribute("spellcheck","false"),e.appendChild(document.createTextNode(b.label)),g.appendChild(e)}if(v<o){let e=document.createElementNS(r,"line");b=Math.round(u/2)+20;e.setAttribute("x1",h+d),e.setAttribute("y1",b),e.setAttribute("x2",h+d+c-10),e.setAttribute("y2",b),e.setAttribute("stroke","rgba( 160, 160, 160, 1)"),e.setAttribute("fill","rgba( 160, 160, 160, 1)"),e.setAttribute("stroke-width",3),e.setAttribute("marker-end","url(#triangle-"+t+")"),g.appendChild(e)}h+=d+c,v++}return g.innerHTML=g.innerHTML,g}}class UDapitest{ud=null;dom=null;udajax=null;ude=null;calc=null;udeTable=null;udeList=null;udeDraw=null;utilities=null;constructor(e){(this.ud=e)&&(void 0!==e.ude?this.ude=e.ude:this.ude=e,this.dom=e.dom,this.udajax=e.udajax,this.calc=this.ude.calc,this.udeTable=this.ude.modules["div#table"].instance),window.API=this,"object"==typeof process&&(global.API=this)}}"object"==typeof process&&(module.exports={class:UDapi},void 0===global.JSDOM&&"undefined"==typeof window&&(console.log("Syntax OK"),console.log("End of auto-test program")));class UDapi{delimiters=" \n\t=+-*/;,&()'\"{}[]:";keepDelimiters="=+-*/;,&()'";fctMap={};detectErrors=!1;availableModules=null;loadable=null;argsLoadable={};calc_cmds=["redoDependencies","toggleSwitch"];ud_cmds=["setModel","copyModel","makeDirectory","translateTerm","onTrigger","docParameter","reload","fetchElement"];clipboard_cmds=["clipElement"];local_cmds=["insertRow","showOneOfClass","setChanged","loadStyle","copyPortion","grabPortionList","pageBanner","grabFromTable","loadModule","service","calculate","addCalculatorFunction","showNextInList","showFirstInList","LED","env","switchHighlight","setupUDElinks","listAPI","getShortcut","raiseErrors","ignoreErrors","poll","isFunction"];afterClick={Styler:"leftColumn.closeAll();"};ud=null;dom=null;udjson=null;udajax=null;ude=null;calc=null;utilities=null;buffer=null;expr;order;litteral;initial_state=1;litteral_state=2;argument_state=3;argumentFct_state=4;valueSet_state=5;state=0;stateStack=[];bannerStack=[];bannerZone="";bannerTimeoutId=-1;valueSetFctLevel=0;clipboardFctsAdded=!1;utilityFctsAdded=!1;unknownCalls=[];constructor(e){(this.ud=e)&&(void 0!==e.ude&&e.ude?(this.ude=e.ude,this.calc=this.ude.calc):this.ude=e,this.dom=e.dom,this.udjson=e.dom.udjson,this.cursor=e.dom.cursor,this.udajax=e.udajax,e.apiBuffer_requests&&(this.buffer=this.dom.element(e.apiBuffer_requests))),this.addFunctions(this,this.local_cmds),this.addFunctions(this.ud,this.ud_cmds),this.bannerZone=document.getElementById("bannerMessage"),window.API=this,"object"==typeof process&&(API=this),this.dom&&this.dom.udjson&&(API.json=this.dom.udjson),this.set1=new UDapiSet1(this),void 0!==UDapiSet2&&(this.set2=new UDapiSet2(this)),void 0!==UDapiSet3&&(this.set3=new UDapiSet3(this)),"function"==typeof UD_ressources_init&&UD_ressources_init(this.ud,this),"function"==typeof UD_content_init&&UD_content_init(this.ud),"function"==typeof UDutilities_init&&(this.utilities=UDutilities_init(this.ud,this)),"undefined"==typeof process&&setTimeout(function(){API.botlogUpdate("server")},300),void 0!==window.udjson&&(API.udjson=window.udjson)}setupUDElinks(e){API.ude=e,API.calc=e.calc,this.set1.ude=e,this.set1.calc=e.calc}addFunctions(t,s){for(let e=0;e<s.length;e++){var n=s[e];this.fctMap[n]=t}}poll(e=0){for(var t,s,n,i,o="";t=this.getNextRequest();)debug({level:2},"API request",t),t.indexOf(";")?(s=(t=t.split("|"))[0],n=t[1].replace(/@8/g,":").replace(/@1/g,"@"),i=t[2],o+=this.run([n]),i&&isNaN(i)&&(document.getElementById(i).textContent+=s+":"+o+"\n"),this.processAfterClick(s)):t.indexOf(".");return o}getNextRequest(){if(!this.buffer)return"";var e;if(0<=(e=(s=this.buffer.textContent).indexOf("\n"))){var t=s.substr(0,e),s=s.substr(e+1);return this.buffer.textContent=s,t}return""}run(commands){var r="",cmdi;for(cmdi in commands){var command=commands[cmdi];return(this.order="",this.state=this.initial_state,this.prepareForExec(command),-1<this.order.indexOf("ERR:"))?"ERR":(r+=eval(this.order),debug({level:4},"Ran ",this.order),r)}}eval(e){if(""==e||!isNaN(e)||"'"==this.expr.charAt(0)&&"'"==this.expr.charAt(this.expr.length-1)||'"'==this.expr.charAt(0)&&'"'==this.expr.charAt(this.expr.length-1))return e;e=this.calc.exec(this.expr);return isNaN(e)?'"'+e+'"':e}addTokenToOrder(e,t){return this.state==this.litteral_state?(this.expr+=e+t,t==this.litteral&&(this.state=this.stateStack.pop())):this.state==this.argument_state?"("==t?(this.expr+=e+t,this.stateStack.push(this.state),this.state=this.argumentFct_state):")"==t?(this.expr+=""+e,this.order+=this.eval(this.expr)+t,this.expr="",this.state=this.stateStack.pop()):","==t?(this.expr+=""+e,this.order+=this.eval(this.expr)+t,this.expr=""):"{"==t?(this.state!=this.valueSet_state&&(this.order+="JSON.parse('{"),this.stateStack.push(this.state),this.state=this.valueSet_state,this.expr=""):"'"==t||'"'==t?(this.stateStack.push(this.state),this.state=this.litteral_state,this.litteral=t,this.expr=t):this.expr+=""+e+t:this.state==this.initial_state?"("==t?(this.order+="API."+e+t,this.stateStack.push(this.state),this.state=this.argument_state,this.expr=""):this.order+=t:(this.state=this.valueSet_state)?"}"==t?(this.expr+=e,this.order+=this.eval(this.expr)+t,this.state=this.stateStack.pop(),this.state!=this.valueSet_state&&(this.order+="')"),this.expr=""):":"==t?this.order+='"'+e+'"'+t:"("==t?(this.valueSetFctLevel++,this.expr+=e+t):")"==t?(this.expr+=""+e+t,0==--this.valueSetFctLevel&&(this.order+=this.eval(this.expr),this.expr="")):","==t?(this.expr+=""+e,0==this.valueSetFctLevel?(this.order+=this.eval(this.expr)+t,this.expr=""):this.expr+=t):this.expr+=e+t:this.state==this.argumentFct_state&&(this.expr+=""+e+t,"("==t?this.stateStack.push(this.state):")"==t&&(this.state=this.stateStack.pop())),""}prepareForExec(e){var t=this.expr=this.order="";this.state=this.initial_state;for(var s=this.valueSetFctLevel=0;s<e.length;s++){var n=e[s];-1<this.delimiters.indexOf(n)?t=this.addTokenToOrder(t,n):t+=n}return t&&this.addTokenToOrder(t,null),this.stateStack.length&&debug({level:1},"Order incomplete"+e),!0}nlp(e){}processAfterClick(source){void 0!==this.afterClick[source]&&eval(this.afterClick[source])}insertRow(e,t,s,n=!0){var i=document.getElementById(e);if(!i)return debug({level:2,return:null},"No table",e);if(!this.ude.tableEd)return debug({level:2,return:null},"No table editor",e);n=this.ude.tableEd.insertRow(e,t,s,n);return this.ude.tableEd.update(e,!0),this.ude.setChanged(i),API.redoDependencies(),n}showOneOfClass(e,t){return this.showOnePortion(e,t)}showOnePortion(e,t){let s=this.dom.element(e);if(s=s||this.dom.element("div.part[name='"+e+"']",this.dom.element("document")),!s)return debug({level:2,return:null},"can't find element in UDAPI.showOneOfClass()",e);var n=s.id;if("div"==s.tagName.toLowerCase()){s.classList.remove("hidden");for(var i=$$$.dom.elements("div."+s.classList.item(0),s.parentNode),o=0;o<i.length;o++){var a=i[o];a.id==n||a.classList.contains("hidden")||a.classList.add("hidden")}s.classList.contains("part")&&this.ude.followScroll(0)}else if(-1<["h1","h2","h3","h4"].indexOf(s.tagName.toLowerCase()))for(var l=s.tagName.toLowerCase(),r=["h1","h2","h3","h4"].indexOf(s.tagName.toLowerCase()),d="ignore",u=this.dom.children(s.parentNode),c=0;c<u.length;c++){var h=u[c];if(h.tagName.toLowerCase()==l)d=h==s?"expand":"collapse";else if(["h1","h2","h3","h4"].indexOf(s.tagName.toLowerCase())<r)d="ignore";else switch(d){case"ignore":break;case"collapse":h.classList.add("hidden");break;case"expand":h.classList.contains("hidden")?h.classList.remove("hidden"):h.classList.add("hidden")}}let m=document.getElementById("scroll");return m&&s.classList.contains("part")&&(m.scrollTop=0,window.scroll(0,0)),s}activateOneOfClass(e,t=0){var s=this.dom.element(e);if(!s)return debug({level:2,return:null},"can't find element in UDapi;activateOneOfClass()",e);let n=s.classList,i="";for(let e=0;e<n.length;e++)-1==["left","right","active"].indexOf(n.item(e))&&(i=n[e]);if(i){var e=s.parentNode,o=this.dom.elements("."+i,e);for(let t=0;t<o.length;t++){let e=o[t];e==s?e.classList.add("active"):e.classList.remove("active")}}}setChanged(e){let t=this.dom.element(e);return t||(t=API.dom.element("[name='"+e+"']","document"),t&&API.dom.attr(t,"ud_oid"))?this.ude.setChanged(t,1):debug({level:2,return:null},"can't find saveable element in UDapi.setChanged()",e)}loadStyle(e){var t=document.getElementById(e);if(!t)return debug({level:2,return:null},"can't find element in UDapi.loadStyle()",e);t=t.textContent;let s=document.createElement("style");return s.appendChild(document.createTextNode(t)),document.head.appendChild(s),s.sheet}copyPortion(e,t,s="",n=null,i=null){n=n||{h3:{style:"titleButton",tag:"h3"},h2:{style:"helpTitle",tag:"h2"}},i=i||"$$$.showOneOfClass";let o=document.getElementById(t);if(!o)return debug({level:2,return:null},"can't find element in UDapi.grabContent()",t);t=document.getElementById(e);if(!t)return debug({level:2,return:null},"can't find element in UDapi.grabContent()",e);if(s){let e=document.getElementById(s);if(e=e||o.previousSibling,!e)return debug({level:2,return:null},"can't find element in UDapi.grabContent()",s);e.innerHTML=t.innerHTML}let a=this.grabPortion(t).inn;o.innerHTML="";let l=null;for(var r,d=0;d<a.length;d++)1==a[d].nodeType&&((r=a[d].cloneNode(!0)).id+="_copied",o.appendChild(r),this.mapClassAndTag(r,n),"titleButton"==r.className&&(r.setAttribute("onclick",i+"( '"+r.id+"', 1);"),l=l||r));l&&this.showOnePortion(l.id,!0),"undefined"==typeof process&&window.scroll(0,0)}mapClassAndTag(e,t){var s=e.tagName.toLowerCase();t&&t[s]&&(t[s].style&&(e.className=t[s].style),t[s].tag!=e.tagName.toLowerCase()&&this.dom.changeTag(e,t[s].tag,""))}grabPortionList(e,t,s){var n=this.dom.udjson.value(s,"headerId");let i=this.dom.udjson.value(s,"tagListStr"),o=null,a=this.dom.udjson.value(s,"mode");a=a||"list";let l=i.split(","),r=this.dom.element(t);if(r=r||this.dom.element("[name='"+t+"']","document"),!r)return debug({level:2,return:null},"can't find element in UDapi.grabPortionList()",t);let d=this.dom.element(e);if(d=d||this.dom.element("[name='"+e+"']","document"),!d)return debug({level:2,return:null},"can't find element in UDapi.grabPortionList()",e);if(n){let e=this.dom.element(n);if(e=e||this.dom.element("[name='"+n+"']",d),!e)return debug({level:2,return:null},"can't find header in UDapi.grabPortionList()",n);o=d.querySelector("div h1"),o?e.innerHTML=o.innerHTML:e.innerHTML="Home"}let u="{details}",c=0,h=document.createElement("div");if("titles"==a){var m=this.dom.children(d);for(let e=0;e<m.length;e++){let t=m[e];if(1==t.nodeType){var p=t.tagName.toLowerCase();if(!l.length||-1<l.indexOf(p)){var g=t.id+"_copy",f="<"+p+' id="'+g+'">';f+='<a href="javascript:" class= "sleepingButton" udapi_value1="'+t.id+'" udapi_quotes="//"',f+=' onclick="'+("API.showOneOfClass( '"+g+"',1);")+'">',f+=t.textContent,f+="</a></"+p+">",u+=f;var v,b=this.grabPortion(t).inn;let s=null;for(let t=0;t<b.length;t++){let e=b[t];1==e.nodeType&&((v=e.cloneNode(!0)).id+="_copy",v.classList.add("hidden"),u+=v.outerHTML,"titleButton"==v.className&&(v.setAttribute("onclick","API.showOneOfClass( '"+v.id+"', 1);"),s=s||v))}c++}else if(!c&&t!=o){let e=t.cloneNode(!0);e.id=e.id+"_copy",this.dom.attr(e,"ud_oid",""),u+=e.outerHTML}}}}else{u+='<ul class="portionList">';var x=this.dom.children(d);for(let e=0;e<x.length;e++){let t=x[e];if(1==t.nodeType)if(!l.length||-1<l.indexOf(t.tagName.toLowerCase())){var y='<li><a href="javascript:" class= "sleepingButton" udapi_value1="'+t.id+'" udapi_quotes="//"';y+=' onclick="'+(this.dom.udjson.value(s,"callback")+"('chapter', this);")+'">',y+=t.textContent,y+="</a></li>",u+=y,c++}else if(!c&&t!=o){let e=t.cloneNode(!0);e.id="Copy of "+e.id,this.dom.attr(e,"ud_oid",""),h.appendChild(e)}}u+="</ul>"}u=u.replace("{details}",h.innerHTML),r.innerHTML=u,r.setAttribute("contenteditable","false"),window.scroll(0,0)}grabPortion(e){let s=[],n=[],t=[];if("div"==e.tagName.toLowerCase()){let t=e.childNodes;for(var i in t)s.push(t[i]);for(var o in t=e.parentNode.getElementsByClassName(e.classList.item(0)),t){if(isNaN(o))break;let e=t[o];e.id==id||e.classList.contains("hidden")||n.push(e)}}else if(-1<["h1","h2","h3","h4","h5"].indexOf(e.tagName.toLowerCase()))for(var a=e.tagName.toLowerCase(),l=["h1","h2","h3","h4","h5"].indexOf(e.tagName.toLowerCase()),r="ignore",d=this.dom.siblings(e),u=0;u<d.length;u++){var c=d[u];if(c.tagName.toLowerCase()==a)r=c==e?"in":"out",t.push(c);else if(["h1","h2","h3","h4","h5"].indexOf(e.tagName.toLowerCase())<l)r="ignore",s.push(c);else switch(r){case"ignore":break;case"in":s.push(c);break;case"out":n.push(c)}}return{inn:s,out:n,bound:t}}pageBanner(e,t=""){switch(void 0===this.bannerStack&&(this.bannerStack=[],this.bannerZone=document.getElementById("bannerMessage"),this.bannerTimeoutId=-1),e){case"clear":if(0==this.bannerStack.length)return debug({level:2,return:!1},"Nothing in banner stack on clear in API pageBanner()");this.bannerZone.innerHTML=this.bannerStack.pop(),this.bannerTimeoutId=-1,this.bannerStack.length&&(this.bannerTimeoutId=setTimeout(function(){n.pageBanner("clear")},5e3));break;case"set":if(!t)return debug({level:2,return:!1},"Can't write nothing to banner, use clear instead in API pageBanner()");"="==t.charAt(0)&&(t=this.calc.exec(t.substr(1)));var s=this.bannerZone.innerHTML;""!=s&&"Banner zone"!=s&&this.bannerStack.push(this.bannerZone.innerHTML),this.bannerZone.innerHTML=t;break;case"tmp":case"temp":if(!t)return debug({level:2,return:!1},"Can't write nothing to banner, use clear instead in API pageBanner()");"="==t.charAt(0)&&(t=this.calc.exec(t.substr(1))),this.bannerStack.length||this.bannerStack.push(this.bannerZone.innerHTML),this.bannerZone.innerHTML=t;var n=this;-1<this.bannerTimeoutId&&clearTimeout(this.bannerTimeoutId),this.bannerTimeoutId=setTimeout(function(){n.pageBanner("clear")},1e4)}}grabFromTable(e,t,s){let n=this.dom.element(e);if(!n)return debug({level:2,return:null},"can't find element",e);let i=this.dom.element(t);if(!i)return debug({level:2,return:null},"can't find table",t);var o=i.rows[0].cells;let a=[];for(let e=0;e<o.length;e++)a.push(this.dom.attr(o[e],"_type")+o[e].textContent);var l=a.indexOf(s);if(-1==l)return debug({level:2,return:null},"can't find column in table",s,tableId);var r=i.getElementsByTagName("tbody")[0].rows;let d="";for(let e=0;e<r.length;e++)d+=r[e].cells[l].innerHTML;d&&(n.innerHTML=d)}loadModule(e,t,s=""){e=e+"/"+t+".js";this.ude.loadScript("modules/"+e,s=s||"window.ud.ude.modules['modules/"+e+"']['instance'] = new "+t+"();")}async servicePromise(e,t,s=!0){var n="SetOfValues--16--nname|{service}%20service".replace("{service}",e);let i=t;if("object"!=typeof t&&(i=JSON.parse(t)),!i)return!1;i.service=e,i.process=$$$.dom.textContent("UD_model"),i.task=this.dom.textContent("UD_dbName");t="/"+UD_SERVICE+"/"+n+"/AJAX_service/",n={dataTarget:i.dataTarget,dataSource:i.dataSource,dataMap:i.dataMap,dataReplace:i.dataReplace,service:e,waitPopup:!0},e="form=INPUT_Service"+e+"&input_oid=SetOfValues--16-0&nServiceRequest="+encodeURIComponent(JSON.stringify(i));if(s)return this.ud.udajax.serverRequestPromise(t,"POST",e,n,this.serviceResponse);this.ud.udajax.serverRequest(t,"POST",e,n,this.serviceResponse)}service(e,t){var s="SetOfValues--16--nname|{service}%20service".replace("{service}",e);let n=t;if("object"!=typeof t&&(n=JSON.parse(t)),!n)return!1;n.service=e,n.process=$$$.dom.textContent("UD_model"),n.task=this.dom.textContent("UD_dbName");t="/"+UD_SERVICE+"/"+s+"/AJAX_service/",s={dataTarget:n.dataTarget,dataSource:n.dataSource,dataMap:n.dataMap,dataReplace:n.dataReplace,service:e},e="form=INPUT_Service&input_oid=SetOfValues--16-0&nServiceRequest="+encodeURIComponent(JSON.stringify(n));return this.ud.udajax.serverRequest(t,"POST",e,s,this.serviceResponse),!0}serviceResponse(t,e,s){let i=window.ud.api;var o=i.dom.udjson.parse(e);if(o){let e="";if(!o.success)return e+='<span class="error">'+o.message+"</span>",i.pageBanner("temp",e),void $$$.botlog(t.service,!1,"Error service "+t.service+": "+o.message);e+='<span class="success">'+o.message+"</span>",$$$.pageBanner("temp",e),$$$.botlog(t.service,!1,"Service "+t.service+": success");var a=o.data;if(a){var l=t.dataTarget,r=t.dataSource,n=t.dataMap;if(l&&r){let e=i.dom.element(l);e=e||i.dom.elementByName(l);let n="value"==r?o.value:i.json.value(a,r);if(e&&n)if("div.part"==i.dom.attr(e,"exTag")){if("object"==typeof n&&Array.isArray(n)){let t=e.textContent;r=i.dom.children(e);let s=r[r.length-1];for(let e=0;e<n.length;e++){var d=n[e];t.indexOf(d)<0&&(s=$$$.insertElement("p",d,{},s,!0))}}}else t.dataReplace||"UD_spare"==l||!e.textContent||e.textContent==i.dom.attr(e,"ude_place")||null==e.textContent||"null"==e.textContent?("object"==typeof n&&(n=JSON.stringify(n)),e.textContent=n,i.ude.setChanged(e)):e.textContent!=n&&(e.textContent+=","+n,i.ude.setChanged(e))}else if(l&&void 0!==n&&Object.keys(n).length){let e=i.json.parse(l);for(var u in n){var c=i.json.valueByPath(a,u);e=c?i.json.valueByPath(e,n[u],c):i.json.valueByPath(e,n[u],i.translateTerm("No value")),i.dom.element(l).textContent=JSON.stringify(e),i.ude.setChanged(l)}}t.promise&&t.resolve(t)}}else i.pageBanner("temp",e)}calculate(e){return this.calc.eval(e)}addCalculatorFunction(e,t){let s=this.calc;return void 0===s[e]&&(s[e]=t,s.localFunctions.push(e),!0)}showNextInList(e){let t,s;for(t=0;t<e.length;t++)if(s=this.dom.element(e[t]),!s.classList.contains("hidden")){s.classList.add("hidden");let e=this.dom.element("tr.rowModel",s);e&&(e.style.display="unset");break}if(s=t>=e.length-1?this.dom.element(e[0]):this.dom.element(e[t+1]),s){s.classList.remove("hidden");let e=this.dom.element("tr.rowModel",s);e&&(e.style.display="block")}}showFirstInList(t){let s=this.dom.element(t[0]);if(s){s.classList.remove("hidden");for(let e=1;e<t.length;e++)s=this.dom.element(t[e]),s&&s.classList.add("hidden")}}LED(e,t){let s=document.getElementById(e);if(s&&"circle"==s.tagName.toLowerCase()){let e=t?"lightgreen":"pink";s.setAttribute("stroke",e),s.setAttribute("fill",e)}}env(e,t){t="/"+this.ud.service+"//AJAX_fetch/"+e+"|"+t+"/";this.ud.udajax.serverRequest(t,"GET","",{action:"ignore"})}switchHighlight(e){let t=null;t="string"==typeof e?this.dom.element(e):e,t&&(t.classList.contains("highlight")?t.classList.remove("highlight"):t.classList.add("highlight"))}listAPI(e=null){let t='<ul class="listAPI">',s="";for(var n in this.fctMap){t+="<li>"+n+"<li>";var i=this.fctMap[n];s+=n+","+i.constructor.name+"\n"}let o=API.dom,a=Object.getOwnPropertyNames(Object.getPrototypeOf(o));for(let e=0;e<a.length;e++){var l=a[e];"function"==typeof o[l]&&"constructor"!=l&&(t+="<li>"+l+"<li>",s+="dom."+l+",dom\n")}o=API.dom.cursor,a=Object.getOwnPropertyNames(Object.getPrototypeOf(o));for(let e=0;e<a.length;e++){var r=a[e];"function"==typeof o[r]&&"constructor"!=r&&(t+="<li>"+r+"<li>",s+="dom.cursor."+r+",dom.cursor\n")}o=API.dom.udjson,a=Object.getOwnPropertyNames(Object.getPrototypeOf(o));for(let e=0;e<a.length;e++){var d=a[e];"function"==typeof o[d]&&"constructor"!=d&&(t+="<li>"+d+"<li>",s+="dom.udjson."+d+",udjson\n")}if(t+="</ul>",!e)return console.log(s),t}getShortcut(t,s=""){if(s=s||this.fctMap[t]){let e=s[t];return e.bind(s)}return function(...e){if(!this.detectErrors)return e[0];console.log("ERR no "+t)}}raiseErrors(){this.detectErrors=!0}ignoreErrors(){this.detectErrors=!1}isLoadable(e){let t="";for(var s in this.availableModules)if(this.availableModules[s]&&-1<this.availableModules[s].indexOf(e)){t=s;break}return t?"modules/$$$/"+t:(this.loadable||(this.loadable=$$$.json.parse("UD_loadable")),$$$.json.value(this.loadable,e))}insertElement(){var e=this.ude.insertElement(arguments[0],arguments[1],arguments[2],arguments[3],arguments[4],arguments[5]);this.ude.initialiseElement(e.id)}removeChildren(e){return this.utilities.removeChildren(e)}followScroll(e){return this.ude.followScroll(e)}changeClass(){return this.ude.changeClass(arguments[0],arguments[1],arguments[2])}reload(){return this.ud.reload(arguments[0],arguments[1],arguments[2])}dom(){return this.dom}loadFcts(t){let s=[],n="";for(let e=0;e<t.length;e++){var i,o=t[e];void 0===this.fctMap[o]&&((i=this.isLoadable(o))?-1==s.indexOf(i)&&s.push(i+version):n+=o+" ")}return n?n.trim():!s.length||(require(s),!1)}loadAndRun(t,e){let s=[];for(let e=0;e<t.length;e++){var n=t[e];void 0!==this.fctMap[n]||(n=this.isLoadable(n))&&-1==s.indexOf(n)&&s.push(n+version)}require(s,e)}isFunction(e){return"object"==typeof this.fctMap[e]}}class Deferred{constructor(){this.promise=new Promise((e,t)=>{this.reject=t,this.resolve=e})}}function setupAPI(e){let o=new UDapi(e);return API=new Proxy(o,{get:function(e,s,t){let n=e.fctMap[s];if(n)return function(...e){return n[s].apply(n,e)};{let t=e[s];if("function"==typeof t)return function(...e){return t.apply(this,e)};if(void 0!==t)return t;{var i=!e.detectErrors;let t=e.isLoadable(s);return t?function(...e){o.argsLoadable[s]=e,require([t+version],function(){return $$$[s](...o.argsLoadable[s])})}:i?function(...e){return debug({level:5},"Unactivated hook ",s),e[0]}:function(){var e,t="ERR 450 - Unknown function call "+s+"()";return debug({level:2},t),-1==this.unknownCalls.indexOf(s)&&(this.unknownCalls.push(s),(e=this.dom.element("UD_debug"))&&10<parseInt(e.textContent)&&alert(t)),null}}}}}),$$$=API,UDLIB=API,API}if("object"==typeof process)if(void 0===global.JSDOM&&"undefined"==typeof window&&"undefined"==typeof ModuleUnderTest){ModuleUnderTest="udapi.js",console.log("Syntax OK");const api1=require("./apiset1.js"),UDapiSet1=api1.class;module.exports={class:UDapi,SET1:UDapiSet1,init:setupAPI};const envMod=require("../tests/testenv.js");envMod.load();const ud=new UniversalDoc("document",!0,133);ud.api?console.log("API loaded : OK"):(console.log("API loaded : KO"),process.exit(-1));let r=API.insertRow("myTable",0,{val1:32,val2:"text",val3:"dom...value"});r?console.log("Test insertRow : OK"):console.log("Test insertRow : KO"),r=API.copyPortion("source_h1a","target"),-1<document.getElementById("target").outerHTML.indexOf("helpTitle")?console.log("Test copyPortion : OK"):console.log("Test copyPortion : KO");{let test="API wrapping good & bad functions";API.raiseErrors();let r1=API.badFct("abc"),r2=API.calculate("2+3");testResult(test,(null==r1||-1<r1.indexOf("ERR"))&5==r2,API)}console.log("udapi.js Test completed"),process.exit()}else{const api1=require("./apiset1.js"),UDapiSet1=api1.class;module.exports={class:UDapi,SET1:UDapiSet1,init:setupAPI}}class UD_content{info;constructor(){this.info=UD_exTagAndClassInfo,void 0!==window.API&&window.API.addFunctions(this,["updateContentAfterEvent","checkContent","replaceModelInElement","extractDataFromContent","getUndefinedElementContent"])}getUndefinedElementContent(t){let s=$$$.dom,a=$$$.json.value;var n=s.element(t),t=s.getSaveableParent(n);if(n&&t){var t=s.getEditableParent(n),l=s.getSelector(n);let e=s.attr(n,"exTag");var n=e.split("."),r=$$$.availableTags(t);let i={};let o="";2==n.length&&(o=n[1]);for(let e=0;e<r.length;e++){let n=r[e];if("p.undefined"!=n){var d=$$$.getTagOrStyleInfo(n);let e="EN"!=lang?a(d,"label_"+lang):"";e=e||a(d,"label");var u=a(d,"icon");let t=2;"h1"==n?t=3:"h2"==n&&(t=2.5);var c=u?[{tag:"img",src:UDincludePath+"resources/images/"+u,style:"width:"+t+"em;"},{value:" "}]:{value:e};let s=n.split(".");o&&(s[1]!=o||s.length<3)||!o&&2<s.length||(d=s.slice(0,2).join("."),u=2<s.length?s[2]:"",i[e]={tag:"a",class:"panel-block",onclick:"let el = $$$.changeTag( '"+d+"', "+l+", '"+u+"'); $$$.displayMenu( el);",title:e,value:c})}}n={tag:"div",class:"panel-block is-wrapped",value:i};return API.json.putElement(n,!1).outerHTML}}updateContentAfterEvent(i,o=null){let a=API.dom,l=API.json.value,r=a.element(i);var d=a.getSaveableParent(r);if(d){let n=a.attr(d,"exTagType");var u=o?o.eventType:"";let e=!1;if(e="emptyView"==u||"update"==u||("changeTag"==u&&API.hasDefaultContent(d,o.oldTag)||"changeClass"==u&&API.hasDefaultContent(d,n,o.oldClass)),e){let s=r.classList;for(let t=0;t<s.length;t++){let e=s.item(t);if(0==e.indexOf("LAY_")){e;break}}let e=!1,t=l(this.info,n);"div.part"==n&&(t=l(this.info,n+"."+a.attr(r,"ud_subtype")));var c=l(t,"defaultContentPath");if(!c||(i=a.keepPermanentClass(d.className))&&(u=l(t,"defaultContentByClassOrViewType"),(u=l(u,i))&&(i=a.attr(d,"name"),a.udjson.valueByPath(i+"_object",c,u),$$$.initialiseElement(d),e=!0)),!e){let e=l(t,"defaultContent");if("__UNDEFINED__"==e&&(e=this.getUndefinedElementContent(d)),o.newClass&&(d=l(t,"defaultContentByClassOrViewType"),(d=l(d,o.newClass))&&(e=d)),e=e||{para:{tag:"p",value:"..."}},-1<n.indexOf("div.part")||"div.zone"==n)return this.setViewContent(r,e);r.innerHTML=API.json.toHTML(e),$$$.dom.attr(r,"ude_place",r.textContent)}}}}checkContent(e){return this.updateContentAfterEvent(e,{eventType:"update"})}setViewContent(e,t){var s,e=API.dom.element(e);let n=e,i=API.dom,o=e.childNodes;"div.page"==API.dom.attr(o[0],"exTag")&&(n=o[0],o=n.childNodes);let a=0,l=!0;for(s in t){var r=t[s];if(a>=o.length||r.tag+"."+r.type!=API.dom.attr(o[a],"exTag")){l=!1;break}a++}if(!l){for(var d in t){var u=API.json.putElement(t[d],!1);if(n.appendChild(u),"span"!=i.attr(u,"exTag")){"object"!=typeof process&&window.ud.viewEvent("create",u);d=i.children(u);let e=null;d.length&&(e=function(e){let t=window.ud.dom;var s=e.childNodes;for(let e=0;e<s.length;e++){var n=s[e];"span.caption"!=t.attr(n,"exTag")&&"object"!=typeof process&&(window.ud.viewEvent("create",n),n.id&&"DIV"==n.tagName&&$$$.initialiseElement(n.id))}}),console.log("Update",u.id,e),e&&API.dom.attr(u,"ud_onupdate",API.onTrigger(u.id,"update",e))}}for(let t=0;t<o.length;t++){let e=o[t];e.nodeType==Node.TEXT_NODE?e.remove():window.ud.viewEvent("remove",o[t])}}}replaceModelInElement(e,t,s){let n=API.dom.element(e);e=n.innerHTML,t=this.extractDataFromContent(e,t);if(0==Object.keys(t).length)return e;s=API.dom.element(s+"viewZone").innerHTML,t=API.calc.substitute(s,t);return n.innerHTML=t,API.setChanged(n),t}extractDataFromContent(t,e){let s=[],n=[];let i=API.dom.element(e+"viewZone").innerHTML;{let e=0,t=i.indexOf("{",e);for(;-1<t;){var o=i.indexOf("}",t);if(o<=0)break;n.push(i.substring(t+1,o));var a=i.indexOf("{",o);s.push(i.substring(e,t)),-1<a?s.push(i.substring(o+1,a)):s.push(i.substring(o+1)),t=a,e=o+1}}let l={};for(let e=0;e<n.length;e++){var r=s[2*e],d=t.indexOf(r),u=t.indexOf(s[2*e+1]);l[n[e]]=-1<d&&-1<u?t.substring(d+r.length,u):""}return l}isDefaultContent(e){return API.hasDefaultContent(e)}}function UD_content_init(){return new UD_content(window.ud)}if("object"==typeof process&&(module.exports={class:UD_content,init:UD_content_init},void 0===global.JSDOM&&"undefined"==typeof window&&"undefined"==typeof ModuleUnderTest)){console.log("Syntax:OK"),console.log("Start of UD_ressources class test program"),console.log("Setting up browser (client) test environment"),ModuleUnderTest="udcontent";let path="..";const testMod=require(path+"/tests/testenv.js");testMod.load([]);let ud=new UniversalDoc("document",!0,133);{let test="1 - view setup with checkContent",view=API.dom.elementByName("view2");view&&(view.classList.add("LAY_thirds"),API.checkContent(view)),console.log(view.innerHTML),testResult(test,view&&-1<view.innerHTML.indexOf("zone"),view)}console.log("Test completed"),process.exit()}class UDJSON{dom;textCol1="n°";textCol2="text";attrMap={label:"name",href:"href",src:"src",onclick:"onclick",class:"class",style:"style",formula:"ude_formula",placeholder:"ude_place",type:"ud_type",subType:"ud_subtype",mime:"ud_mime",stage:"ude_stage",menu:"ude_menu",autosave:"ude_autosave",edit:"ude_edit",bind:"ude_bind",datasrc:"ude_datasrc",follow:"ud_follow",valid:"ude_onvalid",invalid:"ude_oninvalid",title:"title",offset:"ud_offset",validate:"ude_validate",accept:"ude_accept",width:"width",height:"height",x:"x",y:"y",ui:"ude_ui",val:"value",inputType:"type",checked:"checked",spell:"spellcheck",max:"max"};tempClasses=["editing","edcontainer","edinside"];lastJSONkeys=[];use_onclick=!1;use_onclick_el="";mode="";jsonComments={};constructor(e){this.dom=e,this.mode=this.dom.element("UD_mode").textContent}read(e,t,s=""){return this.value(e,t,null,s)}readFromDiv(e,t,s=""){return this.value(e,t,null,s)}write(e,t,s,n){return this.value(e,t,s,n)}writeToDiv(e,t,s,n){return this.value(e,t,s,n)}value(n,i,o=null,a=""){if(void 0===this)return window.udjson.value(n,i,o,a);let l=null,r=null;if("string"==typeof n){if(""==n)return null;l=n.length<48&&"{"!=n[0]&&(r=this.dom.element(n))?this.parse(r.textContent):this.parse(n)}else"object"==typeof n&&(l=n);if(l&&void 0!==l[i]&&null==o&&!a)return l[i];if(l&&null==o&&!a)return"";if(l){let e="",t=-1,s=l[i];switch(a){case"":case"set":l[i]=o;break;case"replace":"string"==typeof l[i]&&(l[i]=l[i].replace(o[0],o[1]));break;case"delete":delete l[i];break;case"addToCSV":if(s=s?s.split(","):[],t=s.indexOf(o),-1<t)break;s.push(o),l[i]=s.join(",");break;case"removeFromCSV":if(s=s?s.split(","):[],t=s.indexOf(o),-1==t)break;s.splice(t,1),l[i]=s.join(",");break;case"add":if(void 0===s.length)break;if(t=s.indexOf(o),-1<t)break;s.push(o),l[i]=s;break;case"remove":if(void 0===s.length)break;if(t=s.indexOf(o),-1==t)break;s.splice(t,1),l[i]=s;break;case"incrementAfter":e=l[i]++;break;case"incrementAfterBase32":e=l[i],l[i]=(parseInt(e,32)+1).toString(32)}return"string"==typeof n&&(l=JSON.stringify(l)),r&&(r.textContent=l),""!=e?e:l}return""}parse(e){let t=null,s=e,n=null;-1==e.indexOf("{")&&e.length<48&&(n=this.dom.element(e))&&(s=n.textContent);try{t=JSON.parse(s)}catch(e){debug({level:4},"Can't parse JSON string ",e,s)}return t}text(e,t){var s=this.valueByPath(e,t);let n="";for(let e=0;e<s.length;e++)n+=s[e]+"\n";return n}valueByPath(t,s,n=null){let i=null,o=null;if("string"==typeof t){if(""==t)return null;i=t.length<48&&"{"!=t[0]&&(o=this.dom.element(t))?this.parse(o.textContent):this.parse(t)}else"object"==typeof t&&(i=t);if(!i)return null;let a=i,l=s;if("string"==typeof l&&(l=l.split("/")),null==n){for(let e=0;e<l.length;e++){if(isNaN(l[e])||(l[e]=parseInt(l[e])),void 0===a[l[e]])return null;a=a[l[e]]}return a}{var r;for(let t=0;t<l.length;t++){let e={};if(r=a,a=a[l[t]],void 0===a&&t<l.length-1)if(isNaN(l[t+1]))switch(t){case 0:i[l[0]]=a=e;break;case 1:i[l[0]][l[1]]=a=e;break;case 2:i[l[0]][l[1]][l[2]]=a=e;break;case 3:i[l[0]][l[1]][l[2]][l[3]]=a=e;break;case 4:i[l[0]][l[1]][l[2]][l[3]][l[4]]=a=e;break;case 5:i[l[0]][l[1]][l[2]][l[3]][l[4]][l[5]]=a=e;break;case 6:debug({level:1},"valueByPath only accesses 6 levels",l)}else if(l[t+1]=parseInt(l[t+1]),Array.isArray(r))switch(t){case 0:i=a=e;break;case 1:i[l[0]].push(e);break;case 2:i[l[0]][l[1]].push(e);break;case 3:i[l[0]][l[1]][l[2]].push(e);break;case 4:case 5:i[l[0]][l[1]][l[2]][l[3]].push(e);break;case 6:debug({level:1},"valueByPath only accesses 6 levels",l)}else switch(e=[],t){case 0:i[l[0]]=a=e;break;case 1:i[l[0]][l[1]]=a=e;break;case 2:i[l[0]][l[1]][l[2]]=a=e;break;case 3:i[l[0]][l[1]][l[2]][l[3]]=a=e;break;case 4:i[l[0]][l[1]][l[2]][l[3]][l[4]]=a=e;break;case 5:debug({level:1},"valueByPath only accesses 6 levels",l)}}s=l[l.length-1];let e=0;if("number"==typeof s)switch(l.length){case 1:e=i.length;case 2:e=i[l[0]].length;break;case 3:e=i[l[0]][l[1]].length;break;case 4:e=i[l[0]][l[1]][l[2]].length;break;case 5:e=i[l[0]][l[1]][l[2]][l[3]].length;break;case 6:e=i[l[0]][l[1]][l[2]][l[3]][l[4]].length;break;case 7:e=i[l[0]][l[1]][l[2]][l[3]][l[4]][l[5]].length;break;case 8:e=i[l[0]][l[1]][l[2]][l[3]][l[4]][l[5]][l[6]].length;break;default:debug({level:1},"valueByPath only accesses 8 levels",l)}if("number"==typeof s&&s>=e)switch(l.length){case 1:i.push(n);break;case 2:i[l[0]].push(n);break;case 3:i[l[0]][l[1]].push(n);break;case 4:i[l[0]][l[1]][l[2]].push(n);break;case 5:i[l[0]][l[1]][l[2]][l[3]].push(n);break;case 6:i[l[0]][l[1]][l[2]][l[3]][l[4]].push(n);break;case 7:i[l[0]][l[1]][l[2]][l[3]][l[4]][l[5]].push(n);break;case 8:i[l[0]][l[1]][l[2]][l[3]][l[4]][l[5]][l[6]].push(n);break;default:debug({level:1},"valueByPath only accesses 8 levels",l)}else switch(l.length){case 1:i[l[0]]=n;break;case 2:i[l[0]][l[1]]=n;break;case 3:i[l[0]][l[1]][l[2]]=n;break;case 4:i[l[0]][l[1]][l[2]][l[3]]=n;break;case 5:i[l[0]][l[1]][l[2]][l[3]][l[4]]=n;break;case 6:i[l[0]][l[1]][l[2]][l[3]][l[4]][l[5]]=n;break;case 7:i[l[0]][l[1]][l[2]][l[3]][l[4]][l[5]][l[6]]=n;break;case 8:i[l[0]][l[1]][l[2]][l[3]][l[4]][l[5]][l[6]][l[7]]=n;break;default:debug({level:1},"valueByPath only accesses 8 levels",l)}return"string"==typeof t&&(i=JSON.stringify(i)),o&&(o.textContent=i),i}}setValueByPath(e,t,s,n=0){"string"==typeof e&&(e=this.parse(e));let i=(t="string"==typeof t?t.split("/"):t).shift();return isNaN(i)||(i=parseInt(i)),e&&(this.valueByPath(e,i)?t.length||(e[i]=s):"string"==typeof i?t.length?isNaN(t[0])?e[i]={}:e[i]=[]:e[i]=s:Array.isArray(e)?i<e.length?e[i]=s:e.push(s):e=t.length?[{}]:[s],t.length&&(e[i]=this.setValueByPath(e[i],t,s,e)),e)}merge(e,t,n=""){let i=null,s=null;if("string"==typeof e){if(""==e)return null;i=e.length<48&&"{"!=e[0]&&(s=this.dom.element(e))?this.parse(s.textContent):this.parse(e)}else"object"==typeof e&&(i=e);let o=null,a=null;if("string"==typeof t){if(""==t)return null;t.length<48&&"{"!=t[0]&&(a=this.dom.element(t))?(o=this.parse(a.textContent),this.value(o,"meta")&&(o=this.valueByPath(o,"data/value"))):o=this.parse(t)}else"object"==typeof t&&(o=t);for(var l in o){let s=o[l],e=n;if(e?e+="/"+l:e=l,"number"==typeof s||"string"==typeof s)this.setValueByPath(i,e,s);else if(Array.isArray(s)){let t=this.valueByPath(i,e);if(t){if(Array.isArray(t)){if("_APPEND_"==s[0]){s.shift();for(let e=0;e<s.length;e++)s[e]&&-1==t.indexOf(s[e])&&t.push(s[e])}else"_REPLACE_"==s[0]&&s.shift(),t=s;this.setValueByPath(i,e,t)}else if(t&&"object"==typeof t)for(let e=0;e<s.length;e++)t&&s[e]&&(t["e"+e]=s[e])}else t=s,this.setValueByPath(i,e,t)}else i=this.merge(i,s,e)}return"string"==typeof e&&(i=JSON.stringify(i)),s&&(s.textContent=i),i}checkClasses(e){let t=this.value(e,"class");return t&&"string"==typeof t&&""!=t&&(t=this.dom.keepPermanentClasses(t),e=t?this.value(e,"class",t):this.value(e,"class","","delete")),e}getElement(t,e=!0){let n={};var s=t.tagName.toLowerCase();let i=t.id;t.name;var o=this.dom.attr(t,"ud_type");let a=!1;if(e){for(var l in n.meta={},i&&(n.meta.name=i.replace("editZone","")),n.meta.zone=i,this.attrMap){var r=this.attrMap[l];-1<["style","bind"].indexOf(l)||!r||this.dom.attr(t,r)&&(n.meta[l]=this.dom.attr(t,r))}n.meta=this.checkClasses(n.meta);this.dom.elements("div",t);a=!0;this.dom.children(t);API&&(this.use_onclick=API.testEditorAttr(t,"ude_edit","on"),this.use_onclick_el=t.id)}else{for(var d in n.tag=s,i&&0!=i.indexOf("udcalc")&&0!=i.indexOf("udecalc")&&(n.name=i),this.attrMap){var u=this.attrMap[d];-1<["style"].indexOf(d)||!u||(this.dom.attr(t,u)?n[d]=this.dom.attr(t,u):"onclick"==d&&this.dom.attr(t,"_onclick")&&(n[d]=this.dom.attr(t,"_onclick")))}if(n=this.checkClasses(n),"off"==this.value(n,"follow"))return n.value="",n}let c=Array.from(t.childNodes),h=null;if(e&&c.length&&"SPAN"==c[0].tagName&&c[0].classList.contains("caption")?1==c[0].childNodes.length&&(h=c.shift(),n.meta.captionPosition="top"):e&&2<c.length&&"SPAN"==c[1].tagName&&c[1].classList.contains("caption")?1==c[1].childNodes.length&&(c.shift(),h=c.shift(),n.meta.captionPosition="top"):e&&c.length&&"SPAN"==c[c.length-1].tagName&&c[c.length-1].classList.contains("caption")&&1==c[c.length-1].length&&(h=c.pop,n.meta.captionPosition="bottom"),h){var m=h.childNodes;let s="";for(let t=0;t<m.length;t++){let e=m[t];e.nodeType==Node.TEXT_NODE?s+=e.textContent:e.nodeType!=Node.ELEMENT_NODE||"SPAN"!=e.tagName||e.classList.contains("objectName")||(s+=e.outerHTML)}if(s){let e=document.createElement("textarea");e.textContent=s.replace(/\n/g,""),s=e.innerHTML,n.meta.caption=s}}let p="value";if(a&&(p="data"),t.innerHTML==t.textContent)n[p]=t.textContent;else if("text"==o||"textedit"==o){let e=this.dom.element("table",t);if(!e&&"object"==typeof process&&("TABLE"==t.tagName?e=t:(e=this.dom.children(t)[1],"TABLE"!=e.tagName&&(e=this.dom.children(t)[2])),!e))return null;n[p]=this.readTextEditor(e,this.dom.attr(e,"ud_mime"))}else if("list"==o){var g=this.dom.element("ul",t);n[p]=this.readList(g)}else if("ul"==s)n=this.readList(t);else if("table"==o){g=this.dom.element("table",t);n[p]=this.readTable(g)}else if("table"==s)n[p]=this.readTable(t);else if("divdata"==o)n[p]=c[0].innerHTML;else if(1==c.length)n[p]=this.getElement(c[0],!1);else{s=["ul","thead","tbody"].indexOf(s);if(a||-1<s){n[p]={};let t=1;for(let e=0;e<c.length;e++){var f=c[e];this.dom.attr(f,"exTag");if(1==f.nodeType)if("BR"==f.tagName)n[p].push({tag:"br",value:""});else{let e=this.dom.attr(f,"ud_key");e=e||t,n[p][e]=this.getElement(f,!1)}else 3==f.nodeType&&(n[p][t]={value:f.textContent});t++}}else{n[p]=[];for(let e=0;e<c.length;e++){var v=c[e];1==v.nodeType?"BR"==v.tagName?n[p].push({tag:"br",value:""}):n[p].push(this.getElement(v,!1)):3==v.nodeType&&n[p].push({value:v.textContent})}}}return e&&(n.changes={}),this.use_onclick&&t.id==this.use_onclick_el&&(this.use_onclick=!1,this.use_onclick_el=""),n}putElement(e,t="",s,n=""){let i=this.value(e,"meta");i=i||e,i=this.checkClasses(i);var o,a=this.value(i,"tag");let l=this.value(i,"name"),r=this.value(i,"zone"),d=null;if(r){if(d=this.dom.element(r),d)for(var u in this.dom.emptyElement(d),this.attrMap)""!==this.value(i,u)&&this.dom.attr(d,this.attrMap[u],this.value(i,u));else{for(var c in d=document.createElement("div"),d.id=r,-1<r.toLowerCase().indexOf("editzone")&&(d.className="editzone"),this.attrMap)""!==this.value(i,c)&&this.dom.attr(d,this.attrMap[c],this.value(i,c));t?this.dom.attr(d,"ude_bind",t):this.dom.attr(d,"ude_bind",l+"_object"),n&&(o=n.split(" "),d.classList.add(o[0]))}API&&(this.use_onclick=!!window.UDE_init&&API.testEditorAttr(d,"ude_edit","on"),this.use_onclick_el=d.id)}else if(a){d=document.createElement(a),l&&(d.id=l),n&&(o=n.split(" "),d.classList.add(o[0])),0<l.indexOf("editZone")&&t&&this.dom.attr(d,"ude_bind",t);var h,m=!this.value(i,"ui")&&this.use_onclick;for(h in this.attrMap)this.value(i,h)&&("onclick"==h&&m&&"yes"!=this.value(i,"ui")?this.dom.attr(d,"_onclick",this.value(i,h)):"placeholder"==h&&"input"==a?this.dom.attr(d,h,this.value(i,h)):this.attrMap[h]&&this.dom.attr(d,this.attrMap[h],this.value(i,h)))}if(!d)return null;let p=this.value(e,"data");if(p=p||this.value(e,"value"),p=p||this.value(e,"placeholder"),p=p||"","string"==typeof p)""==p&&"br"==e.tag?d.appendChild(document.createElement("br")):p&&(d.innerHTML=p);else if("object"==typeof p)if(Array.isArray(p)||""==this.value(p,"tag")){for(var g in p)if("_"!=g.charAt(0)&&"length"!=g){let e=p[g];if("string"==typeof e||""==this.value(e,"tag")&&""==this.value(e,"meta"))"object"==typeof e&&(e=e.value),""==e&&"P"==d.tagName?d.appendChild(document.createElement("br")):e&&d.appendChild(document.createTextNode(e));else if("object"==typeof p&&"datadiv"==this.value(p[g],"tag")){let e=document.createElement("div");e.id=p[g].name,e.innerHTML=JSON.stringify(p[g].value),e.className="hidden",this.dom.attr(e,"ud_type","divdata"),d.appendChild(e)}else{!this.value(p[g],"class")&&n&&(p[g].class=n);var f=this.putElement(p[g],t,a,n);t&&this.dom.attr(f,"ud_key",g),d.appendChild(f)}}}else if(p){var v=p.tag;let e=null;p.name&&(l=p.name),"textedit"==v?(p.value||(p.value={dummy:"..."}),b=l.replace("editZone","-table"),e=this.createTextEditor(p.value,b,p.class)):"datadiv"==v?(e=document.createElement("div"),e.innerHTML=JSON.stringify(p.value),e.className="hidden",this.dom.attr(e,"ud_type","divdata")):"jsonlist"==v?(p.value||(p.value={dummy:"..."}),e=this.createList(p.value,l,p),n&&(e.className=n)):"jsontable"==v?(p.value||(p.value={dummy:"..."}),e=this.createTable(p.value,l,p),n&&(e.className=this.dom.keepPermanentClasses(n,!1))):e=("div"==p.tag&&-1<p.class.indexOf("object")&&"object"==typeof p.value?p.value=JSON.stringify(p.value).replace(/&quot;/g,"&amp;quot;"):!this.value(p,"class")&&n&&(p.class=n),this.putElement(p,t,a,n)),d.appendChild(e)}var b=this.value(i,"caption"),v=this.value(i,"captionPosition");if(b&&v){let e=document.createElement("span");switch(e.className="caption",e.innerHTML=b,this.dom.attr(e,"spellcheck","false"),v){case"top":d.childNodes[0].classList.contains("objectName")?d.insertBefore(e,d.childNodes[1]):d.insertBefore(e,d.childNodes[0]);break;case"bottom":d.appendChild(e)}}return"object"==typeof process||(v=this.dom.element("table",d))&&v.parentNode==d&&(v.id?this.dom.arrangeTable(v.id):this.dom.arrangeTable(v)),!e||(e=this.value(e,"cache"))&&void 0!==e.tag&&d.appendChild(this.putElement(e,t,a)),this.use_onclick&&d.id==this.use_onclick_el&&(this.use_onclick=!1,this.use_onclick_el=""),d}toHTML(e){let t="";if("object"!=typeof e)return e;e=this.putElement({tag:"div",value:e},!1);return t=e?e.innerHTML:"ERR",t}createList(s,e,t){t=void 0===t.class?"":t.class;let n=document.createElement("ul");t&&(n.className=t),n.id=e;for(let t=0;t<s.length;t++){let e=document.createElement("li");var i,o=s[t];"object"==typeof o?(i=this.putElement({tag:"li",value:o},!1),e.innerHTML=i?i.innerHTML:"ERR"):e.innerHTML=o,n.appendChild(e)}return n}readList(e){let t={tag:"jsonlist"};t.name=e.id,e.className&&(t.class=e.className);let s=[];var n=e.childNodes;if(!n.length)return t;for(let t=0;t<n.length;t++){var i=n[t];let e={tag:"li"};this.dom.attr(i,"ude_formula")?e="="+this.dom.attr(i,"ude_formula"):(e=i.textContent,this.dom.isHTML(e)&&(i=this.getElement(i,!1),e=i?i.value:"ERR")),s.push(e)}return t.value=s,t}createTable(t,e,s){var n=void 0===s.class?"":s.class,s=void 0===s.datasrc?"":s.datasrc;let i=[],o=[],a={};if(!Array.isArray(t))for(var l in i.push("id"),t)if("model"!=l){let e=Object.assign({},t[l]);for(var r in e.id=l,e)-1==i.indexOf(r)&&i.push(r);o.push(e)}else a=t[l];else{a=t[0];for(let e=1;e<t.length;e++){var d,u=t[e];for(d in u)-1==i.indexOf(d)&&i.push(d);o.push(u)}}let c=document.createElement("table");n&&(c.className=n),s&&this.dom.attr(c,"ude_datasrc",s),c.id=e;let h=document.createElement("thead"),m=document.createElement("tbody"),p="";p+="<tr>";for(let e=0;e<i.length;e++)p+="<th>"+i[e]+"</th>";p+='</tr><tr class="rowModel">';for(let t=0;t<i.length;t++){let e=a[i[t]];null==e&&(e="");var g=API.getParameter("computingText");"="==e[0]?p+='<td ude_formula="'+e.substring(1)+'">'+g+"</td>":p+='<td ude_stage="on">'+e+"</td>"}p+="</tr>",h.innerHTML=p,c.appendChild(h);var f=API.getParameter("dummyText");for(let s=0;s<o.length;s++){let e=document.createElement("tr");p="";for(let e=0;e<i.length;e++){let t=void 0===o[s][i[e]]?"":o[s][i[e]];null==t&&(t="");var v=API.getParameter("computingText");if("="==t[0])p+='<td ude_stage="on" ude_formula="'+t.substring(1)+'">'+v+"</td>";else{if("object"==typeof t){let e={};e={tag:"div",value:t},t==f&&(e.placeholder=f);v=this.putElement(e,!1);t=v?v.innerHTML:"ERR"}p+="<td>"+t+"</td>"}}e.innerHTML=p,m.appendChild(e)}return c.appendChild(m),c}readTable(e){let t={tag:"jsontable"};t.name=e.id,e.className&&(t.class=e.className);var s=this.dom.attr(e,"ude_datasrc");s&&(json.table.source=s);var n=e.getElementsByTagName("thead")[0];let i=[];for(let e=0;e<n.rows[0].cells.length;e++)i.push(n.rows[0].cells[e].textContent);let o=[],a=!0;"id"==i[0]&&(o={},a=!1);{var l=n.rows[1].cells;let s={};for(let t=0;t<l.length;t++){var r=l[t];let e="";e=this.dom.attr(r,"ude_formula")?(0!=t||a||(a=!0,o=[]),"="+this.dom.attr(r,"ude_formula")):l[t].innerHTML,0==t&&!a||(s[i[t]]=e)}a?o.push(s):o.model=s}let d="";var u=e.getElementsByTagName("tbody")[0];let c={};for(let e=0;e<u.rows.length;e++){var h=u.rows[e].cells;c={},d="";for(let t=0;t<h.length;t++)if(0!=t||a){var m=h[t];if(this.dom.attr(m,"ude_formula"))c[i[t]]="="+this.dom.attr(m,"ude_formula");else{let e=m.innerHTML;$$$.dom.children(m).length&&(m=this.getElement(h[t],!1),e=m?m.value:"ERR"),c[i[t]]=e}}else d=h[t].textContent;a?o.push(c):o[d]=c}return t.value=o,t}createTextEditor(t,e,s,n=""){let i=document.createElement("table");if(i.className=s?"textContent "+s:"textContent",i.id=e,this.dom.attr(i,"ude_autosave","off"),!n)if(Array.isArray(t))switch(t[0].trim().toUpperCase()){case"SERVER":n="text/text";break;case"CSS":n="text/css";break;case"JS":n="text/javascript";break;case"JSON":n="text/json";break;case"HTML":n="text/html";break;case"RESOURCE":n="text/json";break;default:n="text/text"}else n="text/json";this.dom.attr(i,"ud_mime",n);let o=document.createElement("thead"),a=document.createElement("tbody");var s="API.setChanged( '"+i.id+"', 1);",e="",l="";l+='<tr contenteditable=false><th class="rowNo">'+this.textCol1+'</th><th class="linetext">'+this.textCol2+" "+(e+='<span class="rightButton"><a ref="javascript" onclick="'+s+'">save</a>')+"</th></tr>",l+='<tr class="rowModel">',l+='<td class="rowNo" ude_formula="row()" contenteditable="false">=row()</td>',l+='<td class="linetext">...</td>',l+="</tr>",o.innerHTML=l,i.appendChild(o),void 0===t.length&&(t=this.JSONtoText(t).split("\n"));document.createElement("textarea");for(var r=0;r<t.length;r++){let e=document.createElement("tr");l="";l+='<td contenteditable="false" ude_formula="row()" class="rowNo">'+(r+1)+"</td>",l+='<td class="linetext">'+t[r]+"</td>",e.innerHTML=l,a.appendChild(e)}return i.appendChild(a),i}JSONtoText(e,t=""){if(!(e="string"==typeof e&&""!=e?JSON.parse(e):e))return"";let s="",n=this.jsonComments;var i,o=$$$.getParameter("comment-key-in-JSON");for(i in t||(s+="JSON content\n",n=void 0!==e[o]?e[o]:[],this.jsonComments=n),e)if("length"!=i&&i!=o){var a=e[i],l=t+i;switch(typeof a){case"array":case"object":s+=this.JSONtoText(a,l+"/");break;case"number":s+=l+" = "+a+"\n";break;case"string":s+=l+' = "'+a+'"\n';break;default:debug({level:2},"unknown value type in JSON",t+i,a)}n&&void 0!==n[l]&&(s+="//"+n[l]+"\n")}return s}readTextEditor(e,s="text/text"){let n={};var t=this.dom.element("tbody",e),i=(t||e).rows;if(!i)return debug({level:1,return:null},"no rows in tbody of ",e);let o=[],a="text/json"==s;this.lastJSONkeys=[];for(let t=0;t<i.length;t++){let e=i[t].cells[1].textContent;"text/html"==s&&(e=i[t].cells[1].innerHTML),0==t&&0==e.toLowerCase().indexOf("json")&&(a=!0,e.toLowerCase().replace("json","").trim()),a&&t?n=this.prepareJSONstring(n,e):o.push(e)}return a&&(o=n),{tag:"textedit",class:e.className.replace(/textContent/g,""),value:o,mime:s}}prepareJSONstring(e,t){if("//"==t.substring(0,2)){var s=$$$.getParameter("comment-key-in-JSON");return void 0===e[s]&&(e[s]={}),e[s][this.lastJSONkeys.join("/")]=t.substring(2),e}s=t.indexOf("=");if(s<=0)return e;let n=t.substr(0,s).trim(),i=t.substr(s+1).trim();i=i?JSON.parse(i):null;let o=n.split("/");for(let e=0;e<o.length;e++)0==o[e].length&&(o[e]=this.lastJSONkeys[e]);return this.lastJSONkeys=o,null!=i&&(1<o.length?e=this.valueByPath(e,n,i):e[n]=i),e}}if("object"==typeof process&&(module.exports={UDJSON:UDJSON},void 0===global.JSDOM&&"undefined"==typeof window&&"undefined"==typeof ModuleUnderTest)){console.log("Syntax:OK"),console.log("Start of test program"),console.log("Setting up browser (client) test environment");let path="..";const testMod=require(path+"/tests/testenv.js");testMod.load([]);let ud=new UniversalDoc("document",!0,133),dom=ud.dom,udjson=new UDJSON(dom);console.log("start testing");let test="";{test="Test value: ";let json={p1:"val 1",p2:"val1,val2,val3",p4:["val20","val21"]};json=udjson.value(json,"p3","val33"),json=udjson.value(json,"p2","val4","addToCSV"),json=udjson.value(json,"p4","val22","add"),-1<json.p2.indexOf("val4")&&"val33"==udjson.value(json,"p3")&&-1<udjson.value(json,"p4").indexOf("val22")?console.log(test+"OK"):console.log(test+"KO",json)}{test="Test value by path: ";let json={p1:{pa:"val 1"},p2:{a:"val1",b:"val2",c:"val3"},p4:["val20","val21"]};json=udjson.valueByPath(json,"p3","val33"),json=udjson.valueByPath(json,"p2/d","val4"),json=udjson.valueByPath(json,"p4","val22","add"),-1<json.p2.d.indexOf("val4")&&"val33"==udjson.valueByPath(json,"p3")&&-1<udjson.valueByPath(json,"p4").indexOf("val22")?console.log(test+"OK"):console.log(test+"KO",json)}test="Test JSON2HTML 1";let data={tag:"ul",name:"myul",defaults:{tag:{1:"li"}},value:{0:{value:"item1",tag:"li"},1:{value:"item2",tag:"li"}}},json={meta:{type:"list",name:"mylist",zone:"myListeditZone",caption:"My list",captionPosition:"top"},data:data,changes:{}},element=udjson.putElement(json),rjson=udjson.getElement(element);"list"==rjson.meta.type?console.log(test+" : OK"):console.log(test+": KO"),test="Test JSON2HTML 2",data={tag:"textedit",name:"mytext",value:["line1","line2"]},json={meta:{type:"text",name:"mytext",zone:"mytexteditZone",caption:"My text",captionPosition:"top"},data:data,changes:{}},element=udjson.putElement(json),rjson=udjson.getElement(element),rjson&&"text"==rjson.meta.type?console.log(test+" : OK"):console.log(test+": KO",rjson);{test="setValueByPath (recurrent)";let obj={};obj=udjson.setValueByPath(obj,"first","no 1"),obj=udjson.setValueByPath(obj,"second/0","no 2"),obj=udjson.setValueByPath(obj,"second/1","no 3 wrong"),obj=udjson.setValueByPath(obj,"second/2","no 4"),obj=udjson.setValueByPath(obj,"third/a","no 5"),obj=udjson.setValueByPath(obj,"third/b","no 6"),obj=udjson.setValueByPath(obj,"second/1","no 3");let json='{"first":"no 1","second":["no 2","no 3","no 4"],"third":{"a":"no 5","b":"no 6"}}';testResult(test,JSON.stringify(obj)==json,JSON.stringify(obj))}{test="merge";let obj=udjson.parse('{"first":"no 1","second":["no 2","no 3","no 4"],"third":{"a":"no 5","b":"no 6"}}');obj=udjson.merge(obj,'{ "third":{"a":"no 50"}, "second":["no 20", "no 3", "no 4"]}');let json='{"first":"no 1","second":["no 20","no 3","no 4"],"third":{"a":"no 50","b":"no 6"}}';testResult(test,JSON.stringify(obj)==json,JSON.stringify(obj))}{test="jsontable array",data={tag:"jsontable",name:"myJtable",class:"aclass",value:[{col1:"Model Col 1",col2:"Model Col 2",col3:"Model Col 3"},{col1:"Row 1 Col 1",col2:" Row 1 Col 2",col3:" Row 1 Col 3"},{col1:"Row 2 Col 1",col2:" Row 2 Col 2",col3:" Row 2 Col 3"}]},json={meta:{type:"table",name:"myJtable",zone:"myJtableeditZone",caption:"My JSON table",captionPosition:"top"},data:data,changes:{}},element=udjson.putElement(json);let el=dom.insertElement("div",element.outerHTML,{id:test},dom.element("B010000000500000M"),!0),table=dom.element("table",element),got=udjson.getElement(element);testResult(test,JSON.stringify(got.data)==JSON.stringify(json.data),JSON.stringify(got.data)+JSON.stringify(json.data)+"!")}{test="jsontable named array",data={tag:"jsontable",name:"myJ2table",value:{model:{col1:"Model Col 1",col2:"Model Col 2",col3:"Model Col 3"},row1:{col1:"Row 1 Col 1",col2:" Row 1 Col 2",col3:" Row 1 Col 3"},row2:{col1:"Row 2 Col 1",col2:" Row 2 Col 2",col3:" Row 2 Col 3"}}},json={meta:{type:"table",name:"myJ2table",zone:"myJ2tableeditZone",caption:"My 2 JSON table",captionPosition:"top"},data:data,changes:{}},element=udjson.putElement(json);let el=dom.insertElement("div",element.outerHTML,{id:test},dom.element("B010000000500000M"),!0),got=udjson.getElement(element);testResult(test,JSON.stringify(got.data)==JSON.stringify(json.data),JSON.stringify(got))}{test="json_access";let json='{"first":"no 1","second":["no 2","no 3","no 4"],"third":{"a":"no 5","b":"no 6"}, "fourth":4}',holder=dom.insertElement("div",json,{id:test,class:"hidden"},dom.element("UD_resources"),!1,!0),read1=udjson.read(json,"first"),read2=udjson.readFromDiv(test,"first"),read3=udjson.readFromDiv(test,"fourth","incrementAfter"),read4=udjson.readFromDiv(test,"fourth");udjson.writeToDiv(test,"first","no 1 changed");let read5=udjson.readFromDiv(test,"first");testResult(test,"no 1"==read1&&"no 1"==read2&&4==read3&&5==read4&&"no 1 changed"==read5,read1+" "+read2+" "+read3+" "+read4+" "+read5)}{test="jsonlist",data={tag:"jsonlist",name:"myJ2list",value:["item 1","item 2","item 3"]},json={meta:{type:"div",name:"myJ2list",zone:"myJ2listeditZone",caption:"My 2 JSON list",captionPosition:"top"},data:data,changes:{}},element=udjson.putElement(json);let got=udjson.getElement(element);testResult(test,JSON.stringify(got.data)==JSON.stringify(json.data),JSON.stringify(got))}{test="parsing stringify &quot",data=["HTML","&lt;div style=&quot;width:100%;&quot;&gt;"],json=JSON.stringify(data);let el=document.createElement("div");el.innerHTML=json.replace(/&quot;/g,"&amp;quot;"),testResult(test,-1<json.indexOf("&quot;")&&-1<el.innerHTML.indexOf("&amp;quot;"),json+el.innerHTML)}console.log("Test completed"),process.exit(0)}class UDmodule{constructor(){if(void 0!==this._uses){var e=$$$.loadFcts(this._uses);if("string"==typeof e)return console.error("Unknown fct $$$."+e),void $$$.pageBanner("temp",$$$.translateTerm("Unknown fct")+" $$$."+e)}let t=Object.getOwnPropertyNames(Object.getPrototypeOf(this));"undefined"!=typeof $$$&&(e=t.filter((e,t,s)=>{if(e!=s[t+t]&&"function"==typeof this[e]&&"constructor"!=e&&"_"!=e[0])return!0}),$$$.addFunctions(this,e))}}if("object"==typeof process&&(module.exports={class:UDmodule,UDmodule:UDmodule},void 0===global.JSDOM&&"undefined"==typeof window&&"undefined"==typeof ModuleUnderTest)){ModuleUnderTest="udmodule.js",void 0===process.argv[2]&&(console.log("Syntax OK"),console.log("Test completed"),process.exit(0));let testModule="resources/"+process.argv[2],ejsModule="../node_modules/ejs/ejs.js";const envMod=require("../tests/testenv.js");envMod.load(),global.ud=new UniversalDoc("document",!0,133),global.reqMod=envMod.require,envMod.require([ejsModule,testModule],function(){console.log("Module tests returned")})}class UD_ressources{ud=null;classMap=null;info=null;register=null;mappedClasses={};dom;constructor(e,t){this.ud=e,"undefined"!=typeof API&&((API=!API&&"object"==typeof process?t:API).addFunctions(this,["getTagOrStyleInfo","getTagOrStyleLabel","getStyleLabel","getTagLabel","availableTags","listTypeAndSubTypeClasses","availableClassesForExtag","availableClasses","availableStylesForSelection","availableTagsForSelection","availableLayouts","availableLayoutsForExTag","insertables","getViewTypeClass","getClassesForView","updateClassMap","getEditorAttr","testEditorAttr","setEditorAttrPermanently","setLiveEditorAttrs","getParameter","getConstant","hasLanguageSuffix","defaultContent","hasDefaultContent","updateResource","refreshResource"]),this.dom=API.dom,this.register=UD_register,this.info=this.register.UD_exTagAndClassInfo,UD_exTagAndClassInfo=this.info,(t=this.dom.udjson.parse("UD_registerModifications"))&&(UD_exTagAndClassInfo=this.updateResource(UD_exTagAndClassInfo,t[0]),this.register.UD_exTagAndClassInfo=UD_exTagAndClassInfo),"undefined"!=typeof UD_register&&void 0!==UD_register.UD_parameters.buildManageOnClientSide&&debug("Register loaded"),window.UD_resources=this)}getTagOrStyleInfo(e,t=""){window.lang;e=API.json.value(UD_exTagAndClassInfo,e);return e&&t?API.json.value(e,t):e||""}getTagOrStyleLabel(e,t=""){if(!e)return"";let s="";var n,i,o=window.lang;let a=null,l=API.json.value;return t&&(i=$$$.dom.getEditableParent(t),n=this.dom.attr(i,"exTag"),this.getParameter("register")["store-labels-by-view"]&&(t=API.dom.getViewType(i),i=API.dom.getViewClass(i),n&&t&&i&&(a=l(UD_exTagAndClassInfo,"div.part."+t+" ."+i+" "+n+"."+e))),a||n==e||(a=l(UD_exTagAndClassInfo,n+"."+e))),a=a||API.json.value(UD_exTagAndClassInfo,e),s=a?(s="","EN"!=o&&(s=$$$.json.value(a,"label_"+o)),s||$$$.json.value(a,"label")):$$$.translateTerm(e),s=s||$$$.translateTerm(e),s}getStyleLabel(e,t=""){return this.getTagOrStyleLabel(e,t)}getTagLabel(e,t=""){return this.getTagOrStyleLabel(e,t)}availableTags(e){let t=[];e=API.dom.element(e),API.dom.attr(e,"exTag");let s=e.parentNode;if("div.zone"==$$$.dom.attr(s,"exTag")&&s.classList.contains("text-only"))return["p"];if(!e)return t;let n=API.json.value;var i,o=API.dom.getViewType(e);if(!o)return t;for(i in this.info){var a=this.info[i];let e=n(a,"viewTypes");void 0!==e&&("all"==e||-1<e.indexOf(o))&&t.push(i)}return t}listTypeAndSubTypeClasses(){let e=[];var t,s;for(t in API.json.parse("UD_nextViewIds"))e.push(t.replace(/ /g,"_"));for(s in this.info){var n=this.info[s].ud_type,i=this.info[s].ud_subType;n&&-1==e.indexOf(n)&&e.push(n),i&&-1==e.indexOf(i)&&e.push(i)}return e}availableClassesForExtag(e,t="doc",s=""){let n=[],i=API.json.value;var o=this.info[e],e=i(o,"classesByViewClass"),s=e?i(e,s):null;return n=s||(o=i(o,"classesByViewType"),(i(o,t)?i(o,t):i(o,"default"))||[]),n}availableClasses(e,t="",s="",n=""){var i,e=API.dom.element(e);t=t||API.dom.attr(e,"exTag"),s=s||API.dom.getViewType(e),n=n||API.dom.getViewClass(e),i=this.availableClassesForExtag(t,s,n);let o=[];for(let t=0;t<i.length;t++){let e=i[t];-1==e.indexOf("LAY_")&&o.push(e)}return o}availableLayouts(e,t="",s=""){var n,i=API.dom.element(e);t=t||(i?API.dom.attr(i,"exTag"):e),s=s||API.dom.getViewType(i),n=this.availableClassesForExtag(t,s);let o=[];for(let t=0;t<n.length;t++){let e=n[t];0==e.indexOf("LAY_")&&o.push(e)}return o}availableLayoutsForExTag(t){let s=[];if("div.part"==t){let e=API.json.value;var n=this.info[t],n=e(n,"defaultContentByClassOrViewType");s=Object.keys(n)}else s=this.availableClassesForExtag(t,viewType);let i=[];for(let t=0;t<s.length;t++){let e=s[t];0==e.indexOf("LAY_")&&i.push(e.replace("LAY_",""))}return i}availableStylesForSelection(e){let t=[];e=API.dom.element(e),e=API.dom.attr(e,"exTag");let s=API.json.value;var n,e=this.info[e];for(n in s(e,"insertableTags"))t.push(n);return t}availableTagsForSelection(e){let t=[];e=API.dom.element(e),e=API.dom.attr(e,"exTag");let s=API.json.value;var n,e=this.info[e];for(n in s(e,"insertableTags"))t.push("span."+n);return t}insertables(e){e=API.dom.element(e),e=API.dom.attr(e,"exTag");let t=API.json.value;e=this.info[e];return t(e,"insertableTags")}getViewTypeClass(){}getClassesForView(){}defaultContent(e,t="",s=!1){var n="object"==typeof e?this.dom.attr(e,"exTag"):e;t||"object"!=typeof e||(t=API.getViewType(e));e=this.info[n];let i="";n=API.json.value(e,"defaultContentByClassOrViewType");return n&&Object.keys(n).length&&(i=API.json.value(n,t)),i=i||API.json.value(e,"defaultContent"),i=i||"...","object"==typeof i&&s&&(i=API.json.toHTML(i)),i}hasDefaultContentByPath(e,t){var s=this.info[t],t=API.json.value(s,"defaultContentPath");if(t){t=this.getJSONcontentByPath(e,t);if(t)return JSON.stringify(API.json.value(s,"defaultContentByPath"))==t}return!1}hasDefaultContent(e,t="",s=""){var n=this.dom.element(e);if("div.part"!=(t=t||this.dom.attr(n,"exTag")))return!n.innerHTML||n.textContent==this.dom.attr(n,"ude_place")||this.hasDefaultContentByPath(n,t)||n.innerHTML==this.defaultContent(t,s);e=this.dom.children(n),s=this.defaultContent(t,s);return n.textContent.length<20||e.length==Object.keys(s).length}getJSONcontentByPath(e,t){var s=this.dom.attr(e,"name"),e=this.dom.element("#"+s+"_object",e);if(e){t=this.dom.udjson.valueByPath(e.innerText,t);if(t)return JSON.stringify(t)}return""}defaultAttrValue(e,t,s=null){let n="";if(0!=t.indexOf("data-")&&(t="data-"+t.replace("ude_","ude-")),void 0===(s=s||UDE_attributeValues[t]))return n;if(n=API.json.valueByPath(s,e+"/"+t),!n)for(var i in s){let e=s[i];if("object"==typeof e?n=this.defaultAttrValue(t,e.items):-1<e.indexOf("*default*")&&(n=i),n)break}return n}getEditorAttr(t,s){var n=this.dom.element(t);0==s.indexOf("data-")&&(s=s.replace("data-","").replace("-","_"));let i=this.dom.attr(n,s);if(!i){let e=this.dom.attr(n,"ud_extra");e=e||this.dom.parentAttr(n,"ud_extra"),e&&(e=API.json.parse(e),e&&(t=0==s.indexOf("data-")?s:"data-"+s.replace(/_/g,"-"),i=e[s],i=i||e[t],i=i||e[s.replace("ud_","").replace("ude_","")]))}return i=i||this.dom.parentAttr(n,s),i=i||this.defaultAttrValue(this.dom.attr(n,"exTag"),s),i}testEditorAttr(e,t,s=""){let n=this.dom.element(e),i=this.getEditorAttr(e,t);e=this.dom.element("UD_mode");let o="edit2";return e&&(o=e.textContent),n.id&&"B3"!=n.id.substr(0,2)&&"edit3"==o&&-1<["ude_edit","ude_menu"].indexOf(t)&&(i="on"),"on"==i||i&&"off"!=i&&""!=s&&-1<i.indexOf(s)}getParameter(e,t="global"){let s="";if("global"==t)s=this.dom.udjson.value(UD_register.UD_parameters,e);else if("register"==t)s=this.dom.udjson.valueByPath(UD_register,e);else{var n=API.dom.element("UD_"+e);if(!n)return debug({level:2,return:""},"can't find UD_"+e);s=n.textContent}if(s&&"string"==typeof s){n=s.toLowerCase();if(-1<["yes","no","on","off"].indexOf(n))return n}return s}getConstant(e,t){let s=e[t];e=this.getParameter("userId"),t=("00000"+(t=parseInt(e,10).toString(32))).substring(t.length);return s=s.replace("{userId}",e).replace("{userId_base32}",t),s}hasLanguageSuffix(e){e=e.substr(e.length-2);let t=this.getParameter("languageCodes");return-1<t.indexOf(e)}setEditorAttrPermanently(e,t,s){var n=this.dom.element(e),e=this.dom.getSaveableParent(n);this.dom.parentAttr(n,t,s="boolean"==typeof s?s?"on":"off":s);if(n==e){let e=this.dom.attr(n,"ud_extra");e=e?API.json.parse(e):{},e[t]=s,this.dom.attr(n,"ud_extra",JSON.stringify(e))}return API.setChanged(e),s}setLiveEditorAttrs(e){}refreshResource(e){"UD_tagAndClassInfo"==e&&(this.info=this.register.UD_exTagAndClassInfo)}updateClassMap(e){console.error("Call to deprecated updateClassMap() in udresources.js"),API.json.merge(this.classMap,e);let t=API.dom.element("UD_classMap");t&&(t.textContent=JSON.stringify(this.classMap))}updateResource(e,t){t=API.json.value(t,"resource","","delete");e="object"==typeof e?e:API.json.parse(e);return e=API.json.merge(e,t)}loadResourceFile(e){API.loadScript(e,"API.loadRessources( name);")}loadResources(e){for(var t in e){var s,t=e[t],n=t.action,i=t.data;for(s in i){i[s];n}}}}function UD_ressources_init(e,t){return new UD_ressources(e,t)}if("object"==typeof process&&(module.exports={class:UD_ressources,init:UD_ressources_init},void 0===global.JSDOM&&"undefined"==typeof window&&"undefined"==typeof ModuleUnderTest)){console.log("Syntax:OK"),console.log("Start of UD_ressources class test program"),console.log("Setting up browser (client) test environment"),ModuleUnderTest="udressources";let path="..";const testMod=require(path+"/tests/testenv.js");testMod.load([]);let ud=new UniversalDoc("document",!0,133);{let test="1 - availableClassesForExtag",classes=API.availableClassesForExtag("p");testResult(test,-1<classes.indexOf("standard"),classes)}{let test="2 - availableClasses",classes=API.availableClasses("B0100000001000000M");testResult(test,-1<classes.indexOf("standard"),classes)}{let test="3 - insertables",types=API.insertables("B0100000001000000M");testResult(test,types.field,types)}console.log("Test completed"),process.exit()}class UDutilities{moduleName="UDutilities";ud=null;dom=null;api=null;actionElement=null;copyAttributes=["ude_formula","ude_autosave","ude_stage"];constructor(e,t=null){this.ud=e,this.dom=e.dom,this.api=t||e.api,this.api.addFunctions(this,["buildManagePart","diffuseDoc","copy","deepCopy","copyElements","removeChildren","egaliseHeightOfClass","buildDisplayableDeviceList","dispatchNameChange","changeName","dispatchClassChange","prePostDocName","getInlineHTML","concatHTMLelements"])}buildManagePart(t=!1){let s=this.dom.elementByName("Manage");if(s=s||this.dom.elementByName("manage"),!s)return debug({level:1,return:!1},"No manage part found");$$$.dom.attr(s,"contenteditable","true"),$$$.dom.attr(s,"ude_edit","on");let e=this.dom.elementByName("BotlogZone"),n=this.dom.elementByName("DocNames"),i=this.dom.elementByName("DocParameters"),o=this.dom.elementByName("DocActions"),a=this.dom.elementByName("DocHistory"),l=this.dom.udjson,r=API.translateTerm;"FR"==this.dom.textContent("UD_lang")&&(r("Parameters",!0,"Paramètres"),r("Diffuse this document",!0,"Diffusez ce document"),r("Share this documen",!0,"Partagez ce document"),r("Document history",!0,"Voir l'histoire du document")),e&&e.classList.add("hidden"),s.classList.add("LAY_A4");var d=this.dom.attr(this.ud.topElement,"ud_oid").split("--");if(n&&this.dom.children(n).length<2){this.dom.insertElement("h1",r("Manage doc"),{},n);var u=this.dom.textContent("UD_docTitle");let e=this.dom.textContent("UD_docSubtitle");e=e||"Description courte";var c=this.dom.textContent("UD_docModel"),u={tag:"div",value:{docName:{tag:"p",name:"MANAGE_docName",value:{docTitle:{tag:"span",class:"title",placeholder:"Nouvelle tâche",stage:"on",menu:"off",value:u},docSubtitle:{tag:"span",class:"subtitle",stage:"on",menu:"off",placeholder:"Description courte",value:e}}},model:{tag:"p",name:"MANAGE_model",value:{label:{tag:"span",class:"label",edit:"off",value:"Processus :"},modelValue:{tag:"span",stage:"on",menu:"off",value:c},ok:{tag:"span",class:"button",onclick:"$$$.setModel( this.previousSibling.value)",value:"OK"}}},partEditing:{tag:"div",value:{viewTitle:{tag:"h2",edit:"off",value:"Vues"},viewlist:{tag:"div",name:"MANAGE_viewNames",type:"zoneToFill"}}}}};let t=this.dom.textContent("UD_dbName");c=t.split("_")[0];n.innerHTML=l.putElement(u).innerHTML,this.dom.attr("MANAGE_docName","ud_oid",d[0]+"--"+d[1]),this.dom.attr("MANAGE_docName","ud_extra",'{"name":"'+c+'"}'),this.dom.attr("MANAGE_docName","ud_dchanged",0),this.dom.attr("MANAGE_docName","ud_dupdated",0),this.dom.attr("MANAGE_docName","ud_fields","nlabel tcontent"),API.onTrigger("MANAGE_docName","prepost",API.prePostDocName,!1),this.ud.buildPartEditing("MANAGE_viewNames")}if(i&&this.dom.children(i).length<2){let e=l.parse("UD_system");e&&Object.keys(e).length||(e={ideas:["defaultPart","copyParts"]});let t=UD_wellKnownElements.UD_docParams;u=t.replace("_object",""),c={meta:{type:"text",subtype:"JSON",name:u,zone:u+"editZone",caption:"DocParams",captionPostion:"top"},data:{tag:"textedit",class:"textContent",value:e},changes:[]},c={tag:"div",class:"object hidden",name:t,value:JSON.stringify(c)},c={tag:"div",value:{title:{tag:"h3",onclick:"API.toggleClass( 'MANAGE_params', 'hidden');",value:r("Parameters")},editor:{tag:"div",type:"json",class:"json hidden",name:"MANAGE_params",label:u,value:c}}},c=l.putElement(c);i.innerHTML=c.innerHTML;let s=this.dom.element("MANAGE_params");this.ud.ude.initialiseElement(s),this.dom.attr(s,"ud_oid",d[0]+"--"+d[1]),this.dom.attr(s,"ud_dchanged",0),this.dom.attr(s,"ud_dupdated",0),this.dom.attr(s,"ud_fields","textra"),s.classList.add("hidden")}o&&this.dom.children(o).length<2&&(d={tag:"div",value:{title:{tag:"h2",value:r("Actions")},diffusion:{tag:"div",value:{title:{tag:"h3",onclick:"API.toggleClass( 'MANAGE_diffusion', 'hidden');",value:r("Diffuse this document")},diffuse:{tag:"div",class:"*hidden",name:"MANAGE_diffusion",value:{msg:{tag:"p",name:"MANAGE_diffuseMsg",class:"customerMessage",value:"Bonjour,<br><br>Voici le lien pour votre présentation de SD bee : {link}<br><br>L'équipe SD bee"},recipients:{meta:{name:"MANAGE_recipients",zone:"MANAGE_recipientseditZone",type:"list",class:"input",captionPosition:"top",caption:"Entrez les adresses emails des destinataires ici :"},data:{1:{tag:"ul",name:"MANAGE_recipients",class:"listStyle1",value:{1:{tag:"li",class:"input",placeholder:"Enter item",value:"contact@sd-bee.com"}}}},changes:{}},btn:{tag:"span",class:"button",onclick:"API.diffuseDoc( 'MANAGE_diffuseMsg', 'MANAGE_recipients');",value:"Diffuse"}}}}},docactions:{tag:"div",value:{title:{tag:"h3",value:r("Copy, delete ...")},deletedoc:{tag:"span",class:"button",onclick:"API.deleteDoc();",value:"Delete"}}}}},o.innerHTML=l.putElement(d).innerHTML),t&&this.dom.insertElement("div",'<span ud_type="button" class="button" onclick="API.switchView( \'Dir listing\');">Close Manage</span>',{class:"manageZone"},s,!0,!0);t=e?this.dom.element("p.botlog",e):null,t=t?t.innerHTML:"";if(t)if(a){let e=this.dom.element("MANAGE_botlog");e.innerHTML=t}else{t={tag:"div",value:{title:{tag:"h2",onclick:"API.toggleClass( 'MANAGE_history', 'hidden');",value:r("Document history")},history:{tag:"div",class:"*hidden",name:"MANAGE_history",value:{content:{tag:"p",name:"MANAGE_botlog",class:"botlogDisplay",value:t}}}}},t=l.putElement(t);a=this.dom.prepareToInsert("div",t.innerHTML,{name:"DocHistory",class:"manageZone","data-ud-type":"zone"});let e=this.dom.element("div.page",s);(e||s).appendChild(a)}}diffuseDoc(e,t){if(!window.APP_DIFFUSE){window.APP_DIFFUSE=!0;var s=API.dom.element(e),e=API.dom.element(t);if(!s||!e)return API.pageBanner("temp","Missing data"),void(window.APP_DIFFUSE=!1);var n=s.innerHTML,i=API.getItems(t);API.pageBanner("temp","Diffusion d'une instance de ce modèle à "+i.length+" emails");for(let e=0;e<i.length;e++){var o={action:"send",subject:"SD bee demo",body:n,to:i[e],oid:API.dom.attr("document","ud_oid"),docName:"Demo SD bee",lifeInDays:30},o=API.service("SendDoc",o);console.log(o)}return!(window.APP_DIFFUSE=!1)}}copyObjectInDiv(e){}copy(t,e,s={},n,i=!0){var o=this.dom.attr(t,"tagName"),a=this.dom.attr(t,"ud_type"),l=t.className;let r={},d=t.innerHTML;if(-1<["subpart","zone"].indexOf(a)&&(d=""),""==this.dom.attr(t,"ud_oid"))return null;if(a&&(r={ud_type:a,class:a}),l&&(r.class=l),""!=d)for(var u in s){var c=new RegExp("{"+u+"}","g");d=d.replace(c,s[u])}let h;if(h=this.dom.prepareToInsert(o,d,r),h=e.appendChild(h),i||this.ud.ude.calc.substituteFormulaeInElement(h),this.ud.viewEvent("create",h),a)switch(a){case"zone":case"subpart":let e=this;this.ud.onTrigger(h,"update",function(){e.deepCopy(t.id,h.id,s,!1,i)});break;default:this.ud.ude.initialiseElement(h.id)}return h}deepCopy(t,s,n={},i=!1,o=!0){var a=this.dom.element(t);let l=this.dom.element(s),e=this.dom.attr(l,"ud_oid"),r=null;if(""!=e&&0==e.split("--")[1].split("-").pop()){let e=this;return setTimeout(function(){e.deepCopy(t,s,n,i)},1500),debug({level:2,return:!1},"Destination not saveable yet",l)}if(i){l=this.copy(a,l),r=l;let e=this;return this.ud.onTrigger(newElement,"update",function(){e.deepCopy(t,s,n,!1,o)}),l}for(var d=this.dom.children(a),u=0;u<d.length;u++){var c=d[u],h=this.dom.attr(c,"ud_type");-1<["page"].indexOf(h)||(c=this.copy(c,l,n,0,o),r=r||c)}return r&&void 0!==r.id?r.id:debug({level:2,return:!1},"Nothing copied in API.deepCopy()",a,l)}copyElements(e,t,s="document"){s=this.dom.element(s);let n=this.dom.element(e);!n&&s&&(n=this.dom.element("[name='"+e+"']",s));let r=this.dom.element(t);if(!r&&s&&(r=this.dom.element("[name='"+t+"']",s)),!n||!r)return debug({level:1,return:!1},"Can't copy from to",e,t);var d=n.id.substring(0,3),u=r.id.substring(0,3),e=n.id.substring(3,13),t=r.id.substring(3,13),c=parseInt(e,32),h=parseInt(t,32),m=("00000"+window.ud.userId).slice(-5).toUpperCase();let p=this.dom.attr(r,"name").replace(this.dom.attr(n,"name"),"");p=p.replace(/ /g,"_");var g=API.dom.children(n);let f=null;for(let l=g.length-1;0<=l;l--){let i=g[l],o=i.id,a=u+o.substring(3,13)+m;if(d==u&&(b=h+((b=parseInt(o.substring(3,13),32))-c),a=u+("0000000000"+b).slice(-10)+m),this.dom.element(a)){f=this.dom.element(a),this.dom.attr(f,"ude_datasrc",o);let e=API.json.parse(API.dom.attr(f,"ud_extra"));e=e||{},e.datasrc=o,API.dom.attr(f,"ud_extra",JSON.stringify(e)),API.setChanged(f)}else{let e=i.cloneNode(!0);e.id=a;var v=this.dom.attr(i,"name"),b=this.dom.element(v+"_object");let t="";v&&b&&(t=v+p),this.dom.attr(e,"ude_datasrc",o),e.classList.add("ud_requiresAction");let s=API.json.parse(API.dom.attr(e,"ud_extra"));s=s||{},s.datasrc=o,API.dom.attr(e,"ud_extra",JSON.stringify(s));let n=f?f.parentNode:r.childNodes[r.childNodes.length-1];if(e="div.page"==this.dom.attr(n,"exTag")?l==g.length-1?n.appendChild(e):n.insertBefore(e,f):l==g.length-1?r.appendChild(e):r.insertBefore(e,f),t&&b){if(!API.changeName(e,t))return!1;this.dom.attr(e,"ude_datasrc",t)}this.ud.viewEvent("create",e),f=e}}API.paginate(r)}concatHTMLelements(e,t){let s=this.dom.udjson.value;var n=s(t,"baseStyle"),i=s(t,"styleId"),o=s(t,"containerCode"),a={width:"px",height:"px","font-size":"px",float:"",color:"","background-color":"","margin-top":"px","margin-left":"px","margin-right":"px","margin-bottom":"px","padding-top":"px","padding-right":"px","padding-bottom":"px","padding-left":"px","border-radius":"px"},t=this.dom.elementByName(e);if(!t)return debug({level:1,return:""},"Can't find ",e);let l="",r="";if(i){let e=this.ud.ude.calc.textContent2HTML(i);-1==e.indexOf('<meta name="viewport"')&&(r+='<meta name="viewport" content="width=device-width,initial-scale=1.0">\n',r+='<meta charset="UTF-8">\n'),-1<e.indexOf("<style")?r+=e:r+='<style type="text/css">'+e+"</style>"}if(n){for(var d in l+="<html><head>"+r+"</head>",l+='<body style="',n){let e=n[d],t="",s="";"string"==typeof e&&(s=e.slice(-2),"%"==e.slice(-1)&&(s="%")),void 0!==a[d="_"==d.charAt(0)?d.substr(1):d]&&(t=a[d]),-1<["%","px","em"].indexOf(s)&&(t=""),l+=d+":"+n[d]+t+";"}l+='">',l+=o.open}var u=this.dom.elements("div[data-ud-type='filledZone'],div[data-ud-type='html']",t);for(let e=0;e<u.length;e++){var c,h=u[e];"div.html"==this.dom.attr(h,"exTag")?(c=this.dom.element("div div.htmlView",h))&&(l+=c.innerHTML):l+=h.innerHTML}return l+=o.close,n&&(l+="</body></html>"),l}getInlineHTML(e,n,s,i,t=""){var o={width:"px",height:"px","font-size":"px",float:"",color:"","background-color":"","margin-top":"px","margin-left":"px","margin-right":"px","margin-bottom":"px","padding-top":"px","padding-right":"px","padding-bottom":"px","padding-left":"px","border-radius":"px"};let a=e;"string"==typeof e&&(a=this.dom.element(e));let l="",r="";if(t){let e=this.ud.ude.calc.textContent2HTML(t);-1==e.indexOf('<meta name="viewport"')&&(r+='<meta name="viewport" content="width=device-width,initial-scale=1.0">\n',r+='<meta charset="UTF-8">\n'),-1<e.indexOf("<style")?r+=e:r+='<style type="text/css">'+e+"</style>"}if(n){for(var d in l+="<html><head>"+r+"</head>",l+='<body style="',n){let e=n[d],t="",s="";"string"==typeof e&&(s=e.slice(-2),"%"==e.slice(-1)&&(s="%")),void 0!==o[d="_"==d.charAt(0)?d.substr(1):d]&&(t=o[d]),-1<["%","px","em"].indexOf(s)&&(t=""),l+=d+":"+n[d]+t+";"}l+='">',l+='<table class="emailContainer" align="center" cellpadding="0" cellspacing="0" border="0"><tr><td>'}for(var u,c=this.dom.children(a),h=0;h<c.length;h++){let e=c[h],t="";-1<i.indexOf(e.id)||(3==e.nodeType?t+=e.textContent:1==e.nodeType&&(u=this.dom.attr(e,"exTag"),-1<["div.zone"].indexOf(u)?(t+=this.getInlineHTML(e.id,null,s,i),t+="\n"):-1<["div.filledZone","div.zoneToFill"].indexOf(u)?t+=e.innerHTML:"none"!=this.dom.attr(e,"computed_display")&&(e.tagName.toLowerCase(),t='<div style="',t+='">\n',t+=e.innerHTML,t+="</div>\n")),l+=t+"\n")}return n&&(l+="</td></tr></table></body></html>"),l=l.replace(/&nbsp;/g," "),l}egaliseHeightOfClass(e){let t=document.getElementsByClassName(e),s=0;for(let e=0;e<t.length;e++){var n=this.dom.attr(t[e],"computed_height");n>s&&(s=n)}s+="px";for(let e=0;e<t.length;e++)t[e].style.height=s;return!0}getContentWithInlineStyles(){}getInlineStyle(t,s,n){let i="";for(var o in s)if("_"!=o.charAt(0)){var a=this.dom.attr(t,"computed_"+o);console.log(o+":"+a);let e=a;if(isNaN(e)||(e=Math.floor(parseFloat(e))),e!=s[o]&&""!=e){let e="";void 0===n[o]||isNaN(a)||(e=n[o]),i+=o+":"+a+e+";"}}return i}buildDisplayableDeviceList(){var t="scroll";let e=this.ud.ude.calc.exec("classesByTag( '#scroll');");var s=e;e=e.split(",");let n="<ul>";n+='<li><a href="javascript:" onclick="'+("window.ud.ude.changeClass( '', 'scroll', '"+s+"');")+'">This screen</a></li>';for(var i=0;i<e.length;i++){var o=e[i];if(""!=o){var a=this.dom.element("UD_appPart").textContent,a=document.getElementsByName(a)[0];let e="";a&&(e+="API.showOneOfClass( '"+a.id+"');",e+="API.followScroll( '"+a.id+"');"),e+="API.changeClass( '"+o+"', '"+t+"', '"+s+"');",n+='<li><a href="javascript:" onclick="'+e+'", ude_p1="'+t+'">',n+=API.translateTerm(o),n+="</a></li>"}}return n+="</ul>",n}appendHTMLblock(e,t,s){}removeChildren(e){e=this.dom.element(e);if(!e)return!1;let t=e.childNodes[0];if(!t)return!1;for(;t;){var s=t;t=t.nextSibling,this.ud.viewEvent("delete",s)}return!0}insertIntoTemplate(e,n,s){let t=e;"string"==typeof e&&(t=this.dom.element(e));let o={};var a=t.childNodes();for(let e=0;a.length;e++){let e=e[i],t=e.classList,s="";for(let e=0;e<n.length;e++)if(t.contains(n[i])){s=n[i];break}s&&(void 0===o[s]?o[s]=[this.getContentWithInlineStyles(e)]:o[s].push(this.getContentWithInlineStyles(e)))}let l="";var e=n[0],r=o[e];for(let t=0;t<r.length;t++){let e=s;for(var d in o){var u=new RegExp("{"+d+"}","g");e=e.replace(u,o[d][t])}l+=e}return l}dispatchNameChange(e){let s=this.dom.element(e);var n=this.dom.elements("span.objectName",s),e=this.dom.elements("div.object",s);if(!n.length&&!e.length)return!0;let i=n.length?n[0]:null;n=i?i.textContent:this.dom.attr(s,"name");let o=e[0];if(n&&0!=o.id.indexOf(n+"_")){var a=o.id.replace("_object","");if(this.dom.element(n))return i&&(i.textContent=a),API.pageBanner("temp",'<span class="error">'+API.translateTerm("Name is already used")+"</span>"),debug({level:1,return:!1},"Can't dispatch name change as name is not unique",n);o.id=n+"_object";var l=n;this.dom.attr(s,"name")!=l&&this.dom.attr(s,"name",this.dom.attr(s,"name").replace(a,l));let t=[];t=this.nodejs?document.querySelectorAll("#"+s.id+" *"):s.querySelectorAll("*");for(let e=0;e<t.length;e++){let s=t[e];if(s!=o){s.id&&(s.id=s.id.replace(a,l));let e=this.dom.attr(s,"ude_bind");e&&this.dom.attr(s,"ude_bind",e.replace(a,l));let t=this.dom.attr(s,"onclick");t&&this.dom.attr(s,"onclick",t.replace(a,l))}}i&&!i.classList.contains("hidden")&&i.classList.add("hidden")}return!0}changeName(e,s=""){let n=API.dom.element(e);if(!n)return debug({level:1,return:!1},"Can't changeName on unfound element",e);if(s||("_TMPnameEdition"==n.id?(e="previous"==(e=API.dom.attr(n,"ude_bind"))?n.previousSibling:"next"==e?n.nextSibling:null,s=n.textContent,n.remove(),n=e):n==window.MENU.editElement&&(i=("SPAN"==n.tagName?n.parentNode:n).previousSibling,(o=API.dom.element("span.objectName",i))&&(s=o.textContent))),s){var i=API.dom.attr(n,"name"),o=i+"editZone";let e=this.dom.element(o),t=i&&e?API.dom.element("span.objectName",e):null;if(t)t.textContent=s;else{if(API.dom.element('[name="'+s+'"]',"document"))return void API.pageBanner("tmp","Duplicate name");API.dom.attr(n,"name",s),"SPAN"==n.tagName&&(n.id=s)}this.dispatchNameChange(n);i=this.dom.element(s+"_object");i&&(o=s+"editZone",e=this.dom.element(o),this.ud.ude.dispatchEvent({event:"save",target:i},e)),this.ud.ude.setChanged(n,!0);s=s.split("_");2!=s.length||isNaN(s[1])||void 0===window.udparams["AutoIndex_"+s[0]]||window.udparams["AutoIndex_"+s[0]]++}return!0}dispatchClassChange(e,s,n=""){e=this.dom.element(e);if(e&&s&&n){if((n=n||this.dom.keepPermanentClass(e.className))!=s){var i=this.dom.elements("*",e);for(let t=0;t<i.length;t++){let e=i[t];e&&e.className&&(e.className=e.className.replace(s,n))}}return!0}}prePostDocName(e){let t=this.dom.children(e),s="",n="",i="";n=1<t.length?(i='<span class="title">'+htmlEntities(t[0].textContent)+"</span>",t[1].textContent!=this.dom.attr(t[1],"ude_place")&&(i+='<span class="subtitle">'+htmlEntities(t[1].textContent)+"</span>"),s=t[0].textContent,t[0].textContent.replace(/ /g,"").substring(0,8)):0<t.length?(s=t[0].textContent,t[0].textContent.replace(/ /g,"").substring(0,8)):(s=e.textContent,s.replace(/ /g,"").substring(0,8));var o=this.dom.udjson.parse(this.dom.attr(e,"ud_extra"));return o&&this.dom.udjson.value(o,"name")&&(o=o.name+"_"+n,e.id=o,this.dom.attr(e,"name",s),this.dom.attr(e,"ud_saveid","yes")),i}}function UDutilities_init(e,t){return new UDutilities(e,t)}if("object"==typeof process&&(module.exports={class:UDutilities,init:UDutilities_init},void 0===global.JSDOM&&"undefined"==typeof window)){console.log("Syntax udutilities.js:OK"),console.log("Start of test program"),console.log("Setting up browser (client) test environment");var envMod=require("../tests/testenv.js");envMod.load(),ud=new UniversalDoc("document",!0,133);let test="Manage part";$$$.buildManagePart(),testResult(test,$$$.dom.elementByName("DocParameters"),$$$.dom.elementByName("Manage").innerHTML),console.log("Test completed"),process.exit()}