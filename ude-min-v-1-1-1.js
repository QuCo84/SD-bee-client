let UD_exTagAndClassInfo={},elementTypesByExTag=null;function TEST_getElementType(e){if(!elementTypesByExTag)for(var t in elementTypes){t=elementTypes[t];elementTypesByExTag[t.exTag]=t}return elementTypesByExTag[ud.dom.attr(e,"exTag")].label}let UD_defaultContentByExTag={"div.page":"","div.part":"","div.zone":"",h1:"...",h2:"...",h3:"...",h4:"...",h5:"...",h6:"...",p:"...",li:"...",td:"...",th:"...","p.sub_paragraph":"...","div.table":"Table{AutoIndex_table}","div.list":"List{AutoIndex_list}","div.graphic":"Illustration{AutoIndex_graphic}","div.linetext":"Text{AutoIndex_text}","div.server":"Server{AutoIndex_server}","div.css":"Style{AutoIndex_style}","div.js":"Javascript{AutoIndex_js}","div.json":"JSON{AutoIndex_json}","div.connector":"Connector{AutoIndex_connector}","div.zoneToFill":"zone{id}","span.field":"...","span.button":"..."},UD_moduleLabels={siteExtract:"modules/connectors/udcsiteextract.js"};const UD_insignificantWords={EN:["and","if","but","a","an","the","of"],FR:["et","si","mais","un","une","le","la","les","du","de","des","dans","sont","pour","en","type"]},UD_wellKnownClasses={active:"active",hidden:"hidden",editing:"editing"},UD_wellKnownElements={botlog:"BVU00000002200000M",docNameHolder:"BVU0000000810{userId_base32}_texts",UD_docParams:"UD_docParams_object"},UD_appAttributes=["data-ud-iheight","data-ud-pageHeight","data-ud-offset","data-ud-cursor","data-ud-debug","data-ud-refresh","data-ud-mode","data-ud-dupdated","data-ud-dchanged","data-ud-oid","data-ud-oidchildren","data-ud-dsent","data-ud-fields","data-ud-saveId","data-ud-type","data-ud-subtype","data-ud-mime","data-ud-key","data-ud-extra","data-ud-attr","data-ud-hidden","data-ud-onupdate","data-ud-onevent","data-ud-prepost","data-ud-model","data-ud-content","data-ud-display","data-ud-follow","data-ud-dbaction","data-ud-defaultPart","data-ud-quotes","data-ud-selection","data-ud-filter","data-ud-saveid","data-ude-datasrc","data-ude-formula","data-ude-bind","data-ude-edit","data-ude-menu","data-ude-input","data-ude-stage","data-ude-mode","data-ude-autosave","data-ude-source","data-ude-onclick","data-ude-noedit","data-ude-place","data-ude-onclickformula","data-ude-rowidformula","data-ude-updateaction","data-ude-validate","data-ude-editzone","data-ude-autoplay","data-ude-onvalid","data-ude-oninvalid","data-ude-accept","data-ude-pageno","data-ude-check","data-ude-input","data-ude-form","data-ude-ui","data-ude-editzone","data-ude-selection","data-ude-filter","data-udc-step","data-udc-scenario","data-udapi-quotes","data-udapi-callbackid","data-udapi-value1","data-cb-type","data-cb-tags","data-rb-time","data-rb-action","data-ud-lang","data-from-model","ud_iheight","ud_pageHeight","ud_offset","ud_cursor","ud_debug","ud_refresh","ud_mode","ud_dupdated","ud_dchanged","ud_oid","ud_oidchildren","ud_dsent","ud_fields","ud_saveId","ud_type","ud_subtype","ud_mime","ud_key","ud_extra","ud_attr","ud_hidden","ud_onupdate","ud_onevent","ud_prepost","ud_model","ud_content","ud_display","ud_follow","ud_dbaction","ud_defaultPart","ud_quotes","ud_selection","ud_filter","ud_saveid","ude_datasrc","ude_formula","ude_bind","ude_edit","ude_menu","ude_edit","ude_stage","ude_mode","ude_autosave","ude_source","ude_onclick","ude_noedit","ude_place","ude_onclickformula","ude_rowidformula","ude_updateaction","ude_validate","ude_editZone","ude_autoplay","ude_onvalid","ude_oninvalid","ude_accept","ude_pageno","ude_check","ude_input","ude_form","ude_ui","ude_editzone","ude-selection","ude-filter","udc_step","udc_scenario","udapi_quotes","udapi_callbackid","udapi_value1","cb_type","cb_tags","RB_time","RB_action","ud_lang","fromModel"],UD_domAttributes=["onclick","contenteditable","onchange","draggable","ondragstart","ondragend","ondrop","class","id","name","src","onscroll","width","height","href","placeholder","title","tagName","style","type","_editable","_datadest","_add","target_id","_onclick","_type","x","y","onmouseover","onmousenter","onmouseout","value","checked","sandbox","spellcheck","max"],UD_styleAttributes=["marginTop","marginLeft","marginBottom","marginRight"],UD_attributes=["ud_dupdated","ud_dchanged","ud_oid","ud_oidchildren","ud_dsent","ud_fields","ud_iheight","ud_textra","ud_type","ud_content","ud_display","ud_onupdate","ud_onevent","ud_refresh"],UD_indexableTags=["table","ul"],UD_lowerCaseAttr=["tagName","contenteditable"],UD_useComputedPrefix="computed_",UD_layoutPrefix="LAY_",UD_themePrefix="THEME_",UD_viewPrefix="view",UD_dateFormats=("object"==typeof process&&(global.UD_layoutPrefix="LAY_",global.UD_themePrefix="THEME_",global.UD_viewPrefix="view"),["YYYY-MM-DD","YYYY-MM-DD hh:mm","YYYY-MM-DD HH:mm","YYYY-MM-DD HH:mm:ii","DD/MM/YYYY","MM/DD/YYYY","DD/MM/YY","MM/DD/YY"]),UD_terms={"This screen":"Cet écran",genericMobile:"Mobile en portrait",genericTabletLandscape:"Tablette en paysage",INPUT_addApage:"INPUT_ajouterUnePage",INPUT_addAdir:"INPUT_ajouterUnRepertoire",INPUT_addAtemplate:"INPUT_ajouterUnModèle",list:"liste",emphasized:"faire sortir",quoted:"citation",chapter:"chapitre","sub-section":"sous-section",graphic:"illustration",collapse:"réduire",expand:"ouvrir",delete:"effacer","Available styles":"Styles disponibles","Current style":"Style actuelle","Available layouts":"Dispositions possibles","Current layout":"Disposition actuelle","Insertable elements":"Insérer un élément","Click on an idea to add to your text":"Cliquez sur une idée pour l'insérer dans votre texte",Use:"Utiliser",Back:"Retour"},LINKSUSER_login=1,UD_before=0,UD_after=1,UD_inside=1;"object"==typeof process&&(module.exports={UD_defaultContentByExTag:UD_defaultContentByExTag,UD_insignificantWords:UD_insignificantWords,UD_exTagAndClassInfo:UD_exTagAndClassInfo,UD_appAttributes:UD_appAttributes,UD_domAttributes:UD_domAttributes,UD_styleAttributes:UD_styleAttributes,UD_indexableTags:UD_indexableTags,UD_lowerCaseAttr:UD_lowerCaseAttr,UD_useComputedPrefix:UD_useComputedPrefix,UD_wellKnownElements:UD_wellKnownElements,UD_terms:UD_terms,UD_moduleLabels:UD_moduleLabels},void 0===global.JSDOM)&&"undefined"==typeof window&&(console.log("Syntax : OK"),console.log("Test completed"));let UDE_attributeValues={"data-ude-edit":{on:"All editing enabled (*default*)",off:"No editing","a CSV list":{title:"Selected editing",items:{delete:"Enable deletion of complete element",text:"Enable text editing",image:"Enable image insertion an deletion",field:"Enable insertion, editing & deleting of fields"}}},"data-ude-menu":{on:"All tools enabled (*default*)",off:"No tools enabled","a CSV list":{title:"Selected tools",items:{style:"Enable deletion of complete element",config:"Enable text editing",web:"Enable image insertion an deletion",ideas:"Enable insertion, editing & deleting of fields"}}},"data-ude-autosave":{on:"Enable auto saving of element (*default*)",off:"Disable auto saving"}},UDE_availableActions={styler:{apiFct:"displayStyle",icon:"/upload/smartdoc/resources/images/brush.png",label:"style",isDefault:!0},config:{apiFct:"configureElement",icon:"/upload/smartdoc/resources/images/tools.png",label:"config",isDefault:!0},cloud:{apiFct:"displayCloud",icon:"/upload/smartdoc/resources/images/cloud-download-outline.png",label:"web",isDefault:!0},ideas:{apiFct:"displayIdeas",icon:"/upload/smartdoc/resources/images/lightbulb-on-30.png",label:"ideas",isDefault:!0},expand:{apiFct:"expand",label:"expand",onlyClasses:["collapsable"]},collapse:{apiFct:"collapse",label:"collapse",onlyClasses:["collapsable"]},update:{apiFct:"setChanged",icon:"Update",label:"update",args:"1",onlyTypes:["div.text","div.css","div.json","div.html","div.js"]},restore:{apiFct:"initialiseElement",icon:"Restore",label:"restore",onlyTypes:["div.text","div.css","div.json","div.html","div.js"]}};"object"==typeof process&&(module.exports={UDE_attributeValues:UDE_attributeValues,UDE_availableActions:UDE_availableActions},void 0===global.JSDOM)&&"undefined"==typeof window&&(console.log("Syntax : OK"),console.log("Test completed"));class UniversalDoc{minTicksToSave=10;maxTicksToFetch=1200;maxTicksDisconnected=1200;autoReloadTicks=0;idleTicks=6e3;ticksInfo=100;ticksToInfo=12e3;minIdStep=300;server="http://dev.rfolks.com";service="webdesk";fetchAction="AJAX_fetch";refreshAction={model:"AJAX_modelShow",model3:"AJAX_modelShow",edit2:"AJAX_show",edit3:"AJAX_show",display2:"AJAX_show"};serverFormName="INPUT_UDE_FETCH";serverTime=0;reverseTagMap={};historyElementId="UD_history";ticks=0;tickOffset;timestamp=0;lastViewEventTicks=0;topElement;elementsToSave=[];elementsToFetch=[];serverRequestId=1;userId;autoLayoutAdjust=!0;ownerId;user_id;mode;sync=!0;ude=null;dom=null;udajax=null;udlocal=null;api=null;networkStatus={connected:!0,secure:!1,session:!0,dchanged:0,dlastfocus:0};info={displayed:!1,dstarted:0,dlastDisplay:0};botlog={busy:!1,openToServer:!1,call:null,log:{}};infoZoneName="";infoZone=null;localStorageStatus={};apiBuffer_requests=UDapiBuffer_requests;triggeredActions=[];currentURL="";unitTesting=!1;currentPage=null;syncRemovePending=[];constructor(t,e=!1,s){var n=!1;if("object"==typeof process&&(this.unitTesting=n=!0),(window.ud=this).topElement=document.getElementById(t),this.topElement){if(this.user_id=s,this.userId=("00000"+s.toString(32)).slice(-5).toUpperCase(),this.ownerId=this.userId,e&&this.topElement.setAttribute("contenteditable","true"),this.dom=new DOM(this.topElement,this),console.log("Page contains "+document.getElementsByTagName("*").length+" elements"),n&&"undefined"==typeof UD_SERVER){const UD_SERVER="http://dev.rfolks.com",UD_SERVICE="webdesk";this.udajax=new UDAJAX(this,"http://dev.rfolks.com","webdesk")}else this.udajax=new UDAJAX(this,UD_SERVER,UD_SERVICE);if(this.udajax&&(this.networkStatus.connected=!0),!n&&window.localStorage&&(this.localStorageStatus.present=!0),void 0===UDapi?this.ude.loadScript("ud-view-model/udapi.js","window.ud.api = new UDapi( window.ud);","UDapi","UDapi"):this.api=setupAPI(this),this.ude=new UDE(this.topElement,this),this.api.ude=this.ude,this.api.calc=this.ude.calc,void 0===window.udAttributes){let e="yes";t=document.getElementsByName("_new_window");1!=t.length||t[0].checked||(e="no"),window.udAttributes={newWindowOnFiles:e}}var i=this.dom.childrenOfClass(this.topElement,"part");for(let e=0;e<i.length;e++){var a=i[e];a.classList.contains("NoEdit")&&this.dom.attr(a,"contenteditable","false")}this.infoZoneName&&(this.infoZone=document.getElementById(this.infoZoneName));var o,s=this.dom.element("UD_mode"),e=(s&&(this.mode=s.textContent),document.getElementById("footer"));e&&this.displayFooter(),this.pageBanner=$$$.getShortCut("pageBanner"),this.botlogUpdate=$$$.getShortcut("botlogUpdate"),this.getParameter=$$$.getShortcut("getParameter"),this.apiPoll=$$$.getShortcut("poll"),setInterval((o=this,function(){o.heartbeat()}),100),window.addEventListener("focus",function(e){window.ud.focusEvent()}),this.initialise(),debug({level:3},"UniversalDoc up and running")}}initialise(){var t=this.dom.elements("*",this.topElement),s=t.length,n=this.dom.udjson.value;void 0===UD_exTagAndClassInfo&&(UD_exTagAndClassInfo=UD_register.UD_exTagAndClassInfo);for(let e=0;e<s;e++){var i=t[e],a=this.dom.attr(i,"exTag"),o=this.dom.attr(i,"ud_oid");if(i.nodeType==Node.ELEMENT_NODE&&o&&(n(UD_exTagAndClassInfo[a],"earlyInit")||n(UD_exTagAndClassInfo[a],"useTextEditor")))try{this.initialiseElement(i.id)}catch(e){console.log("ERR. Can't initialise "+i.id,e)}else this.dom.attr(i,"onclick")&&!API.testEditorAttr(i,"ude_edit")&&this.dom.attr(i,"contenteditable","false")}var l=this.dom.elements("li.viewoutline",this.dom.element("document-outline")),r=this.dom.element("view-selector"),e=this.dom.element("div.part:not(.hidden)",this.dom.element("document")),d=this.dom.attr(e,"name");let u="";if(r&&l&&1<l.length&&800<window.innerWidth){for(let n=0;n<l.length;n++){var c=l[n],h=c.textContent,c=(u||"app"!=this.dom.attr(c,"ud_type")||(u=this.dom.attr(c,"name")),h.toLowerCase().replace(/ /g,"_")+"sel"),m="API.switchView( '"+h+"', '"+c+"');";let e="tab",t=(-1<["managesel","botlogsel","gérersel"].indexOf(c)?e+=" right":e+=" left",d==h&&(e+=" active"),h);15<t.length&&(t=h.substring(0,6)+"..."+h.substring(t.length-6));API.dom.insertElement("span",t,{id:c,class:e,onclick:m,title:h},r,!0,!0);let s=this.dom.elementByName(h);0==this.dom.children(s).length&&setTimeout(function(){API.updateContentAfterEvent(s,{eventType:"emptyView"})},1e3)}API.dom.insertElement("span","+",{id:"newView",class:"tab left",onclick:"API.addView();"},r,!0,!0)}else r&&r.classList.add("hidden");debug({level:1},"Default view "+d+" "+u),u&&window.innerWidth<this.ude.minWidthFloater?API.switchView(u):API.switchView(d);let p="view_load_"+d;setTimeout(function(){"function"==typeof global[p]&&global[p]()},1e3)}viewEvent(t,s){if(!(s="string"==typeof s?this.dom.element(s):s)||void 0===s.tagName)return!1;if(!(-1<["scroll","middleColumn","content","body"].indexOf(s.id))){this.lastViewEventTicks=this.ticks;let e=this.dom.getSaveableParent(s);switch(e&&e!=s&&(e.classList.contains("page")||e.classList.contains("part"))&&(e=null),t){case"focus":break;case"changeClass":case"change":if(!e||"__NONE__"==this.dom.attr(e,"ud_oid")||""==this.dom.attr(e,"ud_oid")||""==this.dom.attr(e,"ud_dchanged")||""==this.dom.attr(e,"ud_dupdated"))return debug({level:1,return:null},"Cannot set as changed an unknown or incorrect element",s);this.dom.attr(e,"ud_dchanged",this.ticks);break;case"changeTag":var n=this.computeId(s),n=(n!=s.id&&(s.id=n,this.dom.attr(s,"ud_saveId","yes")),this.buildName(s));n&&this.dom.attr(s,"name",n),this.dom.attr(s,"ud_dchanged",this.ticks);break;case"createView":{let e=this.dom.parentAttr(s.parentNode,"ud_oid");e="UniversalDocElement--"+e.split("--")[1]+"-21-0",this.dom.attr(s,"ud_oid",e),this.dom.attr(s,"ud_dupdated",this.ticks-1),this.dom.attr(s,"ud_dchanged",this.ticks),this.dom.attr(s,"ud_dbaction","insert")}break;case"create":{(!s.id||s.id.length<17||0==s.id.indexOf("__TMP"))&&(s.id&&0==s.id.indexOf("__TMP")&&(s.id=""),s.id=this.computeId(s));let e=s.parentNode,t=("page"==this.dom.attr(e,"ud_type")&&(e=e.parentNode),this.dom.parentAttr(e,"ud_oid"));-1<t.indexOf("_FILE_UniversalDocElement")?(n=t.split("--"),t=n[0]+"-_FILE_UniversalDocElement-"+s.id+"--"+n[1]+"-21-0"):t+="-"+t.split("--")[1].split("-").slice(0,1)+"-0",this.dom.attr(s,"ud_oid",t),this.dom.attr(s,"ud_dupdated",this.ticks-1),this.dom.attr(s,"ud_dchanged",this.ticks),this.dom.attr(s,"ud_dbaction","insert"),this.dom.attr(s,"ud_saveId","yes"),s.innerHTML=s.innerHTML.replace(/{id}/g,s.id);n=this.buildName(s);n&&this.dom.attr(s,"name",n);break}case"move":n=s.id;s.id=this.computeId(s,!0),this.dom.attr(s,"ud_saveId","yes"),this.dom.attr(s,"ud_dchanged",this.ticks),debug({level:3},"Moved "+n+"to "+s.id);break;case"delete":e&&(this.dom.attr(e,"ud_dchanged",this.ticks),this.dom.attr(e,"ud_dbaction","remove"),this.dom.attr(s,"ud_dsent")||this.syncRemovePending.push(e.id));break;case"server remove":s.remove()}return e}}computeId(t,e=!1){var s=[];let n=-1,i="";var a=t.id;let o=t.parentNode,l=5;for(;!o.classList.contains("part")&&l--;)o=o.parentNode;if(!o.classList.contains("part"))return debug({level:2,return:!1},"Can't find element's part in parts",t);i=this.dom.attr(o,"id").substring(0,13);for(var r=this.dom.childrenOfClass(this.topElement,"part"),d=0;d<r.length&&this.dom.attr(r[d],"id").substring(0,13)!=i;d++);if(d==r.length)return debug({level:2,return:!1},"Can't find element's part in parts",t,r);var u=r[d],c=(i=i.substring(0,3),u.getElementsByTagName("*"));for(let e=0;e<c.length;e++){var h=c[e],m=this.dom.attr(h,"id");this.dom.attr(h,"ud_oid")&&15<=m.length&&m.substring(0,3)==i?(s.push(m),h==t&&(n=s.length-1)):h==t&&(n=s.length,s.push("BTOFIND"))}let p=null,g=(1<=n&&(p=this.dom.element(s[n-1])),null);-1<n&&n<s.length-1&&(g=this.dom.element(s[n+1]));let f,v,b,x;f=p?parseInt(p.id.substring(3,13),32):1;u=parseInt("VVVVVVVVVV",32)-2*this.minIdStep,v=g?parseInt(g.id.substring(3,13),32):Math.min(f+16*this.minIdStep,u),u=Math.round((f+v)/2);let y=f+.5*this.minIdStep,T=v-.5*this.minIdStep;T<y&&(debug({level:2},"renumbering required (server or JS)"),y=f+10,(T=v-10)<=y)&&(alert("Technical issue with block ids, reloading"),this.reload(!0));var E=f+this.getDBidStepFactor(t)*this.minIdStep;if(b=E<T&&E>y?E:u<T&&u>y?u:T,!e){E=parseInt(a.substring(3,13),32);if(a&&E<b)return a}return debug({level:3},"newId :"+(b=b.toString(32))),x=("00000"+this.userId).slice(-5).toUpperCase(),i+("0000000000"+b).slice(-10).toUpperCase()+x}viewModelEvent(e,t){}focusEvent(){this.networkStatus.dlastfocus=this.ticks;var e=Date.now()-this.timestamp;this.ticks+=Math.round(e/100),e>=this.maxTicksToFetch&&(this.ticks=Math.round(this.ticks/this.maxTicksToFetch)*this.maxTicksToFetch-5),debug({level:3},"Window has focus")}heartbeat(){this.ticks++,this.timestamp=Date.now();var t=this.networkStatus.session,t=(void 0===this.networkStatus.save?this.networkStatus.save={connected:this.networkStatus.connected,secure:this.networkStatus.secure,session:t}:this.networkStatus.save.session!=t?(this.networkStatus.save.session=t,this.networkStatus.dchanged=this.networkStatus.dlastfocus||this.ticks,this.networkStatus.dlastfocus=0):!t&&this.ticks-this.networkStatus.dchanged>this.maxTicksDisconnected?(this.networkStatus.dchanged=this.ticks,this.reload("UniversalDocElement--21--{OIDPARAM}"!=this.dom.attr(this.topElement,"ud_oid"))):t&&this.infoZone&&!this.info.display&&this.ticks-this.info.dlastDisplay>this.ticksToInfo?(this.info.display=!0,this.info.dstarted=this.ticks,this.infoZone=document.getElementById(this.infoZoneName)):this.infoZone&&this.info.display&&this.ticks-this.info.dstarted>this.ticksInfo&&(this.pageBanner("clear"),this.infoZone.style.display="none",this.info.display=!1,this.info.dlastDisplay=this.ticks),this.autoReloadTicks&&this.ticks>this.autoReloadTicks&&this.ticks-this.lastViewEventTicks>this.idleTicks&&(this.dom.cursor.save(),this.reload(!1),this.lastViewEventTicks=this.ticks,this.dom.cusor.restore()),!1),t=0<this.elementsToSave.length|0<this.elementsToFetch.length;if(t=(t|=this.botlogUpdate("busy")|this.ude.isBusy()|this.udajax.isBusy())|"onloaded"!=requirejs_app,this.botlog.busy=t,this.api&&this.api.LED("STATUS_busy",!t),0<this.elementsToSave.length?this.saveElement(this.elementsToSave.shift()):0<this.elementsToFetch.length&&this.fetchElement(this.elementsToFetch.shift()),this.ticks%(this.minTicksToSave/2)==0){var s=document.querySelectorAll("#document *");for(let e=0;e<s.length;e++){var n,i=s[e];1==i.nodeType&&this.dom.attr(i,"ud_dchanged")&&!this.dom.attr(i,"ud_dsent")?(n=parseInt(this.dom.attr(i,"ud_dchanged")),parseInt(this.dom.attr(i,"ud_dupdated"))<n&&this.ticks-n>this.minTicksToSave&&-1==this.elementsToSave.indexOf(i)&&(debug({level:5}," Save ",this.dom.attr(i,"ud_oid")),this.elementsToSave.push(i))):"yes"==this.dom.attr(i,"ud_refresh").toLowerCase()&&this.ude.dispatchEditEvent(i,{event:"refresh"})}this.ticks%this.maxTicksToFetch==0&&this.syncWithServer()}if(this.apiPoll&&this.apiPoll(5),(this.ticks%50==0||this.ticks<20)&&this.autoLayoutAdjust){var t=window.innerHeight,a=this.dom.element("content"),o=this.dom.element("scroll"),l=this.dom.element("view-selector");if(a&&o){o.offsetHeight;var r=a.offsetHeight;let e=this.ude.tabletMode?t-30:t-70-30;this.dom.element("p9")&&(e-=22),r!=e&&"scroll"==this.dom.attr(o,"computed_overflowY")?(a.style.height=e+"px",t=e,t=(t-=this.dom.attr(o,"computed_marginTop")+this.dom.attr(o,"computed_marginBottom"))-(l?l.offsetHeight:0),o.style.height=t+"px"):r!=e?((l=this.dom.element("document")).offsetHeight,a.style.height=e+"px",l.style.height=e-20+"px"):this.dom.element("footer").classList.remove("hidden")}"yes"==this.getParameter("device_isMobile")&&(this.autoLayoutAdjust=!1)}}displayFooter(){var e=this.dom.element("content"),t=this.dom.element("scroll");e&&t&&(t=t.offsetHeight,e.offsetHeight<t+10&&(e.style.height=t+10+"px"),this.dom.element("footer").classList.remove("hidden"))}saveElement(s){if("string"==typeof s&&!(s=this.dom.element(s)))return debug({level:2,return:!1},"Can't find id to save",s);if(this.dom.isEditable(s)){s.innerHTML;(n=this.dom.attr(s,"ud_hidden"))&&document.getElementById(n);let e="update";e=this.dom.attr(s,"ud_dbaction")?this.dom.attr(s,"ud_dbaction"):e;"insert"==e&&"graphic"==this.dom.attr(s,"ud_type")&&(e="refresh"),debug({level:3},"Server request "+this.serverRequestId,e,s.id);var n=s.parentNode;n&&void 0!==n.classList&&n.classList.contains("page")&&n.scrollHeight>n.clientHeight&&debug({level:2},"Page height too big refresh",n);let t=this.dom.attr(s,"ud_oid");"refresh"==e?(t=this.dom.attr(this.topElement,"ud_oid"),this.ude.dom.cursor.save()):"remove"==e&&(t=t+"--SP|"+(t.split("--")[1].split("-").length/2-1),this.dom.attr(s,"ud_oid",t),this.dom.attr(s,"ud_dbaction","remove"),this.ude.dom.cursor.save(),debug({level:5},"removing ",t));var i,n=this.dom.attr(s,"ud_prepost");n&&(n=parseInt(n)-1,i=this.triggeredActions[n].fct,this.triggeredActions[n].once&&(this.triggeredActions[n]=null,this.dom.attr(s,"ud_prepost","__CLEAR__")),n=i?i(s):"")?(i=s.innerHTML,s.innerHTML=n,this.udajax.postElement(s,t,e,this.getDBtype(s)),s.innerHTML=i):this.udajax.postElement(s,t,e,this.getDBtype(s)),this.dom.attr(s,"ud_dsent",this.ticks)}else this.dom.attr(s,"ud_dupdated",parseInt(this.dom.attr(s,"ud_dchanged"))+1)}refresh(){this.fetchElement(document.getElementById("document"),"AJAX_modelShow"),setTimeout(function(){var e=document.getElementsByName("_new_window");1==e.length&&void 0!==window.udAttributes&&("yes"==window.udAttributes.newWindowOnFiles.toLowerCase()?e[0].checked=!0:e[0].checked=!1)},1e3)}fetchElement(e,t=""){let s=this.dom.attr(e,"ud_oid");"document"==e.id&&(s=this.dom.attr(e,"ud_oidchildren")),t&&""!=t||(t="document"==e.id?this.refreshAction[this.mode]:this.fetchAction);t="/"+this.service+"/"+s+"/"+t+"/";let n="update";var i={element:e,action:n="document"==e.id?"refresh":n,setCursor:!1,ud:this};this.udajax.serverRequest(t,"GET","",i),this.dom.isEditable(e)&&e.classList.add("busy"),this.dom.attr(e,"ud_dsent",this.ticks)}updateElement(e,s){if(this.dom.isEditable(e)){let t;try{t=JSON.parse(s)}catch{return debug({level:1,return:!1},"Non JSON server response",s)}if(!e||!e.id)return debug({level:1,return:!1},"Can't update element",e);if(t.nname!=e.id)return debug({level:1,return:!1},"bad record from server",e.id,t);var s=this.dom.attr(e,"ud_fields"),n=this.getDBtype(e);if(t.newElement)this.dom.attr(e,"_add")&&this.dom.attr(e,0),t.oid&&this.dom.attr(e,"ud_oid",t.oid);else if(void 0!==window.botlogId&&e.id==window.botlogId)e.innerHTML=t.tcontent;else if(-1==t.result.indexOf("OK")&&t.modifiableBy!=this.user_id&&e.innerHTML!=t.tcontent)if(this.dom.cursor.save(),n==t.stype)(!s||-1<s.indexOf("tcontent"))&&(e.innerHTML=t.tcontent),t.nstyle&&(!s||-1<s.indexOf("nstyle"))&&this.dom.attr(e,"class",t.nstyle),this.ude.initialiseElement(e.id),this.dom.attr(e,"ud_display")&&doupdate(this.dom.attr(e,"ud_display"));else if(!s||-1<s.indexOf("stype")){(!s||-1<s.indexOf("tcontent"))&&(e.innerHTML=t.tcontent);n=Object.keys(UD_exTagAndClassInfo).find(e=>UD_exTagAndClassInfo[e].db_type==t.stype);if(void 0===n)return debug({level:2,return:!1},"can't update stype",t);this.dom.changeTag(e,n)}this.dom.attr(e,"ud_dsent",""),1<t.users.length&&(this.minTicksToFetch=500/Math.min(t.users.length,10));s=this.dom.attr(e,"ude_edit").split(" ");return t.modifiableBy==t.you?1<s.length&&this.ude.dom.attr(e,"ude_edit",s[1]):s&&1==s.length&&this.ude.dom.attr(e,"ude_edit","Off "+s[0]),this.dom.attr(e,"ud_dupdated",this.ticks),e.classList.remove("busy"),(n=this.dom.attr(e,"ud_onupdate"))&&(n=parseInt(n)-1,s=this.triggeredActions[n].fct,this.triggeredActions[n].once&&(this.triggeredActions[n]=null,this.dom.attr(e,"ud_onupdate","__CLEAR__")),s)&&s(e),t.newElements&&this.syncWithServer(),!0}console.log(e.id+" is not editable so cannot be updated")}isDirListing(){var e=this.dom.element("UD_docModel");return!(!e||0!=e.textContent.indexOf("Basic model for home directories"))}syncWithServer(s=null,n="",e){if(s){var t=s.ud,i=t.dom,a=JSONparse(n),o=Object.keys(a).length;if(!a)return debug({level:2,return:!1},"Bad server response",n);if(1<o&&debug({level:2},"Changed elements count",a.length),"model"==t.mode&&2<o)t.reload(!0);else for(var l in a){var r=a[l],d=t.dom.element(l);if(d)"UD_user"==l?(c=t.dom.element(l).textContent,r.content!=c?t.networkStatus.session=!1:t.networkStatus.session=!0,void 0!==r.time&&(t.serverTime=r.time)):"__DELETED"==r.oid?t.viewEvent("server remove",d):r.ticks>=t.dom.attr(d,"ud_dupdated")&&("A"==l[0]?t.reload(!1):t.elementsToFetch.push(d));else if("__DELETED"!=r.oid){if("A"==l[0])return void t.reload(!1);var u,c=r.before,d=t.dom.element(c),h=r.after,h=t.dom.element(h),m=r.oid,p=r.parent;p?(p=i.element(p))&&(g=i.prepareToInsert("p","...",{ud_oid:m}),0==(u=i.children(p)).length||-1==u.indexOf(d)?p.appendChild(g):p.insertBefore(g,d),t.elementsToFetch.push(g)):d?(u=t.dom.insertElement("p","...",{id:l,ud_oid:m,ud_dupdated:t.ticks,ud_dchanged:t.ticks},d,!1),t.elementsToFetch.push(u)):h?(p=t.dom.insertElement("p","...",{id:l,ud_oid:m,ud_dupdated:t.ticks,ud_dchanged:t.ticks},h,!0),t.elementsToFetch.push(p)):t.reload(!1)}else{var g=t.syncRemovePending.indexOf(l);-1<g?t.syncRemovePending.splice(g,1):"__DELETED"==r.oid?console.log("Deleted element is absent",a,l):l&&"A"!=l[0]&&"Basic model for home directories"!=l&&(console.log("Delete an unfound object in",a),t.reload(!1))}}}else if(this.sync){n=this.dom.attr(this.topElement,"ud_oid");let t=this.dom.attr(this.topElement,"ud_oidchildren");if(n){"model1"!=this.mode&&"model"!=this.mode||!this.isDirListing()||"UniversalDocElement--21"!=(t=n.replace("--{OIDPARAM}",""))&&(t+="-21");o=Date.now()/1e3;let e=Math.round(o-this.maxTicksToFetch/10);this.serverTime&&10<Math.abs(e-this.serverTime)&&(e+=this.serverTime-e);n="/"+UD_SERVICE+"/"+t+"/AJAX_getChanged/?lastTime="+e;s={element:this.topElement,ud:this};this.udajax.serverRequest(n,"GET","",s,this.syncWithServer)}}}isFetchable(e){var t=e.tagName.toLowerCase();return-1<["p","h1","h2","h3","h4","h5","h6"].indexOf(t)||"div"==t&&""!=this.ude.dom.attr(e,"ude_type")}getDBtype(e){var t=this.dom.udjson.value;let s=t(UD_exTagAndClassInfo[this.dom.attr(e,"exTagType")],"db_type");return s=(s=s||t(UD_exTagAndClassInfo[this.dom.attr(e,"exTag")],"db_type"))||t(UD_exTagAndClassInfo["p.undefined"],"db_type")}getDBidStepFactor(e){let t=(0,this.dom.udjson.value)(UD_exTagAndClassInfo[this.dom.attr(e,"exTagType")],"db_id_step_factor");return t=t||2}addTool(e,t,s,n,i=""){this.dom.element(t+"-icon")&&this.dom.element(t+"-icon").remove();var a=document.createElement("div"),o=document.createElement("img"),s=(o.src=s,document.createElement("a")),l=document.createTextNode(t),o=(s.appendChild(o),s.appendChild(document.createElement("br")),s.appendChild(l),s.title=t,i&&(s.title=i),s.href="javascript:","");let r=e.replace("-selector","-zone"),d=(o+="window.ud.loadTool( this,'"+e+"', '"+n+"','"+r+"');",this.dom.attr(s,"onclick",o),a.appendChild(s),this.dom.attr(a,"class","tool-icon"),this.dom.attr(a,"id",t+"-icon"),this.dom.element(e).appendChild(a),t);if("tagger"==t.toLowerCase()&&(d="Inserter"),-1<n.indexOf(".js"))try{this.unitTesting?requirejs(["modules/"+n.replace(".js","")],function(){window.ud.ude.modules["modules/"+n]={src:n,instance:null,state:"loaded"},doOnload("window.ud.ude.modules['modules/"+n+"']['instance'] = new window."+d+"( window.ud, '"+r+"');")}):void 0===window.ud.ude.modules["modules/"+n]&&(window.ud.ude.modules["modules/"+n]={src:n,instance:null,state:"loading"},requirejs(["modules/"+n.replace(".js","")+version],function(){doOnload("window.ud.ude.modules['modules/"+n+"']['instance'] = new "+d+"( window.ud, '"+r+"');window.ud.ude.modules['modules/"+n+"']['state']='loaded';")}))}catch(e){console.log("Load ERR",e.message,d,n)}}loadTool(e,t,s,n){var i,a=document.getElementById(t);for(i in a.childNodes)"object"==typeof a.childNodes[i]&&a.childNodes[i].classList.remove("selected");e.parentNode.classList.add("selected"),document.getElementById(n).innerHTML="",-1<s.indexOf(".js")?(t=this.ude.modules["modules/"+s].instance)&&t.event("open"):(s=s.replace(/{topOID}/g,this.dom.attr(document.getElementById("document"),"ud_oid")),this.unitTesting||new UDAJAX(this,"").serverRequest(s+"/e|open/","GET","",{action:"fill zone",zone:n}))}clearTools(e,t){var s=document.getElementById(e).childNodes;for(let e=s.length;0<e;e--)s[e-1].remove();e=document.getElementById(t).getElementsByTagName("img")[0];return this.dom.attr(e,"src","/upload/N3u2U2g3W_emptyIcon50.png"),!0}loadDocument(e){var t,s;return this.unitTesting||-1<e.indexOf("AJAX_")?(t=(t=e.split("/")).splice(3,t.length-3).join("/"),s={action:"refresh",element:this.topElement,zone:"document"},this.udajax.serverRequest(t,"GET","",s)):document.location=e,!0}reload(e=!0,t=""){var s=this.refreshAction[this.mode];let n=this.service+"/"+this.dom.attr(this.topElement,"ud_oid")+"/"+s+"/";return this.isDirListing()&&(n=this.service+"/"+this.dom.attr(this.topElement,"ud_oid")+"-21/"+s+"/"),e?(s={action:"refresh",element:this.topElement},t&&(n+=t+"/"),this.udajax.serverRequest(n,"GET","",s)):location.reload(!0),!0}addToHistory(e){this.currentURL=e;var t,s=this.dom.element(this.historyElementId);return!!s&&(-1==(t=s.textContent.split(",")).indexOf(e)&&t.push(e),s.textContent=t.join(","),!0)}back(){var e,t=this.dom.element("UD_history").textContent.split(",");2<t.length&&1<(e=t.indexOf(this.currentURL))&&(t=t[e-1],this.loadDocument(t))}setClipboardHandler(e){return this.ude.clipboardHandler=e,this}insertElement(e,t,s){this.dom.insertElement_old(e,t,s)}insertText(e,t="plain"){this.ude.insertTextAtCursor(e,t)}prepareHTML(e){}reserveElement(){}insertTable(e,t){return this.ude.insertTableAtCursor(e)}initialiseElement(e){this.ude.initialiseElement(e)}updateTable(e){let t=e;e=this.dom.element(e);return!!e&&("DIV"==e.tagName&&(t=e.getElementsByTagName("table")[0].id),this.ude.updateTable(t))}updateGraphic(e){return this.ude.updateGraphic(e)}insertHTML(e,t){return this.ude.insertHTML(e)}clientSideInterpretor(e){commande}setModel(e,t=!1){var s="reload",n=(debug({level:3},"Server request model "+this.serverRequestId,s,e),this.dom.attr(this.topElement,"ud_oid"));let i="nstyle="+e;t&&(i+="&stype=3"),i=(i+="&input_oid="+n)+"&form="+this.serverFormName;t="/"+this.service+"/"+n+"/AJAX_show/",n={element:this.topElement,action:s,setCursor:!1,ud:this},this.udajax.serverRequest(t,"POST",i,n,null),s=$$$.getShortcut("translateTerm"),t='<div style="text-align:center"><img src="https://www.sd-bee.com/upload/3VUvtUCVi_processing.gif"><br>';t+=s("Initialisation de la page")+" "+s("avec")+" "+e,this.topElement.innerHTML=t+=".</div>",window.scrollTo(0,0)}copyModel(e){return this.setModel(e,!0)}makeDirectory(e){var t="close",s=(debug({level:3},"Server request model "+this.serverRequestId,t,e),this.dom.attr(this.topElement,"ud_oid")),n="nstyle="+e,s=(n=(n=(n+="&stype=1")+("&tContent="+this.dom.element("UD_docFull").innerHTML.replace("Nouveau document","Nouveau repertoire")))+("&input_oid="+s)+("&form="+this.serverFormName),"/"+this.service+"/"+s+"/AJAX_fetch/"),t={element:this.topElement,action:t,setCursor:!1,ud:this},s=(this.udajax.serverRequest(s,"POST",n,t,null),'<div style="text-align:center"><img src="https://www.sd-bee.com/upload/3VUvtUCVi_processing.gif">');this.topElement.innerHTML=s+="<br>Création d'un repertoire avec "+e+".</div>",window.scrollTo(0,0)}setSystemParameters(e){var t="reload",s=(debug({level:3},"Server request system params"+this.serverRequestId,t,e),this.dom.attr(this.topElement,"ud_oid")),e='textra={"system":{'+JSON.stringyfy(e)+"}",s=(e=e+("&input_oid="+s)+("&form="+this.serverFormName),"/"+this.service+"/"+s+"/"+this.refreshAction[this.mode]+"/"),t={element:this.topElement,action:t,setCursor:!1,ud:this};this.udajax.serverRequest(s,"POST",e,t,null)}delay(t){return new Promise(e=>{setTimeout(e,t)})}async docParameter(e,n,i=null){if(e&&e!=$$$.getParameter("UD_wellKnown/UD_wellKnownElements/UD_currentDocument","register")){var a=this.dom.elementByName(e);if(!a){a=this.getDocInfo(e);let t={},s="";return a.then(e=>{(t=$$$.json.parse("UD_spare"))&&(s=$$$.json.value(t.params,n),i)&&(t.params=$$$.json.value(t.params,n,i))}).catch(e=>console.log("docParamater",e)),await a,t=$$$.json.parse("UD_spare"),s=$$$.json.value(t.params,n)}}else{$$$.buildManagePart();e=$$$.json.valueByPath("UD_docParams_object","data/value/"+n);if(await this.delay(50),null==i)return e;$$$.json.valueByPath("UD_docParams_object","data/value/"+n,i);a=$$$.dom.element("MANAGE_params");$$$.dispatchEditEvent({event:"update"},a),$$$.setChanged(a)}return i}async getDocInfo(e){var t,s=e.split("/");return 1==s.length?(t="UniversalDocElement--"+this.dom.attr("document","ud_oid").split("--")[1].split("-").splice(0,2).join("-"),$$$.servicePromise("doc",{action:"getInfo",dir:t,doc:e,dataTarget:"UD_spare",dataMap:{info:"info",params:"params"}},!0)):(t=s.pop(),e=s.join("/"),$$$.servicePromise("doc",{action:"getInfo",dirPath:e,doc:t,dataTarget:"UD_spare",dataMap:{info:"info",params:"params"}},!0))}setStyle(e){this.ude.setStyle(e)}addStyleRules(e){e=(e=e.replace(/\n/g,"")).split("}");var t,s=document.createElement("style");for(t in s.appendChild(document.createTextNode("")),document.head.appendChild(s),e)if(-1!=e[t].indexOf("{"))for(var n=e[t]+"}",i=(s.sheet.insertRule(n,s.sheet.length)||debug({level:1},"addStyleRules Fail on",n),n.substring(0,n.indexOf("{"))),a=(-1<i.indexOf(".")&&(i=i.substring(i.indexOf(".")+1)),document.getElementById("document").getElementsByClassName(i)),o=0;o<a.length;o++){var l=a[o];l.classList.remove(i),l.classList.add(i)}}translateTerm(e,t=0){return debug("Deprecated call to ud.translateTerm"),console.err("Deprecated call to ud.translateTerm"),API.translateTerm(e,replaceUnderscore)}buildPartEditing(e){var s=this.dom.element(e);if(!s)return debug({level:2,return:null},"Can't find part editing zone",e);var e=window.udparams.outlineId,t=this.dom.element(e);if(!t)return debug({level:2,return:null},"Can't find outline or outlineId",e);var n=t.getElementsByTagName("li");for(let t=0;t<n.length;t++){var i=n[t],a=this.dom.attr(i,"target_id"),a=this.dom.element(a);let e=!0;var o,l=this.dom.attr(a,"ud_extra");l&&this.dom.udjson.parse(l).fromModel&&(e=!1),a&&(l=a.id,a=this.dom.attr(a,"ud_oid"),i=i.innerHTML,(o=document.createElement("p")).id=l+"_manage",o.className=e?"viewname":"viewname noedit",this.dom.attr(o,"ud_oid",a),this.dom.attr(o,"ud_fields","tcontent"),this.dom.attr(o,"ud_dupdated",""+this.ticks),this.dom.attr(o,"ud_dchanged",""+this.ticks),this.dom.attr(o,"ude_stage","on"),this.dom.attr(o,"ude_menu","off"),o.innerHTML=i,s.appendChild(o))}return s}buildName(e){let t="",s=0,n="";var i,a=this.dom.element("span.caption",e);return n=a?a.textContent:e.innerHTML,(s=-1<n.indexOf("AutoIndex_")?n.match(/{AutoIndex_([^}]*)}/):s)&&(i="AutoIndex_"+s[1],void 0===window.udparams[i]&&(window.udparams[i]=1),t=n.replace("{"+i+"}",window.udparams[i]),window.udparams[i]++,a?a.textContent=t:e.innerHTML=t),t}run(e){return this.api.run(e)}onTrigger(e,t,s,n=!0){var i=this.dom.element(e);let a=0;for(let e=0;e<this.triggeredActions.length;e++)this.triggeredActions[e]||(a=e+1,this.triggeredActions[e]={fct:s,once:n});switch(a||(this.triggeredActions.push({fct:s,once:n}),a=this.triggeredActions.length),t){case"update":this.dom.attr(i,"ud_onupdate",a);break;case"prepost":this.dom.attr(i,"ud_prepost",a)}}}const UDapiBuffer_requests="UDErequest";class UDapiRequest{constructor(e,t,s=null){var n,i="",a="",o=null;"object"==typeof e&&(t=e.command,void 0!==e.quotes&&(i=e.quotes),void 0!==e.callbackId&&(a=e.callbackId),e=e.caller,s=null),s&&(n=API.dom,o=s.target||s)&&(n.attr(o,"udapi_quotes")&&(i=n.attr(o,"udapi_quotes")),n.attr(o,"udapi_callbackid")&&(a=n.attr(o,"udapi_callbackId")),n.attr(o,"udapi_value1")&&(t=t.replace("%value1","'"+n.attr(o,"udapi_value1")+"'")),o.getAttribute("id"))&&(t=t.replace("%id","'"+n.attr(o,"id")+"'")),i&&(t=t.replace(new RegExp(i.charAt(0),"g"),"'").replace(new RegExp(i.charAt(1),"g"),"'")),document.getElementById(UDapiBuffer_requests).textContent+=e+"|"+t+"|"+a+"\n",debug({level:4},"API - command submitted",e,t,a),-1<["Outline"].indexOf(e)&&leftColumn.switchDisplayMode()}}if("object"==typeof process&&(module.exports={UniversalDoc:UniversalDoc,UDapiRequest:UDapiRequest,UDapiBuffer_requests:UDapiBuffer_requests},void 0===global.JSDOM)&&"undefined"==typeof window&&"undefined"==typeof ModuleUnderTest){ModuleUnderTest="ud.js",console.log("Syntax : OK"),console.log("Start of ud.js test program"),console.log("Setting up browser (client) test environment");var envMod=require("../tests/testenv.js");envMod.load(),ud=new UniversalDoc("document",!0,133);const connMod=require("../modules/connectors/udeconnector.js"),drawMod=(connMod.init(),require("../modules/editors/udedraw.js"));let test="Test 1 : retrieve content from integrated page",before=("Hello big world"==ud.ude.dom.value("B0100000001000000M...textContent")?console.log(test+": OK"):console.log(test+": KO "+ud.ude.dom.value("B0100000001000000M...textContent")),ud.updateElement(ud.dom.element("B0100000001000000M"),'{"stype":10, "nname" : "B0100000001000000M", "nstyle":"", "tcontent":"Hello again", "result":"", "users":"22", "newElement": 0, "modifiableBy":202}'),"Hello again"==ud.dom.value("B0100000001000000M...textContent")?console.log("Test update: OK"):console.log("Test update: KO "+ud.dom.value("B0100000001000000M...textContent")),TEST_serverSaving=!1,API.dom.element("B010000000500000M")),el=document.createElement("p");function nextTest(e){switch(e.testNo){case 2:var t="webdesk/UniversalDocElement--21-725-21--UD|3|NO|OIDLENGTH|CD|5/show/tusername|demo/tpassword|demo/";console.log("GET from server",t),e.udajax.serverRequest(t,"GET","",{ud:e,action:"reload"});break;case 3:"Text"==e.dom.value("B01000000B0000000M...textContent")?console.log("Test 2 : OK"):console.log("Test 2 : KO",e.topElement.innerHTML);break;case 4:console.log("Program's trace checksum: "+debug("__CHECKSUM__")),console.log("Test completed : OK"),process.exit()}e.testNo++}el.textContent="inserted",before.parentNode.insertBefore(el,before),ud.viewEvent("create",el),testResult("Insert test","B0100000001IO00045"==el.id,el.id),API.dom.attr(el,"ud_dupdated",API.dom.attr(el,"ud_dchanged")),ud.Zone=Zone,ud.UDapiRequest=UDapiRequest,ud.domjs=domjs,ud.testNo=2,nextTest(ud),setInterval(function(){nextTest(ud)},5e3)}var UDE_attributes=["ude_datasrc","ude_autosave","ude_stage","ude_onvalid","ude_oninvalid","ude_bind","ude_place","ude_onvalid","ude_oninvalid"],DEBUG_level,displaylib,envMod;class UDE{useCE=!0;bookChangesTimeout=5;modules={"div.table":{src:"modules/editors/udetable.js",state:"required",onload:"new UDEtable( window.ude.dom, window.ude);",instance:null,extags:"div.table",className:"UDEtable"},"div.linetext":{src:"modules/editors/udetext.js",state:"required",onload:"new UDEtext( window.ude.dom, window.ude);",instance:null,extags:"div.linetext",className:"UDEtext"},"div.list":{src:"modules/editors/udelist.js",state:"required",onload:"new UDElist( window.ude.dom, window.ude);",instance:null,extags:"div.list",className:"UDElist"},"div.graphic":{src:"modules/editors/udedraw.js",state:"required",onload:"new UDEdraw( window.ude.dom, window.ude);",instance:null,extags:"div.graphic",className:"UDEdraw"},"div.chart":{src:"modules/udchart/udechart.js",state:"required",onload:"new UDEchart( window.ude);",instance:null,extags:"div.chart",className:"UDEchart"},Udapi:{src:"ud-view-model/udapi.js",state:"required",onload:"new UDapi( window.ude);",instance:null,extags:"",className:"UDapi"},"div.html":{src:"modules/editors/udehtml.js",state:"required",onload:"new UDEhtml( window.ude);",instance:null,extags:"div.html",className:"UDEhtml"},"div.connector":{src:"modules/connectors/udeconnector.js",state:"required",onload:"new UDEconnector( window.ud);",instance:null,extags:"div.connector",className:"UDEconnector"},"div.video":{src:"modules/players/udevideo.js",state:"required",onload:"new UDEvideo( window.ud);",instance:null,extags:"div.video",className:"UDEvideo"}};virtualKeyboardMaxTime=15;menuManager=null;layoutManager=null;editElement=null;editingElement=null;editRestoreHTML=null;editRestoreAttr={};ticks=0;registerAPI=null;dom=null;calc=null;tableEd=null;draw=null;textEd=null;clipboard=null;topOid="";container=null;dataSource=null;updateForm="updateform";modified=!1;directions=["None","Up","Down","Left","Right"];escapedChars={">":"&gt;","<":"&lt"};lastChar="";lastMouseEvent=null;lastMouseEvent=0;stylePopup=null;drawMouse=null;touchMove=!1;externalExchange={request:null,reply:null};dependencies=null;needUpdate=new Array;lockNeedUpdate=!1;mode="";isMobile=!1;forceStagedEditing=!1;tabletMode=!1;maxElementTopOffset=-1;keyDownTime=0;keyUpTime=0;mouseDownTime=0;mouseUpTime=0;averageKeyboardTime=17;ignoreKeyup=!1;watchElementForChange=null;watchElementTextContent="";emulateMobile=!1;elementToScroll=null;lastClickPosition={x:-1,y:-1};inputField=null;replacedElement=null;displayToRestore="block";clipboardHandler=null;enterCommand="/!";endCommand="!/";commandMode=!1;command="";nonEditableClasses=["Noedit"];includePath="/upload/smartdoc/";testing=!1;dummy="...";constructor(e,t,s=0){"object"==typeof process&&(this.testing=!0,window.DOM,window.UDEcalc),this.container=e,(this.dataSource=t)&&"object"==typeof t.dom?this.dom=t.dom:this.dom=new DOM(e,this),this.calc=new UDEcalc(this.dom,this),this.registerAPI=window.UD_resources,this.mode=$$$.dom.textContent("UD_mode"),window.ude=this,void 0!==UDE_menu&&(this.menuManager=new UDE_menu(this)),void 0!==UDE_layout&&(this.layoutManager=new UDE_layout(this)),"undefined"!=typeof API&&API&&(API.addFunctions(this,["changeTagOnCurrent","changeTag","changeClassOnCurrent","changeSubType","changeClass","toggleClass","setAttribute","insertElement","updateElement","updateTable","removeElement","followScroll","initialiseElement","loadScript","getEditType","setChanged","insertTextAtCursor","replaceTextAtCursor","insertHTMLatCursor","isLongClick","dispatchEditEvent","clearClasses","requires2stageEditing","leave2stageEditing","is2stageEditing"]),API.setupUDElinks(this)),void 0!==UDEclickHandler?this.clickHandler=new UDEclickHandler(this):this.clickEvent({type:"start"}),this.keyEvent({type:"start"}),this.pointEvent({type:"start"}),this.dataActionEvent({type:"start"});var n,t=this.dom.element("scroll"),e=(t&&t.addEventListener("scroll",function(e){window.ude.scrollEvent(e)}),document.getElementById("leftColumn")),t=document.getElementById("rightColumn");if(e&&t&&(e.addEventListener("dragstart",function(e){window.ude.dataActionEvent(e)}),t.addEventListener("dragstart",function(e){window.ude.dataActionEvent(e)}),e.addEventListener("dragend",function(e){window.ude.dataActionEvent(e)}),t.addEventListener("dragend",function(e){window.ude.dataActionEvent(e)}),e.addEventListener("drop",function(e){window.ude.dataActionEvent(e)}),t.addEventListener("drop",function(e){window.ude.dataActionEvent(e)})),void 0!==s&&(this.ticks=s),setInterval((n=this,function(){n.tick()}),100),this.useCE&&!this.testing&&document.execCommand("defaultParagraphSeparator",!1,"p"),!this.testing&&this.container.getAttribute("contenteditable")&&"true"==this.container.getAttribute("contenteditable").toLowerCase()&&!this.dom.cursor.restore()){this.dom.cursor.HTMLelement=null,window.scrollTo(0,0);var i=this.container.childNodes,a=10;for(let e=0;e<i.length;e++){var o=i[e];if(o&&1==o.nodeType){var l=o.classList;if(!l.contains("hidden")&&!l.contains("system")){this.dom.cursor.HTMLelement=o;break}}}if(this.dom.cursor.HTMLelement)for(;"DIV"==this.dom.cursor.HTMLelement.tagName&&--a&&this.dom.elements("*",this.dom.cursor.HTMLelement).length;)this.dom.cursor.HTMLelement=this.dom.elements("*",this.dom.cursor.HTMLelement)[0];this.dom.cursor.HTMLelement&&(this.dom.cursor.textElement=this.dom.cursor.HTMLelement.firstChild,this.dom.cursor.textElement)&&3!=this.dom.cursor.textElement.nodeType&&(this.dom.cursor.HTMLelement=this.dom.cursor.HTMLelement.firstChild,this.dom.cursor.textElement=this.dom.cursor.HTMLelement.firstChild,this.dom.cursor.HTMLoffset=0,this.dom.cursor.set())}var r=this.dom.elements("div.part","document");for(let e=0;e<r.length;e++){var d=r[e];if("false"==this.dom.attr(d,"contenteditable")){var u=this.dom.elements("span.field",d);for(let e=0;e<u.length;e++){var c=u[e];"off"!=this.dom.attr(c,"ude_edit")&&(this.dom.attr(c,"contenteditable","true"),this.dom.attr(c,"ude_edit","on"),""==this.dom.attr(c,"ude_menu"))&&this.dom.attr(c,"ude_menu","off")}}}void 0!==window.UDincludePath?this.includePath=window.UDincludePath:(e=document.getElementsByTagName("script")).length&&-1<e[0].src.indexOf("smartdoc_prod")&&(this.includePath="/upload/smartdoc_prod/");var t=this.dom.element("UD_device_isMobile"),s=(t&&(this.isMobile=parseInt(t.textContent)),this.dom.element("UD_requiredModules").textContent),e=(window.ude=this,"div.table");"undefined"==typeof UDEtable?-1==s.indexOf("udetable")&&(t=this.modules[e],this.loadScript(t.src,"window.ude.tableEd  = window.ude.modules['"+e+"']['instance']="+t.onload,t.className,e)):this.tableEd=this.modules[e].instance=new UDEtable(this.dom,this),e="div.graphic","undefined"==typeof UDEdraw?-1==s.indexOf("udedraw")&&(t=this.modules[e],this.loadScript(t.src,"window.ude.draw  = window.ude.modules['"+e+"']['instance']="+t.onload,t.className,e)):this.draw=this.modules[e].instance=new UDEdraw(this.dom,this),e="div.linetext",void 0===UDEtext?-1==s.indexOf("udetext")&&(t=this.modules[e],this.loadScript(t.src,"window.ude.textEd= window.ude.modules['"+e+"']['instance']="+t.onload,t.className,e)):this.textEd=this.modules[e].instance=new UDEtext(this.dom,this),window.rollbacker=null}tick(){var e;this.lastChangeElement&&this.ticks-this.lastChangeTicks>this.bookChangesTimeout&&("off"!=this.dom.getParentAttribute("","ude_autosave",this.lastChangeElement)?this.setChanged(this.lastChangeElement):this.dom.getSaveableParent(this.lastChangeElement).classList.add("modified"),this.lastChangeElement=null),this.lastMouseEvent&&this.ticks-this.lastMouseEventTime==2&&(this.lastMouseEvent=null),this.watchElementForChange&&this.watchElementForChange.textContent!=this.watchElementTextContent&&this.dataSource.viewEvent("change",this.watchElementForChange),this.ticks%50!=0||this.forceStagedEditing||"on"!=this.dom.attr(this.container,"ude_stage")||(this.forceStagedEditing=!0,this.tabletMode=!0,this.maxElementTopOffset=Math.round(.4*window.innerHeight),this.dom.element("header").classList.add("hidden"),this.dom.element("escapeButton"))||((e=this.dom.insertElement("span","ESC",{id:"escapeButton",class:"button"},this.dom.element("content"),!0,!0)).style.cssText="position:absolute; z-index:20; top:50px; left:10px;",e.addEventListener("click",function(e){window.ude.leave2stageEditing(!1)}),(e=this.dom.element("content")).style.height=e.clientHeight+50+"px"),this.ticks++,6<this.ticks&&this.ticks%5==0&&this.calc.do(50)}isBusy(){for(var e in this.modules)if("loading"==this.modules[e].state)return!0;return!1}clickEvent(n){let i=!1;if("start"==n.type)return this.dom.topElement.addEventListener("click",function(e){window.ude.clickEvent(e)}),this.dom.topElement.addEventListener("touchstart",function(e){window.ude.clickEvent(e)}),this.dom.topElement.addEventListener("touchend",function(e){window.ude.clickEvent(e)}),!0;if(this.drawMouse)this.drawMouse=null;else{n.event=n.type;let s=n.target;if(!s&&void 0!==n.composedPath){var t=n.composedPath();for(let e=0;e<t.length;e++){var a=t[e];if(-1<a.className.indexOf("Noedit")&&(this.dom.cursor.set(),i=!0),"document"==a.id)break}}if("document"==s.id)return n.preventDefault(),!0;if(0==this.dom.parentAttr(s,"id").indexOf("_TMP"))return!1;if(this.watchElementForChange=null,!this.menuManager.click(s,n)){let e=!1;""==this.dom.parentAttr(s,"onclick")&&"a"!=s.tagName&&"a"!=s.parentNode.tagName||(e=!0);var o=this.dom.attr(s,"exTag");let t=!0;if((!s||"div.page"==o||!API.testEditorAttr(s,"ude_edit")&&"input"!=o||e&&"link"!=this.dom.attr(s.parentNode,"ud_type"))&&(t=!1),"mousedown"==n.type)this.mouseDownTime=this.ticks,t||n.preventDefault();else if("mouseup"==n.type)this.mouseUpTime=this.ticks,t||n.preventDefault();else if("touchstart"==n.type)this.touchMove=!1;else if("touchend"!=n.type||!this.touchMove){if(!i&&t){if(this.editElement&&this.clearClasses(this.editElement,"editing,edcontainer,edinside"),this.editElement=null,this.dom.cursor.fetch(),i=i||this.dispatchEvent(n,s),this.requires2stageEditing(s)&&(s=this.editingElement),!i&&this.registerAPI.testEditorAttr(s,"ude_menu")&&(o=this.dom.getSaveableParent(s),l=this.dom.getEditableParent(s,this.dom.cursor.selectionInNode),this.toggleClass(o,"editing"),this.clearClasses(o,"edcontainer"),this.clearClasses(s,"edinside"),0!=this.dom.attr(l,"exTag").indexOf("span")||l.classList.contains("caption")||(this.toggleClass(o,"edcontainer"),this.toggleClass(s,"edinside")),this.editElement=o,this.dom.cursor.selectionInNode&&-1==["div.editzone"].indexOf(this.dom.attr(l,"exTag"))&&!l.classList.contains("linetext")?i=this.menuManager.display(this.dom.getEditableParent(s),this.dom.cursor):this.dom.cursor.selectionMultiNode?this.menuManager.hide():i=this.menuManager.display(s)),!i&&this.emulateMobile){let t=this;this.dom.topElement.addEventListener("mousemove",function(e){t.pointEvent(e)});var o=n.clientX,l=n.clientY;this.lastClickPosition.x=o,this.lastClickPosition.y=l,i=!0}}else"INPUT"==s.tagName||e?i=!1:e?(this.editElement&&this.clearClasses(this.editElement,"editing,edcontainer,edinside"),this.editElement=null,this.menuManager.hide(),this.leave2stageEditing(!0),this.dom.cursor.clear()):(n.ud_clickable=!1,n.ud_editable=!1,i=i||this.dispatchEvent(n,s),this.dom.cursor.set(),this.dom.getSaveableParent(s).classList.contains("collapsable")&&(this.editElement=null,this.menuManager.hide(),this.leave2stageEditing(!0),this.editElement=this.dom.getSaveableParent(s),this.menuManager.display(this.editElement),i=!0));return i&&n.preventDefault(),i}}}}isLongClick(e){return!1}detectVirtualKeyboard(e){"keydown"==e&&(this.keyDownTime=(new Date).getTime()),"keyup"==e&&(this.keyUpTime=(new Date).getTime(),e=this.keyUpTime-this.keyDownTime,this.averageKeyboardTime=Math.round(this.averageKeyboardTime+(e-this.averageKeyboardTime)/2),e<this.averageKeyboardTime&&debug({level:5},"New record keyboard time !: ",e,this.averageKeyboardTime),this.averageKeyboardTime<this.virtualKeyboardMaxTime?this.forceStagedEditing=!0:this.forceStagedEditing=!1)}keyEvent(e){let s=!1;if("start"==e.type)return this.dom.topElement.addEventListener("keypress",function(e){window.ude.keyEvent(e)}),this.dom.topElement.addEventListener("keydown",function(e){window.ude.keyEvent(e)}),this.dom.topElement.addEventListener("keyup",function(e){window.ude.keyEvent(e)}),!0;let n=this.dom.cursor.fetch().HTMLelement;if(n&&n.id&&0==n.id.indexOf("_TMP"))return!1;var i=this.dom.cursor.textElement;if(debug({level:6},"Key "+e.key,e,n),!n||this.menuManager.click(n))return!1;var a=this.dom.attr(n,"exTag"),o=this.dom.getSaveableParent(n),l=this.dom.getDisplayableParent(n);if(!this.testing&&!this.dom.isInViewport(n))return!1;this.detectVirtualKeyboard(e.type);let t=e.key,r=(e.ctrlKey&&(t+="_ctrl",e.shiftKey)&&(t+="_shift"),"");switch(t){case"Escape":(this.leave2stageEditing(!1)||this.inlineCommandManager(t))&&(s=!0),this.dom.cursor.clear();break;case"Backspace":case"Delete":if("input"!=a){n;if("keyup"==e.type)API.getEditorAttr(n,"ude_place")&&""==n.textContent&&n.classList.add("placeHolding"),this.ignoreKeyup?s=!0:this.is2stageEditing(this.dom.cursor.HTMLelement)||"off"==this.dom.getParentAttribute("","ude_autosave",this.dom.cursor.HTMLelement)||window.rollbacker&&window.rollbacker.inputEvent({event:"change",content:n.innerHTML},n),this.setChanged(n);else if("keydown"==e.type||"keypress"==e.type){if(this.ignoreKeyup=!1,r="Key "+t,s=this.dispatchEvent({event:r,saveable:o,displayable:l},n),r="",s)break;var d=this.dom.cursor;if(this.dom.cursor.selectionMultiNode){this.dom.getSaveableParent(n);setTimeout(function(){window.ud.ude.dispatchEvent({event:"change",multinode:"true"},n)},100)}else if(d.selectionInNode&&(d.textElement&&(c=(u=d.textElement).textContent,d.textOffset,d.focusOffset,u.textContent=c.substr(0,d.textOffset)+c.substr(d.focusOffset)),d.selectionInNode=!1,s=!0,this.dom.cursor.set()),this.is2stageEditing(n)&&n.textContent){if(!(this.dom.cursor.textOffset<=1))return;n.textContent=n.textContent.substring(1),this.dom.cursor.textElement=n.childNodes[0],this.dom.cursor.set(),s=!0}else{var u=this.dom.cursor.textElement,c=u?u.textContent:"",d=(0==this.dom.cursor.textOffset&&"Backspace"==t?r="merge up":this.dom.cursor.textOffset==c.length&&"Delete"==t?r="merge down":""!=n.innerHTML&&"<br>"!=n.innerHTML||(r="remove"),n.innerHTML),c=API.getEditorAttr(n,"ude_place");c&&d==c&&(this.dom.cursor.textElement.textContent=""),r&&(this.dispatchEvent({event:r,saveable:o,displayable:l},n)?s=!0:this.editEventDefault({type:r,textEl:u},n),s=!0)}}}break;case"Enter":case"Enter_shift":case"\n":case"\r":if("input"!=n.tagName.toLowerCase())if(this.dom.isEditable(n))if("keydown"==e.type||"keypress"==e.type)e.preventDefault();else{d={event:"newline",type:"newline",HTMLoffset:this.dom.cursor.HTMLoffset};if(e.shiftKey){var c=document.createElement("br"),u=document.createTextNode("..."),h=this.dom.cursor.textElement,m=this.dom.cursor.textOffset,p=h.textContent,p=(m<p.length&&(u.textContent=p.substr(m),h.textContent=p.substr(0,m)),Array.from(n.childNodes)),m=p.indexOf(h);if(m<0)break;++m>=p.length?(n.appendChild(c),n.appendChild(u)):(n.insertBefore(c,p[m]),n.insertBefore(u,p[m])),this.dom.cursor.textElement=u,this.dom.cursor.textOffset=0,this.dom.cursor.set(),this.setChanged(n),s=!0}else(s=this.leave2stageEditing(!0))||!n.classList.contains("caption")&&(s=this.dispatchEvent(d,n))||(s=this.editEventDefault(d,n))}else s=!0;break;case"Tab":if("keyup"==e.type)s=!0;else{let t=null;switch(a){case"th":case"td":if(e.shiftKey)if(n.previousSibling)t=n.previousSibling;else{let e=n.parentNode;(e=e&&e.previousSibling)&&(t=e.cells[e.cells.length-1])}else if(n.nextSibling)t=n.nextSibling;else if("th"==a)r="insert column";else{let e=n.parentNode;(e=e&&e.nextSibling)?t=e.cells[0]:r="newline"}t?(this.dom.cursor.setAt(t),this.leave2stageEditing(!0),this.requires2stageEditing(t),s=!0):r&&(s=!!this.dispatchEvent({event:r,saveable:o,displayable:l},n)||this.editEventDefault({type:r,textEl:i},n))}}break;case"Insert":case"Shift":s=!0;break;case"c_ctrl":case"C_ctrl":case"c_ctrl_shift":case"C_ctrl_shift":case"v_ctrl":case"V_ctrl":case"v_ctrl_shift":case"V_ctrl_shift":case"x_ctrl":case"X_ctrl":case"x_ctrl_shift":case"X_ctrl_shift":"keydown"!=e.type&&(s=!0);break;case"shift":case"Shift":case"shift_shift":case"Shift_shift":case"control":case"Control":case"Control_ctrl":case"control_ctrl":case"altGraph":case"AltGraph":s=!0;break;case"ArrowLeft":if(this.editingElement==n){this.dom.cursor.textOffset<=0&&(this.leave2stageEditing(!0),n=n.previousSibling)&&(this.dom.cursor.setAt(n,1e4),this.requires2stageEditing(n));break}if(n.classList.contains("objectName")&&0==this.dom.cursor.textOffset){s=!0;break}case"ArrowRight":if(this.editingElement==n){this.dom.cursor.textOffset>=n.textContent.length-1&&(this.leave2stageEditing(!0),n=n.nextSibling)&&(this.dom.cursor.setAt(n,0),this.requires2stageEditing(n));break}if("ArrowRight"==t&&n.classList.contains("objectName")&&this.dom.cursor.textOffset==n.textContent.length){s=!0;break}case"ArrowUp":case"ArrowDown":this.leave2stageEditing(!0),"keyup"!=e.type||this.menuManager.box||this.floaterActionPending?(h={event:t,type:t,saveable:o,displayable:l},(s=this.dispatchEvent(h,n))&&(n=this.dom.cursor.fetch().HTMLelement,this.requires2stageEditing(n))):s=this.edit();break;case"PageUp":case"PageDown":if("keyup"==e.type&&!this.menuManager.box&&!this.floaterActionPending){let e=o.parentNode;"div.page"==this.dom.attr(e,"exTag")&&(c=(e="PageDown"==t?e.nextSibling.nextSibling:e.previousSibling.previousSibling).childNodes[0])&&(this.dom.cursor.setAt(c),this.dom.makeVisible(c)),s=!0}break;default:"input"==a?(p=this.dom.attr(n,"ude_accept").replace(/this/g,t))&&!this.calc.eval(p)&&(s=!0):this.inlineCommandManager(t)?e.preventDefault():(this.editingElement||("Unidentified"!=t&&this.requires2stageEditing(n)||(window.rollbacker&&window.rollbacker.inputEvent({event:"change",content:n.innerHTML},n),(this.lastChangeElement&&n!=this.lastChangeElement||-1<[";"].indexOf(t))&&("off"!=this.dom.getParentAttribute("","ude_autosave",n)?this.setChanged(n):o.classList.add("modified"),this.lastChangeElement=null),this.lastChangeElement=n,this.lastChangeTicks=this.ticks),"P"==n.tagName&&n.classList.contains("undefined")&&20<n.textContent.length&&(n.classList.remove("undefined"),n.classList.add("standard"),this.dataSource.viewEvent("changeTag",n))),this.lastChar=t,this.hasDefaultContent(n)&&"keydown"==e.type&&("Unidentified"==t?n.innerHTML="":(n.innerHTML=t,this.dom.cursor.textElement=n.firstChild,this.dom.cursor.textOffset=1,this.dom.cursor.HTMLoffset=1,this.dom.cursor.set(),s=!0)),n.classList.contains("undefined")&&(n.classList.remove("undefined"),this.changeTag("p",n.id),n.textContent=t),(m=this.dom.attr(n,"onchange"))&&doOnload(m))}return s&&(debug({level:6},"Stopping propagation"),this.ignoreKeyup=!0,e.preventDefault(),void 0!==e.stopPropagation&&e.stopPropagation(),o)&&this.menuManager&&this.menuManager.updatePosition(o),s}pointEvent(e){let t=!1;if("start"==e.type)return this.dom.topElement.addEventListener("mouseover",function(e){window.ude.pointEvent(e)}),this.dom.topElement.addEventListener("mousewheel",function(e){window.ude.pointEvent(e)}),this.dom.topElement.addEventListener("focus",function(e){window.ude.pointEvent(e)}),this.dom.topElement.addEventListener("blur",function(e){window.ude.pointEvent(e)}),this.dom.topElement.addEventListener("touchmove",function(e){window.ude.pointEvent(e)}),!0;this.lastMouseEvent=e,this.lastMouseEventTime=this.ticks;let s=e.target,n=null;var i,a,o;switch((n=void 0!==e.composedPath?e.composedPath():e.path)&&"canvas"==n[0].tagName.toLowerCase()&&(s=n[0],i=this.dom.getSaveableParent(s),"div.graphic"==this.dom.attr(i,"exTag"))&&(this.drawMouse=s),e.type){case"touchmove":2<Object.keys(e.changedTouches).length&&(this.touchMove=!0);break;case"mousemove":t=this.emulateMobile&&this.elementToScroll?(e.clientX,a=e.clientY,-1<this.lastClickPosition.x&&(this.lastClickPosition.x,a=a-this.lastClickPosition.y,o=this.dom.element("scroll"),o=this.elementToScroll.scrollHeight/this.dom.attr(o,"computed_height"),0<a)&&(this.elementToScroll.style.marginTop=-a*o+"px"),!0):this.dispatchEvent({event:e.type,target:s},s);break;case"mouseout":this.lastMouseEvent=null,t=this.dispatchEvent({event:e.type,target:s},s);break;case"mousedown":case"touchstart":t=this.dispatchEvent({event:e.type,target:s},s);break;case"mouseup":case"touchend":this.drawMouse?(t=this.draw.inputEvent(e,this.drawMouse),this.drawMouse=null):t=this.dispatchEvent({event:e.type,target:s},s);break;case"mousewheel":this.drawMouse&&(t=this.draw.inputEvent(e,s))}return t&&e.preventDefault(),t}dataActionEvent(a){let o=!1,l=!1;if("start"==a.type)return this.dom.topElement.addEventListener("paste",function(e){window.ude.dataActionEvent(e)}),this.dom.topElement.addEventListener("copy",function(e){window.ude.dataActionEvent(e)}),this.dom.topElement.addEventListener("cut",function(e){window.ude.dataActionEvent(e)}),this.dom.topElement.addEventListener("dragstart",function(e){window.ude.dataActionEvent(e)}),this.dom.topElement.addEventListener("dragend",function(e){window.ude.dataActionEvent(e)}),this.dom.topElement.addEventListener("drop",function(e){window.ude.dataActionEvent(e)}),this.dom.topElement.addEventListener("dragover",function(e){window.ude.dataActionEvent(e)}),this.dom.topElement.addEventListener("contextmenu",function(e){window.ude.dataActionEvent(e)}),(e=this.dom.element("middleColumn"))&&(e.addEventListener("dragenter",function(e){window.ude.dataActionEvent(e)}),e.addEventListener("dragover",function(e){window.ude.dataActionEvent(e)}),e.addEventListener("drop",function(e){window.ude.dataActionEvent(e)})),!0;debug({level:6},"Data action",a.type,a.target,a);var r=this.dom.cursor.fetch().HTMLelement,e=this.dom.getSaveableParent(r);this.dom.getDisplayableParent(r);let d=null,u=null,c=[];var h=this.dom.attr(e,"exTag");switch(a.type){case"paste":let s="",n="",i="";var m=this.dom.element("LastClip");if(m)i=this.dom.attr(m,"cb_type"),s=m.innerHTML;else{document.getElementById("UDEclipboard");var p=a.clipboardData.types;if(p instanceof DOMStringList&&p.contains("text/html")||p.indexOf&&-1!==p.indexOf("text/html"))i="text/html",s=a.clipboardData.getData("text/html"),n=a.clipboardData.getData("text/plain");else if((p instanceof DOMStringList&&p.contains("text/plain")||p.indexOf&&-1!==p.indexOf("text/plain"))&&(i="text/plain",s=a.clipboardData.getData("text/plain"),this.is2stageEditing(r))){$$$.hasDefaultContent(r)?r.textContent=s:this.insertTextAtCursor(s),o=!0;break}}if(this.clipboardHandler){p=this.dom.getEditableParent(r);let e=this.dom.attr(p,"ud_type"),t=(-1<["editzone","viewzone"].indexOf(e)&&(e=this.dom.attr(p,"ud_subtype")),"html");-1<["text","linetext","css","json","js","htmltext","connector"].indexOf(e)&&(t="text",n)&&"htmltext"!=e&&(s=n),c=this.clipboardHandler.preparePasteEvents(this.clipboardHandler.preparePastedData(i,s),t)}else s&&(u={event:"paste",type:"paste",data:s,mime:i});m&&m.remove(),o=!0;break;case"copy":case"cut":debug(1,null,"2DO copy/cut events",a),-1<["div.css","div.js"].indexOf(h)&&-1==UD_SERVER.indexOf("https//")&&(l=!0),(u=a).event=u.type;break;case"drag":case"dragstart":console.log("Drag Start event",a);p=a.target;let e="",t="";0==p.id.indexOf("move")?(t=p.id.substr(4),e=""):"img"==p.tagName.toLowerCase()&&p.classList.contains("CLIPBOARD")||(p.classList.contains("CLIPBOARD_clip")?(e=a.target.innerHTML,t=a.target.id):"dir"==this.dom.attr(p.parentNode.parentNode.parentNode.parentNode,"id")&&(e=this.dom.attr(p.parentNode.parentNode,"onclick"),t="dir")),a.dataTransfer.setData("text/html",e),a.dataTransfer.setData("text/plain",t),a.stopPropagation(),o=!1;break;case"dragenter":"middleColumn"==(d=a.target).id&&(o=!0);break;case"dragover":a.dataTransfer.dropEffect="move",o=!0;break;case"dragend":case"drop":console.log("Drop event"),console.log(a);var m=a.dataTransfer.getData("text/html"),p=a.dataTransfer.getData("text/plain"),g=a.composedPath();if(d=this.dom.getSaveableParent(g[0])){g=this.dom.element(p);if("UD_wasteBin"==d.id){let e=m.split("/")[2];var f="UniversalDocElement--"+(e=e.split("--")[1].split("-").slice(0,-1)).join("-")+"--SP|"+(Math.round(e.length/2)-1)+"|WB|1",v="/webdesk/"+this.dom.attr("document","ud_oidchildren")+"/AJAX_modelShow/",b=API.translateTerm("Are you sure ?");confirm(b)&&(b={zone:"document",element:null,action:"fill zone",setCursor:!1,ud:this.dataSource},this.dataSource.udajax.serverRequest(v,"POST","form=INPUT_UDE_FETCH&input_oid="+f+"&iaccess=0&tlabel=owns",b))}else this.dom.getSaveableParent(d)==d&&this.dom.attr(g,"ud_oid")?"middleColumn"==d.id?API.copyToClipboard(p,!0):d.id&&"B"==d.id[0]&&(v=d.parentNode.insertBefore(g,d),this.dataSource.viewEvent("move",v)):m&&window.clipboarder.insert(p,d)}o=!0;break;case"contextmenu":console.log(a);a.composedPath();this.dom.attr(r,"ud_oid")&&(this.watchElementForChange=r,this.watchElementTextContent=r.textContent)}for(let e=0;e<c.length;e++){var t=c[e];this.dispatchEvent(t,r)||this.editEventDefault(t,r)}return(o=u?(o=this.dispatchEvent(u,r))||this.editEventDefault(u,r):o)&&!l&&-1<!["copy"].indexOf(a.type)&&(a.preventDefault(),void 0!==a.stopPropagation)&&a.stopPropagation(),o}scrollEvent(e){this.menuManager&&this.menuManager.scroll(e)}editEventDefault(o,l){if(l){let a=!1;var r=o.type,d=this.dom.getSaveableParent(l),u=this.dom.attr(d,"exTag"),c=["h1","h2","h3","h4","h5","h6","p","p.undefined","span","span.field"];if(-1==c.indexOf(u)&&"newline"!=r)return!1;switch(r){case"merge up":var h=o.textEl,m=Array.from(h.parentNode.childNodes).indexOf(h),p=l.previousSibling;!m&&p&&-1<c.indexOf(this.dom.attr(p,"exTag"))?(p.innerHTML+=(l=d).innerHTML,this.setChanged(p),this.dom.cursor.setAt(p,9999),l.innerHTML="",API.removeElement(l.id),a=!0):m&&((p=h.previousSibling)&&p.nodeType==Node.ELEMENT_NODE&&"BR"==p.tagName?(p.previousSibling.textContent+=h.textContent,p.remove(),h.remove(),a=!0):p&&p.nodeType==Node.TEXT_NODE&&(p.textContent+=h.textContent,h.remove(),a=!0));break;case"merge down":var m=o.textEl,p=Array.from(m.parentNode.childNodes).indexOf(m),h=l.nextSibling;!p&&h&&-1<c.indexOf(this.dom.attr(h,"exTag"))?(h.innerHTML=(l=d).innerHTML+h.innerHTML,this.setChanged(h),this.dom.cursor.setAt(h,0),l.innerHTML="",API.removeElement(l.id),a=!0):p&&((h=m.nextSibling)&&h.nodeType==Node.ELEMENT_NODE&&"BR"==h.tagName?(h.nextSibling.textContent+=m.textContent,h.remove(),m.remove(),a=!0):h&&h.nodeType==Node.TEXT_NODE&&(h.textContent+=m.textContent,m.remove(),a=!0));break;case"remove":l.innerHTML="",this.source.viewEvent("remove",l),a=!0;break;case"insert row":case"newline":let e="div",t="undefined",s="";p=$$$.availableTags(d);1==p.length&&(h=p[0].split("."),e=h[0],t=1<h.length?h[1]:"standard",s="...");let n=!1;-1<c.indexOf(u)&&(m=this.dom.cursor.textElement.textContent.length,0==(p=this.dom.cursor.textOffset)?n=!0:p<m&&(h=this.dom.cursor.HTMLelement.innerHTML,m=this.dom.cursor.computeHTMLoffset(this.dom.cursor.textElement.textContent,p,h),s=h.substr(m),t="",this.dom.cursor.HTMLelement.innerHTML=h.substr(0,m),"off"!=this.dom.getParentAttribute("","ude_autosave",this.dom.cursor.HTMLelement))&&this.setChanged(this.dom.cursor.HTMLelement));p={class:t},h=this.insertElement(e,s,p,d,!n);s||"undefined"!=t||(h.innerHTML=$$$.getUndefinedElementContent(h)),this.editElement&&this.toggleClass(this.editElement,"editing"),this.editElement=null,this.menuManager.hide(),this.toggleClass(h,"editing"),this.editElement=h,this.dom.cursor.setAt(h),this.menuManager.display(h),a=!0;break;case"copy":window.clipboarder.copyTo();a=!0;break;case"cut":window.clipboarder.copyTo("",!0);a=!0;break;case"paste":m=this.dom.cursor.HTMLelement;let i=o.data;p=this.dom.attr(l,"exTag");if(("image"==o.type||i&&-1<i.indexOf("<img"))&&(h=/src="([^"]+)"/.exec(o.data)[1],f=1.3*l.getBoundingClientRect().height,i='<img src="'+h+'" style="max-height:'+f+'px;">',o.type="image"),console.log("Default pasting",i,l),this.dom.hasDefaultContent(m)?m.innerHTML=i:this.insertHTMLatCursor(i),0==p.indexOf("span")){h=document.createTextNode("Enter to validate"),h=l.appendChild(h);this.dom.cursor.HTMLelement=l,this.dom.cursor.textElement=h,this.dom.cursor.textOffset=0,this.dom.cursor.set()}else if("image"==o.type){var g=d.classList;for(let e=0;e<g.length&&!(-1<g[e].indexOf("LAY_"));e++)e==g.length-1&&d.classList.add("LAY_left")}this.requires2stageEditing(this.dom.cursor.HTMLelement)||this.setChanged(this.dom.cursor.HTMLelement);case"endPaste":a=!0;break;case"setValue":var f=o.key;f.unshift(l.id),this.dom.value(f,o.value,l),API.setEditorAttrPermanently(l,f[f.length-1],o.value);break;case"use":case"idea":API.insertTextAtCursor(o.data)}return a&&d&&this.menuManager&&this.menuManager.updatePosition(d),a}}loadScript(t,s,e="",n=""){var i=(i=t.split("/").pop().split(".",1).pop()).charAt(0).toUpperCase()+i.slice(1);if(void 0!==this.modules[t]&&"required"!=this.modules[t].state){if("loaded"==window.ud.ude.modules[t].state)return s&&doOnload(s),!0}else{if(!this.testing){{console.log("loading "+t);i=document.createElement("script");n=n||t,i.id=n,i.onerror=function(){debug({level:2},t+" is not available"),window.ud.ude.modules[n].state="unavailable"},i.onload=function(){if(!(-1<window.ud.ude.dom.element(n).textContent.indexOf("SOILinks error :")))return debug({level:2},t+" is loaded (old method)"),window.ud.ude.modules[n].state="loaded",window.ud.ude.modules[n].onload&&doOnload(window.ud.ude.modules[n].onload),!0;debug({level:2},t+" is not available"),window.ud.ude.modules[n].state="unavailable"};let e="";void 0!==this.modules[n]&&(e=this.modules[n].state),-1==["undefined","unavailable"].indexOf(e)&&(i.src=this.includePath+t.replace(".js","")+window.version+".js",document.body.appendChild(i),n?this.modules[n]={state:"loading",onload:s}:this.modules[t]={state:"loading",onload:s})}return!1}var i=require("../"+t);e&&n&&(e=i.class,i=doOnload(s.replace(/new[^\(]*\(/,"new "+e+"(")),void 0!==this.modules[n])&&(this.modules[n].state="loaded",this.modules[n].instance=i)}}loadCustomModule(e,t){var s="modules/custom/"+e.toLowerCase()+".js",n="new "+e+"( window.ude.dom, window.ude);";return this.modules[t]={src:s,state:"required",onload:n,className:e,instance:null,exTags:t},this.loadScript(s,n,e,t)}dataEvent(e,t){switch(e){case"created":this.initialiseElement(t);break;case"changed":this.updateElement(t)}}updateTable(e,t=!1){var s;this.tableEd?this.tableEd.update(e,t):(s=this,setTimeout(function(){s.updateTable(e,t)},100))}initialiseElement(t){window.UDE_init=!0;let s=this.dom.element(t);if(s){let e=s.tagName.toLowerCase();var t=this.dom.attr(s,"ud_type"),n=(t&&(e+="."+t),this.dom.udjson.value),t=(this.dom.udjson.valueByPath,t&&n(UD_exTagAndClassInfo[e],"useTextEditor")&&(e="div.linetext"),this.modules[e]);if(t){if(t.instance)t.instance.initialise(s.id);else if(console.log("Module required but not yet loaded "+t.src),1==s.childNodes.length&&"{"==s.childNodes[0].textContent[0]&&n(UD_exTagAndClassInfo[e],"earlyInit")){debug({level:5},"Default initialising",s);var i,t=s.childNodes[0].innerHTML,t=JSON.parse(t),a=JSONvalue(t,"meta");if(a&&(i=JSONvalue(a,"name"),t=this.dom.udjson.putElement(t,i+"_object","",this.dom.keepPermanentClasses(s.className,!0)),s.appendChild(t),-1<["div.table"].indexOf(e)&&this.updateTable(a.name),1<(i=this.dom.elements("div",t)).length)&&(i[0].classList.add("hidden"),i[1].classList.remove("hidden")),n(UD_exTagAndClassInfo[e],"needsOwnInit")){let e=this;setTimeout(function(){e.initialiseElement(s)},100)}}else{let e=this;setTimeout(function(){e.initialiseElement(s)},100)}window.UDE_init=!1}}else window.UDE_init=!1}updateGraphic(e){var t=document.getElementById(e),t=this.dom.attr(t,"ude_bind");this.draw.renderToCanvas(t,e)}getValueFromTable(e,t,s){return this.dom.getValueFromTable(e,t,s)}setStyle(e){debug({level:1},"Old call UDE.setSTyle DEPRECATED"),this.dom.cursor.setStyle(e)}substr(e,t,s){return e.substr(t,s)}changeTagOnCurrent(e){var t,s,e=this.dom.availableTags[e].split("."),n="";1<e.length&&(n=e[1]),e=e[0],this.dom.cursor.HTMLelement&&(s=(t=this.dom.cursor.HTMLelement).id,this.dom.changeTag(t,e,n),t=this.dom.element(s),this.dataSource.viewEvent("changeTag",t),n)&&this.initialiseElement(s)}changeTag(s,n,i=""){let a=s;s=(a=(Number.isInteger(s)?this.dom.availableTags[s]:s).split(".")).join(".");let o="",l=(1<a.length&&(o=a[1]),a=a[0],this.dom.element(n));if(!l)return null;n=l.id;if("p.undefined"==s)(l="p"!=this.dom.attr(l,"exTag")?this.dom.changeTag(l,"p"):l).classList.contains("editing")?l.className="undefined editing":l.className="undefined";else{let e="changeTag";var r=this.dom.attr(l,"exTag"),d=this.dom.elements("div.panel-block",l).length,u=l.classList.contains("undefined");(u||d)&&(l.classList.remove("undefined"),l.innerHTML="",e="create"),l=this.dom.changeTag(l,a,o),i&&this.dom.attr(l,"ud_subtype",i);let t=$$$.getTagOrStyleInfo(s,"autoClass");if(t){Array.isArray(t)||(t=t.split(" "));for(let e=0;e<t.length;e++)l.classList.add(t[e])}$$$.updateContentAfterEvent(l,{eventType:"changeTag",oldTag:r,wasUndefined:u}),l=this.dom.element(n),this.dom.cursor.setAt(l);d=this.dom.elements("div.panel-block",l).length;d||this.dataSource.viewEvent(e,l),o&&!d&&this.initialiseElement(l.id)}return this.editElement.id==n&&this.menuManager.display(l),l}changeSubType(e,t){var s=this.dom.element(t);if(!s)return debug({level:3,return:!1},"Can't change subtype on",t);API.dom.attr(s,"ud_subtype",e),e||(s.className=this.dom.keepTemporaryClasses(s.className))}changeClassOnCurrent(e){var t=this.dom.cursor.HTMLelement;if(!t)return!1;this.changeClass(e,t)}changeClass(t,e,s=null,n="document"!=e){let i=this.dom.element(e);if(!i)return debug({level:3,return:!1},"Can't change class on",e);let a=[t],o=(t.indexOf(".")&&(a=t.split(".")),"");if(s){var l="string"==typeof s?s.split(","):s;for(let e=0;e<l.length;e++)i.classList.contains(l[e])&&(o=o||l[e],i.classList.remove(l[e]))}else void 0!==UD_ressources&&API.hasDefaultContent(i,o)&&this.dom.keepPermanentClasses(a.join(" "))&&(i.innerHTML=API.defaultContent(i,API.getViewType(i),a[0]),this.dataSource.viewEvent("changeClass",i));let r=!1;for(let e=0;e<a.length;e++)""!=(t=a[e])&&(i.classList.contains(t)&&e==a.length-1?(i.classList.remove(t),r=!0,o=o||t):-1==t.indexOf(" ")&&(i.classList.add(t),r=!0));return"span"==this.dom.attr(i,"exTag")&&""==this.dom.keepPermanentClasses(i.className)&&(i.parentNode,s=i.previousSibling)&&s.nodeType==Node.TEXT_NODE&&(s.textContent+=i.textContent,i.remove(),i=s,this.editingElement=i,this.clearClasses(this.dom.getSaveableParent(i),"edcontainer")),n&&API.dispatchClassChange(i,o,t),r}toggleClass(e,t){return this.changeClass(t,e)}clearClasses(e,t){var e=this.dom.element(e),s=(this.changeClass("",e,t),this.dom.children(e));for(let e=0;e<s.length;e++)this.changeClass("",s[e],t)}toggleClasses(e,t){return this.changeClass(t.join(","),e)}insertElement(e,t,s={},n=null,i=!1,a=!1){let o=null;if((o=n?this.dom.insertElement(e,t,s,n,i,a):this.dom.insertElementAtCursor(e,t,s)).classList.contains("undefined")){let e="";o.previousSibling?e="_AFTER_"+o.previousSibling.id:o.nextSibling&&(e="_BEFORE_"+o.nextSibling.id),o.id="__TMP"+e+"__"}else this.dataSource.viewEvent("create",o),window.UDE_lastInsertId=o.id,API.paginate(this.dom.getView(o.id));return o}updateElement(e,t){var s=this.dom.element(e),n=this.dom.getSaveableParent(s);return s?(s.innerHTML=t,n&&this.dataSource.viewEvent("change",n),API.paginate(this.dom.getView(s)),s):debug({level:3,return:null},"Can't update ",e)}setAttribute(e,t){debug({level:1},"Old call UDE.setAttribute DEPRECATED"),"outlineCurrentElementCSS"===e&&(this.dom.cursor.outlineCurrentElementCSS=t)}removeElement(e){e=this.dom.element(e);if(!e)return!1;var t=this.dom.getSaveableParent(e);if(t==e){var s=this.dom.attr(t,"exTag");if("div.part"==s||"div.zone"==s){var n=this.dom.children(e);for(let e=0;e<n.length;e++)this.removeElement(n[e])}window.ud.viewEvent("delete",e)}else-1<e.id.indexOf("Zone")?window.ud.viewEvent("delete",e):(e.remove(),window.ud.viewEvent("change",t));this.editElement&&this.clearClasses(this.editElement,"editing,edcontainer,edinside")}focus(e){this.dom.cursor.HTMLelement=this.dom.element(e),this.dom.cursor.HTMLoffset=0,this.dom.cursor.textElement=this.dom.cursor.HTMLelement.firstChild,this.dom.cursor.textOffset=0,this.dom.cursor.set();e=this.dom.cursor.HTMLelement.offsetTop;this.container.parentNode.scrollTop=200<e?e-200:0}edit(t=""){let s=!1;t=t||this.dom.cursor.fetch().HTMLelement;t=this.dom.element(t);if(t&&t!=this.editElement){let e=!0;(e=this.dom.attr(t,"editable")?e:!1)&&t&&t.nodeType==Node.ELEMENT_NODE&&-1==t.className.indexOf("Noedit")&&""==this.dom.parentAttr(t,"onclick")&&"a"!=this.dom.parentAttr(t,"tagName")&&(this.editElement&&this.clearClasses(this.editElement,"editing,edcontainer,edinside"),this.editElement=null,this.menuManager.hide());var n,i;s=s||this.dispatchEvent({event:"focus",type:"focus"},t),this.requires2stageEditing(t),e&&!s&&"off"!=this.dom.extraAttr(t,"ude_menu")&&(n=this.dom.getSaveableParent(t),i=this.dom.getEditableParent(t),this.toggleClass(n,"editing"),this.clearClasses(n,"edcontainer"),this.clearClasses(t,"edinside"),"span"!=this.dom.attr(i,"exTagType")||i.classList.contains("caption")||(this.toggleClass(n,"edcontainer"),this.toggleClass(t,"edinside")),this.editElement=n,this.menuManager.display(this.dom.getEditableParent(t)))}return s}setChanged(e,t=!1){let s=this.dom.element(e);if(void 0===s&&(this.dom.cursor.fetch(),s=this.dom.cursor.HTMLelement),!s)return null;this.dispatchChangeEvent(s),this.calc.checkDependencies(s),API.checkPagination(s);e=this.dom.getSaveableParent(s);if(!e||!t&&"off"==this.dom.parentAttr(s,"ude_autosave").toLowerCase())return null;if(e.classList.remove("initialcontent"),""==this.dom.keepPermanentClasses(e.className,!0)&&e.classList.add("neutral"),e.classList.remove("modified"),"__NONE__"==this.dom.attr(e,"ud_oid"))return null;var t=this.dom.getParentWithAttribute("ude_bind",s),n=this.dom.element(this.dom.attr(t,"ude_bind")),i=this.dom.attr(e,"ud_type");let a=!0;return(a=n&&i?this.dispatchEvent({event:"save",target:n},t):a)?this.dataSource.viewEvent("change",e):null}dispatchEditEvent(t,s){s=this.dom.element(s),t="string"==typeof t?this.dom.udjson.parse(t):t;let n=!1;if(s&&t){void 0!==t.type&&void 0===t.event&&(t.event=t.type);var i=this.dom.getSaveableParent(s);let e=this.dom.attr(i,"exTag");this.dom.udjson.value(UD_exTagAndClassInfo[e],"useTextEditor")&&(e="div.linetext");i=this.modules[e];n=(n=i&&i.instance?i.instance.inputEvent(t,s):n)||this.editEventDefault(t,s)}return n}dispatchEvent(s,n){if(n){void 0!==s.type&&void 0===s.event&&(s.event=s.type);let e=!1;var i=this.dom.getSaveableParent(n);let t=this.dom.attr(i,"exTag");(this.dom.udjson.value(UD_exTagAndClassInfo[t],"useTextEditor")||"linetext"==this.dom.parentAttr(n,"ud_type"))&&(t="div.linetext");i=this.modules[t];return e=(e=i&&i.instance?i.instance.inputEvent(s,n):e)||this.editEventDefault(s,n)}}dispatchChangeEvent(e){var t=this.dom.getParentWithAttribute("ude_bind",e),s=this.dom.getSaveableParent(e);if(s){var n=this.dom.getParentAttribute("","ud_type",s),i={source:e,container:t,target:s,event:"change"};if(s&&n)switch(n){case"table":this.tableEd.inputEvent(i,e);break;case"list":var a=this.modules["div.list"].instance;a&&a.inputEvent(i,e);break;case"graphic":this.draw.inputEvent(i,e);break;case"linetext":case"server":case"css":case"js":case"apiCalls":case"json":this.textEd.inputEvent(i,t);break;case"html":case"chart":this.dispatchEvent({event:i,target:s},e);break;case"image":this.dispatchEvent(i,s)}}}insertTextAtCursor(e,t){var s=this.dom.cursor.textElement,n=this.dom.cursor.textOffset;let i=s.textContent;var a=this.dom.attr(s.parentNode,"ude_place"),o=this.dom.cursor;i==a?(s.textContent=e,this.dom.cursor.setAt(s,1e4)):(this.cursor.selectionInNode&&(i=i.substring(0,o.textOffset)+i.substring(o.focusOffset)),s.textContent=i.substring(0,n)+e+i.substring(n,i.length),this.dom.cursor.setAt(this.dom.cursor.HTMLelement,n+e.length)),"off"==this.dom.getParentAttribute("","ude_autosave",this.dom.cursor.HTMLelement)?debug({level:3},"Auto update disabled in insertTextAtCursor on "+this.dom.cursor.HTMLelement.id):this.setChanged(this.dom.cursor.HTMLelement)}replaceTextAtCursor(e,t){var s=this.dom.cursor.HTMLelement;this.dom.cursor.textElement.textContent=e,"off"==this.dom.getParentAttribute("","ude_autosave",s)?debug({level:3},"Auto update disabled in insertTextAtCursor on "+s.id):this.setChanged(s)}insertHTMLatCursor(e,t){var s,n=this.dom.cursor.HTMLelement,i=this.dom.cursor.HTMLoffset,a=n.innerHTML;a==this.dom.attr(n,"ude_place")?(n.innerHTML=e,this.dom.cursor.setAt(n,9e3)):(s=n.innerHTML.length,n.innerHTML=a.substring(0,i)+e+a.substring(i,a.length),this.dom.cursor.setAt(n,i+n.innerHTML.length-s)),"off"==this.dom.getParentAttribute("","ude_autosave",n)?debug({level:3},"Auto update disabled in insertTextAtCursor on "+this.dom.cursor.HTMLelement.id):this.setChanged(n)}requires2stageEditing(s){if(this.editingElement&&this.editingElement!=s&&this.leave2stageEditing(!0),this.editingElement&&(this.editingElement==s||this.editingElement==s.parentNode))return!0;var t=s.childNodes;let n=!1;for(let e=0;e<t.length;e++)if(3==t[e].nodeType){n=!0;break}var i=this.forceStagedEditing;if((i|=API.testEditorAttr(s,"ude_stage"))|""!=this.dom.attr(s,"ude_formula")|(""!=this.dom.attr(s,"_onclick")||""!=this.dom.attr(s,"ude_onclick"))&&this.dom.isEditable(s)){this.editingElement=s,this.editRestoreHTML=s.innerHTML,this.editRestoreAttr={ude_onclick:"",ude_formula:""};let e=this.dom.attr(s,"ud_type");var i=this.dom.attr(s,"ude_formula");this.dom.attr(s,"exTagType");if(e||i||(i=s.parentNode,"span"!=this.dom.attr(s,"exTagType")&&(this.dom.attr(i,"ud_type")||this.dom.attr(i,"ude_formula"))&&(s=i,e=this.dom.attr(s,"ud_type"),this.dom.attr(s,"ude_formula"),this.editingElement=s,this.editRestoreHTML=s.innerHTML,this.editRestoreAttr={})),s.classList.add("stageediting"),"button"==e){i="",i=(i+="DO|"+this.dom.attr(s,"_onclick")+"|"+s.innerHTML)+('|<a href="javascript:" onclick="'+this.dom.attr(s,"_onclick")+'">test</a>');s.innerHTML=i,this.editRestoreAttr={ude_onclick:this.dom.attr("_onclick"),ude_formula:this.dom.attr("ude_formula")}}else if("link"==e){i=this.dom.element("a",s);let e="",t=(i&&(e=this.dom.attr(i,"href")),this.dom.attr(s,"ude_formula"));t=t||"linkTag( '"+e+"','','"+s.textContent+"');",s.innerHTML="="+t,e&&(s.innerHTML+=' | <a href="javascript:" onclick="window.open(\''+e+"');\">test</a>")}else"field"==e&&"edit3"==!this.mode&&1==this.calc.countTermsInFormula(this.dom.attr(s,"ude_formula"))?n||"img"==s.childNodes[0].tagName.toLowerCase()&&(s.style.border="2px solid green",n=document.createTextNode("select in clipboard"),n=s.appendChild(n),this.dom.cursor.HTMLelement=s,this.dom.cursor.textElement=n,this.dom.cursor.textOffset=0,this.dom.cursor.set()):("field"==e&&"edit3"==this.mode||this.dom.attr(s,"ude_formula"))&&(n||(this.dom.emptyElement(s),n=document.createTextNode(""),n=s.appendChild(n)),s.textContent="="+this.dom.attr(s,"ude_formula"));return!0}return!1}is2stageEditing(e){return this.editingElement==e}leave2stageEditing(s=!0){if(!this.editingElement)return!1;var n=this.editingElement;this.editingElement=null,n.classList.remove("stageediting");let i=n.textContent;if(s=s&&(a=this.dom.attr(n,"ude_check"))&&!this.calc.checkValue(a,i)?!1:s){let t=!0;window.rollbacker&&window.rollbacker.inputEvent({event:"change",content:this.editRestoreHTML},n);var a=this.dom.attr(n,"ud_type"),s=this.dom.attr(n,"ude_formula");if("="==i.charAt(0))i=i.substr(1).split("|"),this.dom.attr(n,"ude_formula",i[0]),n.textContent=this.dummy,this.dom.attr(n,"_onclick","__CLEAR__"),this.calc.updateElement(n),this.dom.attr(n,"ud_follow",this.dom.children(n)?"off":"__CLEAR__");else if("field"==a&&1==this.calc.countTermsInFormula(s)){let e=s;e=(e=s.indexOf("(")?e.substring(e.indexOf("(")+1,e.length-1).trim():e).split(".");var a=this.dom.element(e[0]),s=(2==n.childNodes.length&&"img"==n.childNodes[0].tagName.toLowerCase()&&(i=this.dom.attr(n.childNodes[0],"src"),n.style.border="none"),{event:"setValue",key:[e[1],e[2]],value:i});this.dispatchEvent(s,a),this.calc.updateElement(n),"off"==this.dom.attr(n,"ude_menu")&&(t=!1)}else if("DO|"==i.substr(0,3)){let e=stripScriptsAndStyles((i=i.substr(3).split("|"))[0]);API.translateTerm(i[1],!1);"="==e.charAt(0)?(e=e.substring(1),this.dom.attr(n,"onclick_formula",e),n.setAttribute("_onclick",this.calc.exec(e,n))):n.setAttribute("_onclick",e),this.dom.attr(n,"ude_formula","__CLEAR__"),n.textContent=i[1],this.dom.clearAttr(n,"ude_formula"),this.calc.updateElement(n)}else{this.dom.attr(n,"ude_formula","__CLEAR__"),this.dom.attr(n,"ud_follow","__CLEAR__"),this.dom.attr(n,"_onclick","__CLEAR__");let e=this.dom.attr(n,"ude_validate");e&&(e=e.replace(/this/g,n.innerHTML),this.calc.eval(e,n)||(t=!1,n.innerHTML=this.editRestoreHTML))}let e=this.dom.attr(n,"ude_onvalid");t&&e&&(s=this.dom.getSaveableParent(n),doOnupdate(e=(e=n.id?e.replace(/{id}/g,n.id):e.replace(/{id}/g,s.id)).replace(/{name}/g,this.dom.attr(s,"name")))),!t||n.innerHTML==this.editRestoreHTML&&this.dom.attr(n,"_onclick")==this.editRestoreAttr.ude_onclick&&this.dom.attr(n,"ude_formula")==this.editRestoreAttr.ude_formula||this.setChanged(n)}else n.innerHTML=this.editRestoreHTML,this.floaterActionPending||("span.field"==this.dom.attr(n,"exTag")&&(n.style.border="none"),a=this.dom.getSaveableParent(n),this.clearClasses(a,"edcontainer"),this.clearClasses(n,"edinside"),this.dom.cursor.setAt(a),(s=this.dom.attr(n,"ude_oninvalid"))&&n.id&&doOnupdate(s.replace(/{id}/g,n.id)));return this.editingElement=null,this.editRestoreHTML="",this.editRestoreAttr={},(this.isMobile||this.forceStagedEditing)&&(document.activeElement.blur(),this.menuManager)&&this.menuManager.hide(),!0}formInputChange(e,t=null){var s=e.parentNode;if(t&&t.keyCode<20)if("Enter"==t.code)s.submit();else if("Backspace"!=t.code&&"Delete"!=t.code)return;debug({level:1},"formInputChange used",e),50<this.ticks&&e.classList.contains("initialField")?(e.value="",e.classList.remove("initialField"),e.classList.add("editField")):""==e.value&&(e.classList.remove("editField"),e.classList.add("initialField"))}inlineCommandManager(e){return this.commandMode?"Escape"==e||"Enter"==e?(this.commandMode=!1,!(this.command="")):(this.command+=e,!0):this.lastChar==this.enterCommand.charAt(0)&&e==this.enterCommand.charAt(1)?(console.log("Command mode"),this.commandMode=!0,!(this.command="")):(e==this.enterCommand.charAt(0)&&(this.lastChar=e),!1)}followScroll(e){if(e){e=this.dom.element(e);if(e){this.emulateMobile=!0,this.elementToScroll=e;let t=this;this.dom.topElement.addEventListener("mousemove",function(e){t.pointEvent(e)}),this.dom.cursor.HTMLelement=e.childNodes[0]}}else{this.emulateMobile=!1,this.elementToScroll=null,this.lastClickPosition={x:-1,y:-1};let t=this;this.dom.topElement.removeEventListener("mousemove",function(e){t.pointEvent(e)})}}arrowNavigate(e){switch(e){case 2:this.dom.moveCursor(1,null,"line");break;case 3:this.dom.moveCursor(-1);break;case 4:this.dom.moveCursor(1)}}click(e){}getEditType(e){e=this.dom.getEditableParent(e);let t=this.dom.attr(e,"ud_type").toLowerCase(),s=(-1<["editzone","viewzone"].indexOf(t)&&(t=this.dom.attr(e,"ud_subtype")),"html");return s=-1<["text","linetext","css","js","json","htmltext","html","chart"].indexOf(t)?"text":s}clearPlaceholder(e){var e=API.dom.element(e),t=API.getEditorAttr(e,"ude_place");(t||"..."!=e.textContent)&&e.textContent!=t||(e.textContent=""),e.classList.remove("placeHolding")}setPlaceholder(e){var e=API.dom.element(e),t=API.getEditorAttr(e,"ude_place");t&&""==e.textContent&&(e.textContent=t),e.classList.add("placeHolding")}hasDefaultContent(e){var e=this.dom.element(e),t=this.dom.getSaveableParent(e);let s=this.dom.udjson.value(UD_defaultContentByExTag,this.dom.attr(e,"exTag"));return s=s||"...",t.classList.contains("initialcontent")||API.getEditorAttr(e,"ude_place")==e.innerHTML||s&&e.innerHTML==s}}if("object"==typeof process){testThis=!1;const udecalc=require("./udecalc.js"),UDEcalc=udecalc.UDEcalc;if(window.UDEcalc=udecalc.UDEcalc,module.exports={UDE:UDE,CALC:window.UDEcalc},window.UDE=UDE,void 0===global.JSDOM&&"undefined"==typeof window){var envMod=require("../tests/testenv.js");envMod.load();const udedraw=require("../modules/editors/udedraw.js"),UDEdraw=udedraw.UDEdraw;window.UDEdraw=udedraw.UDEdraw,console.log("Syntax OK"),console.log("Start of UDE test program"),debug({level:2},"abd"),console.log("Creating ude");var myude=new UDE(document.getElementById("document"),null,0);console.log("Test completed")}}function doOnload(onload){if(onload&&"string"==typeof onload){let r="";try{r=eval(onload)}catch(error){console.error(error,onload)}return r}}function doOnupdate(onupdate){if(onupdate&&"string"==typeof onupdate)return eval(onupdate)}function doOnsave(onsave){if(onsave&&"string"==typeof onsave)return eval(onsave)}function convertToObject(attrFriendlyStr){return attrFriendlyStr?eval("("+attrFriendlyStr+")"):{dummy:"dummy"}}function doControl(test,args){if(test&&"string"==typeof test)return eval(test)}function Confirm(e){confirm(e)}function APIreturnType(fctName){if(fctName&&"string"==typeof fctName)return typeof eval("API."+fctName+"();")}function stripScripts(e,t=null){let s=0,n=5,i=!1;for(;-1<(s=e.indexOf("<script",s))&&n--;){var a=e.indexOf("<\/script>");e=a?e.substr(0,s)+e.substr(a+9):e.substr(0,s),i=!0}return n?(i&&t&&(t.innerHTML=e),e):(alert("<script> sequenciencies not allowed here. Please remove for element to be saved."),!1)}function stripStyles(e,t=null){let s=0,n=5,i=!1;for(;-1<(s=e.indexOf("<style",s))&&n--;){var a=e.indexOf("</style>");e=a?e.substr(0,s)+e.substr(a+9):e.substr(0,s),i=!0}return n?(i&&t&&(t.innerHTML=e),e):(alert("<style> sequenciencies not allowed here. Please remove for element to be saved."),!1)}function stripScriptsAndStyles(e,t=null){return stripStyles(stripScripts(e,t),t)}function htmlEntities(e,t=!1){return t?String(e).replace(/&quote/g,'"').replace(/&gt;/g,">;").replace(/&lt;/g,"<").replace(/&amp;/g,"&"):String(e).replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;")}function htmlEntities2(e,t=null){var s=String(e).replace(/<script/g,"&lt;script").replace(/<style/g,"&lt;style");return s!=String(e)&&t&&(t.innerHTML=s),s}function L_new(e,t){var s=arguments;return s.shift(),s.shift(),new("object"==typeof process?window[e]:e)(s)}function dumpElement(e,t=""){if(e)if("undefined"==typeof process)console.log(e);else{console.log(t,e,e.id,e.getAttribute("name"),e.className,e.getAttribute("ud_type"));var s=e.childNodes;for(let e=0;e<s.length;e++){var n=s[e];1==n.nodeType?dumpElement(n,t+"   "):3==n.nodeType&&console.log(t+"    Text node: "+n.textContent)}}else console.log("null")}function testResult(e,t,s=""){ok=t?"OK":"KO "+s,console.log("Test "+e+" : "+ok)}function stringifyHelper(e,t){return"object"==typeof t&&window.DEBUG_stringifyCount--<=0?"object":"array"==typeof t?"array":t}function debug(){var i=arguments[0];if(!("object"==typeof i&&"level"in i))return 5<=DEBUG_level?"__CHECKSUM__"==i?DEBUG_checksum:"__COVERAGE__"==i?COVERAGE:"Level, arg "+window.DEBUG_level+i:void 0;if(i.level>window.DEBUG_level)return"return"in i?arguments[0].return:"returnValue"in i?i.returnValue:void 0;if(0 in i,1<arguments.length){var a=[];-1==window.DEBUG_time&&(window.DEBUG_time=Date.now()%1e7);for(let e=1;e<arguments.length;e++)a.push(arguments[e]);let t="";var e=Error();if(void 0!==e.stack){e=e.stack.split("\n");-1==e[0].indexOf(":")&&e.shift(),-1==e[0].indexOf(":")&&e.shift(),-1<e[0].indexOf("debug.js")&&e.shift();let s=e[1];var e=s.indexOf("("),o=s.indexOf(")");if((s=(s=0<e&&0<o?s.substring(e+1,o):s).split(":")).length<2)return;let n=s[1];e=s[2],o=(n=-1<n.indexOf("_")?n.substr(n.indexOf("_")+1):n).split("\\");if(n=o[o.length-1],"coverage"in i){void 0===COVERAGE[n]&&(COVERAGE[n]={});let e=i.coverage,t=0;"coverageDetail"in i?e+="/"+i.coverageDetail:(e+="/global",t=3),void 0===COVERAGE[n][e]?COVERAGE[n][e]=parseInt(s[2]):"number"==typeof COVERAGE[n][e]&&(COVERAGE[n][e]=""+(parseInt(s[2])-COVERAGE[n][e]+t))}if(1<arguments.length){if(TEST_ENVIRONMENT)t=n+" line "+e;else{o="0000000"+(Date.now()%1e7-window.DEBUG_time);let e="0000000";void 0!==window.performance.memory&&(e="0000000"+window.performance.memory.totalJSHeapSize),t=o.substring(o.length-7)+" "+e.substring(e.length-7)+" "+n+" line "+s[2]}for(var l=0;l<a.length;l++)window.DEBUG_stringifyCount=2,t+=" "+JSON.stringify(a[l],stringifyHelper);i.error?TEST_ENVIRONMENT?console.log("ALERT "+i.error,t,a):console.error(t,i.error,a):TEST_ENVIRONMENT&&!TEST_verbose||console.log(t,a),DEBUG_checksum+=crc32_compute_string(DEBUG_poly,t)}}else console.log(a)}return"return"in i?i.return:"returnValue"in i?i.returnValue:void 0}function debug_callerFct(){var t=Error();let s="Error stack unavailable";if(void 0!==t.stack){t=t.stack.split("\n");-1==t[0].indexOf(":")&&t.shift(),-1==t[0].indexOf(":")&&t.shift();let e=t[2];var n=e.indexOf("("),i=e.indexOf(")");if((e=(e=0<n&&0<i?e.substring(n+1,i):e).split(":")).length<2)return;n=(s=-1<(s=e[1]).indexOf("_")?s.substr(s.indexOf("_")+1):s).split("/");s=n[n.length-1],s=(s+=" line"+e[2])+(" "+t[3])}return s}function crc32_generate(e){for(var t,s,n=new Array,i=0;i<256;i++){for(s=i,t=8;0<t;t--)1==(1&s)?s=s>>>1^e:s>>>=1;n[i]=s}return n}function crc32_initial(){return 4294967295}function crc32_add_byte(e,t,s){return t=t>>>8^e[s^255&t]}function crc32_final(e){return e=(e=~e)<0?4294967295+e+1:e}function crc32_compute_string(e,t){var s=crc32_generate(e),n=0,n=crc32_initial();for(let e=0;e<t.length;e++)n=crc32_add_byte(s,n,t.charCodeAt(e));return n=crc32_final(n)}function crc32_compute_buffer(e,t){var s=new DataView(t),n=crc32_generate(e),i=0,i=crc32_initial();for(let e=0;e<s.byteLength;e++)i=crc32_add_byte(n,i,s.getUint8(e));return i=crc32_final(i)}function crc32_reverse(t){var s=0;for(let e=0;e<32;e++)s=(s<<=1)|t>>>e&1;return s}DEBUG_alwaysNull={level:2,returnValue:null},DEBUG_alwaysFalse={level:2,returnValue:!1},void 0===DEBUG_level&&(DEBUG_level=5),DEBUG_time=-1,DEBUG_stringifyCount=1,DEBUG_checksum=0,DEBUG_poly=202020192018,TEST_ENVIRONMENT=!1,TEST_verbose=!1,COVERAGE={},"object"==typeof process&&(TEST_ENVIRONMENT=!0),"object"==typeof process&&(displaylib=require("../debug/display_lib.js"),module.exports={debug:debug,L_new:L_new,dumpElement:dumpElement,testResult:testResult,debug_callerFct:debug_callerFct,DEBUG_checksum:DEBUG_checksum,RegisterBlock:displaylib.RegisterBlock,ShowBlock:displaylib.ShowBlock,Zone:displaylib.Zone,doOnload:doOnload,doOnupdate:doOnupdate,doOnsave:doOnsave,doControl:doControl,APIreturnType:APIreturnType,convertToObject:convertToObject,htmlEntities:htmlEntities,htmlEntities2:htmlEntities2,stripScripts:stripScripts,stripStyles:stripStyles,stripScriptsAndStyles:stripScriptsAndStyles},void 0===global.JSDOM)&&"undefined"==typeof window&&"undefined"==typeof ModuleUnderTest&&(ModuleUnderTest="debug.js",console.log("Syntax : OK"),console.log("Start of debug.js test program"),console.log("Setting up browser (client) test environment"),envMod=require("../tests/testenv.js"),envMod.load(),TEST_verbose=!0,debug({level:2,error:"DEPRECATED"},"Value1","Value2"),console.log("Test completed: OK"));var DOM_lastAccessedValues=[];function JSONvalue(e,t){return window.udjson.value(e,t)}function JSONparse(e){return window.udjson.parse(e)}class DOM{maxElementDepth=30;DOM_properties={};parent=null;cursor;udjson=null;domvalue=null;topElement=null;lastAccessedElement=null;autoHome=null;autoIndex1=-1;autoIndex2=-1;headerRowCache={};transformScale=1;classMap={};editClasses=["editing","edcontainer","edinside","menu-on","hidden"];dummyText="...";nodejs=!1;constructor(e,t){this.topElement=e,this.parent=t,this.cursor=new DOM_cursor(this.topElement,this),this.udjson=new UDJSON(this),window.udjson=this.udjson,this.domvalue=new DOMvalue(this),"object"==typeof process&&(this.nodejs=!0)}JSONget(e){return this.udjson.getElement(e)}JSONput(e,t="",s="",n=""){return this.udjson.putElement(e,t,s,n)}value(e,t=null,s=null){return this.domvalue.value(e,t,s)}appAttribute(e,t,s=null){this.attr(e,t,s)}setAttr(e,t,s,n=!0){n?this.attr(t,s)&&(e[s]=this.attr(t,s)):void 0!==e[s]&&this.attr(t,s,e[s])}attr(t,e,n=null){debug({level:5,coverage:"attr"});t=this.element(t);if(!t||void 0===t.getAttribute)return"";if(null!=n)-1<UD_appAttributes.indexOf(e)?((s=0==e.indexOf("data-")?e:"data-"+e.replace(/_/g,"-"))!=e&&void 0!==t.getAttribute(e)&&t.removeAttribute(e),"__CLEAR__"==n?void 0!==t.getAttribute(s)&&t.removeAttribute(s):t.setAttribute(s,n)):(-1==UD_domAttributes.indexOf(e)&&(s=debug_callerFct(),console.error("Writing unknown attribute:"+e,s)),"boolean"==typeof n&&n?t.setAttribute(e,""):"class"==e?t.className=n:"__CLEAR__"==n?t.removeAttribute(e):t.setAttribute(e,n));else{if(-1<UD_styleAttributes.indexOf(e)||0==e.indexOf(UD_useComputedPrefix)){e=e.replace(UD_useComputedPrefix,"");var s=t.currentStyle||window.getComputedStyle(t);(n=void 0!==s[e]?s[e]:n)&&-1<n.indexOf("px")&&(n=parseFloat(n.replace("px","")))}else if("textContent of siblings"==e){var i=t.parentNode.childNodes,a=(n="",API.getParameter("dummyText"));for(let e=0;e<i.length;e++){var o=i[e],l=o.textContent;1!=o.nodeType||o.classList.contains("rowNo")||"false"==o.getAttribute("contenteditable")||l==a||l==this.attr(o,"ude_place")||(n+=l)}}else if("editable"==e){n=!0,"div.page"==this.attr(t,"exTag")&&(n=!1);let s=t,e=10;for(;n&&s&&"document"!=s.id&&--e;){if("true"==this.attr(s,"contenteditable"))return n;let e=this.attr(s,"ude_edit").toLowerCase(),t=(e||(e=this.attr(s,"ude_mode").toLowerCase(),e=!(e="none"==this.attr(s,"ude_input")?"display":e)||-1<e.indexOf("edit")?"on":"off"),this.element("UD_mode"));if(t=t&&t.textContent,-1==["div.page"].indexOf(this.attr(s,"exTag"))&&("false"==this.attr(s,"contenteditable")||this.attr(s,"ude_noedit")||s.classList.contains("noedit")||"INPUT"==s.tagName||"edit3"!=t&&e&&0==e.indexOf("off")||!e&&t&&"model"==t)){n=!1;break}s=s.parentNode}"document"!=t.id&&"div.page"!=this.attr(t,"exTag")||(n=!1)}else"exTag"==e||"exTagType"==e?"div"==(n=t.tagName.toLowerCase())||"span"==n?((s=this.attr(t,"ud_type"))&&(n+="."+s),s=this.attr(t,"ud_subtype"),"exTagType"==e&&s&&(n+="."+s)):"p"==n&&t.classList.contains("undefined")&&(n="p.undefined"):-1<UD_domAttributes.indexOf(e)?n=(n=t.getAttribute(e))||"":(s=0==e.indexOf("data-")?e:"data-"+e.replace(/_/g,"-"),(n=(n=(n=(n=t.getAttribute(s))||t.getAttribute(e))||void 0===t[e]?n:t[e])&&void 0!==n?n:"")&&-1<UD_lowerCaseAttr.indexOf(e)&&(n=n.toLowerCase()),-1==UD_appAttributes.indexOf(e)&&-1==UD_domAttributes.indexOf(e)&&(s=debug_callerFct(),console.error("Reading unknown attribute:"+e,s)));debug({level:5,coverage:"attr"})}return n}isEditable(e,t=!1){var s=this.attr(e,"exTag"),n=$$$.testEditorAttr(e,"ude_edit"),i=!e;return!(i|"div.page"==s|!(n|$$$.testEditorAttr(e,"ude_stage")|"input"==s)|(t&&"link"!=this.attr(e.parentNode,"ud_type")))}clearAttr(e,t){this.attr(e,t,"__CLEAR__")}extraAttr(e,t){let s="";var e=this.parentAttr(e,"ud_extra"),n=this.element("UD_mode").textContent;return s=e&&"edit2"==n&&(e=this.udjson.parse(e))&&e[t]?e[t]:s}parentAttr(e,t){let s=10,n="",i=this.element(e),a="";for(;i&&!(n=this.attr(i,t))&&!(a=this.attr(i,"ude_bind"))&&--s&&i!=this.topElement;)i=i.parentNode;return a?this.parentAttr(this.element(a),t):n}textContent(t){let s="";if(t){("string"==typeof t||"object"==typeof t&&void 0!==t.tagName)&&(t=[t]);for(let e=0;e<t.length;e++){var n,i,a=this.element(t[e]);a&&a.nodeType==Node.ELEMENT_NODE&&(n=this.attr(a,"exTag"),-1<["div.linetext","div.server","div.css","div.js","div.json","div.html"].indexOf(n)?"text/json"===this.attr(a,"ud_mime")?(n=JSONparse(a.textContent))&&(s+=this.udjson.text(n,"data/value")):(n=this.element("div.textObject",a))&&(i=(n=n.textContent.split("\n")).shift(),-1==["linetext","css","js","json","html"].indexOf(i.toLowerCase())&&(s+=firstline+"\n"),s+=n.join("\n")):s+=a.textContent)}}return s}isDOM(e){return e&&void 0!==e.tagName}element(t,e=null){if(!t)return null;let s=null,n=null;if("object"==typeof t){if(void 0!==t.tagName)return t;var i=t;e="string"==typeof i.parent?i.parent:this.element(JSON.stringify(i.parent)),t="tbody"==i.tag||"thead"==i.tag?i.tag:i.tag+":nth-child("+i.child+")"}if("{"==t[0]){i=this.udjson.parse(t);if(!i)return null;e="string"==typeof i.parent?i.parent:this.element(JSON.stringify(i.parent)),t="tbody"==i.tag||"thead"==i.tag?i.tag:i.tag+":nth-child("+i.child+")"}if(e&&((n=this.element(e))||(i=document.getElementsByName(e)).length&&(n=i[0]),n=n||this.element("document")),n)if(this.nodejs){if(n.id&&!(s=document.querySelector("#"+n.id+" "+t))&&-1<" table ul ".indexOf(t)){console.log("parse children for query");var a=n.childNodes;for(let e=0;e<a.length;e++){var o=a[e];if(o.nodeType==Node.ELEMENT_NODE&&o.tagName.toLowerCase()==t){s=o;break}}}}else s=n.querySelector(t);else{e=t.replace(/ /g,"_");s=document.getElementById(e)}return s}elements(e,t,s="",n=""){t=this.element(t);if(!t)return[];let i=null;i=this.nodejs?t.id?document.querySelectorAll("#"+t.id+" "+e):[]:t.querySelectorAll(e);var a=[];for(let e=0;e<i.length;e++){var o,l=i[e];l.nodeType==Node.ELEMENT_NODE&&(!s&&!n||(o=this.getSaveableParent(l))&&(o=o.id,!s||s<o)&&(!n||o<n))&&a.push(l)}return a}elementByName(e,t=""){var s=this.element("document");return s?(t=this.elements(t+"[name='"+e+"']",s))&&0!=t.length?1<t.length?debug({level:3,return:null},"DOM.elementByName name not unique",e):t[0]:debug({level:3,return:null},"DOM.elementByName name not found",e):(console.log("FATAL ERROR No document element",document.body.innerHTML),null)}unpagedChildElements(e){e=this.element(e);if(!e)return[];let t=[];var s=e.childNodes;if(s)for(var n=0;n<s.length;n++){var i=s[n];1==i.nodeType&&(void 0!==i.classList&&i.classList.contains("page")?t=t.concat(this.children(i)):t.push(i))}return t}children(e){return this.unpagedChildElements(e)}childElements(e){e=this.element(e);if(!e)return null;var t=[],s=e.childNodes;if(s)for(var n=0;n<s.length;n++){var i=s[n];1==i.nodeType&&t.push(i)}return t}childNodes(e){e=this.element(e);if(!e)return null;var t=[],s=e.childNodes;if(s)for(var n=0;n<s.length;n++){var i=s[n];t.push(i)}return t}pages(e="document"){let t=this.element(e);if(!(t=t||this.element('[name="'+e+'"]',this.element("document"))))return null;var s=[],n=t.childNodes;if(n)for(var i=0;i<n.length;i++){var a=n[i];1==a.nodeType&&void 0!==a.classList&&a.classList.contains("page")&&s.push(a)}return s}views(){return this.childElements("document")}siblings(e){e=this.element(e).parentNode;return e.classList.contains("page")?this.children(e.parentNode):this.children(e)}emptyElement(e){e=this.element(e);return e?(e.innerHTML="",e):null}childrenAsJSON(e,t=0){debug({level:2},"childrenAsJSON OLD called");var s=e.childNodes,n=[];for(let e=0;e<s.length;e++){var i,a=s[e];a.nodeType==Node.TEXT_NODE?n.push({value:a.textContent}):a.nodeType==Node.ELEMENT_NODE&&("br"==a.tagName.toLowerCase()?n.push({value:""}):(i={value:a.textContent,tag:a.tagName.toLowerCase()},a.className&&(i.class=a.className),(a=this.attr(a,"ude_formula"))&&(i.formula=a),n.push(i)))}return n}childrenOfClass(e,t){e=this.element(e);if(!this.nodejs)return this.elements("."+t,e);var s=this.childElements(e),n=[];for(let e=0;e<s.length;e++){var i=s[e];1==i.nodeType&&i.classList.contains(t)&&n.push(i)}return n}hasClass(e,t){return this.dom.element(e).classList.contains(t)}getSaveableParent(e,t=!0){var s=this.element(e);let n=this.maxElementDepth,i=s;for(;i&&void 0!==i.tagName&&!this.attr(i,"ud_oid")&&(!i.id||0!=i.id.indexOf("__TMP"))&&n--&&(!t||!this.attr(i,"ude_bind"));)i=i.parentNode;return i?t&&this.attr(i,"ude_bind")?this.getSaveableParent(this.attr(i,"ude_bind"),!1):this.attr(i,"ud_oid")||i.id&&0==i.id.indexOf("__TMP")?i:"page"==this.attr(i,"ud_type")?debug({level:8,return:null},"getSaveable() found page before saveable",e):debug({level:8,return:null},"can't find saveable",e):debug({level:8,return:null},"can't find saveable",e)}getEditableParent(e,t=0){e=this.element(e);if(!e)return null;var s=this.getSaveableParent(e),n=this.attr(s,"exTag");if(!this.udjson.valueByPath(UD_exTagAndClassInfo,n+"/editableInside"))return s;let i=e;var a=this.attr(i,"exTag");let o=this.udjson.valueByPath(UD_exTagAndClassInfo,a+"/editable"),l=this.maxElementDepth;for(;!o&&i!=s&&l--;)i=i.parentNode,a=this.attr(i,"exTag"),o=this.udjson.valueByPath(UD_exTagAndClassInfo,a+"/editable"),i.classList.contains("editzone")&&(o=!1);return i}getDisplayableParent(e){e=this.element(e);let t=5,s=e,n=!0;for(;s&&void 0!==s.tagName&&void 0!==UD_exTagAndClassInfo[this.attr(s,"exTag")]&&!(n=UD_exTagAndClassInfo[this.attr(s,"exTag")].displayable)&&t--;)s=s.parentNode;return s&&void 0===UD_exTagAndClassInfo[this.attr(s,"exTag")]&&console.log("BUG udconstants.js",s,this.attr(s,"exTag")),s&&void 0!==s&&void 0!==s.tagName&&void 0!==UD_exTagAndClassInfo[this.attr(s,"exTag")]&&n?s:(console.log("can't find displayable",e),null)}getTypedDivParent(e){return this.getDisplayableParent(e)}getBindedParent(e){e=this.element(e);let t=10,s=e;for(;s&&void 0!==s&&!this.attr(s,"ud_oid")&&!this.attr(s,"ude_bind")&&t--;)s=s.parentNode;if(!s||!this.attr(s,"ud_oid")&&!this.attr(s,"ude_bind"))return debug({level:8,return:null},"can't find saveable",e);if(this.attr(s,"ude_bind")){var n=this.attr(s,"ude_bind"),n="previous"==n?s.previousSibling:"next"==n?s.nextSibling:this.element(n);if(n)return n}return debug({level:5},"No binded parent",e),null}getParentAttribute(e,t,s){if(!e&&s)return this.parentAttr(s,t);e=e.toUpperCase();let n=s,i=this.maxElementDepth;for(;n!=document&&n.tagName!=e&&i--;)n=n.parentNode;return n==document||n.tagName!=e?debug({level:2,return:null},"No parent with tag",e,s):"_element"==t?n:this.parentAttr(n,t)}getParentWithTag(e,t){let s=this.element(e);for(var n=this.maxElementDepth;s&&s!=document&&this.attr(s,"exTag")!=t&&n--;)s=s.parentNode;return s&&s!=document&&this.attr(s,"exTag")==t?s:null}getParentWithAttribute(e,t){for(var s=t,n=this.maxElementDepth;s&&s!=document&&!this.attr(s,e)&&n--;)s=s.parentNode;return s&&s!=document&&this.attr(s,e)?s:null}getView(e){let t=10;let s=this.element(e);for(;s&&"document"!=s.id&&!s.classList.contains("part")&&--t;)s=s.parentNode;return s&&s.classList.contains("part")?s:null}getViewType(e){e=this.getView(e);return e?this.attr(e,"ud_subtype"):""}getViewClass(e){e=this.getView(e);if(e){var t=this.attr(e,"ud_subtype");if(""!=e.classname){var s=e.className.split(" ");for(let e=0;e<s.length;e++){var n=s[e];if("part"!=n&&"view"!=n&&n!=t&&0!=n.indexOf(UD_layoutPrefix)&&-1==this.editClasses.indexOf(n))return n}}}return""}hasDefaultContent(e){e=this.element(e);if(!e)return!1;var t=this.attr(e,"exTag");let s=$$$.getTagOrStyleInfo(t,"defaultContent");return s=s||this.udjson.value(UD_defaultContentByExTag,this.attr(e,"exTag")),e.classList.contains("initialcontent")||this.attr(e,"ude_place")==e.innerHTML||s&&e.innerHTML==s||!e.innerHTML}createLookupFromTable(e,t,s){var n={},i=document.getElementById(e);if(!i)return null;var a=[];for(let e=0;e<i.rows[0].cells.length;e++)a.push(i.rows[0].cells[e].textContent);var o=a.indexOf(t),l=a.indexOf(s),r=i.rows.length;for(let e=1;e<r;e++)"h"==s.substr(0,1)?n[i.rows[e].cells[o].textContent]=i.rows[e].cells[l].innerHTML:n[i.rows[e].cells[o].textContent]=i.rows[e].cells[l].textContent;return n}removeStylesFromHTML(t,e=0){var s=["<body>","</body>","<html>","</html>"],n=["meta","b","body","html","br"];let i="",a=null;if("string"==typeof t){for(let e=0;e<s.length;e++)t=t.replace(s[e],"");t=t.replace(/\n/g,""),(a=document.createElement("div")).innerHTML=t}else a=t;var o=a.childNodes;for(let e=0;e<o.length;e++){var l,r=o[e];r.nodeType==Node.TEXT_NODE?(l=r.textContent.trim(),i+=l):r.nodeType==Node.ELEMENT_NODE&&("span"==(l=r.tagName.toLowerCase())&&this.attr(r,"style")||-1<n.indexOf(l)?i+=this.removeStylesFromHTML(r):(r.className="",this.attr(r,"style")&&this.attr(r,"style",""),i+=r.outerHTML))}return i}splitTextElement(e,t){return e.splitText(t)}getTextElementAtCursor(){let e=this.cursor.textElement;var t;return e||(t=this.cursor.HTMLelement,e=document.createTextNode(""),t.appendChild(e),this.cursor.textElement=e,this.cursor.textOffset=0),e}insertPreparedElement(e,t=this.cursor.HTMLelement,s=null){if(!t&&!s)return debug({level:2,return:null},"No where to insertElement");s=s||t.parentNode,debug({level:6},"Inserting in DOM",e,t=t&&t.id&&(-1<t.id.indexOf("editZone")||-1<t.id.indexOf("viewZone"))?t.nextSibling:t);var n=null,n=t?s.insertBefore(e,t):s.appendChild(e);return t==this.cursor.HTMLelement&&(this.cursor.HTMLelement=n,this.cursor.HTMLoffset=0,this.cursor.textElement=this.cursor.HTMLelement.childNodes[0],this.cursor.textOffset=0,this.cursor.set()),n}prepareToInsert(t,s,e={}){let n=null;if("object"==typeof s)void 0!==s.parentNode?((n=s.cloneNode(!0)).classList.remove("rowModel"),n.classList.remove("model")):(n=document.createElement(t),"img"==t&&(n.setAttribute("src",s.src),s.class)&&n.setAttribute("className",s.src));else{if(!(n=document.createElement(t)))return debug({level:2,return:null},"Can't create",t);if(s)n.innerHTML=s;else{let e=this.dummyText;"string"==typeof s&&""!=s&&(e=s),(-1<["p","span","td","li"].indexOf(t)||e!=this.dummyText)&&(s=document.createTextNode(e),n.appendChild(s))}}for(var i in e)"class"==i?n.className=e[i]:this.attr(n,i,e[i]);return n}insertElementAtCursor(e,t,s={},n=!0){var i;return this.cursor.HTMLelement?(i=this.cursor.HTMLelement,(t=this.insertElement(e,t,s,i,n))&&("br"==e&&Array.from(i.childNodes).indexOf(t)?(s=document.createTextNode(""),t.nextSibling?i.insertBefore(s,t.nextSibling):i.appendChild(s),this.cursor.textElement=s,this.cursor.textOffset=0):(this.cursor.HTMLelement=t,this.cursor.HTMLoffset=0,this.cursor.textElement=null),this.cursor.set()),t):debug({level:2,return:null},"No cursor to insert at",this.cursor)}insertElement(e,t,s={},n=null,i=!1,a=0){debug({level:5,coverage:"insertElement"});e=this.prepareToInsert(e,t,s);if(!e)return debug({level:2,return:null},"Can't insert",elementType,t,s);let o=null,l=null;if(!(n=n||this.cursor.HTMLelement))return debug({level:1,return:null},"Don't know where to insert",elementType,t,s);l=n.parentNode,o=n;t=this.attr(e,"exTag");if(i){let e=n.nextSibling;e&&e.nodeType!=Node.ELEMENT_NODE&&(e=null),o=e}s=this.udjson.value(UD_exTagAndClassInfo[t],"insertable");if(("inside"==s&&-1<a||0<a)&&(o=n==this.cursor.HTMLelement?(l=n,this.cursor.textElement&&0<this.cursor.textOffset?this.splitTextElement(this.cursor.textElement,this.cursor.textOffset):this.cursor.textElement&&0==this.cursor.textOfffset?this.cursor.textElement:null):(l=n,null)),!a&&"above"==s){i=n.parentNode;if(!i||i==this.topElement)return debug({level:2,return:null},"Can't find parent",n);o=i.nextSibling,l=i.parentNode}t=this.insertPreparedElement(e,o,l);return debug({level:5,coverage:"insertElement"}),t}remove(e){e=this.element(e);e&&e.remove()}fillElement(e,t){var s=this.element(e);return s?(s.innerHTML=t,s):debug({level:5,return:null},"fillElement can't find",e)}setStyle(e,t){return debug({level:2},"setStyle OLD called"),value("class",e,this.topElement)}setStyleAttr(e,t,s){var n=document.querySelectorAll("[name='"+e+"']");let i=null;if(1==n.length)i=n[0];else{if(!(i=document.getElementById(e)))return null;i=this.getSaveableParent(i)}return i.style[t]=s,i}styleSelection(e,t,s=""){var n=(e=e||this.cursor.fetch()).textElement,i=e.focusElement;if(!n||!i||n.nodeType!=Node.TEXT_NODE||i.nodeType!=Node.TEXT_NODE)return!1;var a=n.parentNode,o=i.parentNode;if(a.parentNode!=o.parentNode)return!1;let l="";if(n==i){l=n.textContent.substring(e.textOffset,e.focusOffset);i.nextSibling;n.textContent=n.textContent.substring(0,e.textOffset)+i.textContent.substring(e.focusOffset);i=e.textOffset?this.splitTextElement(n,e.textOffset):n,e=this.insertElement("span",l,{class:t,ud_type:t,ude_stage:"on"},i,!1,-1);this.cursor.setAt(e)}else{if(a==o)return!1;{let e=a,t=10;for(;e!=o&&--t;)-1<["span.field","span.input"].indexOf(this.attr(e,"exTag"))?l+=e.outerHTML:l+=e.textContent,e=e.nextSibling();-1<["span.field","span.input"].indexOf(this.attr(e,"exTag"))?l+=e.outerHTML:l+=o.textContent}}API.setChanged(this.cursor.HTMLelement)}changeTag(e,t,s=null){e=this.element(e);if(!e||!e.parentNode)return!1;var n=e.getAttribute("id");let i=t.split(".");t.indexOf(".")&&1==i.length&&(i=t.split(".")),s&&1==i.length&&i.push(s);s=(s=(s=(s=(s=(s=(s="")+"<"+t+' id="'+n+'"')+' ud_oid="'+this.attr(e,"ud_oid")+'"')+' ud_dupdated="'+this.attr(e,"ud_dupdated")+'"')+' ud_dchanged="'+this.attr(e,"ud_dchanged")+'"')+' ud_iheight="'+this.attr(e,"ud_iheight")+'"')+' ud_mode="'+this.attr(e,"ud_mode")+'"';return 1<i.length&&(s=(s+=' ud_type="'+i[1]+'"')+' class="'+i[1]+'"',2<i.length)&&(s+=' ud_subtype="'+i[2]+'"'),e.outerHTML=(s+=">")+e.innerHTML+"</"+t+">",this.element(n)}removeClassFromChildren(e,t){e=this.element(e);if(!e)return null;var s=e.childNodes;for(let e=0;e<s.length;e++)3!=s[e].nodeType&&(s[e].classList.remove(t),this.removeCSSfromAll(s[e],t));return e}removeCSSfromAll(e,t){debug({level:2},"rmoveCSSfromAll OLD called");for(var s=t.childNodes,n=0;n<s.length;n++)3!=s[n].nodeType&&(s[n].classList.remove(e),this.removeCSSfromAll(e,s[n]))}keepPermanentClasses(e,t=!1){let s=UD_register.UD_wellKnown.UD_editorTemporaryClasses,n=(t&&(s=void 0===API.listTypeAndSubTypeClasses?s.concat(["part","subpart","zone","table","list","graphic","text","zoneToFill","filledZone","page"]):s.concat(API.listTypeAndSubTypeClasses()))," ");-1<e.indexOf(",")&&(n=",");var i=e.split(n),a=[];for(let t=0;t<i.length;t++){let e=i[t];"_"!=e.charAt(0)&&-1==s.indexOf(e)&&("*"==e.charAt(0)&&(e=e.substr(1)),a.push(e))}return a.length?a.join(n):""}keepPermanentClass(e){let t=UD_register.UD_wellKnown.UD_editorTemporaryClasses,s=(t=t.concat(API.listTypeAndSubTypeClasses())," ");-1<e.indexOf(",")&&(s=",");var n=e.split(s),i=[];for(let e=0;e<n.length;e++){var a=n[e];"_"!=a.charAt(0)&&-1==t.indexOf(a)&&i.push(a)}return i.length?i[0]:""}keepTemporaryClasses(e){var t=["editing","edcontainer","edinside"];let s=" ";-1<e.indexOf(",")&&(s=",");var n=e.split(s),i=[];for(let e=0;e<n.length;e++){var a=n[e];"_"!=a.charAt(0)&&-1<t.indexOf(a)&&i.push(a)}return i.length?i.join(s):""}getLengthOfText(e){var t=document.createElement("div"),e=(t.textContent=e,t.innerHTML.length);return debug({level:5,return:e,coverage:6,file:"dom.js"},"getLengthOfText()")}increment(e,t,s=1){e=this.element(e);let n=e[t];var i=n.substring(-2);n=parseFloat(n.substring(0,-2)),n+=s,e[t]=n+i}getWidthAndHeightOfText(e,t){let s=document.getElementById("textWidthAndHeightCalculator");return s=s||document.createElement("div"),t&&s.classList.add(t),s.style.fontSize=14,s.textContent=e,s.getBoundingClientRect()}isInViewport(e){var e=this.element(e);return!!e&&(e.nodeType!=Node.ELEMENT_NODE||0<(e=e.getBoundingClientRect()).top&&0<e.left&&e.bottom<=2*(window.innerHeight||document.documentElement.clientHeight)&&e.right<=2*(window.innerWidth||document.documentElement.clientWidth))}isVisible(e,t="div"){if(!this.element("scroll"))return!0;let s=!1;e=this.element(e);let n=e,i=null,a=10,o="";for(;n&&n!=this.topElement.parentNode.parentNode&&"none"!=n.style.display&&!n.classList.contains("hidden")&&(""==n.style.opacity||0!=n.style.opacity)&&a--;){if(t&&n.tagName.toLowerCase()==t&&(i=n),"scroll"==(o=this.attr(n,"computed_overflowY"))||"auto"==o){i=n;break}n=n.parentNode}return n!=this.topElement&&"scroll"!=o&&"auto"!=o||(!i||e.offsetTop>=i.scrollTop&&e.offsetTop<=i.scrollTop+i.offsetHeight+10)&&(s=!0),s}makeVisible(e,t="scroll",s="middle"){e=this.element(e),t=this.element(t);if(!e||!t)return!1;if("none"==e.style.display||""==e.style.display&&e.classList.contains("hidden"))return!1;e.getBoundingClientRect();var n=document.documentElement.clientHeight-t.offsetTop,i=this.getSaveableParent(e),a=e.offsetParent;let o=(i&&i.offsetParent!=a?i.offsetTop+e.offsetTop:e.offsetTop)-t.offsetTop;return(o-="top"==s?0:n/3)<0&&(o=0),"function"==typeof t.scrollTo&&(a=this.getView(e),this.attr(a,"computed_transform"),t.scrollTo(0,o)),!0}isHTML(e){var t=document.createElement("div");return t.innerHTML=e,t.innerHTML!=t.textContent&&(1!=t.childNodes.length||t.childNodes[0].nodeType!=Node.TEXT_NODE)}getSelector(s){let n="";if(s.id)n="'"+s.id+"'";else{var i=s.parentNode;if(!i)return debug({level:2,return:""},"Can't build selector for",s);var a,o=s.tagName.toLowerCase(),s=Array.prototype.indexOf.call(i.getElementsByTagName(o),s)+1;let e="";if(i.id)n={child:s,tag:o,parent:i.id};else{if(!(e=this.getSelector(i)))return"";n={child:s,tag:o,parent:convertToObject(e)}}let t="{";for(a in n){var l=n[a];"parent"==a&&"object"==typeof l?t+=a+":"+e+",":isNaN(l)?t+=a+":'"+l+"',":t+=a+":"+l+","}t=t.substr(0,t.length-1)+"}",n=t}return n}arrangeTable(e,t=!0){if(t&&"string"==typeof e)setTimeout(function(){API.dom.arrangeTable(e,!1)},500);else{t=this.element(e);if(!t||"TABLE"!=t.tagName||t.classList.contains("textContent"))"TABLE"!=t.tagName&&console.error("Bad arrange table request",e,t);else{var n="fixed"==this.attr(t,"computed_tableLayout"),s=API.dom.element("thead",t),a=API.dom.element("tbody",t),o=[],l=[];let i=0;var r=[],d=a.rows.length;if(a&&s){API.dom.attr(a,"onscroll","this.previousSibling.scrollLeft = this.scrollLeft;");var u=s.rows[0].cells;for(let n=0;n<u.length;n++){var c=s.rows[0].cells[n].textContent.length;o.push(0),r.push(0);for(let s=0;s<d;s++){var h=a.rows[s].cells[n];if(h){var m=h.innerHTML.split("<br>");let t=0;for(let e=0;e<m.length;e++){var p=m[e],g=document.createElement("div"),p=(g.innerHTML=p,g.textContent);p.length>t&&(t=p.length)}let e=Math.max(t,c);s&&(e=Math.max(e,o[n]/s)),o[n]+=e,e>r[n]&&(r[n]=e),i+=e}}l[n]=Math.round(o[n]/d)}if(i){var f=[];for(let t=0;t<u.length;t++){var v=u[t];if(f[t]=1,l[t]>i/20){let e=v.textContent.length/l[t];e=2<e?.5:.8,f[t]=e,i-=Math.round(l[t]*(1-e)),o[t]*=e,l[t]*=e,r[t]*=e}}var b=this.attr(t,UD_useComputedPrefix+"maxWidth"),x=t.parentNode.getBoundingClientRect().width-5*u.length;let e=1;var t=API.getView(t),t=this.attr(t,"computed_transform");t&&"none"!=t&&1<(t=t.match(/matrix\(([^,]*),/)).length&&(e=parseFloat(t[1]));for(let s=0;s<u.length;s++){var y=u[s],T=(i*=e,Math.round(100*o[s]/i)),E=Math.round(x*o[s]/i);Math.min(Math.round(10*o[s]/(d*e)),35<T?Math.round(.6*E):E),e;let t=0;if(0<(t=n?Math.round(x/u.length):b&&"none"!=b?(T=Math.round(b*o[s]/i),Math.min(16*r[s],T)):E)){for(let e=0;e<a.rows.length;e++){var w=a.rows[e].cells[s];w.style.minWidth=t+"px",w.style.maxWidth=t+"px",1!=f[s]&&(w.style.fontSize=f[s]+"em")}y.style.minWidth=t+"px",y.style.maxWidth=t+"px"}}}}}}}arrangeTables(e){var t=this.elements("table",e);for(let e=0;e<t.length;e++){var s=t[e];this.arrangeTable(s,!1)}}}if("object"==typeof process){void 0===global.JSDOM&&"undefined"==typeof window&&(global.ModuleUnderTest="DOM");let domcursor=require("./domcursor.js");const DOM_cursor=domcursor.DOM_cursor;let udjsonmod=require("../ud-utilities/udjson.js");const UDJSON=udjsonmod.UDJSON;let domvaluemod=require("./domvalue.js");const DOMvalue=domvaluemod.DOMvalue;if(module.exports={DOM:DOM,DOM_cursor:DOM_cursor,JSONparse:JSONparse,JSONvalue:JSONvalue,UDJSON:UDJSON,DOMvalue:DOMvalue},void 0===global.JSDOM&&"undefined"==typeof window){console.log("Syntax dom.js OK"),console.log("Start of dom.js test program");let path="..";const testMod=require(path+"/tests/testenv.js");testMod.load([]);var dom=new DOM(document.getElementById("document"),null);let test="";{test="Test 1",console.log(dom.value("B0100000001000000M...textContent"));let element=dom.element("B0100000000000000M"),children=dom.children(element),firstChild=children[0];"attribVal"==dom.parentAttr(firstChild,"data-ud-attr")?console.log(test+" : OK"):console.log(test+": KO",firstChild,dom.parentAttr(firstChild,"data-ud-attr"))}{test="Test 2";let data={tag:"ul",name:"myul",defaults:{tag:{1:"li"}},value:{0:{value:"item1",tag:"li"},1:{value:"item2",tag:"li"}}},json={meta:{type:"list",name:"mylist",zone:"myListeditZone",caption:"My list",captionPosition:"top"},data:data,changes:{}},element=dom.JSONput(json),rjson=dom.JSONget(element);"list"==JSONvalue(rjson,"meta").type?console.log(test+" : OK"):console.log(test+": KO")}{test="3 - text editor";let data={tag:"textedit",mime:"text/text",value:["line1","line2","line3"]},json={meta:{type:"text",name:"mytextD",zone:"mytextDeditZone",caption:"My text",captionPosition:"top"},data:data,changes:{}},element=dom.JSONput(json),rjson=JSON.stringify(dom.JSONget(element));testResult(test,-1<rjson.indexOf("textedit")&&-1<rjson.indexOf("line1"),rjson)}{test="4 - views";let views=dom.views(),pages=dom.pages("myView");testResult(test,4==views.length&&1==pages.length,views.length+" views and "+pages.length+" pages in myView")}test="Test 6 - default content",testResult(test,dom.hasDefaultContent("B0100000009000000M"));{test="Test 7 - data- prefix read only";let element=dom.element("B0100000000000000M"),model=(dom.attr(element,"data-ud-model","test"),dom.attr(element,"ud_model"));testResult(test,"test"==model)}console.log("Program checksum : ",debug("__CHECKSUM__")),console.log("Program coverage : ",debug("__COVERAGE__")),console.log("Test completed")}else window.DOM=DOM}class DOM_cursor{topElement=null;parent;dom;topHTMLoffset;HTMLelement;HTMLoffset;textElement;textOffset;selectionMultiNode=!1;selectionInNode=!1;focusElement;focusOffset;display;savedValues=[];outlineCurrentElementCSS=null;noIdTags=["tr","td","th","tbody","thead","table","div","span","ul","ol","li"];constructor(e,t){this.topElement=e,this.parent=t,this.dom=t,this.HTMLelement=null}getOrAddTextNode(e){if(!e)return null;let t=null;var s,n=e.childNodes;for(let e=0;e<n.length;e++)if(n[e].nodeType==Node.TEXT_NODE){t=n[e];break}return t?t.nodeType!=Node.TEXT_NODE&&(t=null):(s=this.dom.attr(e,"ude_place"),t=document.createTextNode(s||""),t=e.appendChild(t)),t}fetch(){debug({level:9,coverage:0},"Fetching cursor");var s=window.getSelection();if(s.anchorNode){let n=s.anchorNode.parentNode;if(s.anchorNode.nodeType!=Node.TEXT_NODE){n=s.anchorNode;var i=document.activeElement;if("INPUT"==i.tagName)return this.HTMLelement=i,this.HTMLOffset=1,this.textElement=null,this}var a=this.parent.getSaveableParent(n),i=a?this.parent.getView(n):null;if(a||i&&"App"==this.parent.attr(i,"name")){if(a){i=this.parent.attr(a,"exTag");let e=!0,t=(-1<["div.html","div.zoneToFill","div.filledZone"].indexOf(i)&&(e=!1),n),s=30;for(;t&&(!t.id||"document"!=t.id)&&s--;){if((e=t==a?!1:e)&&!t.id&&-1==this.noIdTags.indexOf(t.tagName.toLowerCase()))return this;t=t.parentNode}if(!t||"document"!=t.id)return this}if(this.textElement=s.anchorNode,this.textOffset=s.anchorOffset,s.anchorNode.nodeType!=Node.TEXT_NODE){this.textElement=this.getOrAddTextNode(n);i=this.textElement;this.HTMLelement=s.anchorNode,this.HTMLoffset=this.computeHTMLoffset(i.textContent,i.textContent.length,n.innerHTML)}else{this.HTMLelement=this.textElement.parentNode;var o=this.HTMLelement.childNodes;let t=0;for(let e=0;e<o.length;e++){var l=o[e];if(l==this.textElement)break;l.nodeType==Node.TEXT_NODE?t+=this.computeHTMLoffset(l.textContent,l.textContent.length):l.nodeType==Node.ELEMENT_NODE&&(t+=l.outerHTML.length)}this.HTMLoffset=t+this.computeHTMLoffset(this.textElement.textContent,this.textOffset)}this.selectionMultiNode=this.selectionInNode=!1;let e=s.focusNode;e.nodeType!=Node.TEXT_NODE&&(e=this.getOrAddTextNode(e)),!s.isCollapsed&&e&&this.textElement&&(this.focusElement=e,this.focusOffset=s.focusOffset,i=this.dom.attr(s.anchorNode.parentNode,"editable"),r=this.dom.attr(e.parentNode,"editable"),i&&r||r||(e=s.anchorNode,this.focusElement=e,this.focusOffset=0),s.anchorNode!=e?(this.selectionMultiNode=!0,i=this.textElement.parentNode.getBoundingClientRect(),r=this.focusElement.parentNode.getBoundingClientRect(),i.y>r.y&&(this.HTMLelement=this.focusElement.parentNode,this.HTMLoffset=this.focusOffset,this.textElement=this.focusElement,this.textOffset=this.focusOffset,this.focusElement=s.anchorNode,this.focusOffset=s.anchorOffset)):s.anchorOffset!=s.focusOffset&&(this.selectionInNode=!0,this.focusOffset<this.textOffset)&&(this.textOffset=this.focusOffset,this.focusOffset=s.anchorOffset));var r,i=document.getElementById("UDEcursorInfo");let t="";i&&(t=(t=(t=(t=(t=(t=(t+="{")+"element: '"+this.dom.getSelector(this.HTMLelement)+"',")+"offset:"+this.textOffset+",")+"tagName:"+this.HTMLelement.tagName+",")+"classes:'"+this.HTMLelement.classList+"'")+"selectionMultiNode:'"+this.selectionMultiNode+"'")+"selectionInNode:'"+this.selectionInNode+"'}",i.textContent=t),this.outlineCurrentElementCSS&&(this.parent.removeCSSfromAll(this.outlineCurrentElementCSS,this.topElement),this.HTMLelement.classList.add(this.outlineCurrentElementCSS)),debug({level:8,coverage:"DOM_cursor.fetch"},"Cursor info updated",t)}}return this}set(){if(!this.textElement){if(!this.HTMLelement)return!1;let e=this.HTMLelement,t=5;for(;e&&e.nodeType!=Node.TEXT_NODE&&--t;)e=e.firstChild;if(!e||e.nodeType!=Node.TEXT_NODE)return!1;this.textElement=e,this.HTMLelement=e.parentNode,this.textOffset=0}if(this.textElement.createTextRange){var e=this.textElement.createTextRange();e.move("character",this.textOffset),e.select()}else if(this.textElement.selectionStart)this.HTMLelement.focus(),this.textElement.setSelectionRange(caretPos,caretPos);else{var t,s,n,e=window.getSelection(),i=(0<e.rangeCount&&e.removeAllRanges(),this.dom.getParentWithTag(this.HTMLelement,"tbody"));if(i){let e=20;for(;!this.dom.isVisible(this.HTMLelement,"tbody")&&--e;)i.scrollTop+=2}this.HTMLelement&&this.textElement&&(this.HTMLelement.focus(),t=document.createRange(),this.textElement&&void 0!==this.textElement.parentNode&&this.textElement.parentNode&&t.selectNode(this.textElement),this.textOffset>this.textElement.textContent.length&&(debug({level:4},"DOM_cursor auto-correcting invalid textOffset",this.textElement,this.textOffset),this.textOffset=this.textElement.textContent.length),t.setStart(this.textElement,this.textOffset),t.collapse(!0),e.addRange(t),"li"===this.HTMLelement.tagName.toLowerCase())&&(t=(e=this.HTMLelement).parentNode,s=this.dom.element("scroll"),n=this.dom.attr(s,"computed_height"),t.offsetTop-s.scrollTop+t.offsetHeight>=n&&(s.scrollTop=t.offsetTop-(n-t.offsetHeight-100)/2),t.offsetHeight<t.scrollHeight)&&e.offsetTop>t.scrollTop+t.offsetHeight&&(t.scrollTop=e.offsetTop-50)}}clear(){window.getSelection().removeAllRanges()}setAt(e,s=0){e=this.dom.element(e);if(e){var n=this.dom.childNodes(e).concat(this.dom.elements("*",e));let t=this.getOrAddTextNode(e);for(let e=0;e<n.length;e++){var i=n[e];if(i.nodeType==Node.TEXT_NODE){t=i;break}if("input"==i.tagName.toLowerCase())return i.focus(),void(this.HTMLelement=i).setSelectionRange(s,s);if(!t&&this.dom.attr(i,"editable")){var a=i.childNodes;for(let e=0;e<a.length;e++){var o=a[e];if(o.nodeType==Node.TEXT_NODE){t=o;break}}}}return t&&(this.textElement=t,this.HTMLelement=t.parentNode,s>this.textElement.textContent.length&&(s=this.textElement.textContent.length),this.HTMLoffset=this.computeHTMLoffset(this.textElement.textContent,s,this.HTMLelement.innerHTML),this.textOffset=s,!this.HTMLelement||!this.textElement)||this.set(),this}}save(t=-1){if(!this.HTMLelement||this.HTMLelement.nodeType!=Node.ELEMENT_NODE)return-1;""==t?t=-1:"string"==typeof t&&(t=parseInt(t));var s={};if(s.scroll=this.dom.element("scroll").scrollTop,s.free=!1,this.HTMLelement&&this.HTMLelement.nodeType==Node.ELEMENT_NODE){var e=this.dom.getSelector(this.HTMLelement);if(!e)return t;s.HTMLelementId=convertToObject(e),s.HTMLoffset=this.HTMLoffset;var n=this.HTMLelement.childNodes;for(let e=s.textElementIndex=0;e<n.length;e++)n[e]==this.textElement&&(s.textElementIndex=e);s.textOffset=this.textOffset}if(-1==t){for(let e=this.savedValues-1;0<=e;e--)if(this.savedValues[e].free){t=e+1;break}-1==t&&(this.savedValues.push(s),t=this.savedValues.length)}return debug({level:4},"Saved cursor",this.savedValues[t-1]=s,t),t}restore(e,t=!1){if(debug({level:4},"Restoring cursor"),void 0===e?e=this.savedValues.length:"string"==typeof index&&(index=parseInt(index)),!(""==e||e<=0))return e=this.savedValues[e-1],t||(e.free=!0),e.scroll&&(this.dom.element("scroll").scrollTop=e.scroll),void 0!==e.HTMLelementId&&""!=e.HTMLelementId&&(this.HTMLelement=this.dom.element(e.HTMLelementId),this.HTMLelement?(this.HTMLoffset=e.HTMLoffset,this.HTMLelement.childNodes,this.textElement=this.HTMLelement.childNodes[e.textElementIndex],this.textOffset=e.textOffset,debug({level:4},"Restored cursor",this.savedValues,this.HTMLelement,this.textElement,this.textOffset),this.set(),!0):void debug({level:3},"Cursor can't restore",e.HTMLelementId))}savedCursorAsString(e){e=this.savedValues[e-1];return JSON.stringify(e)}setCurrentCursorPosition(e){var t;0<=e&&(t=window.getSelection(),e=createRange(document.getElementById("test").parentNode,{count:e}))&&(e.collapse(!1),t.removeAllRanges(),t.addRange(e))}computeHTMLoffset(e,t,s=""){var t=e.substr(0,t)+"__MARKER__",n=document.createElement("div");n.textContent=t;let i=n.innerHTML.indexOf("__MARKER__");return s&&(i+=s.indexOf(e)),i}getSelectedText(e=!1){var t=this.textElement,s=this.focusElement,n=this.computeHTMLoffset(t.textContent,this.textOffset),i=this.computeHTMLoffset(s.textContent,this.focusOffset);let a=t,o=1e3,l=a.textContent.substring(n);t==s&&(l=a.textContent.substring(n,i));var r=[];for(e&&(0==n?r.push(a):a.textContent=a.textContent.substring(0,n));a&&a!=s&&o--;)(a=a.nextSibling)==s?(l+=a.textContent.substring(0,i),e&&(cursor.focusOffset<a.textContent.length?a.textContent=a.textContent.substring(i):r.push(a))):(l+=a.textContent,e&&r.push(a));for(let e=0;e<r.length;e++)r[e].remove();return l}}"object"==typeof process&&(module.exports={DOM_cursor:DOM_cursor},void 0===global.JSDOM)&&"undefined"==typeof window&&(console.log("Syntax : OK"),console.log("Test completed"));class DOMvalue{parent=null;dom;empty;useFirstCharAsType=!0;constructor(e){this.dom=e,this.cursor=e.cursor,this.lowerCaseAttr=UD_lowerCaseAttr,this.indexableTags=UD_indexableTags,this.empty=document.createElement("p"),this.empty.textContent=""}value(t,s=null,e=null){switch((t="string"==typeof t?t.split("."):t).length){case 1:t[2]=t[0],t[1]=t[0]="";break;case 2:t[2]=t[1],t[1]=t[0],t[0]=""}this.useFirstCharAsType=!0,"!"==t[2].substring(0,1)&&(this.useFirstCharAsType=!1,t[2]=t[2].substring(1));let n;if(e)n=e;else if(!(n=this.findElement(t[0])))return debug({level:8},"can't find",t[0]),null;var i=this.dom.getSaveableParent(n),a=this.dom.attr(i,"exTag");if(-1<["div.json","div.connector"].indexOf(a)){a=i.getElementsByTagName("div")[0].textContent;let e=t[1];t[2]&&(e+="/"+t[2]),-1<a.indexOf('"meta":')&&(e="data/value/"+e);i=this.dom.udjson.valueByPath(a,e,s);if(i)return DOM_lastAccessedValues.push(n),i}if(("-"==t[1][0]||"+"==t[1][0])&&"TABLE"==n.tagName){var o=(this.dom.autoHome||this.cursor.HTMLelement).parentNode,l=n.tBodies[0].rows;let e=-1;for(e=0;e<l.length&&l[e]!=o;e++);t[1]=""+(parseInt(t[1])+e+1)}if(!(n=t[1]||t[2]?this.findChild(n,t[1],t[2]):n))return debug({level:8},"can't find child (path)",t),"N/A";let r=t[3];if(!r||""==r){if(!n)return"N/A";r="innerHTML"}if(this.dom.lastAccessedElement=n,("textContent"==r||"innerHTML"==r)&&(DOM_lastAccessedValues.push(n),s))return n[r]=s;if("all"==t[2]&&"object"==typeof n){s="";for(let e=0;e<n.length;e++)s+=this.value("..."+r,null,n[e])+",";s=s.substring(0,s.length-1).split(",")}else 0==r.indexOf("css_")?s?n.style[r.substr(4)]=s:s=n.style[r.substr(4)]:-1<UD_appAttributes.indexOf(r.toLowerCase())?s?this.dom.attr(n,r,s):(s=this.dom.attr(n,r),"_type"==r&&(s+=n.textContent),s&&""!=s||(s=this.dom.parentAttr(n,r))):s="_element"==r?n:"length"==r?n.length:(s=(s=n[r])&&""!=s||"textContent"==r||"innerHTML"==r?s:this.dom.parentAttr(n,r))||"";if(-1<this.lowerCaseAttr.indexOf(r))s=s.toLowerCase();else if(("textContent"==r||"innerHTML"==r)&&""!=t[2])if(t[2].substr(0,1).toLowerCase()==t[2].substr(0,1)&&this.useFirstCharAsType)switch(t[2].substr(0,1)){case"i":s=""==s?0:parseInt(s);break;case"f":s=""==s?0:parseFloat(s)}else s&&""!=s&&!isNaN(s)&&(s=(parseFloat(s)==parseInt(s)?parseInt:parseFloat)(s));return 5==t.length&&(s='<span class="'+t[4]+'">'+s+"</span>"),debug({level:3},t,this.dom.autoIndex1,e,s=null==s?"N/A":s),s}findElement(e){var t,s=null;if(e&&""!=e)s=(s=(s=document.getElementById(e))||document.getElementById(e.replace(/ /g,"_")))||this.dom.elementByName(e);else{if(this.dom.autoHome)n=this.dom.autoHome;else{if(this.cursor.HTMLelement||this.cursor.fetch(),!this.cursor.HTMLelement)return debug({level:2,returnValue:null},"cursor not set");var n=this.cursor.HTMLelement}switch(n.tagName.toLowerCase()){case"ul":case"span":break;case"td":if("TABLE"!=(n=n.parentNode.parentNode.parentNode).tagName)return debug({level:2,returnValue:null},"No TABLE containing TD")}for(var i=n,a=5;!this.dom.attr(i,"ude_datasrc")&&--a;)i=i.parentNode;s=this.dom.attr(i,"ude_datasrc")?document.getElementById(this.dom.attr(i,"ude_datasrc")):n}return s?(-1<this.dom.attr(s,"ud_type").indexOf("Object")||"none"==this.dom.attr(s,"computed_display"))&&(t=s.parentNode.nextSibling,this.dom.attr(t,"ude_bind")==s.id)&&"TABLE"==t.childNodes[0].tagName?t.childNodes[0]:s:debug({level:8,returnValue:null},e+" not found in DOM")}findChild(e,t,s){let n=e;if(""==t||0==t.indexOf("auto")){var i=t.substr(4);if(0<this.dom.autoIndex1)t=this.dom.autoIndex1;else{let e;switch((e=this.dom.autoHome||this.cursor.HTMLelement).tagName.toLowerCase()){case"td":case"li":t=1;for(var a=e.parentNode;a=a.previousSibling;)t++;break;case"spam":break;default:return debug({level:2,returnValue:null},"unexpected tag "+e.tagName)}}i&&(t+=parseInt(i)),n=n.getElementsByTagName("tbody")[0].rows[t-1]}else if("all"==t)"table"===e.tagName.toLowerCase()&&(n=e.rows);else{if(!(-1<this.indexableTags.indexOf(e.tagName.toLowerCase())))return null;if(isNaN(parseInt(t))){i=$$$.findRows(e.id,"id:"+t+",");if(!Array.isArray(i)||1!=i.length)return null;var o=e.getElementsByTagName("tbody")[0].rows;n=o[i[0]-1]}else switch(t=parseInt(t),e.tagName.toLowerCase()){case"table":var l=e.getElementsByTagName("tbody")[0].rows;if(t<0||t>l.length)return debug({level:2,return:null},"Bad index 1",n,t);n=l[t-1];break;case"ul":l=e.childNodes;if(t<0||t>l.length)return debug({level:2,return:null},"Bad index 1",n,t);n=l[t-1]}}return n?(""!=s&&(isNaN(parseInt(s))?"tr"===n.tagName.toLowerCase()&&("all"==s?n=n.cells:(o=(o=n.parentNode.parentNode.getElementsByTagName("thead")[0].rows[0])||n.parentNode.rows[0],-1<(i=this.getColNamesForIndex(o.cells)).indexOf(s)?n=n.cells[i.indexOf(s)]:(n=this.empty,console.log("Force empty",s,i)))):"tr"===n.tagName.toLowerCase()&&(n=n.cells[s-1])),n):null}getColNamesForIndex(t){var s=[];for(let e=0;e<t.length;e++)t[e].getAttribute("_type")?s.push(t[e].getAttribute("_type")+t[e].textContent.replace(/ /g,"").replace(/-/,"_").replace(/(')/g,"")):s.push(t[e].textContent.replace(/ /g,"").replace(/-/,"_").replace(/(')/g,""));return s}}if("object"==typeof process&&(module.exports={DOMvalue:DOMvalue},void 0===global.JSDOM)&&"undefined"==typeof window&&"undefined"==typeof ModuleUnderTest){ModuleUnderTest="domvalue.js",console.log("Syntax:OK "+ModuleUnderTest),console.log("Start of test program"),console.log("Setting up browser (client) test environment");let path="..";const testMod=require(path+"/tests/testenv.js");testMod.load([]);let ud=new UniversalDoc("document",!0,133),dom=ud.dom,test=(console.log("start testing domvalue.js"),"");{test="Test 1: ";let val=dom.value("B0100000001000000M...textContent");"Hello big world"==val?console.log(test+"OK"):console.log(test+"KO",val)}test="2 read JSON value",testResult(test,"no"==dom.domvalue.value("testConnector_parameters.ready..textContent")),test="3 read velue in table with string indexes",testResult(test,32==dom.domvalue.value("myTable.myId1.val1.textContent"),dom.domvalue.value("myTable.myId1.val1.textContent")),console.log("Test completed"),process.exit(0)}class UDAJAX{ud;dom;server;service;serverRequestId=0;serverFormName="";pending={};url;method;html;js;fetchAction="AJAX_fetch";updateAction="DEFAULT";refreshAction="AJAX_show";useNodejs=!1;PHPcookie="";isOS=!1;constructor(e,t,s){this.ud=e,this.dom=e.dom,this.server=t,this.service=s,this.serverFormName=e.serverFormName,this.isOS=this.server&&-1==this.server.indexOf("sd-bee.com")&&-1==this.server.indexOf("rfolks.com"),"object"==typeof process&&(this.useNodejs=!0)}async serverRequestPromise(s,n="GET",i="",a={},o=null,l=null){return a.promise=new Promise((e,t)=>{a.resolve=e,a.reject=t,this.serverRequest(s,n,i,a,o,l)}),a.promise}serverRequest(e,t="GET",s="",n={},i=null,a=null){if("/"==(e=this.isOS?e.replace("/webdesk/","/"+this.service+"/"):e).charAt(0)?this.url=this.server+e:this.url=this.server+"/"+e,this.isOS&&("POST"==t&&(-1<this.server.indexOf("appspot")||-1<this.server.indexOf("cloudshell"))&&(this.url=this.server),"POST"==t)&&-1<e.indexOf("AJAX_clipboard")&&(this.url=this.server+"/"+this.service+"/"),this.method=t,n.uri=e,n.url=this.url,"function"!=typeof serverTracker||serverTracker({status:"not sent yet",url:this.url,data:s}))if(this.useNodejs)"GET"==t?this.nodejs_get(e,n,i,a):"POST"==t&&TEST_serverSaving&&this.nodejs_post(e,s,n,i,a);else{t=new XMLHttpRequest,e=(t.udajax=this,t.serverRequestId=++this.serverRequestId,t.callerContext=n,this.dom.element("system-message-popup"));if(t.popup=!(!e||e.classList.contains("show"))&&e,t.onreadystatechange=function(){if(4==this.readyState){if(void 0!==this.udajax.pending[this.serverRequestId]&&delete this.udajax.pending[this.serverRequestId],"function"==typeof serverTracker&&serverTracker({status:this.status,url:this.udajax.url,context:this.callerContext,response:this.responseText}),200==this.status)debug({level:5},"server response (requestid, url, context, response)",this.serverRequestId,this.udajax.url,this.callerContext,this.responseText),debug({level:2},"Response server",this.serverRequestId),this.udajax.splitResponseIntoHTMLandJS(this.responseText),i?i(this.callerContext,this.udajax.html,this.udajax.js):"POST"==this.udajax.method?this.udajax.postSuccess(this.callerContext,this.udajax.html,this.udajax.js):"GET"==this.udajax.method&&this.udajax.getSuccess(this.callerContext,this.udajax.html,this.udajax.js);else if(console.log("AJAX error"),debug({level:2},"can't reach server with ",this.udajax.url),a&&a(this.callerContext,this.status),this.callerContext.promise)try{Promise.reject(this.callerContext.promise)}catch(e){console.error(e)}this.popup&&this.popup.classList.remove("show")}},t.open(this.method,this.url,!0),t.setRequestHeader("Content-type","application/x-www-form-urlencoded"),"object"==typeof s){let e="";for(var o in s)e+=o+"="+s[o]+"&";s=e=e.substring(0,e.length-2)}t.send(s),this.pending[this.serverRequestId]={method:this.method,url:this.url},(void 0!==n.waitPopup&&n.waitPopup||"fill zone"==n.action&&n.zone)&&e&&!e.classList.contains("show")&&(e.innerHTML='<div style="text-align:center"><img src="https://www.sd-bee.com/upload/3VUvtUCVi_processing.gif"></div>',e.classList.add("show")),debug({level:2},"request sent to server",t.serverRequestId)}}isBusy(){return Object.keys(this.pending).length}splitResponseIntoHTMLandJS(e){this.html="",this.js="";let t=e.indexOf("window.onloadapp"),s=16;var n,i;return-1==t&&(t=e.indexOf("window.onload"),s=13),50<t?(n=t-'<script type="text/javascript" lang="javascript">'.length-3,this.html=e.substr(0,n),n=t+s+3+9+2,i=e.substr(n).indexOf("}"),this.js=e.substr(n,i),this.js=this.js.replace(/LFJ_openAcco/g,"{"),this.js=this.js.replace(/LFJ_closeAcco/g,"}")):this.html=e,{html:this.html,js:this.js}}postSuccess(e,t,s){var n,i,a;"ignore"!=e.action&&("remove"==e.action?(n=this.dom.getView(e.element),e.element.remove(),n&&$$$.paginate(n)):"fill zone"==e.action?document.getElementById(e.zone).innerHTML=t:"set json"==e.action?(n=this.dom.element(e.holder),(i=this.dom.udjson.parse(t))&&(n.textContent=this.dom.udjson.valueByPath(n.textContent,e.jsonPath,i))):"reload"==e.action?location.reload(!0):"close"==e.action?(this.dom.element("document").innerHTML=t,window.close()):0==t.trim().indexOf("{")?e.ud.updateElement(e.element,t.trim()):0!=t.indexOf("<")&&"refresh"!=e.action||(e.ud.topElement.innerHTML=t)),e.promise&&(e.resolve?e.resolve(e):e.promise.then&&e.promise.then(e)),e.setCursor&&(a=e.ud.ude.dom.cursor,setTimeout(function(){a.restore()},100),debug({level:4},"Cursor restore set for 100ms")),s&&"ignore"!=e.action&&(debug({level:3},"js to run",s),doOnload(s))}getSuccess(e,t,s){var n,i,a;"ignore"!=e.action&&("update"==(n=e.action)||"insert"==n?e.ud.updateElement(e.element,t):"fill zone"==n?(debug({level:2},"fill zone",e),document.getElementById(e.zone).innerHTML=t,"document"==e.zone&&(this.ud.addToHistory(e.url),this.ud.initialise())):"set json"==e.action?(a=this.dom.element(e.holder),(i=this.dom.udjson.parse(t))&&(a.textContent=this.dom.udjson.valueByPath(a.textContent,e.jsonPath,i))):"refresh"==n?(e.element.innerHTML=t,this.ud.addToHistory(e.url)):"reload"==n?("undefined"==typeof process&&(document.open("text/html","replace"),document.write(t),document.close()),ud.topElement=ud.dom.topElement=ud.dom.element("document")):"compositeUpdate"==n&&(e.element.textContent=t,a=this.dom.getSaveableParent(element),this.ud.ude.initialiseElement(a.id)),e.promise&&(e.resolve?e.resolve(e):e.promise.then&&e.promise.then(e)),s&&debug({level:3},"js to run",s),s)&&doOnload(s)}updateZone(e,t){e="/"+this.service+"/"+e,t={zone:t,action:"fill zone",element:null,ud:this.ud};this.serverRequest(e,"GET","",t)}postElement(t,e,s,n,i=0,a){let o=e,l=("refresh"!=s&&"insert"!=s||(o=this.dom.attr(t,"ud_oid")),-1==e.indexOf("UD|")&&(e=e.replace("CD","UD|3|CD")),!1);var r,d=this.dom.attr(t,"ud_fields");let u="form="+this.serverFormName+"&input_oid="+o;if("yes"==this.dom.attr(t,"ud_saveId").toLowerCase()&&(u+="&nname="+t.id,this.dom.attr(t,"ud_saveId","__CLEAR__")),""==d||-1<d.indexOf("nlabel")){let e=this.dom.attr(t,"name");t.id==API.getConstant(UD_wellKnownElements,"docNameHolder")&&(console.error("DEPRECATED CODE USED udajax l 266"),p=this.dom.children(t),p=(e=(0<p.length?p[0]:t).textContent).replace(/ /g,"").substring(0,8),r=this.dom.udjson.parse(this.dom.attr(t,"ud_extra")).name+"_"+p)&&p&&(u+="&nname="+r),e&&(u+="&nlabel="+e)}let c="",h="";if(""==d||-1<d.indexOf("tcontent")){var m=Array.prototype.slice.call(t.childNodes);if(m.length){let e=null;var p=m[0].textContent;if((e=0==p.indexOf("{")?API.json.parse(p):e)&&JSONvalue(e,"meta"))h=m[0].textContent,"remove"!=s&&(c=this.dom.udjson.valueByPath(e,"meta/zone"));else if(this.useNodejs)h=t.innerHTML;else for(let e=0;e<m.length;e++){var g=m[e];if(g.nodeType==Node.TEXT_NODE)h+=g.textContent;else if(g.nodeType==Node.ELEMENT_NODE&&!this.dom.attr(g,"ude_bind")){var f=this.dom.keepPermanentClasses(g.className);let e=g.outerHTML;f!=g.className&&(e=e.replace('class="'+g.className+'"','class="'+f+'"')),h+=e}}}"html"==this.dom.attr(t,"ud_type")&&(h=h.replace(/&amp;/g,"&")),-1<[4,5,51].indexOf(n)?h="":this.dom.attr(t,"ud_content")&&(h=doOnsave(this.dom.attr(t,"ud_content"))),h=htmlEntities2(h,t),u+="&tcontent="+encodeURIComponent(h)}c&&(p=(r=this.dom.element(c))?r.innerHTML:"")&&p.length<65e3&&(u+="&thtml="+encodeURIComponent(p)),"remove"==s?u+="&iaccess=0&tlabel=owns":"insert"==s&&(u+="&nname="+this.dom.attr(t,"id")),(""==d||-1<d.indexOf("stype"))&&(u+="&stype="+n),(""==d||-1<d.indexOf("nstyle"))&&(u+="&nstyle="+this.dom.keepPermanentClasses(t.className,!0)),u+="&taccessRequest="+this.ud.userId,(""==d||-1<d.indexOf("textra"))&&(r={width:t.scrollWidth,height:t.scrollHeight,offsetLeft:t.offsetLeft,offsetTop:t.offsetTop,marginTop:Math.round(parseFloat(this.dom.attr(t,"computed_marginTop"))),marginBottom:Math.round(parseFloat(this.dom.attr(t,"computed_marginBottom"))),system:this.dom.udjson.parse(this.dom.attr(t,"ud_extra"))},-1<d.indexOf("textra")&&-1==d.indexOf("tcontent")&&((p=this.dom.udjson.parse(t.getElementsByTagName("div")[0].textContent)).meta?r.system=p.data.value:r.system=p),u+="&textra="+JSON.stringify(r)),u+="&dmodified=auto","refresh"==s&&(l=!0),"DEFAULT"==this.updateAction&&(this.updateAction=$$$.getParameter("elementUpdateAction"));let v="";this.updateAction&&(v+="/"+this.service+"/"+e+"/"+this.updateAction+"/"),"refresh"==s&&(v="/"+this.service+"/"+e+"/"+this.refreshAction+"/");n={element:t,action:s,setCursor:l,ud:this.ud};this.serverRequest(v,"POST",u,n,null)}postForm(e,t,s=""){var n=this.dom.element(e);if(!n)return debug({level:2,return:null},"can't find ",e);let i="";if(!(i="form"==n.tagName.toLowerCase()?n:this.dom.element("form",n)))return debug({level:2,return:null},"no form in",n);for(var a="",o=i.elements,l=0;l<o.length;l++)a+="&"+o[l].name+"="+o[l].value;a=a.substr(1),n=t,t={zone:e,element:null,action:"fill zone",setCursor:!1,ud:this.ud};return""!=s&&!confirm(s)||this.serverRequest(n,"POST",a,t),!1}link(e,t,s,n){}nodejs_get(e,a={},o=null,t){var s=window.request,e=(this.server="http://dev.rfolks.com","/"==e.charAt(0)?this.url=this.server+e:this.url=this.server+"/"+e,s.jar());this.PHPcookie&&e.setCookie({key:"PHPSESSID",value:this.PHPcookie},"http://dev.rfolks.com"),this.pending[++this.serverRequestId]={method:"GET",url:this.url,context:a},s(this.url,{jar:!0},(e,t,s)=>{process.ud=global.ud;var n=global.ud.udajax,i=(void 0!==n.pending[n.serverRequestId]&&(n.pending[n.serverRequestId].context,delete n.pending[n.serverRequestId]),s.replace(/RegisterBlock/g,"console.log"),t.headers["set-cookie"]);if(i)for(let t=0;t<i.length;t++){let e=i[t];"PHPSESSID"==(e=e.split(";"))[0]&&(this.PHPcookie=e[1])}n.nodejs_processResponse(s,"get",a,o),a.promise&&a.resolve()})}nodejs_post(e,t,s={},o=null,n){var i=window.request;this.server="http://dev.rfolks.com","/"==e.charAt(0)?this.url=this.server+e:this.url=this.server+"/"+e;let a=t;if("object"!=typeof t){a={};var l=t.split("&");for(let e=0;e<l.length;e++){var r=l[e].split("=");a[r[0]]=decodeURIComponent(r[1])}}e=i.jar();this.PHPcookie&&e.setCookie({key:"PHPSESSID",value:this.PHPcookie},"http://dev.rfolks.com"),this.pending[++this.serverRequestId]={method:"POST",url:this.url,context:s},i.post({url:this.url,form:a,jar:!0},(e,t,s)=>{var n=global.ud.udajax;let i=null;if(void 0!==n.pending[n.serverRequestId]&&(i=n.pending[n.serverRequestId].context,delete n.pending[n.serverRequestId]),e)console.error("nodejs_post",e);else{var a=t.headers["set-cookie"];if(a)for(let t=0;t<a.length;t++){let e=a[t];"PHPSESSID"==(e=e.split(";"))[0]&&(this.PHPcookie=e[1])}n.nodejs_processResponse(s,"post",i,o),i&&i.promise&&i.resolve()}})}nodejs_processResponse(html,method,context,successCallback=null){if(void 0===this.url&&(this.url=context.url),-1<this.url.indexOf("AJAX_"))this.splitResponseIntoHTMLandJS(html),successCallback?successCallback(context,this.html,this.js):(method="get",this.getSuccess(context,this.html,this.js));else{let p1=html.indexOf('<div id="main"'),p1b=html.indexOf("</div> \x3c!-- main --\x3e"),p2=html.indexOf("window.onloadapp");if(50<p2){var str='<script type="text/javascript" lang="javascript">';let p3=p2-str.length-3,main=(this.html=html.substr(0,p3),document.getElementById("main")),p4=(main.innerHTML=html.substring(p1+6,p1b),p2+16+3+9+2),jspart=html.substring(p4),p5=jspart.indexOf("<\/script>");this.js=jspart.substring(0,p5-2)}else document.body.innerHTML=html.substring(p1+6,html.indexOf("</body>")-1);if(ud.topElement=ud.dom.topElement=document.getElementById("document"),this.js){let p1=this.js.indexOf("require(");const reqMod=require("../tests/testenv.js");p1&&(this.js=this.js.replace(/require\(/g,"reqMod.require("));let js="try {"+this.js+"} catch( e) {\n";js+='let lines = this.js.split( "\\n");\n',js+="console.log( e, e.message);\n",js+="}",eval(js),this.js=""}}}}if("object"==typeof process)if(module.exports={UDAJAX:UDAJAX},void 0===global.JSDOM&&"undefined"==typeof window){console.log("Syntax udajax.js:OK"),console.log("Setup test environment");var envMod=require("../tests/testenv.js");async function testGet(e,t){var s="Async get test";await t.udajax.serverRequestPromise(e,"GET","",{ud:t,action:"reload"}),"Text"==t.dom.value("B01000000B0000000M...textContent")?console.log(s+" : OK"):console.log(s+" : KO"),console.log("Test completed"),process.exit(0)}envMod.load(),window.request=require("request"),ud=new UniversalDoc("document",!0,133),console.log("Start of test program");let url="webdesk/UniversalDocElement--21-725-21--UD|3|NO|OIDLENGTH|CD|5/show/tusername|demo/tpassword|demo/";testGet(url,ud),console.log("Test completed"),process.exit(0)}else window.request=require("request");class UDEclickHandler{editor=null;dom=null;topDocument=null;mouseDownTime=0;mouseUpTime=0;constructor(e){this.editor=e,this.dom=e.dom,this.topElement=this.dom.topElement,this.setupEventListeners(),this.setupShortcuts()}setupEventListeners(){let t=this;this.topElement.addEventListener("click",function(e){t.event(e)}),this.topElement.addEventListener("mousedown",function(e){t.event(e)}),this.topElement.addEventListener("mouseup",function(e){t.event(e)}),this.topElement.addEventListener("touchstart",function(e){t.event(e)}),this.topElement.addEventListener("touchend",function(e){t.event(e)})}setupShortcuts(){this.requires2stageEditing=$$$.getShortcut("requires2stageEditing"),this.testEditorAttr=$$$.getShortcut("testEditorAttr"),this.clearClasses=$$$.getShortcut("clearClasses"),this.getSaveableParent=this.dom.getSaveableParent.bind(this.dom),this.getEditableParent=this.dom.getEditableParent.bind(this.dom),this.cursor=this.dom.cursor,this.contextualMenuOn=$$$.getShortcut("displayMenu"),this.contextualMenuOff=$$$.getShortcut("hideMenu"),this.element=this.dom.element,this.attr=this.dom.attr.bind(this.dom),this.parentAttr=this.dom.parentAttr.bind(this.dom),this.udjson=this.dom.udjson,this.dispatchEvent=this.editor.dispatchEvent.bind(this.editor),this.toggleClass=$$$.getShortcut("toggleClass")}event(t){let s=this.clickedElement(t);if(s){let e=!1;var n;this.editor.watchElementForChange=null,this.handledByBrowser(s)||(n=this.isEditable(s,!1),this.monitorAndFilter(t,n,s)&&(this.insideActionBox(s)?!e&&this.editor.requires2stageEditing(s)&&(s=this.editor.editingElement):e=n?(this.cursor.HTMLelement==s||s.contains(this.cursor.HTMLelement)||this.cursor.HTMLelement.contains(s)||this.editor.dispatchEvent({event:"click outside"},this.cursor.HTMLelement),this.cursor.fetch(),!(e=this.editor.dispatchEvent(t,s))&&this.editor.requires2stageEditing(s)&&(s=this.editor.editingElement),(e=!e&&$$$.testEditorAttr(s,"ude_menu")?this.displayMenu(s):e)||this.emulateMobile(t)):(t.ud_clickable=!1,t.ud_editable=!1,e=e||this.dispatchEvent(t,s),this.cursor.set(),e||this.displayMenuOnNonClickable(s)),e)&&"touchend"!=t.type&&t.preventDefault())}}handledByBrowser(e){var t=e.parentNode;let s=!1;return s=t&&"SPAN"==t.tagName&&e.parentNode.classList.contains("link")?"A"==e.tagName&&!$$$.testEditorAttr(e,"ude_edit"):""!=this.dom.parentAttr(e,"onclick")||"A"==e.tagName||"INPUT"==e.tagName}insideActionBox(e){e=this.dom.getParentWithAttribute("ud_type",e);return!!e&&e.classList.contains("actionBox")}isEditable(e,t){var s=this.attr(e,"exTag");return!(!e||"document"==e.id||"false"==this.parentAttr(e,"contenteditable")||"div.page"==s||!$$$.testEditorAttr(e,"ude_edit")&&!$$$.testEditorAttr(e,"ude_stage")&&"input"!=s||t&&"link"!=this.attr(e.parentNode,"ud_type"))}monitorAndFilter(e,t,s){if("INPUT"==s.tagName||this.attr(s,"onclick"))return!0;switch(e.type){case"mousedown":return this.mouseDownTime=this.editor.ticks,!1;case"mouseup":return this.mouseUpTime=this.editor.ticks,!1;case"touchstart":return this.editor.touchMove=!1;case"touchend":return this.editor.touchMove,!1}return!this.editor.menuManager.click(s,e)}clickedElement(e){let t=e.target;if(!t&&void 0!==e.composedPath){var s=e.composedPath();for(let e=0;e<s.length;e++){var n=s[e];if(-1<n.className.indexOf("Noedit")&&(this.dom.cursor.set(),t=null),"document"==n.id)break}}let i=t,a=20;for(;!i.id&&"A"!=i.tagName&&--a;)i=i.parentNode;if(a&&"A"==i.tagName){var o=this.editor.ticks-this.mouseDownTime,l=this.dom.attr(i,"href");if("mouseup"==e.type&&l&&18<o&&o<50)return window.open(l,"article"),i}return t==this.topDocument?(e.preventDefault(),null):t}stopEditing(){this.editor.editElement&&(this.clearClasses(this.editor.editElement,"editing,edcontainer,edinside"),this.editor.editElement=null,this.contextualMenuOff(),this.editor.leave2stageEditing(!0),this.cursor.clear())}displayMenu(e){let t=!1;if(this.testEditorAttr(e,"ude_menu")){var s=this.getSaveableParent(e),n=this.getEditableParent(e,this.dom.cursor.selectionInNode);if(!s||!n)return;var i=this.attr(n,"exTag");this.clearClasses(s,"editing edcontainer edinside"),this.clearClasses(n,"editing edcontainer edinside"),0!=i.indexOf("span")||n.classList.contains("caption")||(this.toggleClass(s,"edcontainer"),this.toggleClass(e,"edinside")),this.editor.editElement=s,this.cursor.selectionInNode&&-1==["div.editzone"].indexOf(this.dom.attr(n,"exTag"))&&!n.classList.contains("linetext")?t=this.contextualMenuOn(n,this.cursor.selectionInNode):this.cursor.selectionMultiNode?this.contextualMenuOff():t=this.contextualMenuOn(e)}return t}displayMenuOnNonClickable(e){e=this.dom.getSaveableParent(e);e.classList.contains("collapsable")&&(this.stopEditing(),this.editor.editElement=e,this.contextualMenuOn(e),processed=!0)}emulateMobile(e){let s=!1;if(this.emulateMobile){let t=this.editor;this.dom.topElement.addEventListener("mousemove",function(e){t.pointEvent(e)});var n=e.clientX,e=e.clientY;this.editor.lastClickPosition.x=n,this.editor.lastClickPosition.y=e,s=!0}return s}}if("object"==typeof process&&(module.exports={UDEclickHandler:UDEclickHandler},void 0===global.JSDOM)&&"undefined"==typeof window){var envMod=require("../tests/testenv.js");envMod.load(),console.log("Syntax OK"),console.log("Start of UDEclickHandler test program"),ud=new UniversalDoc("document",!0,133);let handle=new UDEclickHandler(ud.ude),test="click",el=$$$.dom.element("B010000000500000M"),menu=(el.click(),$$$.dom.element("fmenu")),children=$$$.dom.children(menu);children.length?console.log(test+" test: OK"):console.log(test+" test:KO",menu),console.log("Test completed"),process.exit(0)}class UDE_ideas{parent;dom;ude;ideaFcts={};unfinishedSentence="";currentGPT="";currentId="";constructor(e){this.parent=e,this.dom=e.dom,this.ude=e.ude,API&&API.addFunctions(this,["registerIdeasFunction","getIdeas","fillIdeasBox"])}event(e){"open"==e.event&&(this.currentGPT="",this.currentId="")}registerIdeasFunction(e,t){return void 0===this.ideaFcts[e]?this.ideaFcts[e]=[t]:this.ideaFcts[e].push(t),!0}getIdeas(e,t,s=!1,n){var i=this.dom.element(t);let a=[];i.textContent;let o=this.dom.attr(i,"name"),l=(o||(t=this.dom.getSaveableParent(i),o=this.dom.attr(t,"name")),[]);var r=this.dom.attr(i,"exTag"),d=(l=this.addIdeasFctToList(r,l),o&&(l=this.addIdeasFctToList(o,l)),this.dom.keepPermanentClasses(i.className).split(" "));for(let e=0;e<d.length;e++)l=this.addIdeasFctToList(r+"."+d[e],l);if(s)return 0<l.length;for(let e=0;e<l.length;e++){var u=l[e],u=u.fct(i,u.selector);u&&(a=a.concat(u))}return a}fillIdeasBox(t,e){let i=this.dom.element(t);t=i?i.previousSibling:null;if(t&&this.dom.element("div.ideasBoxBulma",t)){let e="";e=i.id==this.currentId?this.currentGPT:(this.currentId=i.id,this.currentGPT="",this.unfinishedSentence="");var t=this.buildPrompt(i),s=(String.prototype.hashCode=function(){var e,t=0;if(0!==this.length)for(e=0;e<this.length;e++)t=(t<<5)-t+this.charCodeAt(e),t|=0;return t},"textgen_"+(t+"OpenAI").hashCode()),t={provider:"OpenAI",action:"complete",text:i.textContent,prompt:t,cacheTag:s,iterations:10,max_tokens:50,lang:$$$.getLang(i).toLowerCase(),engine:"gpt-neo-20b",dataSource:"gentext",dataTarget:"UD_spare"};$$$.servicePromise("textgen",t).then(()=>{let t="";console.log("Handling prompt 0");var e=$$$.json.parse($$$.dom.element("UD_spare").textContent),s=(this.currentGPT+=e.join(""),this.buildIdeas(e));for(let e=0;e<s.length;e++){var n=s[e].replace(/\'/g,"\\'");t+='<a class="idea" onclick="'+("$$$.insertTextAtCursor( '"+n+"');")+'">'+s[e]+"</a>"}var e=i?i.previousSibling:null;e&&((e=this.dom.element("div.ideasBoxBulma",e)).textContent.length<20&&(e.innerHTML=""),e.innerHTML+=t)})}}isCode(e){var t;return-1<e.indexOf("<?")||-1<e.indexOf("?>")||(e.match(/\$/g)||[]).length>e.length/100||(t=new RegExp("\\([^\\)]*\\)/","g"),(e.match(t)||[]).length>e.length/100)}buildIdeas(e){for(var n=[];0<e.length;e++){var i=e[0].split(".");this.unfinishedSentence&&(i[0]=this.unfinishedSentence+i[0],this.unfinishedSentence=""),"."!=e[e.length-1]&&(this.unfinishedSentence=i.pop());let t=!1,s=!1;for(let e=0;e<i.length;e++){var a=i[e].trim();a&&(isNaN(a)?a.length<3||-1<a.indexOf("http")||-1<a.indexOf("more info")||-1<a.indexOf("download")||-1<a.indexOf("<|endoftext|>")||this.isCode(a)||(s?(t&&n.push(a+".<br>"),t=!1):n.push(a+".<br>")):(t=!0,s=!0))}}return n}addIdeasFctToList(t,s){var n=s.map(e=>e.fct.name);if(void 0!==this.ideaFcts[t]){var i=this.ideaFcts[t];for(let e=0;e<i.length;e++){var a=i[e];-1==n.indexOf(a.name)&&s.push({selector:t,fct:a})}}return s}buildPrompt(e,t){let s="";var n,i=this.getModelPrompts(e)[0];return s=i?(n={topic:this.getTopic(e),audience:this.getAudience(e)},this.ude.calc.substitute(i,n)):e.textContent,s+=this.currentGPT}getModelPrompts(e){let s=e,t=10;for(;s&&s!=this.dom.topElement&&t--;){var n=this.dom.keepPermanentClasses(s.className).split(" ");for(let t=0;t<n.length;t++){var i=this.dom.attr(s,"exTag");let e=$$$.getTagOrStyleInfo(i+"."+n[t],"gpt-prompt");if(e=e||$$$.getTagOrStyleInfo(n[t],"gpt-prompt"))return e.split("//")}s=(s="H1"==s.tagName?null:s).previousElement}return[""]}getTopic(s,e=!0){let n="";if(!(n=s.classList.contains("topic")?s.textContent:n)){var t=this.dom.children(s);for(let e=0;e<t.length;e++){var i=t[e];if(i.classList.contains("topic")){n=i.textContent;break}}}if(!n&&e){let e=s.previousSibling,t=10;for(;!n&&e&&e!=this.dom.topElement&&t--;)n=this.getTopic(e,!1),e=e.previousSibling}return n}getAudience(s,e=!0){let n="";if(!(n=s.classList.contains("audience")?s.textContent:n)){var t=this.dom.children(s);for(let e=0;e<t.length;e++){var i=t[e];if(i.classList.contains("audience")){n=i.textContent;break}}}if(!n&&e){let e=s.previousSibling,t=10;for(;!n&&e&&e!=this.dom.topElement&&t--;)n=this.getAudience(e,!1),e=e.previousSibling}return n}}function UDE_ideas_init(){return"object"==typeof window.MENU?(window.MENU.ideasHandler=new UDE_ideas(window.MENU),window.MENU.ideasHandler):(setTimeout(function(){UDE_ideas_init()},100),null)}if("object"!=typeof process)UDE_ideas_init();else if(module.exports={class:UDE_ideas},void 0===global.JSDOM&&"undefined"==typeof window&&"undefined"==typeof ModuleUnderTest){console.log("Syntax:OK"),console.log("Start of UDE_ideas class test program"),console.log("Setting up browser (client) test environment"),ModuleUnderTest="udeideas";let path="..";const testMod=require(path+"/tests/testenv.js");testMod.load([]);let ud=new UniversalDoc("document",!0,133);const menuMod=require(path+"/ude-view/udemenu.js");let menuManager=menuMod.init(),ideasHandler=UDE_ideas_init(),test="Test 1 calling ideas fct",myFct=(window.test1=!1,function(e){return console.log("MyFct called"),window.test1=!0,[]});ideasHandler.registerIdeasFunction("h2",myFct),ideasHandler.getIdeas("","source_h2a"),testResult(test,window.test1,window.test1),console.log("Test completed"),process.exit()}class UDE_layout{ude;dom;ud;knownHeights={};paginating=!1;constructor(e){this.ude=e,this.dom=e.dom,this.ud=e.dataSource,API&&API.addFunctions(this,["paginate","checkPagination"])}paginate(t){if(!this.paginating){this.paginating=!0;var t="string"==typeof t?this.dom.element('[name="'+t+'"]',"document"):t,r=this.dom.elements("div.page",t);let e=0,l=0;for(let o=0;o<r.length;o++){var d=r[o];let a=0;var s=this.dom.attr(d,"ud_pageHeight");if(s?a=e=parseInt(s):e&&(a=lastpageHeight),a){g(d)&&(l=0),a=this.dom.attr(d,"computed_height");var u=d.clientWidth;"border-box"==$$$.dom.attr(d,"computed_boxSizing")&&(a=(a-=this.dom.attr(d,"computed_marginTop")+this.dom.attr(d,"computed_marginBottom"))-(this.dom.attr(d,"computed_paddingTop")+this.dom.attr(d,"computed_paddingBottom")));let s=0,n=0,i=0;var c=this.dom.children(d);for(let t=0;t<c.length;t++){var h=c[t];let e=t<c.length-1?c[t+1].offsetTop-h.offsetTop:h.getBoundingClientRect().height;var m=h.getBoundingClientRect().width,p=h.offsetLeft;if(console.log("zone widths : page, el, left",u,m,p),(e=e>a?a-10:e)<l){if(o<1)return debug({level:1,return:!1},"No previous page to paginate");this.moveToPreviousPage(h,r[o-1],i++),l-=e,n=0}else{if(s+e>a||n){if(o>=r.length-1||g(r[o+1])){m=this.addPage(d);if(!m)return debug({level:1,return:this.paginating=!1},"Can't create new page to paginate");o>=r.length-1?r.push(m):r.splice(o+1,0,m)}this.moveToNextPage(h,r[o+1],n++)}else s+=e;l=0}}l=a-s}}function g(e){e=e.id;return-1==e.indexOf("_")||0==e.indexOf("Forced_")}this.paginating=!1}}addPage(e,t){var s=e.parentNode;let n=parseInt(this.dom.attr(e,"ude_pageno"))+1;var i=[];let a=e.nextSibling;for(;a;)i.push(a),a=a.nextSibling;var o=document.createElement("div");o.id="Break_div_client_"+n,o.className="page";if(this.dom.attr(o,"ud_type","page"),this.dom.attr(o,"ude_mode",this.dom.attr(e,"ude_mode")),this.dom.attr(o,"ude_edit",this.dom.attr(e,"ude_edit")),this.dom.attr(o,"ud_fields",this.dom.attr(e,"ud_fields")),this.dom.attr(o,"ude_pageno",n++),this.dom.attr(o,"ud_pageHeight",this.dom.attr(e,"ud_pageHeight")),0==i.length)s.appendChild(o);else{for(let e=0;e<i.length;e++)this.dom.attr(i[e],"ude_pageno",n++);s.insertBefore(o,i[0])}return o}moveToNextPage(e,t,s){let n=this.dom.cursor.fetch(),i="",a=-1;n&&e.contains(n.HTMLelement)?(i=this.dom.getSelector(n.HTMLelement),a=Array.prototype.indexOf.call(n.HTMLelement.childNodes,n.textElement)):n=null;s=t.childNodes[s];s?t.insertBefore(e,s):t.appendChild(e);n&&(n.HTMLelement=doOnload("$$$.dom.element("+i+");"),n.textElement=n.HTMLelement.childNodes[a],this.dom.cursor.set(),this.dom.makeVisible(n.HTMLelement))}moveToPreviousPage(e,t,s){let n=this.dom.cursor.fetch(),i="",a=-1;n&&e.contains(n.HTMLelement)?(i=this.dom.getSelector(n.HTMLelement),a=Array.prototype.indexOf.call(n.HTMLelement.childNodes,n.textElement)):n=null,t.appendChild(e),n&&(n.HTMLelement=doOnload("$$$.dom.element("+i+");"),n.textElement=n.HTMLelement.childNodes[a],this.dom.cursor.set(),this.dom.makeVisible(n.HTMLelement))}checkPagination(t){t=this.dom.element(t);if(t=this.dom.getSaveableParent(t)){let e=0;var s=t.nextSibling,s=(e=s?s.offsetTop:t.parentNode.scrollHeight)-t.offsetTop,n=this.knownHeights[t.id];void 0===n?this.knownHeights[t.id]=s:s!=n&&this.paginate(API.getView(t))}}toggleViewHeader(){}}"object"==typeof process&&(module.exports={class:UDE_layout},void 0===global.JSDOM)&&"undefined"==typeof window&&"undefined"==typeof ModuleUnderTest&&(console.log("Syntax:OK"),console.log("Test completed"),process.exit());class UDE_menu{minWidthFloater=500;usePanel=!0;floatTO=1e3;ude;dom;ud;box;icons;border=null;floater=null;useSide=!1;elementInSide=null;ticker=0;ticks=0;cursorSave=-1;editElement=null;saveSideBar="";ideasHandler=null;justClosedId=null;constructor(e){this.ude=e,this.dom=e.dom,this.ud=e.dataSource,API&&API.addFunctions(this,["displayMenu","hideMenu","collapse","expand","closeBox","displaySelectionActions","displayCode","displayConfig","displayStyle","displayLayout","displayIdeas","displayCloud","displayCloudWeb","displayCloudConnector","actionTableClick","useActionData","clearCursor","rearmFloaterTO","classChangeInMenu","getName"]);e=this.dom.element("UD_icons");e&&(this.icons=this.dom.udjson.parse(e.textContent)),(window.MENU=this).border=this.dom.element("floating-menu"),this.floater=this.dom.element("fmenu")}collapse(e){API.changeClass("collapsed",e,"collapsed,expanded")}expand(e){API.changeClass("expanded",e,"collapsed,expanded")}display(e,t=0){var s=e?this.dom.element(e):this.dom.cursor.fetch().HTMLelement;if(s){var n=this.dom.getSaveableParent(s);if("off"==API.getEditorAttr(n,"ude_menu"))return!1;if(this.dom.getSaveableParent(this.editElement)==n){if(this.editElement!=s&&this.box){switch(this.box.id){case"_TMPstyle":this.closeZone(this.box),this.position(this.border,n),this.displayStyle(s);break;case"_TMPconfig":this.closeZone(this.box),this.position(this.border,n),this.displayConfig(s)}return this.editElement=this.getEditable(s),!0}}else this.box&&this.closeZone(this.box),this.editElement&&this.hide();var i,e=this.floater;return e&&s?(this.cursorSave=this.dom.cursor.save(this.cursorSave),this.useSide?(this.saveSideBar=this.floater.innerHTML,this.floater.scrollTo(0,0),e.innerHTML="<h2>Editer un élément</h2>"):(e.innerHTML="",this.position(this.border,s),this.ticker||(this.ticker=setInterval(function(){window.MENU.tick()},100)),this.ticks=0),this.fill(s),this.useSide&&(this.copyElement(s),e="window.MENU.hide();",i="Annuler",API.dom.insertElement("span",i,{class:"button",onclick:"window.MENU.hide();",title:i},this.floater,!1,!0),e="window.MENU.updateElement('"+s.id+"'); leftColumn.switchDisplayMode();",i="Valider",API.dom.insertElement("span",i,{class:"button",onclick:e,title:i},this.floater,!1,!0),e="window.MENU.hide();leftColumn.switchDisplayMode();API.insertElement( 'p', '', { class:'undefined'}, 'element.id', true);API.displayMenu( UDE_lastInsertId)",i="Insert",API.dom.insertElement("span",i,{class:"rightButton",onclick:e,title:i},this.floater,!1,!0),this.floater.classList.add("floating-menu"),this.floater.style.width=window.getComputedStyle(this.floater)["max-width"]),this.editElement=this.getEditable(s),!0):!1}}displayMenu(e,t=null){return this.display(e,t)}tick(){if(this.floater&&"none"!=this.floater.style.display||this.box){var e=this.box?this.floatTO:100;if(this.floater.style.opacity&&!isNaN(this.floater.style.opacity)&&this.floater.style.opacity,!this.useSide&&this.ticks++>e){this.closeBox(!0),this.border.style.opacity=0;let e=this;setTimeout(function(){e.hide()},1e3),clearInterval(this.ticker),this.ticker=0}}}rearmFloaterTO(e=0){this.ticks=-e}getEditable(e,t=0){var e=this.dom.element(e),s=this.dom.getSaveableParent(e);return e.classList.contains("caption")?s:e}click(e,t){e=this.dom.element(e);let s=e;for(;s&&"div.configurator"!=this.dom.attr(s,"exTag")&&"document"!=s.id;)s=s.parentNode;return!("div.configurator"!=this.dom.attr(s,"exTag")||!this.dom.attr(e,"onclick"))}scroll(e){this.border&&"block"==this.border.style.display&&this.editElement&&this.positionBorderTop()}positionBorderTop(){var e=this.dom.element("scroll").scrollTop,t=this.dom.getSaveableParent(this.editElement),s=this.dom.attr(this.floater,"computed_height");let n=t.offsetTop-e-.5*s;t.offsetParent&&(n+=t.offsetParent.offsetTop),this.box&&(n=this.box.offsetTop-e-.5*s),this.border.style.top=n+"px"}clearCursor(){this.cursorSave=-1}hide(){this.useSide?(this.floater.style.width="0px",this.floater.classList.remove("floating-menu"),this.saveSideBar&&(this.floater.innerHTML=this.saveSideBar),this.saveSideBar=""):this.border&&(this.border.style.display="none",this.editElement)&&this.editElement.classList.contains("edinside")&&(this.editElement.classList.remove("edinside"),this.editElement.parentNode.classList.remove("edcontainer")),this.box&&(this.closeZone(this.box,!0),this.box=null),"_TMPconfig"==this.justClosedId&&this.ude.dispatchEvent({event:"configure",type:"configure",action:"leave"},this.editElement),this.editElement=null}hideMenu(){return this.hide()}position(t,s){if(t=t||this.border,s){s=this.dom.getSaveableParent(s);if(s){var n=s.getBoundingClientRect(),i=this.dom.attr(this.floater,"computed_height");let e=s.offsetTop-this.dom.element("scroll").scrollTop-.5*i;s.offsetParent&&(e+=s.offsetParent.offsetTop),t.style.top=e+"px",t.style.left=s.offsetLeft-10+"px",t.style.width=n.width+20+"px",t.style.height=n.height+20+"px",t.style.display="block",t.style.opacity=1}}else t.style.display="none",this.floaterActionPending&&API.closeBox(),this.editElement=null}updatePosition(e){e&&e==this.editElement&&this.position(this.border,e)}addButton(t,s,n,i,a=""){var o=this.useSide?"tool-icon":"FMicon";if(o+=" "+s+" button is-small "+n,a){let e="";if(-1<a.indexOf("/"))0==a.indexOf("resources")&&"undefined"!=typeof UDincludePath&&(a=UDincludePath+a),e=a;else{s=API.dom.element("UD_icons");if(!s)return null;n=API.dom.udjson.parse(s.textContent);e=n[a].replace("W15H15","W50H50")}return API.dom.insertElement("img","",{src:e,class:o,onclick:i,title:t},this.floater,!1,!0)}return API.dom.insertElement("span",t,{class:o,onclick:i,title:t},this.floater,!1,!0)}copyElement(e){let t=this.dom.element("MenuCopy");return t||((t=document.createElement("div")).id="MenuCopy"),t.innerHTML=e.innerHTML,this.dom.attr(t,"contenteditable","true"),this.floater.appendChild(t),this.elementInSide=t}updateElement(e){var t=this.dom.element("MenuCopy"),e=this.dom.element(e);return e.innerHTML!=t.innerHTML&&(e.innerHTML=t.innerHTML,API.setChanged(e)),t}fill(s){let e=this.dom.element(s),n=this.dom.getEditableParent(e),i=this.dom.getSaveableParent(e);if(i&&n&&this.floater){s=this.dom.getSelector(n);let e=null;var a=(a=$$$.availableClasses(n).filter(e=>n.classList.contains(e))).length?a[0]:"";this.getLabel(a);let t=API.dom.attr(n,"exTagType");this.getLabel(t);a=this.floater;{let e="$$$.displayStyle("+s+");";var o=this.dom.attr(n,"exTag");-1<["div.html","div.filledZone","div.zoneToFill"].indexOf(o)&&(e="$$$.displayCode("+s+");"),this.addButton("panel","centered","on",e,"resources/images/arrow-split-horizontal.png")}o="API.removeElement("+s+");API.dom.element( 'floating-menu').style.display='none'; window.ud.ude.editElement=null;";API.translateTerm("delete"),this.addButton("effacer","right pos1","off",o,"resources/images/delete-variant.png"),API.translateTerm("move");return e=this.addButton("effacer","right pos2","off","","resources/images/arrow-all.png"),this.dom.attr(e,"ondragstart","window.ude.dataActionEvent(event);"),this.dom.attr(e,"draggable","true"),e.id="move"+i.id,a}}panelOnSelection(e){var t=this.dom.element(e),s="panel-on-selection",t=(t.id,this.dom.childElements(t).length,{style:{tag:"a",onclick:"$$$.dom.styleSelection( null, 'styled', id);$$$.displayStyle( '');",value:"Style"},button:{tag:"a",onclick:"$$$.dom.styleSelection( null, 'button', id);$$$.clickOn( '');",value:"Action"},field:{tag:"a",onclick:"$$$.dom.styleSelection( null, 'field', id);$$$.clickOn( '');",value:"Champ"},link:{tag:"a",onclick:"$$$.dom.styleSelection( null, 'link', id);$$$.clickOn( '');",value:"Lien"},image:{tag:"a",onclick:"$$$.dom.styleSelection( null, 'image', id);$$$.clickOn( '');",value:"Image"}}),t=API.json.putElement({tag:"div",type:"configurator",class:"panel ",name:s,edit:"off",value:{heading:{tag:"p",class:"panel-heading",onclick:"API.closeBox();",value:"Actions sur une sélection"},tabs:{tag:"div",class:"panel-tabs",value:t}}},!1);if("object"==typeof process)return t.innerHTML;this.addActionBox(e,s,s,t)}displaySelectionActions(e){return this.panelOnSelection(e)}fillForSelection(e){return this.panelOnSelection(e)}addZone(e,t=null){var s,n,i,a,o;return this.border?(t&&(a=this.border,t=this.dom.element(t),this.usePanel&&(a.style.display="none",t.classList.add("menu-on")),e=t.parentNode.insertBefore(e,t),s=this.dom.attr(t,"computed_marginTop"),o=this.dom.attr(a,"computed_height"),n=this.dom.attr(e,"computed_height"),e.style.marginTop=s+"px",e.style.width=this.dom.attr(t,"computed_width")-5+"px",e.style.marginLeft=this.dom.attr(t,"computed_marginLeft")+"px",i=t.offsetTop-e.offsetTop,a.style.height=o+i-s/2+"px",this.cursorSave=this.dom.cursor.save(this.cursorSave),this.box=e,window.innerWidth>this.minWidthFloater&&(a=this.dom.element(".panel-block-holder",e))&&(a.classList.add("panel-block"),a.classList.remove("panel-block-holder")),this.dom.attr(this.box,"ude_menu","off"),this.dom.makeVisible(t.previousSibling),o=t.parentNode,"div.page"==this.dom.attr(o,"exTag")&&(o.style.height=parseInt(this.dom.attr(o,"ud_pageHeight"))+n+"px"),this.useSide||(this.floater.style.display="none")),!0):debug({level:1,return:!1},"floatConfig() can't add config as there is no border")}closeZone(e,t=!1){this.floater.style.display="block";var s=e.parentNode;"div.page"==this.dom.attr(s,"exTag")&&(s.style.height=this.dom.attr(s,"ud_pageHeight")+"px"),this.editElement&&!this.useSide&&(s=this.editElement.getBoundingClientRect(),this.border.style.height=s.height+20+"px"),e.remove(),this.box=null,t&&this.cursorSave&&this.dom.cursor.restore(this.cursorSave,!0),this.usePanel&&this.editElement&&(this.border.style.display="block",this.editElement.classList.remove("menu-on"))}addActionBox(e,t,s,n="",i){var e=this.dom.element(e),a=this.dom.getSaveableParent(e);if(this.actionElement=e,this.dom.element(t)&&(this.closeZone(this.dom.element(t)),this.ude.floaterActionPending=null,this.box=null),n){this.closeBox();let e=null;e="object"==typeof n&&void 0!==n.tagName?n:this.dom.prepareToInsert("div",n,{id:t,class:"actionBox "+s,type:"configurator",ude_stage:"on",ude_bind:"next"}),this.useSide&&this.elementInSide?this.floater.insertBefore(e,this.elementInSide):this.addZone(e,a),this.box=e,window.innerWidth<this.minWidthFloater&&(this.box.focus(),this.dom.makeVisible(t,"scroll","top")),"_TMPconfig"==t&&this.ude.dispatchEvent({event:"configure",type:"configure",action:""},a)}else this.dom.cursor.restore(this.cursorSave,!0)}useActionData(t,s){var n=API.dom.element(t),s=API.dom.element(s);let i=s?s.value:"";if(i){var a,o,s=API.json.parse(i);s&&(s=this.findAndUseModel(s))&&(o=n.nextSibling,API.changeTag("div.filledZone",o.id),i=s),"_TMPwebextract_config"==t&&parseInt(API.dom.attr(n,"udc_step"))<5&&(i="https://"+i),this.dom.cursor.restore(this.cursorSave,!0);let e=this.ude.dispatchEvent({event:"use",type:"use",data:i},this.actionElement);return e||(o=this.dom.cursor.HTMLelement,n=(t=(s=this.dom.getSaveableParent(o)).getBoundingClientRect()).height,a=this.dom.isHTML(i),this.dom.hasDefaultContent(o)?o.textContent=i:a?this.ude.insertHTMLatCursor(i):this.ude.insertTextAtCursor(i),o=(t=s.getBoundingClientRect()).height,t=this.ude.floater.getBoundingClientRect(),this.ude.floater.style.height=t.height+o-n+"px",this.ude.requires2stageEditing(this.dom.cursor.HTMLelement)||this.ude.setChanged(this.dom.cursor.HTMLelement),e=!0),this.ticks=0,e}}closeBox(e=!0){this.box&&(this.justClosedId=this.box.id,this.closeZone(this.box,e),this.display(this.editElement))}_getTabs(e,t=""){var e=this.dom.element(e),s=this.dom.getSaveableParent(e),n=this.dom.getSelector(e),i=$$$.getEditorAttr(s,"ude_menu");let a="on"==i||-1<i.indexOf("sel"),o="on"==i||-1<i.indexOf("config"),l="on"==i||-1<i.indexOf("styles"),r="on"==i||-1<i.indexOf("lays"),d="on"==i||-1<i.indexOf("clouds"),u="on"==i||-1<i.indexOf("ideas");i={},a&&$$$.dom.cursor.fetch().selectionInNode&&(i.select={tag:"a",onclick:"$$$.displaySelectionActions("+n+");",value:"Select"}),(o&&this.displayConfig(e,!0)||"config"==t)&&(i.config={tag:"a",onclick:"$$$.displayConfig("+n+");",value:"Config"}),(l&&this.displayStyle(e,!0)||"styles"==t)&&(i.styles={tag:"a",onclick:"$$$.displayStyle("+n+");",value:"Styles"}),(r&&this.displayLayout(e,!0)||"layouts"==t)&&(i.layouts={tag:"a",onclick:"$$$.displayLayout("+n+");",value:"Dispositions"}),(d&&this.displayCloud(e,!0)||"cloud"==t)&&(i.cloud={tag:"a",onclick:"$$$.displayCloud("+n+");",value:"Cloud"}),(u&&this.displayIdeas(e,!0)||"ideas"==t)&&(i.ideas={tag:"a",onclick:"$$$.displayIdeas("+n+");",value:"Idées"}),(-1<["div.zoneToFill","div.html"].indexOf(this.dom.attr(s,"exTag"))||"code"==t)&&this.ude.textEd&&(i.code={tag:"a",onclick:"$$$.displayCode("+n+");",value:"Code"}),t&&(i[t].className="is-active"),e={tag:"div",class:"panel-tabs",value:i};return e}displayCode(e,t=!1,s="_TMPcode",n="styleBox"){var e=e?this.dom.element(e):this.dom.cursor.fetch().HTMLelement,i=this.dom.getSaveableParent(e);if(!e||!i)return!1;if(t)return!1;e=this.dom.getEditableParent(e),$$$.HTMLeditor(i.id),this.rearmFloaterTO(i.id);var t=API.dom.getSelector(e),a={},t=(a.upload={tag:"a",class:"panel-block",onclick:"$$$.setChanged("+t+");",title:"update",value:"update"},a.restore={tag:"a",class:"panel-block",onclick:"$$$.initialiseElement("+t+");",title:"restore",value:"restore"},{tag:"div",type:"configurator",class:"panel "+n,name:s,edit:"off",value:{heading:{tag:"p",class:"panel-heading",onclick:"API.closeBox();",value:"Code"},tabs:this._getTabs(e,"code"),styles:{tag:"p",class:"panel-block-holder is-wrapped",value:a}}}),e=API.json.putElement(t,!1);if(-1<["div.zoneToFill","div.html"].indexOf(this.dom.attr(i,"exTag"))&&$$$.HTMLeditor('"+saveable.id+"'),"object"==typeof process)return e.innerHTML;this.addActionBox(i,s,n,e)}displayStyle(e,t=!1,s="_TMPstyle",n="styleBox"){var a=e?this.dom.element(e):this.dom.cursor.fetch().HTMLelement,e=this.dom.getSaveableParent(a);if(!a||!e)return!1;if(t)return!0;var a=this.dom.getEditableParent(a),o=API.dom.getSelector(a),l=$$$.availableClasses(a),r=l.join(","),d={},u=a.classList;for(let i=0;i<l.length;i++){var c=l[i],h=$$$.getStyleLabel(c,a);let e=$$$.translateTerm("add")+" "+h,t="panel-block",s="$$$.classChangeInMenu( '"+c+"', "+o+", '"+r+"');$$$.closeBox();",n=h;u.contains(c)&&(t+=" is-active",n=[{tag:"span",class:"panel-icon",value:{tag:"i",class:"fa fa-thumbs-up"}},{value:n}],e=API.translateTerm("remove")+" "+h,s=s.replace("closeBox();","displayStyle( '"+a.id+"');")),d[h]={tag:"a",class:t,onclick:s,title:e,value:n}}t={tag:"div",type:"configurator",class:"panel "+n,name:s,edit:"off",value:{heading:{tag:"p",class:"panel-heading",onclick:"API.closeBox();",value:"Styles"},tabs:this._getTabs(a,"styles"),styles:{tag:"p",class:"panel-block-holder is-wrapped",value:d}}},t=API.json.putElement(t,!1);if("object"==typeof process)return t.innerHTML;this.addActionBox(e,s,n,t)}displayLayout(e,t=!1,s="_TMPstyle",n="styleBox"){var a=e?this.dom.element(e):this.dom.cursor.fetch().HTMLelement,e=this.dom.getSaveableParent(a);if(a&&e){var a=this.dom.getEditableParent(a),o=this.dom.getSelector(a),i=0<this.dom.elements("*",a).length;if(t&&!i)return!1;var l={},r=a.classList,d=$$$.availableLayouts(a);if(t)return 0<d.length;var u=d.join(",");for(let i=0;i<d.length;i++){var c=d[i],h=$$$.getStyleLabel(c,a);let e=$$$.translateTerm("add")+" "+h,t="panel-block",s="$$$.classChangeInMenu( '"+c+"', "+o+", '"+u+"');API.closeBox();",n=h;r.contains(c)&&(t+=" is-active",n=[{tag:"span",class:"panel-icon",value:{tag:"i",class:"fa fa-thumbs-up"}},{value:n}],e=$$$.translateTerm("remove")+" "+h,s=s.replace("closeBox();","displayLayout( '"+a.id+"');")),l[h]={tag:"a",class:t,onclick:s,title:e,value:n}}i={tag:"div",type:"configurator",class:"panel "+n,name:s,edit:"off",value:{heading:{tag:"p",onclick:"API.closeBox();",class:"panel-heading",value:"Dispositions"},tabs:this._getTabs(a,"layouts"),layouts:{tag:"p",class:"panel-block-holder",value:l}}},t=API.json.putElement(i,!1);if("object"==typeof process)return t.innerHTML;this.addActionBox(e,s,n,t)}}displayConfig(s,a=!1,o="_TMPconfig",l="configBox"){var r=this.dom.element(s),s=this.dom.getSaveableParent(r);if(r&&s){var d=this.dom.getEditableParent(r),u=API.dom.getSelector(r),c=this.dom.attr(r,"exTagType");if(a)return-1<this.dom.textContent("UD_mode").indexOf("edit")||"p.undefined"==c||-1<["data","style","program"].indexOf(this.dom.getViewType(r))||$$$.getEditorAttr(r,"fromModel");var h=c.split("."),{name:a,placeholder:m}=(this.dom.element(o)&&this.closeBox(),this.getName(d));let n=$$$.availableTags(d);r!=s&&(n=API.availableTagsForSelection(s));var p=r.classList.contains("undefined"),g={systemLabel:{tag:"span",class:"label",value:API.translateTerm("Element type & sub-type :")}},f={};let i="";d=this.getLabel(c);for(let s=0;s<n.length;s++){var v=n[s],b=this.getLabel(v),x=v.split("."),y=x.slice(0,2).join("."),T=2<x.length?x[2]:"";let e="button",t="";if(p){if(void 0!==g[b])continue;t="let el = API.changeTag( '"+y+"', "+u+", '"+T+"');"}else if(v==c)e+=" rightButton",i=3==x.length?(t="API.changeTag( '"+y+"', "+u+");API.displayConfig( '"+r.id+"');","is-active"):(t="API.changeTag( 'p.undefined', "+u+");API.displayConfig( '"+r.id+"');"," is-active");else{if(2!=h.length||x[1]!=h[1])continue;t="API.changeSubType( '"+T+"', "+u+"); API.closeBox();"}v=b;g[b]={tag:"span",class:e,onclick:t,title:b,value:b},f[b]={tag:"a",class:"panel-block"+i,onclick:t,title:b,value:v}}let e="";e+='<span class="label">Options: </span>';var E,w=this.ude.calc.attrPath(u,"ude_edit"),w=(e+=$$$.calculate("switchTag( "+w+", 'configSwitch', 'editable', 'CFG_editable');"),{systemLabel:{tag:"span",class:"label",value:API.translateTerm("Tools :")}});"div.part"==this.dom.attr(r,"exTag")&&-1<[" EN"," FR"].indexOf(a.substring(a.length-3))&&(_=API.dom.getView(r),(E=(_=API.dom.attr(_,"name")).replace(" TBC","").replace(" FR","").replace(" EN",""))!=_)&&$$$.dom.elementByName(E)&&(C=this.getLabel("Copy original"),w[d]={tag:"span",class:"button",onclick:"API.copyElements( '"+E+"', '"+_+"');",title:C,value:C}),"div.image"==c&&-1<r.innerHTML.indexOf("shutterstock")&&($$$.dom.element("img",r).src,d="$$$.licenseImage( '"+r.id+"');",E=this.getLabel("License"),w.license={tag:"span",class:"button",onclick:d,title:E,value:E});let t={};r!=s&&(t={tag:"span",class:"parentLink",value:{tag:"a",onclick:"API.hideMenu(); API.displayMenu( '"+s.id+"');API.displayConfig('"+s.id+"');",value:" parent"}});var _={tag:"div",type:"configurator",class:"actionBox "+l,name:o,value:{name:{tag:"div",class:"nameEdit",value:[{tag:"a",onclick:"API.closeBox();",class:"actionIcon",value:{tag:"img",src:this.icons.Config}},{tag:"span",class:"firstlabel",edit:"off",value:API.translateTerm("Element name :")},{tag:"span",class:"objectName",stage:"on",placeholder:m,valid:"if ( API.changeName( "+u+")) API.closeBox();",value:a},t]},tags:{tag:"div",class:"tagSelect",value:g},flags:{tag:"div",class:"flagControl",value:e},actions:{tag:"div",class:"actionSelect",value:w}}},C=API.json.putElement(_,!1),d=(this.dom.attr(C,"contenteditable","false"),this.dom.attr(this.dom.element("span.objectName",C),"contenteditable","true"),f.name={tag:"p",class:"panel-block",value:{tag:"span",class:"objectName",stage:"on",placeholder:m,valid:"if ( API.changeName( "+u+")) API.closeBox();",value:a},parentLink:t},w.systemLabel="",{tag:"div",type:"configurator",class:"panel",name:o,edit:"off",value:{heading:{tag:"p",onclick:"API.closeBox();",class:"panel-heading",value:"Configuration"},tabs:this._getTabs(r,"config"),config:{tag:"div",value:{tags:{tag:"div",class:"panel-block-holder",value:f},flags:{tag:"div",class:"flagControl",value:e},actions:{tag:"div",class:"actionSelect",value:w}}}}}),C=API.json.putElement(d,!1);return this.addActionBox(r,o,l,C),C.innerHTML}}getName(t,s=!1){let n=this.dom.attr(t,"name"),i="";if(!n){let e=this.dom.attr(t,"ud_type");e&&void 0!==window.udparams["AutoIndex_"+e]||(e="element");t=window.udparams["AutoIndex_"+e];n=API.translateTerm(e)+"_"+t,i=n,s&&window.udparams["AutoIndex_"+e]++}return{name:n,placeholder:i}}displayCloud(e,n=!1){var i=this.dom.element(e);if(i){var a="_TMPwebextract",o="webBox",l=window.ud.ude.modules[UD_moduleLabels.siteExtract],l="object"==typeof l?l.instance:null,r=API.dom.elements("div.connector",API.dom.element("document"));let t='<a href="javascript:" onclick="API.closeBox();"><img src="'+this.icons.Cloud+'"/></a>',s=(t+='<span class="boxLabel">Choisir la source : </span>',"");var d,u=API.dom.getSelector(i);if(l){if(n)return!0;l="API.displayCloudWeb("+u+");";t+='<span class="cloud-source" onclick="'+l+'">Web</span>',s+='<span class="cloud-source" onclick="'+l+'">Web</span>'}for(let e=0;e<r.length;e++){if(n)return!0;var c=API.dom.attr(r[e],"name"),h="API.displayCloudConnector("+u+", '"+c+"');";t+='<span class="cloud-source" onclick="'+h+'">'+c+"</span>",s+='<span class="cloud-source" onclick="'+h+'">'+c+"</span>"}return n?!1:(l=this.dom.prepareToInsert("div",t,{id:a,class:"actionBox "+o,type:"connector",ude_stage:"on",ude_bind:"next"}),d={tag:"div",type:"configurator",class:"panel "+o,name:a,edit:"off",value:{heading:{tag:"p",class:"panel-heading",onclick:"API.closeBox();",value:"Récupérer du cloud"},tabs:this._getTabs(i,"cloud"),content:{tag:"div",name:"_TMP_CLOUDcontent",value:s}}},l=API.json.putElement(d,!1),"object"==typeof process?t:(this.addActionBox(i,a,o,l),r.length?void 0:this.displayCloudWeb(e)))}}displayCloudWeb(n){n=this.dom.element(n);if(n){var i="_TMPwebextract",a=window.ud.ude.modules[UD_moduleLabels.siteExtract],a="object"==typeof a?a.instance:null;if(a){var o=API.dom.element(i);let e=$$$.dom.element("_TMP_CLOUDcontent"),t=!1;e?e.innerHTML="":(e=this.dom.prepareToInsert("div","",{id:i,class:"webBox",type:"connector",ude_stage:"on",ude_bind:"next"}),t=!0),this.dom.attr(o,"contenteditable","false");var l,r=this.dom.children(n);let s="";for(let e=0;e<r.length;e++){var d=r[e];if("a"==this.dom.attr(d,"exTag")&&this.dom.attr(d,"href")){s=this.dom.attr(d,"href");break}}if(s&&(l=API.translateTerm("current link")+" is "+s+".",API.dom.insertElement("span",l,{},o,UD_after,UD_inside),API.dom.insertElement("span",API.translateTerm("follow"),{ude_ui:"on",class:"button",onclick:"window.open('"+s+"');"},o,UD_after,UD_inside)),a.buildConfigZone2(e),"object"==typeof process||!t)return this.dom.cursor.setAt(this.box),content;this.addActionBox(n,i,"webBox",o),this.dom.cursor.setAt(this.box)}}}displayCloudConnector(s,n){s=this.dom.element(s);if(s){var i="_TMPwebextract",n=API.dom.element(n);if(n){let e=API.dom.element(i),t=!1;e?e.innerHTML="":(e=this.dom.prepareToInsert("div","",{id:i,class:"webBox",type:"connector",ude_stage:"on",ude_bind:"next"}),t=!0),API.dom.insertElement("a",'<img src="'+this.icons.Cloud+'"/>',{href:"javascript:",class:"actionIcon",onclick:"API.closeBox();"},e,!1,!0);var a={id:"_TMPwebPrompt",class:"webPrompt",edit:"off"},o=(API.dom.insertElement("span","Cliquer sur une cellule",a,e,!1,!0),API.dom.insertElement("input","",a={id:"_TMPwebInput",class:"webInput",type:"text"},e,!1,!0)),a={id:"_TMPwebUse",class:"button",onclick:"API.useActionData( '"+i+"', '"+o.id+"');"},a=(API.dom.insertElement("span",API.translateTerm("Use"),a,e,!1,!0),n.cloneNode(!0)),n=(a.id="TMP_"+a.id,API.dom.element("tbody",a));API.dom.element("thead",a);if(n.style.height=API.dom.attr(e,"computed_height")-92+"px",API.dom.attr(a,"onclick","API.actionTableClick( event, '"+o.id+"');"),e.appendChild(a),"object"==typeof process||!t)return content;this.addActionBox(s,i,"webBox",e),o=22+API.dom.attr("head","computed_height")+20,n.style.height=API.dom.attr(e,"computed_height")-o+"px"}}}actionTableClick(e,t){t=API.dom.element(t);if(t){var e=e.target,s=API.dom.attr(e,"exTag");if("td"==s){var n=e.parentNode;if(e==n.cells[0]){var i=n.parentNode.childNodes;let e=1;for(;e<=i.length&&i[e-1]!=n;)e++;s=API.getRow(n.parentNode.parentNode.id,e);t.value=JSON.stringify(s),e&&i[e-1].classList.add("selected")}else t.value=e.textContent}}}actionParamGet(){}actionParamSet(){}displayIdeas(d,u=!1){var c=this.dom.element(d);if(c){var d="_TMPideas",h="ideasBox",m=this.dom.udjson.value;let i="",n='<a href="javascript:" class="actionIcon" onclick="API.closeBox();"><img src="'+this.icons.Idea+'"/></a>',a="";var p=API.getEditorAttr(c,"data-ude-datasrc");if(p){if(u)return!0;let n=p;var g=doOnload("("+this.dom.getSelector(c)+")");if("object"==typeof g){let e=g.parent,t=(n={child:g.child,tag:g.tag,parent:e},"parent/"),s=5;for(;e&&"string"!=typeof e&&s--;)e=e.parent,t+="parent/";e&&(t=t.substring(0,t.length-1),g=this.dom.element(e).tagName.toLowerCase(),g=this.dom.element(g,this.dom.element(p)),n=this.dom.udjson.valueByPath(n,t,g.id))}g=this.dom.element(n);if(!g)return debug({level:1,return:null},"Error datasrc attribute in "+c.id+"not found "+n);a=g.innerHTML;let e=this.dom.attr(this.dom.getView(p),"ud_lang");e=e||"EN";g=this.dom.getView(c),p=this.dom.attr(g,"name");let t=this.dom.attr(g,"ud_lang");t=t||p.substring(p.length-2);g={action:"translate",source:e.toLowerCase(),target:t.toLowerCase(),text:a,dataTarget:"UD_spare",dataSource:"translation"};API.service("GoogleTranslate",g);$$$.servicePromise("GoogleTranslate",g).then(()=>{var e="";e+='<a class="idea" onclick="$$$.replaceTextAtCursor( this.textContent);">'+$$$.dom.element("UD_spare").textContent+"</a>",$$$.dom.element("_TMP_IDEAScontent").innerHTML=e});let s="";p={tag:"div",type:"configurator",class:"panel",name:d,edit:"off",value:{heading:{tag:"p",class:"panel-heading",onclick:"API.closeBox();",value:"Idées"},tabs:this._getTabs(c,"ideas"),content:{tag:"div",name:"_TMP_IDEAScontent",class:h+"Bulma",value:i}}};return s=API.json.putElement(p,!1),"object"!=typeof process?void this.addActionBox(c,d,h,s):s.textContent}g=this.dom.attr(c,"exTag");let o=[];var f={};{var p=this.dom.elementByName("_KEYWORDS");f.model=p?p.textContent.split(","):[];let t=function(t){var s=[];let n="";for(let e=0;e<t.length;e++){var i=t[e];-1<" .,;?!-_".indexOf(i)?(n&&s.push(n),n=""):n+=""+i}return n&&s.push(n),s},l=function(e){var t=API.dom.element("UD_lang").textContent;return!(!e.trim()||-1<UD_insignificantWords[t].indexOf(e))},r=function(e,s){var n=[],i=t(e);for(let t=0;t<i.length;t++){let e=i[t];var a,o=e.indexOf("[");-1<o&&(a=e.substr(o+1,e.indexOf("]")-o-1),e=e.substr(0,o),void 0===s[a]&&(s[a]=[]),s[a].push(e)),e=window.ud.ude.calc.removeAccentsAndLower(e),l(e)&&n.push(e)}return n},e=(f.element=r(c.textContent,f),c.textContent,f.section=[],c),s=3;for(;(e=e.previousSibling)&&s--;)f.section=f.section.concat(r(e.textContent,f)),e.textContent;for(e=c,s=3;(e=e.nextSibling)&&s--;)f.section=f.section.concat(r(e.textContent,f)),e.textContent;if(f.view=[],"div.image"==g){if(u)return!0;n+=API.getImagePicker(c,"API.closeBox();",f),i+=API.getImagePicker(c,"API.closeBox();",f)}else{if(this.ideasHandler)return u||this.dom.element(d)||(p={tag:"div",type:"configurator",class:"panel",name:d,edit:"off",value:{heading:{tag:"p",class:"panel-heading",onclick:"API.closeBox();",value:"Idées"},tabs:this._getTabs(c,"ideas"),content:{tag:"div",name:"_TMP_IDEAScontent",class:h+"Bulma",value:$$$.translateTerm("Searching ideas")}}},n=API.json.putElement(p,!1),"object"!=typeof process&&this.addActionBox(c,d,h,n),this.ideasHandler.event({event:"open"})),u?this.ideasHandler.getIdeas(f,c,u):void(o=this.ideasHandler.getIdeas(f,c));{var v=this.dom.attr(c,"exTag");let e=this.dom.element("[name='Ideas']",this.dom.element("document"));e=e||this.dom.element("[name='Models']",this.dom.element("document"));var b=this.dom.element("h2",e)?API.grabPortion():API.dom.unpagedChildElements(e);for(let e=0;e<b.length;e++){var x=b[e],y="object"==typeof x?x.innerHTML:x;if(-1<y.indexOf("{verb}")){var T=m(f,"verb"),E=m(f,"noun"),w=m(f,"article");for(let e=0;e<T.length;e++){var _=T[e];for(let e=0;e<E.length;e++){var C=E[e],A=w[e],A=y.replace("{verb}",_).replace("{article}",A).replace("{noun}",C);b.push(A)}}}else("string"==typeof x||this.dom.attr(x,"exTag")==v&&function(e,t){if(!e)return!0;var s=e.split(" ");for(let e=0;e<s.length;e++)if(t.classList.contains(s[e]))return!0;return!1}(x.className,c))&&function(e,t){var s=r(e);let n=0;var i=[];for(let e=0;e<s.length;e++){var a=s[e],o=n;-1<t.model.indexOf(a)?n+=3:-1<t.element.indexOf(a)?n+=10:-1<t.section.indexOf(a)?n+=6:-1<t.view.indexOf(a)&&(n+=3),n>o&&i.push(a)}return 6<n}(y,f)&&-1==o.indexOf(y)&&-1==c.textContent.indexOf(y)&&o.push(y)}}}}var g=this.dom.getSelector(c),p="API.dispatchEditEvent( "+("{ event:'idea', type:'idea', data: '"+c.textContent.replace(/\'/g,"\\'")+"'};")+", "+g+");";if(a&&(n=(n=(n+='<div id="_TMP_ideas_original" class="textExpand">')+API.translateTerm("Original text")+" : ")+'<span class="UD_idea" ude_edit="off" onclick="'+p+'">'+a+"</span></div>",i+='<a class="panel-block" onclick="'+p+'">'+a+"</a>"),n+='<span class="UD_tip" ude_edit="off">'+API.translateTerm("Click on an idea to add to your text")+"</span><br>",a&&(n=(n+='<div id="_TMP_ideas_translations" class="textExpand">')+'Google Translate : <span name="_TMP_ideas_Google_translate" class="textExpand translation" onclick="'+p+'">Translation comes here</span></div>',i+='<a name="_TMP_ideas_Google_translate" class="panel-block" onclick="'+p+'">Translation comes here/a>'),u)return 0<o.length;for(let e=0;e<o.length;e++){var t=this.dom.getSelector(c),t="API.dispatchEditEvent( "+("{ event:'idea', type:'idea', data: '"+o[e].replace(/\'/g,"\\'")+"'}")+", "+t+");";n+='<span class="UD_idea" ude_edit="off" onclick="'+t+'">'+o[e]+"</span><br>",i+='<a class="panel-block" onclick="'+t+'">'+o[e]+"</a>"}return u?0<o.length:(g={tag:"div",type:"configurator",class:"panel",name:d,edit:"off",value:{heading:{tag:"p",class:"panel-heading",onclick:"API.closeBox();",value:"Idées"},tabs:this._getTabs(c,"ideas"),content:{tag:"div",name:"_TMP_IDEAScontent",class:h+"Bulma",value:i}}},n=API.json.putElement(g,!1),"object"==typeof process?n.textContent:void this.addActionBox(c,d,h,n))}}find(e){}getLabel(e,t="",s="",n=""){if(!e)return"";let i="";var a=window.lang;let o=null;var l=API.json.value;return o=(o=!(o=!(o=!(o=!(o=t&&s&&n?l(UD_exTagAndClassInfo,"div.part."+s+" ."+n+" "+t+"."+e):o)&&t&&n?l(UD_exTagAndClassInfo,"div.part."+n+" "+t+"."+e):o)&&t&&s?l(UD_exTagAndClassInfo,"div.part."+s+" "+t+"."+e):o)&&s?l(UD_exTagAndClassInfo,"div.part."+s+" "+e):o)&&t?l(UD_exTagAndClassInfo,t+"."+e):o)||l(UD_exTagAndClassInfo,e),i=(i=(i=o?(i="EN"==a?i=l(o,"label"):l(o,"label_"+a))||API.json.value(o,"label"):i)||API.translateTerm(e))||e}getTagOrStyleLabel(e){return this.getLabel(e)}getIcon(e,t,s="json100"){let n="";window.lang;var i=API.json.value(UD_exTagAndClassInfo,e);return(n=i?API.json.value(i,"icon"):n)?n="json100"==s?{tag:"img",class:"LAY_icon",onclick:t,title:this.getLabel(e),src:"/tmp/W24H24_"+n}:n:e}findAndUseModel(e){var t=Object.keys(e),t=this.findModels(t);return t.length?(t=t[0],t=API.dom.element(t).innerHTML,API.calc.substitute(t,e)):""}findModels(n){var i=[],a=API.dom.elements("div.html","document");for(let s=0;s<a.length;s++){var o=a[s],o=API.dom.attr(o,"name")+"viewZone",l=API.dom.element(o).innerHTML;let e=0,t=0;for(;-1<(e=l.indexOf("{",e));){var r=l.indexOf("}",e);if(r<=0)break;var d=l.substring(e+1,r);-1<n.indexOf(d)&&t++,e=r+1}t>=n.length-3&&i.push(o)}return i}displayViewConfig(e,t){e=API.dom.element('[name="'+e+'"]',"middleColumn");if(!e)return null;this.ude.displayFloatingMenu(e)}classChangeInMenu(e,t,s){var n=$$$.dom.element(t);let i=n.className;n.classList.forEach(e=>{(-1<s.indexOf(e)||0==e.indexOf("LAY_"))&&(i=e)}),$$$.changeClass(e,t,s),API.updateContentAfterEvent(n,{eventType:"changeClass",oldClass:i,newClass:e}),this.display(this.dom.getSaveableParent(n)),this.ud.viewEvent("changeClass",n),this.ude.dispatchEvent({event:"classAdded",type:"classAdded",class:e},n)}}function UDE_menu_init(){var e=new UDE_menu(window.ud.ude);return window.ud.ude&&(window.ude.menuManager=e),e}if("object"==typeof process&&(module.exports={class:UDE_menu,init:UDE_menu_init},void 0===global.JSDOM)&&"undefined"==typeof window&&"undefined"==typeof ModuleUnderTest){console.log("Syntax:OK"),console.log("Start of UDE_menu class test program"),console.log("Setting up browser (client) test environment"),ModuleUnderTest="udemenu";let path="..";const testMod=require(path+"/tests/testenv.js");testMod.load([]);let ud=new UniversalDoc("document",!0,133),menuManager=UDE_menu_init(),modelsViewData=(menuManager.icons={Style:"",Config:"",Idea:"",Cloud:""},{tag:"div",name:"B0A0000000100000M",label:"Models",type:"page",class:"page",value:[{tag:"p",value:"Hello brave world"},{tag:"p",value:"Hello cruel world"},{tag:"p",value:"Totally different"}]}),modelsView=API.dom.udjson.putElement(modelsViewData);API.dom.element("document").appendChild(modelsView);{let test="1 - Ideas",elName="B0100000001000000M",ideas=(ud.dom.cursor.setAt(ud.dom.element(elName)),menuManager.displayIdeas(elName));testResult(test,-1<ideas.indexOf("cruel"),ideas)}{let test="2 - Config",config=menuManager.displayConfig("B0100000001000000M");testResult(test,-1<config.indexOf("panel"),config)}console.log("Test completed"),process.exit()}class UDE_styleManager{constructor(){}mapStylesOnAll(){for(var e in this.maps){var t=$$$.dom.element("document"),s=$$$.dom.elements("."+e,t);for(let e=0;e<s.length;e++)this.mapStyleOnElement(s[e])}}mapStyleOnElement(e,t="",s){if(newstyle)for(var n in this.map[t])e.classList.add(n)}}"object"==typeof process&&(module.exports={UDE_styleManager:UDE_styleManager},void 0===global.JSDOM)&&"undefined"==typeof window&&console.log("Test completed");class UDEcalc{dom;ude;delimiters=" \n\t=+-*/;,&()'\"";keepDelimiters="=+-*/;,&()'";expr;litteral;quote;autoId=1;cssCalc=null;termCount=0;mathFunctions=["abs","acos","acosh","asin","asinh","atan","atan2","atanh","cbrt","ceil","clz32","cos","cosh","exp","expm1","floor","fround","hypot","imul","log","log10","lop1p","log2","max","min","pow","random","round","sign","sin","sinh","sqrt","tan","tanh","trunc"];cssFunctions=["classesByTag"];tableFunctions=["findRows","findFirstRow","sumsBy","sumsByAK","sumsByAV","sumIf","concatIf","valueList","getRow","tableColumns"];localFunctions=["lookup","ajaxZoneCall","style","if","row","column","datestr","json","imageTag","linkTag","linkJStag","metricTag","multiCalc","checkboxTag","switchTag","switchTagCallback","toggleSwitch","selectorTag","getSingleChoice","textContent2HTML","substitute","buildComposite","buildJSONlist","checkValue","inList","inBetween","listNames","listValues","formatList","removeAccents","item","trim","uppercase","titlecase","orop","oneOf","defaultValue","jsonKeys","api","isName","isDate","array","content","uround","value","textReplace","attrPath"];functions={};dependencies={};toDo=[];lockToDo=!1;constructor(e,t){this.dom=e,this.ude=t,"undefined"==typeof moment&&t&&"undefined"==typeof process&&(window.dayjs=require("dayjs"),window.moment=window.dayjs,window.moment.locale(window.lang.toLowerCase())),"undefined"!=typeof API&&API&&API.addFunctions(this,["redoDependencies","toggleSwitch","if","selectorTag","getSingleChoice","getMultipleChoice"])}addFunctions(t,s){for(let e=0;e<t.length;e++)this.functions[t[e]]=s;return!0}addTokenToExpr(e,t){var s;return this.litteral?(this.expr+=e+t,t==this.quote&&(this.litteral=!1)):"'"==t||'"'==t?(this.litteral=!0,this.quote=t,this.expr+=t):(isNaN(e)?t&&"("==t?""==e?this.expr+=t:-1<this.mathFunctions.indexOf(e)?this.expr+="Math."+e:-1<this.localFunctions.indexOf(e)?this.expr+="this."+e:-1<this.tableFunctions.indexOf(e)?this.expr+="this.ude.tableEd."+e:void 0!==this.functions[e]?this.expr+=this.functions[e]:-1<this.cssFunctions.indexOf(e)?this.cssCalc?this.expr+="this.cssCalc."+e:this.expr+="ERR:RETRY LATER":(s=APIreturnType(e),-1<["string","number","boolean"].indexOf(s)?this.expr+="API."+e:this.expr+="ERR:Unknown function or unallowed response type"):(0==e.indexOf("window")?this.expr+=e:this.expr+="this.dom.value('"+e+"')",this.termCount++):this.expr+=e,t&&-1<this.keepDelimiters.indexOf(t)&&(this.expr+=t)),""}prepareForExec(e){var t=this.expr="";this.litteral=!1,this.quote="";for(var s=this.termCount=0;s<e.length;s++){var n=e[s];-1<this.delimiters.indexOf(n)&&(""!=this.expr||"-"!=n&&"+"!=n)?t=this.addTokenToExpr(t,n):t+=n}return t=t&&this.addTokenToExpr(t,null),!0}exec(e,t){return this.eval(e,t)}eval(expr,element){var r;if(debug({level:4},"Computing ",this.expr,expr),!expr||!this.prepareForExec(expr)||-1<this.expr.indexOf("ERR:"))return"ERR";if(expr=expr.replace(/&quot;/g,"'"),!isNaN(this.expr))return this.expr;if("'"==this.expr.charAt(0)&&"'"==this.expr.charAt(this.expr.length-1)&&2==this.expr.match(/'/g).length||'"'==this.expr.charAt(0)&&'"'==this.expr.charAt(this.expr.length-1)&&2==this.expr.match(/\"/g).length)return this.expr.substr(1,this.expr.length-2);try{r=eval(this.expr),debug({level:4},"Computed ",this.expr,expr,r)}catch(error){r="Err",debug({level:0},"ERR eval :",this.expr),console.log(error),2<DEBUG_level&&eval(this.expr)}return r}markToUpdate(e,t=-1,s=!1){this.toDo.push({element:e,index:t,recurrent:s})}updateElement(s,n=0,i=!1){if(s&&this.dom.attr(s,"ude_formula")&&s!=this.ude.editingElement&&!s.classList.contains("stageediting"))if(this.dependencies){debug({level:4},"updating",s.id,n);let t=this.dom.attr(s,"ude_formula");if(t){var a=this.dom.attr(s,"ude_updateaction");let e=!1;"{"==s.textContent.charAt(0)&&(e=!0),DOM_lastAccessedValues=[];var o={home:this.dom.autoHome,index1:this.dom.autoIndex1,index2:this.dom.autoIndex2};if(a&&e)"chart.initialise"===a&&(a=this.dom.getSaveableParent(s),this.ude.initialiseElement(a.id));else{a=-1<t.indexOf("index."),a=(n&&a?(t=t.replace(/index/g,n),this.dom.attr(s,"ude_formula",t)):t=t.replace(/{index}/g,1),this.dom.parentAttr(s,"ude_datasrc"));if(this.dom.autoHome=a?this.dom.element(a):s,-1<["td","li"].indexOf(this.dom.attr(s,"exTag"))){let e=1,t=s.parentNode;for(;t=t.previousSibling;)e++;this.dom.autoIndex1=e}window.UDEcalc_element=s;a=this.exec(t);this.dom.autoIndex1=0,this.dom.autoHome="","..."==a?this.markToUpdate(s,n,i):"string"==typeof(s.innerHTML=a)&&0==a.indexOf("ERR")?s.classList.add("error"):s.classList.remove("error"),this.dom.elements("table",s).length&&this.dom.arrangeTables(s,!1),window.UDEcalc_element=null}var l,r=DOM_lastAccessedValues;for(l in r){r[l];var d=this.dom.attr(r[l],"id");d||(d="udcalc"+this.autoId++,r[l].id=d),void 0===this.dependencies[d]?this.dependencies[d]=[s]:-1==this.dependencies[d].indexOf(s)&&this.dependencies[d].push(s)}return i&&this.checkDependencies(s),this.dom.autoHome=o.home,this.dom.autoIndex1=o.index1,this.dom.autoIndex2=o.index2,debug({level:4},"updated",s.id,n),!0}}else this.markToUpdate(s,n,i)}do(e){if(!this.lockToDo){this.dependencies||this.initializeDependencies();var t=this.toDo;this.toDo=[];for(var s=0;s<t.length;s++){var n,i,a=t[s];"object"==typeof a&&void 0===a.id?(i=a.index,n=a.recurrent,this.updateElement(a.element,i,n)):(i=(i=this.dom.attr(a,"id"))&&i.split("_"))&&1<i.length?this.updateElement(a,parseInt(i[1])):this.updateElement(a)}}}redoDependencies(){return this.toDo=[],this.initializeDependencies(),!0}initializeDependencies(){this.dependencies=[],this.lockToDo=!0;var e,t=this.dom.topElement.getElementsByTagName("*"),s=[];for(e in this.toDo)"object"==typeof this.toDo[e]?s.push(this.toDo[e].element):s.push(this.toDo[e]);for(var n=t.length-1;0<=n;n--){var i,a=t[n];1!=a.nodeType||!this.dom.attr(a,"ude_formula")||"TD"==a.tagName&&a.parentNode.classList.contains("rowModel")||(this.dom.attr(a,"id")||(i="udcalc"+this.autoId++,a.id=i),-1==s.indexOf(a)&&this.updateElement(a))}this.lockToDo=!1,debug({level:1},"Dependencies",this.dependencies)}checkDependencies(e){void 0===e&&(this.dom.cursor.fetch(),e=this.dom.cursor.HTMLelement);var t,s=[];for(t in this.toDo)"object"==typeof this.toDo[t]?s.push(this.toDo[t].element):s.push(this.toDo[t]);if(this.lockToDo=!0,e&&void 0!==e&&void 0!==this.dependencies[e.id]){var n,i=this.dependencies[e.id];for(n in i){var a=i[n];if(a==e)return a.innerHTML="ERR",void(this.lockToDO=!1);"{"!=a.textContent.charAt(0)&&(a.innerHTML="..."),-1==s.indexOf(a)&&(this.toDo.push(a),this.checkDependencies(a))}}this.lockToDo=!1}lookup(e,t,s,n){return this.dom.createLookupFromTable(e,t,s)[n]}displayOIDcall(e,t,s=""){let n="",i="yes"==window.udAttributes.newWindowOnFiles.toLowerCase(),a=t+"/";return(i=s?i:!1)||(a+="AJAX_"),1==e?a+="modelShow/":2!=e&&3!=e||(a+="show/"),n=i&&s?"window.open('webdesk/"+a+"'/, '"+s+"')":"window.ud.udajax.serverRequest( '"+a+'\', \'GET\', null, { zone: "document", action:"fill zone", element:null, ud:window.ud});'}ajaxUpdateZoneCall(e,t){return"window.ud.udajax.serverRequest( '"+e+"', 'GET', null, { zone: \""+t+'", action:"fill zone", element:null, ud:window.ud});'}ajaxZoneCall(e,t,s,n,i,a,o=""){debug({level:5},"Ajax zone GetValue",e,t,s,i,a);var l,s=this.dom.value(e+"."+t+".id."+(s="oidChildren"==s?"data-ud-oidchildren":s)),r=this.dom.element("UD_openNewWindow"),r=!r||"yes"==r.value.toLowerCase();return-1==s.indexOf("UD|")&&-1<s.indexOf("CD|")&&(s=s.replace("CD","UD|3|CD")),s+="/"+n+"/",o?0==(l=this.dom.value(e+"."+t+".id.textContent"))?"window.ud.udajax.serverRequest( '"+o+'\', \'GET\', null, { zone: "document", action:"fill zone", element:null, ud:window.ud});':"window.open('"+o+"', '"+(a=a.replace("{id}",l))+"')":void 0!==a&&""!=a&&"_"!=a?(l=this.dom.value(e+"."+t+".id.textContent"),a=a.replace("{id}",l),r?"window.open('/webdesk/"+(s=s.replace("AJAX_modelShow","show"))+"', '"+a+"')":"window.ud.udajax.updateZone('"+(s=s.replace("AJAX_modelShow","AJAX_show"))+"','"+i+"');"):"window.ud.udajax.updateZone('"+s+"','"+i+"');"}style(e,t){return'<span class="'+t+'">'+e+"</span>"}row(e=""){if(e)return isNaN(e)?(s=this.dom.getParentAttribute("table","id",this.dom.autoHome),this.ude.tableEd.findFirstRow(s,e)||-1):this.row()+e;{var s=this.dom.autoHome;if(!s||"td"!=this.dom.attr(s,"exTag"))return-1;let e=s.parentNode,t=0;for(;e=e.previousElementSibling;)t++;return t+1}}column(e=""){var t;if(!e)return t=(e=this.dom.autoHome).parentNode,Array.from(t.cells).indexOf(e)+1}datestr(i,t="",a=""){var e;dayjs=this.dayjs,this.dayjs||(this.dayjs=dayjs=requirejs("dayjs"),l=requirejs("dayjscdn/plugin/customParseFormat"),r=requirejs("dayjscdn/plugin/relativeTime"),e=requirejs("dayjscdn/plugin/weekOfYear"),requirejs("dayjscdn/locale/fr"),dayjs.extend(l),dayjs.extend(r),dayjs.extend(e),"function"==typeof dayjs.locale&&dayjs.locale(window.lang.toLowerCase()),this.currentDate=null,this.currentWeek=-1);let o=dayjs();if(Array.isArray(t))for(let e=0;e<t.length&&!(o=dayjs(i,t[e])).isValid();e++);else o=t?dayjs(i,t):i?dayjs(i,"DD/MM/YYYY hh:mm"):dayjs();if(o.isValid()||t){if(a){let e="";return e=o.isValid()?o.format(a):e}return(o=dayjs.unix(i)).fromNow()}{i=i.trim(),this.currentDate||(this.currentDate=dayjs());let s=this.currentDate;var l=window.lang.toLowerCase(),r={en:["today","tomorrow","(Mon|Tue|Wen|Thu|Fri|Sat|Sun) ([0-9]*)h([0-9]*)","\\+([0-9]*)d","\\+([0-9]*)h","([0-9]*)h([0-9]*)","([0-9]*)h","week ([0-9]*)","clear"],fr:["aujourd'hui","demain","(Lun|Mat|Mer|Jeu|Ven|Sam|Dim) ([0-9]*)h([0-9]*)","\\+([0-9]*)j","\\+([0-9]*)h","([0-9]*)h([0-9]*)","([0-9]*)h","semaine ([0-9]*)","raz"]};let t=r[l],n=null;for(let e=0;e<t.length;e++)if(t[e]){var d=new RegExp(t[e],"i");if(n=i.match(d)){n[0]=e+1;break}}if(!n&&"en"!=l){t=r.en;for(let e=0;e<t.length;e++)if(t[e]){var u=new RegExp(t[e],"i");if(n=i.match(u)){n[0]=e+1;break}}}if(n){function c(e){var t=dayjs().week();return s=(s=dayjs()).startOf("week"),s=t<=e?s.add(7*(e-t),"days"):s.add(7*(t-e),"days")}switch(n[0]){case 0:break;case 1:s=s.subtract(1,"days"),this.currentDate=s;break;case 2:s=s.add(1,"days"),this.currentDate=s;break;case 3:let e=["Lun","Mar","Mer","Jeu","Ven","Sam","Dim"].indexOf(n[1]);-1==e&&(e=["Mon","Tue","Wed","Thu","Fri","Sat","Sun"].indexOf(n[1]));var h=parseInt(n[2]),m="string"==typeof n[3]?parseInt(n[3]):0;s=(s=0<this.currentWeek?c(this.currentWeek):s).add(e,"days").add(h,"hours").add(m,"minutes"),this.currentDate=s;break;case 4:s=s.add(parseInt(n[1]),"days");break;case 5:s=s.add(parseInt(n[1]),"hours");break;case 6:case 7:h=n[1]+"h"+(void 0!==n[2]&&n[2]?n[2]:"00"),m=dayjs(h,"h:mm");s=s.isBefore(m)?m:m.add(1,"days"),this.currentDate=s;break;case 8:h=parseInt(n[1]);this.currentWeek=h,this.currentDate=c(h);break;case 9:this.currentDate=null}}return a=a||"DD/MM/YYYY",o=s.format(a)}}json(t,e,s=null){if("string"==typeof t){if(""==t)return null;try{var n=JSON.parse(t)}catch(e){return debug({level:2},"Bad JSON",t),null}}else"object"==typeof t&&(n=t);if(!n)return null;for(var i=e.split("/"),a=0;a<i.length;a++)if(!(n=n[i[a]]))return debug({level:1,return:null},"json can't find value in jsonSTring",e,t);return s&&(n[i[a]]=s),n}if(e,t,s){return e?t:s}imageTag(e,t,s,n){var i=document.createElement("img");return i.setAttribute("src",e),i.setAttribute("alt",t),i.style.width=s,i.style.height=n,i.outerHTML}linkTag(e,t,s){var n=document.createElement("a"),e=(-1<e.indexOf("/")?n.href=e:$$$.dom.attr(n,"onclick",e.replace("&quot;",'"')),n.target=t,document.createTextNode(s));return n.appendChild(e),n.outerHTML}linkJStag(e,t,s){var n=document.createElement("a"),t=(n.href="javascript:",n.target=t,e&&""!=e?n.setAttribute("onclick",e):n.setAttribute("onclick","alert('En cours de développement');"),n.setAttribute("contenteditable","false"),document.createTextNode(s));return n.appendChild(t),n.outerHTML}checkboxTag(e,t="",s="",n=""){let i="",a=(i+="if (this.checked) this.value='yes'; else this.value='no';",s&&(i+="window.ud.ude.updateTable('"+s+"');"),'<input id="'+t+'" type="checkbox" onchange="'+i+'"');return e||"string"==typeof e&&"yes"==e.toLowerCase()?a+=' checked value="yes"':a+='value="no"',a+=" />"+n}switchTag(e,t="UDswitch",s="",n="myVal1"){var i=this.dom.domvalue.value(e);let a="",o=(a=(a+='<span class="label">'+s+"</span>")+('<span class="'+t+'">')+('<input type="checkbox" id="'+n+'" value="'+i+'"'),i&&(a+=" checked"),a=(a=a+">"+('<label for="'+n+'" class="'+("on"==i?"on":"off")+'" onclick="API.toggleSwitch(this);" ude_bind="'+e+'">'))+'<span class="switch"></span>'+"</label>",this.eval("classesByTag( 'span.' + switchClass);"));return-1<o.indexOf("ERR")?0:o||(s="span."+t,o=(o=(o=(o="")+s+"{ display:block; float:right;}\n"+s+" input { display:none;}\n")+s+" label { background-color :blue; position:relative; width:36px; height:20px; border-radius:20px;display:block;}\n"+s+" label.off { background-color :gray; position:relative; width:36px; height:20px; border-radius:20px;display:block;}\n")+s+" label.on span.switch { border-radius:50%; position:absolute; top:2px; left:18px; width:16px; height:16px; background:white;}\n"+s+" label.off span.switch { border-radius:50%; position:absolute; top:2px; left:1px; width:16px; height:16px; background:white;}\n",API.addStyleRules(o)),a}switchTagCallback(e,t,s=0,n){let i=this.switchTag("","sw1","alt");return i=i.replace('onclick="API.toggleSwitch(this);"','onclick="'+(e+"( '"+t+"', this);")+'"')}toggleSwitch(e){var t=e.previousSibling,s=(e.childNodes[0],this.dom.attr(e,"ude_bind")),n=(document.querySelector(":root"),"on"==this.dom.attr(t,"value")?"off":"on"),t=(t.setAttribute("value",n),e.className=n,s.split(".")),e=this.dom.element(t.shift());this.ude.dispatchEvent({event:"setValue",type:"setValue",key:t,value:n},e)}selectorTag(t,e="",s="",n=""){let i="";i+="<select",e&&(i+=' id="'+e+'"'),n&&(i+=' onchange="'+n+'"'),i+=">",s&&(i+='<option value="">'+s+"</option>");for(let e=0;e<t.length;e++)i+='<option value="'+t[e]+'">'+t[e]+"</option>";return i+="</select>"}getSingleChoice(e){let t=null;e=this.dom.element(e);if(!e)return null;let s=this.dom.elements('input[ type="radio"]',e);0==s.length&&(s=this.dom.elements("option",e));for(let e=0;e<s.length;e++){var n=s[e];if(n.checked||n.selected){t=n.value;break}}return t}getMultipleChoices(e){var s=[],e=this.dom.element(e);if(!e)return null;if("fieldset"==this.dom.attr(e,"exTag")){let t=this.dom.elements('input[ type="checkbox"]',e);0==t.length&&(t=this.dom.elements("option",e));for(let e=0;e<t.length;e++){var n=t[e];(n.checked||n.selected)&&s.push(n.value)}}return s.join(",")}metricTag(e,t,s,n){let i="";var a=n[0],o=n[1],n=n[2],o=this.dom.elementByName(o).clientWidth-40,a=(s=Math.min(s,1.3*a),Math.round(100*s/(1.3*a))),a=[a-2,0,a+2,0,a,80].join(",");return"value versus target"==e&&(i+='<span class="counter">'+s+" "+n+"</span>"),-1<["value versus target","progress","limit"].indexOf(e)&&(i+="<svg",t&&(i+=' id="'+t+'"'),i=(i=(i=(i=i+' viewBox="0 0 100 100" preserveaspectratio="none" class="progressmetric" width="'+o+'"')+'><rect class="back low" width="33%" height="100%" y="3" />')+'<rect class="back medium" width="33%" height="100%" x="33" y="3" /><rect class="back high" width="33%" height="100%" x="66" y="3" />')+'<polygon class="cursor" points="'+a+'" /></svg>',n)&&(i+='<span class="gaugecaption">'+n+"</span>"),i}multiCalc(e){let t=null;if(!(t="string"==typeof e?this.dom.udjson.parse(e):this.dom.udjson.parse(JSON.stringify(e))))return debug({level:2,return:null},"Multicalc, no JSON",e);for(var s in t){let e=t[s];"object"==typeof e?e=this.multiCalc(e):"string"==typeof e&&"="==e.charAt(0)&&(e=this.exec(e.substr(1))),t[s]=e}return"string"==typeof e?JSON.stringify(t):t}substituteFormulaeInElement(e){e=this.dom.eleent(e);if(e){let t="";var s=e.childNodes;for(let e=0;e<s.length;e++){var n,i,a=s[e];3==a.nodeType?t+=a.textContent:(n=this.dom.attr(a,"ude_formula"),i=this.dom.attr(a,"ud_type"),n&&(a.innerHTML=this.exec(n,a)),this.dom.attr(a,"ude_formula","__CLEAR__"),t+="field"==i?a.innerHTML:a.outerHTML)}return e.innerHTML=t,e}}textContent2HTML(e){let t=this.dom.element(e);if(!(t=t||this.dom.element(e+"_object")))return"";let s=[],n="";n=t.textContent;e=API.json.parse(n);let i=(s=e&&API.json.value(e,"meta")?API.json.valueByPath(e,"data/edit/value/value"):(n=n.replace("{edit}","")).split("\n")).shift().trim().toLowerCase(),a="";if(-1==["linetext","css","js","json","html"].indexOf(i)&&(a+=i="\n"),"html"!=i)a+=s.join("\n");else{let t=!1;for(var o in s){let e=s[o].trim();-1<(e=e.replace(/\\\"/g,'"')).indexOf("<style")||-1<e.indexOf("<style")?t=!0:(-1<e.indexOf("</style")||-1<e.indexOf("</style"))&&(t=!1),t?e+="\n":e=e||"<br />",a+=e}}e=document.createElement("textarea"),e.innerHTML=a.replace(/\n/g,"").replace(/\r/g,""),e=e.value;return e}HTML2editable(e){var t=document.createElement("textarea");t.textContent=e;let s=t.innerHTML;return s=s.replace(/</g,"\n<")}substitute(e,t){let s=e;for(var n in t){var i=new RegExp("{"+n+"}","g");s=s.replace(i,t[n])}return s}buildComposite(e,t,s){var n=e.replace(/ /g,"_").replace(/'/g,"_").replace(/"/g,"");let i=e,a=s="html"==t?this.HTML2editable(s):s;void 0!==s.caption&&(i=s.caption,a=s.data);e="";return e+('<span class="caption">'+i+'<span class="objectName">'+n+"</span></span>")+('<div id="'+n+'" class="'+t+'object hidden" ude_editZone="'+n+'editZone"')+(">"+a+"</div>")}buildJSONlist(e,t,s){e.replace(/ /g,"_").replace(/'/g,"_").replace(/"/g,"");if("text/plain"!=t)return"ERR: MIME type not processed yet"+t;if(!s)return{};var n=s.split("\n"),i={_list:{_id:e,_classList:"listScroll1"}};for(let e=0;e<n.length;e++){var a=n[e],o=n.indexOf(a);-1<o&&o<e||(i["i"+(e+1)]={value:a})}return JSON.stringify(i)}checkValue(e,t){let s="";return"string"==typeof t?s=e.replace(/\(/,"('"+t+"',"):"number"==typeof t&&(s=e.replace(/\(/,"("+t+",")),this.eval(s)}inList(){let e=Array.from(arguments);var t,s=e.shift();return-1!=(e=1==e.length&&(t=this.dom.element(e[0]))&&"UL"==t.tagName?API.getItems(t.id):e).indexOf(s)}inBetween(e,t,s){var n,i,e=parseFloat(e);let a=!1;return isNaN(e)||(n=parseFloat(t),i=parseFloat(s),a=isNaN(n)||isNaN(i)?(debug({level:2},"Between not a number",t,s),!0):n<=e&&e<=i),a}countTermsInFormula(e){return e?(this.prepareForExec(e),this.termCount):0}listNames(e){return Object.keys(e)}listValues(e){return Object.values(e)}item(e,t){if(Array.isArray(e)&&!isNaN(t)&&"object"!=typeof(e=e[t-1]))return e}formatList(e,t,s){let n="";for(var i in e){var a=n[i];isNaN(a)?n+='"'+i+'":"'+a+'", ':"money"===(a=s.split(" "))[0]?n+='"'+i+'":'+new Intl.NumberFormat(lang,{style:"currency",currency:a[1]}).format(value)+", ":n+='"'+i+'":'+new Intl.NumberFormat(lang,{style:"decimal",maximumSignificantDigits:a[1]}).format(value)+", "}return n.substr(0,n.length-2)}removeAccentsAndLower(e){let t=e.trim().toLowerCase();return t=(t=(t=(t=(t=(t=(t=(t=(t=(t=(t=(t=t.replace(new RegExp(/\s/g),"")).replace(new RegExp(/[àáâãäå]/g),"a")).replace(new RegExp(/æ/g),"ae")).replace(new RegExp(/ç/g),"c")).replace(new RegExp(/[èéêë]/g),"e")).replace(new RegExp(/[ìíîï]/g),"i")).replace(new RegExp(/ñ/g),"n")).replace(new RegExp(/[òóôõö]/g),"o")).replace(new RegExp(/œ/g),"oe")).replace(new RegExp(/[ùúûü]/g),"u")).replace(new RegExp(/[ýÿ]/g),"y")).replace(new RegExp(/\W/g),"")}trim(e,t="_"){t=newRegExp("/"+t+"/","g");return e.replace(t,"").trim()}uppercase(e){return e?e.toUpperCase():""}titlecase(e){return e?e.replace(/\w\S*/g,function(e){return e.charAt(0).toUpperCase()+e.substr(1).toLowerCase()}):""}orop(){let t=!1;for(let e=0;e<arguments.length;e++)t|=arguments[e];return t}oneOf(e){var t=[];for(let e=1;e<arguments.length;e++)t.push(arguments[e]);return-1<t.indexOf(e)}defaultValue(e,t){return""===e?t:e}jsonKeys(e){e=API.json.parse(e);return e?Object.keys(e):[]}api(e,t,s){return-1<["valueByPath"].indexOf(e)?API.json.valueByPath(t,s):API[e](t,s)}isName(e){return 1==e.length?/^[a-zA-Z\u00C0-\u017F 0-9\-]$/.test(e)?e:"":/^[a-zA-Z\u00C0-\u017F 0-9\-]+$/.test(e)?e:""}isDate(e,t="DD/MM/YY",s="DD/MM/YYYY"){return 1==e.length?/^[0-9\/]$/.test(e):this.datestr(e,t,s)}array(){for(var e=[],t=0;t<arguments.length;t++)e.push(arguments[t]);return e}content(e){let t=this.dom.element(e);if(!(t=t||this.dom.elementByName(e)))return"";let s=t.outerHTML;e="U"+this.ude.ticks;return s=s.replace(/id="/g,'id="'+e).replace(/name="/g,'name="'+e)}uround(t,s=0){if(!Array.isArray(t)){let e=t;return isNaN(e)||("string"==typeof e&&(e=parseFloat(e)),e=s?Math.round(e*10**s)/10**s:Math.round(e)),e}var n=t;for(let e=0;e<n.length;e++)n[e]=this.uround(n[e],s);return n}value(e,t="",s=""){e=this.dom.value(e+"."+t+"."+s);return isNaN(e)?e:(t=parseFloat(e))==(s=parseInt(e))?s:t}textReplace(e,t,s){return s.replace(e,t)}attrPath(e,t){var s=doOnload("$$$.dom.element("+e+");");return s?(s.id||(this.dom.attr(s,"name")?s.id=this.dom.attr(s,"name"):(s.id=$$$.getName(s,!0),this.dom.attr(s,"name",s.id))),s.id+"..."+t):(console.log(e),"")}}if("object"==typeof process&&(module.exports={UDEcalc:UDEcalc},void 0===global.JSDOM)&&"undefined"==typeof window){console.log("Syntax : OK");const envMod=require("../tests/testenv.js");requirejs=envMod.require,envMod.load(),"object"==typeof window?window.UDEcalc=UDEcalc:window={};let calc=new UDEcalc(null,null);var DOM_lastAccessedValues,DEBUG_level=6;let r,test="";"test"==(r=calc.exec("'test'",null))?console.log("Test1 : OK"):console.log("Test1 : KO "+r),14==(r=calc.exec("(20+5)*2-3*(7+5)",null))?console.log("Test2 : OK"):console.log("Test2 : KO "+r),10==(r=calc.exec("json('{\"val1\":10}', 'val1')",null))?console.log("Test3 : OK"):console.log("Test3 : KO"),test="4 checkValue/inList",testResult(test,calc.checkValue("inList( 'abc','def','ghi')","abc")),test="5 checkValue/inBetween",testResult(test,calc.checkValue("inBetween( 100,200)",150));{test="6 formatList";let list={Labradors:50,Hounds:20,Retrievers:56};testResult(test,-1<calc.formatList(list,"=","").indexOf("Retrievers"))}{test="7 listName, list Values";let list={Labradors:50,Hounds:20,Retrievers:56};testResult(test,calc.listNames(list).length==calc.listValues(list).length&&3==calc.listNames(list).length)}{test="8 uround";let w=[12.235466,"abc",55,623.3333333],r=calc.uround(w,2);testResult(test,12.24==w[0],r)}{test="9 datestr";let expr="demain",r=calc.datestr(expr);console.log(expr,r),testResult(test,-1<r.indexOf("20"),r)}{test="10 datestr";let expr="+3j",r=calc.datestr(expr);console.log(expr,r),testResult(test,-1<r.indexOf("20"),r)}{test="11 datestr working with week of year";let expr="week 19",r=calc.datestr(expr),r2=calc.datestr("Jeu 10h30","","YYYY-MM-DDTHH:mm:00");console.log(expr,r,r2),testResult(test,-1<r2.indexOf("05"),r)}console.log("Program's trace checksum: "+debug("__CHECKSUM__")),console.log("Test completed")}class UDEtext{dom;ude;textCol1="n°";textCol2="text";defaultContent={linetext:"Server/CSS/JS/JSON\n\n\n",server:"Server\n\n\n",css:"CSS\n\n",js:"JS\n\n\n",json:"JSON\n\n\n",api:"API\n\n"};constructor(e,t){this.dom=e,this.ude=t}initialise(e){var t=this.dom.element(e),s=(t.parentNode,t.nextSibling,t.childNodes),n=this.dom.attr(t,"ud_type"),i=t.classList;let a="";for(var o=0;o<i.length;o++)"table"!=i.item(o)&&""==a&&(a=i.item(o));let l="",r="",d="",u=null,c=this.dom.attr(t,"ud_mime");switch(c||(c="text/json",this.dom.attr(t,"ud_mime",c)),c="text/json"==c&&1<s.length?"text/text":c){case"text/json":if(s.length&&(u=JSONparse(s[0].textContent),l=s[0].id),!u){let e=this.dom.attr(t,"name");e=e||"Text_"+t.id,this.dom.emptyElement(t);var h=t.appendChild(this.newTextObject(e,n));l=h.id,u=JSONparse(h.textContent)}h=this.dom.udjson.putElement(u,l);t.appendChild(h);break;case"text/text":if(s.length&&1==s[0].nodeType&&"SPAN"==s[0].tagName&&s[0].classList.contains("caption"))d=(d=s[0].textContent).replace(/ /g,"_").replace(/'/g,"_").replace(/"/g,""),t.parentNode,l=s[1].id,r=s[s.length-1].innerHTML;else{d=(d=t.textContent).replace(/ /g,"_").replace(/'/g,"_").replace(/"/g,"");for(var m=t.childNodes,o=0;o<m.length;o++)t.removeChild(m[o]);var h=this.dom.prepareToInsert("span",d,{class:"caption"}),p=(t.appendChild(h),"new UDapiRequest('UDtext', 'setChanged(/"+d+"editZone/, 1);', event);");h=this.dom.prepareToInsert("input","",{type:"button",value:"save",onclick:p,udapi_quotes:"//"}),t.appendChild(h),r=this.defaultContent[n],h=this.dom.prepareToInsert("div",r,{id:d,class:"listObject, hidden"}),t.appendChild(h)}p={id:d+"editZone",class:"table",ud_type:"editZone",ud_subtype:"text",ude_bind:d,ud_mime:"text/"+n,ude_autosave:"off",ude_stage:"off"},h=this.dom.prepareToInsert("div","",p),p=("json"==n&&(r=this.JSONtoText(r)),this.convertTextToHTMLtable(r,d,a));h.appendChild(p),t.appendChild(h)}}newTextObject(e,t){var s=e.replace(/ /g,"_").replace(/'/g,"_").replace(/"/g,""),n=s+"_object";let i={meta:{type:"text",subtype:t,name:s,zone:s+"editZone",caption:e,captionPosition:"top",autosave:"off"},data:{tag:"textedit",class:"textContent "+t,value:[t.toUpperCase(),"...","..."]},changes:[]};"json"==t.toLowerCase()&&(i={meta:{type:"text",subtype:t,name:s,zone:s+"editZone",caption:e,captionPosition:"top"},data:{tag:"textedit",class:"textContent "+t,value:{jsonval1:"..."}},changes:[]});s={id:n,class:"object textObject, hidden",ud_mime:"text/json"},e=this.dom.prepareToInsert("div",JSON.stringify(i),s);return this.dom.attr(e,"ud_mime","text/json"),e}convertTextToHTMLtable(e,t,s,n=""){var i=(e=e.replace(/<br data-ud-type="linebreak">/g,"\n")).split("\n"),e=document.createElement("table"),s=(e.className=s?"textContent "+s:"textContent",e.id=t+"edittable",document.createElement("thead")),a=document.createElement("tbody");let o="window.ud.ude.setChanged( document.getElementById( '"+t+"editZone'), true);";var t="",l=(t+='<span class="rightButton"><a ref="javascript" onclick="'+(o=n?n:o)+'">save</a>',"");l+='<tr contenteditable=false><th class="rowNo">'+this.textCol1+'</th><th class="linetext">'+this.textCol2+" "+t+"</th></tr>",s.innerHTML=l=(l=l+'<tr class="rowModel">'+'<td class="rowNo" ude_formula="row()" contenteditable="false">=row()</td>')+'<td class="linetext">...</td>'+"</tr>",e.appendChild(s);for(var r=0;r<i.length;r++){var d=document.createElement("tr"),l="";l=(l+='<td contenteditable="false" ude_formula="row()" class="rowNo">'+(r+1)+"</td>")+('<td class="linetext">'+i[r]+"</td>"),d.innerHTML=l,a.appendChild(d)}return e.appendChild(a),e}inputEvent(a,o){let l=!1;var r=a.event,d=this.dom.getSaveableParent(o),u=this.dom.attr(d,"exTag"),c=this.dom.getParentWithAttribute("ude_bind",o);let h="...";void 0!==a.data&&(h=a.data);var m=this.dom.cursor.textOffset;switch(r){case"change":"true"==this.dom.udjson.value(a,"multinode")&&(p=this.dom.getParentWithTag(o,"table"),this.ude.tableEd.update(p.id));break;case"newline":let t=null;if(this.dom.isHTML(h)){var p=document.createElement("textarea");p.textContent=h.replace(/\n/g,"");var g=p.innerHTML.split("&lt;");for(let e=0;e<g.length;e++){var f=g[e].replace(/\"/g,'"');""!=f&&(f={event:r,data:"&lt;"+f.trim()},this.inputEvent(f,o))}}else{let e=!0;h&&"..."!=h||!m?0==m&&(e=!1):((p=this.dom.cursor.HTMLoffset)<(v=(b=this.dom.cursor.HTMLelement.innerHTML).length)&&(h=b.substr(p,v)),this.dom.cursor.HTMLelement.innerHTML=b.substr(0,p)),h=h.replace(/"/g,'\\"');var v=this.dom.udjson.parse('{ "'+this.textCol1+'":"=row()", "'+this.textCol2+'":"'+h+'"}'),b=(t=this.ude.tableEd?this.ude.tableEd.insertRow(null,-1,v,e,!1):this.dom.insertElementAtCursor("tr"),this.dom.udjson.value(a,"update"));""!=b&&!b||this.ude.updateTable(t.parentNode.parentNode.id),"Off"!=this.dom.getParentAttribute("","ude_autosave",this.dom.cursor.HTMLelement)&&this.ude.setChanged(this.dom.cursor.HTMLelement),this.dom.cursor.HTMLelement=t.querySelector("td :not([contenteditable=false])"),this.dom.cursor.HTMLelement||(this.dom.cursor.HTMLelement=t.cells[1]),this.dom.cursor.setAt(this.dom.cursor.HTMLelement,h.length)}l=!0;break;case"paste":p=this.dom.cursor.HTMLelement;if(p){this.ude.clearPlaceholder(p);let t=p.textContent,s=0;if("string"==typeof h){v=document.createElement("textarea"),b=(v.innerHTML=h.replace(/\n/g,""),v.textContent);if(p.textContent=t.substr(0,m)+b,m<t.length-1&&!a.last){let e=t.substr(m);e=e.replace(/"/g,'\\"'),e=this.dom.udjson.parse('{ "'+this.textCol1+'":"=row()", "'+this.textCol2+'":"'+e+'"}'),this.ude.tableEd&&(this.ude.tableEd.insertRow(null,-1,e),s=e.length)}else p.textContent=t.substr(0,m)+b+t.substr(m),s=m+b.length}else"object"==typeof h&&(this.dom.udjson.value(h,"src")&&(t=t.substr(0,m)+h.src+t.substr(m)),this.dom.cursor.HTMLelement.innerHTML=t);this.dom.cursor.setAt(this.dom.cursor.HTMLelement,s),l=!0}break;case"endPaste":v=this.dom.cursor.HTMLelement;this.ude.updateTable(v.parentNode.parentNode.parentNode.id),l=!0;break;case"cut":case"copy":this.dom.cursor.fetch();var p=this.dom.cursor,b=p.textElement,v=p.focusElement,b=(p.HTMLelement.parentNode.parentNode.childNodes,b.parentNode.parentNode),v=v.parentNode.parentNode,x=this.dom.cursor.computeHTMLoffset(p.textElement.textContent,p.textOffset),p=this.dom.cursor.computeHTMLoffset(p.focusElement.textContent,p.focusOffset),b=this.getSelection(b,v,x,p);let e="text";this.dom.isHTML(b)&&(e="html"),window.clipboarder&&(window.clipboarder.openClipboard(),v=window.clipboarder.createClip(e,b))&&window.clipboarder.saveClip(v),-1<["div.css","div.js"].indexOf(u)&&-1<UD_SERVER.indexOf("https:")&&navigator.clipboard.writeText(b),l=!0;break;case"merge up":case"merge down":case"remove":{if("TD"!=o.tagName){l=!0;break}var x=this.dom.attr(o,"textContent of siblings").replace(/\s/g,""),p=o.innerHTML,v=o.parentNode,b=v.parentNode.parentNode.id;let e=v.previousSibling.cells[1],t=0;e&&(t=e.innerHTML.length),"merge down"!=r&&e||!v.nextSibling||(e=v.nextSibling.cells[1],t=0),x&&(x=e.innerHTML,e.innerHTML=x.substring(0,t)+p+x.substring(t),t+=x.length-1),v.remove(),this.ude.tableEd.update(b),this.dom.cursor.HTMLelement=e,this.dom.cursor.HTMLoffset=t,this.dom.cursor.textElement=e.firstChild,this.dom.cursor.textOffset=t-1,this.dom.cursor.set(),l=!0;break}case"save":p=a.target;l=this.prepareToSave(c,p);break;case"update":x=this.dom.attr(o,"ud_type");let s=this.dom.attr(o,"name"),n=(s=s||o.id,this.dom.element(s+"editZone"));v=(n=this.dom.udjson.value(a,"editZoneId")?this.dom.element(this.dom.udjson.value(a,"editZoneId")):n).className;let i=this.dom.udjson.value(a,"object");if(i)i=JSON.stringify(i);else if("json"!=x){b=this.dom.element("div.textObject",o);b&&(i=b.textContent)}else{p=this.dom.element("div.object",o);if(!p)return;i=this.dom.udjson.valueByPath(p.textContent,"data/value")}"json"==x&&(i=this.JSONtoText(i));b=this.convertTextToHTMLtable(i,s,v);n&&(n.innerHTML=b.outerHTML),l=!0;break;case"setValue":p=this.dom.attr(d,"ud_type"),x=this.dom.attr(o,"id");if("json"==p){v=a.key,b=d.getElementsByTagName("div")[0],p=b.textContent;let e="data/value/"+v[0];v[1]&&(e+="/"+v[1]),p=this.dom.udjson.valueByPath(p,e,a.value),b.textContent=p,this.ude.setChanged(d);v=this.dom.element(x+"editZone"),b=this.dom.attr(v,"ude_bind"),x=this.dom.udjson.putElement(this.dom.udjson.parse(p),b);v.innerHTML=x.outerHTML}}return l}getSelection(e,t,s,n,i=!1){let a=e,o=1e3,l=a.cells[1].innerHTML.substring(s)+"\n";e==t&&(l=a.cells[1].innerHTML.substring(s,n));var r=[];for(i&&(0==s?r.push(a):a.cells[1].innerHTML=a.cells[1].innerHTML.substring(0,s));a&&a!=t&&o--;){var d=(a=a.nextSibling).cells[1].innerHTML;a==t?(l+=d.substring(0,n),i&&(cursor.focusOffset<a.cell[1].innerHTML.length?a.cells[1].innerHTML=d.substring(n):r.push(a))):(l&&(l+="\n"),l+=d),i&&r.push(a)}for(let e=0;e<r.length;e++)r[e].remove();return l}getHTMLOffset(e,t){e.parentNode.childNodes;let s=0,n=0;for(let e=0;e<children.length&&!((s+=child.textContent.length)>=t);e++)child.nodeType==Node.TEXT_NODE?n+=child.textContent.length:child.nodeType==Node.ELEMENT_NODE&&(n+=child.outerHTML.length);return n}prepareToSave(t,o){var e=o.parentNode;let l=this.dom.attr(t,"ud_mime");if(l=l||this.dom.attr(e,"ud_mime"),API.dispatchNameChange(e),"text/json"==l&&2<this.dom.children(e).length)l="text/text";else if("text/json"!=l){var s=o.id,n=this.dom.attr(e,"ud_type"),i=(o=this.newTextObject(s,n),e.childNodes);o=e.insertBefore(o,i[0]);for(let e=1;e<i.length;e++){var a=i[e];"span"==this.dom.attr(a,"exTag")&&a.classList.contains("caption")?t.insertBefore(a,t.childNodes[0]):a!=o&&a!=t&&a.remove()}i[0].id=i[0].id+"object",this.dom.attr(t,"ud_type","text"),l="text/json"}switch(l){case"text/json":{var r=API.json,d=r.parse(o.textContent),u=r.value(d.meta,"name"),c=(o.innerHTML=JSON.stringify(this.dom.udjson.getElement(t,!0)),d=r.parse(o.textContent),r.value(d.meta,"name"));let e=r.value(d.meta,"caption");u!=c&&e&&(e=e.replace(u,c),d.meta.caption=e,o.textContent=JSON.stringify(d),r=this.dom.element("span.caption",c+"editZone"))&&(r.textContent=e);break}case"text/js":case"text/css":case"text/text":case"text/linetext":case"text/server":u=t.getElementsByTagName("table")[0];if(!u)return debug({level:1,return:null},"can't find table in ",editorZoneId);var h=u.getElementsByTagName("tbody")[0].rows;if(!h)return debug({level:1,return:null},"no rows in tbody of ",editorZoneId);let s="",n=!1,i={},a;for(let t=0;t<h.length;t++){let e=h[t].cells[1].textContent;"text/html"==l&&(e=h[t].cells[1].innerHTML),0==t&&0==e.indexOf("JSON")&&(n=!0,a=e.replace("JSON","").trim()),n?i=this.prepareJSONstring(i,e):s+=e+"\n"}if(n){var m=JSON.stringify(i);switch(a){case"parent_extra":var p=o.parentNode;this.dom.attr(p,"ud_extra",m);break;case"content":o.textContent=JSON.stringify(i)}}else o.textContent=s.substring(0,s.length-1)}return!0}prepareJSONstring(e,t){var s,n=t.indexOf("=");return n<=0||(s=t.substr(0,n).trim(),t=t.substr(n+1).trim(),t=JSON.parse(t),1<(n=s.split("/")).length?(void 0===e[n[0]]&&(e[n[0]]={}),2<n.length?(void 0===e[n[0]][n[1]]&&(e[n[0]][n[1]]={}),e[n[0]][n[1]][n[2]]=t):e[n[0]][n[1]]=t):e[s]=t),e}JSONtoText(e,t=""){if(!(e="string"==typeof e&&""!=e?this.dom.udjson.parse(e):e))return"";let s="";for(var n in t||(s+="JSON content\n"),e)if("length"!=n){var i=e[n],a=t+n;switch(typeof i){case"array":case"object":s+=this.JSONtoText(i,a+"/");break;case"number":s+=a+" = "+i+"\n";break;case"string":s+=a+' = "'+i+'"\n';break;default:debug({level:2},"unknown value type in JSON",prefix+n,i)}}return s}}function Zone(e,t){this.stayOpenTime=18e4,this.mobileModeMaxWidth=480,this.getStyle1=function(e,t){e=window.getComputedStyle(this.element1)[e];return"nb"==t?parseInt(e):e},this.getStyle2=function(e,t){e=window.getComputedStyle(this.element2)[e];return"nb"==t?parseInt(e):e},this.element1=document.getElementById(e),this.element2=document.getElementById(t),this.mode="",this.saveContent="",this.params="",0==this.getStyle1("width","nb")&&(this.mode="Reduced"),this.toolZone1=this.element1.childNodes[3],this.toolZone1.setAttribute("onclick","leftColumn.closeIfAnchor(event.target, true);"),this.manageButtons=function(){var e=document.getElementById("leftToolIcon"),t=document.getElementById("rightToolIcon"),s=25<this.element1.textContent.length,n=25<this.element2.textContent.length;!s&&e?e.classList.add("hidden"):s&&e&&e.classList.remove("hidden"),!n&&t?t.classList.add("hidden"):n&&t&&t.classList.remove("hidden")},this.switchDisplayMode=function(e=!1){var t=25<this.element1.textContent.length,s=25<this.element2.textContent.length,n=window.getComputedStyle(this.element1).width,i=window.getComputedStyle(this.element2).width,a=window.scrollY;let o=e?1200:screen.innerWidth;if(o=o||screen.availWidth,console.log("window.scrollY:"+a+", screenWidth:"+o),"0px"==n&&(o>this.mobileModeMaxWidth||"0px"==i)&&t){if(this.element1.style.width=window.getComputedStyle(this.element1)["max-width"],this.element1.style.top=a+"px",a){let t=this;window.addEventListener("scroll",function(e){t.scrollMove(e,t.element1)})}this.element1.querySelector("div.tool-zone").style.display="block",setTimeout(function(){leftColumn.closeAll(!0)},this.stayOpenTime)}else if("0px"!=n&&(o>=this.mobileModeMaxWidth||"0px"==i)&&s){o<this.mobileModeMaxWidth&&(this.element2.style.width=window.getComputedStyle(this.element2)["max-width"],this.element2.querySelector("div.tool-zone").style.display="block",setTimeout(function(){rightColumn.closeAll(!0)},this.stayOpenTime)),this.element1.style.width="0px";this.element1.querySelector("div.tool-zone").style.display="none",API.setAttribute("outlineCurrentElementCSS","");var l,r=document.getElementById("document");for(l in r.childNodes)"object"==typeof r.childNodes[l]&&r.childNodes[l].classList&&r.childNodes[l].classList.remove("StylerTool_outline")}else"0px"!=n&&"0px"==i?(this.element1.style.width="0px",this.element1.querySelector("div.tool-zone").style.display="none"):"0px"==n&&"0px"!=i&&(this.element2.style.width="0px",this.element2.querySelector("div.tool-zone").style.display="none")},this.closeAll=function(e=!1){this.element1.style.width="0px",this.element2.style.width="0px",e&&(this.element1.childNodes[3].innerHTML="",this.element2.childNodes[3].innerHTML="")},this.scrollMove=function(e,t){var s=window.scrollY,n=parseInt(window.getComputedStyle(document.getElementById("content")).height.slice(0,-2)),i=window.getComputedStyle(this.element1).width,a=window.getComputedStyle(this.element2).width;i&&(this.element1.style.top=s+"px",this.element1.style.height=n-s+"px"),i&&(this.element2.style.top=s+"px",this.element2.style.height=n-s+"px"),i||a||window.removeEventListener("scroll",function(e){me.scrollMove(e,t)})},this.closeIfAnchor=function(e,t=!1){"a"==e.tagName.toLowerCase()&&this.closeAll(t)}}"object"==typeof process&&(module.exports={class:UDEtext},void 0===global.JSDOM)&&"undefined"==typeof window&&(console.log("Syntax : OK"),console.log("Start of test program"),console.log("Test completed")),"object"==typeof process&&(module.exports={class:Zone});class UDapiSet1{moduleName="apiset1.js";ud=null;dom=null;udajax=null;ude=null;calc=null;udeTable=null;udeList=null;udeDraw=null;utilities=null;terms=null;constructor(e){"undefined"==typeof API?(this.ud=e,void 0!==this.ud.ude?this.ude=this.ud.ude:this.ude=ud,this.dom=this.ud.dom,this.udajax=this.ud.udajax,this.calc=this.ude.calc,this.udeTable=this.ude.modules["div.table"].instance):e==API&&(this.ud=API.ud,this.dom=API.dom,this.udajax=API.udajax,this.utilities=API.utilities,API.addFunctions(this,["addStyleRules","addToHistory","addTool","back","botlogUpdate","botlog","buildPartEditing","clearTools","initialiseElement","insertElement","insertHTML","insertTable","loadDocument","createDocument","loadModule","loadTool","postForm","reload","reloadView","removeElement","setModel","setStyle","setSystemParameters","getUDparam","setUDparam","env","translateTerm","switchView","configureElement","HTMLeditor","displayDocInPanel","goTo","getView","showMenu","clearMenu","displayTip","addTip","hoverOver","clickOn","addView","setupView","createUser","prepareUserCreation","getOIDbyName","checkAndWriteValue","getRadioValue"]))}addTool(e,t,s,n,i=""){this.dom.findElement(t+"-icon")&&this.dom.findElement(t+"-icon").remove();var a=document.createElement("div"),o=document.createElement("img"),s=(o.src=s,document.createElement("a")),l=document.createTextNode(t),o=(s.appendChild(o),s.appendChild(document.createElement("br")),s.appendChild(l),s.title=t,i&&(s.title=i),s.href="javascript:",""),l=e.replace("-selector","-zone");s.setAttribute("onclick",o+="window.ud.loadTool( this,'"+e+"', '"+n+"','"+l+"');"),a.appendChild(s),a.setAttribute("class","tool-icon"),a.setAttribute("id",t+"-icon"),document.getElementById(e).appendChild(a);let r=t;"tagger"==t.toLowerCase()&&(r="Inserter"),-1<n.indexOf(".js")?this.unitTesting?(i=require("../modules/"+n).class,this.ude.modules["modules/"+n]={},this.ude.modules["modules/"+n].instance=new i(this,l)):this.ude.loadScript("modules/"+n,"window.ud.ude.modules['modules/"+n+"']['instance'] = new "+r+"( window.ud, '"+l+"');"):this.unitTesting||((o=new XMLHttpRequest).element=a,o.ud=this,o.onreadystatechange=function(){var e;4==this.readyState&&200==this.status&&(debug({level:7},e=getOnload(this.responseText)),doOnload(e))},o.open("GET",n+"/e|load/",!0),o.setRequestHeader("Content-type","application/x-www-form-urlencoded"),o.send())}loadTool(e,t,s,n){var i,a=document.getElementById(t);for(i in a.childNodes)console.log(typeof a.childNodes[i]),"object"==typeof a.childNodes[i]&&a.childNodes[i].classList.remove("selected");e.parentNode.classList.add("selected"),document.getElementById(n).innerHTML="",-1<s.indexOf(".js")?(t=this.ude.modules["modules/"+s].instance)&&t.event("open"):(s=s.replace(/{topOID}/g,this.dom.attr(this.topElement,"UD_oid")),this.unitTesting||new UDAJAX(this,"").serverRequest(s+"/e|open/","GET","",{action:"fill zone",zone:n}))}clearTools(e,t){var s=document.getElementById(e).childNodes;for(let e=s.length;0<e;e--)s[e-1].remove();return document.getElementById(t).getElementsByTagName("img")[0].setAttribute("src","/upload/N3u2U2g3W_emptyIcon50.png"),!0}loadDocument(t,e=""){var s=API.dom.element("UD_openNewWindow"),s=!s||"yes"==s.value;if(!s||this.unitTesting||-1<t.indexOf("AJAX_")){let e=t.replace("/show/","/AJAX_show/");-1<e.indexOf("http")&&(n=(n=t.split("/")).splice(3,n.length-3),e=n.join("/"));var n={action:"refresh",element:this.dom.topElement,zone:"document"};this.udajax.serverRequest(e,"GET","",n)}else s&&e?window.open(t,e):document.location=t;return!0}reload(e=!0,t=""){let s=this.ud.service+"/"+this.dom.attr(this.topElement,"ud_oid")+"/"+this.refreshAction+"/";return e?(e={action:"refresh",element:this.topElement},t&&(s+=t+"/"),this.udajax.serverRequest(s,"GET","",e)):location.reload(!0),!0}reloadView(e){var t=this.dom.element(e);return!!t&&(t=this.dom.attr(t,"ud_oid"),this.ud.udajax.updateZone(t+"-21/AJAX_show/",e),!0)}addToHistory(e){this.currentURL=e;var t,s=this.dom.element(this.historyElementId);return!!s&&(-1==(t=s.textContent.split(",")).indexOf(e)&&t.push(e),s.textContent=t.join(","),!0)}back(){var e,t=this.dom.element("UD_history").textContent.split(",");2<t.length&&1<(e=t.indexOf(this.currentURL))?(t=t[e-1],this.loadDocument(t)):this.loadDocument("/webdesk/")}insertElement(e,t,s={},n=null,i=!1,a=!1){let o=null;return o=n?this.dom.insertElement(e,t,s,n,i,a):this.dom.insertElementAtCursor(e,t,s),this.dataSource.viewEvent("create",o),o}removeElement(e){var t,s,n,e=this.dom.element(e);e&&((n=this.dom.getSaveableParent(e))==e?this.ud.viewEvent("delete",e):n&&(t=this.dom.attr(e,"exTag"),-1<["span.styled"].indexOf(t)?(s=e.parentNode.innerHTML,e.parentNode.innerHTML=s.replace(e.outerHTML,e.innerHTML)):e.remove(),this.ud.viewEvent("change",n),"div.part"==t)&&(s=this.dom.attr(e,"name").toLowerCase().replace(/ /g,"_")+"sel",n=this.dom.element(s))&&(n.previousSibling?$$$.clickOn(n.previousSibling):n.nextSibling&&$$$.clickOn(n.nextSibling),n.remove()))}insertText(e,t="plain"){this.ude.insertTextAtCursor(e,t)}prepareHTML(e){}reserveElement(){}fetch(e){return this.htmlContent}insertTable(e,t){return this.ude.insertTableAtCursor(e)}initialiseElement(e){this.ude.initialiseElement(e)}updateTable(e){let t=e;e=this.dom.element(e);return!!e&&("DIV"==e.tagName&&(t=e.getElementsByTagName("table")[0].id),this.ude.updateTable(t))}updateGraphic(e){return this.ude.updateGraphic(e)}insertHTML(e,t){return API.dom.cursor.setAt(t),this.ude.insertHTMLAtCursor(e)}clientSideInterpretor(e){commande}setModel(e){this.ud.setModel(e)}setSystemParameters(e){var t=this.dom.attr(this.topElement,"ud_oid"),s='textra={"system":{'+JSON.stringyfy(e)+"}",t=(s=s+("&input_oid="+t)+("&form="+this.serverFormName),"/"+this.ud.service+"/"+t+"/"+this.refreshAction+"/"),n={element:this.topElement,action:"reload",setCursor:!1,ud:this};return this.udajax.serverRequest(t,"POST",s,n,null),debug({level:5,coverage:10,file:"apiset1.js",return:!0},"Server request system params"+this.serverRequestId,"reload",e)}env(e,t){e="/"+this.ud.service+"/?"+e+"="+t;this.udajax.serverRequest(e,"GET",null,{action:"ignore"})}setStyle(e){this.ude.setStyle(e)}addStyleRules(e){console.log(e),e=e.split("}");var s,n=document.createElement("style");for(s in n.appendChild(document.createTextNode("")),document.head.appendChild(n),e){var i=e[s].indexOf("{");if(-1!=i){i=e[s].substr(0,i-1).replace(/\n/g,"")+"{"+e[s].substr(i+1).replace(/\s/g,"")+"}";n.sheet.insertRule(i)||debug({level:5},"addStyleRules Fail on",i);let t=i.substring(0,i.indexOf("{")-1);-1<t.indexOf(".")&&(t=t.substring(t.indexOf(".")+1));var a=document.getElementById("document").getElementsByClassName(t);for(let e=0;e<a.length;e++){var o=a[e];o.classList.remove(t),o.classList.add(t)}}}}loadModule(e,t,s){return"object"==typeof process?new window[e](this.topElement):new e(t)}postForm(e,t="",s=""){var n=document.forms.loginform;t&&n.setAttribute("action",t),""!=s&&!Confirm(s)||n.submit()}translateTerm(s,e=!0,t=""){if(!s)return"";let n="";if(this.terms||(this.terms=API.json.merge(UD_terms,"UD_terms")),t)e&&(this.terms[s]=t);else if(-1==s.indexOf("{!"))void 0===(n=this.terms[s])&&(e=Object.values(this.terms).indexOf(s))&&(t=Object.keys(this.terms),n=t[e]),void 0===n&&(n=this.terms[s.replace("_","-")]);else{let e=20,t=s.indexOf("{!");for(;-1<t&&e--;){var i=s.indexOf("!}",t);if(!i)break;var a=s.substring(t+2,i),a="string"==typeof this.terms[a]?this.terms[a]:a;s=s.substr(0,t)+a+s.substr(i+2),t=s.indexOf("{!")}}return n=void 0!==n&&n?n:s}buildPartEditing(e){var t=this.dom.element(e);if(!t)return debug({level:2,return:null},"Can't find part editing zone",e);var e=window.udparams.outlineId,s=this.dom.element(e);if(!s)return debug({level:2,return:null},"Can't find outline or outlineId",e);var n=s.getElementsByTagName("li");for(let e=0;e<n.length;e++){var i,a,o=n[e],l=this.dom.attr(o,"target_id"),l=this.dom.element(l);l&&(i=l.id,l=this.dom.attr(l,"ud_oid"),o=o.innerHTML,(a=document.createElement("p")).id=i+"_manage",this.dom.attr(a,"ud_oid",l),this.dom.attr(a,"ud_fields","tcontent"),this.dom.attr(a,"ud_dupdated",""+this.ticks),this.dom.attr(a,"ud_dchanged",""+this.ticks),a.innerHTML=o,t.appendChild(a))}return t}runCommand(e){return this.run(e)}botlogUpdate(t,i,a,o){var l=window.ud.botlog,r=window.ud.ticks;let d=this.dom.element("BVU00000002000000M");if(d=d&&"p"==this.dom.attr(d,"exTag")?d:this.dom.element("BVU00000002200000M")){window.botlogId=d.id;var u=[],c=d.childNodes;for(let e=0;e<c.length;e++)3==c[e].nodeType&&u.push(c[e].textContent.trim());let e=!1,s=!1,n=!1;if("get"!=t)if("set"==t)void 0===l.log[i]?l.log[i]={status:a,details:o,start:r,update:r,error:!1}:(l.log[i].status=a,l.log[i].details=l.log[i].details+"\n"+o,l.log[i].update=r);else{if("busy"==t){let e=!1;for(var h in l.log){var m,p=l.log[h];p.status?(50<p.update-p.start?p.error=!0:p.error=!1,e=!0):(m=$$$.calculate("datestr( '', '', 'YYYY-MM-DD-hh:mm');"),m+=" "+h+" "+(p.error?"KO":"OK")+" in "+(p.update-p.start)/10+" s "+p.details,u.push(m),delete l.log[h],d.innerHTML=u.join("<br>"),$$$.setChanged(d))}return e}if("server"==t||""==t){for(let t=0;t<u.length;t++){var g,f=u[t];if("__OPEN__"==f){l.call&&clearInterval(l.call),l.call=setInterval(function(){API.botlogUpdate("server")},2e3),l.openToServer=!0;let e=d.parentNode;"zone"==this.dom.attr(e,"ud_type")&&(e=e.parentNode),API.showOneOfClass(e.id,!0),u[t]="Ouvert au serveur",s=!0}else"__CLOSE__"==f?(l.call&&clearInterval(l.call),l.call=setInterval(function(){API.botlogUpdate("server")},12e3),l.openToServer=!1,(g=this.dom.attr(this.topElement,"ud_defaultpart"))&&API.showOneOfClass(g,!0),u[t]="Fermé au serveur",e=!0,s=!0):"__RELOAD__"==f&&(n=!0,u[t]="Rechargé",s=!0)}if(s&&(d.innerHTML=u.join("<br>")),n&&API.reload(!1),l.openToServer)this.ud.fetchElement(d);else{for(var v in l.log){var b=l.log[v];b.status||(u.push(b.details),delete l.log[v],d.textContent=u.join("<br>"),e=!0)}e&&this.ud.viewEvent("change",d)}debug({level:5,coverage:41,file:"apiset1.js"},"botlogUpdate action:",t)}}}}botlog(e,t,s){this.botlogUpdate("set",e,t,s)}getUDparam(e){let t=null;if(void 0===window.udparams){var s=this.dom.udjson.parse("UD_system");void 0!==s[e]&&(t=s[e])}else{$$$.buildManagePart();s=this.dom.element(UD_wellKnownElements.UD_docParams);if(s){s=this.dom.udjson.parse(s.textContent);if(!s)return null;s=s.data.value;void 0!==s[e]&&(t=s[e])}}return t||(s=this.dom.udjson.parse("UD_globals"))&&void 0!==s[e]&&(t=s[e]),t}setUDparam(e,t){API.buildManagePart();let s=this.dom.element(UD_wellKnownElements.UD_docParams),n=null,i=null;if(s){var a=this.dom.udjson.parse(s.textContent);if(!a)return null;(i=a.data.value)[e]=t,a.data.value=i,s.textContent=JSON.stringify(a),n=s.parentNode}else{if(!(n=this.dom.element("BVV00000300000000M_params")))return debug({level:3,return:null},"Can't find doc parameters, so can't change them");if(!(s=this.dom.element("div.textObject",n)))return debug({level:3,return:null},"Can't find doc parameters, so can't change them",n);if(!(i=this.dom.udjson.parse(s.textContent)))return null;i[e]=t,s.textContent=JSON.stringify(i)}return this.ude.textEd.inputEvent({event:"update",object:i},n),this.ud.viewEvent("change",n),i}userId(){return this.ud.userId}ownerId(){return this.ud.ownerId}createDocument(e="Nouvelle tâche",t="Description courte",s="",n=""){var i=this.dom.element("system-message-popup"),i=(i&&(i.innerHTML='<div style="text-align:center"><img src="https://www.sd-bee.com/upload/3VUvtUCVi_processing.gif"></div>',i.classList.add("show")),e=API.translateTerm(e,!0),t=API.translateTerm(t,!1),s=API.translateTerm(s,!1),this.dom.attr(this.dom.element("document"),"ud_oid"));let a=i,o=a.split("--")[1].split("-");0!=this.dom.element("UD_mode").textContent.indexOf("model")&&(o=o.slice(0,-2)),n&&(i=this.dom.element(n))&&(n=i.textContent.split("--")[1].split("-"),o=n),a=o.length%2==1?"UniversalDocElement--"+o.join("-")+"-0":"UniversalDocElement--"+o.join("-")+"-21-0";i=this.dom.element("UD_lang").textContent;let l="INPUT_addApage";n="",n=(n=(n=(n+="form="+(l="EN"!=i?API.translateTerm(l):l))+"&input_oid="+a+"&stype=2&tgivenname="+e)+"&tcontent="+t+"&nstyle="+s)+"&textra="+JSON.stringify({system:{state:"new"}}),i="/"+UD_SERVICE+"/"+a+"/AJAX_addDirOrFile/e%7CcreateAndOpen/p1%7Cfile/",e={action:"fill zone",zone:"left-tool-zone",setCursor:!1,ud:this.ud},t=new Promise((e,t)=>{console.log("Promise new doc")});return t.then(e=>{console.log("then APIset1",e),this.createDocument2(e)}),t.catch(e=>{console.error("Can't create doc (catch)")}),e.promise=t,e.resolve=e=>{console.log("then byresolve APIset1",e),this.createDocument2(e)},e.thenDo={postdata:n,uri:i},window.ud.udajax.serverRequest(i,"GET","",e),!1}createDocument2(e){var t=e.thenDo.uri,e=e.thenDo.postdata,s={action:"fill zone",zone:"left-tool-zone",setCursor:!1,ud:this.ud},n=new Promise((e,t)=>{console.log("Promise new doc 2")}),n=(n.then(e=>this.createDocument3(e)),s.promise=n,s.resolve=e=>{console.log("then APIset1",e),this.createDocument3(e)},this.ud.udajax.serverRequest(t,"POST",e,s),e.indexOf("nstyle=")),t=e.indexOf("&",n),s=e.substring(n+7,t),e=$$$.getShortcut("translateTerm");let i='<div style="text-align:center"><img src="https://www.sd-bee.com/upload/3VUvtUCVi_processing.gif"><br>';i+=e("Initialisation de la page"),s&&(i+=" "+e("avec")+" "+s),i+=".</div>",this.topElement.innerHTML=i,window.scrollTo(0,0)}createDocument3(e){var t=this.dom.element("system-message-popup");t&&t.classList.remove("show")}cantCreateDocument(e){var t=this.dom.element("system-message-popup");t&&t.classList.remove("show"),console.error("Can't create doc")}switchView(e,t=""){if(!this.dom.elementByName(e))return!1;var s=t?API.dom.element(t):null;if(s&&s.classList.contains(UD_wellKnownClasses.active))return n=this.dom.element("div.part:not(.hidden)",this.dom.element("document")),API.displayMenu(n);var n=this.dom.element("div.part:not(.hidden)",this.dom.element("document")),n=(n&&this.dom.attr(n,"ud_cursor",this.dom.cursor.save(this.dom.attr(n,"ud_cursor"))),API.showOneOfClass(e));if(s||(s=API.dom.element("UD_lang").textContent,s=API.hasLanguageSuffix(e)?e:e+" "+s,API.showOneOfClass(s)||API.showOneOfClass(e)),!n)return null;this.buildView(e),API.testEditorAttr(n,"ude_edit","on")&&this.dom.cursor.restore(this.dom.attr(n,"ud_cursor"),!0);var s=API.dom.element("document"),i=API.dom.element("scroll"),a=API.dom.element("content"),o=[],l=s.classList;for(let e=0;e<l.length;e++){var r=l.item(e);-1==r.indexOf(UD_viewPrefix)&&-1==r.indexOf(UD_themePrefix)&&o.push(r)}var d=n.className.split(" ");for(let e=0;e<d.length;e++){var u=d[e];0!=u.indexOf(UD_layoutPrefix)&&0!=u.indexOf(UD_themePrefix)||o.push(UD_viewPrefix+u)}var c=o.join(" "),s=(s.className=c,i.className=c,a.className=c,t=t||e.toLowerCase().replace(/ /g,"_")+"sel",API.activateOneOfClass(t),API.hideMenu(),$$$.dom.element("system-message-popup")),i=(s&&s.classList.remove("magneto"),this.dom.attr(n,"computed_transform"));i&&i.indexOf("scale(")?API.dom.transformScale=.8:API.dom.transformScale=1,API.dom.arrangeTables(n),API.paginate(n),"function"==typeof global["view_load_"+e]&&global["view_load_"+e]()}buildView(e){"manage"==e.toLowerCase()?$$$.buildManagePart():$$$.isFunction("build_"+e+"_view")?$$$["build_"+e+"_view"]():$$$.isFunction("build_view")&&$$$.build_view(e)}configureElement(e){let t=this.dom.element(e);t=t||this.dom.element("[name='"+e+"']","document");e=this.dom.getSaveableParent(t);if(!e)return debug({level:7,return:!1},"apiset1.configureElement() can't find ",name);this.ude.dispatchEvent({event:"configure",action:"enter"},e)||(s=this.dom.attr(e,"name"))&&this.dom.element(s+"editZone")&&this.dom.element(s+"_parameters_editZone")&&API.showNextInList([s+"editZone",s+"_parameters_editZone"]);var s=API.insertables(e);s&&function(e,t){for(var s in e)if(t==e[s])return s}(s,this.dom.attr(t,"exTag"))?API.displayConfig(t):API.displayConfig(e)}HTMLeditor(s,n=!1){var i=this.dom.element(s);if(!i)return debug({level:4,return:!1},"Can't find element",s);s=this.dom.attr(i,"name").replace(/ /g,"_");if(this.dom.element(s+"editZone"))API.showNextInList([s+"editZone",s+"viewZone"]);else if(n){s=this.dom.element(i.id+"editZone"),n=s.getElementsByTagName("table")[0];if(!n)return debug({level:1,return:null},"can't find table in ",editorZoneId);var a=n.getElementsByTagName("tbody")[0].rows;if(!a)return debug({level:1,return:null},"no rows in tbody of ",editorZoneId);let t="";for(let e=0;e<a.length;e++){var o=a[e].cells[1].innerHTML;t+=o}n=document.createElement("textarea"),n=(n.innerHTML=t,n.textContent);s.remove(),i.innerHTML=n,i.classList.remove("hidden"),this.ud.viewEvent("change",i)}else if(this.dom.element(i.id+"editZone"))this.dom.element(i.id+"editZone").remove(),i.classList.remove("hidden");else{s=i.innerHTML,n=document.createElement("textarea");n.textContent=s;let e=n.innerHTML.split("&lt;").join("\n&lt;");"\n"==e[0]&&(e=e.substring(1));var s=document.createElement("div"),n=(this.dom.attr(s,"id",i.id+"editZone"),this.dom.attr(s,"class","linetext"),this.dom.attr(s,"ude_autosave","off"),this.dom.attr(s,"ude_bind",i.id),this.dom.attr(s,"ud_type","linetext"),this.dom.attr(s,"ud_subtype","text"),"API.HTMLeditor( '"+i.id+"', true);"),n=this.ude.textEd.convertTextToHTMLtable(e,i.id,"",n),n=(s.appendChild(n),i.nextSibling),t=i.parentNode;n?t.insertBefore(s,n):t.appendChild(s),i.classList.add("hidden")}}keepOneLanguage(e){var t=this.dom.element("[name='"+name+"']","document");if(!t)return debug({level:7,return:!1},"apiset1.configureElement() can't find ",name);this.ude.dispatchEvent({event:"configure"},t)||API.showNextInList([name+"editZone",name+"_parameters_editZone"])}displayDocInPanel(e,t="",s=""){var n,i=this.dom.element(e+"Column"),a=this.dom.element(e+"-tool-selector"),e=this.dom.element(e+"-tool-zone");return e&&t?(a&&(a.style.display="none"),API.dom.emptyElement(e),n={onclick:"API.displayDocInPanel( 'right');"},API.dom.insertElement("div","Close",n,e,!1,!0),n={id:s,src:"/webdesk/"+t+"/show/?mode=frame",class:"docDisplay",sandbox:"allow-top-navigation allow-scripts allow-same-origin",style:"width:100%; height:750px;"},API.dom.insertElement("iframe","",n,e,!1,!0),i.style.width="380px",!0):(e&&(API.dom.emptyElement(e),a)&&(a.style.display="block"),!1)}goTo(e,t=null,s="middle"){let n="string"==typeof t?this.dom.element('[name="'+t+'"]',"document"):t,i=(n=n||this.dom.element("div.part:not(.hidden)",this.dom.element("document")),this.dom.element(e));return(i=i||(0==e.indexOf("Page ")&&n&&"div.part"==API.dom.attr(n,"exTag")?(t=parseInt(e.substr(5)),API.dom.childElements(n)[t-1].childNodes[0]):API.dom.element('[name="'+e+'"]',n)))?(n&&(t=this.dom.element("div.part:not(.hidden)",this.dom.element("document")))&&t!=n&&this.switchView(this.dom.attr(n,"name")),this.dom.cursor.setAt(i),this.dom.makeVisible(i,"scroll",s),!0):debug({level:5,return:!1},"Can't find element to goTo",e)}getView(e){let t=10;let s=this.dom.element(e);for(;s&&"document"!=s.id&&!s.classList.contains("part")&&--t;)s=s.parentNode;return s.classList.contains("part")?s:null}showMenu(e){e=API.dom.element('[Name="'+e+'"]',"document");e&&API.displayMenu(e)}clearMenu(){API.hideMenu()}hoverOver(e){var t,e=API.dom.element(e);e&&(t=new MouseEvent("mouseover",{view:window,bubbles:!0,cancelable:!0}),e.dispatchEvent(t))}clickOn(e=""){var t,e=e?this.dom.element(e):this.dom.cursor.fetch().HTMLelement;e&&(t=new MouseEvent("click",{view:window,bubbles:!0,cancelable:!0}),e.dispatchEvent(t))}displayTip(e,t={x:100,y:100,from:"bottomLeft"},s=20,n=[]){if("undefined"!=typeof TIPS_manager)return TIPS_manager(e,t,1e3*s,n)}addTip(e,t){var s=API.dom.element("tips");let n=API.dom.element(e);return n?n.innerHTML=t:s&&(n=API.dom.insertElement("div","<p>"+t+"</p>",{id:e,class:"tip hidden"},s,!1,!0)),n}addView(){var t=API.defaultContent("div.part","_unconfigured"),s="_NEW_VIEW_ID",e={id:s,name:"_NEW_VIEW_NAME",class:"part unconfigured",ud_type:"part",ude_edit:"on"};let n=this.dom.element(s);if(!n){n=API.dom.insertElement("div","",e,this.dom.element("document"),!1,!0);var i,a=API.dom.insertElement("div","",{class:"page",ud_type:"page"},n,!1,!0),o=API.json.parse("UD_system");if(o&&void 0!==o.showHidden){var l=[{tag:"h2",value:"Voir les vues cachées"}];for(let e=0;e<o.showHidden.length;e++){var r=o.showHidden[e];l.push({tag:"span",class:"button",onclick:"API.switchView('"+r+"');",value:r})}e=API.json.putElement({tag:"div",value:l});a.appendChild(e)}for(i in t){var d=t[i];let e=d.value;""==e&&""!=d.placeholder&&(e=API.translateTerm(d.placeholder),d.placeholder=e),"="==e[0]&&(e=this.calc.exec(API.translateTerm(e.substring(1),!1))),d.value=e,d.name=s+i;d=API.json.putElement(d);this.dom.attr(d,"ud_oid","__NONE__"),a.appendChild(d)}}return this.switchView("_NEW_VIEW_NAME","newView"),n}setupView(t="_NEW_VIEW_ID"){var e=API.dom.element(t);let s=e.childNodes[0];var n=(s="page"!=API.dom.attr(s,"ud_type")?e:s).childNodes;let i="";let a="doc",o="standard",l="";for(let e=0;e<n.length;e++){var r=n[e],d=r.textContent;switch(r.id.replace(t,"")){case"name":i=d.replace(/ /g,"-");break;case"describe":0;break;case"type":var u=this.dom.element(t+"type"),u=this.dom.element("select",u);a=u.value;break;case"layout":var u=this.dom.element(t+"layout"),c=this.dom.element("select",u);o=c.value;break;case"className":l=" "+d}}for(let e=n.length-1;0<=e;e--)n[e].remove();e.className="part "+a.replace(/ /g,"_")+" LAY_"+o.replace(/ /g,"_")+" "+l;var h=API.getTagOrStyleInfo("div.part."+a,"nextId"),h=(API.json.valueByPath(UD_exTagAndClassInfo,"div.part."+a+"/nextId",(parseInt(h,32)+1).toString(32)),e.id=("B"+("00"+h).slice(-2)+"0000000000"+("00000"+this.ud.userId).slice(-5)).toUpperCase(),API.dom.attr(e,"name",i),API.dom.attr(e,"ud_subtype",a),this.ud.viewEvent("createView",e),API.onTrigger(e,"update",API.checkContent),this.dom.element("view-selector")),e=i.toLowerCase().replace(/ /g,"_")+"sel",m="API.switchView( '"+i+"', '"+e+"');";API.dom.insertElement("span",i,{id:e,class:"tab left active",onclick:m,title:i},h,!0,!0)}createUser(e="",t="",s="client",n="UserId",i=""){if(!e){var a=this.dom.elementByName("UserName");if((e=a?a.textContent:"")==this.dom.attr(a,"ude_place")&&(e=""),!a||!e)return API.pageBanner("temp",API.translateTerm("A name is required")),debug({level:1,return:!1},"Can't find UserName")}if(!t){a=this.dom.elementByName("UserEmail");let e=a?a.textContent:"";if(e==this.dom.attr(a,"ude_place")&&(e=""),!a||!e)return API.pageBanner("temp",API.translateTerm("A valid email is required")),debug({level:1,return:!1},"Can't find valid UserEmail")}if(!this.dom.elementByName(n))return API.pageBanner("temp",API.translateTerm("An element to write response is required")),debug({level:1,return:!1},"Can't find id element");var o,a="/webdesk/"+i+"/AJAX_userManager/e|create/out|json/",i={userModel:s},l={form:"INPUT_createUser",input_oid:"Links_User--2-0",nname:e,tpasswd:"",tdomain:"localhost_webdesk",stype:LINKSUSER_login,nemail:t,tparams:JSON.stringify(i)};let r="";for(o in l)r+=o+"="+l[o]+"&";r=r.substring(0,r.length-1);this.ud.udajax.serverRequest(a,"POST",r,{dataTarget:n,dataSource:"id"},this.createUserResponse)}createUserResponse(t,e,s){var n=window.ud.api,i=n.dom.udjson.parse(e);if(i&&i.success){let e="";i.success?e+='<span class="success">'+i.message+"</span>":e+='<span class="error">'+i.message+"</span>";i=i.data;if(!i)return!1;var a=n.dom.elementByName(t.dataTarget),i=n.json.value(i,t.dataSource);a&&i&&(a.textContent==n.dom.attr(a,"ude_place")?a.textContent=i:a.textContent+=","+i,n.ude.setChanged(a))}else n.pageBanner("temp",e)}prepareUserCreation(){this.ud.udajax.serverRequest("/webdesk//AJAX_userManager/e|arm/out|json/","GET",null,{action:"ignore"})}getOIDbyName(e){e=this.dom.elementByName(e),e=this.dom.getSaveableParent(e);return this.dom.attr(e,"ud_oid")}checkAndWriteValue(e,t,s,n="",i=""){var s=s.replace(/this/g,t);return!s||this.calc.eval(s)?((s=this.dom.domvalue.value(e+"._element")).textContent=t,API.setChanged(s),n&&("function"==typeof window[n]?window:$$$)[n](),!0):(i?$$$[i]():(e="Error: ",e+=API.translateTerm("Unacceptable value"),API.pageBanner("temp",e)),!1)}getRadioValue(e){e=this.dom.element(e);if(e){var t,e=this.dom.getSaveableParent(e);for(t of this.dom.elements("input[type='radio']",e))if(t.checked)return t.value}return""}}"object"==typeof process&&(module.exports={class:UDapiSet1},void 0===global.JSDOM)&&"undefined"==typeof window&&"undefined"==typeof ModuleUnderTest&&(ModuleUnderTest="apiset1.js",console.log("Syntax OK"),console.log("apiset1.js Test completed"));class UDapiSet2{moduleName="apiSet2";ud=null;dom=null;udajax=null;ude=null;calc=null;udeTable=null;udeList=null;udeDraw=null;utilities=null;openMenu=null;menuOffsets=[{top:0,left:0},{top:15,left:-35},{top:0,left:10}];appEventHandlers={};constructor(e){"undefined"==typeof API?(this.ud=e,void 0!==this.ud.ude?this.ude=this.ud.ude:this.ude=ud,this.dom=this.ud.dom,this.udajax=this.ud.udajax,this.calc=this.ude.calc,this.udeTable=this.ude.modules["div.table"].instance):e==API&&(this.ud=API.ud,this.dom=API.dom,this.udajax=API.udajax,this.utilities=API.utilities,API.addFunctions(this,["addMenuOption","toggleMenu","showBotlog","getKeywords","updateZone","deleteDoc","appEvent","listenAppEvent","getLang","replaceBannerWithMenu","setLogoLink","toggleDisplay","contactFromTable","hide"]))}addMenuOption(e,t,s,n){var i=this.dom.element("mainMenu");if(!i)return!1;this.dom.attr(i,"computed_display");i.classList.contains("hidden")&&(this.dom.element("banner").style.display="none",i.classList.remove("hidden"));var a=this.dom.element(e+"Menu");if(!a)return!1;let o=1,l=a,r=5;for(;l!=i&&r--;)l=l.parentNode,o++;let d="";if("main"==e){var u=this.dom.elements("div.menuOption",i);if(3<=u.length){var c=u.length+2;d=Math.floor((97.6-c)/c)+"%";for(let e=0;e<u.length;e++)u[e].style.width=d}var c=this.dom.element("main"),h={id:t+"Menu",class:"hidden optionLevel"+o+" "+t+"Option"};this.dom.insertElement("div","",h,c,!0,!0)}else{h=this.dom.element("main"+e);h&&h.classList.add("hasSubMenu")}c="NEVERmain"==e?{class:"menuOption",onmouseenter:n,onmouseout:n}:{id:e+t,class:"menuOption",onclick:n},d&&(c.style="width:"+d+";"),h=API.translateTerm(s);return this.dom.insertElement("div",h,c,a,!0,!0),!0}toggleMenu(e,s=null){e=this.dom.element(e+"Menu");if(!e)return!1;if(e.classList.contains("hidden")){this.openMenu&&this.toggleMenu(this.openMenu.id.replace("Menu",""));let t=-1;e.className.split(" ").forEach(e=>{0==e.indexOf("optionLevel")&&(t=parseInt(e.replace("optionLevel","")))}),console.log("toggle",s.offsetTop,s.offsetLeft),e.style.top=s.offsetTop+this.menuOffsets[t].top+"px",e.style.left=s.offsetLeft+this.menuOffsets[t].left+"px",e.style.width=s.clientWidth,e.classList.remove("hidden"),e.parentNode.classList.add("menuOpen"),this.openMenu=e}else e.parentNode.classList.remove("menuOpen"),e.classList.add("hidden"),this.openMenu=null}showBotlog(t="system-message-popup"){var e=this.dom.element(t),s=this.dom.element(UD_wellKnownElements.botlog);if(!e||!s)return!1;e.innerHTML==s.innerHTML?e.innerHTML="":(e.innerHTML=s.innerHTML,s=this.dom.elements("br",e).length,e.scrollTop=20*(s-6),e.classList.add("botlogDisplay"),setTimeout(function(){var e=API.dom.element(t);e.classList.remove("botlogDisplay"),e.style.top="50%"}.bind(null,t),5e4))}_getWords(t){var s=[];let n="",i=!1;t=t.normalize("NFD").replace(/[\u0300-\u036f]/g,"");for(let e=0;e<t.length;e++){var a=t[e],o=a.toUpperCase()==a;-1<" .,;?!-_".indexOf(a)?(n&&s.push(n),n=""):o&&!i?(n&&s.push(n),n=""+a):n+=""+a,i=o}return n&&s.push(n),s}_isSignificant(e){var t=API.dom.element("UD_lang").textContent;return!(!e.trim()||-1<UD_insignificantWords[t].indexOf(e))}getKeywords(e){var t=[],s=this._getWords(e);for(let e=0;e<s.length;e++){var n=s[e],n=window.ud.ude.calc.removeAccentsAndLower(n);this._isSignificant(n)&&t.push(n.toLowerCase())}return t}updateZone(e,t){return this.ud.udajax.updateZone(e,t)}deleteDoc(e=""){if("webdesk"!=UD_SERVICE){e=e||this.dom.attr("document","ud_oid"),console.log("Deleting "+e);var t="",s=(t=t+"form=INPUT_deleteDoc"+("&input_oid="+e),this.dom.attr("document","ud_oid"));s==e?(n="/"+UD_SERVICE+"/",console.log("Deleting "+e+" with "+n),this.ud.udajax.serverRequest(n,"POST",t,{action:"ignore",zone:"",setCursor:!1})):(n="/"+UD_SERVICE+"/"+s+"/AJAX_listContainers/",console.log("Deleting "+e+" with "+n),this.ud.udajax.serverRequest(n,"POST",t,{action:"fill zone",zone:"BE00000000000000M_dirListing",setCursor:!1}))}else{if(!e){s=$$$.dom.textContent("UD_mode");if(-1==["edit2","edit3"].indexOf(s))return;e=this.dom.attr("document","ud_oid")}var n=e.split("--")[1].split("-"),t="UniversalDocElement--"+n.join("-")+"--SP|"+(Math.round(n.length/2)-1),s="/webdesk/"+this.dom.attr("document","ud_oidchildren")+"/AJAX_modelShow/",e=API.translateTerm("Are you sure ?");confirm(e)&&(n={zone:"none",element:null,action:"ignore",setCursor:!1,ud:this.dataSource},this.ud.udajax.serverRequestPromise(s,"POST","form=INPUT_UDE_FETCH&input_oid="+t+"&iaccess=0&tlabel=owns",n).then(()=>{var e="/webdesk/"+this.dom.attr("document","ud_oid")+"-21/AJAX_modelShow/",t={zone:this.dom.elementByName("Dir listing").id,element:null,action:"fill zone",setCursor:!1,ud:this.dataSource};this.ud.udajax.serverRequest(e,"GET","",t)}))}}appEvent(e,t={}){e=this.appEventHandlers[e];e&&e(t)}listenAppEvent(e,t){this.appEventHandlers[e]=t}getLang(e){e=this.dom.element(e);let t=this.dom.attr(e,"ud_lang");return t=(t=t||this.dom.parentAttr(e,"ud_lang"))||this.dom.textContent("UD_lang")}replaceBannerWithMenu(e){var e=this.buildMenuHTML(e),t=this.dom.element("menu");t.innerHTML=e,t.classList.remove("hidden");this.dom.element("banner").style.display="none";e=document.createElement("link");e.type="text/css",e.rel="stylesheet",e.href="/upload/smartdoc/css/menu.css",document.getElementsByTagName("head")[0].appendChild(e)}buildMenuHTML(e,t="MainMenu",s="mainMenu"){let n="";for(var i in e){var a,o=e[i];if("string"==typeof o){n+='<span class="'+s+'">';let e="mobileMenu();";"MainMenu"!=t&&(e+="$$$.toggleDisplay( '"+t+"');"),e+=o,n=(n+='  <a href="javascript:" onclick="'+e+'" title="'+i+'">')+i+"</a></span>"}else"object"==typeof o&&(a="menu-"+i.replace(/ /g,"-"),n=(n+='<span class="'+s+' hasSubMenu" onclick="$$$.toggleDisplay(\''+a+"', this);\">")+i+"</span>",i=(i='  <div id="'+a+'" class="subMenu hidden">')+this.buildMenuHTML(o,a,"menu-level-2")+"  </div>",n+=i)}var l=this.dom.element("mobileMenu");return l&&(l.innerHTML=n.replace(/menu-/g,"mobilemenu-")),n}setLogoLink(e,t=""){var s=this.dom.element("logo"),s=this.dom.element("a",s);return!!s&&(this.dom.attr(s,"onclick",e),this.dom.attr(s,"title",t),!0)}toggleDisplay(e,t=null){e=this.dom.element(e);t&&(e.style.left=t.offsetLeft+10+"px",e.style.top=t.offsetTop+20+"px"),e.classList.contains("hidden")?$$$.showOneOfClass(e):e.classList.add("hidden")}contactFromTable(t){var s=$$$.findRows(t,".*"),n={name:"",email:"",account:"",developper:"",clients:""};$$$.translateTerm;let i="Contact from<br>";for(let e=0;e<s.length;e++){var a=$$$.getRow(t,s[e]);i+=a.question+": "+a.Value+"<br>",-1<a.question.indexOf("name")&&(n.name+=a.Value+" "),-1<a.question.indexOf("email")&&(n.email=a.Value)}var e={provider:"default",action:"contact",contact:n,body:i};$$$.service("contact",e)}hide(e){e=this.dom.elementByName(e);e&&e.classList.add("hidden")}}"object"==typeof process&&(module.exports={class:UDapiSet2},void 0===global.JSDOM)&&"undefined"==typeof window&&(console.log("Syntax OK"),console.log("Test completed"));class UDapiSet3{moduleName="apiset3.js";ud=null;dom=null;constructor(e=null){"undefined"==typeof API?(this.ud=e,void 0!==this.ud.ude?this.ude=this.ud.ude:this.ude=ud,this.dom=this.ud.dom,this.udajax=this.ud.udajax,this.calc=this.ude.calc,this.udeTable=this.ude.modules["div.table"].instance):e==API&&(this.ud=API.ud,this.dom=API.dom,this.udajax=API.udajax,this.utilities=API.utilities,API.addFunctions(this,["getProgressSVG"]))}getProgressSVG(e,t,s,n){var i=Object.keys(t).length;let a="green";var o=[[30,0],[60,15],[60,45],[30,60],[0,45],[0,15]],l="http://www.w3.org/2000/svg",r=Math.round(60),d=Math.round(60),u=(n-i*r-20)/(i-1);let c=10;var h,m="rgba( 120, 120, 120, 1)",p=document.createElementNS(l,"svg"),n=(p.setAttribute("fill","none"),p.setAttribute("viewBox","0 0 "+n+" "+(d+20)),p.setAttribute("stroke","black"),p.setAttribute("width",n),p.setAttribute("height",d+20),document.createElementNS(l,"marker")),g=(n.id="triangle-"+e,n.setAttribute("viewBox","0 0 10 10"),n.setAttribute("refX","0"),n.setAttribute("refY","5"),n.setAttribute("markerWidth","4"),n.setAttribute("markerHeight","3"),n.setAttribute("orient","auto"),n.setAttribute("stroke",m),n.setAttribute("fill",m),document.createElement("path"));g.setAttribute("d","M 0 0 L 10 5 L 0 10 z"),g.setAttribute("fill","context-stroke"),n.appendChild(g),p.appendChild(n);let f=1;for(h in t){var v=t[h],b=document.createElementNS(l,"polygon");b.setAttribute("width",r),b.setAttribute("height",d);for(let e=0;e<o.length;e++){var x=p.createSVGPoint();x.x=Math.round(+o[e][0])+c,x.y=Math.round(+o[e][1])+20,b.points.appendItem(x)}a=s>=v["progress-end"]?"rgba( 0,250,0,1)":s<v["progress-start"]?"rgba( 220,220,220,1)":"rgba( 240,240,100,1)",b.setAttribute("fill",a),b.setAttribute("stroke",a),p.appendChild(b);var y=document.createElementNS("http://www.w3.org/2000/svg","text");y.setAttribute("x",c+8*r/20),y.setAttribute("y",20+12*d/20),y.setAttribute("width",20),y.setAttribute("height",20),y.setAttribute("font-family","Arial"),y.setAttribute("font-size","20"),y.setAttribute("fill",m),y.setAttribute("stroke",m),y.setAttribute("stroke-width",.25),y.appendChild(document.createTextNode(f)),p.appendChild(y),f!=e&&((y=document.createElementNS("http://www.w3.org/2000/svg","text")).setAttribute("x",Math.round(c+r/2-4.5*v.label.length)),y.setAttribute("y",18),y.setAttribute("width",2*r),y.setAttribute("height",20),y.setAttribute("font-family","Arial"),y.setAttribute("font-size","18"),y.setAttribute("fill",m),y.setAttribute("stroke",m),y.setAttribute("stroke-width",.25),y.setAttribute("spellcheck","false"),y.appendChild(document.createTextNode(v.label)),p.appendChild(y)),f<i&&(v=document.createElementNS(l,"line"),y=Math.round(d/2)+20,v.setAttribute("x1",c+r),v.setAttribute("y1",y),v.setAttribute("x2",c+r+u-10),v.setAttribute("y2",y),v.setAttribute("stroke","rgba( 160, 160, 160, 1)"),v.setAttribute("fill","rgba( 160, 160, 160, 1)"),v.setAttribute("stroke-width",3),v.setAttribute("marker-end","url(#triangle-"+e+")"),p.appendChild(v)),c+=r+u,f++}return p.innerHTML=p.innerHTML,p}}class UDapitest{ud=null;dom=null;udajax=null;ude=null;calc=null;udeTable=null;udeList=null;udeDraw=null;utilities=null;constructor(e){(this.ud=e)&&(void 0!==e.ude?this.ude=e.ude:this.ude=e,this.dom=e.dom,this.udajax=e.udajax,this.calc=this.ude.calc,this.udeTable=this.ude.modules["div#table"].instance),window.API=this,"object"==typeof process&&(global.API=this)}}"object"==typeof process&&(module.exports={class:UDapi},void 0===global.JSDOM)&&"undefined"==typeof window&&(console.log("Syntax OK"),console.log("End of auto-test program"));class UDapi{delimiters=" \n\t=+-*/;,&()'\"{}[]:";keepDelimiters="=+-*/;,&()'";fctMap={};detectErrors=!1;availableModules=null;loadable=null;argsLoadable={};calc_cmds=["redoDependencies","toggleSwitch"];ud_cmds=["setModel","copyModel","makeDirectory","translateTerm","onTrigger","docParameter","reload","fetchElement"];clipboard_cmds=["clipElement"];local_cmds=["insertRow","showOneOfClass","setChanged","loadStyle","copyPortion","grabPortionList","pageBanner","grabFromTable","loadModule","service","calculate","addCalculatorFunction","showNextInList","showFirstInList","LED","env","switchHighlight","setupUDElinks","listAPI","getShortcut","raiseErrors","ignoreErrors","poll","isFunction"];afterClick={Styler:"leftColumn.closeAll();"};ud=null;dom=null;udjson=null;udajax=null;ude=null;calc=null;utilities=null;buffer=null;expr;order;litteral;initial_state=1;litteral_state=2;argument_state=3;argumentFct_state=4;valueSet_state=5;state=0;stateStack=[];bannerStack=[];bannerZone="";bannerTimeoutId=-1;valueSetFctLevel=0;clipboardFctsAdded=!1;utilityFctsAdded=!1;unknownCalls=[];constructor(e){(this.ud=e)&&(void 0!==e.ude&&e.ude?(this.ude=e.ude,this.calc=this.ude.calc):this.ude=e,this.dom=e.dom,this.udjson=e.dom.udjson,this.cursor=e.dom.cursor,this.udajax=e.udajax,e.apiBuffer_requests)&&(this.buffer=this.dom.element(e.apiBuffer_requests)),this.addFunctions(this,this.local_cmds),this.addFunctions(this.ud,this.ud_cmds),this.bannerZone=document.getElementById("bannerMessage"),window.API=this,"object"==typeof process&&(API=this),this.dom&&this.dom.udjson&&(API.json=this.dom.udjson),this.set1=new UDapiSet1(this),void 0!==UDapiSet2&&(this.set2=new UDapiSet2(this)),void 0!==UDapiSet3&&(this.set3=new UDapiSet3(this)),"function"==typeof UD_ressources_init&&UD_ressources_init(this.ud,this),"function"==typeof UD_content_init&&UD_content_init(this.ud),"function"==typeof UDutilities_init&&(this.utilities=UDutilities_init(this.ud,this)),"undefined"==typeof process&&setTimeout(function(){API.botlogUpdate("server")},300),void 0!==window.udjson&&(API.udjson=window.udjson)}setupUDElinks(e){API.ude=e,API.calc=e.calc,this.set1.ude=e,this.set1.calc=e.calc}addFunctions(t,s){for(let e=0;e<s.length;e++){var n=s[e];this.fctMap[n]=t}}poll(e=0){for(var t,s,n,i,a="";t=this.getNextRequest();)debug({level:2},"API request",t),t.indexOf(";")?(s=(t=t.split("|"))[0],n=t[1].replace(/@8/g,":").replace(/@1/g,"@"),i=t[2],a+=this.run([n]),i&&isNaN(i)&&(document.getElementById(i).textContent+=s+":"+a+"\n"),this.processAfterClick(s)):t.indexOf(".");return a}getNextRequest(){var e,t,s;return this.buffer&&0<=(e=(s=this.buffer.textContent).indexOf("\n"))?(t=s.substr(0,e),s=s.substr(e+1),this.buffer.textContent=s,t):""}run(commands){var r="",cmdi;for(cmdi in commands){var command=commands[cmdi];return(this.order="",this.state=this.initial_state,this.prepareForExec(command),-1<this.order.indexOf("ERR:"))?"ERR":(r+=eval(this.order),debug({level:4},"Ran ",this.order),r)}}eval(e){return!(""==e||!isNaN(e)||"'"==this.expr.charAt(0)&&"'"==this.expr.charAt(this.expr.length-1)||'"'==this.expr.charAt(0)&&'"'==this.expr.charAt(this.expr.length-1))&&(e=this.calc.exec(this.expr),isNaN(e))?'"'+e+'"':e}addTokenToOrder(e,t){return this.state==this.litteral_state?(this.expr+=e+t,t==this.litteral&&(this.state=this.stateStack.pop())):this.state==this.argument_state?"("==t?(this.expr+=e+t,this.stateStack.push(this.state),this.state=this.argumentFct_state):")"==t?(this.expr+=""+e,this.order+=this.eval(this.expr)+t,this.expr="",this.state=this.stateStack.pop()):","==t?(this.expr+=""+e,this.order+=this.eval(this.expr)+t,this.expr=""):"{"==t?(this.state!=this.valueSet_state&&(this.order+="JSON.parse('{"),this.stateStack.push(this.state),this.state=this.valueSet_state,this.expr=""):"'"==t||'"'==t?(this.stateStack.push(this.state),this.state=this.litteral_state,this.litteral=t,this.expr=t):this.expr+=""+e+t:this.state==this.initial_state?"("==t?(this.order+="API."+e+t,this.stateStack.push(this.state),this.state=this.argument_state,this.expr=""):this.order+=t:(this.state=this.valueSet_state)?"}"==t?(this.expr+=e,this.order+=this.eval(this.expr)+t,this.state=this.stateStack.pop(),this.state!=this.valueSet_state&&(this.order+="')"),this.expr=""):":"==t?this.order+='"'+e+'"'+t:"("==t?(this.valueSetFctLevel++,this.expr+=e+t):")"==t?(this.expr+=""+e+t,0==--this.valueSetFctLevel&&(this.order+=this.eval(this.expr),this.expr="")):","==t?(this.expr+=""+e,0==this.valueSetFctLevel?(this.order+=this.eval(this.expr)+t,this.expr=""):this.expr+=t):this.expr+=e+t:this.state==this.argumentFct_state&&(this.expr+=""+e+t,"("==t?this.stateStack.push(this.state):")"==t&&(this.state=this.stateStack.pop())),""}prepareForExec(e){var t=this.expr=this.order="";this.state=this.initial_state;for(var s=this.valueSetFctLevel=0;s<e.length;s++){var n=e[s];-1<this.delimiters.indexOf(n)?t=this.addTokenToOrder(t,n):t+=n}return t&&this.addTokenToOrder(t,null),this.stateStack.length&&debug({level:1},"Order incomplete"+e),!0}nlp(e){}processAfterClick(source){void 0!==this.afterClick[source]&&eval(this.afterClick[source])}insertRow(e,t,s,n=!0){var i=document.getElementById(e);return i?this.ude.tableEd?(t=this.ude.tableEd.insertRow(e,t,s,n),this.ude.tableEd.update(e,!0),this.ude.setChanged(i),API.redoDependencies(),t):debug({level:2,return:null},"No table editor",e):debug({level:2,return:null},"No table",e)}showOneOfClass(e,t){return this.showOnePortion(e,t)}showOnePortion(e,t){let s=this.dom.element(e);if(!(s=s||this.dom.element("div.part[name='"+e+"']",this.dom.element("document"))))return debug({level:2,return:null},"can't find element in UDAPI.showOneOfClass()",e);var n=s.id;if("div"==s.tagName.toLowerCase()){s.classList.remove("hidden");for(var i=$$$.dom.elements("div."+s.classList.item(0),s.parentNode),a=0;a<i.length;a++){var o=i[a];o.id==n||o.classList.contains("hidden")||o.classList.add("hidden")}s.classList.contains("part")&&this.ude.followScroll(0)}else if(-1<["h1","h2","h3","h4"].indexOf(s.tagName.toLowerCase()))for(var l=s.tagName.toLowerCase(),r=["h1","h2","h3","h4"].indexOf(s.tagName.toLowerCase()),d="ignore",u=this.dom.children(s.parentNode),c=0;c<u.length;c++){var h=u[c];if(h.tagName.toLowerCase()==l)d=h==s?"expand":"collapse";else if(["h1","h2","h3","h4"].indexOf(s.tagName.toLowerCase())<r)d="ignore";else switch(d){case"ignore":break;case"collapse":h.classList.add("hidden");break;case"expand":h.classList.contains("hidden")?h.classList.remove("hidden"):h.classList.add("hidden")}}e=document.getElementById("scroll");return e&&s.classList.contains("part")&&(e.scrollTop=0,window.scroll(0,0)),s}activateOneOfClass(e,t=0){var s=this.dom.element(e);if(!s)return debug({level:2,return:null},"can't find element in UDapi;activateOneOfClass()",e);var n=s.classList;let i="";for(let e=0;e<n.length;e++)-1==["left","right","active"].indexOf(n.item(e))&&(i=n[e]);if(i){var e=s.parentNode,a=this.dom.elements("."+i,e);for(let e=0;e<a.length;e++){var o=a[e];o==s?o.classList.add("active"):o.classList.remove("active")}}}setChanged(e){let t=this.dom.element(e);return t||(t=API.dom.element("[name='"+e+"']","document"))&&API.dom.attr(t,"ud_oid")?this.ude.setChanged(t,1):debug({level:2,return:null},"can't find saveable element in UDapi.setChanged()",e)}loadStyle(e){var t,s=document.getElementById(e);return s?(s=s.textContent,(t=document.createElement("style")).appendChild(document.createTextNode(s)),document.head.appendChild(t),t.sheet):debug({level:2,return:null},"can't find element in UDapi.loadStyle()",e)}copyPortion(e,t,s="",n=null,i=null){n=n||{h3:{style:"titleButton",tag:"h3"},h2:{style:"helpTitle",tag:"h2"}},i=i||"$$$.showOneOfClass";var a=document.getElementById(t);if(!a)return debug({level:2,return:null},"can't find element in UDapi.grabContent()",t);t=document.getElementById(e);if(!t)return debug({level:2,return:null},"can't find element in UDapi.grabContent()",e);if(s){let e=document.getElementById(s);if(!(e=e||a.previousSibling))return debug({level:2,return:null},"can't find element in UDapi.grabContent()",s);e.innerHTML=t.innerHTML}var o=this.grabPortion(t).inn;a.innerHTML="";let l=null;for(var r,d=0;d<o.length;d++)1==o[d].nodeType&&((r=o[d].cloneNode(!0)).id+="_copied",a.appendChild(r),this.mapClassAndTag(r,n),"titleButton"==r.className)&&(r.setAttribute("onclick",i+"( '"+r.id+"', 1);"),l=l||r);l&&this.showOnePortion(l.id,!0),"undefined"==typeof process&&window.scroll(0,0)}mapClassAndTag(e,t){var s=e.tagName.toLowerCase();t&&t[s]&&(t[s].style&&(e.className=t[s].style),t[s].tag!=e.tagName.toLowerCase())&&this.dom.changeTag(e,t[s].tag,"")}grabPortionList(e,t,s){var n=this.dom.udjson.value(s,"headerId"),i=this.dom.udjson.value(s,"tagListStr");let a=null,o=this.dom.udjson.value(s,"mode");o=o||"list";var l=i.split(",");let r=this.dom.element(t);if(!(r=r||this.dom.element("[name='"+t+"']","document")))return debug({level:2,return:null},"can't find element in UDapi.grabPortionList()",t);let d=this.dom.element(e);if(!(d=d||this.dom.element("[name='"+e+"']","document")))return debug({level:2,return:null},"can't find element in UDapi.grabPortionList()",e);if(n){let e=this.dom.element(n);if(!(e=e||this.dom.element("[name='"+n+"']",d)))return debug({level:2,return:null},"can't find header in UDapi.grabPortionList()",n);(a=d.querySelector("div h1"))?e.innerHTML=a.innerHTML:e.innerHTML="Home"}let u="{details}",c=0;var h=document.createElement("div");if("titles"==o){var m=this.dom.children(d);for(let e=0;e<m.length;e++){var p=m[e];if(1==p.nodeType){var g=p.tagName.toLowerCase();if(!l.length||-1<l.indexOf(g)){var f=p.id+"_copy",v="<"+g+' id="'+f+'">',b=(v=(v=v+('<a href="javascript:" class= "sleepingButton" udapi_value1="'+p.id+'" udapi_quotes="//"')+(' onclick="'+("API.showOneOfClass( '"+f+"',1);")+'">'))+p.textContent+("</a></"+g+">"),u+=v,this.grabPortion(p).inn);let t=null;for(let e=0;e<b.length;e++){var x=b[e];1==x.nodeType&&((x=x.cloneNode(!0)).id+="_copy",x.classList.add("hidden"),u+=x.outerHTML,"titleButton"==x.className)&&(x.setAttribute("onclick","API.showOneOfClass( '"+x.id+"', 1);"),t=t||x)}c++}else c||p==a||((f=p.cloneNode(!0)).id=f.id+"_copy",this.dom.attr(f,"ud_oid",""),u+=f.outerHTML)}}}else{u+='<ul class="portionList">';var y=this.dom.children(d);for(let e=0;e<y.length;e++){var T,E=y[e];1==E.nodeType&&(!l.length||-1<l.indexOf(E.tagName.toLowerCase())?(T='<li><a href="javascript:" class= "sleepingButton" udapi_value1="'+E.id+'" udapi_quotes="//"',T=(T+=' onclick="'+(this.dom.udjson.value(s,"callback")+"('chapter', this);")+'">')+E.textContent+"</a></li>",u+=T,c++):c||E==a||((T=E.cloneNode(!0)).id="Copy of "+T.id,this.dom.attr(T,"ud_oid",""),h.appendChild(T)))}u+="</ul>"}u=u.replace("{details}",h.innerHTML),r.innerHTML=u,r.setAttribute("contenteditable","false"),window.scroll(0,0)}grabPortion(t){var s=[],n=[],e=[];if("div"==t.tagName.toLowerCase()){let e=t.childNodes;for(var i in e)s.push(e[i]);for(var a in e=t.parentNode.getElementsByClassName(t.classList.item(0))){if(isNaN(a))break;a=e[a];a.id==id||a.classList.contains("hidden")||n.push(a)}}else if(-1<["h1","h2","h3","h4","h5"].indexOf(t.tagName.toLowerCase()))for(var o=t.tagName.toLowerCase(),l=["h1","h2","h3","h4","h5"].indexOf(t.tagName.toLowerCase()),r="ignore",d=this.dom.siblings(t),u=0;u<d.length;u++){var c=d[u];if(c.tagName.toLowerCase()==o)r=c==t?"in":"out",e.push(c);else if(["h1","h2","h3","h4","h5"].indexOf(t.tagName.toLowerCase())<l)r="ignore",s.push(c);else switch(r){case"ignore":break;case"in":s.push(c);break;case"out":n.push(c)}}return{inn:s,out:n,bound:e}}pageBanner(e,t=""){switch(void 0===this.bannerStack&&(this.bannerStack=[],this.bannerZone=document.getElementById("bannerMessage"),this.bannerTimeoutId=-1),e){case"clear":if(0==this.bannerStack.length)return debug({level:2,return:!1},"Nothing in banner stack on clear in API pageBanner()");this.bannerZone.innerHTML=this.bannerStack.pop(),this.bannerTimeoutId=-1,this.bannerStack.length&&(this.bannerTimeoutId=setTimeout(function(){n.pageBanner("clear")},5e3));break;case"set":if(!t)return debug({level:2,return:!1},"Can't write nothing to banner, use clear instead in API pageBanner()");"="==t.charAt(0)&&(t=this.calc.exec(t.substr(1)));var s=this.bannerZone.innerHTML;""!=s&&"Banner zone"!=s&&this.bannerStack.push(this.bannerZone.innerHTML),this.bannerZone.innerHTML=t;break;case"tmp":case"temp":if(!t)return debug({level:2,return:!1},"Can't write nothing to banner, use clear instead in API pageBanner()");"="==t.charAt(0)&&(t=this.calc.exec(t.substr(1))),this.bannerStack.length||this.bannerStack.push(this.bannerZone.innerHTML),this.bannerZone.innerHTML=t;var n=this;-1<this.bannerTimeoutId&&clearTimeout(this.bannerTimeoutId),this.bannerTimeoutId=setTimeout(function(){n.pageBanner("clear")},1e4)}}grabFromTable(e,t,s){var n=this.dom.element(e);if(!n)return debug({level:2,return:null},"can't find element",e);e=this.dom.element(t);if(!e)return debug({level:2,return:null},"can't find table",t);var i=e.rows[0].cells,a=[];for(let e=0;e<i.length;e++)a.push(this.dom.attr(i[e],"_type")+i[e].textContent);var o=a.indexOf(s);if(-1==o)return debug({level:2,return:null},"can't find column in table",s,tableId);var l=e.getElementsByTagName("tbody")[0].rows;let r="";for(let e=0;e<l.length;e++)r+=l[e].cells[o].innerHTML;r&&(n.innerHTML=r)}loadModule(e,t,s=""){e=e+"/"+t+".js";this.ude.loadScript("modules/"+e,s=s||"window.ud.ude.modules['modules/"+e+"']['instance'] = new "+t+"();")}async servicePromise(e,t,s=!0){var n="SetOfValues--16--nname|{service}%20service".replace("{service}",e);let i=t;if(!(i="object"!=typeof t?JSON.parse(t):i))return!1;i.service=e,i.process=$$$.dom.textContent("UD_model"),i.task=this.dom.textContent("UD_dbName");t="/"+UD_SERVICE+"/"+n+"/AJAX_service/",n={dataTarget:i.dataTarget,dataSource:i.dataSource,dataMap:i.dataMap,dataReplace:i.dataReplace,service:e,waitPopup:!0},e="form=INPUT_Service"+e+"&input_oid=SetOfValues--16-0&nServiceRequest="+encodeURIComponent(JSON.stringify(i));if(s)return this.ud.udajax.serverRequestPromise(t,"POST",e,n,this.serviceResponse);this.ud.udajax.serverRequest(t,"POST",e,n,this.serviceResponse)}service(e,t){var s="SetOfValues--16--nname|{service}%20service".replace("{service}",e);let n=t;if(!(n="object"!=typeof t?JSON.parse(t):n))return!1;n.service=e,n.process=$$$.dom.textContent("UD_model"),n.task=this.dom.textContent("UD_dbName");t="/"+UD_SERVICE+"/"+s+"/AJAX_service/",s={dataTarget:n.dataTarget,dataSource:n.dataSource,dataMap:n.dataMap,dataReplace:n.dataReplace,service:e},e="form=INPUT_Service&input_oid=SetOfValues--16-0&nServiceRequest="+encodeURIComponent(JSON.stringify(n));return this.ud.udajax.serverRequest(t,"POST",e,s,this.serviceResponse),!0}serviceResponse(t,e,s){var n=window.ud.api,i=n.dom.udjson.parse(e);if(i){let e="";if(i.success){e+='<span class="success">'+i.message+"</span>",$$$.pageBanner("temp",e),$$$.botlog(t.service,!1,"Service "+t.service+": success");var a=i.data;if(a){var o=t.dataTarget,l=t.dataSource,r=t.dataMap;if(o&&l){let e=n.dom.element(o),s=(e=e||n.dom.elementByName(o),"value"==l?i.value:n.json.value(a,l));if(e&&s)if("div.part"==n.dom.attr(e,"exTag")){if("object"==typeof s&&Array.isArray(s)){var d=e.textContent,l=n.dom.children(e);let t=l[l.length-1];for(let e=0;e<s.length;e++){var u=s[e];d.indexOf(u)<0&&(t=$$$.insertElement("p",u,{},t,!0))}}}else t.dataReplace||"UD_spare"==o||!e.textContent||e.textContent==n.dom.attr(e,"ude_place")||null==e.textContent||"null"==e.textContent?("object"==typeof s&&(s=JSON.stringify(s)),e.textContent=s,n.ude.setChanged(e)):e.textContent!=s&&(e.textContent+=","+s,n.ude.setChanged(e))}else if(o&&void 0!==r&&Object.keys(r).length){let e=n.json.parse(o);for(var c in r){var h=n.json.valueByPath(a,c);e=h?n.json.valueByPath(e,r[c],h):n.json.valueByPath(e,r[c],n.translateTerm("No value")),n.dom.element(o).textContent=JSON.stringify(e),n.ude.setChanged(o)}}t.promise&&t.resolve(t)}}else e+='<span class="error">'+i.message+"</span>",n.pageBanner("temp",e),$$$.botlog(t.service,!1,"Error service "+t.service+": "+i.message)}else n.pageBanner("temp",e)}calculate(e){return this.calc.eval(e)}addCalculatorFunction(e,t){var s=this.calc;return void 0===s[e]&&(s[e]=t,s.localFunctions.push(e),!0)}showNextInList(e){let t,s;for(t=0;t<e.length;t++)if(!(s=this.dom.element(e[t])).classList.contains("hidden")){s.classList.add("hidden");var n=this.dom.element("tr.rowModel",s);n&&(n.style.display="unset");break}var i;(s=t>=e.length-1?this.dom.element(e[0]):this.dom.element(e[t+1]))&&(s.classList.remove("hidden"),i=this.dom.element("tr.rowModel",s))&&(i.style.display="block")}showFirstInList(t){let s=this.dom.element(t[0]);if(s){s.classList.remove("hidden");for(let e=1;e<t.length;e++)(s=this.dom.element(t[e]))&&s.classList.add("hidden")}}LED(t,s){t=document.getElementById(t);if(t&&"circle"==t.tagName.toLowerCase()){let e=s?"lightgreen":"pink";t.setAttribute("stroke",e),t.setAttribute("fill",e)}}env(e,t){e="/"+this.ud.service+"//AJAX_fetch/"+e+"|"+t+"/";this.ud.udajax.serverRequest(e,"GET","",{action:"ignore"})}switchHighlight(e){let t=null;(t="string"==typeof e?this.dom.element(e):e)&&(t.classList.contains("highlight")?t.classList.remove("highlight"):t.classList.add("highlight"))}listAPI(e=null){let t='<ul class="listAPI">',s="";for(var n in this.fctMap){t+="<li>"+n+"<li>";var i=this.fctMap[n];s+=n+","+i.constructor.name+"\n"}let a=API.dom,o=Object.getOwnPropertyNames(Object.getPrototypeOf(a));for(let e=0;e<o.length;e++){var l=o[e];"function"==typeof a[l]&&"constructor"!=l&&(t+="<li>"+l+"<li>",s+="dom."+l+",dom\n")}a=API.dom.cursor,o=Object.getOwnPropertyNames(Object.getPrototypeOf(a));for(let e=0;e<o.length;e++){var r=o[e];"function"==typeof a[r]&&"constructor"!=r&&(t+="<li>"+r+"<li>",s+="dom.cursor."+r+",dom.cursor\n")}a=API.dom.udjson,o=Object.getOwnPropertyNames(Object.getPrototypeOf(a));for(let e=0;e<o.length;e++){var d=o[e];"function"==typeof a[d]&&"constructor"!=d&&(t+="<li>"+d+"<li>",s+="dom.udjson."+d+",udjson\n")}if(t+="</ul>",!e)return console.log(s),t}getShortcut(t,e=""){return(e=e||this.fctMap[t])?e[t].bind(e):function(...e){if(!this.detectErrors)return e[0];console.log("ERR no "+t)}}raiseErrors(){this.detectErrors=!0}ignoreErrors(){this.detectErrors=!1}isLoadable(e){let t="";for(var s in this.availableModules)if(this.availableModules[s]&&-1<this.availableModules[s].indexOf(e)){t=s;break}return t?"modules/$$$/"+t:(this.loadable||(this.loadable=$$$.json.parse("UD_loadable")),$$$.json.value(this.loadable,e))}insertElement(){var e=this.ude.insertElement(arguments[0],arguments[1],arguments[2],arguments[3],arguments[4],arguments[5]);this.ude.initialiseElement(e.id)}removeChildren(e){return this.utilities.removeChildren(e)}followScroll(e){return this.ude.followScroll(e)}changeClass(){return this.ude.changeClass(arguments[0],arguments[1],arguments[2])}reload(){return this.ud.reload(arguments[0],arguments[1],arguments[2])}dom(){return this.dom}loadFcts(t){var s=[];let n="";for(let e=0;e<t.length;e++){var i,a=t[e];void 0===this.fctMap[a]&&((i=this.isLoadable(a))?-1==s.indexOf(i)&&s.push(i+version):n+=a+" ")}return n?n.trim():!s.length||(require(s),!1)}loadAndRun(t,e){var s=[];for(let e=0;e<t.length;e++){var n=t[e];void 0===this.fctMap[n]&&(n=this.isLoadable(n))&&-1==s.indexOf(n)&&s.push(n+version)}require(s,e)}isFunction(e){return"object"==typeof this.fctMap[e]}}class Deferred{constructor(){this.promise=new Promise((e,t)=>{this.reject=t,this.resolve=e})}}function setupAPI(e){let a=new UDapi(e);return $$$=API=new Proxy(a,{get:function(e,s,t){let n=e.fctMap[s];if(n)return function(...e){return n[s].apply(n,e)};{let t=e[s];if("function"==typeof t)return function(...e){return t.apply(this,e)};if(void 0!==t)return t;{var i=!e.detectErrors;let t=e.isLoadable(s);return t?function(...e){a.argsLoadable[s]=e,require([t+version],function(){return $$$[s](...a.argsLoadable[s])})}:i?function(...e){return debug({level:5},"Unactivated hook ",s),e[0]}:function(){var e,t="ERR 450 - Unknown function call "+s+"()";return debug({level:2},t),-1==this.unknownCalls.indexOf(s)&&(this.unknownCalls.push(s),e=this.dom.element("UD_debug"))&&10<parseInt(e.textContent)&&alert(t),null}}}}}),UDLIB=API}if("object"==typeof process)if(void 0===global.JSDOM&&"undefined"==typeof window&&"undefined"==typeof ModuleUnderTest){ModuleUnderTest="udapi.js",console.log("Syntax OK");const api1=require("./apiset1.js"),UDapiSet1=api1.class,envMod=(module.exports={class:UDapi,SET1:UDapiSet1,init:setupAPI},require("../tests/testenv.js")),ud=(envMod.load(),new UniversalDoc("document",!0,133));ud.api?console.log("API loaded : OK"):(console.log("API loaded : KO"),process.exit(-1));let r=API.insertRow("myTable",0,{val1:32,val2:"text",val3:"dom...value"});r?console.log("Test insertRow : OK"):console.log("Test insertRow : KO"),r=API.copyPortion("source_h1a","target"),-1<document.getElementById("target").outerHTML.indexOf("helpTitle")?console.log("Test copyPortion : OK"):console.log("Test copyPortion : KO");{let test="API wrapping good & bad functions",r1=(API.raiseErrors(),API.badFct("abc")),r2=API.calculate("2+3");testResult(test,(null==r1||-1<r1.indexOf("ERR"))&5==r2,API)}console.log("udapi.js Test completed"),process.exit()}else{const api1=require("./apiset1.js"),UDapiSet1=api1.class;module.exports={class:UDapi,SET1:UDapiSet1,init:setupAPI}}class UD_content{info;constructor(){this.info=UD_exTagAndClassInfo,void 0!==window.API&&window.API.addFunctions(this,["updateContentAfterEvent","checkContent","replaceModelInElement","extractDataFromContent","getUndefinedElementContent"])}getUndefinedElementContent(e){var t=$$$.dom,n=$$$.json.value,e=t.element(e),i=t.getSaveableParent(e);if(e&&i){var i=t.getEditableParent(e),a=t.getSelector(e),t=t.attr(e,"exTag").split("."),o=$$$.availableTags(i),l={};let s="";2==t.length&&(s=t[1]);for(let e=0;e<o.length;e++){var r=o[e];if("p.undefined"!=r){var d=$$$.getTagOrStyleInfo(r);let e="EN"!=lang?n(d,"label_"+lang):"";e=e||n(d,"label");d=n(d,"icon");let t=2;"h1"==r?t=3:"h2"==r&&(t=2.5);var u,d=d?[{tag:"img",src:UDincludePath+"resources/images/"+d,style:"width:"+t+"em;"},{value:" "}]:{value:e},r=r.split(".");s&&(r[1]!=s||r.length<3)||!s&&2<r.length||(u=r.slice(0,2).join("."),r=2<r.length?r[2]:"",l[e]={tag:"a",class:"panel-block",onclick:"let el = $$$.changeTag( '"+u+"', "+a+", '"+r+"'); $$$.displayMenu( el);",title:e,value:d})}}return API.json.putElement({tag:"div",class:"panel-block is-wrapped",value:l},!1).outerHTML}}updateContentAfterEvent(s,n=null){var i=API.dom,a=API.json.value,s=i.element(s),o=i.getSaveableParent(s);if(o){var l=i.attr(o,"exTagType"),r=n?n.eventType:"";let e=!1;if(e="emptyView"==r||"update"==r||"changeTag"==r&&API.hasDefaultContent(o,n.oldTag)||"changeClass"==r&&API.hasDefaultContent(o,l,n.oldClass)){var d=s.classList;for(let e=0;e<d.length;e++){var u=d.item(e);if(0==u.indexOf("LAY_")){0;break}}let e=!1,t=a(this.info,l);"div.part"==l&&(t=a(this.info,l+"."+i.attr(s,"ud_subtype")));var c,h,r=a(t,"defaultContentPath");if(r&&(h=i.keepPermanentClass(o.className))&&(c=a(t,"defaultContentByClassOrViewType"),c=a(c,h))&&(h=i.attr(o,"name"),i.udjson.valueByPath(h+"_object",r,c),$$$.initialiseElement(o),e=!0),!e){let e=a(t,"defaultContent");if("__UNDEFINED__"==e&&(e=this.getUndefinedElementContent(o)),e=(e=n.newClass&&(i=a(t,"defaultContentByClassOrViewType"),i=a(i,n.newClass))?i:e)||{para:{tag:"p",value:"..."}},-1<l.indexOf("div.part")||"div.zone"==l)return this.setViewContent(s,e);s.innerHTML=API.json.toHTML(e),$$$.dom.attr(s,"ude_place",s.textContent)}}}}checkContent(e){return this.updateContentAfterEvent(e,{eventType:"update"})}setViewContent(e,t){e=API.dom.element(e);let s=e;var n,i=API.dom;let a=e.childNodes,o=("div.page"==API.dom.attr(a[0],"exTag")&&(s=a[0],a=s.childNodes),0),l=!0;for(n in t){var r=t[n];if(o>=a.length||r.tag+"."+r.type!=API.dom.attr(a[o],"exTag")){l=!1;break}o++}if(!l){for(var d in t){d=API.json.putElement(t[d],!1);if(s.appendChild(d),"span"!=i.attr(d,"exTag")){"object"!=typeof process&&window.ud.viewEvent("create",d);let e=null;i.children(d).length&&(e=function(e){var t=window.ud.dom,s=e.childNodes;for(let e=0;e<s.length;e++){var n=s[e];"span.caption"!=t.attr(n,"exTag")&&"object"!=typeof process&&(window.ud.viewEvent("create",n),n.id)&&"DIV"==n.tagName&&$$$.initialiseElement(n.id)}}),console.log("Update",d.id,e),e&&API.dom.attr(d,"ud_onupdate",API.onTrigger(d.id,"update",e))}}for(let e=0;e<a.length;e++){var u=a[e];u.nodeType==Node.TEXT_NODE?u.remove():window.ud.viewEvent("remove",a[e])}}}replaceModelInElement(e,t,s){var e=API.dom.element(e),n=e.innerHTML,t=this.extractDataFromContent(n,t);return 0==Object.keys(t).length?n:(n=API.dom.element(s+"viewZone").innerHTML,s=API.calc.substitute(n,t),e.innerHTML=s,API.setChanged(e),s)}extractDataFromContent(t,e){var s=[],n=[],i=API.dom.element(e+"viewZone").innerHTML;{let e=0,t=i.indexOf("{",e);for(;-1<t;){var a=i.indexOf("}",t);if(a<=0)break;n.push(i.substring(t+1,a));var o=i.indexOf("{",a);s.push(i.substring(e,t)),s.push(-1<o?i.substring(a+1,o):i.substring(a+1)),t=o,e=a+1}}var l={};for(let e=0;e<n.length;e++){var r=s[2*e],d=t.indexOf(r),u=t.indexOf(s[2*e+1]);l[n[e]]=-1<d&&-1<u?t.substring(d+r.length,u):""}return l}isDefaultContent(e){return API.hasDefaultContent(e)}}function UD_content_init(){return new UD_content(window.ud)}if("object"==typeof process&&(module.exports={class:UD_content,init:UD_content_init},void 0===global.JSDOM)&&"undefined"==typeof window&&"undefined"==typeof ModuleUnderTest){console.log("Syntax:OK"),console.log("Start of UD_ressources class test program"),console.log("Setting up browser (client) test environment"),ModuleUnderTest="udcontent";let path="..";const testMod=require(path+"/tests/testenv.js");testMod.load([]);let ud=new UniversalDoc("document",!0,133);{let test="1 - view setup with checkContent",view=API.dom.elementByName("view2");view&&(view.classList.add("LAY_thirds"),API.checkContent(view)),console.log(view.innerHTML),testResult(test,view&&-1<view.innerHTML.indexOf("zone"),view)}console.log("Test completed"),process.exit()}class UDJSON{dom;textCol1="n°";textCol2="text";attrMap={label:"name",href:"href",src:"src",onclick:"onclick",class:"class",style:"style",formula:"ude_formula",placeholder:"ude_place",type:"ud_type",subType:"ud_subtype",mime:"ud_mime",stage:"ude_stage",menu:"ude_menu",autosave:"ude_autosave",edit:"ude_edit",bind:"ude_bind",datasrc:"ude_datasrc",follow:"ud_follow",valid:"ude_onvalid",invalid:"ude_oninvalid",title:"title",offset:"ud_offset",validate:"ude_validate",accept:"ude_accept",width:"width",height:"height",x:"x",y:"y",ui:"ude_ui",val:"value",inputType:"type",checked:"checked",spell:"spellcheck",max:"max"};tempClasses=["editing","edcontainer","edinside"];lastJSONkeys=[];use_onclick=!1;use_onclick_el="";mode="";jsonComments={};constructor(e){this.dom=e,this.mode=this.dom.element("UD_mode").textContent}read(e,t,s=""){return this.value(e,t,null,s)}readFromDiv(e,t,s=""){return this.value(e,t,null,s)}write(e,t,s,n){return this.value(e,t,s,n)}writeToDiv(e,t,s,n){return this.value(e,t,s,n)}value(n,i,a=null,o=""){if(void 0===this)return window.udjson.value(n,i,a,o);let l=null,r=null;if("string"==typeof n){if(""==n)return null;l=n.length<48&&"{"!=n[0]&&(r=this.dom.element(n))?this.parse(r.textContent):this.parse(n)}else"object"==typeof n&&(l=n);if(l&&void 0!==l[i]&&null==a&&!o)return l[i];if(l&&null==a&&!o)return"";if(l){let e="",t=-1,s=l[i];switch(o){case"":case"set":l[i]=a;break;case"replace":"string"==typeof l[i]&&(l[i]=l[i].replace(a[0],a[1]));break;case"delete":delete l[i];break;case"addToCSV":s=s?s.split(","):[],-1<(t=s.indexOf(a))||(s.push(a),l[i]=s.join(","));break;case"removeFromCSV":s=s?s.split(","):[],-1!=(t=s.indexOf(a))&&(s.splice(t,1),l[i]=s.join(","));break;case"add":void 0===s.length||-1<(t=s.indexOf(a))||(s.push(a),l[i]=s);break;case"remove":void 0!==s.length&&-1!=(t=s.indexOf(a))&&(s.splice(t,1),l[i]=s);break;case"incrementAfter":e=l[i]++;break;case"incrementAfterBase32":e=l[i],l[i]=(parseInt(e,32)+1).toString(32)}return"string"==typeof n&&(l=JSON.stringify(l)),r&&(r.textContent=l),""!=e?e:l}}parse(e){let t=null,s=e,n=null;-1==e.indexOf("{")&&e.length<48&&(n=this.dom.element(e))&&(s=n.textContent);try{t=JSON.parse(s)}catch(e){debug({level:4},"Can't parse JSON string ",e,s)}return t}text(e,t){var s=this.valueByPath(e,t);let n="";for(let e=0;e<s.length;e++)n+=s[e]+"\n";return n}valueByPath(t,s,n=null){let i=null,a=null;if("string"==typeof t){if(""==t)return null;i=t.length<48&&"{"!=t[0]&&(a=this.dom.element(t))?this.parse(a.textContent):this.parse(t)}else"object"==typeof t&&(i=t);if(!i)return null;let o=i,l=s;if("string"==typeof l&&(l=l.split("/")),null==n){for(let e=0;e<l.length;e++){if(isNaN(l[e])||(l[e]=parseInt(l[e])),void 0===o[l[e]])return null;o=o[l[e]]}return o}{var r;for(let t=0;t<l.length;t++){let e={};if(void 0===(o=(r=o)[l[t]])&&t<l.length-1)if(isNaN(l[t+1]))switch(t){case 0:i[l[0]]=o=e;break;case 1:i[l[0]][l[1]]=o=e;break;case 2:i[l[0]][l[1]][l[2]]=o=e;break;case 3:i[l[0]][l[1]][l[2]][l[3]]=o=e;break;case 4:i[l[0]][l[1]][l[2]][l[3]][l[4]]=o=e;break;case 5:i[l[0]][l[1]][l[2]][l[3]][l[4]][l[5]]=o=e;break;case 6:debug({level:1},"valueByPath only accesses 6 levels",l)}else if(l[t+1]=parseInt(l[t+1]),Array.isArray(r))switch(t){case 0:i=o=e;break;case 1:i[l[0]].push(e);break;case 2:i[l[0]][l[1]].push(e);break;case 3:i[l[0]][l[1]][l[2]].push(e);break;case 4:case 5:i[l[0]][l[1]][l[2]][l[3]].push(e);break;case 6:debug({level:1},"valueByPath only accesses 6 levels",l)}else switch(e=[],t){case 0:i[l[0]]=o=e;break;case 1:i[l[0]][l[1]]=o=e;break;case 2:i[l[0]][l[1]][l[2]]=o=e;break;case 3:i[l[0]][l[1]][l[2]][l[3]]=o=e;break;case 4:i[l[0]][l[1]][l[2]][l[3]][l[4]]=o=e;break;case 5:debug({level:1},"valueByPath only accesses 6 levels",l)}}s=l[l.length-1];let e=0;if("number"==typeof s)switch(l.length){case 1:e=i.length;case 2:e=i[l[0]].length;break;case 3:e=i[l[0]][l[1]].length;break;case 4:e=i[l[0]][l[1]][l[2]].length;break;case 5:e=i[l[0]][l[1]][l[2]][l[3]].length;break;case 6:e=i[l[0]][l[1]][l[2]][l[3]][l[4]].length;break;case 7:e=i[l[0]][l[1]][l[2]][l[3]][l[4]][l[5]].length;break;case 8:e=i[l[0]][l[1]][l[2]][l[3]][l[4]][l[5]][l[6]].length;break;default:debug({level:1},"valueByPath only accesses 8 levels",l)}if("number"==typeof s&&s>=e)switch(l.length){case 1:i.push(n);break;case 2:i[l[0]].push(n);break;case 3:i[l[0]][l[1]].push(n);break;case 4:i[l[0]][l[1]][l[2]].push(n);break;case 5:i[l[0]][l[1]][l[2]][l[3]].push(n);break;case 6:i[l[0]][l[1]][l[2]][l[3]][l[4]].push(n);break;case 7:i[l[0]][l[1]][l[2]][l[3]][l[4]][l[5]].push(n);break;case 8:i[l[0]][l[1]][l[2]][l[3]][l[4]][l[5]][l[6]].push(n);break;default:debug({level:1},"valueByPath only accesses 8 levels",l)}else switch(l.length){case 1:i[l[0]]=n;break;case 2:i[l[0]][l[1]]=n;break;case 3:i[l[0]][l[1]][l[2]]=n;break;case 4:i[l[0]][l[1]][l[2]][l[3]]=n;break;case 5:i[l[0]][l[1]][l[2]][l[3]][l[4]]=n;break;case 6:i[l[0]][l[1]][l[2]][l[3]][l[4]][l[5]]=n;break;case 7:i[l[0]][l[1]][l[2]][l[3]][l[4]][l[5]][l[6]]=n;break;case 8:i[l[0]][l[1]][l[2]][l[3]][l[4]][l[5]][l[6]][l[7]]=n;break;default:debug({level:1},"valueByPath only accesses 8 levels",l)}return"string"==typeof t&&(i=JSON.stringify(i)),a&&(a.textContent=i),i}}setValueByPath(e,t,s,n=0){"string"==typeof e&&(e=this.parse(e));let i=(t="string"==typeof t?t.split("/"):t).shift();return isNaN(i)||(i=parseInt(i)),e&&(this.valueByPath(e,i)?t.length||(e[i]=s):"string"==typeof i?t.length?isNaN(t[0])?e[i]={}:e[i]=[]:e[i]=s:Array.isArray(e)?i<e.length?e[i]=s:e.push(s):e=t.length?[{}]:[s],t.length)&&(e[i]=this.setValueByPath(e[i],t,s,e)),e}merge(e,t,s=""){let n=null,i=null;if("string"==typeof e){if(""==e)return null;n=e.length<48&&"{"!=e[0]&&(i=this.dom.element(e))?this.parse(i.textContent):this.parse(e)}else"object"==typeof e&&(n=e);let a=null,o=null;if("string"==typeof t){if(""==t)return null;t.length<48&&"{"!=t[0]&&(o=this.dom.element(t))?(a=this.parse(o.textContent),this.value(a,"meta")&&(a=this.valueByPath(a,"data/value"))):a=this.parse(t)}else"object"==typeof t&&(a=t);for(var l in a){var r=a[l];let e=s;if(e?e+="/"+l:e=l,"number"==typeof r||"string"==typeof r)this.setValueByPath(n,e,r);else if(Array.isArray(r)){let t=this.valueByPath(n,e);if(t){if(Array.isArray(t)){if("_APPEND_"==r[0]){r.shift();for(let e=0;e<r.length;e++)r[e]&&-1==t.indexOf(r[e])&&t.push(r[e])}else"_REPLACE_"==r[0]&&r.shift(),t=r;this.setValueByPath(n,e,t)}else if(t&&"object"==typeof t)for(let e=0;e<r.length;e++)t&&r[e]&&(t["e"+e]=r[e])}else t=r,this.setValueByPath(n,e,t)}else n=this.merge(n,r,e)}return"string"==typeof e&&(n=JSON.stringify(n)),i&&(i.textContent=n),n}checkClasses(e){var t=this.value(e,"class");return e=t&&"string"==typeof t&&""!=t?(t=this.dom.keepPermanentClasses(t))?this.value(e,"class",t):this.value(e,"class","","delete"):e}getElement(t,e=!0){let s={};var n=t.tagName.toLowerCase(),i=t.id,a=(t.name,this.dom.attr(t,"ud_type"));let o=!1;if(e){for(var l in s.meta={},i&&(s.meta.name=i.replace("editZone","")),s.meta.zone=i,this.attrMap){var r=this.attrMap[l];-1<["style","bind"].indexOf(l)||!r||this.dom.attr(t,r)&&(s.meta[l]=this.dom.attr(t,r))}s.meta=this.checkClasses(s.meta);this.dom.elements("div",t),o=!0,this.dom.children(t);API&&(this.use_onclick=API.testEditorAttr(t,"ude_edit","on"),this.use_onclick_el=t.id)}else{for(var d in s.tag=n,i&&0!=i.indexOf("udcalc")&&0!=i.indexOf("udecalc")&&(s.name=i),this.attrMap){var u=this.attrMap[d];-1<["style"].indexOf(d)||!u||(this.dom.attr(t,u)?s[d]=this.dom.attr(t,u):"onclick"==d&&this.dom.attr(t,"_onclick")&&(s[d]=this.dom.attr(t,"_onclick")))}if(s=this.checkClasses(s),"off"==this.value(s,"follow"))return s.value="",s}var c=Array.from(t.childNodes);let h=null;if(e&&c.length&&"SPAN"==c[0].tagName&&c[0].classList.contains("caption")?1==c[0].childNodes.length&&(h=c.shift(),s.meta.captionPosition="top"):e&&2<c.length&&"SPAN"==c[1].tagName&&c[1].classList.contains("caption")?1==c[1].childNodes.length&&(c.shift(),h=c.shift(),s.meta.captionPosition="top"):e&&c.length&&"SPAN"==c[c.length-1].tagName&&c[c.length-1].classList.contains("caption")&&1==c[c.length-1].length&&(h=c.pop,s.meta.captionPosition="bottom"),h){var m=h.childNodes;let t="";for(let e=0;e<m.length;e++){var p=m[e];p.nodeType==Node.TEXT_NODE?t+=p.textContent:p.nodeType!=Node.ELEMENT_NODE||"SPAN"!=p.tagName||p.classList.contains("objectName")||(t+=p.outerHTML)}t&&((i=document.createElement("textarea")).textContent=t.replace(/\n/g,""),t=i.innerHTML,s.meta.caption=t)}let g="value";if(o&&(g="data"),t.innerHTML==t.textContent)s[g]=t.textContent;else if("text"==a||"textedit"==a){let e=this.dom.element("table",t);if(!e&&"object"==typeof process&&("TABLE"==t.tagName?e=t:"TABLE"!=(e=this.dom.children(t)[1]).tagName&&(e=this.dom.children(t)[2]),!e))return null;s[g]=this.readTextEditor(e,this.dom.attr(e,"ud_mime"))}else if("list"==a){i=this.dom.element("ul",t);s[g]=this.readList(i)}else if("ul"==n)s=this.readList(t);else if("table"==a){i=this.dom.element("table",t);s[g]=this.readTable(i)}else if("table"==n)s[g]=this.readTable(t);else if("divdata"==a)s[g]=c[0].innerHTML;else if(1==c.length)s[g]=this.getElement(c[0],!1);else{i=["ul","thead","tbody"].indexOf(n);if(o||-1<i){s[g]={};let t=1;for(let e=0;e<c.length;e++){var f=c[e];this.dom.attr(f,"exTag");if(1==f.nodeType)if("BR"==f.tagName)s[g].push({tag:"br",value:""});else{let e=this.dom.attr(f,"ud_key");e=e||t,s[g][e]=this.getElement(f,!1)}else 3==f.nodeType&&(s[g][t]={value:f.textContent});t++}}else{s[g]=[];for(let e=0;e<c.length;e++){var v=c[e];1==v.nodeType?"BR"==v.tagName?s[g].push({tag:"br",value:""}):s[g].push(this.getElement(v,!1)):3==v.nodeType&&s[g].push({value:v.textContent})}}}return e&&(s.changes={}),this.use_onclick&&t.id==this.use_onclick_el&&(this.use_onclick=!1,this.use_onclick_el=""),s}putElement(e,t="",s,n=""){let i=this.value(e,"meta");i=i||e,i=this.checkClasses(i);var a=this.value(i,"tag");let o=this.value(i,"name");var l,r=this.value(i,"zone");let d=null;if(r){if(d=this.dom.element(r))for(var u in this.dom.emptyElement(d),this.attrMap)""!==this.value(i,u)&&this.dom.attr(d,this.attrMap[u],this.value(i,u));else{for(var c in-1<((d=document.createElement("div")).id=r).toLowerCase().indexOf("editzone")&&(d.className="editzone"),this.attrMap)""!==this.value(i,c)&&this.dom.attr(d,this.attrMap[c],this.value(i,c));t?this.dom.attr(d,"ude_bind",t):this.dom.attr(d,"ude_bind",o+"_object"),n&&(r=n.split(" "),d.classList.add(r[0]))}API&&(this.use_onclick=!!window.UDE_init&&API.testEditorAttr(d,"ude_edit","on"),this.use_onclick_el=d.id)}else if(a){d=document.createElement(a),o&&(d.id=o),n&&(r=n.split(" "),d.classList.add(r[0])),0<o.indexOf("editZone")&&t&&this.dom.attr(d,"ude_bind",t);var h,m=!this.value(i,"ui")&&this.use_onclick;for(h in this.attrMap)this.value(i,h)&&("onclick"==h&&m&&"yes"!=this.value(i,"ui")?this.dom.attr(d,"_onclick",this.value(i,h)):"placeholder"==h&&"input"==a?this.dom.attr(d,h,this.value(i,h)):this.attrMap[h]&&this.dom.attr(d,this.attrMap[h],this.value(i,h)))}if(!d)return null;let p=this.value(e,"data");if("string"==typeof(p=(p=(p=p||this.value(e,"value"))||this.value(e,"placeholder"))||""))""==p&&"br"==e.tag?d.appendChild(document.createElement("br")):p&&(d.innerHTML=p);else if("object"==typeof p)if(Array.isArray(p)||""==this.value(p,"tag")){for(var g in p)if("_"!=g.charAt(0)&&"length"!=g){let e=p[g];"string"==typeof e||""==this.value(e,"tag")&&""==this.value(e,"meta")?""==(e="object"==typeof e?e.value:e)&&"P"==d.tagName?d.appendChild(document.createElement("br")):e&&d.appendChild(document.createTextNode(e)):"object"==typeof p&&"datadiv"==this.value(p[g],"tag")?((l=document.createElement("div")).id=p[g].name,l.innerHTML=JSON.stringify(p[g].value),l.className="hidden",this.dom.attr(l,"ud_type","divdata"),d.appendChild(l)):(!this.value(p[g],"class")&&n&&(p[g].class=n),l=this.putElement(p[g],t,a,n),t&&this.dom.attr(l,"ud_key",g),d.appendChild(l))}}else if(p){r=p.tag;let e=null;p.name&&(o=p.name),"textedit"==r?(p.value||(p.value={dummy:"..."}),f=o.replace("editZone","-table"),e=this.createTextEditor(p.value,f,p.class)):"datadiv"==r?((e=document.createElement("div")).innerHTML=JSON.stringify(p.value),e.className="hidden",this.dom.attr(e,"ud_type","divdata")):"jsonlist"==r?(p.value||(p.value={dummy:"..."}),e=this.createList(p.value,o,p),n&&(e.className=n)):"jsontable"==r?(p.value||(p.value={dummy:"..."}),e=this.createTable(p.value,o,p),n&&(e.className=this.dom.keepPermanentClasses(n,!1))):e=("div"==p.tag&&-1<p.class.indexOf("object")&&"object"==typeof p.value?p.value=JSON.stringify(p.value).replace(/&quot;/g,"&amp;quot;"):!this.value(p,"class")&&n&&(p.class=n),this.putElement(p,t,a,n)),d.appendChild(e)}var f=this.value(i,"caption"),r=this.value(i,"captionPosition");if(f&&r){var v=document.createElement("span");switch(v.className="caption",v.innerHTML=f,this.dom.attr(v,"spellcheck","false"),r){case"top":d.childNodes[0].classList.contains("objectName")?d.insertBefore(v,d.childNodes[1]):d.insertBefore(v,d.childNodes[0]);break;case"bottom":d.appendChild(v)}}return"object"!=typeof process&&(f=this.dom.element("table",d))&&f.parentNode==d&&(f.id?this.dom.arrangeTable(f.id):this.dom.arrangeTable(f)),e&&(r=this.value(e,"cache"))&&void 0!==r.tag&&d.appendChild(this.putElement(r,t,a)),this.use_onclick&&d.id==this.use_onclick_el&&(this.use_onclick=!1,this.use_onclick_el=""),d}toHTML(e){let t="";return"object"!=typeof e?e:(e=this.putElement({tag:"div",value:e},!1),t=e?e.innerHTML:"ERR")}createList(t,e,s){var s=void 0===s.class?"":s.class,n=document.createElement("ul");s&&(n.className=s),n.id=e;for(let e=0;e<t.length;e++){var i,a=document.createElement("li"),o=t[e];"object"==typeof o?(i=this.putElement({tag:"li",value:o},!1),a.innerHTML=i?i.innerHTML:"ERR"):a.innerHTML=o,n.appendChild(a)}return n}readList(e){var t={tag:"jsonlist"},s=(t.name=e.id,e.className&&(t.class=e.className),[]),n=e.childNodes;if(n.length){for(let t=0;t<n.length;t++){var i=n[t];let e={tag:"li"};this.dom.attr(i,"ude_formula")?e="="+this.dom.attr(i,"ude_formula"):(e=i.textContent,this.dom.isHTML(e)&&(i=this.getElement(i,!1),e=i?i.value:"ERR")),s.push(e)}t.value=s}return t}createTable(t,e,s){var n=void 0===s.class?"":s.class,s=void 0===s.datasrc?"":s.datasrc,i=[],a=[];let o={};if(!Array.isArray(t))for(var l in i.push("id"),t)if("model"==l)o=t[l];else{var r,d=Object.assign({},t[l]);for(r in d.id=l,d)-1==i.indexOf(r)&&i.push(r);a.push(d)}else{o=t[0];for(let e=1;e<t.length;e++){var u,c=t[e];for(u in c)-1==i.indexOf(u)&&i.push(u);a.push(c)}}var h=document.createElement("table"),n=(n&&(h.className=n),s&&this.dom.attr(h,"ude_datasrc",s),h.id=e,document.createElement("thead")),m=document.createElement("tbody");let p="";p+="<tr>";for(let e=0;e<i.length;e++)p+="<th>"+i[e]+"</th>";p+='</tr><tr class="rowModel">';for(let t=0;t<i.length;t++){let e=o[i[t]];null==e&&(e="");var g=API.getParameter("computingText");"="==e[0]?p+='<td ude_formula="'+e.substring(1)+'">'+g+"</td>":p+='<td ude_stage="on">'+e+"</td>"}p+="</tr>",n.innerHTML=p,h.appendChild(n);var f=API.getParameter("dummyText");for(let s=0;s<a.length;s++){var v=document.createElement("tr");p="";for(let t=0;t<i.length;t++){let e=void 0===a[s][i[t]]?"":a[s][i[t]];null==e&&(e="");var b=API.getParameter("computingText");"="==e[0]?p+='<td ude_stage="on" ude_formula="'+e.substring(1)+'">'+b+"</td>":("object"==typeof e&&(b={},b={tag:"div",value:e},e==f&&(b.placeholder=f),b=this.putElement(b,!1),e=b?b.innerHTML:"ERR"),p+="<td>"+e+"</td>")}v.innerHTML=p,m.appendChild(v)}return h.appendChild(m),h}readTable(e){var t={tag:"jsontable"},s=(t.name=e.id,e.className&&(t.class=e.className),this.dom.attr(e,"ude_datasrc")),n=(s&&(json.table.source=s),e.getElementsByTagName("thead")[0]),i=[];for(let e=0;e<n.rows[0].cells.length;e++)i.push(n.rows[0].cells[e].textContent);let a=[],o=!0;"id"==i[0]&&(a={},o=!1);var l=n.rows[1].cells,r={};for(let t=0;t<l.length;t++){var d=l[t];let e="";e=this.dom.attr(d,"ude_formula")?(0!=t||o||(o=!0,a=[]),"="+this.dom.attr(d,"ude_formula")):l[t].innerHTML,0==t&&!o||(r[i[t]]=e)}o?a.push(r):a.model=r;let u="";var c=e.getElementsByTagName("tbody")[0],h={};for(let e=0;e<c.rows.length;e++){var m=c.rows[e].cells,h={};u="";for(let t=0;t<m.length;t++)if(0!=t||o){var p=m[t];if(this.dom.attr(p,"ude_formula"))h[i[t]]="="+this.dom.attr(p,"ude_formula");else{let e=p.innerHTML;$$$.dom.children(p).length&&(p=this.getElement(m[t],!1),e=p?p.value:"ERR"),h[i[t]]=e}}else u=m[t].textContent;o?a.push(h):a[u]=h}return t.value=a,t}createTextEditor(e,t,s,n=""){var i=document.createElement("table");if(i.className=s?"textContent "+s:"textContent",i.id=t,this.dom.attr(i,"ude_autosave","off"),!n)if(Array.isArray(e))switch(e[0].trim().toUpperCase()){case"SERVER":n="text/text";break;case"CSS":n="text/css";break;case"JS":n="text/javascript";break;case"JSON":n="text/json";break;case"HTML":n="text/html";break;case"RESOURCE":n="text/json";break;default:n="text/text"}else n="text/json";this.dom.attr(i,"ud_mime",n);for(var s=document.createElement("thead"),a=document.createElement("tbody"),t="API.setChanged( '"+i.id+"', 1);",o="",l="",r=(l+='<tr contenteditable=false><th class="rowNo">'+this.textCol1+'</th><th class="linetext">'+this.textCol2+" "+(o+='<span class="rightButton"><a ref="javascript" onclick="'+t+'">save</a>')+"</th></tr>",s.innerHTML=l=(l=l+'<tr class="rowModel">'+'<td class="rowNo" ude_formula="row()" contenteditable="false">=row()</td>')+'<td class="linetext">...</td>'+"</tr>",i.appendChild(s),void 0===e.length&&(e=this.JSONtoText(e).split("\n")),document.createElement("textarea"),0);r<e.length;r++){var d=document.createElement("tr");l=(l="")+('<td contenteditable="false" ude_formula="row()" class="rowNo">'+(r+1)+"</td>")+('<td class="linetext">'+e[r]+"</td>"),d.innerHTML=l,a.appendChild(d)}return i.appendChild(a),i}JSONtoText(e,t=""){if(!(e="string"==typeof e&&""!=e?JSON.parse(e):e))return"";let s="",n=this.jsonComments;var i,a=$$$.getParameter("comment-key-in-JSON");for(i in t||(s+="JSON content\n",n=void 0!==e[a]?e[a]:[],this.jsonComments=n),e)if("length"!=i&&i!=a){var o=e[i],l=t+i;switch(typeof o){case"array":case"object":s+=this.JSONtoText(o,l+"/");break;case"number":s+=l+" = "+o+"\n";break;case"string":s+=l+' = "'+o+'"\n';break;default:debug({level:2},"unknown value type in JSON",t+i,o)}n&&void 0!==n[l]&&(s+="//"+n[l]+"\n")}return s}readTextEditor(e,s="text/text"){let n={};var t=this.dom.element("tbody",e),i=(t||e).rows;if(!i)return debug({level:1,return:null},"no rows in tbody of ",e);let a=[],o="text/json"==s;this.lastJSONkeys=[];for(let t=0;t<i.length;t++){let e=i[t].cells[1].textContent;"text/html"==s&&(e=i[t].cells[1].innerHTML),0==t&&0==e.toLowerCase().indexOf("json")&&(o=!0,e.toLowerCase().replace("json","").trim()),o&&t?n=this.prepareJSONstring(n,e):a.push(e)}return o&&(a=n),{tag:"textedit",class:e.className.replace(/textContent/g,""),value:a,mime:s}}prepareJSONstring(t,s){if("//"==s.substring(0,2))void 0===t[n=$$$.getParameter("comment-key-in-JSON")]&&(t[n]={}),t[n][this.lastJSONkeys.join("/")]=s.substring(2);else{var n=s.indexOf("=");if(!(n<=0)){var i=s.substr(0,n).trim();let e=s.substr(n+1).trim();e=e?JSON.parse(e):null;var a=i.split("/");for(let e=0;e<a.length;e++)0==a[e].length&&(a[e]=this.lastJSONkeys[e]);this.lastJSONkeys=a,null!=e&&(1<a.length?t=this.valueByPath(t,i,e):t[i]=e)}}return t}}if("object"==typeof process&&(module.exports={UDJSON:UDJSON},void 0===global.JSDOM)&&"undefined"==typeof window&&"undefined"==typeof ModuleUnderTest){console.log("Syntax:OK"),console.log("Start of test program"),console.log("Setting up browser (client) test environment");let path="..";const testMod=require(path+"/tests/testenv.js");testMod.load([]);let ud=new UniversalDoc("document",!0,133),dom=ud.dom,udjson=new UDJSON(dom),test=(console.log("start testing"),"");{test="Test value: ";let json={p1:"val 1",p2:"val1,val2,val3",p4:["val20","val21"]};json=udjson.value(json,"p3","val33"),json=udjson.value(json,"p2","val4","addToCSV"),json=udjson.value(json,"p4","val22","add"),-1<json.p2.indexOf("val4")&&"val33"==udjson.value(json,"p3")&&-1<udjson.value(json,"p4").indexOf("val22")?console.log(test+"OK"):console.log(test+"KO",json)}{test="Test value by path: ";let json={p1:{pa:"val 1"},p2:{a:"val1",b:"val2",c:"val3"},p4:["val20","val21"]};json=udjson.valueByPath(json,"p3","val33"),json=udjson.valueByPath(json,"p2/d","val4"),json=udjson.valueByPath(json,"p4","val22","add"),-1<json.p2.d.indexOf("val4")&&"val33"==udjson.valueByPath(json,"p3")&&-1<udjson.valueByPath(json,"p4").indexOf("val22")?console.log(test+"OK"):console.log(test+"KO",json)}test="Test JSON2HTML 1";let data={tag:"ul",name:"myul",defaults:{tag:{1:"li"}},value:{0:{value:"item1",tag:"li"},1:{value:"item2",tag:"li"}}},json={meta:{type:"list",name:"mylist",zone:"myListeditZone",caption:"My list",captionPosition:"top"},data:data,changes:{}},element=udjson.putElement(json),rjson=udjson.getElement(element);"list"==rjson.meta.type?console.log(test+" : OK"):console.log(test+": KO"),test="Test JSON2HTML 2",data={tag:"textedit",name:"mytext",value:["line1","line2"]},json={meta:{type:"text",name:"mytext",zone:"mytexteditZone",caption:"My text",captionPosition:"top"},data:data,changes:{}},element=udjson.putElement(json),rjson=udjson.getElement(element),rjson&&"text"==rjson.meta.type?console.log(test+" : OK"):console.log(test+": KO",rjson);{test="setValueByPath (recurrent)";let obj={},json=(obj=udjson.setValueByPath(obj,"first","no 1"),obj=udjson.setValueByPath(obj,"second/0","no 2"),obj=udjson.setValueByPath(obj,"second/1","no 3 wrong"),obj=udjson.setValueByPath(obj,"second/2","no 4"),obj=udjson.setValueByPath(obj,"third/a","no 5"),obj=udjson.setValueByPath(obj,"third/b","no 6"),obj=udjson.setValueByPath(obj,"second/1","no 3"),'{"first":"no 1","second":["no 2","no 3","no 4"],"third":{"a":"no 5","b":"no 6"}}');testResult(test,JSON.stringify(obj)==json,JSON.stringify(obj))}{test="merge";let obj=udjson.parse('{"first":"no 1","second":["no 2","no 3","no 4"],"third":{"a":"no 5","b":"no 6"}}'),json=(obj=udjson.merge(obj,'{ "third":{"a":"no 50"}, "second":["no 20", "no 3", "no 4"]}'),'{"first":"no 1","second":["no 20","no 3","no 4"],"third":{"a":"no 50","b":"no 6"}}');testResult(test,JSON.stringify(obj)==json,JSON.stringify(obj))}{test="jsontable array",data={tag:"jsontable",name:"myJtable",class:"aclass",value:[{col1:"Model Col 1",col2:"Model Col 2",col3:"Model Col 3"},{col1:"Row 1 Col 1",col2:" Row 1 Col 2",col3:" Row 1 Col 3"},{col1:"Row 2 Col 1",col2:" Row 2 Col 2",col3:" Row 2 Col 3"}]},json={meta:{type:"table",name:"myJtable",zone:"myJtableeditZone",caption:"My JSON table",captionPosition:"top"},data:data,changes:{}},element=udjson.putElement(json);let el=dom.insertElement("div",element.outerHTML,{id:test},dom.element("B010000000500000M"),!0),table=dom.element("table",element),got=udjson.getElement(element);testResult(test,JSON.stringify(got.data)==JSON.stringify(json.data),JSON.stringify(got.data)+JSON.stringify(json.data)+"!")}{test="jsontable named array",data={tag:"jsontable",name:"myJ2table",value:{model:{col1:"Model Col 1",col2:"Model Col 2",col3:"Model Col 3"},row1:{col1:"Row 1 Col 1",col2:" Row 1 Col 2",col3:" Row 1 Col 3"},row2:{col1:"Row 2 Col 1",col2:" Row 2 Col 2",col3:" Row 2 Col 3"}}},json={meta:{type:"table",name:"myJ2table",zone:"myJ2tableeditZone",caption:"My 2 JSON table",captionPosition:"top"},data:data,changes:{}},element=udjson.putElement(json);let el=dom.insertElement("div",element.outerHTML,{id:test},dom.element("B010000000500000M"),!0),got=udjson.getElement(element);testResult(test,JSON.stringify(got.data)==JSON.stringify(json.data),JSON.stringify(got))}{test="json_access";let json='{"first":"no 1","second":["no 2","no 3","no 4"],"third":{"a":"no 5","b":"no 6"}, "fourth":4}',holder=dom.insertElement("div",json,{id:test,class:"hidden"},dom.element("UD_resources"),!1,!0),read1=udjson.read(json,"first"),read2=udjson.readFromDiv(test,"first"),read3=udjson.readFromDiv(test,"fourth","incrementAfter"),read4=udjson.readFromDiv(test,"fourth"),read5=(udjson.writeToDiv(test,"first","no 1 changed"),udjson.readFromDiv(test,"first"));testResult(test,"no 1"==read1&&"no 1"==read2&&4==read3&&5==read4&&"no 1 changed"==read5,read1+" "+read2+" "+read3+" "+read4+" "+read5)}{test="jsonlist",data={tag:"jsonlist",name:"myJ2list",value:["item 1","item 2","item 3"]},json={meta:{type:"div",name:"myJ2list",zone:"myJ2listeditZone",caption:"My 2 JSON list",captionPosition:"top"},data:data,changes:{}},element=udjson.putElement(json);let got=udjson.getElement(element);testResult(test,JSON.stringify(got.data)==JSON.stringify(json.data),JSON.stringify(got))}{test="parsing stringify &quot",data=["HTML","&lt;div style=&quot;width:100%;&quot;&gt;"],json=JSON.stringify(data);let el=document.createElement("div");el.innerHTML=json.replace(/&quot;/g,"&amp;quot;"),testResult(test,-1<json.indexOf("&quot;")&&-1<el.innerHTML.indexOf("&amp;quot;"),json+el.innerHTML)}console.log("Test completed"),process.exit(0)}class UDmodule{constructor(){if(void 0!==this._uses){var e=$$$.loadFcts(this._uses);if("string"==typeof e)return console.error("Unknown fct $$$."+e),void $$$.pageBanner("temp",$$$.translateTerm("Unknown fct")+" $$$."+e)}var e=Object.getOwnPropertyNames(Object.getPrototypeOf(this));"undefined"!=typeof $$$&&(e=e.filter((e,t,s)=>{if(e!=s[t+t]&&"function"==typeof this[e]&&"constructor"!=e&&"_"!=e[0])return!0}),$$$.addFunctions(this,e))}}if("object"==typeof process&&(module.exports={class:UDmodule,UDmodule:UDmodule},void 0===global.JSDOM)&&"undefined"==typeof window&&"undefined"==typeof ModuleUnderTest){ModuleUnderTest="udmodule.js",void 0===process.argv[2]&&(console.log("Syntax OK"),console.log("Test completed"),process.exit(0));let testModule="resources/"+process.argv[2],ejsModule="../node_modules/ejs/ejs.js";const envMod=require("../tests/testenv.js");envMod.load(),global.ud=new UniversalDoc("document",!0,133),global.reqMod=envMod.require,envMod.require([ejsModule,testModule],function(){console.log("Module tests returned")})}class UD_ressources{ud=null;classMap=null;info=null;register=null;mappedClasses={};dom;constructor(e,t){this.ud=e,"undefined"!=typeof API&&((API=API||"object"!=typeof process?API:t).addFunctions(this,["getTagOrStyleInfo","getTagOrStyleLabel","getStyleLabel","getTagLabel","availableTags","listTypeAndSubTypeClasses","availableClassesForExtag","availableClasses","availableStylesForSelection","availableTagsForSelection","availableLayouts","availableLayoutsForExTag","insertables","getViewTypeClass","getClassesForView","updateClassMap","getEditorAttr","testEditorAttr","setEditorAttrPermanently","setLiveEditorAttrs","getParameter","getConstant","hasLanguageSuffix","defaultContent","hasDefaultContent","updateResource","refreshResource"]),this.dom=API.dom,this.register=UD_register,this.info=this.register.UD_exTagAndClassInfo,UD_exTagAndClassInfo=this.info,(e=this.dom.udjson.parse("UD_registerModifications"))&&(UD_exTagAndClassInfo=this.updateResource(UD_exTagAndClassInfo,e[0]),this.register.UD_exTagAndClassInfo=UD_exTagAndClassInfo),"undefined"!=typeof UD_register&&void 0!==UD_register.UD_parameters.buildManageOnClientSide&&debug("Register loaded"),window.UD_resources=this)}getTagOrStyleInfo(e,t=""){window.lang;e=API.json.value(UD_exTagAndClassInfo,e);return e&&t?API.json.value(e,t):e||""}getTagOrStyleLabel(e,t=""){if(!e)return"";let s="";var n=window.lang;let i=null;var a,o,l=API.json.value;return t&&(t=$$$.dom.getEditableParent(t),a=this.dom.attr(t,"exTag"),(i=this.getParameter("register")["store-labels-by-view"]&&(o=API.dom.getViewType(t),t=API.dom.getViewClass(t),a)&&o&&t?l(UD_exTagAndClassInfo,"div.part."+o+" ."+t+" "+a+"."+e):i)||a==e||(i=l(UD_exTagAndClassInfo,a+"."+e))),i=i||API.json.value(UD_exTagAndClassInfo,e),s=(s=i?(s="",(s="EN"!=n?$$$.json.value(i,"label_"+n):s)||$$$.json.value(i,"label")):$$$.translateTerm(e))||$$$.translateTerm(e)}getStyleLabel(e,t=""){return this.getTagOrStyleLabel(e,t)}getTagLabel(e,t=""){return this.getTagOrStyleLabel(e,t)}availableTags(e){var t=[],e=API.dom.element(e),s=(API.dom.attr(e,"exTag"),e.parentNode);if("div.zone"==$$$.dom.attr(s,"exTag")&&s.classList.contains("text-only"))return["p"];if(e){var n=API.json.value,i=API.dom.getViewType(e);if(i)for(var a in this.info){var o=n(this.info[a],"viewTypes");void 0!==o&&("all"==o||-1<o.indexOf(i))&&t.push(a)}}return t}listTypeAndSubTypeClasses(){var e,t,s=[];for(e in API.json.parse("UD_nextViewIds"))s.push(e.replace(/ /g,"_"));for(t in this.info){var n=this.info[t].ud_type,i=this.info[t].ud_subType;n&&-1==s.indexOf(n)&&s.push(n),i&&-1==s.indexOf(i)&&s.push(i)}return s}availableClassesForExtag(e,t="doc",s=""){let n=[];var i=API.json.value,e=this.info[e],a=i(e,"classesByViewClass"),a=a?i(a,s):null;return n=a||(s=i(e,"classesByViewType"),i(s,t)?i(s,t):i(s,"default"))||[]}availableClasses(e,t="",s="",n=""){var i,e=API.dom.element(e),a=(t=t||API.dom.attr(e,"exTag"),s=s||API.dom.getViewType(e),n=n||API.dom.getViewClass(e),i=this.availableClassesForExtag(t,s,n),[]);for(let e=0;e<i.length;e++){var o=i[e];-1==o.indexOf("LAY_")&&a.push(o)}return a}availableLayouts(e,t="",s=""){var n,i=API.dom.element(e),a=(t=t||(i?API.dom.attr(i,"exTag"):e),s=s||API.dom.getViewType(i),n=this.availableClassesForExtag(t,s),[]);for(let e=0;e<n.length;e++){var o=n[e];0==o.indexOf("LAY_")&&a.push(o)}return a}availableLayoutsForExTag(e){let t=[];t="div.part"==e?(s=(0,API.json.value)(this.info[e],"defaultContentByClassOrViewType"),Object.keys(s)):this.availableClassesForExtag(e,viewType);var s,n=[];for(let e=0;e<t.length;e++){var i=t[e];0==i.indexOf("LAY_")&&n.push(i.replace("LAY_",""))}return n}availableStylesForSelection(e){var t,s=[],e=API.dom.element(e),e=API.dom.attr(e,"exTag");for(t in(0,API.json.value)(this.info[e],"insertableTags"))s.push(t);return s}availableTagsForSelection(e){var t,s=[],e=API.dom.element(e),e=API.dom.attr(e,"exTag");for(t in(0,API.json.value)(this.info[e],"insertableTags"))s.push("span."+t);return s}insertables(e){e=API.dom.element(e),e=API.dom.attr(e,"exTag");return(0,API.json.value)(this.info[e],"insertableTags")}getViewTypeClass(){}getClassesForView(){}defaultContent(e,t="",s=!1){var n="object"==typeof e?this.dom.attr(e,"exTag"):e,e=(t||"object"!=typeof e||(t=API.getViewType(e)),this.info[n]);let i="";n=API.json.value(e,"defaultContentByClassOrViewType");return i="object"==typeof(i=(i=(i=n&&Object.keys(n).length?API.json.value(n,t):i)||API.json.value(e,"defaultContent"))||"...")&&s?API.json.toHTML(i):i}hasDefaultContentByPath(e,t){var t=this.info[t],s=API.json.value(t,"defaultContentPath");if(s){e=this.getJSONcontentByPath(e,s);if(e)return JSON.stringify(API.json.value(t,"defaultContentByPath"))==e}return!1}hasDefaultContent(e,t="",s=""){var n,i,e=this.dom.element(e);return"div.part"==(t=t||this.dom.attr(e,"exTag"))?(n=this.dom.children(e),i=this.defaultContent(t,s),e.textContent.length<20||n.length==Object.keys(i).length):!e.innerHTML||e.textContent==this.dom.attr(e,"ude_place")||this.hasDefaultContentByPath(e,t)||e.innerHTML==this.defaultContent(t,s)}getJSONcontentByPath(e,t){var s=this.dom.attr(e,"name"),s=this.dom.element("#"+s+"_object",e);if(s){e=this.dom.udjson.valueByPath(s.innerText,t);if(e)return JSON.stringify(e)}return""}defaultAttrValue(e,t,s=null){let n="";if(0!=t.indexOf("data-")&&(t="data-"+t.replace("ude_","ude-")),void 0!==(s=s||UDE_attributeValues[t])&&!(n=API.json.valueByPath(s,e+"/"+t)))for(var i in s){var a=s[i];if("object"==typeof a?n=this.defaultAttrValue(t,a.items):-1<a.indexOf("*default*")&&(n=i),n)break}return n}getEditorAttr(t,s){var n,t=this.dom.element(t);0==s.indexOf("data-")&&(s=s.replace("data-","").replace("-","_"));let i=this.dom.attr(t,s);if(!i){let e=this.dom.attr(t,"ud_extra");(e=(e=e||this.dom.parentAttr(t,"ud_extra"))&&API.json.parse(e))&&(n=0==s.indexOf("data-")?s:"data-"+s.replace(/_/g,"-"),i=(i=(i=e[s])||e[n])||e[s.replace("ud_","").replace("ude_","")])}return i=(i=i||this.dom.parentAttr(t,s))||this.defaultAttrValue(this.dom.attr(t,"exTag"),s)}testEditorAttr(e,t,s=""){var n=this.dom.element(e);let i=this.getEditorAttr(e,t);e=this.dom.element("UD_mode");let a="edit2";return e&&(a=e.textContent),"on"==(i=n.id&&"B3"!=n.id.substr(0,2)&&"edit3"==a&&-1<["ude_edit","ude_menu"].indexOf(t)?"on":i)||i&&"off"!=i&&""!=s&&-1<i.indexOf(s)}getParameter(e,t="global"){let s="";if("global"==t)s=this.dom.udjson.value(UD_register.UD_parameters,e);else if("register"==t)s=this.dom.udjson.valueByPath(UD_register,e);else{t=API.dom.element("UD_"+e);if(!t)return debug({level:2,return:""},"can't find UD_"+e);s=t.textContent}if(s&&"string"==typeof s){e=s.toLowerCase();if(-1<["yes","no","on","off"].indexOf(e))return e}return s}getConstant(e,t){let s=e[t];e=this.getParameter("userId"),t=("00000"+(t=parseInt(e,10).toString(32))).substring(t.length);return s=s.replace("{userId}",e).replace("{userId_base32}",t)}hasLanguageSuffix(e){e=e.substr(e.length-2);return-1<this.getParameter("languageCodes").indexOf(e)}setEditorAttrPermanently(e,t,s){var n,e=this.dom.element(e),i=this.dom.getSaveableParent(e);this.dom.parentAttr(e,t,s="boolean"==typeof s?s?"on":"off":s);return e==i&&((n=(n=this.dom.attr(e,"ud_extra"))?API.json.parse(n):{})[t]=s,this.dom.attr(e,"ud_extra",JSON.stringify(n))),API.setChanged(i),s}setLiveEditorAttrs(e){}refreshResource(e){"UD_tagAndClassInfo"==e&&(this.info=this.register.UD_exTagAndClassInfo)}updateClassMap(e){console.error("Call to deprecated updateClassMap() in udresources.js"),API.json.merge(this.classMap,e);e=API.dom.element("UD_classMap");e&&(e.textContent=JSON.stringify(this.classMap))}updateResource(e,t){t=API.json.value(t,"resource","","delete");e="object"==typeof e?e:API.json.parse(e);return API.json.merge(e,t)}loadResourceFile(e){API.loadScript(e,"API.loadRessources( name);")}loadResources(e){for(var t in e){var s,t=e[t],n=t.action,i=t.data;for(s in i){i[s];n}}}}function UD_ressources_init(e,t){return new UD_ressources(e,t)}if("object"==typeof process&&(module.exports={class:UD_ressources,init:UD_ressources_init},void 0===global.JSDOM)&&"undefined"==typeof window&&"undefined"==typeof ModuleUnderTest){console.log("Syntax:OK"),console.log("Start of UD_ressources class test program"),console.log("Setting up browser (client) test environment"),ModuleUnderTest="udressources";let path="..";const testMod=require(path+"/tests/testenv.js");testMod.load([]);let ud=new UniversalDoc("document",!0,133);{let test="1 - availableClassesForExtag",classes=API.availableClassesForExtag("p");testResult(test,-1<classes.indexOf("standard"),classes)}{let test="2 - availableClasses",classes=API.availableClasses("B0100000001000000M");testResult(test,-1<classes.indexOf("standard"),classes)}{let test="3 - insertables",types=API.insertables("B0100000001000000M");testResult(test,types.field,types)}console.log("Test completed"),process.exit()}class UDutilities{moduleName="UDutilities";ud=null;dom=null;api=null;actionElement=null;copyAttributes=["ude_formula","ude_autosave","ude_stage"];constructor(e,t=null){this.ud=e,this.dom=e.dom,this.api=t||e.api,this.api.addFunctions(this,["buildManagePart","diffuseDoc","copy","deepCopy","copyElements","removeChildren","egaliseHeightOfClass","buildDisplayableDeviceList","dispatchNameChange","changeName","dispatchClassChange","prePostDocName","getInlineHTML","concatHTMLelements"])}buildManagePart(e=!1){let t=this.dom.elementByName("Manage");if(!(t=t||this.dom.elementByName("manage")))return debug({level:1,return:!1},"No manage part found");$$$.dom.attr(t,"contenteditable","true"),$$$.dom.attr(t,"ude_edit","on");var s=this.dom.elementByName("BotlogZone"),n=this.dom.elementByName("DocNames"),i=this.dom.elementByName("DocParameters"),a=this.dom.elementByName("DocActions"),o=this.dom.elementByName("DocHistory"),l=this.dom.udjson,r=API.translateTerm,d=("FR"==this.dom.textContent("UD_lang")&&(r("Parameters",!0,"Paramètres"),r("Diffuse this document",!0,"Diffusez ce document"),r("Share this documen",!0,"Partagez ce document"),r("Document history",!0,"Voir l'histoire du document")),s&&s.classList.add("hidden"),t.classList.add("LAY_A4"),this.dom.attr(this.ud.topElement,"ud_oid").split("--"));if(n&&this.dom.children(n).length<2){this.dom.insertElement("h1",r("Manage doc"),{},n);var u=this.dom.textContent("UD_docTitle");let e=this.dom.textContent("UD_docSubtitle");e=e||"Description courte";var c=this.dom.textContent("UD_docModel"),u={tag:"div",value:{docName:{tag:"p",name:"MANAGE_docName",value:{docTitle:{tag:"span",class:"title",placeholder:"Nouvelle tâche",stage:"on",menu:"off",value:u},docSubtitle:{tag:"span",class:"subtitle",stage:"on",menu:"off",placeholder:"Description courte",value:e}}},model:{tag:"p",name:"MANAGE_model",value:{label:{tag:"span",class:"label",edit:"off",value:"Processus :"},modelValue:{tag:"span",stage:"on",menu:"off",value:c},ok:{tag:"span",class:"button",onclick:"$$$.setModel( this.previousSibling.value)",value:"OK"}}},partEditing:{tag:"div",value:{viewTitle:{tag:"h2",edit:"off",value:"Vues"},viewlist:{tag:"div",name:"MANAGE_viewNames",type:"zoneToFill"}}}}},c=this.dom.textContent("UD_dbName").split("_")[0];n.innerHTML=l.putElement(u).innerHTML,this.dom.attr("MANAGE_docName","ud_oid",d[0]+"--"+d[1]),this.dom.attr("MANAGE_docName","ud_extra",'{"name":"'+c+'"}'),this.dom.attr("MANAGE_docName","ud_dchanged",0),this.dom.attr("MANAGE_docName","ud_dupdated",0),this.dom.attr("MANAGE_docName","ud_fields","nlabel tcontent"),API.onTrigger("MANAGE_docName","prepost",API.prePostDocName,!1),this.ud.buildPartEditing("MANAGE_viewNames")}if(i&&this.dom.children(i).length<2){let e=l.parse("UD_system");e&&Object.keys(e).length||(e={ideas:["defaultPart","copyParts"]});n=UD_wellKnownElements.UD_docParams,u=n.replace("_object",""),c={meta:{type:"text",subtype:"JSON",name:u,zone:u+"editZone",caption:"DocParams",captionPostion:"top"},data:{tag:"textedit",class:"textContent",value:e},changes:[]},n={tag:"div",class:"object hidden",name:n,value:JSON.stringify(c)},c={tag:"div",value:{title:{tag:"h3",onclick:"API.toggleClass( 'MANAGE_params', 'hidden');",value:r("Parameters")},editor:{tag:"div",type:"json",class:"json hidden",name:"MANAGE_params",label:u,value:n}}},u=l.putElement(c),n=(i.innerHTML=u.innerHTML,this.dom.element("MANAGE_params"));this.ud.ude.initialiseElement(n),this.dom.attr(n,"ud_oid",d[0]+"--"+d[1]),this.dom.attr(n,"ud_dchanged",0),this.dom.attr(n,"ud_dupdated",0),this.dom.attr(n,"ud_fields","textra"),n.classList.add("hidden")}a&&this.dom.children(a).length<2&&(c={tag:"div",value:{title:{tag:"h2",value:r("Actions")},diffusion:{tag:"div",value:{title:{tag:"h3",onclick:"API.toggleClass( 'MANAGE_diffusion', 'hidden');",value:r("Diffuse this document")},diffuse:{tag:"div",class:"*hidden",name:"MANAGE_diffusion",value:{msg:{tag:"p",name:"MANAGE_diffuseMsg",class:"customerMessage",value:"Bonjour,<br><br>Voici le lien pour votre présentation de SD bee : {link}<br><br>L'équipe SD bee"},recipients:{meta:{name:"MANAGE_recipients",zone:"MANAGE_recipientseditZone",type:"list",class:"input",captionPosition:"top",caption:"Entrez les adresses emails des destinataires ici :"},data:{1:{tag:"ul",name:"MANAGE_recipients",class:"listStyle1",value:{1:{tag:"li",class:"input",placeholder:"Enter item",value:"contact@sd-bee.com"}}}},changes:{}},btn:{tag:"span",class:"button",onclick:"API.diffuseDoc( 'MANAGE_diffuseMsg', 'MANAGE_recipients');",value:"Diffuse"}}}}},docactions:{tag:"div",value:{title:{tag:"h3",value:r("Copy, delete ...")},deletedoc:{tag:"span",class:"button",onclick:"API.deleteDoc();",value:"Delete"}}}}},a.innerHTML=l.putElement(c).innerHTML),e&&this.dom.insertElement("div",'<span ud_type="button" class="button" onclick="API.switchView( \'Dir listing\');">Close Manage</span>',{class:"manageZone"},t,!0,!0);i=s?this.dom.element("p.botlog",s):null,u=i?i.innerHTML:"";u&&(o?this.dom.element("MANAGE_botlog").innerHTML=u:(d={tag:"div",value:{title:{tag:"h2",onclick:"API.toggleClass( 'MANAGE_history', 'hidden');",value:r("Document history")},history:{tag:"div",class:"*hidden",name:"MANAGE_history",value:{content:{tag:"p",name:"MANAGE_botlog",class:"botlogDisplay",value:u}}}}},n=l.putElement(d),o=this.dom.prepareToInsert("div",n.innerHTML,{name:"DocHistory",class:"manageZone","data-ud-type":"zone"}),(this.dom.element("div.page",t)||t).appendChild(o)))}diffuseDoc(e,t){if(!window.APP_DIFFUSE){window.APP_DIFFUSE=!0;var e=API.dom.element(e),s=API.dom.element(t);if(e&&s){var n=e.innerHTML,i=API.getItems(t);API.pageBanner("temp","Diffusion d'une instance de ce modèle à "+i.length+" emails");for(let e=0;e<i.length;e++){var a={action:"send",subject:"SD bee demo",body:n,to:i[e],oid:API.dom.attr("document","ud_oid"),docName:"Demo SD bee",lifeInDays:30},a=API.service("SendDoc",a);console.log(a)}return!(window.APP_DIFFUSE=!1)}API.pageBanner("temp","Missing data"),window.APP_DIFFUSE=!1}}copyObjectInDiv(e){}copy(t,e,s={},n,i=!0){var a=this.dom.attr(t,"tagName"),o=this.dom.attr(t,"ud_type"),l=t.className;let r={},d=t.innerHTML;if(-1<["subpart","zone"].indexOf(o)&&(d=""),""==this.dom.attr(t,"ud_oid"))return null;if(o&&(r={ud_type:o,class:o}),l&&(r.class=l),""!=d)for(var u in s){var c=new RegExp("{"+u+"}","g");d=d.replace(c,s[u])}let h=null;if(h=this.dom.prepareToInsert(a,d,r),h=e.appendChild(h),i||this.ud.ude.calc.substituteFormulaeInElement(h),this.ud.viewEvent("create",h),o)switch(o){case"zone":case"subpart":let e=this;this.ud.onTrigger(h,"update",function(){e.deepCopy(t.id,h.id,s,!1,i)});break;default:this.ud.ude.initialiseElement(h.id)}return h}deepCopy(t,s,n={},i=!1,a=!0){var o=this.dom.element(t);let l=this.dom.element(s);var e=this.dom.attr(l,"ud_oid");let r=null;if(""!=e&&0==e.split("--")[1].split("-").pop()){let e=this;return setTimeout(function(){e.deepCopy(t,s,n,i)},1500),debug({level:2,return:!1},"Destination not saveable yet",l)}if(i){l=this.copy(o,l),r=l;let e=this;return this.ud.onTrigger(newElement,"update",function(){e.deepCopy(t,s,n,!1,a)}),l}for(var d=this.dom.children(o),u=0;u<d.length;u++){var c=d[u],h=this.dom.attr(c,"ud_type");-1<["page"].indexOf(h)||(h=this.copy(c,l,n,0,a),r=r||h)}return r&&void 0!==r.id?r.id:debug({level:2,return:!1},"Nothing copied in API.deepCopy()",o,l)}copyElements(e,t,s="document"){s=this.dom.element(s);let n=this.dom.element(e),a=(!n&&s&&(n=this.dom.element("[name='"+e+"']",s)),this.dom.element(t));if(!a&&s&&(a=this.dom.element("[name='"+t+"']",s)),!n||!a)return debug({level:1,return:!1},"Can't copy from to",e,t);var o=n.id.substring(0,3),l=a.id.substring(0,3),s=n.id.substring(3,13),e=a.id.substring(3,13),r=parseInt(s,32),d=parseInt(e,32),u=("00000"+window.ud.userId).slice(-5).toUpperCase();let c=this.dom.attr(a,"name").replace(this.dom.attr(n,"name"),"");c=c.replace(/ /g,"_");var h=API.dom.children(n);let m=null;for(let i=h.length-1;0<=i;i--){var p=h[i],g=p.id;let n=l+g.substring(3,13)+u;if(o==l&&(f=d+((f=parseInt(g.substring(3,13),32))-r),n=l+("0000000000"+f).slice(-10)+u),this.dom.element(n)){m=this.dom.element(n),this.dom.attr(m,"ude_datasrc",g);let e=API.json.parse(API.dom.attr(m,"ud_extra"));(e=e||{}).datasrc=g,API.dom.attr(m,"ud_extra",JSON.stringify(e)),API.setChanged(m)}else{let e=p.cloneNode(!0);e.id=n;var f=this.dom.attr(p,"name"),p=this.dom.element(f+"_object");let t="",s=(f&&p&&(t=f+c),this.dom.attr(e,"ude_datasrc",g),e.classList.add("ud_requiresAction"),API.json.parse(API.dom.attr(e,"ud_extra")));(s=s||{}).datasrc=g,API.dom.attr(e,"ud_extra",JSON.stringify(s));g=m?m.parentNode:a.childNodes[a.childNodes.length-1];if(e="div.page"==this.dom.attr(g,"exTag")?i==h.length-1?g.appendChild(e):g.insertBefore(e,m):i==h.length-1?a.appendChild(e):a.insertBefore(e,m),t&&p){if(!API.changeName(e,t))return!1;this.dom.attr(e,"ude_datasrc",t)}this.ud.viewEvent("create",e),m=e}}API.paginate(a)}concatHTMLelements(e,t){var s=this.dom.udjson.value,n=s(t,"baseStyle"),i=s(t,"styleId"),s=s(t,"containerCode"),a={width:"px",height:"px","font-size":"px",float:"",color:"","background-color":"","margin-top":"px","margin-left":"px","margin-right":"px","margin-bottom":"px","padding-top":"px","padding-right":"px","padding-bottom":"px","padding-left":"px","border-radius":"px"},t=this.dom.elementByName(e);if(!t)return debug({level:1,return:""},"Can't find ",e);let o="",l="";if(i&&(-1==(e=this.ud.ude.calc.textContent2HTML(i)).indexOf('<meta name="viewport"')&&(l+='<meta name="viewport" content="width=device-width,initial-scale=1.0">\n<meta charset="UTF-8">\n'),-1<e.indexOf("<style")?l+=e:l+='<style type="text/css">'+e+"</style>"),n){for(var r in o=o+("<html><head>"+l+"</head>")+'<body style="',n){var d=n[r];let e="",t="";"string"==typeof d&&(t=d.slice(-2),"%"==d.slice(-1))&&(t="%"),void 0!==a[r="_"==r.charAt(0)?r.substr(1):r]&&(e=a[r]),-1<["%","px","em"].indexOf(t)&&(e=""),o+=r+":"+n[r]+e+";"}o=(o+='">')+s.open}var u=this.dom.elements("div[data-ud-type='filledZone'],div[data-ud-type='html']",t);for(let e=0;e<u.length;e++){var c,h=u[e];"div.html"==this.dom.attr(h,"exTag")?(c=this.dom.element("div div.htmlView",h))&&(o+=c.innerHTML):o+=h.innerHTML}return o+=s.close,n&&(o+="</body></html>"),o}getInlineHTML(e,s,t,n,i=""){var a={width:"px",height:"px","font-size":"px",float:"",color:"","background-color":"","margin-top":"px","margin-left":"px","margin-right":"px","margin-bottom":"px","padding-top":"px","padding-right":"px","padding-bottom":"px","padding-left":"px","border-radius":"px"};let o=e,l=("string"==typeof e&&(o=this.dom.element(e)),""),r="";if(i&&(-1==(e=this.ud.ude.calc.textContent2HTML(i)).indexOf('<meta name="viewport"')&&(r+='<meta name="viewport" content="width=device-width,initial-scale=1.0">\n<meta charset="UTF-8">\n'),-1<e.indexOf("<style")?r+=e:r+='<style type="text/css">'+e+"</style>"),s){for(var d in l=l+("<html><head>"+r+"</head>")+'<body style="',s){var u=s[d];let e="",t="";"string"==typeof u&&(t=u.slice(-2),"%"==u.slice(-1))&&(t="%"),void 0!==a[d="_"==d.charAt(0)?d.substr(1):d]&&(e=a[d]),-1<["%","px","em"].indexOf(t)&&(e=""),l+=d+":"+s[d]+e+";"}l=l+'">'+'<table class="emailContainer" align="center" cellpadding="0" cellspacing="0" border="0"><tr><td>'}for(var c=this.dom.children(o),h=0;h<c.length;h++){var m,p=c[h];let e="";-1<n.indexOf(p.id)||(3==p.nodeType?e+=p.textContent:1==p.nodeType&&(m=this.dom.attr(p,"exTag"),-1<["div.zone"].indexOf(m)?e=e+this.getInlineHTML(p.id,null,t,n)+"\n":-1<["div.filledZone","div.zoneToFill"].indexOf(m)?e+=p.innerHTML:"none"!=this.dom.attr(p,"computed_display")&&(p.tagName.toLowerCase(),e='<div style="',e=(e+='">\n')+p.innerHTML+"</div>\n")),l+=e+"\n")}return s&&(l+="</td></tr></table></body></html>"),l=l.replace(/&nbsp;/g," ")}egaliseHeightOfClass(e){var t=document.getElementsByClassName(e);let s=0;for(let e=0;e<t.length;e++){var n=this.dom.attr(t[e],"computed_height");n>s&&(s=n)}s+="px";for(let e=0;e<t.length;e++)t[e].style.height=s;return!0}getContentWithInlineStyles(){}getInlineStyle(t,s,n){let i="";for(var a in s)if("_"!=a.charAt(0)){var o=this.dom.attr(t,"computed_"+a);console.log(a+":"+o);let e=o;if((e=isNaN(e)?e:Math.floor(parseFloat(e)))!=s[a]&&""!=e){let e="";void 0===n[a]||isNaN(o)||(e=n[a]),i+=a+":"+o+e+";"}}return i}buildDisplayableDeviceList(){var t="scroll";let e=this.ud.ude.calc.exec("classesByTag( '#scroll');");var s=e;e=e.split(",");let n="<ul>";n+='<li><a href="javascript:" onclick="'+("window.ud.ude.changeClass( '', 'scroll', '"+s+"');")+'">This screen</a></li>';for(var i=0;i<e.length;i++){var a=e[i];if(""!=a){var o=this.dom.element("UD_appPart").textContent,o=document.getElementsByName(o)[0];let e="";o&&(e=(e+="API.showOneOfClass( '"+o.id+"');")+"API.followScroll( '"+o.id+"');"),e+="API.changeClass( '"+a+"', '"+t+"', '"+s+"');",n=(n+='<li><a href="javascript:" onclick="'+e+'", ude_p1="'+t+'">')+API.translateTerm(a)+"</a></li>"}}return n+="</ul>"}appendHTMLblock(e,t,s){}removeChildren(e){e=this.dom.element(e);if(!e)return!1;let t=e.childNodes[0];if(!t)return!1;for(;t;){var s=t;t=t.nextSibling,this.ud.viewEvent("delete",s)}return!0}insertIntoTemplate(e,s,n){let t=e;var a={},o=(t="string"==typeof e?this.dom.element(e):t).childNodes();for(let e=0;o.length;e++){let e=e[i];var l=e.classList;let t="";for(let e=0;e<s.length;e++)if(l.contains(s[i])){t=s[i];break}t&&(void 0===a[t]?a[t]=[this.getContentWithInlineStyles(e)]:a[t].push(this.getContentWithInlineStyles(e)))}let r="";var d=a[s[0]];for(let t=0;t<d.length;t++){let e=n;for(var u in a){var c=new RegExp("{"+u+"}","g");e=e.replace(c,a[u][t])}r+=e}return r}dispatchNameChange(e){var e=this.dom.element(e),s=this.dom.elements("span.objectName",e),t=this.dom.elements("div.object",e);if(s.length||t.length){var s=s.length?s[0]:null,n=s?s.textContent:this.dom.attr(e,"name"),i=t[0];if(n&&0!=i.id.indexOf(n+"_")){var a=i.id.replace("_object","");if(this.dom.element(n))return s&&(s.textContent=a),API.pageBanner("temp",'<span class="error">'+API.translateTerm("Name is already used")+"</span>"),debug({level:1,return:!1},"Can't dispatch name change as name is not unique",n);i.id=n+"_object";var o=n;this.dom.attr(e,"name")!=o&&this.dom.attr(e,"name",this.dom.attr(e,"name").replace(a,o));let t=[];t=this.nodejs?document.querySelectorAll("#"+e.id+" *"):e.querySelectorAll("*");for(let e=0;e<t.length;e++){var l,r=t[e];r!=i&&(r.id&&(r.id=r.id.replace(a,o)),(l=this.dom.attr(r,"ude_bind"))&&this.dom.attr(r,"ude_bind",l.replace(a,o)),l=this.dom.attr(r,"onclick"))&&this.dom.attr(r,"onclick",l.replace(a,o))}s&&!s.classList.contains("hidden")&&s.classList.add("hidden")}}return!0}changeName(e,t=""){let s=API.dom.element(e);if(!s)return debug({level:1,return:!1},"Can't changeName on unfound element",e);if(t||("_TMPnameEdition"==s.id?(e="previous"==(e=API.dom.attr(s,"ude_bind"))?s.previousSibling:"next"==e?s.nextSibling:null,t=s.textContent,s.remove(),s=e):s==window.MENU.editElement&&(e=("SPAN"==s.tagName?s.parentNode:s).previousSibling,e=API.dom.element("span.objectName",e))&&(t=e.textContent)),t){var e=API.dom.attr(s,"name"),n=this.dom.element(e+"editZone"),e=e&&n?API.dom.element("span.objectName",n):null;if(e)e.textContent=t;else{if(API.dom.element('[name="'+t+'"]',"document"))return void API.pageBanner("tmp","Duplicate name");API.dom.attr(s,"name",t),"SPAN"==s.tagName&&(s.id=t)}this.dispatchNameChange(s);e=this.dom.element(t+"_object"),e=(e&&(n=this.dom.element(t+"editZone"),this.ud.ude.dispatchEvent({event:"save",target:e},n)),this.ud.ude.setChanged(s,!0),t.split("_"));2!=e.length||isNaN(e[1])||void 0===window.udparams["AutoIndex_"+e[0]]||window.udparams["AutoIndex_"+e[0]]++}return!0}dispatchClassChange(e,t,s=""){e=this.dom.element(e);if(e&&t&&s){if((s=s||this.dom.keepPermanentClass(e.className))!=t){var n=this.dom.elements("*",e);for(let e=0;e<n.length;e++){var i=n[e];i&&i.className&&(i.className=i.className.replace(t,s))}}return!0}}prePostDocName(e){var t=this.dom.children(e);let s="",n="",i="";n=(1<t.length?(i='<span class="title">'+htmlEntities(t[0].textContent)+"</span>",t[1].textContent!=this.dom.attr(t[1],"ude_place")&&(i+='<span class="subtitle">'+htmlEntities(t[1].textContent)+"</span>"),s=t[0].textContent,t[0].textContent):0<t.length?(s=t[0].textContent,t[0].textContent):s=e.textContent).replace(/ /g,"").substring(0,8);var t=this.dom.udjson.parse(this.dom.attr(e,"ud_extra"));return t&&this.dom.udjson.value(t,"name")&&(t=t.name+"_"+n,e.id=t,this.dom.attr(e,"name",s),this.dom.attr(e,"ud_saveid","yes")),i}}function UDutilities_init(e,t){return new UDutilities(e,t)}if("object"==typeof process&&(module.exports={class:UDutilities,init:UDutilities_init},void 0===global.JSDOM)&&"undefined"==typeof window){console.log("Syntax udutilities.js:OK"),console.log("Start of test program"),console.log("Setting up browser (client) test environment");var envMod=require("../tests/testenv.js");envMod.load(),ud=new UniversalDoc("document",!0,133);let test="Manage part";$$$.buildManagePart(),testResult(test,$$$.dom.elementByName("DocParameters"),$$$.dom.elementByName("Manage").innerHTML),console.log("Test completed"),process.exit()}